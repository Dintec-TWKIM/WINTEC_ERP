USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[UP_PU_POLL_INSERT]    Script Date: 2022-03-24 오후 6:00:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--발주등록 사급자재 INSERT    
ALTER PROCEDURE [NEOE].[UP_PU_POLL_INSERT]    
(    
	@P_CD_COMPANY   NVARCHAR(7),    
	@P_CD_PLANT     NVARCHAR(7),     
	@P_NO_PO        NVARCHAR(20),     
	@P_NO_POLINE    NUMERIC(5, 0),     
	@P_NO_LINE      NUMERIC(5, 0),     
	@P_CD_MATL      NVARCHAR(20),     
	@P_QT_NEED      NUMERIC(17, 4),     
	@P_QT_NEED_UNIT NUMERIC(17, 4),     
	@P_ID_INSERT    NVARCHAR(15),
	@P_NO_RELATION	NVARCHAR(20) = NULL,
	@P_SEQ_RELATION NUMERIC(5,0) = 0,
	@P_TXT_USERDEF1 NVARCHAR(100) = NULL,
	@P_NUM_USERDEF1 NUMERIC(19,6) = 0,
	@P_TXT_USERDEF2 NVARCHAR(100) = NULL,
	@P_TXT_USERDEF3 NVARCHAR(100) = NULL,
	@P_TXT_USERDEF4 NVARCHAR(100) = NULL,
	@P_TXT_USERDEF5 NVARCHAR(100) = NULL,
	@P_NUM_USERDEF2 NUMERIC(19,6) = 0    
)    
AS    
DECLARE      @ERRNO               INT,     
			 @ERRMSG              NVARCHAR(255),     
			 @P_DTS_INSERT        VARCHAR(14),     
			 @FG_TAX              NVARCHAR(3),     
			 @FG_COMP             NVARCHAR(3),                --유무상구분     
			 @CD_PARTNER		  NVARCHAR(7),     
			 @CD_ITEM             NVARCHAR(20),
			 @V_SERVER_KEY		  NVARCHAR(25)   
			 
			     
SELECT @V_SERVER_KEY = SERVER_KEY
  FROM CM_SERVER_CONFIG
 WHERE YN_UPGRADE = 'Y'   
    
SET @P_DTS_INSERT = REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR(20), GETDATE(), 120), '-',''), ' ', ''),':','')   

      
IF (@V_SERVER_KEY LIKE 'DONGWOON%')
BEGIN
	UPDATE MM_QTIOLOT
	   SET NUM_USERDEF1 = ISNULL(NUM_USERDEF1,0) + ISNULL(@P_QT_NEED,0)
	 WHERE NO_IO = @P_NO_RELATION
	   AND NO_IOLINE = @P_SEQ_RELATION
	   AND NO_IOLINE2 = @P_NUM_USERDEF1
	   AND CD_COMPANY = @P_CD_COMPANY
END 
    
SELECT @FG_TAX = FG_TAX, @CD_PARTNER = CD_PARTNER    
FROM PU_POH    
WHERE CD_COMPANY = @P_CD_COMPANY    
AND CD_PLANT = @P_CD_PLANT  
AND NO_PO = @P_NO_PO    
    
SELECT @CD_ITEM = CD_ITEM    
FROM PU_POL    
WHERE CD_COMPANY = @P_CD_COMPANY   
AND CD_PLANT = @P_CD_PLANT   
AND NO_PO = @P_NO_PO    
AND NO_LINE = @P_NO_POLINE    
    
SELECT @FG_COMP = FG_COMP    
--CD_COMPANY, CD_PLANT, CD_PARTNER, CD_ITEM, CD_MATL    
FROM SU_BOML    
WHERE CD_COMPANY = @P_CD_COMPANY    
AND CD_PLANT = @P_CD_PLANT  
AND CD_PARTNER = @CD_PARTNER    
AND CD_ITEM = @CD_ITEM    
AND CD_MATL = @P_CD_MATL    
    
SELECT @FG_COMP = ISNULL(@FG_COMP, 'N')    
    
INSERT PU_POLL    
(NO_PO, NO_POLINE, CD_COMPANY, CD_PLANT, NO_LINE, CD_ITEM, CD_MATL, FG_COMP, FG_TAX, QT_NEED, UM_SAGUP, AM_SAGUP,     
AM_VAT, AM_HAP, DC_REMARK, QT_REQ, QT_ISU, QT_USE, QT_NEED_UNIT, DTS_INSERT, ID_INSERT, NO_RELATION, SEQ_RELATION, TXT_USERDEF1,
NUM_USERDEF1,TXT_USERDEF2,TXT_USERDEF3,TXT_USERDEF4,TXT_USERDEF5,NUM_USERDEF2)    
VALUES(@P_NO_PO, @P_NO_POLINE, @P_CD_COMPANY, @P_CD_PLANT, @P_NO_LINE, @CD_ITEM, @P_CD_MATL, @FG_COMP, @FG_TAX, @P_QT_NEED, 0, 0,     
0, 0, NULL, 0, 0, 0, @P_QT_NEED_UNIT, @P_DTS_INSERT, @P_ID_INSERT, @P_NO_RELATION, @P_SEQ_RELATION, @P_TXT_USERDEF1,
@P_NUM_USERDEF1,@P_TXT_USERDEF2,@P_TXT_USERDEF3,@P_TXT_USERDEF4,@P_TXT_USERDEF5,@P_NUM_USERDEF2)    
    
IF (@@ERROR <> 0 ) BEGIN SELECT @ERRNO  = 100000, @ERRMSG = '작업을 정상적으로 처리하지 못했습니다.' GOTO ERROR END    
    
RETURN    
ERROR: RAISERROR (@ERRMSG , 18 ,1)
GO


