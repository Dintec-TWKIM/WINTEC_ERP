USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_SO_MNG_TRUST_WINTEC_JSON]    Script Date: 2017-01-05 오후 5:48:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_SO_MNG_TRUST_WINTEC_JSON]          
(
	@P_JSON			NVARCHAR(MAX),
	@P_ID_USER		NVARCHAR(10)	
)  
AS
   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_ERRMSG NVARCHAR(255)   -- ERROR 메시지

BEGIN TRAN SP_CZ_SA_SO_MNG_TRUST_WINTEC
BEGIN TRY

SELECT * INTO #JSON_I
FROM OPENJSON(@P_JSON)
WITH
(
	CD_COMPANY      NVARCHAR(7),
	NO_SO			NVARCHAR(20),
	SEQ_SO			NUMERIC(5, 0),
	IDX				INT,
	CD_ITEM			NVARCHAR(20),
	NO_TRUST		NVARCHAR(15),
	JSON_FLAG		NVARCHAR(1)
) JS
WHERE JS.JSON_FLAG = 'I'

SELECT * INTO #JSON_D
FROM OPENJSON(@P_JSON)
WITH
(
	CD_COMPANY      NVARCHAR(7),
	NO_SO			NVARCHAR(20),
	SEQ_SO			NUMERIC(5, 0),
	IDX				INT,
	CD_ITEM			NVARCHAR(20),
	NO_TRUST		NVARCHAR(15),
	JSON_FLAG		NVARCHAR(1)
) JS
WHERE JS.JSON_FLAG = 'D'

SELECT * INTO #JSON_U
FROM OPENJSON(@P_JSON)
WITH
(
	CD_COMPANY      NVARCHAR(7),
	NO_SO			NVARCHAR(20),
	SEQ_SO			NUMERIC(5, 0),
	IDX				INT,
	CD_ITEM			NVARCHAR(20),
	NO_TRUST		NVARCHAR(15),
	JSON_FLAG		NVARCHAR(1)
) JS
WHERE JS.JSON_FLAG = 'U'

DELETE ST
FROM CZ_SA_SOL_TRUST_WINTEC ST
WHERE EXISTS (SELECT 1 
			  FROM #JSON_D JS
			  WHERE JS.CD_COMPANY = ST.CD_COMPANY
			  AND JS.NO_SO = ST.NO_SO
			  AND JS.SEQ_SO = ST.SEQ_SO
			  AND JS.IDX = ST.IDX
			  AND JS.CD_ITEM = ST.CD_ITEM)

INSERT INTO CZ_SA_SOL_TRUST_WINTEC
(
	CD_COMPANY,
	NO_SO,
	SEQ_SO,
	IDX,
	CD_ITEM,
	NO_TRUST,
	ID_INSERT,
	DTS_INSERT
)
SELECT CD_COMPANY,
	   NO_SO,
	   SEQ_SO,
	   IDX,
	   CD_ITEM,
	   NO_TRUST,
	   @P_ID_USER,
	   NEOE.SF_SYSDATE(GETDATE())
FROM #JSON_I

UPDATE ST
SET ST.NO_TRUST = JS.NO_TRUST,
	ST.ID_UPDATE = @P_ID_USER,
	ST.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
FROM CZ_SA_SOL_TRUST_WINTEC ST
JOIN #JSON_U JS ON JS.CD_COMPANY = ST.CD_COMPANY AND JS.NO_SO = ST.NO_SO AND JS.SEQ_SO = ST.SEQ_SO AND JS.IDX = ST.IDX AND JS.CD_ITEM = ST.CD_ITEM

DROP TABLE #JSON_I
DROP TABLE #JSON_D
DROP TABLE #JSON_U

COMMIT TRAN SP_CZ_SA_SO_MNG_TRUST_WINTEC

END TRY
BEGIN CATCH
	ROLLBACK TRAN SP_CZ_SA_SO_MNG_TRUST_WINTEC
	SELECT @V_ERRMSG = ERROR_MESSAGE()
	GOTO ERROR
END CATCH

RETURN
ERROR: 
RAISERROR(@V_ERRMSG, 16, 1)
ROLLBACK TRAN SP_CZ_SA_SO_MNG_TRUST_WINTEC

GO