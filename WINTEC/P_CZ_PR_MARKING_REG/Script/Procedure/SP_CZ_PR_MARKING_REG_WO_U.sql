USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_MARKING_REG_WO_U]    Script Date: 2017-01-05 오후 5:48:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_MARKING_REG_WO_U]          
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_NO_WO			NVARCHAR(20),
	@P_SEQ_WO			NUMERIC(5, 0),
	@P_NO_LINE			NUMERIC(5, 0),
	@P_YN_MARKING		NVARCHAR(1),
	@P_ID_UPDATE		NVARCHAR(15)
)
AS
   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_ERRMSG			VARCHAR(255)

BEGIN TRAN SP_CZ_PR_MARKING_REG_WO_U
BEGIN TRY

IF @P_YN_MARKING = 'Y'
BEGIN
	IF EXISTS (SELECT 1 
			   FROM CZ_PR_WO_INSP WM
			   WHERE WM.CD_COMPANY = @P_CD_COMPANY
			   AND WM.NO_WO = @P_NO_WO
			   AND WM.SEQ_WO = @P_SEQ_WO
			   AND WM.NO_LINE = @P_NO_LINE
			   AND WM.NO_INSP = 998)
	BEGIN
		UPDATE CZ_PR_WO_INSP
		SET YN_MARKING = @P_YN_MARKING,
		    ID_UPDATE = @P_ID_UPDATE,
			DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		WHERE CD_COMPANY = @P_CD_COMPANY
		AND NO_WO = @P_NO_WO
		AND SEQ_WO = @P_SEQ_WO
		AND NO_LINE = @P_NO_LINE
		AND NO_INSP = 998
	END
	ELSE
	BEGIN
		INSERT INTO CZ_PR_WO_INSP
		(
			CD_COMPANY,
		    NO_WO,
		    NO_LINE,
		    SEQ_WO,
		    NO_INSP,
		    DT_INSP,
		    NO_EMP,
		    YN_MARKING,
		    DTS_INSERT,
		    ID_INSERT
		)
		VALUES
		(
			@P_CD_COMPANY,
			@P_NO_WO,
			@P_NO_LINE,
			@P_SEQ_WO,
			998,
			CONVERT(CHAR(8), GETDATE(), 112),
			@P_ID_UPDATE,
			@P_YN_MARKING,
			NEOE.SF_SYSDATE(GETDATE()),
			@P_ID_UPDATE
		)
	END
END
ELSE
BEGIN
    DECLARE @V_QT_MARKING INT
	DECLARE @V_QT_WORK INT

	SELECT @V_QT_MARKING = ISNULL(WM.QT_MARKING, 0),
		   @V_QT_WORK = ISNULL(WR.QT_WORK, 0) 
	FROM PR_WO_ROUT WR
	LEFT JOIN (SELECT WM.CD_COMPANY, WM.NO_WO, WM.NO_LINE,
	 		   	      COUNT(1) AS QT_MARKING 
	 		   FROM CZ_PR_WO_INSP WM
	 		   WHERE WM.NO_INSP = 998 
			   AND WM.YN_MARKING = 'Y'
	 		   GROUP BY WM.CD_COMPANY, WM.NO_WO, WM.NO_LINE) WM
	ON WM.CD_COMPANY = WR.CD_COMPANY AND WM.NO_WO = WR.NO_WO AND WM.NO_LINE = WR.NO_LINE
	WHERE WR.CD_COMPANY = @P_CD_COMPANY
	AND WR.NO_WO = @P_NO_WO
	AND WR.NO_LINE = @P_NO_LINE

	IF (@V_QT_MARKING - 1) < @V_QT_WORK
 	BEGIN
		SET @V_ERRMSG = '마킹수량은 실적수량보다 많거나 같아야 합니다.'
		GOTO ERROR
	END
	ELSE
	BEGIN
		UPDATE A
		SET A.YN_MARKING = @P_YN_MARKING,
		    A.ID_UPDATE = @P_ID_UPDATE,
			A.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_WO_INSP A
		JOIN (SELECT CD_COMPANY,
			  	     NO_WO,
			  	     SEQ_WO,
					 NO_LINE,
			  	     ROW_NUMBER() OVER (PARTITION BY NO_WO, NO_LINE ORDER BY SEQ_WO DESC) AS IDX
			  FROM CZ_PR_WO_INSP
			  WHERE NO_INSP = 998 
			  AND YN_MARKING = 'Y') B
		ON B.CD_COMPANY = A.CD_COMPANY AND B.NO_WO = A.NO_WO AND B.SEQ_WO = A.SEQ_WO AND B.NO_LINE = A.NO_LINE AND B.IDX = 1
		WHERE A.CD_COMPANY = @P_CD_COMPANY
		AND A.NO_WO = @P_NO_WO
	END
END

COMMIT TRAN SP_CZ_PR_MARKING_REG_WO_U

END TRY
BEGIN CATCH
	ROLLBACK TRAN SP_CZ_PR_MARKING_REG_WO_U
	SELECT @V_ERRMSG = ERROR_MESSAGE()
	GOTO ERROR
END CATCH

RETURN
ERROR: 
RAISERROR(@V_ERRMSG, 16, 1)
ROLLBACK TRAN SP_CZ_PR_MARKING_REG_WO_U


GO