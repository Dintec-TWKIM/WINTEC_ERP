USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_MARKING_REG_WO_S1]    Script Date: 2017-01-05 오후 5:48:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_MARKING_REG_WO_S1]          
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_NO_WO			NVARCHAR(20),
	@P_NO_LINE			NUMERIC(5, 0)
)
AS
   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET NOCOUNT ON

SELECT TOP 1 WO.NO_WO,
	         WD.SEQ_WO,
			 WR.NO_LINE,
	         OP.NM_OP,
	         WO.CD_ITEM,
	         MI.NM_ITEM,
	         MI.NO_DESIGN,
			 WD.NO_ID,
	         WD.CD_QR
FROM PR_WO WO
JOIN PR_WO_ROUT WR ON WR.CD_COMPANY = WO.CD_COMPANY AND WR.NO_WO = WO.NO_WO
JOIN CZ_PR_WO_REQ_D WD ON WD.CD_COMPANY = WO.CD_COMPANY AND WD.NO_WO = WO.NO_WO
LEFT JOIN CZ_PR_WO_INSP WM ON WM.CD_COMPANY = WO.CD_COMPANY AND WM.NO_WO = WO.NO_WO AND WM.SEQ_WO = WD.SEQ_WO AND WM.NO_LINE = WR.NO_LINE AND WM.NO_INSP = 998
LEFT JOIN PR_WCOP OP ON OP.CD_COMPANY = WR.CD_COMPANY AND OP.CD_PLANT = WR.CD_PLANT AND OP.CD_WC = WR.CD_WC AND OP.CD_WCOP = WR.CD_WCOP
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = WO.CD_COMPANY AND MI.CD_PLANT = WO.CD_PLANT AND MI.CD_ITEM = WO.CD_ITEM
WHERE WO.CD_COMPANY = @P_CD_COMPANY
AND WO.NO_WO = @P_NO_WO
AND WR.NO_LINE = @P_NO_LINE
AND ISNULL(WM.YN_MARKING, 'N') = 'N'
AND ISNULL(WD.CD_QR, '') <> ''
AND (ISNULL(WR.CD_OP_BEFORE, '') = '' OR EXISTS (SELECT 1 
												 FROM CZ_PR_WO_INSP WI
												 JOIN PR_WO_ROUT WR1 ON WR1.CD_COMPANY = WI.CD_COMPANY AND WR1.NO_WO = WI.NO_WO AND WR1.NO_LINE = WI.NO_LINE
												 WHERE WI.CD_COMPANY = WR.CD_COMPANY
												 AND WI.NO_WO = WO.NO_WO
												 AND WR1.CD_OP = WR.CD_OP_BEFORE
												 AND WR1.CD_WC = WR.CD_WC_BEFORE
												 AND WR1.CD_WCOP = WR.CD_WCOP_BEFORE
												 AND WI.SEQ_WO = WD.SEQ_WO
												 AND ISNULL(WI.NO_INSP, '') <> '994'))
AND NOT EXISTS (SELECT 1 
				FROM CZ_PR_WO_INSP WI
				WHERE WI.CD_COMPANY = WO.CD_COMPANY
				AND WI.NO_WO = WO.NO_WO
				AND WI.NO_LINE < WR.NO_LINE
				AND WI.SEQ_WO = WD.SEQ_WO
				AND WI.NO_INSP = -1)
ORDER BY WD.SEQ_WO
OPTION(RECOMPILE)

GO