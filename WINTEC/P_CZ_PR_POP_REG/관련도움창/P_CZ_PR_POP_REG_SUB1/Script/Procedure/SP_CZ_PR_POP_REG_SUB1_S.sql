USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_POP_REG_SUB1_S]    Script Date: 2017-01-05 오후 5:48:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_POP_REG_SUB1_S]          
(
	@P_CD_COMPANY		NVARCHAR(7),
    @P_CD_PLANT			NVARCHAR(7),
	@P_NO_WO			NVARCHAR(20),
	@P_NO_LINE			NUMERIC(5, 0)
)  
AS
   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
       WD.NO_ID,
       RI.DC_ITEM,
       RI.NO_INSP,
       RI.TP_DATA,
       WI.NO_DATA1,
       WI.NO_DATA2,
       WI.NO_DATA3,
       WI.NO_DATA4,
       WI.NO_DATA5,
       (SELECT (CASE RI.TP_DATA WHEN 'MAX' THEN MAX(DATA) 
                                WHEN 'MIN' THEN MIN(DATA)
                                ELSE 0 END)
        FROM (VALUES (WI.NO_DATA1), (WI.NO_DATA2), (WI.NO_DATA3), (WI.NO_DATA4), (WI.NO_DATA5)) AS D (DATA)) AS NO_DATA,
       WO.CD_PLANT,
       WO.NO_WO,
       WD.SEQ_WO,
	   WR.NO_LINE,
       WI.DT_INSP,
       WI.NO_EMP,
       (CASE WHEN CHARINDEX('Ø', RI.DC_SPEC) = 0 THEN 0 ELSE CAST(REPLACE(RI.DC_SPEC, 'Ø', '') AS DECIMAL) END) AS SPEC_VALUE
FROM PR_WO WO
JOIN CZ_PR_WO_REQ_D WD ON WD.CD_COMPANY = WO.CD_COMPANY AND WD.NO_WO = WO.NO_WO
JOIN PR_WO_ROUT WR ON WR.CD_COMPANY = WO.CD_COMPANY AND WR.CD_PLANT = WO.CD_PLANT AND WR.NO_WO = WO.NO_WO
JOIN CZ_PR_ROUT_INSP RI ON RI.CD_COMPANY = WO.CD_COMPANY AND RI.CD_PLANT = WO.CD_PLANT AND RI.CD_ITEM = WO.CD_ITEM AND RI.NO_OPPATH = WO.PATN_ROUT AND RI.CD_OP = WR.CD_OP AND RI.CD_WCOP = WR.CD_WCOP
LEFT JOIN CZ_PR_WO_INSP WI ON WI.CD_COMPANY = WO.CD_COMPANY AND WI.NO_WO = WO.NO_WO AND WI.SEQ_WO = WD.SEQ_WO AND WI.NO_LINE = WR.NO_LINE AND WI.NO_INSP = RI.NO_INSP
WHERE WO.CD_COMPANY = @P_CD_COMPANY
AND WO.CD_PLANT = @P_CD_PLANT
AND WO.NO_WO = @P_NO_WO
AND WR.NO_LINE = @P_NO_LINE
AND WI.NO_WO IS NULL
ORDER BY WD.SEQ_WO, RI.NO_INSP

GO