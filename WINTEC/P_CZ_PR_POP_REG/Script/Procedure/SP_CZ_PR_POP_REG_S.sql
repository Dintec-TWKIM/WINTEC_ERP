USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_POP_REG_S]    Script Date: 2017-01-05 오후 5:48:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_POP_REG_S]          
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_CD_EQUIP			NVARCHAR(30),
	@P_NO_WO			NVARCHAR(20) = NULL
)  
AS
   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT WO.NO_WO,
	   WO.DT_DUE,
	   MI.NM_ITEM AS NM_PITEM, 
	   MI.NO_DESIGN,
	   MI.MAT_ITEM,
	   MI.STND_ITEM,
	   WR.QT_WO,
	   WR.QT_START,
	   WR.QT_WORK,
	   WR.QT_REJECT,
	   WR.QT_BAD,
	   WR.QT_REWORK,
	   WR.QT_WIP,
	   WR.QT_MOVE,
	   WR.QT_OUTPO,
	   (ISNULL(WR.QT_START, 0) - (ISNULL(WR.QT_WORK, 0) + ISNULL(WI.QT_OPOUT, 0))) AS QT_REMAIN,
	   (ISNULL(WR.QT_REJECT, 0) - ISNULL(WR.QT_REWORK, 0) - ISNULL(WR.QT_BAD, 0)) AS QT_REWORK_REMAIN,
	   OP.NM_OP,
	   (CASE WR.CD_USERDEF1 WHEN 'E' THEN '완료'
							WHEN 'I' THEN '진행'
							ELSE '대기' END) AS NM_ST_WO,
	   OP1.NM_OP AS NM_OP_NEXT,
	   WO.CD_PLANT,
	   WO.CD_ITEM AS CD_PITEM,
	   MI.MAT_ITEM,
	   WO.NO_SO,
	   WO.NO_LINE_SO,
	   MI.DC_RMK,
	   WR.NO_LINE,
	   WR.CD_OP,
	   WR.CD_WCOP,
	   WR.CD_OP_NEXT,
	   WR.CD_WCOP_NEXT,
	   WR.CD_OP_BEFORE,
	   WR.CD_WCOP_BEFORE,
	   OP2.NM_OP AS NM_OP_BEFORE,
	   WR.YN_FINAL,
	   WR.CD_WC_BEFORE,
	   WR.CD_WC,
	   WR.CD_WC_NEXT,
	   WR.CD_EQUIP,
	   EQ.NM_EQUIP,
	   ISNULL(NULLIF(RL.YN_INSP, ''), 'N') AS YN_INSP,
	   WO.PATN_ROUT,
	   ISNULL(WR.YN_SUBCON, 'N') AS YN_SUBCON,
	   WO.NO_SO,
	   WO.NO_LINE_SO,
	   RL.DC_OP,
	   MC.CD_FLAG2 AS CD_HEAT,
	   (CASE WHEN EXISTS (SELECT 1 
						  FROM CZ_PR_ROUT_FILE
						  WHERE CD_COMPANY = WO.CD_COMPANY
						  AND CD_PLANT = WO.CD_PLANT
						  AND CD_ITEM = WO.CD_ITEM
						  AND NO_OPPATH = WO.PATN_ROUT
						  AND CD_OP = WR.CD_OP
						  AND CD_WCOP = WR.CD_WCOP) THEN 'Y' ELSE 'N' END) AS YN_IMAGE,
	   (SELECT COUNT(1) 
		FROM CZ_PR_ROUT_INSP RI 
		WHERE RI.CD_COMPANY = WO.CD_COMPANY 
		AND RI.CD_PLANT = WO.CD_PLANT 
		AND RI.CD_ITEM = WO.CD_ITEM 
		AND RI.NO_OPPATH = WO.PATN_ROUT 
		AND RI.CD_OP = WR.CD_OP 
		AND RI.CD_WCOP = WR.CD_WCOP) AS QT_INSP
FROM PR_WO WO
LEFT JOIN PR_WO_ROUT WR ON WR.CD_COMPANY = WO.CD_COMPANY AND WR.NO_WO = WO.NO_WO
LEFT JOIN PR_WCOP OP ON OP.CD_COMPANY = WO.CD_COMPANY AND OP.CD_PLANT = WO.CD_PLANT AND OP.CD_WC = WR.CD_WC AND OP.CD_WCOP = WR.CD_WCOP
LEFT JOIN PR_WCOP OP1 ON OP1.CD_COMPANY = WO.CD_COMPANY AND OP1.CD_PLANT = WO.CD_PLANT AND OP1.CD_WC = WR.CD_WC_NEXT AND OP1.CD_WCOP = WR.CD_WCOP_NEXT
LEFT JOIN PR_WCOP OP2 ON OP2.CD_COMPANY = WO.CD_COMPANY AND OP2.CD_PLANT = WO.CD_PLANT AND OP2.CD_WC = WR.CD_WC_BEFORE AND OP2.CD_WCOP = WR.CD_WCOP_BEFORE
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = WO.CD_COMPANY AND MI.CD_PLANT = WO.CD_PLANT AND MI.CD_ITEM = WO.CD_ITEM
LEFT JOIN PR_ROUT_L RL ON RL.CD_COMPANY = WO.CD_COMPANY AND RL.CD_PLANT = WO.CD_PLANT AND RL.CD_ITEM = WO.CD_ITEM AND RL.NO_OPPATH = WO.PATN_ROUT AND RL.CD_OP = WR.CD_OP AND RL.YN_USE = 'Y'
LEFT JOIN PR_EQUIP EQ ON EQ.CD_COMPANY = WR.CD_COMPANY AND EQ.CD_PLANT = WR.CD_PLANT AND EQ.CD_EQUIP = WR.CD_EQUIP
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = WR.CD_COMPANY AND MC.CD_FIELD = 'CZ_WIN0011' AND MC.CD_FLAG1 = WR.CD_EQUIP
LEFT JOIN (SELECT WI.CD_COMPANY, WI.NO_WO, WI.NO_LINE,
                  COUNT(1) AS QT_OPOUT
           FROM CZ_PR_WO_INSP WI
           WHERE NO_INSP = '994'
           GROUP BY WI.CD_COMPANY, WI.NO_WO, WI.NO_LINE) WI
ON WI.CD_COMPANY = WO.CD_COMPANY AND WI.NO_WO = WO.NO_WO AND WR.NO_LINE = WI.NO_LINE
WHERE WO.CD_COMPANY = @P_CD_COMPANY
AND WR.QT_WIP > 0
AND (MI.FG_SERNO <> '999' OR EXISTS (SELECT 1 
									 FROM CZ_PR_WO_REQ_D WD 
									 WHERE WD.CD_COMPANY = WO.CD_COMPANY
									 AND WD.NO_WO = WO.NO_WO))
AND (ISNULL(@P_NO_WO, '') = '' OR WO.NO_WO = @P_NO_WO)
AND (ISNULL(@P_CD_EQUIP, '') = '' OR WR.CD_EQUIP = @P_CD_EQUIP)
ORDER BY ROW_NUMBER() OVER (PARTITION BY WR.CD_EQUIP ORDER BY ISNULL(NULLIF(WR.CD_USERDEF1, ''), '9999') ASC, WO.DT_REL)

GO

