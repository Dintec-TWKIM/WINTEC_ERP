USE [NEOE]
GO
/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_OPOUT_PR_REG_S]    Script Date: 2022-10-19 오후 5:42:37 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_PR_OPOUT_PR_REG_S]
(          
    @P_CD_COMPANY			NVARCHAR(7),                    
	@P_CD_PLANT				NVARCHAR(7),
	@P_NO_PR				NVARCHAR(20)  
)
AS

SELECT CD_COMPANY, CD_PLANT, NO_PR, DT_PR
FROM CZ_PR_OPOUT_PR 
WHERE CD_COMPANY = @P_CD_COMPANY
AND CD_PLANT = @P_CD_PLANT
AND NO_PR = @P_NO_PR
GROUP BY CD_COMPANY, CD_PLANT, NO_PR, DT_PR
ORDER BY NO_PR


SELECT 
	A.CD_COMPANY
,	A.CD_PLANT
,	A.NO_LINE
,	A.NO_WO
,	A.NO_EMP
,	B.NO_LINE AS NO_WO_LINE
,	A.CD_OP
,	A.CD_WC
,	E.NM_WC
,	A.CD_WCOP
,	D.NM_OP
,	A.CD_ITEM
,	C.NM_ITEM
,	C.STND_ITEM
,	C.NO_DESIGN
,	C.UNIT_IM
,	B.QT_START
,	A.QT_PR
,	A.DC_RMK
,	(CASE WHEN SUM(F.QT_RCV) = A.QT_PR THEN '완료'
		  WHEN SUM(F.QT_PO) > 0 AND SUM(F.QT_RCV) < A.QT_PR THEN '발주'
		  ELSE '요청' END) ST_PR
,	A.CD_PARTNER
,	G.LN_PARTNER
,	A.DT_DUE
,	B.CD_WCOP_NEXT
,	H.NM_OP AS NM_OP_NEXT
,	B.QT_START - SUM(ISNULL(J.QT_WORK,0)) - ISNULL(K.QT_PR, 0) AS QT_APPLY_YET
FROM CZ_PR_OPOUT_PR A
LEFT JOIN PR_WO_ROUT B ON B.CD_COMPANY = A.CD_COMPANY AND B.CD_PLANT = A.CD_PLANT AND B.NO_WO = A.NO_WO AND B.CD_OP = A.CD_OP
LEFT JOIN MA_PITEM C ON C.CD_COMPANY = A.CD_COMPANY AND C.CD_PLANT = A.CD_PLANT AND C.CD_ITEM = A.CD_ITEM
LEFT JOIN PR_WCOP D ON D.CD_COMPANY = A.CD_COMPANY AND D.CD_PLANT = A.CD_PLANT AND D.CD_WC = A.CD_WC AND D.CD_WCOP = A.CD_WCOP
LEFT JOIN MA_WC E ON E.CD_COMPANY = A.CD_COMPANY AND E.CD_PLANT = A.CD_PLANT AND E.CD_WC = A.CD_WC
LEFT JOIN PR_OPOUT_POL F ON F.CD_COMPANY = A.CD_COMPANY AND F.CD_PLANT = A.CD_PLANT AND F.DC_RMK = A.NO_PR AND F.NO_WO = A.NO_WO
LEFT JOIN MA_PARTNER G ON G.CD_COMPANY = A.CD_COMPANY AND G.CD_PARTNER = A.CD_PARTNER
LEFT JOIN PR_WCOP H ON H.CD_COMPANY = B.CD_COMPANY AND H.CD_PLANT = B.CD_PLANT AND H.CD_WC = B.CD_WC_NEXT AND H.CD_WCOP = B.CD_WCOP_NEXT
LEFT JOIN MA_WC I ON I.CD_COMPANY = B.CD_COMPANY AND I.CD_PLANT = B.CD_PLANT AND I.CD_WC = B.CD_WC_NEXT
LEFT JOIN PR_WORK J ON J.CD_COMPANY = A.CD_COMPANY AND J.NO_WO = A.NO_WO AND J.CD_OP = A.CD_OP AND ISNULL(J.NO_OPOUT_PO, '') = ''
LEFT JOIN (SELECT CD_COMPANY, CD_PLANT, NO_WO, CD_OP, SUM(QT_PR) AS QT_PR FROM CZ_PR_OPOUT_PR WHERE NO_PR != @P_NO_PR GROUP BY CD_COMPANY, CD_PLANT, NO_WO, CD_OP) K
ON K.CD_COMPANY = A.CD_COMPANY AND K.CD_PLANT = A.CD_PLANT AND K.NO_WO = A.NO_WO AND K.CD_OP = A.CD_OP
WHERE A.CD_COMPANY = @P_CD_COMPANY
AND A.CD_PLANT = @P_CD_PLANT
AND A.NO_PR = @P_NO_PR
GROUP BY 	A.CD_COMPANY, A.CD_PLANT ,A.NO_PR, A.NO_LINE,	A.NO_WO, B.NO_LINE, A.CD_OP, A.CD_WC,	E.NM_WC, A.CD_WCOP, D.NM_OP
		  , A.CD_ITEM,	C.NM_ITEM, C.STND_ITEM,	C.NO_DESIGN, C.UNIT_IM,	B.QT_START, A.QT_PR, A.DC_RMK, A.CD_PARTNER, G.LN_PARTNER, A.DT_DUE
		  , B.CD_WCOP_NEXT, H.NM_OP, A.NO_EMP, K.QT_PR

