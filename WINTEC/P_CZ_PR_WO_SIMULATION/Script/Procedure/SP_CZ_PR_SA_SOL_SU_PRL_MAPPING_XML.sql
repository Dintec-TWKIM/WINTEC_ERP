USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_SA_SOL_SU_PRL_MAPPING_XML]    Script Date: 2020-06-30 오후 7:14:12 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_SA_SOL_SU_PRL_MAPPING_XML]
(
	@P_XML	XML
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @DOC		INT

EXEC SP_XML_PREPAREDOCUMENT @DOC OUTPUT, @P_XML

PRINT CHAR(13) + '==================================================================================================== ▣ XML 임시테이블 생성'
SELECT CD_COMPANY, 
	   CD_PLANT,
	   NO_SO, 
	   NO_LINE, 
	   NO_PR,
	   NO_PRLINE,
	   CD_ITEM, 
	   QT_PR, 
	   ID_INSERT
INTO #XML
FROM OPENXML (@DOC, '/XML/ROW', 2) WITH
			 (CD_COMPANY	NVARCHAR(7),
			  CD_PLANT		NVARCHAR(7),
			  NO_SO			NVARCHAR(20), 
			  NO_LINE		NUMERIC(5, 0), 
			  NO_PR			NVARCHAR(20),
			  NO_PRLINE		NUMERIC(5, 0),
			  CD_ITEM		NVARCHAR(20), 
			  QT_PR			NUMERIC(17, 4), 
			  ID_INSERT		NVARCHAR(15))

EXEC SP_XML_REMOVEDOCUMENT @DOC

SET XACT_ABORT ON
BEGIN TRAN SP_CZ_PR_SA_SOL_SU_PRL_MAPPING
BEGIN TRY

INSERT INTO CZ_PR_SA_SOL_SU_PRL_MAPPING
(
	CD_COMPANY,
	CD_PLANT,
	NO_SO,
	NO_LINE,
	NO_PR,
	NO_PRLINE,
	CD_ITEM,
	QT_PR,
	ID_INSERT,
	DTS_INSERT
)
SELECT CD_COMPANY,
	   CD_PLANT,
	   NO_SO,
	   NO_LINE,
	   NO_PR,
	   NO_PRLINE,
	   CD_ITEM,
	   QT_PR,
	   ID_INSERT, 
	   NEOE.SF_SYSDATE(GETDATE()) 
FROM #XML

DROP TABLE #XML

COMMIT
END TRY
BEGIN CATCH
ROLLBACK
DECLARE @ERRMSG		NVARCHAR(255) = 'ERROR : ' + ERROR_MESSAGE() GOTO ERROR
END CATCH

RETURN
ERROR:RAISERROR(@ERRMSG, 18, 1)

GO