USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_OPOUT_REG_S]    Script Date: 2022-08-25 오후 3:41:01 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER   PROCEDURE [NEOE].[SP_CZ_PR_OPOUT_REG_S]  
(  
    @P_CD_COMPANY   NVARCHAR(7),   
    @P_NO_WO        NVARCHAR(20),
	@P_CD_PLANT     NVARCHAR(7),   
	@P_DT_PR_FROM	NVARCHAR(8),
	@P_DT_PR_TO		NVARCHAR(8)
)  
AS  

SELECT 
	'N' S
,	A.CD_COMPANY
,	A.CD_PLANT
,	A.NO_WO
,	A.DT_PR
,	A.CD_OP
,	D.NM_OP
,	E.NM_WC
,	A.CD_WC
,	A.CD_WCOP
,	A.CD_ITEM
,	F.NM_ITEM
,	F.STND_ITEM
,	F.NO_DESIGN
,	F.UNIT_IM
,	A.QT_PR, 0 QT_PR
,	MAX(A.DTS_INSERT) DTS_INSERT
,	MAX(A.ID_INSERT) ID_INSERT
,	MAX(A.DTS_UPDATE) DTS_UPDATE
,	MAX(A.ID_UPDATE) ID_UPDATE
,	(CASE WHEN SUM(G.QT_RCV) = SUM(A.QT_PR) THEN '완료'
		  WHEN SUM(G.QT_PO) > 0 AND SUM(G.QT_RCV) < SUM(A.QT_PR) THEN '발주'
		  ELSE '요청' END) ST_PR
,	C.QT_WIP - SUM(ISNULL(A.QT_PR, 0)) - SUM(ISNULL(G.QT_PO, 0)) AS QT_PR_ORIGIN
,	C.QT_START as QT_WIP
,	A.DC_RMK
,	C.NO_LINE AS NO_WO_LINE
,	F.MAT_ITEM
,	ROW_NUMBER() OVER(ORDER BY A.NO_WO) AS NO_LINE
FROM CZ_PR_OPOUT_PR A
LEFT JOIN PR_WO B ON A.CD_COMPANY = B.CD_COMPANY AND A.NO_WO = B.NO_WO
LEFT JOIN PR_WO_ROUT C ON A.CD_COMPANY = C.CD_COMPANY AND A.NO_WO = C.NO_WO AND A.CD_OP = C.CD_OP
LEFT JOIN PR_WCOP D ON C.CD_COMPANY = D.CD_COMPANY AND C.CD_WC = D.CD_WC AND C.CD_WCOP = D.CD_WCOP
LEFT JOIN MA_WC E ON C.CD_COMPANY = E.CD_COMPANY AND C.CD_PLANT = E.CD_PLANT AND C.CD_WC = E.CD_WC
LEFT JOIN MA_PITEM F ON A.CD_COMPANY = F.CD_COMPANY AND A.CD_ITEM = F.CD_ITEM
LEFT JOIN PR_OPOUT_POL G ON A.CD_COMPANY = G.CD_COMPANY AND A.CD_PLANT = G.CD_PLANT AND A.NO_WO = G.NO_WO AND A.CD_OP = G.CD_OP AND A.CD_WC = G.CD_WC AND A.CD_WCOP = G.CD_WCOP
WHERE A.CD_COMPANY = @P_CD_COMPANY
AND (@P_NO_WO IS NULL OR @P_NO_WO = '' OR @P_NO_WO = A.NO_WO)
AND @P_CD_PLANT = A.CD_PLANT
AND A.DT_PR BETWEEN @P_DT_PR_FROM AND @P_DT_PR_TO
GROUP BY A.CD_COMPANY, A.NO_WO, A.CD_PLANT, A.DT_PR, A.CD_OP, D.NM_OP, E.NM_WC,
A.CD_WC, A.CD_WCOP, A.CD_ITEM, F.NM_ITEM, F.STND_ITEM, F.NO_DESIGN, F.UNIT_IM, C.QT_WIP, C.QT_START, A.DC_RMK, C.NO_LINE, A.QT_PR, F.MAT_ITEM


GO


