USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_WO_MNGDL_S]    Script Date: 2022-08-19 오전 10:40:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_PR_WO_MNGDL_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_NO_WO			NVARCHAR(20),
	@P_SEQ_WO			NUMERIC(5, 0),
	@P_YN_INSP_ALL		NVARCHAR(1)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

WITH A AS
(
    SELECT WO.CD_COMPANY,
		   WO.CD_PLANT,
		   WO.NO_WO,
		   WO.CD_ITEM,
		   WO.PATN_ROUT,
		   RD.SEQ_WO,
		   WR.NO_LINE,
		   WR.CD_OP,
	       WR.CD_WC,
		   WC.NM_WC,
		   WR.CD_WCOP,
		   OP.NM_OP
	FROM PR_WO WO --작업지시
	LEFT JOIN PR_WO_ROUT WR ON WR.CD_COMPANY = WO.CD_COMPANY AND WR.NO_WO = WO.NO_WO --공정경로(작업지시)
	LEFT JOIN CZ_PR_WO_REQ_D RD ON RD.CD_COMPANY = WO.CD_COMPANY AND RD.NO_WO = WO.NO_WO --ID번호(작업지시)
	LEFT JOIN MA_WC WC ON WC.CD_COMPANY = WR.CD_COMPANY AND WC.CD_PLANT = WR.CD_PLANT AND WC.CD_WC = WR.CD_WC --W/C
	LEFT JOIN PR_WCOP OP ON OP.CD_COMPANY = WR.CD_COMPANY AND OP.CD_PLANT = WR.CD_PLANT AND OP.CD_WC = WR.CD_WC AND OP.CD_WCOP = WR.CD_WCOP --작업장별공정
	WHERE RD.CD_COMPANY = @P_CD_COMPANY
	AND RD.NO_WO = @P_NO_WO
	AND RD.SEQ_WO = @P_SEQ_WO
),
B AS
(
	SELECT A.NO_WO,
		   A.SEQ_WO,
		   A.NO_LINE,
		   RI.NO_INSP,
		   A.CD_OP,
	       A.CD_WC,
		   A.NM_WC,
		   A.CD_WCOP,
		   A.NM_OP,
		   RI.TP_DATA,
		   RI.DC_ITEM,
		   RI.CD_MEASURE,
		   RI.DC_LOCATION,
		   RI.DC_SPEC,
		   WI.NO_DATA1,
		   WI.NO_DATA2,
		   WI.NO_DATA3,
		   WI.NO_DATA4,
		   WI.NO_DATA5,
		   WI.NO_HEAT,
		   WI.YN_MARKING,
		   NULL AS NM_REJECT,
		   NULL AS NM_RESOURCE,
		   WI.NO_SO,
		   WI.DC_RMK,
		   WI.NO_OPOUT_PO
	FROM A
	LEFT JOIN CZ_PR_ROUT_INSP RI ON RI.CD_COMPANY = A.CD_COMPANY AND RI.CD_PLANT = A.CD_PLANT AND RI.CD_ITEM = A.CD_ITEM AND RI.NO_OPPATH = A.PATN_ROUT AND RI.CD_OP = A.CD_OP AND RI.CD_WCOP = A.CD_WCOP
	LEFT JOIN CZ_PR_WO_INSP WI ON WI.CD_COMPANY = A.CD_COMPANY AND WI.NO_WO = A.NO_WO AND WI.SEQ_WO = A.SEQ_WO AND WI.NO_LINE = A.NO_LINE AND WI.NO_INSP = RI.NO_INSP
	WHERE (ISNULL(@P_YN_INSP_ALL, 'N') = 'Y' OR WI.NO_INSP IS NOT NULL)
	UNION ALL
	SELECT A.NO_WO,
		   A.SEQ_WO,
		   A.NO_LINE,
		   WI.NO_INSP,
		   A.CD_OP,
	       A.CD_WC,
		   A.NM_WC,
		   A.CD_WCOP,
		   A.NM_OP,
		   NULL AS TP_DATA,
		   (CASE WHEN WI.NO_INSP = 0 THEN '열처리'
				 WHEN WI.NO_INSP = -1 THEN '불량'
				 WHEN (WI.NO_INSP = 994 AND WI.NO_OPOUT_PO IS NULL) THEN '요청'
				 WHEN (WI.NO_INSP = 994 AND WI.NO_OPOUT_PO IS NOT NULL) THEN '발주'
				 WHEN WI.NO_INSP = 995 THEN '외주'
				 WHEN WI.NO_INSP = 996 THEN '조립'
				 WHEN WI.NO_INSP = 997 THEN '현합'
				 WHEN WI.NO_INSP = 998 THEN '마킹'
				 WHEN WI.NO_INSP = 999 THEN '임의입력' END) AS DC_ITEM,
		   NULL AS CD_MEASURE,
		   NULL AS DC_LOCATION,
		   NULL AS DC_SPEC,
		   WI.NO_DATA1,
		   WI.NO_DATA2,
		   WI.NO_DATA3,
		   WI.NO_DATA4,
		   WI.NO_DATA5,
		   WI.NO_HEAT,
		   WI.YN_MARKING,
		   MC.NM_SYSDEF AS NM_REJECT,
		   MC1.NM_SYSDEF AS NM_RESOURCE,
		   WI.NO_SO,
		   WI.DC_RMK,
		   WI.NO_OPOUT_PO
	FROM A
	JOIN CZ_PR_WO_INSP WI ON WI.CD_COMPANY = A.CD_COMPANY AND WI.NO_WO = A.NO_WO AND WI.SEQ_WO = A.SEQ_WO AND WI.NO_LINE = A.NO_LINE AND WI.NO_INSP IN (0, -1, 994, 995, 996, 997, 998, 999)
	LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = WI.CD_COMPANY AND MC.CD_FIELD = 'QU_2000007' AND MC.CD_SYSDEF = WI.CD_REJECT
	LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = WI.CD_COMPANY AND MC1.CD_FIELD = 'QU_2000009' AND MC1.CD_SYSDEF = WI.CD_RESOURCE
)
SELECT 'N' AS S,
	   B.NO_WO,
	   B.SEQ_WO,
	   B.NO_LINE,
	   B.NO_INSP,
	   B.CD_OP,
	   B.CD_WC,
	   B.NM_WC,
	   B.CD_WCOP,
	   B.NM_OP,
	   B.TP_DATA,
	   B.DC_ITEM,
	   B.CD_MEASURE,
	   B.DC_LOCATION,
	   B.DC_SPEC,
	   B.NO_DATA1,
	   B.NO_DATA2,
	   B.NO_DATA3,
	   B.NO_DATA4,
	   B.NO_DATA5,
	   B.NO_HEAT,
	   B.YN_MARKING,
	   B.NM_REJECT,
	   B.NM_RESOURCE,
	   B.NO_SO,
	   B.DC_RMK,
	   B.NO_OPOUT_PO
FROM B
ORDER BY B.NO_WO,
	     B.SEQ_WO,
	     B.NO_LINE,
	     B.DC_LOCATION

GO


