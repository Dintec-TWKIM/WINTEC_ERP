USE [NEOE]
GO
/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_ASSEMBLING_MNG_S2]    Script Date: 2023-05-08 오전 10:46:04 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_ASSEMBLING_MNG_S2]          
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_NO_WO			NVARCHAR(20),
    @P_YN_ASSEMBLE      NVARCHAR(1)
)  
AS
   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT SW.NO_WO,
       SW.NO_SO,
       SW.NO_LINE,
       SL.DT_DUEDATE,
       SW.QT_APPLY,
       ISNULL(WI.QT_INSP, 0) AS QT_INSP,
       SL.TXT_USERDEF6 AS NM_VESSEL
FROM CZ_PR_SA_SOL_PR_WO_MAPPING SW
LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = SW.CD_COMPANY AND SL.NO_SO = SW.NO_SO AND SL.SEQ_SO = SW.NO_LINE
LEFT JOIN (SELECT WO.CD_COMPANY, WO.NO_WO, WI.NO_LINE, WI.NO_SO,
                  SUM(CASE WHEN AI.QT_ITEM = AD.QT_DATA THEN 1 ELSE 0 END) AS QT_INSP
           FROM PR_WO WO
           JOIN CZ_PR_WO_INSP WI ON WI.CD_COMPANY = WO.CD_COMPANY AND WI.NO_WO = WO.NO_WO
           LEFT JOIN (SELECT AI.CD_COMPANY, AI.CD_PLANT, AI.CD_ITEM,
                             SUM(AI.QT_ITEM) AS QT_ITEM       
                      FROM CZ_PR_ASSEMBLING_ITEM AI
                      GROUP BY AI.CD_COMPANY, AI.CD_PLANT, AI.CD_ITEM) AI
           ON AI.CD_COMPANY = WO.CD_COMPANY AND AI.CD_PLANT = WO.CD_PLANT AND AI.CD_ITEM = WO.CD_ITEM
           LEFT JOIN (SELECT AD.CD_COMPANY, AD.CD_PLANT, AD.NO_WO, AD.NO_LINE, AD.SEQ_WO,
                             COUNT(1) AS QT_DATA
                      FROM CZ_PR_ASSEMBLING_DATA AD
                      GROUP BY AD.CD_COMPANY, AD.CD_PLANT, AD.NO_WO, AD.NO_LINE, AD.SEQ_WO) AD
           ON AD.CD_COMPANY = WI.CD_COMPANY AND AD.CD_PLANT = WO.CD_PLANT AND AD.NO_WO = WI.NO_WO AND AD.NO_LINE = WI.NO_LINE AND AD.SEQ_WO = WI.SEQ_WO
           WHERE WI.NO_INSP = 996
           GROUP BY WO.CD_COMPANY, WO.NO_WO, WI.NO_LINE, WI.NO_SO) WI
ON WI.CD_COMPANY = SW.CD_COMPANY AND WI.NO_WO = SW.NO_WO AND WI.NO_SO = SW.NO_SO
WHERE SW.CD_COMPANY = @P_CD_COMPANY
AND SW.NO_WO = @P_NO_WO
AND (ISNULL(@P_YN_ASSEMBLE, 'N') = 'N' OR SW.QT_APPLY > ISNULL(WI.QT_INSP, 0))
ORDER BY SL.DT_DUEDATE ASC, SL.NO_SO ASC

