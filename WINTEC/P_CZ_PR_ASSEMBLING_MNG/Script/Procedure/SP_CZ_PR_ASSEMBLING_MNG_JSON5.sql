SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_ASSEMBLING_MNG_JSON5]          
(
	@P_JSON			NVARCHAR(MAX),
	@P_ID_USER		NVARCHAR(10)	
)  
AS
   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

UPDATE AD
SET AD.NO_ID_C = JS.NO_ID_C,
	AD.NO_HEAT = JS.NO_HEAT,
	AD.NO_LOT = JS.NO_LOT,
	AD.DT_ASSEMBLE = CONVERT(CHAR(8), GETDATE(), 112),
	AD.ID_UPDATE = @P_ID_USER,
	AD.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
FROM CZ_PR_ASSEMBLING_DATA AD
JOIN OPENJSON(@P_JSON)
WITH
(
	CD_COMPANY			NVARCHAR(7),
	CD_PLANT			NVARCHAR(7),
	NO_WO				NVARCHAR(20),
	NO_LINE				NUMERIC(5, 0),
	SEQ_WO				NUMERIC(5, 0),
	NO_ID				NVARCHAR(20),
	TP_POS				NVARCHAR(4),
	NO_ID_C				NVARCHAR(20),
	CD_PITEM			NVARCHAR(20),
	NO_HEAT				NVARCHAR(200),
	NO_LOT				NVARCHAR(20),
	JSON_FLAG			NVARCHAR(1)
) JS
ON JS.CD_COMPANY = AD.CD_COMPANY AND JS.CD_PLANT = AD.CD_PLANT AND JS.NO_WO = AD.NO_WO AND JS.NO_LINE = AD.NO_LINE AND JS.SEQ_WO = AD.SEQ_WO AND JS.NO_ID = AD.NO_ID AND JS.CD_PITEM = AD.CD_PITEM
WHERE JS.JSON_FLAG = 'I'

