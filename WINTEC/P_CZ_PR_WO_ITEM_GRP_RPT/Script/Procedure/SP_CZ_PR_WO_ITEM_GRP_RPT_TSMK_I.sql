USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_WO_ITEM_GRP_RPT_TSMK_I]    Script Date: 2022-09-08 오후 3:35:42 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [NEOE].[SP_CZ_PR_WO_ITEM_GRP_RPT_TSMK_I]
(  
    @P_CD_COMPANY   NVARCHAR(7),
	@P_NO_SO		NVARCHAR(20),
	@P_SEQ_SO		NUMERIC(5, 0),
	@P_ID_USER		NVARCHAR(10) 
)  
AS

BEGIN TRAN SP_CZ_PR_WO_ITEM_GRP_RPT_TSMK_I
BEGIN TRY

DECLARE @V_ERRMSG   VARCHAR(255),   -- ERROR 메시지
	    @V_STA_SO	NVARCHAR(1)

IF EXISTS (SELECT 1
		   FROM SA_SOL
		   WHERE CD_COMPANY = @P_CD_COMPANY
		   AND NO_SO = @P_NO_SO
		   AND SEQ_SO = @P_SEQ_SO
		   AND TXT_USERDEF9 = 'Y')
BEGIN
	SELECT @V_ERRMSG = '이미 마킹 요청된 수주 품목 입니다.'
	GOTO ERROR
END

SELECT @V_STA_SO = ISNULL(STA_SO, 'O')
FROM SA_SOL
WHERE CD_COMPANY = @P_CD_COMPANY
AND NO_SO = @P_NO_SO
AND SEQ_SO = @P_SEQ_SO 

IF @V_STA_SO = 'O'
BEGIN
	SELECT @V_ERRMSG = '수주상태가 미정이므로 의뢰하실 수 없습니다.'
	GOTO ERROR
END

IF @V_STA_SO = 'C'
BEGIN
	SELECT @V_ERRMSG = '수주상태가 종결이므로 의뢰하실 수 없습니다.'
	GOTO ERROR  
END

UPDATE SA_SOL
SET TXT_USERDEF9 = 'Y'
WHERE CD_COMPANY = @P_CD_COMPANY
AND NO_SO = @P_NO_SO
AND SEQ_SO = @P_SEQ_SO

COMMIT TRAN SP_CZ_PR_WO_ITEM_GRP_RPT_TSMK_I

END TRY
BEGIN CATCH
	ROLLBACK TRAN SP_CZ_PR_WO_ITEM_GRP_RPT_TSMK_I
	SELECT @V_ERRMSG = ERROR_MESSAGE()
	GOTO ERROR
END CATCH

RETURN
ERROR: 
RAISERROR(@V_ERRMSG, 16, 1)
ROLLBACK TRAN SP_CZ_PR_WO_ITEM_GRP_RPT_TSMK_I

GO


