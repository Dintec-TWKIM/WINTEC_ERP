USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_WO_SA_SOL_CHANGE_SWITCH]    Script Date: 2021-03-02 오전 10:51:36 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_WO_SA_SOL_CHANGE_SWITCH]
(
	@P_CD_COMPANY			NVARCHAR(7),
    @P_NO_WO_FROM			NVARCHAR(20),
	@P_NO_SO_FROM			NVARCHAR(20),
	@P_NO_LINE_FROM			NUMERIC(5, 0),
	@P_QT_APPLY_FROM		NUMERIC(17, 4),		
	@P_NO_WO_TO				NVARCHAR(20),
	@P_NO_SO_TO				NVARCHAR(20),
	@P_NO_LINE_TO			NUMERIC(5, 0),
	@P_QT_APPLY_TO			NUMERIC(17, 4),
	@P_ID_UPDATE			NVARCHAR(15)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @P_QT_APPLY_FROM = @P_QT_APPLY_TO
BEGIN
	IF EXISTS (SELECT 1 
			   FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
			   WHERE MP.CD_COMPANY = @P_CD_COMPANY
			   AND MP.NO_WO = @P_NO_WO_TO
			   AND MP.NO_SO = @P_NO_SO_FROM
			   AND MP.NO_LINE = @P_NO_LINE_FROM)
	BEGIN
		UPDATE MP
		SET MP.QT_APPLY = (MP.QT_APPLY + @P_QT_APPLY_FROM),
			MP.ID_UPDATE = @P_ID_UPDATE,
			MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_TO
		AND MP.NO_SO = @P_NO_SO_FROM
		AND MP.NO_LINE = @P_NO_LINE_FROM	
	END
	ELSE
	BEGIN
		UPDATE MP
		SET MP.NO_WO = @P_NO_WO_TO,
			MP.ID_UPDATE = @P_ID_UPDATE,
			MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_FROM
		AND MP.NO_SO = @P_NO_SO_FROM
		AND MP.NO_LINE = @P_NO_LINE_FROM	
	END

	IF EXISTS (SELECT 1 
			   FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
			   WHERE MP.CD_COMPANY = @P_CD_COMPANY
			   AND MP.NO_WO = @P_NO_WO_FROM
			   AND MP.NO_SO = @P_NO_SO_TO
			   AND MP.NO_LINE = @P_NO_LINE_TO)
	BEGIN
		UPDATE MP
		SET MP.QT_APPLY = (MP.QT_APPLY + @P_QT_APPLY_TO),
			MP.ID_UPDATE = @P_ID_UPDATE,
			MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_FROM
		AND MP.NO_SO = @P_NO_SO_TO
		AND MP.NO_LINE = @P_NO_LINE_TO
	END
	ELSE
	BEGIN
		UPDATE MP
		SET MP.NO_WO = @P_NO_WO_FROM,
			MP.ID_UPDATE = @P_ID_UPDATE,
			MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_TO
		AND MP.NO_SO = @P_NO_SO_TO
		AND MP.NO_LINE = @P_NO_LINE_TO
	END
END
ELSE IF @P_QT_APPLY_FROM > @P_QT_APPLY_TO
BEGIN
	IF EXISTS (SELECT 1 
			   FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
			   WHERE MP.CD_COMPANY = @P_CD_COMPANY
			   AND MP.NO_WO = @P_NO_WO_TO
			   AND MP.NO_SO = @P_NO_SO_FROM
			   AND MP.NO_LINE = @P_NO_LINE_FROM)
	BEGIN
		UPDATE MP
		SET MP.QT_APPLY = (MP.QT_APPLY + @P_QT_APPLY_TO),
			MP.ID_UPDATE = @P_ID_UPDATE,
			MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_TO
		AND MP.NO_SO = @P_NO_SO_FROM
		AND MP.NO_LINE = @P_NO_LINE_FROM	
	END
	ELSE
	BEGIN
		INSERT INTO CZ_PR_SA_SOL_PR_WO_MAPPING
		(
			CD_COMPANY,
			CD_PLANT,
			NO_SO,
			NO_LINE,
			NO_WO,
			CD_ITEM,
			QT_APPLY,
			ID_INSERT,
			DTS_INSERT
		)
		SELECT MP.CD_COMPANY,
			   MP.CD_PLANT,
			   MP.NO_SO,
			   MP.NO_LINE,
			   @P_NO_WO_TO,
			   MP.CD_ITEM,
			   @P_QT_APPLY_TO,
			   @P_ID_UPDATE,
			   NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_FROM
		AND MP.NO_SO = @P_NO_SO_FROM
		AND MP.NO_LINE = @P_NO_LINE_FROM		
	END

	UPDATE MP
	SET MP.QT_APPLY = (@P_QT_APPLY_FROM - @P_QT_APPLY_TO),
		MP.ID_UPDATE = @P_ID_UPDATE,
		MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
	WHERE MP.CD_COMPANY = @P_CD_COMPANY
	AND MP.NO_WO = @P_NO_WO_FROM
	AND MP.NO_SO = @P_NO_SO_FROM
	AND MP.NO_LINE = @P_NO_LINE_FROM
	
	IF EXISTS (SELECT 1 
			   FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
			   WHERE MP.CD_COMPANY = @P_CD_COMPANY
			   AND MP.NO_WO = @P_NO_WO_FROM
			   AND MP.NO_SO = @P_NO_SO_TO
			   AND MP.NO_LINE = @P_NO_LINE_TO)
	BEGIN
		UPDATE MP
		SET MP.QT_APPLY = (MP.QT_APPLY + @P_QT_APPLY_TO),
			MP.ID_UPDATE = @P_ID_UPDATE,
			MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_FROM
		AND MP.NO_SO = @P_NO_SO_TO
		AND MP.NO_LINE = @P_NO_LINE_TO
	END
	ELSE
	BEGIN
		INSERT INTO CZ_PR_SA_SOL_PR_WO_MAPPING
		(
			CD_COMPANY,
			CD_PLANT,
			NO_SO,
			NO_LINE,
			NO_WO,
			CD_ITEM,
			QT_APPLY,
			ID_INSERT,
			DTS_INSERT
		)
		SELECT MP.CD_COMPANY,
			   MP.CD_PLANT,
			   MP.NO_SO,
			   MP.NO_LINE,
			   @P_NO_WO_FROM,
			   MP.CD_ITEM,
			   MP.QT_APPLY,
			   @P_ID_UPDATE,
			   NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_TO
		AND MP.NO_SO = @P_NO_SO_TO
		AND MP.NO_LINE = @P_NO_LINE_TO		
	END

	DELETE MP
	FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
    WHERE MP.CD_COMPANY = @P_CD_COMPANY
    AND MP.NO_WO = @P_NO_WO_TO
	AND MP.NO_SO = @P_NO_SO_TO
	AND MP.NO_LINE = @P_NO_LINE_TO
END
ELSE IF @P_QT_APPLY_FROM < @P_QT_APPLY_TO
BEGIN
	IF EXISTS (SELECT 1 
			   FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
			   WHERE MP.CD_COMPANY = @P_CD_COMPANY
			   AND MP.NO_WO = @P_NO_WO_FROM
			   AND MP.NO_SO = @P_NO_SO_TO
			   AND MP.NO_LINE = @P_NO_LINE_TO)
	BEGIN
		UPDATE MP
		SET MP.QT_APPLY = (MP.QT_APPLY + @P_QT_APPLY_FROM),
			MP.ID_UPDATE = @P_ID_UPDATE,
			MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_FROM
		AND MP.NO_SO = @P_NO_SO_TO
		AND MP.NO_LINE = @P_NO_LINE_TO
	END
	ELSE
	BEGIN
		INSERT INTO CZ_PR_SA_SOL_PR_WO_MAPPING
		(
			CD_COMPANY,
			CD_PLANT,
			NO_SO,
			NO_LINE,
			NO_WO,
			CD_ITEM,
			QT_APPLY,
			ID_INSERT,
			DTS_INSERT
		)
		SELECT MP.CD_COMPANY,
			   MP.CD_PLANT,
			   MP.NO_SO,
			   MP.NO_LINE,
			   @P_NO_WO_FROM,
			   MP.CD_ITEM,
			   @P_QT_APPLY_FROM,
			   @P_ID_UPDATE,
			   NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_TO
		AND MP.NO_SO = @P_NO_SO_TO
		AND MP.NO_LINE = @P_NO_LINE_TO
	END

	UPDATE MP
	SET MP.QT_APPLY = (@P_QT_APPLY_TO - @P_QT_APPLY_FROM),
		MP.ID_UPDATE = @P_ID_UPDATE,
		MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
	WHERE MP.CD_COMPANY = @P_CD_COMPANY
	AND MP.NO_WO = @P_NO_WO_TO
	AND MP.NO_SO = @P_NO_SO_TO
	AND MP.NO_LINE = @P_NO_LINE_TO

	IF EXISTS (SELECT 1 
			   FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
			   WHERE MP.CD_COMPANY = @P_CD_COMPANY
			   AND MP.NO_WO = @P_NO_WO_TO
			   AND MP.NO_SO = @P_NO_SO_FROM
			   AND MP.NO_LINE = @P_NO_LINE_FROM)
	BEGIN
		UPDATE MP
		SET MP.QT_APPLY = (MP.QT_APPLY + @P_QT_APPLY_FROM),
			MP.ID_UPDATE = @P_ID_UPDATE,
			MP.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_TO
		AND MP.NO_SO = @P_NO_SO_FROM
		AND MP.NO_LINE = @P_NO_LINE_FROM
	END
	ELSE
	BEGIN
		INSERT INTO CZ_PR_SA_SOL_PR_WO_MAPPING
		(
			CD_COMPANY,
			CD_PLANT,
			NO_SO,
			NO_LINE,
			NO_WO,
			CD_ITEM,
			QT_APPLY,
			ID_INSERT,
			DTS_INSERT
		)
		SELECT MP.CD_COMPANY,
			   MP.CD_PLANT,
			   MP.NO_SO,
			   MP.NO_LINE,
			   @P_NO_WO_TO,
			   MP.CD_ITEM,
			   MP.QT_APPLY,
			   @P_ID_UPDATE,
			   NEOE.SF_SYSDATE(GETDATE())
		FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
		WHERE MP.CD_COMPANY = @P_CD_COMPANY
		AND MP.NO_WO = @P_NO_WO_FROM
		AND MP.NO_SO = @P_NO_SO_FROM
		AND MP.NO_LINE = @P_NO_LINE_FROM	
	END

	DELETE MP
	FROM CZ_PR_SA_SOL_PR_WO_MAPPING MP
    WHERE MP.CD_COMPANY = @P_CD_COMPANY
    AND MP.NO_WO = @P_NO_WO_FROM
    AND MP.NO_SO = @P_NO_SO_FROM
    AND MP.NO_LINE = @P_NO_LINE_FROM
END

GO