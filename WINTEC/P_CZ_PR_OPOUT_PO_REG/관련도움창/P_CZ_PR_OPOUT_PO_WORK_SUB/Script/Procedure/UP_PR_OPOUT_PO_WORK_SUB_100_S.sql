USE [NEOE]
GO
/****** Object:  StoredProcedure [NEOE].[UP_PR_OPOUT_PO_WORK_SUB_100_S]    Script Date: 2021-07-20 오후 7:06:43 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [NEOE].[UP_PR_OPOUT_PO_WORK_SUB_100_S]
(
	@P_CD_COMPANY			NVARCHAR(7),
	@P_CD_PLANT				NVARCHAR(7),
	@P_CD_PARTNER			NVARCHAR(20),
	@P_DT_START				NVARCHAR(8),
	@P_DT_END				NVARCHAR(8),
	@P_CD_EXCH				NVARCHAR(3),
	@P_RT_EXCH				NUMERIC(17, 4),
	@P_EXCEPT_LIST			VARCHAR(8000),
	@P_DT_PO				NVARCHAR(8),
	@P_RT_RATE				NUMERIC(17,4),
	@P_NO_WO				NVARCHAR(20)   = '',
	@P_NO_LOT				NVARCHAR(20)   = '',
	@P_CD_MULTI_TP_ROUT 	NVARCHAR(4000) = '',
	@P_WO_DCRMK_APPLY_YN	NVARCHAR(1)    = '',
	@P_NO_EMP				NVARCHAR(10)	= NULL
)
AS

DECLARE @YN_MFG_AUTH	NCHAR(1)
SELECT	@YN_MFG_AUTH  = ISNULL((SELECT	YN_MFG_AUTH
								FROM	MA_ENV
								WHERE	CD_COMPANY = @P_CD_COMPANY ), 'N')
								
SELECT	'N' AS CHK,
		K.CD_COMPANY,
		K.CD_PLANT,
		C.CD_PARTNER,
		R.CD_WC,
		R.CD_WCOP,
		R.NO_WO,
		R.CD_OP,
		W.CD_ITEM,
		M.NM_ITEM,
		M.STND_ITEM,
		M.UNIT_IM,
		W.QT_ITEM AS QT_WO,
		K.QT_MOVE AS QT_OUTPO,
		K.QT_MOVE - SUM(ISNULL(L.QT_PO, 0)) AS QT_APPLY_YET,
		K.QT_MOVE - SUM(ISNULL(L.QT_PO, 0)) AS QT_APPLY,
		SUM(ISNULL(L.QT_PO, 0)) AS QT_OPOUT_PO,
		P.LN_PARTNER,
		A.NM_WC,
		C.NM_OP,
		W.DT_REL,
		W.DT_DUE,
		R.NO_WO + '&' + R.CD_OP AS NO_WO_CD_OP,
		T.NM_TP_WO,
		W.NO_LOT,
		D.NM_SYSDEF AS NM_FG_SERNO,
		G.NM_ITEMGRP AS NM_GRP_ITEM,
		CASE WHEN ISNULL(@P_WO_DCRMK_APPLY_YN, 'N') = 'N' THEN '' 
		     ELSE W.DC_RMK 
		END DC_RMK1,
		K.NO_WORK,
		ISNULL(XX.UM, 0) AS UM_EX,
	   (ISNULL(R.QT_OUTPO, 0) - SUM(ISNULL(L.QT_PO, 0))) * ISNULL(XX.UM, 0) AS AM_EX,
		ISNULL(XX.UM, 0) * @P_RT_EXCH AS UM,
	   (ISNULL(R.QT_OUTPO, 0) - SUM(ISNULL(L.QT_PO, 0))) * ISNULL(XX.UM, 0) * @P_RT_EXCH AS AM,
		CASE WHEN ISNULL(@P_RT_RATE, 0) = 0 THEN 0
		     ELSE (ISNULL(R.QT_OUTPO, 0) - SUM(ISNULL(L.QT_PO, 0))) * ISNULL(XX.UM, 0) * @P_RT_EXCH / @P_RT_RATE
		END AM_VAT,
		XX.UM_MATL,
		XX.UM_SOUL,
		W.TP_ROUT,
		T.NM_TP_WO,
		M.FG_SERNO,
		M.GRP_ITEM,
		XX.UNIT_CH,
		XX.QT_CHCOEF,
		W.NO_PJT,
		J.NO_PROJECT AS NM_PJT,
		M.EN_ITEM,
		M.STND_DETAIL_ITEM,
		M.MAT_ITEM,
		M.NM_MAKER,
		M.BARCODE,
		M.NO_MODEL,
		W.TXT_USERDEF1 AS TXT_USERDEF1_WO
FROM	PR_WORK K
INNER JOIN PR_WO        W ON K.CD_COMPANY = W.CD_COMPANY AND K.CD_PLANT = W.CD_PLANT AND K.NO_WO = W.NO_WO
INNER JOIN PR_WO_ROUT   R ON K.CD_COMPANY = R.CD_COMPANY AND K.CD_PLANT = R.CD_PLANT AND K.NO_WO = R.NO_WO AND K.CD_WC = R.CD_WC_BEFORE
                         AND K.CD_WCOP = R.CD_WCOP_BEFORE
INNER JOIN PR_WCOP      C ON R.CD_COMPANY = C.CD_COMPANY AND R.CD_PLANT = C.CD_PLANT AND R.CD_WC = C.CD_WC AND R.CD_WCOP = C.CD_WCOP
INNER JOIN MA_PITEM     M ON W.CD_COMPANY = M.CD_COMPANY AND W.CD_PLANT = M.CD_PLANT AND W.CD_ITEM = M.CD_ITEM
LEFT  JOIN PR_OPOUT_POL L ON R.CD_COMPANY = L.CD_COMPANY AND R.CD_PLANT = L.CD_PLANT AND R.NO_WO = L.NO_WO AND R.CD_OP = L.CD_OP
                         AND R.CD_WC = L.CD_WC AND R.CD_WCOP = L.CD_WCOP AND K.NO_WORK = L.NO_WORK
LEFT  JOIN MA_PARTNER   P ON C.CD_COMPANY = P.CD_COMPANY AND C.CD_PARTNER = P.CD_PARTNER
LEFT  JOIN MA_WC        A ON R.CD_COMPANY = A.CD_COMPANY AND R.CD_PLANT = A.CD_PLANT AND R.CD_WC = A.CD_WC
LEFT  JOIN PR_TPWO      T ON W.CD_COMPANY = T.CD_COMPANY AND W.TP_ROUT = T.TP_WO
LEFT  JOIN MA_CODEDTL   D ON M.CD_COMPANY = D.CD_COMPANY AND D.CD_FIELD = 'MA_B000015' AND D.CD_SYSDEF = M.FG_SERNO
LEFT  JOIN MA_ITEMGRP   G ON G.CD_COMPANY = M.CD_COMPANY AND G.CD_ITEMGRP = M.GRP_ITEM
LEFT  JOIN (
			SELECT	U.CD_COMPANY, U.CD_PLANT, U.CD_WC, U.CD_WCOP, U.CD_PARTNER,
					U.CD_ITEM,    U.CD_EXCH,  U.UM,    U.UM_MATL, U.UM_SOUL,
					U.DT_END,     U.UNIT_CH,  U.QT_CHCOEF
			FROM	SU_UM_OP U
			INNER JOIN (
						SELECT	A.CD_COMPANY, A.CD_PLANT, A.CD_WC, A.CD_WCOP, W.CD_ITEM,
						        U.CD_PARTNER, U.CD_EXCH , MAX(DT_START) AS DT_START
						FROM    PR_WO_ROUT A
						INNER JOIN PR_WO    W ON W.CD_COMPANY = A.CD_COMPANY AND W.CD_PLANT = A.CD_PLANT AND W.NO_WO = A.NO_WO
						                     AND W.DT_REL    >= @P_DT_START  AND W.DT_DUE  <= @P_DT_END
						INNER JOIN SU_UM_OP U ON A.CD_COMPANY = U.CD_COMPANY AND A.CD_PLANT = U.CD_PLANT AND A.CD_WC = U.CD_WC
						                     AND A.CD_WCOP    = U.CD_WCOP    AND W.CD_ITEM = U.CD_ITEM
						WHERE	A.CD_COMPANY = @P_CD_COMPANY
						AND     A.CD_PLANT   = @P_CD_PLANT
						AND     A.ST_OP     <> 'C'
						AND     A.YN_SUBCON  = 'Y'
						AND    (A.NO_WO + '&' + A.CD_OP NOT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_EXCEPT_LIST)) OR @P_EXCEPT_LIST = '' OR @P_EXCEPT_LIST IS NULL)
						AND     A.NO_WO LIKE '%' + ISNULL(@P_NO_WO,'') + '%'
						AND     ISNULL(W.NO_LOT, '') LIKE '%' + ISNULL(@P_NO_LOT, '') + '%'
						AND    (W.TP_ROUT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_MULTI_TP_ROUT)) OR @P_CD_MULTI_TP_ROUT = '' OR @P_CD_MULTI_TP_ROUT IS NULL)
						AND		U.CD_EXCH  = @P_CD_EXCH
						GROUP BY A.CD_COMPANY, A.CD_PLANT, A.CD_WC, A.CD_WCOP, W.CD_ITEM, U.CD_PARTNER, U.CD_EXCH
            ) M ON U.CD_COMPANY = M.CD_COMPANY AND U.CD_PLANT = M.CD_PLANT AND U.CD_WC = M.CD_WC AND U.CD_WCOP = M.CD_WCOP
               AND U.CD_PARTNER = M.CD_PARTNER AND U.CD_ITEM = M.CD_ITEM AND U.CD_EXCH = M.CD_EXCH AND U.DT_START = M.DT_START
			WHERE	U.CD_COMPANY = @P_CD_COMPANY
			AND		U.CD_PLANT   = @P_CD_PLANT
			AND		U.DT_START  <= @P_DT_PO
) XX ON R.CD_COMPANY = XX.CD_COMPANY AND R.CD_PLANT = XX.CD_PLANT AND R.CD_WC = XX.CD_WC AND R.CD_WCOP = XX.CD_WCOP
    AND C.CD_PARTNER = XX.CD_PARTNER AND W.CD_ITEM = XX.CD_ITEM AND XX.DT_END >= W.DT_DUE
    LEFT JOIN SA_PROJECTH J ON W.CD_COMPANY = J.CD_COMPANY AND W.NO_PJT = J.NO_PROJECT
WHERE	K.CD_COMPANY = @P_CD_COMPANY
AND		K.CD_PLANT   = @P_CD_PLANT
AND		R.YN_SUBCON  = 'Y'
AND		R.ST_OP     <> 'C'
AND		W.DT_REL    >= @P_DT_START
AND     W.DT_DUE    <= @P_DT_END
AND    (R.NO_WO + '&' + R.CD_OP NOT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_EXCEPT_LIST)) OR @P_EXCEPT_LIST = '' OR @P_EXCEPT_LIST IS NULL)
AND     R.NO_WO LIKE '%' + ISNULL(@P_NO_WO, '') + '%'
AND     ISNULL(W.NO_LOT, '') LIKE '%' + ISNULL(@P_NO_LOT, '') + '%'
AND    (W.TP_ROUT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_MULTI_TP_ROUT)) OR @P_CD_MULTI_TP_ROUT = '' OR @P_CD_MULTI_TP_ROUT IS NULL)
AND    (C.CD_PARTNER = @P_CD_PARTNER OR @P_CD_PARTNER  = '' OR @P_CD_PARTNER IS NULL)
AND (	(@YN_MFG_AUTH <> 'Y' OR  ISNULL(@P_NO_EMP,'') =  '') 
	OR	(@YN_MFG_AUTH =  'Y' AND ISNULL(@P_NO_EMP,'') <> ''  AND EXISTS (SELECT	1       
																		 FROM	MA_MFG_AUTH AUTH      
																		 WHERE	AUTH.CD_COMPANY = W.CD_COMPANY
																		 AND	AUTH.CD_AUTH	= W.TP_ROUT
																		 AND	AUTH.FG_AUTH	= 'PR_TPWO'      
																		 AND	AUTH.NO_EMP		= @P_NO_EMP)) )   
AND (	(@YN_MFG_AUTH <> 'Y' OR  ISNULL(@P_NO_EMP,'') =  '')
    OR	(@YN_MFG_AUTH =  'Y' AND ISNULL(@P_NO_EMP,'') <> ''  AND EXISTS (SELECT	1
																		 FROM	MA_MFG_AUTH AUTH
																		 WHERE	AUTH.CD_COMPANY = R.CD_COMPANY
																		 AND	AUTH.CD_AUTH	= R.CD_WC
																		 AND	AUTH.FG_AUTH	= 'MA_WC'
																		 AND	AUTH.NO_EMP		= @P_NO_EMP)) )
GROUP BY K.CD_COMPANY, K.CD_PLANT, C.CD_PARTNER, R.CD_WC, R.CD_WCOP, R.NO_WO, R.CD_OP, W.CD_ITEM, M.NM_ITEM, M.STND_ITEM, M.UNIT_IM,
		W.QT_ITEM, K.QT_MOVE, P.LN_PARTNER, A.NM_WC, C.NM_OP, W.DT_REL, W.DT_DUE, R.NO_WO + '&' + R.CD_OP, T.NM_TP_WO, W.NO_LOT,
		D.NM_SYSDEF, G.NM_ITEMGRP, CASE WHEN ISNULL(@P_WO_DCRMK_APPLY_YN, 'N') = 'N' THEN '' ELSE W.DC_RMK END, K.NO_WORK,
		ISNULL(XX.UM, 0), ISNULL(R.QT_OUTPO, 0), XX.UM_MATL, XX.UM_SOUL, W.TP_ROUT, M.FG_SERNO, M.GRP_ITEM, XX.UNIT_CH, XX.QT_CHCOEF,
		W.NO_PJT,J.NO_PROJECT, M.EN_ITEM, M.STND_DETAIL_ITEM, M.MAT_ITEM, M.NM_MAKER, M.BARCODE, M.NO_MODEL, W.TXT_USERDEF1
HAVING K.QT_MOVE - SUM(ISNULL(L.QT_PO, 0)) > 0