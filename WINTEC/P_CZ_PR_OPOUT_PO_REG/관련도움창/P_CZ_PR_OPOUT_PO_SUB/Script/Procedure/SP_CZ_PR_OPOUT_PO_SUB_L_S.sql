USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_OPOUT_PO_SUB_L_S]    Script Date: 2021-07-20 오후 5:47:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_OPOUT_PO_SUB_L_S]
(
	@P_CD_COMPANY   NVARCHAR(7),
	@P_CD_PLANT     NVARCHAR(7),
	@P_CD_PARTNER   NVARCHAR(20),
	@P_DT_START     NVARCHAR(8),
	@P_DT_END       NVARCHAR(8), 
	@P_NO_PO        NVARCHAR(20),
	@P_NO_EMP		NVARCHAR(10)	 = NULL,
    @P_FG_LANG     NVARCHAR(4) = NULL	--언어
)
AS
-- MultiLang Call
EXEC UP_MA_LOCAL_LANGUAGE @P_FG_LANG

DECLARE	@YN_MFG_AUTH NCHAR(1)
SELECT @YN_MFG_AUTH = ISNULL((SELECT YN_MFG_AUTH FROM MA_ENV WHERE CD_COMPANY = @P_CD_COMPANY), 'N')

SELECT L.CD_PLANT, 
	   L.NO_PO, 
	   L.NO_LINE, 
	   L.NO_WO, 
	   L.CD_OP,
	   B.NM_OP, 
	   L.CD_WC,
	   A.NM_WC, 
	   L.CD_WCOP, 
	   L.NO_WORK, 
	   L.CD_ITEM,
	   P.NM_ITEM,
	   P.STND_ITEM,
	   P.UNIT_IM, 
	   L.DT_DUE, 
	   L.QT_PO, 
	   L.QT_RCV, 
	   L.QT_CLS, 
	   L.UM_EX, 
	   L.AM_EX, 
	   L.UM, 
	   L.AM, 
	   L.AM_VAT, 
	   L.DC_RMK, 
	   (R.QT_START - R.QT_OUTPO + L.QT_PO) AS QT_APPLY_YET, 
	   L.UM_MATL, 
	   L.UM_SOUL, 
	   L.OLD_QT_PO, 
	   L.UNIT_CH, 
	   L.QT_CHCOEF,
	   C.NO_PJT,
	   D.NM_PROJECT AS NM_PJT,
	   P.NO_DESIGN
FROM PR_OPOUT_POL L
JOIN PR_OPOUT_POH H ON H.CD_COMPANY = L.CD_COMPANY AND H.CD_PLANT = L.CD_PLANT AND H.NO_PO = L.NO_PO
JOIN PR_WO_ROUT	R ON R.CD_COMPANY = L.CD_COMPANY AND R.CD_PLANT = L.CD_PLANT AND R.NO_WO = L.NO_WO AND R.CD_OP = L.CD_OP
LEFT JOIN DZSN_MA_PITEM	P ON P.CD_COMPANY = L.CD_COMPANY AND P.CD_PLANT = L.CD_PLANT AND P.CD_ITEM = L.CD_ITEM
LEFT JOIN DZSN_MA_WC A ON A.CD_COMPANY = L.CD_COMPANY AND A.CD_PLANT = L.CD_PLANT AND A.CD_WC = L.CD_WC
LEFT JOIN DZSN_PR_WCOP B ON B.CD_COMPANY = L.CD_COMPANY AND B.CD_PLANT = L.CD_PLANT AND B.CD_WC = L.CD_WC AND B.CD_WCOP = L.CD_WCOP
LEFT JOIN PR_WO C ON L.CD_COMPANY = C.CD_COMPANY AND L.CD_PLANT = C.CD_PLANT AND L.NO_WO = C.NO_WO
LEFT JOIN DZSN_SA_PROJECTH D ON D.CD_COMPANY = C.CD_COMPANY AND D.NO_PROJECT = C.NO_PJT 
WHERE L.CD_COMPANY = @P_CD_COMPANY
AND L.CD_PLANT = @P_CD_PLANT
AND L.NO_PO = @P_NO_PO
AND	H.DT_PO BETWEEN @P_DT_START AND @P_DT_END
AND	(H.CD_PARTNER = @P_CD_PARTNER OR @P_CD_PARTNER = '' OR @P_CD_PARTNER IS NULL)
AND ((@YN_MFG_AUTH <> 'Y' OR ISNULL(@P_NO_EMP,'') =  '') OR
     (@YN_MFG_AUTH = 'Y' AND ISNULL(@P_NO_EMP,'') <> '' AND EXISTS (SELECT 1
																	FROM MA_MFG_AUTH AUTH
																	WHERE AUTH.CD_COMPANY = L.CD_COMPANY
																	AND AUTH.CD_AUTH = L.CD_WC
																	AND AUTH.FG_AUTH = 'MA_WC'
																	AND AUTH.NO_EMP = @P_NO_EMP)))

GO