USE [NEOE]
GO
/****** Object:  StoredProcedure [NEOE].[UP_CZ_PR_OPOUT_WORK_SELECT]    Script Date: 2023-03-15 오후 1:21:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [NEOE].[UP_CZ_PR_OPOUT_WORK_SELECT]
(
    @P_CD_COMPANY   	NVARCHAR(7),
    @P_CD_PLANT     	NVARCHAR(7),
    @P_CD_ITEM      	NVARCHAR(50),
    @P_NO_WO_FROM   	NVARCHAR(20),
    @P_NO_WO_TO     	NVARCHAR(20),
    @P_DT_PO_FROM     	NVARCHAR(8),
    @P_DT_PO_TO       	NVARCHAR(8),
    @P_NO_PO_FROM   	NVARCHAR(20),
    @P_NO_PO_TO     	NVARCHAR(20),
    @P_CONDITION    	NVARCHAR(20),
    @P_CD_MULTI_TP_ROUT NVARCHAR(4000),
    @P_CD_MULTI_CD_WC	NVARCHAR(4000),
    @P_NO_EMP			NVARCHAR(20)	= NULL,
    @P_CHK_DT_PO		NVARCHAR(1)		= 'Y',
    @P_CHK_DT_REL		NVARCHAR(1)		= 'N',
    @P_DT_REL     		NVARCHAR(8)		= NULL,
    @P_DT_DUE       	NVARCHAR(8)		= NULL,
    @P_YN_QT_REJECT		NVARCHAR(1)     = 'Y',
    @P_CD_PARTNER		NVARCHAR(20)	= NULL,
    @P_CD_WCOP			NVARCHAR(4)		= NULL,
    @P_ST_WO            NVARCHAR(10)	= NULL,
    @P_FG_LANG     NVARCHAR(4) = NULL	--언어
)
AS

SET NOCOUNT ON
SET ANSI_WARNINGS OFF
SET ARITHIGNORE ON
SET ARITHABORT OFF

-- MultiLang Call
EXEC UP_MA_LOCAL_LANGUAGE @P_FG_LANG

DECLARE @CD_BIZAREA		NVARCHAR(7),
		@YN_MFG_AUTH	NCHAR(1)

SELECT	@CD_BIZAREA  = ISNULL((SELECT CD_BIZAREA FROM DZSN_MA_PLANT WHERE CD_COMPANY = @P_CD_COMPANY AND CD_PLANT = @P_CD_PLANT), '')
SELECT  @YN_MFG_AUTH = ISNULL((SELECT YN_MFG_AUTH FROM MA_ENV WHERE CD_COMPANY = @P_CD_COMPANY), 'N')


SELECT	'N' AS CHK, 
		A.NO_WO, 
		A.CD_PLANT, 
		A.CD_ITEM, 
		P.NM_ITEM, 
		P.STND_ITEM, 
		P.UNIT_IM, 
		A.QT_ITEM, 
		A.FG_WO, 
		A.ST_WO, 
		A.DT_REL, 
		A.DT_DUE, 
		0.0000 AS QT_WO_WORK, 
		0.0000 AS QT_WO_REJECT, 
		A.TP_GI, 
		A.TP_GR, 
		P.FG_SERNO, 
		A.NO_LOT, 
		L.NO_PO, 
		L.NO_LINE AS NO_POLINE, 
		H.DT_PO,
		H.DC_RMK AS DC_RMK_H,
		CASE WHEN P.FG_SERNO = '002' THEN 'Y' ELSE 'N' END AS YN_LOT, 
		CASE WHEN P.FG_SERNO = '003' THEN 'Y' ELSE 'N' END AS YN_SERL, 
		P.CD_SL, 
		S.NM_SL,
		A.TP_ROUT, 
		T.NM_TP_WO,
		ISNULL(L.UM_EX,  0) AS UM_EX,
		ISNULL(L.UM,	 0) AS UM,
		ISNULL(L.AM_EX,  0) AS AM_EX,
		ISNULL(L.AM,	 0) AS AM,
		ISNULL(L.AM_VAT, 0) AS AM_VAT,
		ISNULL(L.QT_PO,  0) AS QT_PO,
		L.DC_RMK,
		L.DT_DUE AS DT_DLV,
		R.CD_OP,
		A.NO_PJT, 
		M.NM_PROJECT AS NM_PJT,  
		A.SEQ_PROJECT,
		D.CD_ITEM AS CD_PJT_ITEM,
		J.NM_ITEM AS NM_PJT_ITEM,
		J.STND_ITEM AS PJT_ITEM_STND,
		H.CD_PARTNER,
		N.LN_PARTNER,
		R.CD_WCOP,
		C.NM_OP,
		R.CD_WC,
		W.NM_WC,
		R.ST_OP,
		A.DC_RMK AS DC_RMK_WO,
		P.EN_ITEM,
		P.STND_DETAIL_ITEM,
		P.MAT_ITEM,
		P.NM_MAKER,
		P.BARCODE,
		P.NO_MODEL,
		A.TXT_USERDEF1 AS TXT_USERDEF1_WO,
		SUM(Z.QT_WORK),
		P.NO_DESIGN,
		L.NO_PR,
		CONVERT(decimal,L.AM_EX) / (L.UM_EX) AS WEIGHT
FROM PR_WO A
INNER JOIN PR_OPOUT_POL			L ON L.CD_COMPANY = A.CD_COMPANY AND L.CD_PLANT = A.CD_PLANT AND L.NO_WO = A.NO_WO
INNER JOIN PR_OPOUT_POH			H ON H.CD_COMPANY = L.CD_COMPANY AND H.CD_PLANT = L.CD_PLANT AND H.NO_PO = L.NO_PO 
INNER JOIN PR_WO_ROUT			R ON R.CD_COMPANY = A.CD_COMPANY AND R.CD_PLANT = A.CD_PLANT AND R.NO_WO = A.NO_WO AND R.CD_OP = L.CD_OP
INNER JOIN DZSN_MA_PITEM		P ON P.CD_COMPANY = A.CD_COMPANY AND P.CD_PLANT = A.CD_PLANT AND P.CD_ITEM = A.CD_ITEM
LEFT  JOIN DZSN_MA_SL			S ON S.CD_COMPANY = P.CD_COMPANY AND S.CD_PLANT = P.CD_PLANT AND S.CD_BIZAREA = @CD_BIZAREA AND S.CD_SL = P.CD_SL
LEFT  JOIN DZSN_PR_TPWO			T ON T.CD_COMPANY = A.CD_COMPANY AND T.TP_WO = A.TP_ROUT
LEFT  JOIN DZSN_SA_PROJECTH		M ON M.CD_COMPANY = A.CD_COMPANY AND M.NO_PROJECT = A.NO_PJT
LEFT  JOIN SA_PROJECTL			D ON D.CD_COMPANY = M.CD_COMPANY AND D.CD_PLANT = M.CD_PLANT AND D.NO_PROJECT = M.NO_PROJECT AND D.SEQ_PROJECT = A.SEQ_PROJECT
LEFT  JOIN DZSN_MA_PITEM		J ON J.CD_COMPANY = D.CD_COMPANY AND J.CD_PLANT = D.CD_PLANT AND J.CD_ITEM = D.CD_ITEM
LEFT  JOIN DZSN_MA_PARTNER		N ON N.CD_COMPANY = A.CD_COMPANY AND N.CD_PARTNER = H.CD_PARTNER
LEFT  JOIN DZSN_PR_WCOP			C ON C.CD_COMPANY = R.CD_COMPANY AND C.CD_PLANT = R.CD_PLANT AND C.CD_WCOP = R.CD_WCOP AND C.CD_WC = R.CD_WC
LEFT  JOIN DZSN_MA_WC			W ON W.CD_COMPANY = R.CD_COMPANY AND W.CD_PLANT = R.CD_PLANT AND W.CD_WC = R.CD_WC
LEFT  JOIN PR_WORK				Z ON Z.CD_COMPANY = L.CD_COMPANY AND Z.CD_PLANT = L.CD_PLANT AND Z.NO_OPOUT_PO = L.NO_PO AND Z.NO_OPOUT_PO_LINE = L.NO_LINE
WHERE	(A.CD_COMPANY = @P_CD_COMPANY)
AND		(A.CD_PLANT   = @P_CD_PLANT)
AND		(A.CD_ITEM = @P_CD_ITEM    OR @P_CD_ITEM    = '' OR @P_CD_ITEM    IS NULL)
AND		(A.NO_WO  >= @P_NO_WO_FROM OR @P_NO_WO_FROM = '' OR @P_NO_WO_FROM IS NULL)
AND		(A.NO_WO  <= @P_NO_WO_TO   OR @P_NO_WO_TO   = '' OR @P_NO_WO_TO   IS NULL)
AND		(L.NO_PO  >= @P_NO_PO_FROM OR @P_NO_PO_FROM = '' OR @P_NO_PO_FROM IS NULL)
AND		(L.NO_PO  <= @P_NO_PO_TO   OR @P_NO_PO_TO   = '' OR @P_NO_PO_TO   IS NULL)
AND		((@P_CHK_DT_PO = 'Y' AND H.DT_PO >= @P_DT_PO_FROM) OR @P_CHK_DT_PO = 'N')
AND		((@P_CHK_DT_PO = 'Y' AND H.DT_PO <= @P_DT_PO_TO)   OR @P_CHK_DT_PO = 'N')
AND		((@P_CHK_DT_REL = 'Y' AND A.DT_REL >= @P_DT_REL)   OR @P_CHK_DT_REL = 'N')
AND		((@P_CHK_DT_REL = 'Y' AND A.DT_DUE <= @P_DT_DUE)   OR @P_CHK_DT_REL = 'N')
AND		(L.QT_PO > L.QT_RCV)	--발주잔량이 있는건만
AND		(A.ST_WO IN ('R', 'S'))
AND		(A.TP_ROUT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_MULTI_TP_ROUT)) OR @P_CD_MULTI_TP_ROUT = '' OR @P_CD_MULTI_TP_ROUT IS NULL)
AND		(R.CD_WC   IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_MULTI_CD_WC))   OR @P_CD_MULTI_CD_WC   = '' OR @P_CD_MULTI_CD_WC   IS NULL)
--사용자 세부 권한
AND  (  (@YN_MFG_AUTH <> 'Y' OR  ISNULL(@P_NO_EMP,'') =  '')
	 OR	(@YN_MFG_AUTH =  'Y' AND ISNULL(@P_NO_EMP,'') <> '' AND EXISTS (SELECT	1
																		FROM	MA_MFG_AUTH AUTH
																		WHERE	AUTH.CD_COMPANY = A.CD_COMPANY
																		AND		AUTH.CD_AUTH	= A.TP_ROUT
																		AND		AUTH.FG_AUTH	= 'PR_TPWO'
																		AND		AUTH.NO_EMP		= @P_NO_EMP))	)
AND  (  (@YN_MFG_AUTH <> 'Y' OR  ISNULL(@P_NO_EMP,'') =  '')
	 OR	(@YN_MFG_AUTH =  'Y' AND ISNULL(@P_NO_EMP,'') <> '' AND EXISTS (SELECT	1
																		FROM	MA_MFG_AUTH AUTH
																		WHERE	AUTH.CD_COMPANY = R.CD_COMPANY
																		AND		AUTH.CD_AUTH	= R.CD_WC
																		AND		AUTH.FG_AUTH	= 'MA_WC'
																		AND		AUTH.NO_EMP		= @P_NO_EMP))	)
AND		(H.CD_PARTNER = @P_CD_PARTNER OR @P_CD_PARTNER = '' OR @P_CD_PARTNER IS NULL)
AND		(R.CD_WCOP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_WCOP))   OR @P_CD_WCOP   = '' OR @P_CD_WCOP   IS NULL)
GROUP BY A.NO_WO, A.CD_PLANT, A.CD_ITEM, P.NM_ITEM, P.STND_ITEM, P.UNIT_IM, A.QT_ITEM, A.FG_WO, A.ST_WO, A.DT_REL, A.DT_DUE, 
		 A.TP_GI, A.TP_GR, P.FG_SERNO, A.NO_LOT, L.NO_PO, L.NO_LINE, H.DT_PO, H.DC_RMK, P.FG_SERNO, P.CD_SL, S.NM_SL,A.TP_ROUT, 
		 T.NM_TP_WO, L.UM_EX, L.UM, L.AM_EX, L.AM, L.AM_VAT, L.QT_PO, L.DC_RMK, L.DT_DUE, R.CD_OP,A.NO_PJT, M.NM_PROJECT, A.SEQ_PROJECT,
		 D.CD_ITEM, J.NM_ITEM, J.STND_ITEM, H.CD_PARTNER, N.LN_PARTNER, R.CD_WCOP, C.NM_OP, R.CD_WC, W.NM_WC, R.ST_OP,
		 A.DC_RMK, P.EN_ITEM, P.STND_DETAIL_ITEM, P.MAT_ITEM, P.NM_MAKER, P.BARCODE, P.NO_MODEL, A.TXT_USERDEF1, P.NO_DESIGN,L.NO_PR
HAVING (L.QT_PO > SUM(ISNULL(Z.QT_WORK ,0)))
ORDER BY L.NO_PO ASC, L.NO_LINE ASC, A.NO_WO ASC