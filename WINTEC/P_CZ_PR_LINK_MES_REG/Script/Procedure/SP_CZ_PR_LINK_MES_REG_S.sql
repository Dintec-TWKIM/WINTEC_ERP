USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_LINK_MES_REG_S]    Script Date: 2021-03-22 오후 7:51:47 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_LINK_MES_REG_S]
(
	@P_CD_COMPANY	NVARCHAR(7),
	@P_CD_PLANT		NVARCHAR(7),
	@P_DT_WORK_S	NVARCHAR(8),
	@P_DT_WORK_E	NVARCHAR(8),
	@P_YN_END		NVARCHAR(1),
	@P_CD_ITEM_S	NVARCHAR(50),
	@P_CD_ITEM_E	NVARCHAR(50),
	@P_NO_WO		NVARCHAR(20),
	@P_CD_WC		NVARCHAR(7)
)
AS

SELECT	'N' AS S,
		LM.CD_PLANT,
		LM.NO_MES,
		LM.DT_WORK,
		LM.NO_EMP,
		ME.NM_KOR,
		LM.NO_WO,
		LM.NO_WORK,
		LM.CD_ITEM,
		MI.NM_ITEM,
		MI.NO_DESIGN,
		MI.STND_ITEM,
		MI.UNIT_MO,
		LM.QT_WORK,
		LM.YN_END,
		LM.CD_OP,
		LM.CD_WC,
		MW.NM_WC,
		LM.CD_WCOP,
		OP.NM_OP,
		LM.YN_WO,
		LM.CD_SL_IN,
		MS.NM_SL AS NM_SL_IN,
		LM.CD_ITEM_PARTNER,
		CI.NM_ITEM_PARTNER,
		CI.STND_ITEM_PARTNER,
		CI.UNIT_IM_PARTNER,
		CI.CD_ITEM AS CD_ITEM_P,
		MI1.NM_ITEM AS NM_ITEM_P,
		MI1.STND_ITEM AS STND_ITEM_P,
		MI1.UNIT_MO AS UNIT_MO_P,
		LM.CD_EQUIP,
		EQ.NM_EQUIP,
		LM.DTS_INSERT
FROM PR_LINK_MES LM
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = LM.CD_COMPANY AND ME.NO_EMP = LM.NO_EMP
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = LM.CD_COMPANY AND MI.CD_PLANT = LM.CD_PLANT AND MI.CD_ITEM = LM.CD_ITEM
LEFT JOIN MA_WC MW ON MW.CD_COMPANY = LM.CD_COMPANY AND MW.CD_PLANT = LM.CD_PLANT AND MW.CD_WC = LM.CD_WC
LEFT JOIN PR_WCOP OP ON OP.CD_COMPANY = LM.CD_COMPANY AND OP.CD_PLANT = LM.CD_PLANT AND OP.CD_WCOP = LM.CD_WCOP AND OP.CD_WC = LM.CD_WC
LEFT JOIN MA_SL MS ON MS.CD_COMPANY = LM.CD_COMPANY AND MS.CD_PLANT = LM.CD_PLANT AND MS.CD_SL = LM.CD_SL_IN
LEFT JOIN PR_EQUIP EQ ON EQ.CD_COMPANY = LM.CD_COMPANY AND EQ.CD_PLANT = LM.CD_PLANT AND EQ.CD_EQUIP = LM.CD_EQUIP
LEFT JOIN (SELECT CD_COMPANY,
				  CD_PLANT,
				  CD_ITEM_PARTNER,
				  NM_ITEM_PARTNER, 
			      STND_ITEM AS STND_ITEM_PARTNER,
				  UNIT_IM_PARTNER,
				  MAX(CD_ITEM) AS CD_ITEM
		   FROM	PU_CUSTITEM	
		   WHERE CD_COMPANY	= @P_CD_COMPANY
		   AND CD_PLANT	= @P_CD_PLANT
		   AND CD_PARTNER  = '13255'
		   GROUP BY CD_COMPANY, CD_PLANT, CD_ITEM_PARTNER, NM_ITEM_PARTNER, STND_ITEM, UNIT_IM_PARTNER) CI
ON CI.CD_COMPANY = LM.CD_COMPANY AND CI.CD_PLANT = LM.CD_PLANT AND CI.CD_ITEM_PARTNER = LM.CD_ITEM_PARTNER --거래처품목 : 갤럭시아디바이스전용 - 거래처코드 디폴트('13255')
LEFT JOIN MA_PITEM MI1 ON MI1.CD_COMPANY = CI.CD_COMPANY AND MI1.CD_PLANT = CI.CD_PLANT AND MI1.CD_ITEM = CI.CD_ITEM
WHERE LM.CD_COMPANY = @P_CD_COMPANY
AND LM.CD_PLANT = @P_CD_PLANT
AND	LM.YN_END = @P_YN_END
AND	LM.DT_WORK BETWEEN @P_DT_WORK_S AND @P_DT_WORK_E
AND (@P_NO_WO IS NULL OR @P_NO_WO = '' OR LM.NO_WO = @P_NO_WO)
AND	(@P_CD_ITEM_S IS NULL OR @P_CD_ITEM_S = '' OR LM.CD_ITEM >= @P_CD_ITEM_S)
AND	(@P_CD_ITEM_S IS NULL OR @P_CD_ITEM_S = '' OR LM.CD_ITEM <= @P_CD_ITEM_E)
AND (ISNULL(@P_CD_WC, '') = '' OR LM.CD_WC = @P_CD_WC)
ORDER BY LM.NO_MES DESC

GO