USE [NEOE]
GO
/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_LINK_MES_REG_I]    Script Date: 2021-03-08 오후 7:53:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [NEOE].[SP_CZ_PR_LINK_MES_REG_I]
(
	@P_CD_COMPANY	NVARCHAR(7),
	@P_CD_PLANT		NVARCHAR(7),
	@P_NO_MES		NVARCHAR(20)
)
AS

DECLARE
	@ERRMSG					NVARCHAR(255),
	@P_YN_END				NVARCHAR(1),
	@P_CD_ITEM				NVARCHAR(50),
	@P_YN_WO				NVARCHAR(1),
	@P_YN_WORK				NVARCHAR(1)
	
SELECT	@P_YN_END	= YN_END,
		@P_CD_ITEM	= CD_ITEM,
		@P_YN_WO	= YN_WO,
		@P_YN_WORK	= YN_WORK
FROM	NEOE.PR_LINK_MES
WHERE	CD_COMPANY	= @P_CD_COMPANY
AND		CD_PLANT	= @P_CD_PLANT
AND		NO_MES		= @P_NO_MES


IF (ISNULL(@P_YN_END, 'N') = 'Y')
BEGIN
	SELECT @ERRMSG = '[UP_PR_LINK_MES_REG_I] 이미 종결된 연동건입니다. [' + @P_NO_MES + ']' 
	GOTO ERROR
END

IF NOT EXISTS(SELECT 1 FROM MA_PITEM WHERE CD_COMPANY = @P_CD_COMPANY AND CD_PLANT = @P_CD_PLANT AND CD_ITEM = @P_CD_ITEM)
BEGIN
	SELECT @ERRMSG = '[UP_PR_LINK_MES_REG_I] 마스터에 등록되어 있지 않은 품목입니다. [' + @P_CD_ITEM + ']' 
	GOTO ERROR
END

 
-- <1 YN_WO가 'Y'인 건은 작업지시 생성>
IF (@P_YN_WO = 'Y')
BEGIN
	EXEC NEOE.SP_CZ_PR_LINK_MES_REG_WO_I @P_CD_COMPANY, @P_CD_PLANT, @P_NO_MES

	IF (@@ERROR <> 0)
	BEGIN
		SELECT @ERRMSG = '[UP_PR_LINK_MES_REG_I] 작업지시 연동오류.' 
		GOTO ERROR
	END
END


-- <2 소요자재창고이동, 자재청구 : 개발보류>
  --(일단작업지시소요자재에 대해 전부 B/F항목처럼 실적잡을때 들어가도록 개발)


-- <3 자재청구반품, 생산출고반품 : 개발보류>


-- <4 YN_WORK가 'Y'인 건은 작업실적 생성>
IF (@P_YN_WORK = 'Y')
BEGIN
	EXEC NEOE.SP_CZ_PR_LINK_MES_REG_WORK_I @P_CD_COMPANY, @P_CD_PLANT, @P_NO_MES

	IF (@@ERROR <> 0)
	BEGIN
		SELECT @ERRMSG = '[UP_PR_LINK_MES_REG_I] 작업실적 연동오류.' 
		GOTO ERROR
	END
END



-- <LAST. 연동테이블 UPDATE>
BEGIN
	UPDATE	NEOE.PR_LINK_MES
	SET		YN_END		= 'Y'
	WHERE	CD_COMPANY	= @P_CD_COMPANY
	AND		CD_PLANT	= @P_CD_PLANT
	AND		NO_MES		= @P_NO_MES
	
	IF (@@ERROR <> 0)
	BEGIN
		SELECT @ERRMSG = '[UP_PR_LINK_MES_REG_I] 연동테이블 UPDATE 오류.' 
		GOTO ERROR
	END
END


RETURN
ERROR: RAISERROR (@ERRMSG, 18, 1)