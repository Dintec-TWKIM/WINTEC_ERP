USE [NEOE]
GO
/****** Object:  StoredProcedure [NEOE].[SP_CZ_PR_ROUT_PITEM_S]    Script Date: 2023-05-15 오전 9:55:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PR_ROUT_PITEM_S]
(  
    @P_CD_COMPANY       NVARCHAR(7),  
    @P_CD_PLANT         NVARCHAR(7),  
    @P_CD_ITEM_FROM     NVARCHAR(50),  
    @P_CD_ITEM_TO       NVARCHAR(50),  
    @P_CLS_ITEM         NVARCHAR(20),   
    @P_CHECK_YN         NVARCHAR(1),  
    @P_TP_OPPATH        NVARCHAR(3),   
	@P_TP_PROC			NVARCHAR(3)		= NULL,
	@P_GRP_ITEM         NVARCHAR(20)	= NULL,
	@P_CLS_L			NVARCHAR(4)		= NULL,
	@P_CLS_M			NVARCHAR(4)		= NULL,
	@P_CLS_S			NVARCHAR(4)		= NULL,	
	@P_CD_WC			NVARCHAR(4000)  = NULL,
	@P_CD_WCOP			NVARCHAR(4000)  = NULL,
	@P_GRP_MFG			NVARCHAR(4)		= NULL,
    @P_FG_LANG			NVARCHAR(4) = NULL,	--언어
	@P_YN_INSP			NVARCHAR(3),
	@P_YN_FILE			NVARCHAR(3)
)  
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

-- MultiLang Call
EXEC UP_MA_LOCAL_LANGUAGE @P_FG_LANG

DECLARE @V_SERVER_KEY	NVARCHAR(25),
		@V_TP_PROC		NVARCHAR(10)

SELECT	@V_SERVER_KEY = MAX(SERVER_KEY) FROM CM_SERVER_CONFIG WHERE YN_UPGRADE = 'Y'
SET		@V_TP_PROC = 'M|S|'

--델리팜 : 외주품도 조회되도록
IF (@V_SERVER_KEY LIKE 'DELIF%') SET @V_TP_PROC = 'M|S|P|'
--하츠 : 전용메뉴(공정경로등록_HAZ)에서 패키지 SP를 호출하는데, 해당조회조건이 맨밑에 추가되지 않아 조회가 되지 않는현상발생
ELSE IF (@V_SERVER_KEY LIKE 'HAATZ%') SET @P_GRP_MFG = ''

IF (@P_CHECK_YN = 'A')        --전체 조회  
BEGIN
	WITH A AS
	(
		SELECT 'N' AS CHK, 
			   P.CD_ITEM, 
			   P.NM_ITEM, 
			   P.STND_ITEM, 
			   P.UNIT_MO, 
			   P.TP_PROC, 
			   P.CLS_ITEM, 
			   P.CD_PLANT, 
			   P.TP_BOM, 
			   P.NO_MODEL, 
			   P.NO_DESIGN,
			   P.GRP_ITEM,
			   G.NM_ITEMGRP,
			   P.CLS_L,
			   P.CLS_M,
			   P.CLS_S,
			   P.GRP_MFG,
			   MAX(LEFT(M.DTS_INSERT, 8)) AS DT_BOM,
			   P.DC_RMK1
	    FROM MA_PITEM P  
	    LEFT JOIN PR_ROUT B ON B.CD_COMPANY = P.CD_COMPANY AND B.CD_PLANT = P.CD_PLANT AND B.CD_ITEM = P.CD_ITEM 
	    LEFT JOIN MA_ITEMGRP G ON G.CD_COMPANY = P.CD_COMPANY  AND G.CD_ITEMGRP = P.GRP_ITEM     
	    LEFT JOIN PR_ROUT_L L ON L.CD_COMPANY = B.CD_COMPANY AND L.CD_PLANT = B.CD_PLANT AND L.CD_ITEM = B.CD_ITEM AND L.NO_OPPATH = B.NO_OPPATH AND L.TP_OPPATH = B.TP_OPPATH
	    LEFT JOIN PR_BOM M ON M.CD_COMPANY = P.CD_COMPANY AND M.CD_PLANT = P.CD_PLANT AND M.CD_ITEM = P.CD_ITEM
	    WHERE P.CD_COMPANY = @P_CD_COMPANY  
	    AND P.CD_PLANT = @P_CD_PLANT  
	    AND (P.CD_ITEM >= @P_CD_ITEM_FROM OR @P_CD_ITEM_FROM = '' OR @P_CD_ITEM_FROM IS NULL)  
	    AND (P.CD_ITEM <= @P_CD_ITEM_TO   OR @P_CD_ITEM_TO	= '' OR @P_CD_ITEM_TO	IS NULL)  
	    AND (P.CLS_ITEM = @P_CLS_ITEM OR @P_CLS_ITEM = '' OR @P_CLS_ITEM IS NULL)  
	    AND (B.TP_OPPATH = @P_TP_OPPATH OR @P_TP_OPPATH = '' OR @P_TP_OPPATH IS NULL)  
	    AND	P.TP_PROC IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@V_TP_PROC))
	    AND	P.YN_PHANTOM = 'N'
	    AND (P.TP_PROC = @P_TP_PROC OR @P_TP_PROC = '' OR @P_TP_PROC IS NULL) 
	    AND	P.YN_USE = 'Y'	--사용유무 'Y'만 조회 
	    AND (P.GRP_ITEM = @P_GRP_ITEM OR @P_GRP_ITEM = '' OR @P_GRP_ITEM IS NULL) 
	    AND	(P.CLS_L = @P_CLS_L OR @P_CLS_L = '' OR @P_CLS_L IS NULL)
		AND	(P.CLS_M = @P_CLS_M OR @P_CLS_M = '' OR @P_CLS_M IS NULL)
		AND	(P.CLS_S = @P_CLS_S OR @P_CLS_S = '' OR @P_CLS_S IS NULL)
		AND	(L.CD_WC IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_WC)) OR @P_CD_WC = '' OR @P_CD_WC IS NULL)
	    AND	(L.CD_WCOP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_WCOP)) OR @P_CD_WCOP = '' OR @P_CD_WCOP IS NULL)
		AND	(P.GRP_MFG = @P_GRP_MFG OR @P_GRP_MFG = '' OR @P_GRP_MFG IS NULL)   
		GROUP BY P.CD_COMPANY, P.CD_ITEM, P.NM_ITEM, P.STND_ITEM, P.UNIT_MO, P.TP_PROC, P.CLS_ITEM, P.CD_PLANT, P.TP_BOM, P.NO_MODEL, P.NO_DESIGN, P.GRP_ITEM, G.NM_ITEMGRP, P.CLS_L, P.CLS_M, P.CLS_S, P.GRP_MFG, P.DC_RMK1
	)
	SELECT A.CHK, 
		   A.CD_ITEM, 
		   A.NM_ITEM, 
		   A.STND_ITEM, 
		   A.UNIT_MO, 
		   A.TP_PROC, 
		   A.CLS_ITEM, 
		   A.CD_PLANT, 
		   A.TP_BOM, 
		   A.NO_MODEL, 
		   A.NO_DESIGN,
		   A.GRP_ITEM,
		   A.NM_ITEMGRP,
		   A.CLS_L,
		   A.CLS_M,
		   A.CLS_S,
		   A.GRP_MFG,
		   A.DT_BOM,
		   RI.QT_INSP,
		   RF.QT_FILE,
		   A.DC_RMK1
	FROM A
	LEFT JOIN (SELECT RI.CD_COMPANY, RI.CD_PLANT, RI.CD_ITEM, 
					  COUNT(NO_INSP) AS QT_INSP 
			   FROM CZ_PR_ROUT_INSP RI
			   GROUP BY RI.CD_COMPANY, RI.CD_PLANT, RI.CD_ITEM) RI
	ON RI.CD_COMPANY = @P_CD_COMPANY AND RI.CD_PLANT = A.CD_PLANT AND RI.CD_ITEM = A.CD_ITEM
	LEFT JOIN (SELECT RF.CD_COMPANY, RF.CD_PLANT, RF.CD_ITEM,
			   	      COUNT(1) AS QT_FILE
			   FROM CZ_PR_ROUT_FILE RF
			   JOIN PR_ROUT_L PR ON RF.CD_COMPANY = PR.CD_COMPANY AND RF.CD_PLANT = PR.CD_PLANT AND RF.CD_ITEM = PR.CD_ITEM AND RF.CD_ITEM = PR.CD_ITEM AND RF.CD_OP = PR.CD_OP AND RF.CD_WCOP = PR.CD_WCOP
			   GROUP BY RF.CD_COMPANY, RF.CD_PLANT, RF.CD_ITEM) RF
	ON RF.CD_COMPANY = @P_CD_COMPANY AND RF.CD_PLANT = A.CD_PLANT AND RF.CD_ITEM = A.CD_ITEM
	WHERE (ISNULL(@P_YN_INSP, '') = '' OR (@P_YN_INSP = '001' AND ISNULL(RI.QT_INSP, '') <> '') OR (@P_YN_INSP = '002' AND ISNULL(RI.QT_INSP, '') = ''))
	AND (ISNULL(@P_YN_FILE, '') = '' OR (@P_YN_FILE = '001' AND ISNULL(RF.QT_FILE, '') <> '') OR (@P_YN_FILE = '002' AND ISNULL(RF.QT_FILE, '') = ''))
	ORDER BY A.CD_ITEM
END  

IF (@P_CHECK_YN = 'Y')        --등록된 건만 조회  
BEGIN
	WITH A AS
	(
		SELECT 'N' AS CHK, 
			   P.CD_ITEM, 
			   P.NM_ITEM, 
			   P.STND_ITEM, 
			   P.UNIT_MO, 
			   P.TP_PROC, 
			   P.CLS_ITEM, 
			   P.CD_PLANT, 
			   P.TP_BOM, 
			   P.NO_MODEL, 
			   P.NO_DESIGN,
			   P.GRP_ITEM,
			   G.NM_ITEMGRP,
			   P.CLS_L,
			   P.CLS_M,
			   P.CLS_S,
			   P.GRP_MFG,
			   MAX(LEFT(M.DTS_INSERT, 8)) AS DT_BOM,
			   P.DC_RMK1
	    FROM MA_PITEM P  
	    JOIN PR_ROUT A ON A.CD_COMPANY = @P_CD_COMPANY AND A.CD_PLANT = @P_CD_PLANT AND A.CD_ITEM = P.CD_ITEM  
	    LEFT JOIN MA_ITEMGRP G ON G.CD_COMPANY = P.CD_COMPANY  AND G.CD_ITEMGRP = P.GRP_ITEM     
	    LEFT JOIN PR_ROUT_L L ON L.CD_COMPANY = A.CD_COMPANY AND L.CD_PLANT = A.CD_PLANT AND L.CD_ITEM = A.CD_ITEM AND L.NO_OPPATH = A.NO_OPPATH AND L.TP_OPPATH = A.TP_OPPATH
	    LEFT JOIN PR_BOM M ON M.CD_COMPANY = P.CD_COMPANY AND M.CD_PLANT = P.CD_PLANT AND M.CD_ITEM = P.CD_ITEM
	    WHERE P.CD_COMPANY = @P_CD_COMPANY  
	    AND P.CD_PLANT = @P_CD_PLANT  
	    AND (P.CD_ITEM >= @P_CD_ITEM_FROM OR @P_CD_ITEM_FROM = '' OR @P_CD_ITEM_FROM IS NULL)  
	    AND (P.CD_ITEM <= @P_CD_ITEM_TO   OR @P_CD_ITEM_TO	= '' OR @P_CD_ITEM_TO	IS NULL)  
	    AND (P.CLS_ITEM = @P_CLS_ITEM OR @P_CLS_ITEM = '' OR @P_CLS_ITEM IS NULL)  
	    AND (A.TP_OPPATH = @P_TP_OPPATH OR @P_TP_OPPATH = '' OR @P_TP_OPPATH IS NULL)  
	    AND	P.TP_PROC IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@V_TP_PROC))
	    AND	P.YN_PHANTOM = 'N'  
	    AND (P.TP_PROC = @P_TP_PROC OR @P_TP_PROC = '' OR @P_TP_PROC IS NULL) 
	    AND	P.YN_USE = 'Y'	--사용유무 'Y'만 조회 
	    AND (P.GRP_ITEM = @P_GRP_ITEM OR @P_GRP_ITEM = '' OR @P_GRP_ITEM IS NULL) 
	    AND	(P.CLS_L = @P_CLS_L OR @P_CLS_L = '' OR @P_CLS_L IS NULL)
		AND	(P.CLS_M = @P_CLS_M OR @P_CLS_M = '' OR @P_CLS_M IS NULL)
		AND	(P.CLS_S = @P_CLS_S OR @P_CLS_S = '' OR @P_CLS_S IS NULL)
	    AND	(L.CD_WC IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_WC)) OR @P_CD_WC = '' OR @P_CD_WC IS NULL)
	    AND	(L.CD_WCOP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_WCOP)) OR @P_CD_WCOP = '' OR @P_CD_WCOP IS NULL)
	    AND	(P.GRP_MFG = @P_GRP_MFG OR @P_GRP_MFG = '' OR @P_GRP_MFG IS NULL)   
	    GROUP BY P.CD_COMPANY, P.CD_ITEM, P.NM_ITEM, P.STND_ITEM, P.UNIT_MO, P.TP_PROC, P.CLS_ITEM, P.CD_PLANT, P.TP_BOM, P.NO_MODEL, P.NO_DESIGN, P.GRP_ITEM, G.NM_ITEMGRP, P.CLS_L, P.CLS_M, P.CLS_S,P.GRP_MFG, P.DC_RMK1
	)
	SELECT A.CHK, 
		   A.CD_ITEM, 
		   A.NM_ITEM, 
		   A.STND_ITEM, 
		   A.UNIT_MO, 
		   A.TP_PROC, 
		   A.CLS_ITEM, 
		   A.CD_PLANT, 
		   A.TP_BOM, 
		   A.NO_MODEL, 
		   A.NO_DESIGN,
		   A.GRP_ITEM,
		   A.NM_ITEMGRP,
		   A.CLS_L,
		   A.CLS_M,
		   A.CLS_S,
		   A.GRP_MFG,
		   A.DT_BOM,
		   RI.QT_INSP,
		   RF.QT_FILE,
		   A.DC_RMK1
	FROM A
	LEFT JOIN (SELECT RI.CD_COMPANY, RI.CD_PLANT, RI.CD_ITEM, 
					  COUNT(NO_INSP) AS QT_INSP 
			   FROM CZ_PR_ROUT_INSP RI
			   GROUP BY RI.CD_COMPANY, RI.CD_PLANT, RI.CD_ITEM) RI
	ON RI.CD_COMPANY = @P_CD_COMPANY AND RI.CD_PLANT = A.CD_PLANT AND RI.CD_ITEM = A.CD_ITEM
	LEFT JOIN (SELECT RF.CD_COMPANY, RF.CD_PLANT, RF.CD_ITEM,
			   	      COUNT(1) AS QT_FILE
			   FROM CZ_PR_ROUT_FILE RF
			   JOIN PR_ROUT_L PR ON RF.CD_COMPANY = PR.CD_COMPANY AND RF.CD_PLANT = PR.CD_PLANT AND RF.CD_ITEM = PR.CD_ITEM AND RF.CD_ITEM = PR.CD_ITEM AND RF.CD_OP = PR.CD_OP AND RF.CD_WCOP = PR.CD_WCOP
			   GROUP BY RF.CD_COMPANY, RF.CD_PLANT, RF.CD_ITEM) RF
	ON RF.CD_COMPANY = @P_CD_COMPANY AND RF.CD_PLANT = A.CD_PLANT AND RF.CD_ITEM = A.CD_ITEM
	WHERE (ISNULL(@P_YN_INSP, '') = '' OR (@P_YN_INSP = '001' AND ISNULL(RI.QT_INSP, '') <> '') OR (@P_YN_INSP = '002' AND ISNULL(RI.QT_INSP, '') = ''))
	AND (ISNULL(@P_YN_FILE, '') = '' OR (@P_YN_FILE = '001' AND ISNULL(RF.QT_FILE, '') <> '') OR (@P_YN_FILE = '002' AND ISNULL(RF.QT_FILE, '') = ''))
	ORDER BY A.CD_ITEM
END  

IF (@P_CHECK_YN = 'N')        --등록되지 않은건만 조회  
BEGIN
	WITH A AS
	(
		SELECT 'N' AS CHK, 
			   P.CD_ITEM, 
			   P.NM_ITEM, 
			   P.STND_ITEM, 
			   P.UNIT_MO, 
			   P.TP_PROC, 
			   P.CLS_ITEM, 
			   P.CD_PLANT, 
			   P.TP_BOM, 
			   P.NO_MODEL, 
			   P.NO_DESIGN,
			   P.GRP_ITEM,
			   G.NM_ITEMGRP,
			   P.CLS_L,
			   P.CLS_M,
			   P.CLS_S,
			   P.GRP_MFG,
			   MAX(LEFT(M.DTS_INSERT, 8)) AS DT_BOM,
			   P.DC_RMK1
		FROM MA_PITEM P   
		LEFT JOIN PR_ROUT B ON B.CD_COMPANY = P.CD_COMPANY AND B.CD_PLANT = P.CD_PLANT AND B.CD_ITEM = P.CD_ITEM   
	    LEFT JOIN MA_ITEMGRP G ON G.CD_COMPANY = P.CD_COMPANY  AND G.CD_ITEMGRP = P.GRP_ITEM     
		LEFT JOIN PR_ROUT_L L ON L.CD_COMPANY = B.CD_COMPANY AND L.CD_PLANT = B.CD_PLANT AND L.CD_ITEM = B.CD_ITEM AND L.NO_OPPATH = B.NO_OPPATH AND L.TP_OPPATH = B.TP_OPPATH
	    LEFT JOIN PR_BOM M ON M.CD_COMPANY = P.CD_COMPANY AND M.CD_PLANT = P.CD_PLANT AND M.CD_ITEM = P.CD_ITEM
		WHERE P.CD_COMPANY = @P_CD_COMPANY  
		AND P.CD_PLANT = @P_CD_PLANT  
		AND (P.CD_ITEM >= @P_CD_ITEM_FROM OR @P_CD_ITEM_FROM = '' OR @P_CD_ITEM_FROM IS NULL)  
		AND (P.CD_ITEM <= @P_CD_ITEM_TO   OR @P_CD_ITEM_TO	= '' OR @P_CD_ITEM_TO	IS NULL)  
		AND (P.CLS_ITEM = @P_CLS_ITEM OR @P_CLS_ITEM = '' OR @P_CLS_ITEM IS NULL)  
		AND (B.TP_OPPATH = @P_TP_OPPATH OR @P_TP_OPPATH = '' OR @P_TP_OPPATH IS NULL)  
	    AND	P.TP_PROC IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@V_TP_PROC))
		AND	P.YN_PHANTOM = 'N'  
	    AND (P.TP_PROC = @P_TP_PROC OR @P_TP_PROC = '' OR @P_TP_PROC IS NULL) 
		AND	NOT EXISTS ( SELECT 1 FROM PR_ROUT WHERE CD_COMPANY = P.CD_COMPANY AND CD_PLANT = P.CD_PLANT AND CD_ITEM = P.CD_ITEM )  
		AND	P.YN_USE = 'Y'   --사용유무 'Y'만 조회 
	    AND (P.GRP_ITEM = @P_GRP_ITEM OR @P_GRP_ITEM = '' OR @P_GRP_ITEM IS NULL) 
	    AND	(P.CLS_L = @P_CLS_L OR @P_CLS_L = '' OR @P_CLS_L IS NULL)
		AND	(P.CLS_M = @P_CLS_M OR @P_CLS_M = '' OR @P_CLS_M IS NULL)
		AND	(P.CLS_S = @P_CLS_S OR @P_CLS_S = '' OR @P_CLS_S IS NULL)
		AND	(L.CD_WC IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_WC)) OR @P_CD_WC = '' OR @P_CD_WC IS NULL)
	    AND	(L.CD_WCOP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_WCOP)) OR @P_CD_WCOP = '' OR @P_CD_WCOP IS NULL)
	    AND	(P.GRP_MFG = @P_GRP_MFG OR @P_GRP_MFG = '' OR @P_GRP_MFG IS NULL)   
		GROUP BY P.CD_COMPANY, P.CD_ITEM, P.NM_ITEM, P.STND_ITEM, P.UNIT_MO, P.TP_PROC, P.CLS_ITEM, P.CD_PLANT, P.TP_BOM, P.NO_MODEL, P.NO_DESIGN, P.GRP_ITEM, G.NM_ITEMGRP, P.CLS_L, P.CLS_M, P.CLS_S,P.GRP_MFG, P.DC_RMK1
	)
	SELECT A.CHK, 
		   A.CD_ITEM, 
		   A.NM_ITEM, 
		   A.STND_ITEM, 
		   A.UNIT_MO, 
		   A.TP_PROC, 
		   A.CLS_ITEM, 
		   A.CD_PLANT, 
		   A.TP_BOM, 
		   A.NO_MODEL, 
		   A.NO_DESIGN,
		   A.GRP_ITEM,
		   A.NM_ITEMGRP,
		   A.CLS_L,
		   A.CLS_M,
		   A.CLS_S,
		   A.GRP_MFG,
		   A.DT_BOM,
		   RI.QT_INSP,
		   RF.QT_FILE,
		   A.DC_RMK1
	FROM A
	LEFT JOIN (SELECT RI.CD_COMPANY, RI.CD_PLANT, RI.CD_ITEM, 
					  COUNT(NO_INSP) AS QT_INSP 
			   FROM CZ_PR_ROUT_INSP RI
			   GROUP BY RI.CD_COMPANY, RI.CD_PLANT, RI.CD_ITEM) RI
	ON RI.CD_COMPANY = @P_CD_COMPANY AND RI.CD_PLANT = A.CD_PLANT AND RI.CD_ITEM = A.CD_ITEM
	LEFT JOIN (SELECT RF.CD_COMPANY, RF.CD_PLANT, RF.CD_ITEM,
			   	      COUNT(1) AS QT_FILE
			   FROM CZ_PR_ROUT_FILE RF
			   JOIN PR_ROUT_L PR ON RF.CD_COMPANY = PR.CD_COMPANY AND RF.CD_PLANT = PR.CD_PLANT AND RF.CD_ITEM = PR.CD_ITEM AND RF.CD_ITEM = PR.CD_ITEM AND RF.CD_OP = PR.CD_OP AND RF.CD_WCOP = PR.CD_WCOP
			   GROUP BY RF.CD_COMPANY, RF.CD_PLANT, RF.CD_ITEM) RF
	ON RF.CD_COMPANY = @P_CD_COMPANY AND RF.CD_PLANT = A.CD_PLANT AND RF.CD_ITEM = A.CD_ITEM
	WHERE (ISNULL(@P_YN_INSP, '') = '' OR (@P_YN_INSP = '001' AND ISNULL(RI.QT_INSP, '') <> '') OR (@P_YN_INSP = '002' AND ISNULL(RI.QT_INSP, '') = ''))
	AND (ISNULL(@P_YN_FILE, '') = '' OR (@P_YN_FILE = '001' AND ISNULL(RF.QT_FILE, '') <> '') OR (@P_YN_FILE = '002' AND ISNULL(RF.QT_FILE, '') = ''))
	ORDER BY A.CD_ITEM	
END  

IF (@P_CHECK_YN = 'W')        --작업장 미등록 품목만 조회 
BEGIN
	WITH A AS
	(
		SELECT 'N' AS CHK, 
			   P.CD_ITEM, 
			   P.NM_ITEM, 
			   P.STND_ITEM, 
			   P.UNIT_MO, 
			   P.TP_PROC, 
			   P.CLS_ITEM, 
			   P.CD_PLANT, 
			   P.TP_BOM, 
			   P.NO_MODEL, 
			   P.NO_DESIGN,
			   P.GRP_ITEM,
			   G.NM_ITEMGRP,
			   P.CLS_L,
			   P.CLS_M,
			   P.CLS_S ,
			   P.GRP_MFG,
			   MAX(LEFT(M.DTS_INSERT, 8)) AS DT_BOM,
			   P.DC_RMK1
	    FROM MA_PITEM P  
	    JOIN PR_ROUT A ON A.CD_COMPANY = @P_CD_COMPANY AND A.CD_PLANT = @P_CD_PLANT AND A.CD_ITEM = P.CD_ITEM  
	    LEFT JOIN PR_ROUT_L C ON C.CD_COMPANY = A.CD_COMPANY AND C.CD_PLANT = A.CD_PLANT AND C.CD_ITEM = A.CD_ITEM AND C.NO_OPPATH = A.NO_OPPATH
	    LEFT JOIN DZSN_MA_ITEMGRP G ON G.CD_COMPANY = P.CD_COMPANY  AND G.CD_ITEMGRP = P.GRP_ITEM     
	    LEFT JOIN PR_BOM M ON M.CD_COMPANY = P.CD_COMPANY AND M.CD_PLANT = P.CD_PLANT AND M.CD_ITEM = P.CD_ITEM
	    WHERE P.CD_COMPANY = @P_CD_COMPANY  
	    AND	P.CD_PLANT = @P_CD_PLANT  
	    AND (P.CD_ITEM >= @P_CD_ITEM_FROM OR @P_CD_ITEM_FROM = '' OR @P_CD_ITEM_FROM IS NULL)  
	    AND (P.CD_ITEM <= @P_CD_ITEM_TO   OR @P_CD_ITEM_TO	= '' OR @P_CD_ITEM_TO	IS NULL)  
	    AND (P.CLS_ITEM = @P_CLS_ITEM OR @P_CLS_ITEM = '' OR @P_CLS_ITEM IS NULL)  
	    AND (A.TP_OPPATH = @P_TP_OPPATH OR @P_TP_OPPATH = '' OR @P_TP_OPPATH IS NULL)  
	    AND	P.TP_PROC IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@V_TP_PROC))
	    AND	P.YN_PHANTOM = 'N'  
	    AND	ISNULL(C.CD_WC,'') = ''
	    AND (P.TP_PROC = @P_TP_PROC OR @P_TP_PROC = '' OR @P_TP_PROC IS NULL) 
	    AND	P.YN_USE = 'Y'   --사용유무 'Y'만 조회 
	    AND (P.GRP_ITEM = @P_GRP_ITEM OR @P_GRP_ITEM = '' OR @P_GRP_ITEM IS NULL) 
	    AND	(P.CLS_L = @P_CLS_L OR @P_CLS_L = '' OR @P_CLS_L IS NULL)
		AND	(P.CLS_M = @P_CLS_M OR @P_CLS_M = '' OR @P_CLS_M IS NULL)
		AND	(P.CLS_S = @P_CLS_S OR @P_CLS_S = '' OR @P_CLS_S IS NULL)
	    AND	(C.CD_WC IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_WC)) OR @P_CD_WC = '' OR @P_CD_WC IS NULL)
	    AND	(C.CD_WCOP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_WCOP)) OR @P_CD_WCOP = '' OR @P_CD_WCOP IS NULL)
	    AND	(P.GRP_MFG = @P_GRP_MFG OR @P_GRP_MFG = '' OR @P_GRP_MFG IS NULL)   
	    GROUP BY P.CD_COMPANY, P.CD_ITEM, P.NM_ITEM, P.STND_ITEM, P.UNIT_MO, P.TP_PROC, P.CLS_ITEM, P.CD_PLANT, P.TP_BOM, P.NO_MODEL, P.NO_DESIGN, P.GRP_ITEM, G.NM_ITEMGRP, P.CLS_L, P.CLS_M, P.CLS_S,P.GRP_MFG, P.DC_RMK1
	)
	SELECT A.CHK, 
		   A.CD_ITEM, 
		   A.NM_ITEM, 
		   A.STND_ITEM, 
		   A.UNIT_MO, 
		   A.TP_PROC, 
		   A.CLS_ITEM, 
		   A.CD_PLANT, 
		   A.TP_BOM, 
		   A.NO_MODEL, 
		   A.NO_DESIGN,
		   A.GRP_ITEM,
		   A.NM_ITEMGRP,
		   A.CLS_L,
		   A.CLS_M,
		   A.CLS_S,
		   A.GRP_MFG,
		   A.DT_BOM,
		   RI.QT_INSP,
		   RF.QT_FILE,
		   A.DC_RMK1
	FROM A
	LEFT JOIN (SELECT RI.CD_COMPANY, RI.CD_PLANT, RI.CD_ITEM, 
					  COUNT(NO_INSP) AS QT_INSP 
			   FROM CZ_PR_ROUT_INSP RI
			   GROUP BY RI.CD_COMPANY, RI.CD_PLANT, RI.CD_ITEM) RI
	ON RI.CD_COMPANY = @P_CD_COMPANY AND RI.CD_PLANT = A.CD_PLANT AND RI.CD_ITEM = A.CD_ITEM
	LEFT JOIN (SELECT RF.CD_COMPANY, RF.CD_PLANT, RF.CD_ITEM,
			   	      COUNT(1) AS QT_FILE
			   FROM CZ_PR_ROUT_FILE RF
			   JOIN PR_ROUT_L PR ON RF.CD_COMPANY = PR.CD_COMPANY AND RF.CD_PLANT = PR.CD_PLANT AND RF.CD_ITEM = PR.CD_ITEM AND RF.CD_ITEM = PR.CD_ITEM AND RF.CD_OP = PR.CD_OP AND RF.CD_WCOP = PR.CD_WCOP
			   GROUP BY RF.CD_COMPANY, RF.CD_PLANT, RF.CD_ITEM) RF
	ON RF.CD_COMPANY = @P_CD_COMPANY AND RF.CD_PLANT = A.CD_PLANT AND RF.CD_ITEM = A.CD_ITEM
	WHERE (ISNULL(@P_YN_INSP, '') = '' OR (@P_YN_INSP = '001' AND ISNULL(RI.QT_INSP, '') <> '') OR (@P_YN_INSP = '002' AND ISNULL(RI.QT_INSP, '') = ''))
	AND (ISNULL(@P_YN_FILE, '') = '' OR (@P_YN_FILE = '001' AND ISNULL(RF.QT_FILE, '') <> '') OR (@P_YN_FILE = '002' AND ISNULL(RF.QT_FILE, '') = ''))
	ORDER BY A.CD_ITEM
END