USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_QU_INSP_SCHEDULE_S]    Script Date: 2015-04-14 오전 8:31:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_QU_INSP_SCHEDULE_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_TP_DATE			NVARCHAR(3),
	@P_DT_FROM			NVARCHAR(8),
	@P_DT_TO			NVARCHAR(8),
	@P_TP_COMPANY		NVARCHAR(4),
	@P_TP_INSP			NVARCHAR(4),
	@P_TP_CONTENTS		NVARCHAR(4),
	@P_TP_RESULT		NVARCHAR(4),
	@P_NO_SO			NVARCHAR(20)
) 
AS
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT QS.CD_COMPANY,
	   QS.NO_SO,
	   SH.NO_PO_PARTNER,
	   SH.DT_SO,
	   MP.LN_PARTNER,
	   SL.NO_HULL,
	   SL.NM_ENGINE,
	   SL.YN_INSP,
	   SL.NM_INSP1,
	   SL.NM_INSP2,
	   SL.CD_ITEM,
	   SL.NM_ITEM,
	   SL.QT_SO,
	   QS.TP_COMPANY,
	   QS.DT_INSP,
	   QS.TP_INSP,
	   QS.TP_CONTENTS,
	   QS.TP_RESULT,
	   QS.NO_CERT,
	   QS.DC_RMK
FROM CZ_QU_INSP_SCHEDULE QS
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = QS.CD_COMPANY AND SH.NO_SO = QS.NO_SO
LEFT JOIN (SELECT SL.CD_COMPANY,
				  SL.NO_SO,
				  MAX(SL.CD_ITEM) AS CD_ITEM,
				  MAX(MI.NM_ITEM) AS NM_ITEM,
				  MAX(SL.QT_SO) AS QT_SO,
				  MAX(SL.TXT_USERDEF6) AS NO_HULL,
				  MAX(CD.NM_SYSDEF) AS NM_ENGINE,
				  MAX(SL.YN_OPTION) AS YN_INSP,
				  MAX(SL.CD_USERDEF1) AS NM_INSP1,
				  MAX(SL.CD_USERDEF2) AS NM_INSP2
		   FROM SA_SOL SL
		   LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = SL.CD_COMPANY AND CD.CD_FIELD = 'CZ_WIN0003' AND CD.CD_SYSDEF = SL.CD_USERDEF3
		   LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = SL.CD_COMPANY AND MI.CD_PLANT = SL.CD_PLANT AND MI.CD_ITEM = SL.CD_ITEM
		   GROUP BY SL.CD_COMPANY, SL.NO_SO) SL
ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = SH.CD_COMPANY AND MP.CD_PARTNER = SH.CD_PARTNER
WHERE QS.CD_COMPANY = @P_CD_COMPANY
AND ((@P_TP_DATE = '000' AND SH.DT_SO BETWEEN @P_DT_FROM AND @P_DT_TO) OR 
     (@P_TP_DATE = '001' AND QS.DT_INSP BETWEEN @P_DT_FROM AND @P_DT_TO))
AND (ISNULL(@P_TP_COMPANY, '') = '' OR QS.TP_COMPANY = @P_TP_COMPANY)
AND (ISNULL(@P_TP_INSP, '') = '' OR QS.TP_INSP = @P_TP_INSP)
AND (ISNULL(@P_TP_CONTENTS, '') = '' OR QS.TP_CONTENTS = @P_TP_CONTENTS)
AND (ISNULL(@P_TP_RESULT, '') = '' OR QS.TP_RESULT = @P_TP_RESULT)
AND (ISNULL(@P_NO_SO, '') = '' OR QS.NO_SO = @P_NO_SO)

GO