USE [cus_dat]
GO

/****** Object:  StoredProcedure [dbo].[SP_ST_ESTIMATE_I]    Script Date: 2015-10-23 오후 6:23:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[SP_ST_ESTIMATE_I] 
(
	@P_ORD_NO				VARCHAR(20),
	@P_WRK_NM				VARCHAR(30),
	@P_OUT_CD				VARCHAR(30),
	@P_OUT_NM				VARCHAR(60),
	@P_VSL_NM				VARCHAR(40),
	@P_VSL_HULL_NO			VARCHAR(50),
	@P_REF_NO				VARCHAR(50),
	@P_XML					XML
) 
AS 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_DOC INT

EXEC SP_XML_PREPAREDOCUMENT @V_DOC OUTPUT, @P_XML 

SELECT * INTO #XML
FROM OPENXML (@V_DOC, '/XML/ROW', 2) WITH 
(
	ORD_LINENO		INT,
	SEQNO			DECIMAL(8, 1),
	ITEM_NO			VARCHAR(10),
	ITEM_CD			VARCHAR(30),
	ITEM_NM			VARCHAR(250),
	ITEM_UNIT		VARCHAR(6),
	QTY				DECIMAL(12, 2),
	OPT				VARCHAR(1)
)

EXEC SP_XML_REMOVEDOCUMENT @V_DOC 

INSERT INTO ST_ESTIMATE_M
(
	DB_TAG,
	ORD_NO,
	ORD_TAG,
	WRK_DATE,
	LOAD_DATE,
	WRK_NM,
	OUT_CD,
	OUT_NM,
	OUT_MAN,
	VSL_CD,
	VSL_NM,
	VSL_COMP,
	VSL_FLAG,
	LOAD_PLACE,
	EXRATE,
	CURR,
	AMTF,
	AMT,
	IN_AMTF,
	IN_AMT,
	VAT_YN,
	VAT_AMT,
	IN_VAT_AMT,
	MARGIN,
	REMARK,
	CREW_CNT,
	PSGR_CNT,
	SAIL_CNT,
	ANCH_NM,
	ANCH_CD,
	ENT_NO,
	CALL_SIGN,
	DEST_PORT_CD,
	DEST_PORT_NM,
	REF_NO,
	DC_AMT,
	IN_DC_AMT,
	CHARGE,
	EST_CHK,
	ORD_CHK,
	INV_CHK,
	TAX_CHK,
	EST_STATE,
	PK_CHARGE,
	OT_CHARGE,
	FT_CHARGE,
	PK_KRW_CHARGE,
	OT_KRW_CHARGE,
	FT_KRW_CHARGE,
	DC_AMTF,
	INV_CHARGE,
	DC_PER,
	DZ_OUT_TYPE,
	DZ_SLIP_CHK,
	DZ_JNO,
	DZ_DIV,
	VSL_HULL_NO,
	DC_DESC,
	PK_CHARGE_TITLE,
	OT_CHARGE_TITLE,
	FT_CHARGE_TITLE,
	REMARKS,
	LOCK_YN,
	PK_IN_CHARGE,
	OT_IN_CHARGE,
	FT_IN_CHARGE,
	PK_IN_KRW_CHARGE,
	OT_IN_KRW_CHARGE,
	FT_IN_KRW_CHARGE,
	UPD_YMD,
	RECE_CHK,
	IN_CD,
	IN_NM,
	DOC_NO,
	REQ_CHK,
	IN_CHK,
	TAKE_CHK,
	TAMT,
	TAMTF,
	TIN_AMT,
	TIN_AMTF,
	BIZ_NM,
	PART_ID,
	PLACE_ID,
	IN_DC_AMTF,
	IN_CHARGE_AMT,
	IN_CHARGE_AMTF,
	EXCHG_PL_AMT,
	ITEM_COUNT,
	IS_CHARGE_TITLE,
	IS_CHARGE,
	IS_KRW_CHARGE,
	CM_CHARGE_TITLE,
	CM_CHARGE,
	CM_KRW_CHARGE,
	COLL_YDAY,
	CUS_EXRATE,
	CUS_PASS_NO,
	OUT_CHK,
	ITEM_KIND,
	INV_KIND,
	CREDIT_PER,
	CREDIT_DESC,
	CREDIT_AMTF,
	CREDIT_AMT,
	SUM_ORD_NOS,
	SUM_REF_NOS,
	DEL_CHK,
	PAY_EXRATE,
	INV_NO,
	EST_STATUS,
	POUT_CD,
	POUT_NM,
	ITEM_DIV,
	PO_NO
)
VALUES
(
	'DB_ST_JO01', -- DB_TAG
	@P_ORD_NO,
	'EST', -- ORD_TAG
	CONVERT(DATETIME, CONVERT(NVARCHAR(8), GETDATE(), 112)), -- WRK_DATE
	CONVERT(DATETIME, CONVERT(NVARCHAR(8), GETDATE(), 112)), -- LOAD_DATE
	@P_WRK_NM,
	@P_OUT_CD,
	@P_OUT_NM,
	'', -- OUT_MAN
	'', -- VSL_CD
	@P_VSL_NM,
	'', -- VSL_COMP
	'', -- VSL_FLAG
	'', -- LOAD_PLACE
	1, -- EXRATE
	'USD', -- CURR
	0, -- AMTF
	0, -- AMT
	0, -- IN_AMTF
	0, -- IN_AMT
	'N', -- VAT_YN
	0, -- VAT_AMT
	0, -- IN_VAT_AMT
	0, -- MARGIN
	'', -- REMARK
	0, -- CREW_CNT
	0, -- PSGR_CNT
	0, -- SAIL_CNT
	'', -- ANCH_NM
	'', -- ANCH_CD
	'', -- ENT_NO
	'', -- CALL_SIGN
	'', -- DEST_PORT_CD
	'', -- DEST_PORT_NM
	@P_REF_NO,
	0, -- DC_AMT,
	0, -- IN_DC_AMT,
	0, -- CHARGE,
	'', -- EST_CHK,
	'', -- ORD_CHK,
	'', -- INV_CHK,
	'', -- TAX_CHK,
	'견적서', -- EST_STATE,
	0, -- PK_CHARGE,
	0, -- OT_CHARGE,
	0, -- FT_CHARGE,
	0, -- PK_KRW_CHARGE,
	0, -- OT_KRW_CHARGE,
	0, -- FT_KRW_CHARGE,
	0, -- DC_AMTF,
	0, -- INV_CHARGE,
	0, -- DC_PER,
	'', -- DZ_OUT_TYPE,
	'미처리', -- DZ_SLIP_CHK,
	'', -- DZ_JNO,
	'선식', -- DZ_DIV,
	@P_VSL_HULL_NO,
	'', -- DC_DESC,
	'PACKING CHARGES',
	'OTHER CHARGES',
	'FREIGHT CHARGES',
	'', -- REMARKS,
	'', -- LOCK_YN,
	0, -- PK_IN_CHARGE,
	0, -- OT_IN_CHARGE,
	0, -- FT_IN_CHARGE,
	0, -- PK_IN_KRW_CHARGE,
	0, -- OT_IN_KRW_CHARGE,
	0, -- FT_IN_KRW_CHARGE,
	CONVERT(DATETIME, CONVERT(NVARCHAR(8), GETDATE(), 112)), -- UPD_YMD,
	'', -- RECE_CHK
	'', -- IN_CD,
	'', -- IN_NM,
	'', -- DOC_NO,
	'', -- REQ_CHK,
	'', -- IN_CHK,
	'N', -- TAKE_CHK,
	0, -- TAMT,
	0, -- TAMTF,
	0, -- TIN_AMT,
	0, -- TIN_AMTF,
	@P_WRK_NM,
	'JAEIL-0001',
	'BUSAN00001',
	0, -- IN_DC_AMTF,
	0, -- IN_CHARGE_AMT,
	0, -- IN_CHARGE_AMTF,
	0, -- EXCHG_PL_AMT,
	(SELECT COUNT(1) FROM #XML), -- ITEM_COUNT
	'', -- IS_CHARGE_TITLE,
	0, -- IS_CHARGE,
	0, -- IS_KRW_CHARGE,
	'', -- CM_CHARGE_TITLE,
	0, -- CM_CHARGE,
	0, -- CM_KRW_CHARGE,
	0, -- COLL_YDAY,
	0, -- CUS_EXRATE,
	'     -  -', -- CUS_PASS_NO,
	'', -- OUT_CHK,
	'', -- ITEM_KIND,
	'', -- INV_KIND,
	0, -- CREDIT_PER,
	'', -- CREDIT_DESC,
	0, -- CREDIT_AMTF,
	0, -- CREDIT_AMT,
	'', -- SUM_ORD_NOS,
	'', -- SUM_REF_NOS,
	'', -- DEL_CHK,
	0, -- PAY_EXRATE,
	'', -- INV_NO,
	'', -- EST_STATUS,
	'', -- POUT_CD,
	'', -- POUT_NM,
	'', -- ITEM_DIV,
	'' -- PO_NO
)

INSERT INTO ST_ESTIMATE_S
(
	DB_TAG,
	ORD_NO,
	ORD_TAG,
	ORD_LINENO,
	SEQNO,
	ITEM_NO,
	ITEM_CD,
	ITEM_NM,
	ITEM_UNIT,
	ITEM_EDIDIV,
	PRICE,
	PRICEF,
	QTY,
	AMT,
	AMTF,
	VAT_YN,
	VAT_AMT,
	MARGIN,
	IN_CD,
	IN_NM,
	IN_PRICE,
	IN_PRICEF,
	IN_QTY,
	IN_AMT,
	IN_AMTF,
	IN_VAT_YN,
	OPT,
	STCK_CHK,
	INQTY_CHK,
	IN_CD1,
	IN_NM1,
	IN_CURR,
	IN_EXRATE,
	MARGIN_AMT,
	COST_PRICE,
	COST_AMT
)
SELECT 'DB_ST_JO01', -- DB_TAG
		@P_ORD_NO,
		'EST', -- ORD_TAG
		ORD_LINENO,
		SEQNO,
		ITEM_NO,
		ITEM_CD,
		ITEM_NM,
		ITEM_UNIT,
		'N', -- ITEM_EDIDIV
		0, -- PRICE
		0, -- PRICEF
		QTY,
		0, -- AMT
		0, -- AMTF
		'3', -- VAT_YN
		0, -- VAT_AMT
		0, -- MARGIN
		'', -- IN_CD
		'', -- IN_NM
		0, -- IN_PRICE
		0, -- IN_PRICEF
		QTY, -- IN_QTY
		0, -- IN_AMT
		0, -- IN_AMTF
		'3', -- IN_VAT_YN,
		OPT, -- OPT
		'N', -- STCK_CHK
		'N', -- INQTY_CHK
		'',  -- IN_CD1,
		'', -- IN_NM1,
		'', -- IN_CURR
		0, -- IN_EXRATE
		0, -- MARGIN_AMT
		0, -- COST_PRICE
		0 -- COST_AMT
FROM #XML

GO