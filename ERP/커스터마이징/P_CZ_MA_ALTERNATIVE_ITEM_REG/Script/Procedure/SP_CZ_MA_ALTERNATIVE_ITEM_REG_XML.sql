USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_ALTERNATIVE_ITEM_REGH_XML]    Script Date: 2017-02-07 오후 5:11:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_MA_ALTERNATIVE_ITEM_REG_XML]
(
	@P_XML_H		XML, 
	@P_XML_L		XML, 
	@P_ID_USER		NVARCHAR(10)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_ERRMSG   VARCHAR(255),   -- ERROR 메시지
		@V_DOC_H INT,
		@V_DOC_L INT

EXEC SP_XML_PREPAREDOCUMENT @V_DOC_H OUTPUT, @P_XML_H 
EXEC SP_XML_PREPAREDOCUMENT @V_DOC_L OUTPUT, @P_XML_L

SELECT * INTO #XML_H
FROM OPENXML (@V_DOC_H, '/XML/ROW', 2) WITH 
(
    NO_PRIME		NVARCHAR(20),
	XML_FLAG		NVARCHAR(1)
)

SELECT * INTO #XML_L
FROM OPENXML (@V_DOC_L, '/XML/ROW', 2) WITH 
(
	NO_PRIME		NVARCHAR(20),
    NO_ALTERNATIVE	NVARCHAR(20),
	XML_FLAG		NVARCHAR(1)
)

EXEC SP_XML_REMOVEDOCUMENT @V_DOC_H
EXEC SP_XML_REMOVEDOCUMENT @V_DOC_L 

BEGIN TRAN SP_CZ_MA_ALTERNATIVE_ITEM_REG
BEGIN TRY

-- ================================================== DELETE
DELETE A 
FROM CZ_MA_ALTERNATIVE_ITEM A 
JOIN #XML_H B ON B.XML_FLAG = 'D' AND A.NO_PRIME = B.NO_PRIME

DELETE A 
FROM CZ_MA_ALTERNATIVE_ITEM A 
JOIN #XML_L B ON B.XML_FLAG = 'D' AND A.NO_PRIME = B.NO_PRIME AND (A.NO_MATERIAL = B.NO_ALTERNATIVE OR A.NO_ALTERNATIVE = B.NO_ALTERNATIVE)

-- ================================================== INSERT
IF EXISTS (SELECT 1 
		   FROM #XML_L A
		   WHERE A.XML_FLAG = 'I')
BEGIN
	SELECT * INTO #CZ_MA_ALTERNATIVE_ITEM
	FROM (SELECT A.NO_PRIME, A.NO_MATERIAL 
		  FROM CZ_MA_ALTERNATIVE_ITEM A
		  JOIN #XML_L B ON B.XML_FLAG = 'I' AND A.NO_PRIME = B.NO_PRIME
		  GROUP BY A.NO_PRIME, A.NO_MATERIAL) A 
	
	INSERT INTO #CZ_MA_ALTERNATIVE_ITEM
	(
		NO_PRIME,
		NO_MATERIAL
	)
	SELECT NO_PRIME,
		   NO_ALTERNATIVE 
	FROM #XML_L A
	WHERE A.XML_FLAG = 'I'
	
	DELETE A 
	FROM CZ_MA_ALTERNATIVE_ITEM A 
	JOIN #XML_L B ON B.XML_FLAG = 'I' AND A.NO_PRIME = B.NO_PRIME
	
	INSERT INTO CZ_MA_ALTERNATIVE_ITEM
	(
		NO_PRIME,
		NO_MATERIAL,
		NO_ALTERNATIVE,
		ID_INSERT,
		DTS_INSERT
	)
	SELECT AI.NO_PRIME,
		   AI.NO_MATERIAL AS NO_MATERIAL,
		   AI1.NO_MATERIAL,
		   @P_ID_USER,
		   NEOE.SF_SYSDATE(GETDATE())
	FROM #CZ_MA_ALTERNATIVE_ITEM AI
	LEFT JOIN #CZ_MA_ALTERNATIVE_ITEM AI1 ON AI1.NO_PRIME = AI.NO_PRIME	

	DROP TABLE #CZ_MA_ALTERNATIVE_ITEM
END

DROP TABLE #XML_H
DROP TABLE #XML_L

COMMIT TRAN SP_CZ_MA_ALTERNATIVE_ITEM_REG

END TRY
BEGIN CATCH
	ROLLBACK TRAN SP_CZ_MA_ALTERNATIVE_ITEM_REG
	SELECT @V_ERRMSG = ERROR_MESSAGE()
	GOTO ERROR
END CATCH

RETURN
ERROR: 
RAISERROR(@V_ERRMSG, 16, 1)
ROLLBACK TRAN SP_CZ_MA_ALTERNATIVE_ITEM_REG

GO