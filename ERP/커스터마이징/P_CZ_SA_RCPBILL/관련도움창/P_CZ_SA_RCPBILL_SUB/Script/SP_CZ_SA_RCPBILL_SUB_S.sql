USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_BILL_SUB_S]    Script Date: 2015-12-11 오후 3:18:22 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*******************************************
**  System			: 영업관리
**  Sub System      : 영업관리
**  Page            : 수금등록
**  Desc            : 반제등록 도움창 조회
**  참           고 : 
**  Return Values
**
**  수    정    자  : 장은경
**  작    성    일  : 2006.09.05
**  수    정    자  :이승훈 (환종추가및 환율및 외화반제금액표시추가 20080430 
**  수    정    내   용 : 기존 SP_SA_BILL_SUB_SELECT
*********************************************
** Change History
*********************************************
*********************************************/
ALTER PROCEDURE [NEOE].[SP_CZ_SA_RCPBILL_SUB_S]
(
    @P_CD_COMPANY        NVARCHAR(7),
    @P_DT_FROM           NVARCHAR(8),
    @P_DT_TO             NVARCHAR(8),
    @P_CD_PARTNER        NVARCHAR(20),
    @P_TP_BUSI           NVARCHAR(3),
    @P_CD_DEPT           NVARCHAR(12),
    @P_NO_EMP            NVARCHAR(10),
	@P_DT_BILL			 NVARCHAR(8),
	@P_CD_TP			 NVARCHAR(3)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
	   IH.CD_COMPANY,
	   IH.NO_IV,
	   IH.DT_PROCESS,
	   FD.CD_EXCH,
	   MC.NM_SYSDEF AS NM_EXCH,
	   FD.RT_EXCH,
	   (CASE WHEN ISNULL(EX.RATE_BASE, 0) = 0 THEN 1 ELSE ISNULL(EX.RATE_BASE, 0) END) AS RT_EXCH_CUR,
	   ISNULL((CASE WHEN FD.CD_EXCH = '000' THEN BH.AM_DOCU ELSE BH.AM_EX END), 0) AS AM_EX,
	   ISNULL(BH.AM_DOCU, 0) AS AM_DOCU,
	   ISNULL((CASE WHEN FD.CD_EXCH = '000' THEN BH.AM_BAN ELSE BH.AM_EXBAN END), 0) AS AM_BAN_EX,
	   ISNULL(BH.AM_BAN, 0) AS AM_BAN,
	   0.00 AS AM_RCP_EX,
	   0.00 AS AM_RCP,
	   0.00 AS AM_PL_LOSS,
	   0.00 AS AM_PL_PROFIT,
	   (CASE WHEN FD.CD_EXCH = '000' THEN (ISNULL(BH.AM_DOCU, 0) - ISNULL(BH.AM_BAN, 0)) ELSE (ISNULL(BH.AM_EX, 0) - ISNULL(BH.AM_EXBAN, 0)) END) AS AM_RCP_JAN_EX,
	   (ISNULL(BH.AM_DOCU, 0) - ISNULL(BH.AM_BAN, 0)) AS AM_RCP_JAN,
	   0.00 AS AM_PL,
	   ME.NM_KOR AS NM_EMP,
	   MD.NM_DEPT,
	   CASE SIGN(IH.AM_EX) WHEN -1 THEN '0' ELSE '1' END AS IV_GUBUN,
	   BH.NO_DOCU,
	   BH.NO_DOLINE,
	   FD.CD_PJT,
	   IL.TP_IV
FROM SA_IVH IH
JOIN (SELECT CD_COMPANY, NO_IV, TP_IV, FG_TRANS 
	  FROM SA_IVL
	  GROUP BY CD_COMPANY, NO_IV, TP_IV, FG_TRANS) IL 
ON IL.CD_COMPANY = IH.CD_COMPANY AND IL.NO_IV = IH.NO_IV
JOIN MA_AISPOSTL AL ON AL.CD_COMPANY = IH.CD_COMPANY AND AL.FG_TP = '100' AND AL.CD_TP = IL.TP_IV AND AL.FG_AIS = (CASE WHEN IL.FG_TRANS = '001' THEN '101' ELSE '102' END)
JOIN FI_DOCU FD ON FD.CD_COMPANY = IH.CD_COMPANY AND FD.NO_MDOCU = IH.NO_IV AND FD.CD_ACCT = AL.CD_ACCT
JOIN FI_BANH BH ON BH.CD_COMPANY = FD.CD_COMPANY AND BH.NO_DOCU = FD.NO_DOCU AND BH.NO_DOLINE = FD.NO_DOLINE
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = IH.CD_COMPANY AND ME.NO_EMP = IH.NO_EMP
LEFT JOIN MA_DEPT MD ON MD.CD_COMPANY = IH.CD_COMPANY AND MD.CD_DEPT = IH.CD_DEPT
LEFT JOIN (SELECT CD_COMPANY, YYMMDD, CURR_SOUR,
		   		  (CASE WHEN CURR_SOUR = '002' THEN RATE_BASE ELSE ROUND(RATE_BASE, 2) END) AS RATE_BASE 
		   FROM MA_EXCHANGE
		   WHERE NO_SEQ = '1'
		   AND CURR_DEST = '000') EX
ON EX.CD_COMPANY = IH.CD_COMPANY AND EX.YYMMDD = @P_DT_BILL AND EX.CURR_SOUR = IH.CD_EXCH 
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = FD.CD_COMPANY AND MC.CD_FIELD = 'MA_B000005' AND MC.CD_SYSDEF = FD.CD_EXCH
WHERE IH.CD_COMPANY = @P_CD_COMPANY
AND IH.DT_PROCESS BETWEEN @P_DT_FROM AND @P_DT_TO
AND IH.CD_PARTNER = @P_CD_PARTNER
AND IH.FG_TRANS = @P_TP_BUSI
AND (ISNULL(@P_CD_DEPT, '') = '' OR IH.CD_DEPT = @P_CD_DEPT)
AND (ISNULL(@P_NO_EMP, '') = '' OR IH.NO_EMP = @P_NO_EMP)
AND ABS(ISNULL(BH.AM_DOCU, 0) - ISNULL(BH.AM_BAN, 0)) > 0

GO