USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_BILL_SCH_PRE_SELECT]    Script Date: 2016-03-15 오전 9:04:13 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_BILL_SCH_PRE_SELECT]
(
    @CD_COMPANY         NVARCHAR(7),
    @DT_RCP_FROM        NVARCHAR(8),
    @DT_RCP_TO          NVARCHAR(8),
    @CD_TP              NVARCHAR(3),
    @FG_TRANS           NVARCHAR(3),
    @CD_PARTNER         NVARCHAR(20),
    @BILL_PARTNER       NVARCHAR(20),
    @CD_SALEGRP         NVARCHAR(7),
    @NO_EMP             NVARCHAR(10)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
	   RH.NO_RCP,
	   RH.NO_PROJECT AS CD_PJT,
	   RH.DT_RCP,
	   RH.CD_TP,
	   AH.NM_TP,
	   RH.CD_EXCH,
	   MC.NM_SYSDEF AS CD_EXCH_NAME,
	   RH.RT_EXCH,
	   ISNULL(BH.AM_EX, 0) AS AM_RCP_A_EX,
	   ISNULL(BH.AM_DOCU, 0) AS AM_RCP_A,
	   ISNULL(BH.AM_EXBAN, 0) AS AM_RCPS_EX,
	   ISNULL(BH.AM_BAN, 0) AS AM_RCPS,
	   (ISNULL(BH.AM_EX, 0) - ISNULL(BH.AM_EXBAN, 0)) AS AM_REMAIN_EX,
	   (ISNULL(BH.AM_DOCU, 0) - ISNULL(BH.AM_BAN, 0)) AS AM_REMAIN,
	   RH.CD_PARTNER,
	   MP.LN_PARTNER AS LN_CD_PARTNER,
	   RH.BILL_PARTNER,
	   MP1.LN_PARTNER AS LN_BILL_PARTNER,
	   RH.CD_SALEGRP,
	   MS.NM_SALEGRP,
	   RH.NO_EMP,
	   ME.NM_KOR,
	   RH.FG_MAP,
	   BH.NO_DOCU,
	   BH.NO_DOLINE
FROM SA_RCPH RH
LEFT JOIN MA_AISPOSTH AH ON AH.CD_COMPANY = RH.CD_COMPANY AND AH.FG_TP = '300' AND AH.CD_TP = RH.CD_TP
LEFT JOIN MA_AISPOSTL AL ON AL.CD_COMPANY = RH.CD_COMPANY AND AL.FG_TP = '300' AND AL.CD_TP = RH.CD_TP AND AL.FG_AIS = (CASE WHEN RH.TP_BUSI = '001' THEN '331' ELSE '333' END)
LEFT JOIN FI_DOCU FD ON FD.CD_COMPANY = RH.CD_COMPANY AND FD.NO_MDOCU = RH.NO_RCP AND FD.CD_ACCT = AL.CD_ACCT
LEFT JOIN FI_BANH BH ON BH.CD_COMPANY = FD.CD_COMPANY AND BH.NO_DOCU = FD.NO_DOCU AND BH.NO_DOLINE = FD.NO_DOLINE
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = RH.CD_COMPANY AND MP.CD_PARTNER = RH.CD_PARTNER
LEFT JOIN MA_PARTNER MP1 ON MP1.CD_COMPANY = RH.CD_COMPANY AND MP1.CD_PARTNER = RH.BILL_PARTNER
LEFT JOIN MA_SALEGRP MS ON MS.CD_COMPANY = RH.CD_COMPANY AND MS.CD_SALEGRP = RH.CD_SALEGRP
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = RH.CD_COMPANY AND ME.NO_EMP = RH.NO_EMP
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = RH.CD_COMPANY AND MC.CD_FIELD = 'MA_B000005' AND MC.CD_SYSDEF = RH.CD_EXCH
WHERE RH.CD_COMPANY = @CD_COMPANY
AND RH.DT_RCP BETWEEN @DT_RCP_FROM AND @DT_RCP_TO
AND RH.TP_BUSI = @FG_TRANS
AND ISNULL(BH.AM_EX, 0) > 0
AND (ISNULL(BH.AM_EX, 0) - ISNULL(BH.AM_EXBAN, 0)) > 0
AND (ISNULL(@CD_TP, '') = '' OR RH.CD_TP = @CD_TP)
AND (ISNULL(@CD_PARTNER, '') = '' OR RH.CD_PARTNER = @CD_PARTNER)
AND (ISNULL(@BILL_PARTNER, '') = '' OR RH.BILL_PARTNER = @BILL_PARTNER)
AND (ISNULL(@CD_SALEGRP, '') = '' OR RH.CD_SALEGRP = @CD_SALEGRP)
AND (ISNULL(@NO_EMP, '') = '' OR RH.NO_EMP = @NO_EMP)

GO