USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PU_ADPAYMENT_BILL_SUB_S]    Script Date: 2015-08-05 오전 10:56:56 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_PU_ADPAYMENT_SCH_S]
(
	@P_CD_COMPANY           NVARCHAR(7),
	@P_LANGUAGE				NVARCHAR(5) = 'KR',
	@P_DT_FROM				NVARCHAR(8),
	@P_DT_TO				NVARCHAR(8),
	@P_CD_SUPPLIER			NVARCHAR(20),
	@P_FG_TRANS				NVARCHAR(3),
	@P_NO_EMP				NVARCHAR(10),
	@P_CD_PURGRP		    NVARCHAR(12)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
	   AP.CD_COMPANY,
	   AP.NO_ADPAY,
	   MAX(FD.DT_ACCT) AS DT_ADPAY,
	   MAX(FD.CD_EXCH) AS CD_EXCH,
	   MAX(CD.NM_SYSDEF) AS NM_EXCH,
	   MAX(FD.RT_EXCH) AS RT_EXCH,
	   BH.NO_DOCU,
	   BH.NO_DOLINE,
	   MAX(BH.AM_DOCU) AS AM,
	   MAX(BH.AM_BAN) AS AM_ADPS,
	   MAX(ISNULL(BH.AM_DOCU, 0) - ISNULL(BH.AM_BAN, 0)) AS AM_REMAIN,
	   MAX(BH.AM_EX) AS AM_EX,
	   MAX(BH.AM_EXBAN) AS AM_ADPS_EX,
	   MAX(ISNULL(BH.AM_EX, 0) - ISNULL(BH.AM_EXBAN, 0)) AS AM_REMAIN_EX,
	   MAX(PH.FG_TRANS) AS CD_FG_TRANS,
	   MAX(CD1.NM_SYSDEF) AS NM_FG_TRANS,
	   MAX(PH.CD_PARTNER) AS CD_SUPPLIER,
	   MAX(MP.LN_PARTNER) AS NM_SUPPLIER,
	   MAX(PH.NO_EMP) AS NO_EMP,
	   MAX(ME.NM_KOR) AS NM_EMP,
	   MAX(PH.CD_PURGRP) AS CD_PURGRP,
	   MAX(PG.NM_PURGRP) AS NM_PURGRP,
	   MAX(FD.CD_PJT) AS CD_PJT
FROM PU_ADPAYMENT AP
JOIN PU_POL PL ON PL.CD_COMPANY = AP.CD_COMPANY AND PL.NO_PO = AP.NO_PO AND PL.NO_LINE = AP.NO_POLINE
JOIN PU_POH PH ON PH.CD_COMPANY = PL.CD_COMPANY AND PH.NO_PO = PL.NO_PO
JOIN MA_AISPOSTL AL ON AL.CD_COMPANY = PL.CD_COMPANY AND AL.CD_TP = PL.FG_PURCHASE AND AL.FG_TP = '200' AND AL.FG_AIS = '221'
JOIN FI_DOCU FD ON FD.CD_COMPANY = AP.CD_COMPANY AND FD.NO_MDOCU = AP.NO_ADPAY AND FD.CD_ACCT = AL.CD_ACCT
JOIN FI_BANH BH ON BH.CD_COMPANY = FD.CD_COMPANY AND BH.NO_DOCU = FD.NO_DOCU AND BH.NO_DOLINE = FD.NO_DOLINE
LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = FD.CD_COMPANY AND CD.CD_FIELD = 'MA_B000005' AND CD.CD_SYSDEF = FD.CD_EXCH
LEFT JOIN MA_CODEDTL CD1 ON CD1.CD_COMPANY = PH.CD_COMPANY AND CD1.CD_FIELD = 'PU_C000016' AND CD1.CD_SYSDEF = PH.FG_TRANS
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = PH.CD_COMPANY AND MP.CD_PARTNER = PH.CD_PARTNER
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = PH.CD_COMPANY AND ME.NO_EMP = PH.NO_EMP
LEFT JOIN MA_PURGRP PG ON PG.CD_COMPANY = PH.CD_COMPANY AND PG.CD_PURGRP = PH.CD_PURGRP
WHERE AP.CD_COMPANY = @P_CD_COMPANY
AND AP.DT_ADPAY BETWEEN @P_DT_FROM AND @P_DT_TO
AND FD.ST_DOCU = 2
AND (ISNULL(@P_CD_SUPPLIER, '') = '' OR PH.CD_PARTNER = @P_CD_SUPPLIER)
AND (ISNULL(@P_FG_TRANS, '') = '' OR PH.FG_TRANS = @P_FG_TRANS)
AND (ISNULL(@P_NO_EMP, '') = '' OR PH.NO_EMP = @P_NO_EMP)
AND (ISNULL(@P_CD_PURGRP, '') = '' OR PH.CD_PURGRP = @P_CD_PURGRP)
GROUP BY AP.CD_COMPANY, AP.NO_ADPAY, BH.NO_DOCU, BH.NO_DOLINE
HAVING MAX(BH.AM_DOCU) > MAX(BH.AM_BAN)

GO