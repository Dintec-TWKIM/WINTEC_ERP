USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PU_IV_REGL_SUB_S]    Script Date: 2015-06-23 오후 4:37:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_FI_IMP_PMT_REGL_S]            
(       
    @P_CD_COMPANY			NVARCHAR(7),
	@P_NO_PO				NVARCHAR(20),
	@P_ID_USER			NVARCHAR(20)
)            
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'Y' AS S,
	   PL.NO_PO,
	   PL.NO_LINE AS NO_POLINE,
	   PL.NO_SO,
	   PL.NO_SOLINE,
	   QL.NO_DSP,
	   QL.CD_ITEM_PARTNER,
	   QL.NM_ITEM_PARTNER,
	   PL.CD_PLANT,
	   PL.CD_ITEM,
	   MI.NM_ITEM,
	   MI.UNIT_SO,
	   PL.QT_PO_MM,
	   PL.UM_EX,
	   PL.AM_EX,
	   PL.AM,
	   '' AS NO_RAN,
	   0 AS AM_TAX
FROM PU_POL PL
LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = PL.CD_COMPANY AND QL.NO_FILE = PL.NO_SO AND QL.NO_LINE = PL.NO_SOLINE
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = PL.CD_COMPANY AND MI.CD_PLANT = PL.CD_PLANT AND MI.CD_ITEM = PL.CD_ITEM
WHERE PL.CD_COMPANY = @P_CD_COMPANY
AND PL.NO_PO = @P_NO_PO
AND NOT EXISTS (SELECT 1 
				FROM CZ_FI_IMP_PMTL IL
				WHERE IL.CD_COMPANY = PL.CD_COMPANY 
				AND IL.NO_PO = PL.NO_PO
				AND IL.NO_POLINE = PL.NO_LINE)

GO

