USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_FI_VAT_MNG_S]    Script Date: 2015-08-12 오후 3:03:52 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_FI_IMP_PMT_MNGL_S] 
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_LANGUAGE		    NVARCHAR(5) = 'KR',
	@P_NO_IMPORT		NVARCHAR(20),
	@P_NO_SO			NVARCHAR(20),
	@P_NO_EMP			NVARCHAR(10),
	@P_NO_IMO			NVARCHAR(10),
	@P_CD_SUPPLIER		NVARCHAR(20)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
	   IL.NO_IMPORT,
	   IL.NO_PO,
	   IL.NO_POLINE,
	   QL.NO_DSP,
	   QL.CD_ITEM_PARTNER,
	   QL.NM_ITEM_PARTNER,
	   IL.CD_ITEM,
	   MI.NM_ITEM,
	   MI.UNIT_SO,
	   IL.QT_PO,
	   ISNULL(IL.QT_TAX, 0) AS QT_TAX,
	   ISNULL(OL.QT_IO , 0) AS QT_OUT,
	   OL.DT_IO AS DT_OUT,
	   (SELECT (CASE @P_LANGUAGE WHEN 'KR' THEN NM_SYSDEF
								 WHEN 'US' THEN NM_SYSDEF_E
								 WHEN 'JP' THEN NM_SYSDEF_JP
								 WHEN 'CH' THEN NM_SYSDEF_CH END)
		FROM MA_CODEDTL
		WHERE CD_COMPANY = GL.CD_COMPANY
		AND CD_FIELD = 'CZ_SA00006'
		AND CD_SYSDEF = GL.CD_MAIN_CATEGORY) AS NM_MAIN_CATEGORY,
	   (SELECT (CASE @P_LANGUAGE WHEN 'KR' THEN NM_SYSDEF
								 WHEN 'US' THEN NM_SYSDEF_E
								 WHEN 'JP' THEN NM_SYSDEF_JP
								 WHEN 'CH' THEN NM_SYSDEF_CH END)
		FROM MA_CODEDTL
		WHERE CD_COMPANY = GL.CD_COMPANY
		AND CD_FIELD = MC.CD_FLAG1
		AND CD_SYSDEF = GL.CD_SUB_CATEGORY) AS NM_SUB_CATEGORY,
	   IL.UM_EX,
	   IL.AM_EX,
	   IL.AM,
	   IL.NO_RAN,
	   ISNULL(IL.AM_TAX, 0) AS AM_TAX,
	   ISNULL(IL.QT_RETURN, 0) AS QT_RETURN,
	   ISNULL(IL.AM_RETURN, 0) AS AM_RETURN,
	   IL.NO_SO,
	   SH.CD_SALEGRP,
	   SG.NM_SALEGRP,
	   SH.NO_IMO,
	   MH.NM_VESSEL,
	   PH.CD_PARTNER AS CD_SUPPLIER,
	   MP.LN_PARTNER AS NM_SUPPLIER,
	   SH.NO_EMP,
	   ME.NM_KOR AS NM_EMP,
	   IL.NO_RETURN,
	   FD.NO_DOCU AS NO_RETURN_DOCU 
FROM CZ_FI_IMP_PMTL IL
LEFT JOIN (SELECT GL.CD_COMPANY, GL.NO_SO, GL.SEQ_SO, 
				  MAX(GD.CD_MAIN_CATEGORY) AS CD_MAIN_CATEGORY,
				  MAX(GD.CD_SUB_CATEGORY) AS CD_SUB_CATEGORY
		   FROM SA_GIRL GL
		   LEFT JOIN CZ_SA_GIRH_WORK_DETAIL GD ON GD.CD_COMPANY = GL.CD_COMPANY AND GD.NO_GIR = GL.NO_GIR
		   GROUP BY GL.CD_COMPANY, GL.NO_SO, GL.SEQ_SO) GL
ON GL.CD_COMPANY = IL.CD_COMPANY AND GL.NO_SO = IL.NO_SO AND GL.SEQ_SO = IL.NO_SOLINE
LEFT JOIN (SELECT OL.CD_COMPANY, OL.NO_PSO_MGMT, OL.NO_PSOLINE_MGMT, 
				  ISNULL(MAX(OL.DT_IO), '') AS DT_IO,
				  SUM(CASE WHEN OH.YN_RETURN = 'Y' THEN -OL.QT_IO ELSE OL.QT_IO END) AS QT_IO
		   FROM MM_QTIO OL
		   LEFT JOIN MM_QTIOH OH ON OH.CD_COMPANY = OL.CD_COMPANY AND OH.NO_IO = OL.NO_IO
		   WHERE OL.FG_PS = '2'
		   GROUP BY OL.CD_COMPANY, OL.NO_PSO_MGMT, OL.NO_PSOLINE_MGMT) OL 
ON OL.CD_COMPANY = IL.CD_COMPANY AND OL.NO_PSO_MGMT = IL.NO_SO AND OL.NO_PSOLINE_MGMT = IL.NO_SOLINE
LEFT JOIN (SELECT CD_COMPANY, NO_MDOCU,
		   		  MAX(NO_DOCU) AS NO_DOCU 
		   FROM FI_DOCU
		   WHERE NO_MODULE = 'D04'
		   GROUP BY CD_COMPANY, NO_MDOCU) FD 
ON FD.CD_COMPANY = IL.CD_COMPANY AND FD.NO_MDOCU = IL.NO_RETURN
LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = IL.CD_COMPANY AND QL.NO_FILE = IL.NO_SO AND QL.NO_LINE = IL.NO_SOLINE
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = IL.CD_COMPANY AND SH.NO_SO = IL.NO_SO
LEFT JOIN PU_POH PH ON PH.CD_COMPANY = IL.CD_COMPANY AND PH.NO_PO = IL.NO_PO
LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = SH.NO_IMO
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SH.CD_COMPANY AND ME.NO_EMP = SH.NO_EMP
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = PH.CD_COMPANY AND MP.CD_PARTNER = PH.CD_PARTNER
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = GL.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00006' AND MC.CD_SYSDEF = GL.CD_MAIN_CATEGORY
WHERE IL.CD_COMPANY = @P_CD_COMPANY
AND IL.NO_IMPORT = @P_NO_IMPORT
AND (ISNULL(@P_NO_SO, '') = '' OR IL.NO_SO = @P_NO_SO)
AND (ISNULL(@P_NO_EMP, '') = '' OR SH.NO_EMP = @P_NO_EMP)
AND (ISNULL(@P_NO_IMO, '') = '' OR SH.NO_IMO = @P_NO_IMO)
AND (ISNULL(@P_CD_SUPPLIER, '') = '' OR PH.CD_PARTNER = @P_CD_SUPPLIER)
ORDER BY IL.NO_RAN, QL.NO_DSP

GO