USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_H_CZ_MA_CUSTOMIZE_SUB]    Script Date: 2016-06-13 오후 5:01:19 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_H_CZ_MA_CUSTOMIZE_SUB]
(
	@P_CD_COMPANY	NVARCHAR(7),
	@P_HELP_ID		NVARCHAR(30),
	@P_DT_FROM		NVARCHAR(8),
	@P_DT_TO		NVARCHAR(8),
	@P_SEARCH_TEXT	NVARCHAR(MAX)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @P_HELP_ID = 'CZ_SA_GIR_PACK_SUB'
	SELECT SL.NO_SO, 
		   SH.DT_SO, 
		   SH.CD_PARTNER, 
		   MP.LN_PARTNER, 
		   SH.NO_IMO, 
		   MH.NO_HULL, 
		   MH.NM_VESSEL
	FROM SA_SOL SL
	LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
	LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = SL.CD_COMPANY AND SH.NO_SO = SL.NO_SO
	LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = SH.CD_COMPANY AND MP.CD_PARTNER = SH.CD_PARTNER
	LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = SH.NO_IMO
	WHERE SL.CD_COMPANY = @P_CD_COMPANY
	AND (SL.STA_SO IN ('R', 'C') OR SL.CD_USERDEF1 = '재고픽업')
	AND (ISNULL(@P_SEARCH_TEXT, '') = '' OR SL.NO_SO LIKE '%' + @P_SEARCH_TEXT + '%')
	GROUP BY SL.NO_SO, SH.DT_SO, SH.CD_PARTNER, MP.LN_PARTNER, SH.NO_IMO, MH.NO_HULL, MH.NM_VESSEL
	ORDER BY SH.DT_SO, SL.NO_SO
ELSE IF @P_HELP_ID = 'CZ_SA_GIR_SUB'
	SELECT SL.NO_SO, 
		   SH.DT_SO, 
		   SH.CD_PARTNER, 
		   MP.LN_PARTNER, 
		   SH.NO_IMO, 
		   MH.NO_HULL, 
		   MH.NM_VESSEL
	FROM SA_SOL SL
	LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
	LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = SL.CD_COMPANY AND SH.NO_SO = SL.NO_SO
	LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = SH.CD_COMPANY AND MP.CD_PARTNER = SH.CD_PARTNER
	LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = SH.NO_IMO
	LEFT JOIN (SELECT CD_COMPANY, NO_SO, SEQ_SO, SUM(QT_GIR) AS QT_GIR
			   FROM SA_GIRL
			   GROUP BY CD_COMPANY, NO_SO, SEQ_SO) GL
	ON GL.CD_COMPANY = SL.CD_COMPANY AND GL.NO_SO = SL.NO_SO AND GL.SEQ_SO = SL.SEQ_SO
	WHERE SL.CD_COMPANY = @P_CD_COMPANY
	AND SL.STA_SO = 'R'
	AND ISNULL(SL.QT_SO, 0) - ISNULL(SL.QT_GI, 0) > 0
	AND ISNULL(SL.QT_SO, 0) - ISNULL(GL.QT_GIR, 0) > 0
	AND (ISNULL(@P_SEARCH_TEXT, '') = '' OR SL.NO_SO LIKE '%' + @P_SEARCH_TEXT + '%')
	GROUP BY SL.NO_SO, SH.DT_SO, SH.CD_PARTNER, MP.LN_PARTNER, SH.NO_IMO, MH.NO_HULL, MH.NM_VESSEL
	ORDER BY SH.DT_SO, SL.NO_SO
ELSE IF @P_HELP_ID = 'H_SA_SO_SUB'
	SELECT SH.NO_SO,
		   SH.DT_SO,
		   SH.CD_SALEGRP,
		   SG.NM_SALEGRP,
		   SH.NO_EMP,
		   ME.NM_KOR,
		   SH.NO_PROJECT,
		   PH.NM_PROJECT,
		   SH.CD_PARTNER,
		   MP.LN_PARTNER,
		   ST.TP_BUSI,
		   SH.CD_EXCH
	FROM SA_SOH SH
    JOIN (SELECT SL.CD_COMPANY, SL.NO_SO 
		  FROM SA_SOL SL
		  LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
		  GROUP BY SL.CD_COMPANY, SL.NO_SO) SL
	ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
	LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = SH.CD_COMPANY AND MP.CD_PARTNER = SH.CD_PARTNER
	LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
	LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SH.CD_COMPANY AND ME.NO_EMP = SH.NO_EMP
	LEFT JOIN SA_PROJECTH PH ON PH.CD_COMPANY = SH.CD_COMPANY AND PH.NO_PROJECT = SH.NO_PROJECT
	LEFT JOIN SA_TPSO ST ON ST.CD_COMPANY = SH.CD_COMPANY AND ST.TP_SO = SH.TP_SO
	WHERE SH.CD_COMPANY = @P_CD_COMPANY
	AND SH.DT_SO BETWEEN @P_DT_FROM AND @P_DT_TO
	AND (ISNULL(@P_SEARCH_TEXT, '') = '' OR SH.NO_SO LIKE '%' + @P_SEARCH_TEXT + '%')
ELSE IF @P_HELP_ID = 'H_SA_SO_GI_SUB'
	SELECT SH.NO_SO,
		   SH.DT_SO,
		   SH.CD_SALEGRP,
		   SG.NM_SALEGRP,
		   SH.NO_EMP,
		   ME.NM_KOR,
		   SH.CD_PARTNER,
		   MP.LN_PARTNER,
		   ST.TP_BUSI,
		   SH.TP_VAT,
		   SH.CD_EXCH
	FROM SA_SOH SH
	JOIN (SELECT SL.CD_COMPANY, SL.NO_SO 
		  FROM SA_SOL SL
		  LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
		  WHERE ISNULL(SL.QT_GI, 0) > 0
		  GROUP BY SL.CD_COMPANY, SL.NO_SO) SL
	ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
	LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = SH.CD_COMPANY AND MP.CD_PARTNER = SH.CD_PARTNER  
	LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
	LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SH.CD_COMPANY AND ME.NO_EMP = SH.NO_EMP
	LEFT JOIN SA_TPSO ST ON ST.CD_COMPANY = SH.CD_COMPANY AND ST.TP_SO = SH.TP_SO
	WHERE SH.CD_COMPANY = @P_CD_COMPANY
	AND SH.DT_SO BETWEEN @P_DT_FROM AND @P_DT_TO
	AND (ISNULL(@P_SEARCH_TEXT, '') = '' OR SH.NO_SO LIKE '%' + @P_SEARCH_TEXT + '%')
ELSE IF @P_HELP_ID = 'H_PU_PO_SUB'
	SELECT PH.NO_PO,
		   PH.DT_PO,
		   PH.CD_PARTNER,
		   MP.LN_PARTNER,
		   PH.NO_EMP,
		   ME.NM_KOR,
		   PH.CD_PURGRP,
		   PG.NM_PURGRP,
		   PH.FG_TRANS,
		   PH.FG_TAX,
		   PH.CD_EXCH 
	FROM PU_POH PH
	JOIN (SELECT PL.CD_COMPANY, PL.NO_PO 
		  FROM PU_POL PL
		  LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = PL.CD_COMPANY AND QL.NO_FILE = PL.NO_SO AND QL.NO_LINE = PL.NO_SOLINE
		  GROUP BY PL.CD_COMPANY, PL.NO_PO) PL
	ON PL.CD_COMPANY = PH.CD_COMPANY AND PL.NO_PO = PH.NO_PO
	LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = PH.CD_COMPANY AND MP.CD_PARTNER = PH.CD_PARTNER
	LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = PH.CD_COMPANY AND ME.NO_EMP = PH.NO_EMP
	LEFT JOIN MA_PURGRP PG ON PG.CD_COMPANY = PH.CD_COMPANY AND PG.CD_PURGRP = PH.CD_PURGRP
	WHERE PH.CD_COMPANY = @P_CD_COMPANY
	AND PH.DT_PO BETWEEN @P_DT_FROM AND @P_DT_TO
	AND (ISNULL(@P_SEARCH_TEXT, '') = '' OR PH.NO_PO LIKE '%' + @P_SEARCH_TEXT + '%')
ELSE IF @P_HELP_ID = 'H_MA_PITEM_SUB'
	SELECT MI.CD_ITEM,
		   MI.NM_ITEM,
		   MI.CLS_ITEM,
		   MC.NM_SYSDEF AS NM_CLS_ITEM,
		   MI.STND_DETAIL_ITEM,
		   MI.STND_ITEM,
		   MI.MAT_ITEM,
		   MI.CD_ZONE,
		   MI.NO_DESIGN,
		   MI.GRP_ITEM,
		   IG.NM_ITEMGRP,
		   MI.CLS_L,
		   MC1.NM_SYSDEF AS NM_CLS_L,
		   MI.CLS_M,
		   MC2.NM_SYSDEF AS NM_CLS_M,
		   MI.CLS_S,
		   MC3.NM_SYSDEF AS NM_CLS_S,
		   MI.UNIT_IM,
		   MC4.NM_SYSDEF AS NM_UNIT_IM,
		   MI.UNIT_PO,
		   MC5.NM_SYSDEF AS NM_UNIT_PO,
		   MI.FG_SERNO,
		   MI.NM_MAKER,
		   MI.CD_GISL,
		   MS.NM_SL AS NM_GISL,
		   MI.CD_SL,
		   MS1.NM_SL AS NM_SL,
		   MI.BARCODE,
		   MI.UNIT_PO_FACT,
		   MI.GRP_MFG,
		   MC6.NM_SYSDEF AS NM_GRP_MFG
	FROM MA_PITEM MI
	LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = MI.CD_COMPANY AND MC.CD_FIELD = 'MA_B000010' AND MC.CD_SYSDEF = MI.CLS_ITEM
	LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = MI.CD_COMPANY AND MC1.CD_FIELD = 'MA_B000030' AND MC1.CD_SYSDEF = MI.CLS_L
	LEFT JOIN MA_CODEDTL MC2 ON MC2.CD_COMPANY = MI.CD_COMPANY AND MC2.CD_FIELD = 'MA_B000031' AND MC2.CD_SYSDEF = MI.CLS_M
	LEFT JOIN MA_CODEDTL MC3 ON MC3.CD_COMPANY = MI.CD_COMPANY AND MC3.CD_FIELD = 'MA_B000032' AND MC3.CD_SYSDEF = MI.CLS_S
	LEFT JOIN MA_CODEDTL MC4 ON MC4.CD_COMPANY = MI.CD_COMPANY AND MC4.CD_FIELD = 'MA_B000004' AND MC4.CD_SYSDEF = MI.UNIT_IM
	LEFT JOIN MA_CODEDTL MC5 ON MC5.CD_COMPANY = MI.CD_COMPANY AND MC5.CD_FIELD = 'MA_B000004' AND MC5.CD_SYSDEF = MI.UNIT_PO
	LEFT JOIN MA_CODEDTL MC6 ON MC6.CD_COMPANY = MI.CD_COMPANY AND MC6.CD_FIELD = 'MA_B000066' AND MC6.CD_SYSDEF = MI.GRP_MFG
	LEFT JOIN MA_ITEMGRP IG ON  IG.CD_COMPANY = MI.CD_COMPANY AND IG.USE_YN = 'Y' AND  IG.CD_ITEMGRP = MI.GRP_ITEM
	LEFT JOIN MA_SL MS ON MS.CD_COMPANY = MI.CD_COMPANY AND MS.CD_SL = MI.CD_GISL
	LEFT JOIN MA_SL MS1 ON MS1.CD_COMPANY = MI.CD_COMPANY AND MS1.CD_SL = MI.CD_SL
	WHERE MI.CD_COMPANY = @P_CD_COMPANY
	AND (ISNULL(@P_SEARCH_TEXT, '') = '' OR MI.CD_ITEM LIKE '%' + @P_SEARCH_TEXT + '%')
ELSE IF @P_HELP_ID = 'H_SA_MEETING_MEMO_SUB'
	SELECT MT.NO_MEETING,
		   MT.DC_SUBJECT,
		   MT.CD_PARTNER,
		   MP.LN_PARTNER,
		   MT.DT_MEETING,
		   MT.DC_TIME,
		   MT.DC_LOCATION,
		   MT.DC_PURPOSE,
		   MT.DC_MEETING,
		   MU.NM_USER AS NM_INSERT
	FROM CZ_SA_MEETING_MEMO MT
    LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = MT.CD_COMPANY AND MP.CD_PARTNER = MT.CD_PARTNER
	LEFT JOIN MA_USER MU ON MU.CD_COMPANY = MT.CD_COMPANY AND MU.ID_USER = MT.ID_INSERT
	WHERE MT.CD_COMPANY = @P_CD_COMPANY
	AND MT.DT_MEETING BETWEEN @P_DT_FROM AND @P_DT_TO
	AND (ISNULL(@P_SEARCH_TEXT, '') = '' OR MT.NO_MEETING LIKE @P_SEARCH_TEXT + '%')
ELSE IF @P_HELP_ID = 'H_MA_EMP_SUB'
	SELECT ME.CD_COMPANY,
		   MC.NM_COMPANY,
		   ME.NO_EMP,
		   ME.NM_KOR,
		   ME.CD_DEPT,
		   MD.NM_DEPT,
		   ME.CD_DUTY_RANK,
		   CD.NM_SYSDEF AS NM_DUTY_RANK
	FROM MA_EMP ME
	LEFT JOIN MA_COMPANY MC ON MC.CD_COMPANY = ME.CD_COMPANY
	LEFT JOIN MA_DEPT MD ON MD.CD_COMPANY = ME.CD_COMPANY AND MD.CD_DEPT = ME.CD_DEPT
	LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = ME.CD_COMPANY AND CD.CD_FIELD = 'HR_H000002' AND CD.CD_SYSDEF = ME.CD_DUTY_RANK
	WHERE ME.CD_COMPANY IN ('K100', 'K200', 'S100')
	AND ME.CD_INCOM <> '099'
    AND ISNULL(ME.DT_RETIRE, '00000000') = '00000000'
    AND ME.TP_EMP IN ('100', '200')
	AND (ISNULL(@P_SEARCH_TEXT, '') = '' OR ME.NO_EMP LIKE @P_SEARCH_TEXT + '%' OR ME.NM_KOR LIKE @P_SEARCH_TEXT + '%')
	ORDER BY ME.CD_COMPANY, ME.NO_EMP

GO