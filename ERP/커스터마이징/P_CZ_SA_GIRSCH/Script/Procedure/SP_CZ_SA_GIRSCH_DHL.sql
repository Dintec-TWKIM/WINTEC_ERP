USE [NEOE]
GO
/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIRSCH_DHL]    Script Date: 2017-07-03 오후 3:42:46 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIRSCH_DHL]  
(
	@P_CD_COMPANY			NVARCHAR(7),
	@P_NO_GIR			    NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_CD_COMPANY	NVARCHAR(7)
DECLARE @V_NO_GIR		NVARCHAR(20)
DECLARE @V_BAN			NVARCHAR(100)
DECLARE @V_PC			NVARCHAR(100)

SELECT @V_NO_GIR = GL.NO_GIR
FROM SA_GIRL GL
LEFT JOIN (SELECT 'S100' AS CD_COMPANY,
	  	          SL.NO_PO_PARTNER,
	  	          SL.SEQ_SO,
			      GL.QT_GIR
	       FROM SA_GIRL GL
	       LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = GL.CD_COMPANY AND SL.NO_SO = GL.NO_SO AND SL.SEQ_SO = GL.SEQ_SO
	       WHERE GL.CD_COMPANY = @P_CD_COMPANY
	       AND GL.NO_GIR = @P_NO_GIR) GL1
ON GL1.CD_COMPANY = GL.CD_COMPANY AND GL1.NO_PO_PARTNER = GL.NO_SO AND GL1.SEQ_SO = GL.SEQ_SO
WHERE GL.CD_ITEM NOT LIKE 'SD%'
GROUP BY GL.NO_GIR
HAVING SUM(GL1.QT_GIR) > 0
AND SUM(GL.QT_GIR) = SUM(GL1.QT_GIR)

IF @V_NO_GIR IS NOT NULL
BEGIN
	SET @V_CD_COMPANY = 'S100'

	SELECT @V_BAN = TH.REMARK4,
		   @V_PC = TH.REMARK5
	FROM SA_GIRH GH
	JOIN (SELECT GL.CD_COMPANY, GL.NO_GIR,
			     MAX(GL.NO_INV) AS NO_INV
	      FROM SA_GIRL GL
		  GROUP BY GL.CD_COMPANY, GL.NO_GIR) GL
    ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
	JOIN CZ_TR_INVH TH ON TH.CD_COMPANY = GL.CD_COMPANY AND TH.NO_INV = GL.NO_INV
	WHERE GH.CD_COMPANY = @P_CD_COMPANY
	AND GH.NO_GIR = @P_NO_GIR
END
ELSE
BEGIN
	SET @V_CD_COMPANY = @P_CD_COMPANY
	SET @V_NO_GIR = @P_NO_GIR
END

SELECT GH.CD_COMPANY,
	   GH.NO_GIR,
	   MH.NM_VESSEL,
	   TH.NM_CONSIGNEE,
	   (ISNULL(TH.ADDR1_CONSIGNEE, '') + ' ' + ISNULL(TH.ADDR2_CONSIGNEE, '')) AS DC_ADDRESS,
	   ISNULL(NULLIF(TH.NO_TO, ''), MC.CD_FLAG1) AS ARRIVER_COUNTRY,
	   ISNULL(MC3.NM_SYSDEF, MC.NM_SYSDEF_E) AS NM_ARRIVER_COUNTRY,
	   TH.PORT_ARRIVER,
	   MC1.NM_SYSDEF AS NM_HS,
	   TH.CD_EXCH,
	   MC2.NM_SYSDEF AS NM_EXCH,
	   TH.AM_EX,
	   TH.REMARK1 AS TEL,
	   TH.REMARK2 AS EMAIL,
	   TH.REMARK3 AS PIC,
	   (CASE WHEN GH.CD_COMPANY = 'S100' THEN @V_BAN ELSE TH.REMARK4 END) AS BAN,
	   (CASE WHEN GH.CD_COMPANY = 'S100' THEN @V_PC ELSE TH.REMARK5 END) AS PC,
	   PH.QT_PACK,
	   PH.QT_NET_WEIGHT,
	   PH.QT_GROSS_WEIGHT,
	   PH.NM_ITEM_PARTNER,
	   'P' AS CD_PRODUCT,
	   OL.NO_IO,
	   GH.DT_GIR,
	   TH.YN_INSURANCE,
	   ISNULL(TH.YN_DUTY, 'N') AS YN_DUTY,
	   GL.AM_CHARGE
FROM SA_GIRH GH
JOIN (SELECT GL.CD_COMPANY, GL.NO_GIR,
			 MAX(GL.NO_INV) AS NO_INV,
			 SUM(CASE WHEN GL.CD_ITEM LIKE 'SD%' THEN GL.AM_GIR ELSE 0 END) AS AM_CHARGE
	  FROM SA_GIRL GL
	  GROUP BY GL.CD_COMPANY, GL.NO_GIR) GL 
ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
JOIN CZ_TR_INVH TH ON TH.CD_COMPANY = GL.CD_COMPANY AND TH.NO_INV = GL.NO_INV
JOIN CZ_SA_GIRH_WORK_DETAIL WD ON WD.CD_COMPANY = GH.CD_COMPANY AND WD.NO_GIR = GH.NO_GIR
JOIN CZ_MA_HULL MH ON MH.NO_IMO = WD.NO_IMO
LEFT JOIN (SELECT PH.CD_COMPANY, PH.NO_GIR,
				  COUNT(1) AS QT_PACK,
				  SUM(PH.QT_NET_WEIGHT) AS QT_NET_WEIGHT,
				  SUM(PH.QT_GROSS_WEIGHT) AS QT_GROSS_WEIGHT,
				  MAX(PL.NM_ITEM_PARTNER) AS NM_ITEM_PARTNER
		   FROM CZ_SA_PACKH PH
		   JOIN (SELECT PL.CD_COMPANY, PL.NO_GIR, PL.NO_PACK,
						MAX(QL.NM_ITEM_PARTNER) AS NM_ITEM_PARTNER
				 FROM CZ_SA_PACKL PL
				 JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = PL.CD_COMPANY AND QL.NO_FILE = PL.NO_FILE AND QL.NO_LINE = PL.NO_QTLINE
				 GROUP BY PL.CD_COMPANY, PL.NO_GIR, PL.NO_PACK) PL 
		   ON PL.CD_COMPANY = PH.CD_COMPANY AND PL.NO_GIR = PH.NO_GIR AND PL.NO_PACK = PH.NO_PACK
		   GROUP BY PH.CD_COMPANY, PH.NO_GIR) PH
ON PH.CD_COMPANY = GH.CD_COMPANY AND PH.NO_GIR = GH.NO_GIR
LEFT JOIN (SELECT OL.CD_COMPANY, 
		   	      OL.NO_ISURCV,
		   	      MAX(OL.NO_IO) AS NO_IO
		   FROM MM_QTIO OL
		   GROUP BY OL.CD_COMPANY, OL.NO_ISURCV) OL
ON OL.CD_COMPANY = GH.CD_COMPANY AND OL.NO_ISURCV = GH.NO_GIR
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = TH.CD_COMPANY AND MC.CD_FIELD = 'MA_B000020' AND MC.CD_SYSDEF = TH.ARRIVER_COUNTRY
LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = TH.CD_COMPANY AND MC1.CD_FIELD = 'CZ_SA00018' AND MC1.CD_SYSDEF = TH.CD_PRODUCT
LEFT JOIN MA_CODEDTL MC2 ON MC2.CD_COMPANY = TH.CD_COMPANY AND MC2.CD_FIELD = 'MA_B000005' AND MC2.CD_SYSDEF = TH.CD_EXCH
LEFT JOIN CZ_MA_CODEDTL MC3 ON MC3.CD_COMPANY = TH.CD_COMPANY AND MC3.CD_FIELD = 'CZ_MA00004' AND MC3.CD_SYSDEF = NULLIF(TH.NO_TO, '')
WHERE GH.CD_COMPANY = @V_CD_COMPANY
AND GH.NO_GIR = @V_NO_GIR

SELECT PH.CD_COMPANY, 
	   PH.NO_GIR,
	   PH.NO_PACK,
	   PH.QT_WIDTH,
	   PH.QT_HEIGHT,
	   PH.QT_LENGTH,
	   PH.QT_NET_WEIGHT,
	   PH.QT_GROSS_WEIGHT,
	   PL.NM_ITEM_PARTNER
FROM CZ_SA_PACKH PH
LEFT JOIN (SELECT PL.CD_COMPANY, 
				  PL.NO_GIR, 
				  PL.NO_PACK,
				  MAX(QL.NM_ITEM_PARTNER) AS NM_ITEM_PARTNER
		   FROM CZ_SA_PACKL PL
		   JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = PL.CD_COMPANY AND QL.NO_FILE = PL.NO_FILE AND QL.NO_LINE = PL.NO_QTLINE
		   GROUP BY PL.CD_COMPANY, PL.NO_GIR, PL.NO_PACK) PL
ON PL.CD_COMPANY = PH.CD_COMPANY AND PL.NO_GIR = PH.NO_GIR AND PL.NO_PACK = PH.NO_PACK
WHERE PH.CD_COMPANY = @V_CD_COMPANY
AND PH.NO_GIR = @V_NO_GIR

SELECT GL.SEQ_GIR,
	   GL.QT_GIR,
	   GL.UNIT,
	   QL.NM_ITEM_PARTNER,
	   GL.UM
FROM SA_GIRL GL
LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = GL.CD_COMPANY AND QL.NO_FILE = GL.NO_SO AND QL.NO_LINE = GL.SEQ_SO
WHERE GL.CD_COMPANY = @V_CD_COMPANY
AND GL.NO_GIR = @V_NO_GIR
AND GL.CD_ITEM NOT LIKE 'SD%'

GO