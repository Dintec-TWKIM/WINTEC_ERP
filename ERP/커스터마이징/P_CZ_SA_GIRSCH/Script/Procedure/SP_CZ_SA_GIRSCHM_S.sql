USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIRSCHM_S]    Script Date: 2015-06-19 오전 11:44:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


--EXEC SP_CZ_SA_GIRSCHM_S 'TEST', '1', '1', '0', '1', '1', '20150601', '20150618', '010000', '001', '1', '1', '1', '1', '3', '1', '1', '1', '1', 'Y', 'N', '20150601', '20150618', '1', '1', '1', '1', 'N', 'S-391'            
ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIRSCHM_S]  
(
    @P_CD_COMPANY			NVARCHAR(100),		 -- 회사코드
	@P_LANGUAGE				NVARCHAR(5) = 'KR',	 
	@P_NO_GIR			    NVARCHAR(20) = '',	 -- 의뢰번호
	@P_NO_SO			    NVARCHAR(20) = '',	 -- 수주번호
	@P_KEY					NVARCHAR(20) = '',	 -- KEY
	@P_KEY2					NVARCHAR(3) = '',	 -- KEY2        
	@P_KEY3					NVARCHAR(3) = '',	 -- KEY3
	@P_DTS_CONFIRM			NVARCHAR(14) = '',	 -- 확정일자                  
    @P_STA_SO				NVARCHAR(3) = '',	 -- 처리상태              
    @P_RET					NVARCHAR(3) = '',	 -- 출고구분         
    @P_TP_SO				NVARCHAR(4) = '',	 -- 수주유형              
    @P_STATE				NCHAR(1) = '0',		 -- 상태                       
    @P_NO_EMP				NVARCHAR(10) = '',	 -- 의뢰담당자
	@P_NO_SA_EMP		    NVARCHAR(10) = '',	 -- 수주담당자  
    @P_CD_PARTNER			NVARCHAR(20) = '',	 -- 매출처
	@P_CD_GIR_PARTNER		NVARCHAR(20) = '',	 -- 납품처
    @P_TP_DATE				NVARCHAR(3) = '',	 -- 일자유형   
	@P_DT_FROM				NVARCHAR(8) = '',	 -- 조회일자From              
	@P_DT_TO				NVARCHAR(8) = '',	 -- 조회일자To
    @P_CD_TYPE1				NVARCHAR(3) = '',	 -- 물류업무(대)
	@P_CD_TYPE2				NVARCHAR(3) = '',	 -- 물류업무(중)
	@P_CD_TYPE3				NVARCHAR(3) = '',	 -- 물류업무(소)
	@P_NO_IMO				NVARCHAR(10) = '',	 -- 호선
	@P_YN_URGENT			NVARCHAR(1) = 'N',   -- 긴급건
	@P_YN_AUTO				NVARCHAR(1) = 'N',   -- 청구건
	@P_YN_AUTO_SUBMIT		NVARCHAR(1) = 'N',   -- 자동제출건
	@P_STA_GIR		        NVARCHAR(100) = '',	 -- 확정여부
	@P_NO_PO_PARTNER		NVARCHAR(50) = '',	 -- 매출처발주번호
	@P_CD_PARTNER_GRP	    NVARCHAR(4000) = '', -- 매출처그룹
	@P_YN_NOT_SUBMIT		NVARCHAR(1) = 'N',	 -- 미제출건
	@P_YN_REVIEW			NVARCHAR(1) = 'N',	 -- 검토필요
	@P_YN_NOT_OUT			NVARCHAR(1) = 'N',	 -- 미출고처리
	@P_YN_REALTIME_GI		NVARCHAR(1) = 'N',   -- 실시간출고처리
	@P_SERVER_KEY			NVARCHAR(50)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @MA_CALENDAR TABLE
(
	DT_CAL NVARCHAR(8)
)

DECLARE @CZ_SA_GIRH_PACK TABLE
(
	CD_COMPANY NVARCHAR(7),
	NO_GIR	   NVARCHAR(20)
)

DECLARE @CZ_SA_GIRL_PACK TABLE
(
	CD_COMPANY NVARCHAR(7),
	NO_GIR	   NVARCHAR(20)
)

DECLARE @SA_GIRH TABLE
(
	CD_COMPANY NVARCHAR(7),
	NO_GIR	   NVARCHAR(20)
)

DECLARE @SA_GIRL TABLE
(
	CD_COMPANY NVARCHAR(7),
	NO_GIR	   NVARCHAR(20)
)

INSERT INTO @MA_CALENDAR
SELECT DT_CAL
FROM MA_CALENDAR WITH(NOLOCK)
WHERE CD_COMPANY = 'K100'
AND FG1_HOLIDAY = 'W'
ORDER BY DT_CAL

DECLARE @V_TODAY NVARCHAR(8) = CONVERT(CHAR(8), GETDATE(), 112)

INSERT INTO @CZ_SA_GIRH_PACK
SELECT GH.CD_COMPANY, GH.NO_GIR
FROM CZ_SA_GIRH_PACK GH
LEFT JOIN CZ_SA_GIRH_PACK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
WHERE GH.CD_COMPANY IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_COMPANY))
AND (@P_STATE <> '1' OR ISNULL(LEFT(GD.DTS_SUBMIT, 8), '') = @P_KEY)
AND (@P_STATE <> '2' OR ISNULL(GH.CD_PARTNER, '') = @P_KEY)
AND (@P_STATE <> '3' OR ('002' = @P_KEY AND
						 ISNULL(GD.CD_PACK_CATEGORY, '') = @P_KEY2 AND 
						 ISNULL(GD.CD_SUB_CATEGORY, '') = @P_KEY3))
AND (@P_STATE <> '4' OR ISNULL(GD.DT_COMPLETE, '') = @P_KEY)
AND (@P_STATE <> '5' OR ISNULL(GD.DT_START, '') = @P_KEY)
AND (@P_NO_GIR = '' OR GH.NO_GIR = REPLACE(@P_NO_GIR, 'DN', 'WO'))
AND ((CASE @P_TP_DATE WHEN '001' THEN GD.DT_START
				      WHEN '002' THEN LEFT(GD.DTS_SUBMIT, 8)
					  WHEN '003' THEN GD.DT_COMPLETE
					  WHEN '004' THEN GH.DT_GIR END) BETWEEN @P_DT_FROM AND @P_DT_TO)
AND (@P_DTS_CONFIRM = '' OR (CASE WHEN GH.DTS_UPDATE > GD.DTS_CONFIRM THEN GH.DTS_UPDATE ELSE GD.DTS_CONFIRM END) >= @P_DTS_CONFIRM)
AND (@P_STA_SO <> 'Y' OR GH.STA_GIR = 'C')
AND (@P_STA_SO <> 'N' OR GH.STA_GIR <> 'C')
AND (@P_YN_URGENT <> 'Y' OR (SUBSTRING(GD.DTS_SUBMIT, 1, 8) = SUBSTRING(GD.DT_COMPLETE, 1, 8)) OR
							 (SUBSTRING(GD.DTS_SUBMIT, 9, 2) >= 16 AND 
							  SUBSTRING(GD.DT_COMPLETE, 1, 8) <= (SELECT TOP 1 DT_CAL 
																  FROM @MA_CALENDAR
																  WHERE DT_CAL > SUBSTRING(GD.DTS_SUBMIT, 1, 8))))
AND (@P_CD_PARTNER = '' OR GH.CD_PARTNER = @P_CD_PARTNER)
AND (@P_CD_GIR_PARTNER = '' OR GD.CD_COLLECT_FROM = @P_CD_GIR_PARTNER)
AND (@P_NO_EMP = '' OR GH.NO_EMP = @P_NO_EMP)
AND (@P_NO_IMO = '' OR GD.NO_IMO = @P_NO_IMO)
AND (@P_CD_TYPE1 = '' OR '002' = @P_CD_TYPE1)
AND (@P_CD_TYPE2 = '' OR GD.CD_PACK_CATEGORY = @P_CD_TYPE2)
AND (@P_CD_TYPE3 = '' OR GD.CD_SUB_CATEGORY = @P_CD_TYPE3)
AND (@P_YN_AUTO_SUBMIT = 'N' OR 'N' = @P_YN_AUTO_SUBMIT)
AND (@P_STA_GIR = '' OR GH.STA_GIR IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_STA_GIR)))
AND (@P_CD_PARTNER_GRP = '' OR MP.CD_PARTNER_GRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_PARTNER_GRP)))
AND (@P_YN_NOT_SUBMIT = 'N' OR ISNULL(GH.STA_GIR, '') <> '')
AND (@P_YN_REALTIME_GI = 'N' OR ISNULL(GH.CD_USERDEF3, '') = 'A')

INSERT INTO @CZ_SA_GIRL_PACK
SELECT GH.CD_COMPANY, GH.NO_GIR
FROM @CZ_SA_GIRH_PACK GH
LEFT JOIN CZ_SA_GIRL_PACK GL ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = GL.CD_COMPANY AND SL.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT) AND SL.SEQ_SO = (CASE WHEN GL.SEQ_SO = 0 THEN GL.NO_SOLINE_MGMT ELSE GL.SEQ_SO END)
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = SL.CD_COMPANY AND SH.NO_SO = SL.NO_SO
LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
WHERE (@P_NO_SO = '' OR SL.NO_SO = @P_NO_SO)
AND (@P_RET = '' OR GL.RET = @P_RET)
AND (@P_TP_SO = '' OR SH.TP_SO = @P_TP_SO)
AND (@P_NO_SA_EMP = '' OR SH.NO_EMP = @P_NO_SA_EMP)
AND (@P_YN_AUTO = 'N' OR QL.CD_COMPANY IS NOT NULL)
AND (@P_NO_PO_PARTNER = '' OR SH.NO_PO_PARTNER = @P_NO_PO_PARTNER)
GROUP BY GH.CD_COMPANY, GH.NO_GIR

INSERT INTO @SA_GIRH
SELECT GH.CD_COMPANY, GH.NO_GIR
FROM SA_GIRH GH
LEFT JOIN CZ_SA_GIRH_WORK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
WHERE GH.CD_COMPANY IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_COMPANY))
AND (@P_STATE <> '1' OR ISNULL(LEFT(GD.DTS_SUBMIT, 8), '') = @P_KEY)
AND (@P_STATE <> '2' OR ISNULL(GH.CD_PARTNER, '') = @P_KEY)
AND (@P_STATE <> '3' OR ('001' = @P_KEY AND
	  					 ISNULL(GD.CD_MAIN_CATEGORY, '') = @P_KEY2 AND 
	  					 ISNULL(GD.CD_SUB_CATEGORY, '') = @P_KEY3))
AND (@P_STATE <> '4' OR ISNULL(GD.DT_COMPLETE, '') = @P_KEY)
AND (@P_STATE <> '5' OR ISNULL(GD.DT_START, '') = @P_KEY)
AND (@P_NO_GIR = '' OR GH.NO_GIR = REPLACE(@P_NO_GIR, 'DN', 'WO'))
AND (@P_NO_GIR <> '' OR 
	 ((CASE @P_TP_DATE WHEN '001' THEN GD.DT_START
				       WHEN '002' THEN LEFT(GD.DTS_SUBMIT, 8)
					   WHEN '003' THEN GD.DT_COMPLETE
					   WHEN '004' THEN GH.DT_GIR END) BETWEEN @P_DT_FROM AND @P_DT_TO))
AND (@P_DTS_CONFIRM = '' OR (CASE WHEN GH.DTS_UPDATE > GD.DTS_CONFIRM THEN GH.DTS_UPDATE ELSE GD.DTS_CONFIRM END) >= @P_DTS_CONFIRM)
AND (@P_STA_SO <> 'Y' OR GH.STA_GIR = 'C')
AND (@P_STA_SO <> 'N' OR GH.STA_GIR <> 'C')
AND (@P_YN_URGENT <> 'Y' OR (SUBSTRING(GD.DTS_SUBMIT, 1, 8) = SUBSTRING(GD.DT_COMPLETE, 1, 8)) OR
							 ((SUBSTRING(GD.DTS_SUBMIT, 9, 2) >= 16 OR 
							   (GD.CD_MAIN_CATEGORY = '001' OR (GD.CD_MAIN_CATEGORY = '002' AND GD.CD_SUB_CATEGORY = 'DIR'))) AND 
							  SUBSTRING(GD.DT_COMPLETE, 1, 8) <= (SELECT TOP 1 DT_CAL 
																  FROM @MA_CALENDAR
																  WHERE DT_CAL > SUBSTRING(GD.DTS_SUBMIT, 1, 8))))
AND (@P_CD_PARTNER = '' OR GH.CD_PARTNER = @P_CD_PARTNER)
AND (@P_CD_GIR_PARTNER = '' OR GD.CD_DELIVERY_TO = @P_CD_GIR_PARTNER)
AND (@P_NO_EMP = '' OR GH.NO_EMP = @P_NO_EMP)
AND (@P_NO_IMO = '' OR GD.NO_IMO = @P_NO_IMO)
AND (@P_CD_TYPE1 = '' OR '001' = @P_CD_TYPE1)
AND (@P_CD_TYPE2 = '' OR GD.CD_MAIN_CATEGORY = @P_CD_TYPE2)
AND (@P_CD_TYPE3 = '' OR GD.CD_SUB_CATEGORY = @P_CD_TYPE3)
AND (@P_YN_AUTO_SUBMIT = 'N' OR GD.YN_AUTO_SUBMIT = @P_YN_AUTO_SUBMIT)
AND (@P_STA_GIR = '' OR GH.STA_GIR IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_STA_GIR)))
AND (@P_CD_PARTNER_GRP = '' OR MP.CD_PARTNER_GRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_PARTNER_GRP)))
AND (@P_YN_NOT_SUBMIT = 'N' OR ISNULL(GH.STA_GIR, '') <> '')
AND (@P_YN_REALTIME_GI = 'N' OR ISNULL(GH.CD_USERDEF3, '') = 'A')

INSERT INTO @SA_GIRL
SELECT GH.CD_COMPANY, GH.NO_GIR
FROM @SA_GIRH GH
LEFT JOIN SA_GIRL GL ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = GL.CD_COMPANY AND SL.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT) AND SL.SEQ_SO = (CASE WHEN GL.SEQ_SO = 0 THEN GL.NO_SOLINE_MGMT ELSE GL.SEQ_SO END)
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = SL.CD_COMPANY AND SH.NO_SO = SL.NO_SO
LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
WHERE (@P_NO_SO = '' OR SL.NO_SO = @P_NO_SO)
AND (@P_RET = '' OR GL.RET = @P_RET)
AND (@P_TP_SO = '' OR SH.TP_SO = @P_TP_SO)
AND (@P_NO_SA_EMP = '' OR SH.NO_EMP = @P_NO_SA_EMP)
AND (@P_YN_AUTO = 'N' OR QL.CD_COMPANY IS NOT NULL)
AND (@P_NO_PO_PARTNER = '' OR SH.NO_PO_PARTNER = @P_NO_PO_PARTNER)
GROUP BY GH.CD_COMPANY, GH.NO_GIR

DECLARE	@V_SERVER_PATH NVARCHAR(MAX)

SELECT @V_SERVER_PATH = ASSEMBLY_HOST_SERVER
FROM CM_SERVER_CONFIG
WHERE SERVER_KEY = @P_SERVER_KEY

SELECT 'N' AS S,
	   GH.CD_COMPANY,
	   MC.NM_COMPANY,
	   GH.NO_GIR,
	   GH.DT_GIR,
	   GD.DT_START,
	   GD.DT_COMPLETE,
	   '' AS DT_BILL,
	   '002' AS CD_TYPE,
	   (CASE WHEN @P_LANGUAGE = 'KR' THEN MD2.NM_SYSDEF ELSE MD2.NM_SYSDEF_E END) AS NM_TYPE1,
	   (CASE WHEN @P_LANGUAGE = 'KR' THEN MD3.NM_SYSDEF ELSE MD3.NM_SYSDEF_E END) AS NM_TYPE2,
	   (CASE WHEN @P_LANGUAGE = 'KR' THEN MD4.NM_SYSDEF ELSE MD4.NM_SYSDEF_E END) AS NM_TYPE3,
	   GD.YN_PACKING,
	   GL.YN_TAX,
	   (CASE WHEN SUBSTRING(GD.DTS_SUBMIT, 1, 8) = SUBSTRING(GD.DT_COMPLETE, 1, 8) THEN 'Y'
			 WHEN SUBSTRING(GD.DTS_SUBMIT, 9, 2) >= 16 AND 
				  SUBSTRING(GD.DT_COMPLETE, 1, 8) <= (SELECT TOP 1 DT_CAL 
													  FROM @MA_CALENDAR
													  WHERE DT_CAL > SUBSTRING(GD.DTS_SUBMIT, 1, 8)) THEN 'Y'
			 ELSE 'N' END) AS YN_URGENT,
	   'N' AS YN_AUTO_SUBMIT,
	   GH.STA_GIR,
	   GD.DT_PACKING AS DT_DONE,
	   ME1.NM_KOR AS NM_EMP_GIR,
	   ME2.NM_KOR AS NM_EMP_LOG,
	   ME3.NM_KOR AS NM_EMP_SO,
	   MH.NM_VESSEL,
	   MP.LN_PARTNER,
	   MP1.LN_PARTNER AS NM_GIR_PARTNER,
	   ISNULL(MD13.NM_SYSDEF, MD5.NM_SYSDEF_E) AS ARRIVER_COUNTRY,
	   GL.QT_ITEM,
	   MP.CD_PARTNER_GRP,
	   MD1.NM_SYSDEF AS NM_PARTNER_GRP,
	   GH.CD_PARTNER,
	   PT.NM_PLANT,
	   MD.NM_SYSDEF AS NM_RETURN,
	   GD.DC_RMK1,
	   GD.DC_RMK2,
	   GD.DC_RMK3,
	   GD.DC_RMK4,
	   MD6.NM_SYSDEF AS NM_RMK,
	   GD.DC_RMK,
	   GD.DC_RESULT,
	   ME.NM_KOR AS NM_EMP_SALE,
	   GH.DTS_INSERT,
	   GH.DTS_UPDATE,
	   GD.DTS_SUBMIT,
	   GD.DTS_CONFIRM,
	   GH.YN_RETURN,
	   PH.DC_RMK AS DC_RMK_PACK,
	   GH.MEMO_CD,
	   GH.CHECK_PEN,
	   
	   MD8.NM_SYSDEF AS NM_STA_GIR,
	   GD.NO_IMO,
	   MH.NO_HULL,
	   GH.CD_PLANT,
	   MD7.NM_SYSDEF AS NM_BUSI,
	   IH.NM_CONSIGNEE,
	   IH.ADDR1_CONSIGNEE,
	   IH.ADDR2_CONSIGNEE,
	   IH.NM_NOTIFY,
	   IH.ADDR1_NOTIFY,
	   IH.ADDR2_NOTIFY,
	   IH.REMARK1 AS TEL,
	   IH.REMARK2 AS EMAIL,
	   IH.REMARK3 AS PIC,
	   IH.ADDR1_PARTNER,
	   IH.ADDR2_PARTNER,
	   IH.PORT_LOADING,
	   (CASE WHEN ISNULL(MD5.NM_SYSDEF_E, '') = '' THEN ISNULL(IH.PORT_ARRIVER, '')
			 WHEN ISNULL(IH.PORT_ARRIVER, '') = '' THEN MD5.NM_SYSDEF_E 
												   ELSE (ISNULL(IH.PORT_ARRIVER, '') + ' ' + ISNULL(MD13.NM_SYSDEF, MD5.NM_SYSDEF_E)) END) AS PORT_ARRIVER,
	   IH.DT_SAILING_ON,
	   MD9.NM_SYSDEF AS NM_HS,
	   MD10.NM_SYSDEF_E AS NM_ORIGIN,
	   (MD11.NM_SYSDEF + ' ' + ISNULL(MD14.NM_SYSDEF, IH.PORT_LOADING)) AS NM_TRANS,
	   MD12.NM_SYSDEF AS NM_COND_PAY,
	   GL.NO_IO,
	   GL.DT_IO,
	   GL.NO_SALES,
	   GL.NM_ENG,
	   (CASE WHEN ISNULL(GL.DC_SIGN, '') = '' THEN '' ELSE ISNULL(@V_SERVER_PATH, '') + '/shared/image/human/sign/' + GL.CD_COMPANY + '/' + GL.DC_SIGN END) AS PATH_SIGN,
	   PH.QT_BOX,
	   GL.QT_PARTIAL,
	   GL.QT_CLAIM,
	   '' AS NO_PO_PARTNER_ALL,
	   GL.NM_ITEMGRP,
	   STUFF((SELECT '+' + MC.CD_FLAG2 + CONVERT(VARCHAR, CONVERT(INT, PH.QT_WIDTH))
			  FROM CZ_SA_PACKH PH
			  JOIN MA_CODEDTL MC ON MC.CD_COMPANY = PH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00026' AND MC.CD_SYSDEF = PH.CD_TYPE
			  WHERE PH.CD_COMPANY = GH.CD_COMPANY
			  AND PH.NO_GIR = GH.NO_GIR
			  FOR XML PATH('')), 1,1, '')AS DC_RESULT_PACK,
	  STUFF((SELECT DISTINCT ',' + LEFT(GL.NO_SO, 2)
			  FROM CZ_SA_GIRL_PACK GL
			  WHERE GL.CD_COMPANY = GH.CD_COMPANY
			  AND GL.NO_GIR = GH.NO_GIR
			  FOR XML PATH('')), 1,1, '')AS NO_SO_PRE,
	  GL.NO_SO,
	  GL.NO_PO_PARTNER,
	  GL.YN_AM,
	  '002' AS TP_GIR,
	  GD.CD_PACK_CATEGORY AS CD_MAIN_CATEGORY,
	  GD.CD_SUB_CATEGORY,
	  GD.CD_COLLECT_FROM AS CD_DELIVERY_TO,
	  NULL AS CD_GW_STATUS,
	  NULL AS NM_GW_STATUS,
	  NULL AS QT_RECIEPT_PAGE,
	  NULL AS NO_EMAIL,
	  NULL AS NO_DELIVERY_EMAIL,
	  NULL AS YN_CPR,
	  NULL AS DTS_CPR,
	  NULL AS YN_EXCLUDE_CPR,
	  NULL AS YN_AUTO_CPR,
	  GD.DC_RMK_CI,
	  NULL AS DC_RMK_PL,
	  NULL AS YN_FILE,
	  GL.AM_GIR_10000,
	  GD.DTS_PRINT,
	  NULL AS DT_IV,
	  NULL AS DTS_CUTOFF,
	  NULL AS CD_TAEGBAE,
	  NULL AS DC_FORWARD_OUT,
	  ('이윤 : ' + CONVERT(NVARCHAR, FORMAT(GL.AM_PROFIT, '#,##0')) + '원' + (CASE WHEN GL.QT_NOT_BILL > 0 THEN ' (포장비청구불가)' ELSE ' (포장비청구가능)' END)) AS DC_PACK_CHARGE,
	  (ISNULL(MP1.DC_ADDRESS, '') + ' ' + ISNULL(MP1.DC_ADDRESS1, '') + ' ' + ISNULL(MP1.NM_PIC, '') + ' ' + ISNULL(MP1.NO_TEL, '')) AS DC_DELIVERY_ADDR,
	  LEFT(GD.DTS_SUBMIT, 8) AS DT_SUBMIT,
	  'N' AS YN_REVIEW
FROM CZ_SA_GIRH_PACK GH
LEFT JOIN CZ_SA_GIRH_PACK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
LEFT JOIN (SELECT GL.CD_COMPANY, GL.NO_GIR,
				  MAX(GL.NO_INV) AS NO_INV,
				  'N' AS YN_TAX,
				  COUNT(1) AS QT_ITEM,
				  MAX(IG.NM_ITEMGRP) AS NM_ITEMGRP,
				  MAX(GL.NO_SO) AS NO_SO,
				  MAX(SL.NO_PO_PARTNER) AS NO_PO_PARTNER,
				  NULL AS NO_IO,
				  NULL AS DT_IO,
				  MAX(SO.NO_SALES) AS NO_SALES,
	  			  MAX(PT.DC_SIGN) AS DC_SIGN,
	  			  MAX(ME.NM_ENG) AS NM_ENG,
				  MAX(JT.YN_AM) AS YN_AM,

				  SUM(CASE WHEN (ISNULL(SL.QT_SO, 0) - ISNULL(SL.QT_GI, 0)) > ISNULL(GL.QT_GIR, 0) THEN 1 ELSE 0 END) AS QT_PARTIAL,
				  SUM(CASE WHEN (SL.NO_SO LIKE 'CL%' OR SL.NO_SO LIKE 'CN%') THEN 1 ELSE 0 END) AS QT_CLAIM,
				  ROUND(SUM(GL.AM_GIRAMT) / 10000, 0, 1) AS AM_GIR_10000,
				  SUM(CASE WHEN MC.CD_FLAG1 = 'N' THEN 1 ELSE 0 END) AS QT_NOT_BILL,
				  SUM((CASE WHEN TP.RET = 'Y' THEN -ISNULL(SL.AM_WONAMT, 0) ELSE ISNULL(SL.AM_WONAMT, 0) END) - (ISNULL(PL.AM_PO, 0) + ISNULL(SB.UM_KR * SB.QT_STOCK, 0))) AS AM_PROFIT
		   FROM CZ_SA_GIRL_PACK GL
		   LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = GL.CD_COMPANY AND SL.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT) AND SL.SEQ_SO = (CASE WHEN GL.SEQ_SO = 0 THEN GL.NO_SOLINE_MGMT ELSE GL.SEQ_SO END)
		   LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
		   LEFT JOIN MA_ITEMGRP IG ON IG.CD_COMPANY = QL.CD_COMPANY AND IG.CD_ITEMGRP = QL.GRP_ITEM
		   LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = GL.CD_COMPANY AND SG.CD_SALEGRP = GL.CD_SALEGRP
	  	   LEFT JOIN MA_SALEORG SO ON SO.CD_COMPANY = SG.CD_COMPANY AND SO.CD_SALEORG = SG.CD_SALEORG
	  	   LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SO.CD_COMPANY AND ME.NO_EMP = SO.NO_SALES
	  	   LEFT JOIN HR_PHOTO PT ON PT.CD_COMPANY = ME.CD_COMPANY AND PT.NO_EMP = ME.NO_EMP
		   LEFT JOIN MM_EJTP JT ON JT.CD_COMPANY = GL.CD_COMPANY AND JT.CD_QTIOTP = GL.TP_GI
		   LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = SL.CD_COMPANY AND SH.NO_SO = SL.NO_SO
		   LEFT JOIN SA_TPSO TP ON TP.CD_COMPANY = SH.CD_COMPANY AND TP.TP_SO = SH.TP_SO
		   LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = SH.CD_COMPANY AND MC.CD_FIELD = 'TR_IM00011' AND MC.CD_SYSDEF = SH.TP_PACKING
		   LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO
		   LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE,
		                     SUM(PL.AM) AS AM_PO
		              FROM PU_POL PL
		              WHERE PL.CD_ITEM NOT LIKE 'SD%'
		              GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE) PL
		   ON PL.CD_COMPANY = SL.CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.NO_SOLINE = SL.SEQ_SO
		   GROUP BY GL.CD_COMPANY, GL.NO_GIR) GL
ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
LEFT JOIN MA_COMPANY MC ON MC.CD_COMPANY = GH.CD_COMPANY
LEFT JOIN (SELECT CD_COMPANY, NO_GIR, 
				  COUNT(NO_PACK) AS QT_BOX,
				  MAX(DC_RMK) AS DC_RMK 
		   FROM CZ_SA_PACKH
		   GROUP BY CD_COMPANY, NO_GIR) PH
ON PH.CD_COMPANY = GH.CD_COMPANY AND PH.NO_GIR = GH.NO_GIR
LEFT JOIN CZ_TR_INVH IH ON IH.CD_COMPANY = GH.CD_COMPANY AND IH.NO_INV = GL.NO_INV
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
LEFT JOIN CZ_MA_DELIVERY MP1 ON MP1.CD_COMPANY = GH.CD_COMPANY AND MP1.CD_PARTNER = GD.CD_COLLECT_FROM
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = GD.NO_IMO
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = GL.CD_COMPANY AND SH.NO_SO = GL.NO_SO
LEFT JOIN CZ_MA_WORKFLOWH WH ON WH.CD_COMPANY = SH.CD_COMPANY AND WH.TP_STEP = '08' AND WH.NO_KEY = SH.NO_SO 
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = GH.CD_COMPANY AND ME.NO_EMP = MP.CD_EMP_SALE
LEFT JOIN MA_EMP ME1 ON ME1.CD_COMPANY = GH.CD_COMPANY AND ME1.NO_EMP = GH.NO_EMP
LEFT JOIN MA_EMP ME2 ON ME2.CD_COMPANY = WH.CD_COMPANY AND ME2.NO_EMP = WH.ID_LOG
LEFT JOIN MA_EMP ME3 ON ME3.CD_COMPANY = SH.CD_COMPANY AND ME3.NO_EMP = SH.NO_EMP
LEFT JOIN MA_PLANT PT ON PT.CD_COMPANY = GH.CD_COMPANY AND PT.CD_PLANT = GH.CD_PLANT
LEFT JOIN MA_CODEDTL MD ON MD.CD_COMPANY = GH.CD_COMPANY AND MD.CD_FIELD = 'PU_C000027' AND MD.CD_SYSDEF = GH.YN_RETURN
LEFT JOIN MA_CODEDTL MD1 ON MD1.CD_COMPANY = GH.CD_COMPANY AND MD1.CD_FIELD = 'MA_B000065' AND MD1.CD_SYSDEF = MP.CD_PARTNER_GRP
LEFT JOIN MA_CODEDTL MD2 ON MD2.CD_COMPANY = GH.CD_COMPANY AND MD2.CD_FIELD = 'CZ_SA00021' AND MD2.CD_SYSDEF = '002'
LEFT JOIN MA_CODEDTL MD3 ON MD3.CD_COMPANY = GH.CD_COMPANY AND MD3.CD_FIELD = 'CZ_SA00020' AND MD3.CD_SYSDEF = GD.CD_PACK_CATEGORY
LEFT JOIN MA_CODEDTL MD4 ON MD4.CD_COMPANY = GH.CD_COMPANY AND MD4.CD_FIELD = MD3.CD_FLAG1 AND MD4.CD_SYSDEF = GD.CD_SUB_CATEGORY
LEFT JOIN MA_CODEDTL MD5 ON MD5.CD_COMPANY = GH.CD_COMPANY AND MD5.CD_FIELD = 'MA_B000020' AND MD5.CD_SYSDEF = IH.ARRIVER_COUNTRY
LEFT JOIN MA_CODEDTL MD6 ON MD6.CD_COMPANY = GH.CD_COMPANY AND MD6.CD_FIELD = 'CZ_SA00032' AND MD6.CD_SYSDEF = GD.CD_RMK

LEFT JOIN MA_CODEDTL MD7 ON MD7.CD_COMPANY = GH.CD_COMPANY AND MD7.CD_FIELD = 'PU_C000016' AND MD7.CD_SYSDEF = GH.TP_BUSI
LEFT JOIN MA_CODEDTL MD8 ON MD8.CD_COMPANY = GH.CD_COMPANY AND MD8.CD_FIELD = 'CZ_SA00030' AND MD8.CD_SYSDEF = GH.STA_GIR
LEFT JOIN MA_CODEDTL MD9 ON MD9.CD_COMPANY = GH.CD_COMPANY AND MD9.CD_FIELD = 'CZ_SA00018' AND MD9.CD_SYSDEF = IH.CD_PRODUCT
LEFT JOIN MA_CODEDTL MD10 ON MD10.CD_COMPANY = GH.CD_COMPANY AND MD10.CD_FIELD = 'MA_B000020' AND MD10.CD_SYSDEF = IH.CD_ORIGIN
LEFT JOIN MA_CODEDTL MD11 ON MD11.CD_COMPANY = GH.CD_COMPANY AND MD11.CD_FIELD = 'TR_IM00003' AND MD11.CD_SYSDEF = IH.TP_TRANS
LEFT JOIN MA_CODEDTL MD12 ON MD12.CD_COMPANY = GH.CD_COMPANY AND MD12.CD_FIELD = 'CZ_SA00013' AND MD12.CD_SYSDEF = IH.COND_PAY
LEFT JOIN CZ_MA_CODEDTL MD13 ON MD13.CD_COMPANY = IH.CD_COMPANY AND MD13.CD_FIELD = 'CZ_MA00004' AND MD13.CD_SYSDEF = IH.NO_TO
LEFT JOIN MA_CODEDTL MD14 ON MD14.CD_COMPANY = GH.CD_COMPANY AND MD14.CD_FIELD = 'CZ_SA00005' AND MD14.CD_SYSDEF = IH.TP_TRANSPORT
WHERE EXISTS (SELECT 1 
			  FROM @CZ_SA_GIRL_PACK
			  WHERE CD_COMPANY = GH.CD_COMPANY
			  AND NO_GIR = GH.NO_GIR)
AND @P_YN_REVIEW = 'N'
AND @P_YN_NOT_OUT = 'N'
UNION ALL
SELECT 'N' AS S,
	   GH.CD_COMPANY,
	   MC.NM_COMPANY,
	   GH.NO_GIR,
	   GH.DT_GIR,
	   GD.DT_START,
	   GD.DT_COMPLETE,
	   GD.DT_BILL,
	   '001' AS CD_TYPE,
	   (CASE WHEN '' + @P_LANGUAGE + '' = 'KR' THEN MD2.NM_SYSDEF ELSE MD2.NM_SYSDEF_E END) AS NM_TYPE1,
	   (CASE WHEN '' + @P_LANGUAGE + '' = 'KR' THEN MD3.NM_SYSDEF ELSE MD3.NM_SYSDEF_E END) AS NM_TYPE2,
	   (CASE WHEN '' + @P_LANGUAGE + '' = 'KR' THEN MD4.NM_SYSDEF ELSE MD4.NM_SYSDEF_E END) AS NM_TYPE3,
	   GD.YN_PACKING,
	   GL.YN_TAX,
	   (CASE WHEN ISNULL(GD.DTS_CUTOFF, '') <> '' THEN 'Y'
			 WHEN SUBSTRING(GD.DTS_SUBMIT, 1, 8) = SUBSTRING(GD.DT_COMPLETE, 1, 8) THEN 'Y'
			 WHEN (SUBSTRING(GD.DTS_SUBMIT, 9, 2) >= 16 OR 
				   (GD.CD_MAIN_CATEGORY = '001' OR (GD.CD_MAIN_CATEGORY = '002' AND GD.CD_SUB_CATEGORY = 'DIR'))) AND 
				   SUBSTRING(GD.DT_COMPLETE, 1, 8) <= (SELECT TOP 1 DT_CAL 
													   FROM @MA_CALENDAR
													   WHERE DT_CAL > SUBSTRING(GD.DTS_SUBMIT, 1, 8)) THEN 'Y'
			 ELSE 'N' END) AS YN_URGENT,
	   GD.YN_AUTO_SUBMIT,
	   GH.STA_GIR,
	   (GD.DT_LOADING + '000000') AS DT_DONE,
	   ME1.NM_KOR AS NM_EMP_GIR,
	   ME2.NM_KOR AS NM_EMP_LOG,
	   ME3.NM_KOR AS NM_EMP_SO,
	   MH.NM_VESSEL,
	   IH.NM_PARTNER AS LN_PARTNER,
	   MP1.LN_PARTNER AS NM_GIR_PARTNER,
	   ISNULL(MD14.NM_SYSDEF, MD5.NM_SYSDEF_E) AS ARRIVER_COUNTRY,
	   GL.QT_ITEM,
	   MP.CD_PARTNER_GRP,
	   MD1.NM_SYSDEF AS NM_PARTNER_GRP,
	   GH.CD_PARTNER,
	   PT.NM_PLANT,
	   MD.NM_SYSDEF AS NM_RETURN,
	   GD.DC_RMK1,
	   GD.DC_RMK2,
	   GD.DC_RMK3,
	   GD.DC_RMK4,
	   MD6.NM_SYSDEF AS NM_RMK,
	   GD.DC_RMK,
	   GD.DC_RESULT,
	   ME.NM_KOR AS NM_EMP_SALE,
	   GH.DTS_INSERT,
	   GH.DTS_UPDATE,
	   GD.DTS_SUBMIT,
	   GD.DTS_CONFIRM,
	   GH.YN_RETURN,
	   PH.DC_RMK AS DC_RMK_PACK,
	   GH.MEMO_CD,
	   GH.CHECK_PEN,
	   
	   MD8.NM_SYSDEF AS NM_STA_GIR,
	   GD.NO_IMO,
	   MH.NO_HULL,
	   GH.CD_PLANT,
	   MD7.NM_SYSDEF AS NM_BUSI,
	   IH.NM_CONSIGNEE,
	   IH.ADDR1_CONSIGNEE,
	   IH.ADDR2_CONSIGNEE,
	   IH.NM_NOTIFY,
	   IH.ADDR1_NOTIFY,
	   IH.ADDR2_NOTIFY,
	   IH.REMARK1 AS TEL,
	   IH.REMARK2 AS EMAIL,
	   IH.REMARK3 AS PIC,
	   IH.ADDR1_PARTNER,
	   IH.ADDR2_PARTNER,
	   IH.PORT_LOADING,
	   (CASE WHEN ISNULL(MD5.NM_SYSDEF_E, '') = '' THEN ISNULL(IH.PORT_ARRIVER, '')
			 WHEN ISNULL(IH.PORT_ARRIVER, '') = '' THEN MD5.NM_SYSDEF_E 
												   ELSE (ISNULL(IH.PORT_ARRIVER, '') + ' ' + ISNULL(MD14.NM_SYSDEF, MD5.NM_SYSDEF_E)) END) AS PORT_ARRIVER,
	   IH.DT_SAILING_ON,
	   MD9.NM_SYSDEF AS NM_HS,
	   MD10.NM_SYSDEF_E AS NM_ORIGIN,
	   (MD11.NM_SYSDEF + ' ' + ISNULL(MD15.NM_SYSDEF, IH.PORT_LOADING)) AS NM_TRANS,
	   MD12.NM_SYSDEF AS NM_COND_PAY,
	   GL.NO_IO,
	   GL.DT_IO,
	   GL.NO_SALES,
	   GL.NM_ENG,
	   (CASE WHEN ISNULL(GL.DC_SIGN, '') = '' THEN '' ELSE ISNULL(@V_SERVER_PATH, '') + '/shared/image/human/sign/' + GL.CD_COMPANY + '/' + GL.DC_SIGN END) AS PATH_SIGN,
	   PH.QT_BOX,
	   GL.QT_PARTIAL,
	   GL.QT_CLAIM,
	   '' AS NO_PO_PARTNER_ALL,
	   GL.NM_ITEMGRP,
	   STUFF((SELECT '+' + MC.CD_FLAG2 + CONVERT(VARCHAR, CONVERT(INT, PH.QT_WIDTH))
			  FROM CZ_SA_PACKH PH
			  JOIN MA_CODEDTL MC ON MC.CD_COMPANY = PH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00026' AND MC.CD_SYSDEF = PH.CD_TYPE
			  WHERE PH.CD_COMPANY = GH.CD_COMPANY
			  AND PH.NO_GIR = GH.NO_GIR
			  FOR XML PATH('')), 1,1, '')AS DC_RESULT_PACK,
	   STUFF((SELECT DISTINCT ',' + LEFT(GL.NO_SO, 2)
			  FROM SA_GIRL GL
			  WHERE GL.CD_COMPANY = GH.CD_COMPANY
			  AND GL.NO_GIR = GH.NO_GIR
			  FOR XML PATH('')), 1,1, '')AS NO_SO_PRE,
	   GL.NO_SO,
	   GL.NO_PO_PARTNER,
	   GL.YN_AM,
	   '001' AS TP_GIR,
	   GD.CD_MAIN_CATEGORY,
	   GD.CD_SUB_CATEGORY,
	   GD.CD_DELIVERY_TO,
	   GW.ST_STAT AS CD_GW_STATUS,
	   MD13.NM_SYSDEF AS NM_GW_STATUS,
	   GD.QT_RECIEPT_PAGE,
	   MP1.NO_EMAIL,
	   GD.NO_DELIVERY_EMAIL,
	   GD.YN_CPR,
	   GD.DTS_CPR,
	   GD.YN_EXCLUDE_CPR,
	   (CASE WHEN ((GD.CD_MAIN_CATEGORY = '002' AND GD.CD_SUB_CATEGORY IN ('DIR', 'ADV')) OR 
				   (GD.CD_MAIN_CATEGORY = '003' AND GD.CD_SUB_CATEGORY IN ('001', '002', '004', '005', '007')))
			       AND GH.STA_GIR = 'C'
				   AND ISNULL(GD.YN_CPR, 'N') = 'N'
				   AND ISNULL(GD.YN_EXCLUDE_CPR, 'N') = 'N'
				   AND GD.DT_COMPLETE = CONVERT(CHAR(8), NEOE.SF_SYSDATE(GETDATE()), 112)
				   AND ISNULL(NULLIF(GD.NO_DELIVERY_EMAIL, ''), MP1.NO_EMAIL) <> ''
				   AND NOT EXISTS (SELECT 1
								   FROM (SELECT GL.CD_COMPANY, GL.NO_GIR,
								   		 	    SUM(GL.QT_GIR) AS QT_GIR
								   		 FROM SA_GIRL GL
								   		 WHERE GL.CD_COMPANY = GH.CD_COMPANY 
								   		 AND GL.NO_GIR = GH.NO_GIR
								   		 AND GL.CD_ITEM NOT LIKE 'SD%'
								   		 GROUP BY GL.CD_COMPANY, GL.NO_GIR) GL
								   LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_GIR,
								   				     SUM(PL.QT_PACK) AS QT_PACK
								   		      FROM CZ_SA_PACKL PL
								   		      WHERE PL.CD_ITEM NOT LIKE 'SD%'
								   		      GROUP BY PL.CD_COMPANY, PL.NO_GIR) PL
								   ON PL.CD_COMPANY = GL.CD_COMPANY AND PL.NO_GIR = GL.NO_GIR
								   WHERE GL.QT_GIR <> PL.QT_PACK) THEN 'Y' ELSE 'N' END) AS YN_AUTO_CPR,
	   GD.DC_RMK_CI,
	   GD.DC_RMK_PL,
	   (CASE WHEN EXISTS (SELECT * 
						  FROM MA_FILEINFO MF
						  WHERE MF.CD_COMPANY = GH.CD_COMPANY
						  AND MF.CD_MODULE = 'SA' 
						  AND MF.ID_MENU = 'P_CZ_SA_GIR'
						  AND MF.CD_FILE = GH.NO_GIR) THEN 'Y' ELSE 'N' END) AS YN_FILE,
	   GL.AM_GIR_10000,
	   GD.DTS_PRINT,
	   GD.DT_IV,
	   GD.DTS_CUTOFF,
	   GD.CD_TAEGBAE,
	   PH.DC_FORWARD_OUT,
	   ('이윤 : ' + CONVERT(NVARCHAR, FORMAT(GL.AM_PROFIT, '#,##0')) + '원' + (CASE WHEN GL.QT_NOT_BILL > 0 THEN ' (포장비청구불가)' ELSE ' (포장비청구가능)' END)) AS DC_PACK_CHARGE,
	   (ISNULL(MP1.DC_ADDRESS, '') + ' ' + ISNULL(MP1.DC_ADDRESS1, '') + ' ' + ISNULL(MP1.NM_PIC, '') + ' ' + ISNULL(MP1.NO_TEL, '')) AS DC_DELIVERY_ADDR,
	   LEFT(GD.DTS_SUBMIT, 8) AS DT_SUBMIT,
	   GR.YN_REVIEW
FROM SA_GIRH GH
LEFT JOIN CZ_SA_GIRH_WORK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
LEFT JOIN CZ_SA_GIRH_REMARK GR ON GR.CD_COMPANY = GH.CD_COMPANY AND GR.NO_GIR = GH.NO_GIR
LEFT JOIN (SELECT GL.CD_COMPANY, GL.NO_GIR,
				  MAX(GL.NO_INV) AS NO_INV,
				  (CASE WHEN (ISNULL(SUM(FT.QT_TAX), 0) > 0 OR MAX(PL.YN_BL) = 'Y') THEN 'Y' ELSE 'N' END) AS YN_TAX,
				  COUNT(1) AS QT_ITEM,
				  MAX(IG.NM_ITEMGRP) AS NM_ITEMGRP,
				  MAX(GL.NO_SO) AS NO_SO,
				  MAX(SL.NO_PO_PARTNER) AS NO_PO_PARTNER,

				  MAX(QO.NO_IO) AS NO_IO,
	  			  MAX(QOH.DT_IO) AS DT_IO,
	  			  MAX(SO.NO_SALES) AS NO_SALES,
	  			  MAX(PT.DC_SIGN) AS DC_SIGN,
	  			  MAX(ME.NM_ENG) AS NM_ENG,
				  MAX(JT.YN_AM) AS YN_AM,

				  SUM(CASE WHEN (ISNULL(SL.QT_SO, 0) - ISNULL(SL.QT_GI, 0)) > ISNULL(GL.QT_GIR, 0) THEN 1 ELSE 0 END) AS QT_PARTIAL,
				  SUM(CASE WHEN (SL.NO_SO LIKE 'CL%' OR SL.NO_SO LIKE 'CN%') THEN 1 ELSE 0 END) AS QT_CLAIM,
				  ROUND(SUM(GL.AM_GIRAMT) / 10000, 0, 1) AS AM_GIR_10000,
				  SUM(CASE WHEN MC.CD_FLAG1 = 'N' THEN 1 ELSE 0 END) AS QT_NOT_BILL,
				  SUM((CASE WHEN TP.RET = 'Y' THEN -ISNULL(SL.AM_WONAMT, 0) ELSE ISNULL(SL.AM_WONAMT, 0) END) - (ISNULL(PL.AM_PO, 0) + ISNULL(SB.UM_KR * SB.QT_STOCK, 0))) AS AM_PROFIT
		   FROM SA_GIRL GL
		   LEFT JOIN MM_QTIO QO ON QO.CD_COMPANY = GL.CD_COMPANY AND QO.NO_ISURCV = GL.NO_GIR AND QO.NO_ISURCVLINE = GL.SEQ_GIR
	  	   LEFT JOIN MM_QTIOH QOH ON QOH.CD_COMPANY = QO.CD_COMPANY AND QOH.NO_IO = QO.NO_IO
		   LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = GL.CD_COMPANY AND SL.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT) AND SL.SEQ_SO = (CASE WHEN GL.SEQ_SO = 0 THEN GL.NO_SOLINE_MGMT ELSE GL.SEQ_SO END)
		   LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
		   LEFT JOIN MA_ITEMGRP IG ON IG.CD_COMPANY = QL.CD_COMPANY AND IG.CD_ITEMGRP = QL.GRP_ITEM
		   LEFT JOIN (SELECT CD_COMPANY, NO_SO, NO_SOLINE, 
							 ISNULL(SUM(QT_TAX), 0) AS QT_TAX 
	  	    		  FROM CZ_FI_IMP_PMTL
	  	    		  GROUP BY CD_COMPANY, NO_SO, NO_SOLINE) FT
	  	   ON FT.CD_COMPANY = SL.CD_COMPANY AND FT.NO_SO = SL.NO_SO AND FT.NO_SOLINE = SL.SEQ_SO
	  	   LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = GL.CD_COMPANY AND SG.CD_SALEGRP = GL.CD_SALEGRP
	  	   LEFT JOIN MA_SALEORG SO ON SO.CD_COMPANY = SG.CD_COMPANY AND SO.CD_SALEORG = SG.CD_SALEORG
	  	   LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SO.CD_COMPANY AND ME.NO_EMP = SO.NO_SALES
	  	   LEFT JOIN HR_PHOTO PT ON PT.CD_COMPANY = ME.CD_COMPANY AND PT.NO_EMP = ME.NO_EMP
		   LEFT JOIN MM_EJTP JT ON JT.CD_COMPANY = GL.CD_COMPANY AND JT.CD_QTIOTP = GL.TP_GI
		   LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = SL.CD_COMPANY AND SH.NO_SO = SL.NO_SO
		   LEFT JOIN SA_TPSO TP ON TP.CD_COMPANY = SH.CD_COMPANY AND TP.TP_SO = SH.TP_SO
		   LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = SH.CD_COMPANY AND MC.CD_FIELD = 'TR_IM00011' AND MC.CD_SYSDEF = SH.TP_PACKING
		   LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO 
		   LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE,
						     MAX(PL.YN_BL) AS YN_BL,
							 SUM(PL.AM) AS AM_PO
					  FROM PU_POL PL
					  WHERE PL.CD_ITEM NOT LIKE 'SD%'
					  GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE) PL
		   ON PL.CD_COMPANY = SL.CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.NO_SOLINE = SL.SEQ_SO
		   GROUP BY GL.CD_COMPANY, GL.NO_GIR) GL
ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
LEFT JOIN MA_COMPANY MC ON MC.CD_COMPANY = GH.CD_COMPANY
LEFT JOIN (SELECT PH.CD_COMPANY, PH.NO_GIR, 
				  COUNT(PH.NO_PACK) AS QT_BOX,
				  MAX(PH.DC_RMK) AS DC_RMK,
				  MAX(FO.DT_FORWARD) AS DT_FORWARD,
				  CONVERT(NVARCHAR, SUM(CASE WHEN FO.NO_GIR IS NULL THEN 0 ELSE 1 END)) + '/' + 
				  CONVERT(NVARCHAR, COUNT(1)) + 
				  (CASE WHEN MAX(FO.DT_FORWARD) IS NULL THEN '' 
														ELSE ' (' + MAX(CONVERT(CHAR(19), CONVERT(DATETIME, SUBSTRING(FO.DTS_INSERT, 1, 4) + '-' + SUBSTRING(FO.DTS_INSERT, 5, 2) + '-' + SUBSTRING(FO.DTS_INSERT, 7, 2) + ' ' + 
																											SUBSTRING(FO.DTS_INSERT, 9, 2) + ':' + SUBSTRING(FO.DTS_INSERT, 11, 2) + ':' + SUBSTRING(FO.DTS_INSERT, 13, 2)), 20) + ' / ' + MU.NM_USER) + ')' END) AS DC_FORWARD_OUT
		   FROM CZ_SA_PACKH PH
		   LEFT JOIN CZ_SA_FORWARD_OUT FO ON FO.CD_COMPANY = PH.CD_COMPANY AND FO.NO_GIR = PH.NO_GIR AND FO.NO_PACK = PH.NO_PACK
		   LEFT JOIN MA_USER MU ON MU.CD_COMPANY = FO.CD_COMPANY AND MU.ID_USER = FO.ID_INSERT
		   GROUP BY PH.CD_COMPANY, PH.NO_GIR) PH
ON PH.CD_COMPANY = GH.CD_COMPANY AND PH.NO_GIR = GH.NO_GIR
LEFT JOIN CZ_TR_INVH IH ON IH.CD_COMPANY = GH.CD_COMPANY AND IH.NO_INV = GL.NO_INV
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = IH.CD_COMPANY AND MP.CD_PARTNER = IH.CD_PARTNER
LEFT JOIN CZ_MA_DELIVERY MP1 ON MP1.CD_COMPANY = GH.CD_COMPANY AND MP1.CD_PARTNER = GD.CD_DELIVERY_TO
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = GD.NO_IMO
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = GL.CD_COMPANY AND SH.NO_SO = GL.NO_SO
LEFT JOIN CZ_MA_WORKFLOWH WH ON WH.CD_COMPANY = SH.CD_COMPANY AND WH.TP_STEP = '08' AND WH.NO_KEY = SH.NO_SO 
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = GH.CD_COMPANY AND ME.NO_EMP = MP.CD_EMP_SALE
LEFT JOIN MA_EMP ME1 ON ME1.CD_COMPANY = GH.CD_COMPANY AND ME1.NO_EMP = GH.NO_EMP
LEFT JOIN MA_EMP ME2 ON ME2.CD_COMPANY = WH.CD_COMPANY AND ME2.NO_EMP = WH.ID_LOG
LEFT JOIN MA_EMP ME3 ON ME3.CD_COMPANY = SH.CD_COMPANY AND ME3.NO_EMP = SH.NO_EMP
LEFT JOIN MA_PLANT PT ON PT.CD_COMPANY = GH.CD_COMPANY AND PT.CD_PLANT = GH.CD_PLANT
LEFT JOIN FI_GWDOCU GW ON GW.CD_COMPANY = 'K100' AND GW.CD_PC = '010000' AND GW.NO_DOCU = GL.CD_COMPANY + '-' + GL.NO_IO + '-D'
LEFT JOIN MA_CODEDTL MD ON MD.CD_COMPANY = GH.CD_COMPANY AND MD.CD_FIELD = 'PU_C000027' AND MD.CD_SYSDEF = GH.YN_RETURN
LEFT JOIN MA_CODEDTL MD1 ON MD1.CD_COMPANY = GH.CD_COMPANY AND MD1.CD_FIELD = 'MA_B000065' AND MD1.CD_SYSDEF = MP.CD_PARTNER_GRP
LEFT JOIN MA_CODEDTL MD2 ON MD2.CD_COMPANY = GH.CD_COMPANY AND MD2.CD_FIELD = 'CZ_SA00021' AND MD2.CD_SYSDEF = '001'
LEFT JOIN MA_CODEDTL MD3 ON MD3.CD_COMPANY = GH.CD_COMPANY AND MD3.CD_FIELD = 'CZ_SA00006' AND MD3.CD_SYSDEF = GD.CD_MAIN_CATEGORY
LEFT JOIN MA_CODEDTL MD4 ON MD4.CD_COMPANY = GH.CD_COMPANY AND MD4.CD_FIELD = MD3.CD_FLAG1 AND MD4.CD_SYSDEF = GD.CD_SUB_CATEGORY
LEFT JOIN MA_CODEDTL MD5 ON MD5.CD_COMPANY = GH.CD_COMPANY AND MD5.CD_FIELD = 'MA_B000020' AND MD5.CD_SYSDEF = IH.ARRIVER_COUNTRY
LEFT JOIN MA_CODEDTL MD6 ON MD6.CD_COMPANY = GH.CD_COMPANY AND MD6.CD_FIELD = 'CZ_SA00032' AND MD6.CD_SYSDEF = GD.CD_RMK

LEFT JOIN MA_CODEDTL MD7 ON MD7.CD_COMPANY = GH.CD_COMPANY AND MD7.CD_FIELD = 'PU_C000016' AND MD7.CD_SYSDEF = GH.TP_BUSI
LEFT JOIN MA_CODEDTL MD8 ON MD8.CD_COMPANY = GH.CD_COMPANY AND MD8.CD_FIELD = 'CZ_SA00030' AND MD8.CD_SYSDEF = GH.STA_GIR
LEFT JOIN MA_CODEDTL MD9 ON MD9.CD_COMPANY = GH.CD_COMPANY AND MD9.CD_FIELD = 'CZ_SA00018' AND MD9.CD_SYSDEF = IH.CD_PRODUCT
LEFT JOIN MA_CODEDTL MD10 ON MD10.CD_COMPANY = GH.CD_COMPANY AND MD10.CD_FIELD = 'MA_B000020' AND MD10.CD_SYSDEF = IH.CD_ORIGIN
LEFT JOIN MA_CODEDTL MD11 ON MD11.CD_COMPANY = GH.CD_COMPANY AND MD11.CD_FIELD = 'TR_IM00003' AND MD11.CD_SYSDEF = IH.TP_TRANS
LEFT JOIN MA_CODEDTL MD12 ON MD12.CD_COMPANY = GH.CD_COMPANY AND MD12.CD_FIELD = 'CZ_SA00013' AND MD12.CD_SYSDEF = IH.COND_PAY
LEFT JOIN MA_CODEDTL MD13 ON MD13.CD_COMPANY = GW.CD_COMPANY AND MD13.CD_FIELD = 'PU_C000065' AND MD13.CD_SYSDEF = GW.ST_STAT
LEFT JOIN CZ_MA_CODEDTL MD14 ON MD14.CD_COMPANY = IH.CD_COMPANY AND MD14.CD_FIELD = 'CZ_MA00004' AND MD14.CD_SYSDEF = IH.NO_TO
LEFT JOIN MA_CODEDTL MD15 ON MD15.CD_COMPANY = GH.CD_COMPANY AND MD15.CD_FIELD = 'CZ_SA00005' AND MD15.CD_SYSDEF = IH.TP_TRANSPORT
WHERE EXISTS (SELECT 1 
			  FROM @SA_GIRL
			  WHERE CD_COMPANY = GH.CD_COMPANY
			  AND NO_GIR = GH.NO_GIR)
AND (@P_YN_REVIEW = 'N' OR ISNULL(GR.YN_REVIEW, 'N') = @P_YN_REVIEW)
AND (@P_YN_NOT_OUT = 'N' OR ISNULL(PH.DT_FORWARD, '') = '')

GO