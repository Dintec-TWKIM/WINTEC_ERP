USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIRSCH_L_D]    Script Date: 2015-10-20 오후 3:40:42 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIRSCH_L_D]  
(  
    @P_CD_COMPANY   NVARCHAR(7),        --회사
    @P_NO_GIR       NVARCHAR(20),       --의뢰번호
	@P_SEQ_GIR		NUMERIC(5, 0)
)
AS

DECLARE @V_ERRMSG		NVARCHAR(255)

BEGIN TRAN SP_CZ_SA_GIRSCH_L_D
BEGIN TRY

DECLARE @V_NO_TEMP	NVARCHAR(20)
DECLARE @V_CD_TPPO	NVARCHAR(7)
DECLARE @V_MAX_IDX	INT
DECLARE @V_NO_RCV	NVARCHAR(20)
DECLARE @V_NO_IO	NVARCHAR(20)
DECLARE @V_YYYYMM	NVARCHAR(6)
DECLARE @V_NO_PO	NVARCHAR(20)
DECLARE @V_NO_LINE	NUMERIC(5, 0)

SET @V_YYYYMM = SUBSTRING(CONVERT(CHAR(8), GETDATE(), 112), 1, 6)

CREATE TABLE #SA_SOL
(
	CD_COMPANY		NVARCHAR(7),
	NO_SO			NVARCHAR(20),
	SEQ_SO		    NUMERIC(5, 0)
)

CREATE NONCLUSTERED INDEX SA_SOL ON #SA_SOL (CD_COMPANY, NO_SO, SEQ_SO)

-- 데이터 백업

INSERT INTO #SA_SOL
SELECT GL.CD_COMPANY,
       GL.NO_SO,
       GL.SEQ_SO
FROM SA_GIRL GL
WHERE GL.CD_COMPANY = @P_CD_COMPANY
AND GL.NO_GIR = @P_NO_GIR
AND GL.SEQ_GIR = @P_SEQ_GIR

SELECT * INTO #PU_POL
FROM PU_POL PL
WHERE EXISTS (SELECT 1 
			  FROM #SA_SOL SL
			  WHERE SL.CD_COMPANY = PL.CD_COMPANY
			  AND SL.NO_SO = PL.NO_SO
			  AND SL.SEQ_SO = PL.NO_SOLINE)

SELECT * INTO #PU_POH
FROM PU_POH PH
WHERE EXISTS (SELECT 1 
              FROM #PU_POL PL
              WHERE PL.CD_COMPANY = PH.CD_COMPANY
              AND PL.NO_PO = PH.NO_PO)

SELECT PT.CD_COMPANY,
       PT.CD_TPPO,
       PT1.CD_TPPO AS CD_TPPO1,
       EP.CD_QTIOTP,
       EP.YN_AM INTO #PU_TPPO
FROM PU_TPPO PT
JOIN PU_TPPO PT1 ON PT1.CD_COMPANY = PT.CD_COMPANY AND PT1.NM_TPPO = PT.NM_TPPO + '(무상)'
JOIN MM_EJTP EP ON EP.CD_COMPANY = PT1.CD_COMPANY AND EP.CD_QTIOTP = PT1.FG_TPRCV
WHERE PT.CD_COMPANY = @P_CD_COMPANY

PRINT('수주확정')
UPDATE SL
SET SL.STA_SO = 'R'
FROM SA_SOL SL
WHERE EXISTS (SELECT 1 
              FROM #SA_SOL SL1
              WHERE SL1.CD_COMPANY = SL.CD_COMPANY 
              AND SL1.NO_SO = SL.NO_SO 
              AND SL1.SEQ_SO = SL.SEQ_SO)

PRINT('재고예약해제')
UPDATE SB
SET SB.QT_BOOK = (CASE WHEN ISNULL(SB.QT_BOOK, 0) - ISNULL(GL.QT_GIR_STOCK, 0) > 0 THEN ISNULL(SB.QT_BOOK, 0) - ISNULL(GL.QT_GIR_STOCK, 0) ELSE 0 END)
FROM CZ_SA_STOCK_BOOK SB
JOIN SA_GIRL GL ON GL.CD_COMPANY = SB.CD_COMPANY AND GL.NO_SO = SB.NO_FILE AND GL.SEQ_SO = SB.NO_LINE
WHERE SB.CD_COMPANY = @P_CD_COMPANY
AND GL.NO_GIR = @P_NO_GIR
AND GL.SEQ_GIR = @P_SEQ_GIR

PRINT('창고이동 삭제 시작')

SELECT @V_NO_TEMP = MAX(OL.NO_IO) 
FROM MM_QTIO OL
WHERE OL.CD_COMPANY = @P_CD_COMPANY
AND EXISTS (SELECT 1 
			FROM MM_GIREQL QL
			WHERE QL.CD_COMPANY = OL.CD_COMPANY
			AND QL.NO_GIREQ = OL.NO_ISURCV
			AND QL.NO_LINE = OL.NO_ISURCVLINE
			AND QL.NO_PO = @P_NO_GIR
			AND QL.NO_PO_LINE = @P_SEQ_GIR
			AND QL.CD_SL = 'SL03'
			AND QL.CD_GRSL = 'SL01')

DELETE OL 
FROM MM_QTIO OL
WHERE OL.CD_COMPANY = @P_CD_COMPANY
AND OL.NO_IO = @V_NO_TEMP
AND EXISTS (SELECT 1 
			FROM MM_GIREQL QL
			WHERE QL.CD_COMPANY = OL.CD_COMPANY
			AND QL.NO_GIREQ = OL.NO_ISURCV
			AND QL.NO_LINE = OL.NO_ISURCVLINE
			AND QL.NO_PO = @P_NO_GIR
			AND QL.NO_PO_LINE = @P_SEQ_GIR
			AND QL.CD_SL = 'SL03'
			AND QL.CD_GRSL = 'SL01')

DELETE OH
FROM MM_QTIOH OH
WHERE OH.CD_COMPANY = @P_CD_COMPANY
AND OH.NO_IO = @V_NO_TEMP
AND NOT EXISTS (SELECT 1 
			    FROM MM_QTIO OL
				WHERE OL.CD_COMPANY = OH.CD_COMPANY
				AND OL.NO_IO = OH.NO_IO)

SELECT @V_NO_TEMP = MAX(QL.NO_GIREQ) 
FROM MM_GIREQL QL
WHERE QL.CD_COMPANY = @P_CD_COMPANY
AND QL.NO_PO = @P_NO_GIR
AND QL.NO_PO_LINE = @P_SEQ_GIR
AND QL.CD_SL = 'SL03'
AND QL.CD_GRSL = 'SL01'

DELETE QL
FROM MM_GIREQL QL
WHERE QL.CD_COMPANY = @P_CD_COMPANY
AND QL.NO_PO = @P_NO_GIR
AND QL.NO_PO_LINE = @P_SEQ_GIR
AND QL.CD_SL = 'SL03'
AND QL.CD_GRSL = 'SL01'

DELETE QH
FROM MM_GIREQH QH
WHERE QH.CD_COMPANY = @P_CD_COMPANY
AND QH.NO_GIREQ = @V_NO_TEMP
AND NOT EXISTS (SELECT 1 
			    FROM MM_GIREQL QL
				WHERE QL.CD_COMPANY = QH.CD_COMPANY
				AND QL.NO_GIREQ = QH.NO_GIREQ)

PRINT('창고이동 삭제 끝')

SELECT @V_NO_TEMP = MAX(OL.NO_IO)
FROM MM_QTIO OL
WHERE OL.CD_COMPANY = @P_CD_COMPANY
AND OL.NO_ISURCV = @P_NO_GIR
AND OL.NO_ISURCVLINE = @P_SEQ_GIR

PRINT('출고라인 삭제')
DELETE OL
FROM MM_QTIO OL
WHERE OL.CD_COMPANY = @P_CD_COMPANY
AND OL.NO_ISURCV = @P_NO_GIR
AND OL.NO_ISURCVLINE = @P_SEQ_GIR

PRINT('출고헤더 삭제')
DELETE OH
FROM MM_QTIOH OH
WHERE OH.CD_COMPANY = @P_CD_COMPANY
AND OH.NO_IO = @V_NO_TEMP
AND NOT EXISTS (SELECT 1 
			    FROM MM_QTIO OL
				WHERE OL.CD_COMPANY = OH.CD_COMPANY
				AND OL.NO_IO = OH.NO_IO)

PRINT('송장라인 삭제')
DELETE TL
FROM CZ_TR_INVL TL
JOIN SA_GIRL GL ON GL.CD_COMPANY = TL.CD_COMPANY AND GL.NO_INV = TL.NO_INV AND GL.SEQ_GIR = TL.NO_LINE
WHERE GL.CD_COMPANY = @P_CD_COMPANY
AND GL.NO_GIR = @P_NO_GIR
AND GL.SEQ_GIR = @P_SEQ_GIR

PRINT('포장라인 삭제')
DELETE PL
FROM CZ_SA_PACKL PL
WHERE PL.CD_COMPANY = @P_CD_COMPANY
AND PL.NO_GIR = @P_NO_GIR
AND PL.SEQ_GIR = @P_SEQ_GIR

PRINT('포장헤더 삭제')
DELETE PH
FROM CZ_SA_PACKH PH
WHERE PH.CD_COMPANY = @P_CD_COMPANY
AND PH.NO_GIR = @P_NO_GIR
AND NOT EXISTS (SELECT 1 
			    FROM CZ_SA_PACKL PL
				WHERE PL.CD_COMPANY = PH.CD_COMPANY
				AND PL.NO_GIR = PH.NO_GIR
				AND PL.NO_PACK = PH.NO_PACK)

PRINT('협조전라인 삭제')
DELETE GL
FROM SA_GIRL GL
WHERE GL.CD_COMPANY = @P_CD_COMPANY
AND GL.NO_GIR = @P_NO_GIR
AND GL.SEQ_GIR = @P_SEQ_GIR



--SELECT @V_NO_TEMP = MAX(IL.NO_IO) 
--FROM MM_QTIO IL
--WHERE IL.CD_COMPANY = @P_CD_COMPANY
--AND EXISTS (SELECT 1 
--			FROM #PU_POL PL
--			WHERE PL.CD_COMPANY = IL.CD_COMPANY
--			AND PL.NO_PO = IL.NO_PSO_MGMT
--			AND PL.NO_LINE = IL.NO_PSOLINE_MGMT)

--PRINT('입고라인 삭제')
--DELETE IL
--FROM MM_QTIO IL
--WHERE IL.CD_COMPANY = @P_CD_COMPANY
--AND EXISTS (SELECT 1 
--			FROM #PU_POL PL
--			WHERE PL.CD_COMPANY = IL.CD_COMPANY
--			AND PL.NO_PO = IL.NO_PSO_MGMT
--			AND PL.NO_LINE = IL.NO_PSOLINE_MGMT)

--PRINT('입고헤더 삭제')
--DELETE IH
--FROM MM_QTIOH IH
--WHERE IH.CD_COMPANY = @P_CD_COMPANY
--AND IH.NO_IO = @V_NO_TEMP
--AND NOT EXISTS (SELECT 1 
--			    FROM MM_QTIO IL
--				WHERE IL.CD_COMPANY = IH.CD_COMPANY
--				AND IL.NO_IO = IH.NO_IO)

--SELECT @V_NO_TEMP = MAX(RL.NO_RCV) 
--FROM PU_RCVL RL
--WHERE RL.CD_COMPANY = @P_CD_COMPANY
--AND EXISTS (SELECT 1 
--			FROM #PU_POL PL
--			WHERE PL.CD_COMPANY = RL.CD_COMPANY
--			AND PL.NO_PO = RL.NO_PO
--			AND PL.NO_LINE = RL.NO_POLINE)

--PRINT('입고의뢰라인 삭제')
--DELETE RL
--FROM PU_RCVL RL
--WHERE RL.CD_COMPANY = @P_CD_COMPANY
--AND EXISTS (SELECT 1 
--			FROM #PU_POL PL
--			WHERE PL.CD_COMPANY = RL.CD_COMPANY
--			AND PL.NO_PO = RL.NO_PO
--			AND PL.NO_LINE = RL.NO_POLINE)

--PRINT('입고의뢰헤더 삭제')
--DELETE RH
--FROM PU_RCVH RH
--WHERE RH.CD_COMPANY = @P_CD_COMPANY
--AND RH.NO_RCV = @V_NO_TEMP
--AND NOT EXISTS (SELECT 1 
--			    FROM PU_RCVL RL
--				WHERE RL.CD_COMPANY = RH.CD_COMPANY
--				AND RL.NO_RCV = RH.NO_RCV)

--PRINT('발주이동 시작')
--DELETE FROM #PU_POL

--INSERT INTO #PU_POL
--SELECT *
--FROM PU_POL PL
--WHERE EXISTS (SELECT 1 
--			  FROM #SA_SOL SL
--			  WHERE SL.CD_COMPANY = PL.CD_COMPANY
--			  AND SL.NO_SO = PL.NO_SO
--			  AND SL.SEQ_SO = PL.NO_SOLINE)

--DELETE PL
--FROM PU_POL PL
--WHERE EXISTS (SELECT 1 
--			  FROM #SA_SOL SL
--			  WHERE SL.CD_COMPANY = PL.CD_COMPANY
--			  AND SL.NO_SO = PL.NO_SO
--			  AND SL.SEQ_SO = PL.NO_SOLINE)

--SELECT @V_MAX_IDX = CONVERT(INT, RIGHT(MAX(PH.NO_PO), 2))
--FROM PU_POH PH
--WHERE EXISTS (SELECT 1 
--			  FROM #SA_SOL SL
--			  WHERE SL.CD_COMPANY = PH.CD_COMPANY
--			  AND SL.NO_SO = PH.CD_PJT)

--;WITH A AS
--(
--	SELECT PH.CD_COMPANY,
--		   PH.NO_PO,
--		   PH.CD_PJT + '-' + FORMAT(ROW_NUMBER() OVER (PARTITION BY PH.CD_COMPANY ORDER BY PH.NO_PO) + @V_MAX_IDX, '0#') AS CD_USERDEF1
--    FROM #PU_POH PH
--    WHERE ISNULL(PH.CD_USERDEF1, '') = '' 
--)
--UPDATE PH
--SET PH.CD_USERDEF1 = PH1.CD_USERDEF1 
--FROM #PU_POH PH
--JOIN A PH1 ON PH1.CD_COMPANY = PH.CD_COMPANY AND PH1.NO_PO = PH.NO_PO

--UPDATE PH
--SET PH.CD_USERDEF1 = PH1.CD_USERDEF1
--FROM PU_POH PH
--JOIN #PU_POH PH1 ON PH1.CD_COMPANY = PH.CD_COMPANY AND PH1.NO_PO = PH.NO_PO
--WHERE ISNULL(PH.CD_USERDEF1, '') = ''

--UPDATE PL
--SET PL.NO_PO = PH.CD_USERDEF1,
--	PL.FG_RCV = TP.CD_QTIOTP
--FROM #PU_POH PH
--JOIN #PU_POL PL ON PL.CD_COMPANY = PH.CD_COMPANY AND PL.NO_PO = PH.NO_PO
--LEFT JOIN #PU_TPPO TP ON TP.CD_COMPANY = PH.CD_COMPANY AND TP.CD_TPPO = PH.CD_TPPO

--UPDATE PH
--SET PH.NO_PO = PH.CD_USERDEF1,
--	PH.CD_TPPO = TP.CD_TPPO1,
--	PH.YN_AM = TP.YN_AM
--FROM #PU_POH PH
--LEFT JOIN #PU_TPPO TP ON TP.CD_COMPANY = PH.CD_COMPANY AND TP.CD_TPPO = PH.CD_TPPO

--INSERT INTO PU_POH
--SELECT * 
--FROM #PU_POH PH
--WHERE NOT EXISTS (SELECT 1 
--				  FROM PU_POH PH1
--				  WHERE PH1.CD_COMPANY = PH.CD_COMPANY
--				  AND PH1.NO_PO = PH.NO_PO)

--INSERT INTO PU_POL
--SELECT * FROM #PU_POL PL

--PRINT('발주이동 종료')

--PRINT('입고의뢰등록 & 입고등록')
--DECLARE SRC_CURSOR CURSOR FOR
--SELECT PL.NO_PO, PL.NO_LINE
--FROM #PU_POL PL

--OPEN SRC_CURSOR
--FETCH NEXT FROM SRC_CURSOR INTO @V_NO_PO, @V_NO_LINE

--	WHILE @@FETCH_STATUS = 0
--	BEGIN
--		IF NOT EXISTS (SELECT 1 
--					   FROM PU_RCVL RL
--					   WHERE RL.CD_COMPANY = @P_CD_COMPANY
--					   AND RL.NO_PO = @V_NO_PO)
--		BEGIN
--			EXEC CP_GETNO @P_CD_COMPANY, 'PU', '04', @V_YYYYMM, @V_NO_RCV OUTPUT
--		END
--		ELSE
--		BEGIN
--			SET @V_NO_RCV = (SELECT TOP 1 RL.NO_RCV
--							 FROM PU_RCVL RL
--							 WHERE RL.CD_COMPANY = @P_CD_COMPANY
--							 AND RL.NO_PO = @V_NO_PO)
--		END

--		IF NOT EXISTS (SELECT 1 
--					   FROM PU_RCVH RH
--					   WHERE RH.CD_COMPANY = @P_CD_COMPANY
--					   AND RH.NO_RCV = @V_NO_RCV)
--		BEGIN
--			INSERT INTO PU_RCVH
--			( 
--				CD_COMPANY, 
--				NO_RCV, 
--				CD_PLANT, 
--				CD_PARTNER, 
--				DT_REQ, 
--				NO_EMP, 
--				FG_TRANS, 
--				FG_PROCESS, 
--				CD_EXCH, 
--				CD_SL, 
--				YN_RETURN, 
--				YN_AM, 
--				FG_RCV, 
--				CD_DEPT, 
--				FG_UM, 
--				DC_RMK, 
--				ID_INSERT, 
--				DTS_INSERT
--			)
--			SELECT PH.CD_COMPANY,
--				   @V_NO_RCV,
--				   PH.CD_PLANT,
--				   PH.CD_PARTNER,
--				   CONVERT(CHAR(8), GETDATE(), 112)	AS DT_REQ,
--				   PH.NO_EMP,
--				   PH.FG_TRANS,
--				   '001' AS FG_PROCESS,
--				   PH.CD_EXCH,
--				   'SL01' AS CD_SL,
--				   'N' AS YN_RETURN,
--				   PH.YN_AM AS YN_AM,
--				   TP.FG_TPRCV	AS FG_RCV,
--				   ME.CD_DEPT,
--				   '' AS FG_UM,
--				   '선용품 무상 반품 자동 입고' AS DC_RMK,
--				   PH.NO_EMP AS ID_INSERT,
--				   NEOE.SF_SYSDATE(GETDATE()) AS DTS_INSERT
--			FROM #PU_POH PH
--			JOIN PU_TPPO TP ON TP.CD_COMPANY = PH.CD_COMPANY AND TP.CD_TPPO = PH.CD_TPPO
--			JOIN MA_EMP ME ON ME.CD_COMPANY = PH.CD_COMPANY AND ME.NO_EMP = PH.NO_EMP
--			WHERE PH.CD_COMPANY = @P_CD_COMPANY
--			AND PH.NO_PO = @V_NO_PO
--		END

--		INSERT INTO PU_RCVL
--		( 
--			CD_COMPANY, 
--			NO_RCV, 
--			NO_LINE, 
--			NO_PO, 
--			NO_POLINE, 
--			CD_PURGRP, 
--			DT_LIMIT, 
--			DT_GRLAST, 
--			CD_ITEM, 
--			QT_REQ, 
--			YN_INSP, 
--			QT_PASS, 
--			QT_REJECTION, 
--			CD_UNIT_MM, 
--			QT_REQ_MM, 
--			CD_EXCH, 
--			RT_EXCH, 
--			UM_EX_PO,	
--			UM_EX,				
--			AM_EX,				
--			UM,				
--			AM,				
--			VAT,				
--			RT_CUSTOMS,		
--			CD_PJT,			
--			YN_PURCHASE,		
--			YN_RETURN,
--			FG_TPPURCHASE,
--			FG_RCV,
--			FG_TRANS,			
--			FG_TAX,			
--			FG_TAXP,			
--			YN_AUTORCV,		
--			YN_REQ,
--			CD_SL,
--			NO_LC,
--			NO_LCLINE,
--			RT_SPEC,
--			NO_EMP,
--			NO_TO,
--			NO_TO_LINE,
--			FG_POST,
--			YN_AUTOSTOCK,
--			NO_REV,
--			NO_REVLINE,
--			CD_WH,
--			TP_UM_TAX,
--			ID_INSERT,
--			DTS_INSERT
--		)
--		SELECT PL.CD_COMPANY,
--			   @V_NO_RCV,
--			   (SELECT ISNULL(MAX(RL.NO_LINE), 0) 
--				FROM PU_RCVL RL
--				WHERE RL.CD_COMPANY = @P_CD_COMPANY
--				AND RL.NO_RCV = @V_NO_RCV) + 1 AS NO_LINE,
--			   PL.NO_PO,
--			   PL.NO_LINE AS NO_POLINE,
--			   PH.CD_PURGRP,
--			   PL.DT_LIMIT,
--			   PL.DT_LIMIT AS DT_GRLAST,
--			   PL.CD_ITEM,
--			   PL.QT_PO AS QT_REQ,
--			   'N' AS YN_INSP,
--			   PL.QT_PO AS QT_PASS,
--			   0 AS QT_REJECTION,
--			   PL.CD_UNIT_MM,
--			   PL.QT_PO AS QT_REQ_MM,
--			   PH.CD_EXCH,
--			   PH.RT_EXCH,
--			   PL.UM_EX_PO,
--			   PL.UM_EX,
--			   (PL.UM_EX * PL.QT_PO) AS AM_EX,
--			   PL.UM,
--			   (PL.UM * PL.QT_PO) AS AM,
--			   (PL.UM * PL.QT_PO) * (CONVERT(NUMERIC(17, 4), CASE WHEN ISNULL(MC.CD_FLAG1,'') = '' THEN '0' ELSE MC.CD_FLAG1 END) / 100) AS VAT,
--			   0 AS RT_CUSTOMS,
--			   PL.CD_PJT,
--			   'Y' AS YN_PURCHASE,
--			   'N' AS YN_RETURN,
--			   PL.FG_PURCHASE AS FG_TPPURCHASE,
--			   PL.FG_RCV AS FG_RCV,
--			   PL.FG_TRANS AS FG_TRANS,
--			   PL.FG_TAX AS FG_TAX,
--			   PH.FG_TAXP AS FG_TAXP,
--			   '' AS YN_AUTORCV,
--			   PL.YN_REQ,
--			   'SL01' AS CD_SL,
--			   '' AS NO_LC,
--			   0 AS NO_LCLINE,
--			   0 AS RT_SPEC,
--			   PH.NO_EMP,
--			   '' AS NO_TO,
--			   0 AS NO_TO_LINE,
--			   'O' AS FG_POST,
--			   'Y' AS YN_AUTOSTOCK,
--			   '' AS NO_REV,
--			   0 AS NO_REVLINE,
--			   '' AS CD_WH,
--			   PL.TP_UM_TAX,
--			   PH.NO_EMP AS ID_INSERT,
--			   NEOE.SF_SYSDATE(GETDATE()) AS DTS_INSERT
--		FROM #PU_POH PH
--		JOIN #PU_POL PL ON PL.CD_COMPANY = PH.CD_COMPANY AND PL.NO_PO = PH.NO_PO
--		LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = PH.CD_COMPANY AND MC.CD_FIELD = 'MA_B000046' AND MC.CD_SYSDEF = PH.FG_TAX
--		WHERE PH.CD_COMPANY = @P_CD_COMPANY
--		AND PL.NO_PO = @V_NO_PO
--		AND PL.NO_LINE = @V_NO_LINE

--		IF NOT EXISTS (SELECT 1 
--					   FROM MM_QTIO IL
--					   WHERE IL.CD_COMPANY = @P_CD_COMPANY
--					   AND IL.NO_PSO_MGMT = @V_NO_PO)
--		BEGIN
--			SET @V_NO_IO = @V_NO_RCV
--		END
--		ELSE
--		BEGIN
--			SET @V_NO_IO = (SELECT TOP 1 IL.NO_IO
--							FROM MM_QTIO IL
--							WHERE IL.CD_COMPANY = @P_CD_COMPANY
--							AND IL.NO_PSO_MGMT = @V_NO_PO)
--		END

--		IF NOT EXISTS (SELECT 1 
--					   FROM MM_QTIOH IH
--					   WHERE IH.CD_COMPANY = @P_CD_COMPANY
--					   AND IH.NO_IO = @V_NO_IO)
--		BEGIN
--			INSERT INTO MM_QTIOH
--			(
--				CD_COMPANY,
--				NO_IO,
--				CD_PLANT,
--				CD_PARTNER,
--				FG_TRANS,
--				YN_RETURN,	
--				DT_IO,
--				CD_DEPT,
--				NO_EMP,
--				CD_QTIOTP,
--				ID_INSERT,
--				DTS_INSERT
--			)
--			SELECT PH.CD_COMPANY,
--				   @V_NO_IO,
--				   PH.CD_PLANT,
--				   PH.CD_PARTNER,
--				   PH.FG_TRANS,
--				   'N' AS YN_RETURN,
--				   CONVERT(CHAR(8), GETDATE(), 112) AS DT_IO,
--				   ME.CD_DEPT,
--				   PH.NO_EMP,
--				   TP.FG_TPRCV AS CD_QTIOTP,
--				   PH.NO_EMP AS ID_INSERT,
--				   NEOE.SF_SYSDATE(GETDATE()) AS DTS_INSERT
--			FROM #PU_POH PH
--			JOIN PU_TPPO TP ON TP.CD_COMPANY = PH.CD_COMPANY AND TP.CD_TPPO = PH.CD_TPPO
--			LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = PH.CD_COMPANY AND ME.NO_EMP = PH.NO_EMP
--			WHERE PH.CD_COMPANY = @P_CD_COMPANY
--			AND PH.NO_PO = @V_NO_PO
--		END

--		INSERT INTO MM_QTIO
--		(
--			CD_COMPANY,
--			NO_IO,
--			NO_IOLINE,
--			CD_BIZAREA,
--			CD_PLANT,
--			CD_SL,
--			CD_SECTION,
--			CD_BIN,
--			DT_IO,
--			NO_ISURCV,
--			NO_ISURCVLINE,
--			NO_PSO_MGMT,
--			NO_PSOLINE_MGMT,
--			FG_PS,		
--			YN_PURSALE,	
--			FG_TPIO,		
--			FG_IO,		
--			CD_QTIOTP,
--			FG_TRANS,		
--			FG_TAX,		
--			CD_PARTNER,	
--			CD_ITEM,
--			QT_IO,
--			QT_GOOD_INV,
--			CD_EXCH,	
--			RT_EXCH,		
--			UM_EX,		
--			AM_EX,
--			UM,			
--			AM,			
--			VAT,			
--			FG_TAXP,		
--			UM_STOCK,
--			YN_AM,		
--			CD_PJT,
--			NO_LC,
--			NO_LCLINE,
--			GI_PARTNER,
--			NO_EMP,
--			CD_GROUP,
--			NO_IO_MGMT,
--			NO_IOLINE_MGMT,
--			CD_BIN_REF,
--			BILL_PARTNER,
--			CD_UNIT_MM,
--			QT_UNIT_MM,
--			UM_EX_PSO,
--			YN_INSPECT,
--			ID_INSERT,
--			DTS_INSERT
--		)
--		SELECT PH.CD_COMPANY,
--			   @V_NO_IO,
--			   RL.NO_LINE AS NO_IOLINE,
--			   BA.CD_BIZAREA,
--			   PL.CD_PLANT,
--			   'SL01' AS CD_SL,
--			   '' AS CD_SECTION,
--			   'N' AS CD_BIN,
--			   CONVERT(CHAR(8), GETDATE(), 112) AS DT_IO,
--			   RL.NO_RCV AS NO_ISURCV,
--			   RL.NO_LINE AS NO_ISURCVLINE,
--			   PL.NO_PO AS NO_PSO_MGMT,
--			   PL.NO_LINE AS NO_PSOLINE_MGMT,
--			   '1' AS FG_PS,
--			   EJ.YN_PURCHASE AS YN_PURSALE,
--			   PL.FG_PURCHASE AS FG_TPIO,
--			   EJ.FG_IO AS FG_IO,
--			   TP.FG_TPRCV AS CD_QTIOTP,
--			   PL.FG_TRANS AS FG_TRANS,
--			   PL.FG_TAX AS FG_TAX,
--			   PH.CD_PARTNER AS CD_PARTNER,
--			   PL.CD_ITEM AS CD_ITEM,
--			   PL.QT_PO AS QT_IO,
--			   PL.QT_PO AS QT_GOOD_INV,
--			   PH.CD_EXCH AS CD_EXCH,
--			   PH.RT_EXCH AS RT_EXCH,
--			   PL.UM_EX AS UM_EX,
--			   (PL.UM_EX * PL.QT_PO) AS AM_EX,
--			   PL.UM AS UM,
--			   PL.UM * PL.QT_PO AS AM,
--			   (PL.UM * PL.QT_PO) * (CONVERT(NUMERIC(17, 4), CASE WHEN ISNULL(MC.CD_FLAG1,'') = '' THEN '0' ELSE MC.CD_FLAG1 END) / 100) AS VAT,
--			   PH.FG_TAXP AS FG_TAXP,
--			   PL.UM AS UM_STOCK,
--			   TP.YN_AM AS YN_AM,
--			   PL.CD_PJT AS CD_PJT,
--			   '' AS NO_LC,
--			   0 AS NO_LCLINE,
--			   PH.CD_PARTNER AS GI_PARTNER,
--			   PH.NO_EMP,
--			   PH.CD_PURGRP AS CD_GROUP,
--			   NULL AS NO_IO_MGMT,
--			   NULL AS NO_IOLINE_MGMT,
--			   'N' AS CD_BIN_REF,
--			   PH.CD_PARTNER AS BILL_PARTNER,
--			   PL.CD_UNIT_MM AS CD_UNIT_MM,
--			   PL.QT_PO AS QT_UNIT_MM,
--			   PL.UM_EX AS UM_EX_PSO,
--			   'N' AS YN_INSPECT,
--			   PH.NO_EMP AS ID_INSERT,
--			   NEOE.SF_SYSDATE(GETDATE()) AS DTS_INSERT
--		 FROM #PU_POH PH
--		 JOIN #PU_POL PL ON PL.CD_COMPANY = PH.CD_COMPANY AND PL.NO_PO = PH.NO_PO
--		 JOIN (SELECT RL.CD_COMPANY, RL.NO_PO, RL.NO_POLINE,
--		              MAX(RL.NO_RCV) AS NO_RCV,
--		              MAX(RL.NO_LINE) AS NO_LINE
--		       FROM PU_RCVL RL
--		       WHERE RL.QT_REQ > RL.QT_GR
--		       GROUP BY RL.CD_COMPANY, RL.NO_PO, RL.NO_POLINE) RL
--		 ON RL.CD_COMPANY = PL.CD_COMPANY AND RL.NO_PO = PL.NO_PO AND RL.NO_POLINE = PL.NO_LINE
--		 JOIN PU_TPPO TP ON TP.CD_COMPANY = PH.CD_COMPANY AND TP.CD_TPPO = PH.CD_TPPO
--		 JOIN MM_EJTP EJ ON EJ.CD_COMPANY = TP.CD_COMPANY AND EJ.CD_QTIOTP = TP.FG_TPRCV
--		 LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = TP.CD_COMPANY AND MC.CD_FIELD = 'MA_B000046' AND MC.CD_SYSDEF = TP.FG_TAX
--		 LEFT JOIN MA_BIZAREA BA ON BA.CD_COMPANY = PH.CD_COMPANY

--	FETCH NEXT FROM SRC_CURSOR INTO @V_NO_PO, @V_NO_LINE
--	END

--CLOSE SRC_CURSOR
--DEALLOCATE SRC_CURSOR

DROP TABLE #SA_SOL
DROP TABLE #PU_POL
DROP TABLE #PU_POH
DROP TABLE #PU_TPPO

COMMIT TRAN SP_CZ_SA_GIRSCH_L_D

END TRY
BEGIN CATCH
	ROLLBACK TRAN SP_CZ_SA_GIRSCH_L_D
	SELECT @V_ERRMSG = ERROR_MESSAGE()
	GOTO ERROR
END CATCH

RETURN
ERROR: 
RAISERROR(@V_ERRMSG, 16, 1)
ROLLBACK TRAN SP_CZ_SA_GIRSCH_L_D

GO

