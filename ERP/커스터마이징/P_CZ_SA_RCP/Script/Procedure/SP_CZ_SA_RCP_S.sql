USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_BILL_S]    Script Date: 2015-12-24 오후 7:06:03 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_SA_RCP_S] 
( 
    @P_CD_COMPANY  NVARCHAR(7),
	@P_LANGUAGE	   NVARCHAR(5) = 'KR', 
    @P_NO_RCP      NVARCHAR(20) 
) 
AS 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

/*수금헤더*/ 
SELECT      A.NO_RCP,  
	        A.DT_RCP,  
	        A.CD_TP,  
	        A.TP_BUSI,  
	        A.CD_PARTNER,  
	        A.BILL_PARTNER,  
	        A.CD_SALEGRP,  
	        A.NO_EMP,  
	        A.NO_PROJECT,  
	        A.AM_RCP,  
	        A.AM_RCP_TX,  
	        A.AM_RCP_A,  
	        A.AM_RCPS,  
	        ( A.AM_RCP + A.AM_RCP_A ) AS AM_RCP_TOT,  
	        A.TP_AIS,  
	        A.DC_RMK,                                          
	        (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = @P_CD_COMPANY AND CD_PARTNER = A.CD_PARTNER)LN_CD_PARTNER, 
	        (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = @P_CD_COMPANY AND CD_PARTNER = A.BILL_PARTNER) LN_BILL_PARTNER,    
	        (SELECT NM_KOR FROM MA_EMP WHERE CD_COMPANY = @P_CD_COMPANY AND NO_EMP = A.NO_EMP)NM_KOR,  
	        (SELECT NM_SALEGRP FROM MA_SALEGRP WHERE CD_COMPANY = @P_CD_COMPANY AND CD_SALEGRP = A.CD_SALEGRP)NM_SALEGRP, 
	        (SELECT NM_TP FROM MA_AISPOSTH WHERE FG_TP = '300' AND CD_TP = A.CD_TP AND CD_COMPANY = A.CD_COMPANY) NM_CD_TP, 
	        (SELECT DISTINCT NM_PROJECT FROM SA_PROJECTH WHERE CD_COMPANY = @P_CD_COMPANY AND NO_PROJECT = A.NO_PROJECT) NM_PROJECT, 
	        A.CD_EXCH, 
	        A.RT_EXCH, 
	        A.AM_RCP_EX, 
	        A.AM_RCP_A_EX, 
	        ( A.AM_RCP_EX + A.AM_RCP_A_EX ) AS AM_RCP_EX_TOT,  
	        A.FG_MAP, 
	        A.AM_RCP_EX_TX, 
			A.CD_BIZAREA,   
			A.TP_BILLS,
			A.GI_PARTNER,  
			(SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = @P_CD_COMPANY AND CD_PARTNER = A.GI_PARTNER) LN_GI_PARTNER,
			FD.NO_DOCU,
			FD.CD_PC    
      FROM  SA_RCPH A
	  LEFT JOIN (SELECT CD_COMPANY, NO_MDOCU, NO_DOCU, CD_PC 
			     FROM FI_DOCU
			     GROUP BY CD_COMPANY, NO_MDOCU, NO_DOCU, CD_PC) FD
	  ON FD.CD_COMPANY = A.CD_COMPANY AND FD.NO_MDOCU = A.NO_RCP  
     WHERE  A.CD_COMPANY    = @P_CD_COMPANY 
       AND  A.NO_RCP        = @P_NO_RCP         
 
/*수금내역*/ 
 SELECT L.NO_RCP, 
        L.NO_LINE, 
		L.FG_RCP, 
		L.NO_MGMT, 
		L.FG_JATA,         
		L.AM_RCP, 
		L.AM_RCP_A, 
		L.CD_BANK, 
		L.NM_ISSUE, 
		L.DT_DUE, 
		L.DY_TURN, 
		ISNULL(H.TP_AIS, 'N') TP_AIS, 
		L.AM_RCP AM_RCP_ORG, 
		(SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = @P_CD_COMPANY AND CD_PARTNER = L.CD_BANK) NM_BANK, 
		L.AM_RCP_EX, 
		L.AM_RCP_A_EX, 
		L.DC_BANK, 
        H.RT_EXCH,
        L.NO_RELATION,
        L.SEQ_RELATION,
        L.TXT_USERDEF1, 
        L.TXT_USERDEF2,
        L.TXT_USERDEF3,
        L.TXT_USERDEF4,
        L.TXT_USERDEF5
  FROM  SA_RCPL L INNER JOIN SA_RCPH H 
    ON  L.CD_COMPANY = H.CD_COMPANY 
    AND L.NO_RCP = H.NO_RCP 
  WHERE L.CD_COMPANY = @P_CD_COMPANY 
    AND L.NO_RCP = @P_NO_RCP 
ORDER BY L.FG_RCP ASC 
 
/*수금반제AM_PL(환차손) 이(+)이면차손(-)이면차익이다. */ 
SELECT  B.NO_RCP, 
        B.NO_TX, 
        B.DT_IV, 
        B.TP_SO, 
		B.AM_IV_EX,
		(SELECT (CASE @P_LANGUAGE WHEN 'KR' THEN NM_SYSDEF
		 						  WHEN 'US' THEN NM_SYSDEF_E
		 						  WHEN 'JP' THEN NM_SYSDEF_JP
		 						  WHEN 'CH' THEN NM_SYSDEF_CH END)
		 FROM MA_CODEDTL
		 WHERE CD_COMPANY = IH.CD_COMPANY
		 AND CD_FIELD = 'MA_B000005'
		 AND CD_SYSDEF = IH.CD_EXCH) AS NM_EXCH,
		B.RT_EXCH_IV, 
        B.AM_IV, 
		B.AM_RCP_TX_EX, 
        B.AM_RCP_TX, 
		B.AM_PL, 
		CASE WHEN SIGN(B.AM_PL) = 1   THEN 0 - (B.AM_PL) ELSE 0 END AS AM_PL_LOSS, 
		CASE WHEN SIGN(B.AM_PL) = -1  THEN 0 - (B.AM_PL) ELSE 0 END AS AM_PL_PROFIT,
		B.CD_USERDEF1,
		B.NO_DOCU,
		B.NO_DOLINE
   FROM SA_RCPD B 
   LEFT JOIN SA_IVH IH ON IH.CD_COMPANY = B.CD_COMPANY AND IH.NO_IV = B.NO_TX
  WHERE B.CD_COMPANY = @P_CD_COMPANY 
    AND B.NO_RCP = @P_NO_RCP 
  ORDER BY B.DT_IV ASC
  
  
  --선수금이등록되어않을경우선수금잔액구하기(정상수금)
  --선수금등록이되어있으면0원  (테이블레코드카운트0)
    SELECT  SUM(A.AM_RCP_A) AS AM_RCP FROM SA_RCPL A 
    WHERE A.CD_COMPANY = @P_CD_COMPANY AND
		 A.NO_RCP=  @P_NO_RCP AND
		 NOT  EXISTS (  SELECT NO_RCP
				FROM SA_BILLSD D  WHERE D.CD_COMPANY = A.CD_COMPANY AND
				D.NO_RCP   = A.NO_RCP)

GO