USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[UP_HR_SLACCLIM_DOCU1]    Script Date: 2018-01-10 오후 4:08:03 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*******************************************
*********************************************/
ALTER PROCEDURE [NEOE].[UP_HR_SLACCLIM_DOCU1]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_YM				NVARCHAR(6),
	@P_TP_SUM			NVARCHAR(3),	
	@P_DT_DECI			NVARCHAR(8),	
	@P_전표분류단위		NVARCHAR(1),
	@P_CNT_DOCU			INT,
	@P_WRITE_DEPT		NVARCHAR(12),
	@P_WRITE_NO_EMP		NVARCHAR(10),
	@P_NM_COMPANY		NVARCHAR(50),
	@P_CD_BIZAREA		NVARCHAR(7),
	@P_NM_BIZAREA		NVARCHAR(50),
	@P_CD_PC			NVARCHAR(7),
	@P_NM_PC			NVARCHAR(50),
	@P_CD_DEPT			NVARCHAR(12),
	@P_NM_DEPT			NVARCHAR(50),
	@P_F_CD_BIZAREA		NVARCHAR(7),
	@P_F_NM_BIZAREA		NVARCHAR(50),
	@P_F_CD_PC			NVARCHAR(7),
	@P_F_NM_PC			NVARCHAR(50),
	@P_ID_USER			NVARCHAR(15),
	@P_CTIME			NVARCHAR(14),
	@P_SERVERKEY		NVARCHAR(20) = NULL	,
	@P_TP_PAY			NVARCHAR(3),
	@P_FG_LANG			NVARCHAR(4) = NULL
)
AS

SET NOCOUNT ON

EXEC UP_MA_LOCAL_LANGUAGE @P_FG_LANG

DECLARE
		@V_분류단위_회사			VARCHAR(1),
		@V_분류단위_사업장			VARCHAR(1),
		@V_분류단위_부서			VARCHAR(1),
		@V_분류단위_회계_사업장		VARCHAR(1),
		@V_분류단위_회계_CC			VARCHAR(1),
		@V_집계범위_사원			VARCHAR(3),

		@V_NM_PC					NVARCHAR(50),		
		@V_NO_EMP					NVARCHAR(12),
		@V_NM_KOR					NVARCHAR(50),
		@V_NM_ACCT					NVARCHAR(50),		
		@V_CD_ACLIM					NVARCHAR(3),	

		@V_NO_DOCU  				NVARCHAR(20),
		@V_NO_DOLINE  				NUMERIC(5,0),
		@V_CD_PC  					NVARCHAR(7),
		@V_CD_COMPANY  				NVARCHAR(7),
		@V_CD_WDEPT  				NVARCHAR(12),
		@V_ID_WRITE					NVARCHAR(10),
		@V_DT_ACCT  				NCHAR(8),
		@V_NO_ACCT  				NUMERIC(5,0),
		@V_TP_DOCU					NCHAR(1),
		@V_CD_DOCU  				NVARCHAR(3),
		@V_ST_DOCU					NCHAR(1),
		@V_ID_ACCEPT  				NVARCHAR(10),
		@V_TP_PAYDEDUCT				NVARCHAR(3),
		@V_TP_DRCR					NCHAR(1),
		@V_CD_ACCT  				NVARCHAR(10),
		@V_NM_NOTE  				NVARCHAR(100),
		@V_AM_DR  					NUMERIC(19,4),
		@V_AM_CR  					NUMERIC(19,4),
		@V_TP_ACAREA  				NCHAR(1),
		@V_CD_RELATION				NCHAR(2),
		@V_CD_BUDGET  				NVARCHAR(20),
		@V_CD_FUND  				NCHAR(4),
		@V_NO_BDOCU  				NVARCHAR(20),
		@V_NO_BDOLINE  				NUMERIC(4,0),
		@V_TP_ETCACCT  				NCHAR(1),
		@V_CD_BIZAREA  				NVARCHAR(7),
		@V_NM_BIZAREA				NVARCHAR(50),
		@V_CD_CC  					NVARCHAR(12),
		@V_NM_CC					NVARCHAR(50),
		@V_CD_PJT  					NVARCHAR(20),
		@V_NM_PJT  					NVARCHAR(50),
		@V_CD_DEPT  				NVARCHAR(12),
		@V_NM_DEPT 					NVARCHAR(50),
		@V_CD_EMPLOY  				NVARCHAR(10),
		@V_NM_EMPLOY				NVARCHAR(50),
		@V_CD_PARTNER  				NVARCHAR(7),
		@V_NM_PARTNER				NVARCHAR(50),
		@V_CD_DEPOSIT  				NVARCHAR(20),
		@V_NM_DEPOSIT				NVARCHAR(50),
		@V_CD_CARD  				NVARCHAR(20),
		@V_NM_CARD 					NVARCHAR(50),
		@V_CD_BANK  				NVARCHAR(7),
		@V_NM_BANK 					NVARCHAR(50),
		@V_NO_ITEM  				NVARCHAR(20),
		@V_NM_ITEM 					NVARCHAR(50),
		@V_TP_TAX  					NVARCHAR(2),
		@V_NM_TAX  					NVARCHAR(50),
		@V_CD_TRADE  				NVARCHAR(2),
		@V_NM_TRADE  				NVARCHAR(50),
		@V_CD_EXCH  				NVARCHAR(3),
		@V_NM_EXCH					NVARCHAR(50),
		@V_CD_UMNG1  				NVARCHAR(20),
		@V_CD_UMNG2  				NVARCHAR(20),
		@V_CD_UMNG3  				NVARCHAR(20),
		@V_CD_UMNG4  				NVARCHAR(20),
		@V_CD_UMNG5  				NVARCHAR(20),
		@V_CD_MNG  					NVARCHAR(20),
		@V_DT_START  				NCHAR(8),
		@V_DT_END  					NCHAR(8),
		@V_RT_EXCH  				NUMERIC(15,4),
		@V_AM_EXDO  				NUMERIC(19,4),
		@V_NO_MODULE  				NVARCHAR(3),
		@V_NO_MDOCU  				NVARCHAR(20),
		@V_CD_EPNOTE  				NVARCHAR(10),
		@V_ID_INSERT  				NVARCHAR(15),
		@V_CD_BGACCT  				NVARCHAR(10),
		@V_TP_EPNOTE  				CHAR(1),
		@V_NM_PUMM  				NVARCHAR(100),
		@V_DT_WRITE  				NCHAR(8),
		@V_AM_ACTSUM  				NUMERIC(19,4),
		@V_AM_JSUM					NUMERIC(19,4),
		@V_YN_GWARE  				NCHAR(1),
		@V_CD_BIZPLAN  				NVARCHAR(20),
		@V_ERRORCODE				INT,
		@V_ERRORMSG					NVARCHAR(300),
		@V_DT_PAY					NVARCHAR(8),
		@V_CD_PAYDEDUCT				NVARCHAR(3),
		@V_CD_EMP					NVARCHAR(3),
		@V_TP_EMP					NVARCHAR(3),
		@V_TP_PAY					NVARCHAR(3),
		@V_NO_SEQ					NUMERIC(7),
		@V_TP_RADJUST				NVARCHAR(3),
		@V_DT_BRETIRE				VARCHAR(8),
		@V_PER_CD					NVARCHAR(12),
		@V_DATA_CD					VARCHAR(2),
		@V_SQ						NUMERIC(5),
		@V_SEQ						NUMERIC(14),
		@V_NO_PROPOSAL				NVARCHAR(12),
		@V_TP_PROPOSAL				NVARCHAR(3),
		@V_TP_NODOCU				NVARCHAR(3),		-- 채번구분(2011-07-18)
		
		@V_NM_NOTE2  				NVARCHAR(100),		
		@V_TP_BUDGETMNG				NCHAR(1), --0: 사업계획안씀, 1:사업계획 씀
		
		@V_NO_BANK					NVARCHAR(200),
		@V_TP_EVIDENCE				NVARCHAR(4)
		
SET @V_TP_BUDGETMNG = ISNULL(NEOE.FN_MA_ENVD(@P_CD_COMPANY, 'TP_BUDGETMNG'), '0')

SET @V_분류단위_회사 = 'C'		
SET @V_분류단위_사업장 = 'B' 
SET @V_분류단위_부서 = 'D' 
SET @V_분류단위_회계_사업장	= 'A' 
SET @V_분류단위_회계_CC = 'E'
SET @V_집계범위_사원 = '004'

SET @V_TP_DOCU = '3'

--2012.05.03 : SMC공압 급여구분별 전표유형 
IF @P_TP_SUM = '001' AND @P_SERVERKEY LIKE 'SMC%'
	SET @V_CD_DOCU = CASE @P_TP_PAY WHEN '001' THEN '71' WHEN '002' THEN '72' WHEN '003' THEN '73' ELSE  '11' END
ELSE
	SET @V_CD_DOCU = '11'
	
SET @V_ST_DOCU = '1'
SET @V_TP_ACAREA = '0'
SET @V_CD_RELATION = '10'
SET @V_NO_BDOLINE = 0
SET @V_RT_EXCH = 0
SET @V_AM_EXDO = 0
SET @V_AM_ACTSUM = 0
SET @V_AM_JSUM = 0

SET @V_NO_DOLINE = 1
SET @V_NM_NOTE = SUBSTRING(@P_YM, 1, 4) + NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '년', @P_FG_LANG) + SUBSTRING(@P_YM, 5, 2) + NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '월', @P_FG_LANG)

IF @P_TP_SUM = '001'
	SET @V_NM_NOTE = @V_NM_NOTE + ' ' + CASE @P_TP_PAY WHEN '001' THEN NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '급여', @P_FG_LANG) 
													   WHEN '002' THEN NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '상여', @P_FG_LANG) 
													   WHEN '003' THEN NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '년월차', @P_FG_LANG)
													   WHEN '004' THEN NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '소급', @P_FG_LANG)
													   ELSE NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '급여', @P_FG_LANG)
										 END
ELSE IF @P_TP_SUM IN ('002', '005')
	SET @V_NM_NOTE = @V_NM_NOTE + ' ' + NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '퇴직', @P_FG_LANG)
ELSE IF @P_TP_SUM = '003'
	SET @V_NM_NOTE = @V_NM_NOTE  + ' ' + NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '사업', @P_FG_LANG)
ELSE IF @P_TP_SUM = '004'
	SET @V_NM_NOTE = @V_NM_NOTE + ' ' + NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '기타', @P_FG_LANG)
ELSE IF @P_TP_SUM = '099'
	SET @V_NM_NOTE = @V_NM_NOTE + ' ' + NEOE.FN_GET_DD(@P_CD_COMPANY, 'HR', '출장비', @P_FG_LANG)

IF @P_SERVERKEY LIKE 'YTN%' AND @P_TP_SUM = '001' AND @P_TP_PAY = '003'
	SET @V_NM_NOTE = SUBSTRING(@P_YM, 1, 4) + '년도 연차수당'
  	
SET @V_NO_MODULE = CASE @P_TP_SUM	WHEN '001' THEN '310' 
									WHEN '002' THEN '320' 
									WHEN '003' THEN '330' 
									WHEN '004' THEN '340' 
									WHEN '005' THEN '350'
									WHEN '099' THEN '399' 
				   END
SET @V_CD_COMPANY = @P_CD_COMPANY
SET @V_DT_WRITE = CONVERT(NCHAR, GETDATE(), 112)

--대림I&S 전용
IF (@P_SERVERKEY = 'DEM_급여') 
BEGIN
	SET @V_CD_UMNG4 = '04'
	SET @V_CD_EMPLOY = @P_WRITE_NO_EMP
	
	SELECT	@V_NM_EMPLOY = NM_KOR
	FROM	MA_EMP
	WHERE	CD_COMPANY = @P_CD_COMPANY AND NO_EMP = @P_WRITE_NO_EMP
	
END

IF @P_전표분류단위 = @V_분류단위_회사
BEGIN
	SET @P_CD_BIZAREA	= @P_F_CD_BIZAREA
	SET @P_CD_PC		= @P_F_CD_PC
	
END
ELSE IF @P_전표분류단위 IN (@V_분류단위_회계_사업장, @V_분류단위_회계_CC)
BEGIN
	SET @P_CD_BIZAREA	= @P_F_CD_BIZAREA
	SET @P_CD_PC		= @P_F_CD_PC
	
END
ELSE 
BEGIN
	SET @P_CD_BIZAREA	= @P_CD_BIZAREA
	SET @P_CD_PC		= @P_CD_PC
	
END

-- 전표번호 채번 2011.07.18 전표채번단위에 따라 전표번호 생성하기
IF @P_전표분류단위 = @V_분류단위_회사
	SET @V_CD_PC = @P_F_CD_PC
ELSE IF @P_전표분류단위 IN ( @V_분류단위_회계_사업장, @V_분류단위_회계_CC)
	SET @V_CD_PC = @P_CD_PC
ELSE
	SET @V_CD_PC = @P_CD_PC

SELECT @V_TP_NODOCU = CD_ENV FROM MA_ENVD WHERE CD_COMPANY = @P_CD_COMPANY AND TP_ENV = 'TP_NODOCU'

IF @P_SERVERKEY LIKE 'YTN%' AND @P_CD_COMPANY = 'YTN' -- 무조건 FI_Y_XXXX => YTN만
	EXEC UP_FI_DOCU_CREATE_SEQ3 'YTN', '1000', 'FI01', @P_DT_DECI, @V_NO_DOCU OUTPUT
ELSE
	IF (ISNULL(@V_TP_NODOCU,'0') = '0')
		EXEC UP_FI_DOCU_CREATE_SEQ @P_CD_COMPANY, 'FI01', @P_DT_DECI, @V_NO_DOCU OUTPUT
	ELSE
		EXEC UP_FI_DOCU_CREATE_SEQ3 @P_CD_COMPANY, @V_CD_PC, 'FI01', @P_DT_DECI, @V_NO_DOCU OUTPUT

IF @@ERROR > 0
	GOTO ERROR

-- HR_200611001	
SET @V_NO_MDOCU = 'HR_' + @P_YM + SUBSTRING('000' + CONVERT(NVARCHAR, @P_CNT_DOCU), LEN('000' + CONVERT(NVARCHAR, @P_CNT_DOCU)) - 2, 3)

DECLARE @V_CUR CURSOR
IF @P_전표분류단위 = @V_분류단위_회사
BEGIN
	SET @V_CUR = CURSOR FOR
	SELECT	CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, 
			CASE WHEN ( @P_SERVERKEY LIKE 'CHOSUNHOTELBA%' ) THEN CD_BUDGET
			ELSE CD_PJT END CD_PJT, 
			CASE WHEN ( @P_SERVERKEY LIKE 'CHOSUNHOTELBA%' ) THEN NM_BUDGET
			ELSE NM_PJT END NM_PJT, CD_PARTNER, NM_PARTNER,
			CD_BUDGET, DT_START, DT_END, S.CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, SUM(AM_DR) AM_DR, SUM(AM_CR) AM_CR,
			DT_PAY, CD_PAYDEDUCT, CD_BGACCT, CD_BIZPLAN, N.NM_NOTE, CD_DEPOSIT, CD_BANK
	FROM	##GTB_HR_SLIP S
	LEFT OUTER JOIN HR_SLACCLIM_NOTE N	ON S.CD_COMPANY = N.CD_COMPANY AND S.CD_ACCT = N.CD_ACCT
	WHERE	S.CD_COMPANY	= @P_CD_COMPANY
	GROUP BY CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, CD_PJT, NM_PJT, CD_PARTNER, NM_PARTNER, 
			CD_BUDGET, NM_BUDGET, DT_START, DT_END,S.CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, CD_PAYDEDUCT, DT_PAY, CD_BGACCT, CD_BIZPLAN
			, N.NM_NOTE, CD_DEPOSIT, CD_BANK
	ORDER BY TP_DRCR, CD_PAYDEDUCT, S.CD_ACCT,CD_DEPT, CD_CC, CD_PJT, NO_EMP, TP_PAYDEDUCT, DT_PAY
	
END
ELSE IF @P_전표분류단위 = @V_분류단위_사업장
BEGIN
	SET @V_CUR = CURSOR FOR
	SELECT	CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, CD_PJT, NM_PJT, CD_PARTNER, NM_PARTNER,
			CD_BUDGET, DT_START, DT_END, S.CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, SUM(AM_DR) AM_DR, SUM(AM_CR) AM_CR,
			DT_PAY, CD_PAYDEDUCT, CD_BGACCT, CD_BIZPLAN, N.NM_NOTE, CD_DEPOSIT, CD_BANK
	FROM	##GTB_HR_SLIP S
	LEFT OUTER JOIN HR_SLACCLIM_NOTE N	ON S.CD_COMPANY = N.CD_COMPANY AND S.CD_ACCT = N.CD_ACCT
	WHERE	CD_BIZAREA	= @P_CD_BIZAREA AND CD_PC = @P_CD_PC
	GROUP BY CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, CD_PJT, NM_PJT, CD_PARTNER, NM_PARTNER, 
			CD_BUDGET, DT_START, DT_END, S.CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, CD_PAYDEDUCT, DT_PAY, CD_BGACCT, CD_BIZPLAN
			, N.NM_NOTE, CD_DEPOSIT, CD_BANK
	ORDER BY TP_DRCR, CD_PAYDEDUCT, S.CD_ACCT, CD_DEPT, CD_CC, CD_PJT, NO_EMP, TP_PAYDEDUCT, DT_PAY
	
END
ELSE IF @P_전표분류단위 = @V_분류단위_부서
BEGIN
	SET @V_CUR = CURSOR FOR
	SELECT	CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, CD_PJT, NM_PJT, CD_PARTNER, NM_PARTNER,
			CD_BUDGET, DT_START, DT_END, S.CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, SUM(AM_DR) AM_DR, SUM(AM_CR) AM_CR,
			DT_PAY, CD_PAYDEDUCT, CD_BGACCT, CD_BIZPLAN, N.NM_NOTE, CD_DEPOSIT, CD_BANK
	FROM	##GTB_HR_SLIP S
	LEFT OUTER JOIN HR_SLACCLIM_NOTE N	ON S.CD_COMPANY = N.CD_COMPANY AND S.CD_ACCT = N.CD_ACCT
	WHERE	CD_DEPT	= @P_CD_DEPT
	GROUP BY CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, CD_PJT, NM_PJT, CD_PARTNER, NM_PARTNER, 
			CD_BUDGET, DT_START, DT_END, S.CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, CD_PAYDEDUCT, DT_PAY, CD_BGACCT, CD_BIZPLAN
			, N.NM_NOTE, CD_DEPOSIT, CD_BANK
	ORDER BY TP_DRCR, CD_PAYDEDUCT, S.CD_ACCT,CD_DEPT, CD_CC, CD_PJT, NO_EMP, TP_PAYDEDUCT, DT_PAY
	
END
ELSE IF @P_전표분류단위 IN ( @V_분류단위_회계_사업장, @V_분류단위_회계_CC)
BEGIN
	SET @V_CUR = CURSOR FOR
	SELECT	CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, CD_PJT, NM_PJT, CD_PARTNER, NM_PARTNER,
			CD_BUDGET, DT_START, DT_END, S.CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, SUM(AM_DR) AM_DR, SUM(AM_CR) AM_CR,
			DT_PAY, CD_PAYDEDUCT, CD_BGACCT, CD_BIZPLAN, N.NM_NOTE, CD_DEPOSIT, CD_BANK
	FROM	##GTB_HR_SLIP S	
	LEFT OUTER JOIN HR_SLACCLIM_NOTE N	ON S.CD_COMPANY = N.CD_COMPANY AND S.CD_ACCT = N.CD_ACCT	
	WHERE	CD_PC = @P_CD_PC
	GROUP BY CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, CD_PJT, NM_PJT, CD_PARTNER, NM_PARTNER, 
			CD_BUDGET, DT_START, DT_END, S.CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, CD_PAYDEDUCT, DT_PAY ,CD_BGACCT, CD_BIZPLAN
			, N.NM_NOTE, CD_DEPOSIT, CD_BANK
	ORDER BY TP_DRCR, CD_PAYDEDUCT, S.CD_ACCT, CD_DEPT, CD_CC, CD_PJT, NO_EMP,TP_PAYDEDUCT, DT_PAY
	
END

OPEN @V_CUR
FETCH NEXT FROM @V_CUR 
INTO @V_CD_BIZAREA, @V_NM_BIZAREA, @V_CD_PC, @V_NM_PC, @V_CD_DEPT, @V_NM_DEPT, @V_CD_CC, @V_NM_CC, @V_NO_EMP, @V_NM_KOR, @V_CD_PJT, @V_NM_PJT, @V_CD_PARTNER, @V_NM_PARTNER, 
	@V_CD_BUDGET, @V_DT_START, @V_DT_END, @V_CD_ACCT, @V_NM_ACCT, @V_TP_PAYDEDUCT, @V_TP_DRCR, @V_CD_ACLIM, @V_AM_DR, @V_AM_CR,
	@V_DT_PAY, @V_CD_PAYDEDUCT, @V_CD_BGACCT, @V_CD_BIZPLAN, @V_NM_NOTE2, @V_CD_DEPOSIT, @V_CD_BANK

WHILE @@FETCH_STATUS = 0
BEGIN
	IF @P_전표분류단위 = @V_분류단위_회사
	BEGIN
		SET @V_CD_BIZAREA	= @P_F_CD_BIZAREA
		SET	@V_NM_BIZAREA	= @P_F_NM_BIZAREA
		SET @V_CD_PC		= @P_F_CD_PC
		SET @V_NM_PC		= @P_F_NM_PC
		
	END
	ELSE IF @P_전표분류단위 IN ( @V_분류단위_회계_사업장, @V_분류단위_회계_CC)
	BEGIN
		SET @V_CD_BIZAREA	= @P_F_CD_BIZAREA
		SET	@V_NM_BIZAREA	= @P_F_NM_BIZAREA
		SET @V_CD_PC		= @P_F_CD_PC
		SET @V_NM_PC		= @P_F_NM_PC
		
	END
	ELSE
	BEGIN
		SET @V_CD_BIZAREA	= @P_CD_BIZAREA
		SET @V_CD_PC		= @P_CD_PC
		
	END

	SET @V_CD_WDEPT = @P_WRITE_DEPT
	SET @V_ID_WRITE = @P_WRITE_NO_EMP
	SET @V_DT_ACCT	= @P_DT_DECI
	SET @V_NO_MDOCU = 'HR_' + CONVERT(NVARCHAR, CONVERT(INT, @V_NO_DOLINE))
	SET @V_NO_DOLINE = @V_NO_DOLINE

	SET @V_CD_EMPLOY = NULL
	SET @V_NM_EMPLOY = NULL
	
	IF @V_TP_BUDGETMNG = '1' AND @V_CD_ACLIM = @V_분류단위_회사  -- @V_TP_BUDGETMNG (사업계획사용여부) 0:사업계획미사용, 1:사업계획사용 체크 추가. 사용일때만 0으로 처리한다.
	BEGIN
		SET @V_CD_BIZPLAN = '0'
	END
	
	--2011.06.23 사업소득, 기타소득은 제외
	ELSE IF ( (@V_CD_ACLIM = @V_집계범위_사원 or @V_CD_ACLIM = '007') AND @P_TP_SUM != '003' AND @P_TP_SUM != '004' )
	BEGIN
		SET @V_CD_EMPLOY = @V_NO_EMP
		SET @V_NM_EMPLOY = @V_NM_KOR

	END
	
	-- 장은경 : 2010.08.20
	SELECT	@V_TP_ACAREA = CASE WHEN @V_TP_DRCR = TP_DRCR AND YN_BANPILSU = 'Y' THEN '4' ELSE '0' END
	FROM	FI_ACCTCODE 
	WHERE	CD_COMPANY	= @P_CD_COMPANY 
	AND		CD_ACCT		= @V_CD_ACCT 	
	
	SET @V_ID_INSERT = @P_WRITE_NO_EMP
	
	IF NEOE.FN_SERVERKEY('N', 'PANKO|') = 'Y'
	BEGIN
		SELECT @V_NM_DEPOSIT = NO_DEPOSIT  FROM FI_DEPOSIT WHERE CD_COMPANY = @P_CD_COMPANY AND CD_DEPOSIT = @V_CD_DEPOSIT;		
		SET @V_CD_BANK = CASE WHEN @V_CD_BANK = '999' THEN '003' ELSE @V_CD_BANK END --기타은행(999) 면 기업은행으로 바꿔준다.
		SELECT @V_NM_BANK = NM_SYSDEF FROM MA_CODEDTL WHERE CD_COMPANY = @P_CD_COMPANY AND CD_SYSDEF = @V_CD_BANK AND CD_FIELD = 'HR_P000006';
		SET @V_TP_EVIDENCE = '5'
	END

	IF EXISTS ( SELECT	* 
				FROM	HR_SLBASIS
				WHERE	CD_COMPANY = @P_CD_COMPANY
				AND		CD_ACCT = @V_CD_ACCT
				AND		TP_TR = '001'
				AND		CD_ACLIM = '004'
				AND		CD_MNG = 'C15' )
	BEGIN
		SELECT	@V_CD_BANK = CD_BANK1,
				@V_NM_BANK = (SELECT NM_SYSDEF FROM DZSN_MA_CODEDTL WHERE CD_COMPANY = @P_CD_COMPANY AND CD_FIELD = 'HR_P000006' AND CD_SYSDEF = CD_BANK1)
		FROM	MA_EMP
		WHERE	CD_COMPANY = @P_CD_COMPANY
		AND		NO_EMP = @V_NO_EMP

	END
	
	IF (NEOE.FN_SERVERKEY('N', 'BIOLAND|') = 'Y')
	BEGIN
		SET @V_CD_BUDGET = @V_CD_CC
		SET @V_CD_BGACCT = @V_CD_ACCT
	END
	
	IF (NEOE.FN_SERVERKEY('N', 'EMC|') = 'Y')
	BEGIN
		SET @V_CD_BIZPLAN = @V_CD_CC
		SET @V_CD_BUDGET = @V_CD_CC
		SET @V_CD_BGACCT = @V_CD_ACCT		
	END

	IF (NEOE.FN_SERVERKEY('N', 'DINTEC') = 'Y' OR NEOE.FN_SERVERKEY('N', 'DINTEC2') = 'Y')
	BEGIN
		SET @V_TP_EVIDENCE = '5'
		SET @V_CD_BUDGET = @V_CD_CC
	END
	
	EXEC UP_HR_SLACCLIM_DOCU1_ACCT_PTNR @P_CD_COMPANY, @P_SERVERKEY, @P_TP_SUM, @V_CD_ACCT, @P_FG_LANG, @V_CD_PARTNER OUTPUT, @V_NM_PARTNER OUTPUT
	
	IF (ISNULL(@V_NM_NOTE2, '') = '')
		BEGIN
			EXEC UP_HR_AUTODOCU						
					@V_NO_DOCU,
					@V_NO_DOLINE,
					@V_CD_PC,
					@V_CD_COMPANY,
					@V_CD_WDEPT,
					@V_ID_WRITE,
					@V_DT_ACCT,
					@V_NO_ACCT,
					@V_TP_DOCU,
					@V_CD_DOCU,
					@V_ST_DOCU,
					@V_ID_ACCEPT,
					@V_TP_DRCR,
					@V_CD_ACCT,
					@V_NM_NOTE,
					@V_AM_DR,
					@V_AM_CR,
					@V_TP_ACAREA,
					@V_CD_RELATION,
					@V_CD_BUDGET,
					@V_CD_FUND,
					@V_NO_BDOCU,
					@V_NO_BDOLINE,
					@V_TP_ETCACCT,
					@V_CD_BIZAREA,
					@V_NM_BIZAREA,
					@V_CD_CC,
					@V_NM_CC,
					@V_CD_PJT,
					@V_NM_PJT,
					@V_CD_DEPT,
					@V_NM_DEPT,
					@V_CD_EMPLOY,
					@V_NM_EMPLOY,
					@V_CD_PARTNER,
					@V_NM_PARTNER,
					@V_CD_DEPOSIT,
					@V_NM_DEPOSIT,
					@V_CD_CARD,
					@V_NM_CARD,
					@V_CD_BANK,
					@V_NM_BANK,
					@V_NO_ITEM,
					@V_NM_ITEM,
					@V_TP_TAX,
					@V_NM_TAX,
					@V_CD_TRADE,
					@V_NM_TRADE,
					@V_CD_EXCH,
					@V_NM_EXCH,
					@V_CD_UMNG1,
					@V_CD_UMNG2,
					@V_CD_UMNG3,
					@V_CD_UMNG4,
					@V_CD_UMNG5,

					NULL, 	-- @P_NO_RES
					0,		-- @P_AM_SUPPLY

					@V_CD_MNG,
					@V_DT_START,
					@V_DT_END,
					@V_RT_EXCH,
					@V_AM_EXDO,
					@V_NO_MODULE,
					@V_NO_MDOCU,
					@V_CD_BGACCT, --@V_CD_EPNOTE,
					@V_ID_INSERT,
					@V_CD_BGACCT,
					@V_TP_EPNOTE,
					@V_NM_PUMM,
					@V_DT_WRITE,
					@V_AM_ACTSUM,
					@V_AM_JSUM,
					@V_YN_GWARE,
					@V_CD_BIZPLAN,
					@V_NO_EMP,				--사업소득자, 기타소득자 
					@V_ERRORCODE OUTPUT,
					@V_ERRORMSG OUTPUT,
					NULL,				-- BL번호 (전방추가)          
					NULL,				-- LC번호 (전방추가)          
					NULL,				-- 결재방법 (전방추가)    --LINE : 80  
					NULL,				-- 미착품구분 (전방추가) 
					@V_CD_PAYDEDUCT,    --인사추가 
					NULL,				--EC 추가 (본죽)
                    @V_DT_PAY,			--인사추가 (YTN)
                    NULL,
                    NULL,
                    NULL,
                    NULL,
                    NULL,
                    NULL,
                    @P_FG_LANG,
                    @V_TP_EVIDENCE
		END
	ELSE						
		BEGIN
			EXEC UP_HR_AUTODOCU						
					@V_NO_DOCU,
					@V_NO_DOLINE,
					@V_CD_PC,
					@V_CD_COMPANY,
					@V_CD_WDEPT,
					@V_ID_WRITE,
					@V_DT_ACCT,
					@V_NO_ACCT,
					@V_TP_DOCU,
					@V_CD_DOCU,
					@V_ST_DOCU,
					@V_ID_ACCEPT,
					@V_TP_DRCR,
					@V_CD_ACCT,
					@V_NM_NOTE2,
					@V_AM_DR,
					@V_AM_CR,
					@V_TP_ACAREA,
					@V_CD_RELATION,
					@V_CD_BUDGET,
					@V_CD_FUND,
					@V_NO_BDOCU,
					@V_NO_BDOLINE,
					@V_TP_ETCACCT,
					@V_CD_BIZAREA,
					@V_NM_BIZAREA,
					@V_CD_CC,
					@V_NM_CC,
					@V_CD_PJT,
					@V_NM_PJT,
					@V_CD_DEPT,
					@V_NM_DEPT,
					@V_CD_EMPLOY,
					@V_NM_EMPLOY,
					@V_CD_PARTNER,
					@V_NM_PARTNER,
					@V_CD_DEPOSIT,
					@V_NM_DEPOSIT,
					@V_CD_CARD,
					@V_NM_CARD,
					@V_CD_BANK,
					@V_NM_BANK,
					@V_NO_ITEM,
					@V_NM_ITEM,
					@V_TP_TAX,
					@V_NM_TAX,
					@V_CD_TRADE,
					@V_NM_TRADE,
					@V_CD_EXCH,
					@V_NM_EXCH,
					@V_CD_UMNG1,
					@V_CD_UMNG2,
					@V_CD_UMNG3,
					@V_CD_UMNG4,
					@V_CD_UMNG5,

					NULL, 	-- @P_NO_RES
					0,		-- @P_AM_SUPPLY

					@V_CD_MNG,
					@V_DT_START,
					@V_DT_END,
					@V_RT_EXCH,
					@V_AM_EXDO,
					@V_NO_MODULE,
					@V_NO_MDOCU,
					@V_CD_BGACCT,--@V_CD_EPNOTE,
					@V_ID_INSERT,
					@V_CD_BGACCT,
					@V_TP_EPNOTE,
					@V_NM_PUMM,
					@V_DT_WRITE,
					@V_AM_ACTSUM,
					@V_AM_JSUM,
					@V_YN_GWARE,
					@V_CD_BIZPLAN,
					@V_NO_EMP, 
					@V_ERRORCODE OUTPUT,
					@V_ERRORMSG OUTPUT,
					NULL,				-- BL번호 (전방추가)          
					NULL,				-- LC번호 (전방추가)          
					NULL,				-- 결재방법 (전방추가)    --LINE : 80  
					NULL,				-- 미착품구분 (전방추가) 
					@V_CD_PAYDEDUCT,    --인사추가 
					NULL,				--EC 추가 (본죽)
                    @V_DT_PAY,			--인사추가 (YTN)
                    NULL,
                    NULL,
                    NULL,
                    NULL,
                    NULL,
                    NULL,
                    @P_FG_LANG,
                    @V_TP_EVIDENCE
		END

	IF @@ERROR > 0
		GOTO ERROR

	SET @V_NO_DOLINE = @V_NO_DOLINE + 1
	FETCH NEXT FROM @V_CUR 
	INTO @V_CD_BIZAREA, @V_NM_BIZAREA, @V_CD_PC, @V_NM_PC, @V_CD_DEPT, @V_NM_DEPT, @V_CD_CC, @V_NM_CC, @V_NO_EMP, @V_NM_KOR, @V_CD_PJT, @V_NM_PJT, @V_CD_PARTNER, @V_NM_PARTNER, 
		 @V_CD_BUDGET, @V_DT_START, @V_DT_END, @V_CD_ACCT, @V_NM_ACCT, @V_TP_PAYDEDUCT, @V_TP_DRCR, @V_CD_ACLIM, @V_AM_DR, @V_AM_CR, @V_DT_PAY, @V_CD_PAYDEDUCT, @V_CD_BGACCT, @V_CD_BIZPLAN
		 ,@V_NM_NOTE2, @V_CD_DEPOSIT, @V_CD_BANK
END

CLOSE @V_CUR
DEALLOCATE @V_CUR

EXEC CP_GETNO @P_CD_COMPANY, 'HR', '14', @P_YM, @V_NO_MDOCU OUTPUT

IF @@ERROR > 0
	GOTO ERROR
	
-- 전표처리정보 추가
INSERT INTO HR_SLHINFO
(
	CD_COMPANY, CD_BIZAREA, YM, NO_SSEQ, TP_PAY, NO_MDOCU, NO_MODULE, DECI_DEPT, DECI_EMP, DECI_DATE, DOSL_NO, CD_PC, TP_SL, ID_INSERT, DTS_INSERT, CD_DEPT
)
VALUES
(
	@P_CD_COMPANY, @P_CD_BIZAREA, @P_YM, 1, @P_TP_SUM, @V_NO_MDOCU, @V_NO_MODULE, @P_WRITE_DEPT, @P_WRITE_NO_EMP, @P_DT_DECI, @V_NO_DOCU, @P_CD_PC, 'Y', @P_ID_USER, @P_CTIME, @V_CD_DEPT
)

SET @V_SEQ = 1
DECLARE @V_CUR2 CURSOR
SET @V_CUR2 = CURSOR FOR
SELECT CD_BIZAREA, CD_EMP, TP_EMP, TP_PAY, NO_SEQ, TP_RADJUST, NO_EMP, DT_BRETIRE, PER_CD, DATA_CD, SQ, NO_PROPOSAL, TP_PROPOSAL
FROM   ##GTB_HR_SLIP_DETAIL
WHERE  ID_USER = @P_ID_USER AND CTIME = @P_CTIME

OPEN @V_CUR2
FETCH NEXT FROM @V_CUR2
INTO @V_CD_BIZAREA, @V_CD_EMP, @V_TP_EMP, @V_TP_PAY, @V_NO_SEQ, @V_TP_RADJUST, @V_NO_EMP, @V_DT_BRETIRE, @V_PER_CD, @V_DATA_CD, @V_SQ, @V_NO_PROPOSAL, @V_TP_PROPOSAL
WHILE @@FETCH_STATUS = 0
BEGIN 	
	INSERT INTO HR_SLHINFO_DETAIL
	( CD_COMPANY, CD_BIZAREA, YM,NO_SSEQ, TP_PAY, NO_MDOCU, DOSL_NO, NO_SEQ, TP_EMP, CD_EMP, CD_BIZAREA_R,
	  TP_PAY_R, NO_SEQ_R, TP_RADJUST, NO_EMP, DT_BRETIRE, PER_CD, DATA_CD,SQ)
	VALUES( @P_CD_COMPANY, @P_CD_BIZAREA, @P_YM, 1, @P_TP_SUM, @V_NO_MDOCU, @V_NO_DOCU, @V_SEQ, @V_TP_EMP, @V_CD_EMP, @V_CD_BIZAREA,
			@V_TP_PAY, @V_NO_SEQ, @V_TP_RADJUST, @V_NO_EMP, @V_DT_BRETIRE, @V_PER_CD, @V_DATA_CD, @V_SQ)

	--2011.11.23.( HINCOME.SLIP_YN 값 '1' )
	IF ( @P_TP_SUM = '003' OR @P_TP_SUM = '004' )
	BEGIN
		UPDATE HINCOME
		SET		NO_DOCU = @V_NO_DOCU, SLIP_YN = '1'
		WHERE	CO_CD	= @P_CD_COMPANY AND YM = @P_YM 
		AND		DATA_CD = @V_DATA_CD AND DIV_CD = @V_CD_BIZAREA 
		AND		PER_CD = @V_PER_CD AND SQ = @V_SQ
	END
	ELSE IF ( @P_TP_SUM = '099' )
	BEGIN
		UPDATE HR_Z_KFI_BISICALC
		SET		NO_DOCU = @V_NO_DOCU, YN_DOCU = 'Y'
		WHERE	CD_COMPANY	= @P_CD_COMPANY AND NO_EMP = @V_PER_CD 
		AND		NO_PROPOSAL = @V_NO_PROPOSAL AND TP_PROPOSAL = @V_TP_PROPOSAL 
	END
	
	SET @V_SEQ = @V_SEQ + 1
	FETCH NEXT FROM @V_CUR2
	INTO @V_CD_BIZAREA, @V_CD_EMP, @V_TP_EMP, @V_TP_PAY, @V_NO_SEQ, @V_TP_RADJUST, @V_NO_EMP, @V_DT_BRETIRE, @V_PER_CD, @V_DATA_CD, @V_SQ, @V_NO_PROPOSAL, @V_TP_PROPOSAL
END

CLOSE @V_CUR2
DEALLOCATE @V_CUR2
	
IF (@P_SERVERKEY IN ('DEM_상대전표', 'DEM_급여'))
	EXEC UP_HR_SLACCLIM_DOCU1_DEM @P_CD_COMPANY, @P_YM, @P_전표분류단위, @P_CD_BIZAREA, @P_CD_PC, @P_CD_DEPT, @V_NO_DOCU, @P_ID_USER, @P_CTIME, @P_SERVERKEY

IF EXISTS (SELECT * FROM CM_SERVER_CONFIG WHERE SERVER_KEY = 'HHIAVS')
	BEGIN
	DELETE FROM ZFIT01 WHERE BUDAT = @V_DT_ACCT
	
	SET @V_CUR = CURSOR FOR
	SELECT	CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, 
			CASE WHEN ( @P_SERVERKEY LIKE 'CHOSUNHOTELBA%' ) THEN CD_BUDGET
			ELSE CD_PJT END CD_PJT, 
			CASE WHEN ( @P_SERVERKEY LIKE 'CHOSUNHOTELBA%' ) THEN NM_BUDGET
			ELSE NM_PJT END NM_PJT, CD_PARTNER, NM_PARTNER,
			CD_BUDGET, DT_START, DT_END, CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, SUM(AM_DR) AM_DR, SUM(AM_CR) AM_CR,
			DT_PAY, CD_PAYDEDUCT, 
			CASE WHEN ( @P_SERVERKEY = 'DEM_급여' ) THEN CD_BGACCT END CD_BGACCT
	FROM	##GTB_HR_SLIP
	WHERE	CD_COMPANY	= @P_CD_COMPANY
	GROUP BY CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, CD_PJT, NM_PJT, CD_PARTNER, NM_PARTNER, 
			CD_BUDGET, NM_BUDGET, DT_START, DT_END,CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, CD_PAYDEDUCT, DT_PAY, CD_BGACCT
	ORDER BY TP_DRCR, CD_PAYDEDUCT, CD_ACCT,CD_DEPT, CD_CC, CD_PJT, NO_EMP, TP_PAYDEDUCT, DT_PAY
	
	OPEN @V_CUR
		FETCH NEXT FROM @V_CUR 
		INTO @V_CD_BIZAREA, @V_NM_BIZAREA, @V_CD_PC, @V_NM_PC, @V_CD_DEPT, @V_NM_DEPT, @V_CD_CC, @V_NM_CC, @V_NO_EMP, @V_NM_KOR, @V_CD_PJT, @V_NM_PJT, @V_CD_PARTNER, @V_NM_PARTNER, 
			@V_CD_BUDGET, @V_DT_START, @V_DT_END, @V_CD_ACCT, @V_NM_ACCT, @V_TP_PAYDEDUCT, @V_TP_DRCR, @V_CD_ACLIM, @V_AM_DR, @V_AM_CR,
			@V_DT_PAY, @V_CD_PAYDEDUCT, @V_CD_BGACCT

		WHILE @@FETCH_STATUS = 0
		BEGIN
			INSERT INTO ZFIT01 (MANDT, BUDAT, HKONT, KOSTL, BSCHL, BKTXT, DMBTR) 
					VALUES ('ERP', @V_DT_ACCT, @V_CD_ACCT, @V_CD_CC, CASE @V_TP_DRCR WHEN '1' THEN '40' WHEN '2' THEN '50' END, @V_NM_NOTE, @V_AM_DR + @V_AM_CR)
					
			FETCH NEXT FROM @V_CUR 
			INTO @V_CD_BIZAREA, @V_NM_BIZAREA, @V_CD_PC, @V_NM_PC, @V_CD_DEPT, @V_NM_DEPT, @V_CD_CC, @V_NM_CC, @V_NO_EMP, @V_NM_KOR, @V_CD_PJT, @V_NM_PJT, @V_CD_PARTNER, @V_NM_PARTNER, 
				 @V_CD_BUDGET, @V_DT_START, @V_DT_END, @V_CD_ACCT, @V_NM_ACCT, @V_TP_PAYDEDUCT, @V_TP_DRCR, @V_CD_ACLIM, @V_AM_DR, @V_AM_CR, @V_DT_PAY, @V_CD_PAYDEDUCT, @V_CD_BGACCT
		END
	END

--이트너스 전용 로직
IF EXISTS (SELECT * FROM CM_SERVER_CONFIG WHERE SERVER_KEY = 'ETNERS12')
	BEGIN

	IF	@P_TP_PAY IS NULL OR @P_TP_PAY = ''
	BEGIN
		RAISERROR('급여구분은 반드시 선택하여주시기 바랍니다.', 18, 1)  
		RETURN
	END
		
	DELETE FROM HR_Z_ETNERS_SAP WHERE ID_INTERFACE IN (SELECT ID_INTERFACE FROM Z_ETNERS_SAP WHERE REFERENCE = @P_YM +' '+ (CASE @P_TP_PAY WHEN '001' THEN '급여' WHEN '002' THEN '상여' END))

	DECLARE @V_CNT INT
	
	SET @V_CNT = 1
	
	SET @V_CUR = CURSOR FOR
	SELECT	CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, 
			CASE WHEN ( @P_SERVERKEY LIKE 'CHOSUNHOTELBA%' ) THEN CD_BUDGET
			ELSE CD_PJT END CD_PJT, 
			CASE WHEN ( @P_SERVERKEY LIKE 'CHOSUNHOTELBA%' ) THEN NM_BUDGET
			ELSE NM_PJT END NM_PJT, CD_PARTNER, NM_PARTNER,
			CD_BUDGET, DT_START, DT_END, CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, SUM(AM_DR) AM_DR, SUM(AM_CR) AM_CR,
			DT_PAY, CD_PAYDEDUCT, 
			CASE WHEN ( @P_SERVERKEY = 'DEM_급여' ) THEN CD_BGACCT END CD_BGACCT
	FROM	##GTB_HR_SLIP
	WHERE	CD_COMPANY	= @P_CD_COMPANY
	GROUP BY CD_BIZAREA, NM_BIZAREA, CD_PC, NM_PC, CD_DEPT, NM_DEPT, CD_CC, NM_CC, NO_EMP, NM_KOR, CD_PJT, NM_PJT, CD_PARTNER, NM_PARTNER, 
			CD_BUDGET, NM_BUDGET, DT_START, DT_END,CD_ACCT, NM_ACCT, TP_PAYDEDUCT, TP_DRCR, CD_ACLIM, CD_PAYDEDUCT, DT_PAY, CD_BGACCT
	ORDER BY TP_DRCR, CD_PAYDEDUCT, CD_ACCT,CD_DEPT, CD_CC, CD_PJT, NO_EMP, TP_PAYDEDUCT, DT_PAY
	
	OPEN @V_CUR
		FETCH NEXT FROM @V_CUR 
		INTO @V_CD_BIZAREA, @V_NM_BIZAREA, @V_CD_PC, @V_NM_PC, @V_CD_DEPT, @V_NM_DEPT, @V_CD_CC, @V_NM_CC, @V_NO_EMP, @V_NM_KOR, @V_CD_PJT, @V_NM_PJT, @V_CD_PARTNER, @V_NM_PARTNER, 
			@V_CD_BUDGET, @V_DT_START, @V_DT_END, @V_CD_ACCT, @V_NM_ACCT, @V_TP_PAYDEDUCT, @V_TP_DRCR, @V_CD_ACLIM, @V_AM_DR, @V_AM_CR,
			@V_DT_PAY, @V_CD_PAYDEDUCT, @V_CD_BGACCT

		WHILE @@FETCH_STATUS = 0
		BEGIN
			IF @V_CNT = 1
			BEGIN
				INSERT INTO HR_Z_ETNERS_SAP 
						(
							ID_INTERFACE,
							IDENT_NUMBER,
							LINE_ID,
							SEQ_NUMBER,
							REFERENCE,
							DOC_DATE,
							DOC_TYPE,
							COMP_CODE,
							PSTNG_DATE,
							CURRENCY,
							HEADER_TXT,
							USER_NAME,
							FISCAL_YEAR,
							PERIOD,
							POSTING_KEY,
							GL_ACCOUNT,
							AMT_DOCCUR,
							COST_CENTER,
							TEXT,
							PAYMENT_BLOCK,
							ASSIGNMENT
						) 
						VALUES 
						(
							@P_CTIME,
							'00001',
							'01',
							RIGHT('0000'+CONVERT(NVARCHAR(5),@V_CNT),5),
							REPLACE(REPLACE(@V_NM_NOTE,'년',''),'월','')  ,
							SUBSTRING(NEOE.FN_HR_GET_MONTH_END(@P_YM+'01',4),7,2)+SUBSTRING(NEOE.FN_HR_GET_MONTH_END(@P_YM+'01',4),5,2)+SUBSTRING(NEOE.FN_HR_GET_MONTH_END(@P_YM+'01',4),1,4)  , --MMDDYYYY -> DDMMYYY로 수정 
							'IP'  ,
							'5101'  ,
							SUBSTRING(NEOE.FN_HR_GET_MONTH_END(@P_YM+'01',4),7,2)+SUBSTRING(NEOE.FN_HR_GET_MONTH_END(@P_YM+'01',4),5,2)+SUBSTRING(NEOE.FN_HR_GET_MONTH_END(@P_YM+'01',4),1,4)  , --MMDDYYYY -> DDMMYYY로 수정 
							'KRW'  ,
							RIGHT(@V_NM_NOTE,2)  ,
							@P_ID_USER  ,
							LEFT(@P_YM,4)  ,
							RIGHT(@P_YM,2)  ,
							NULL, 
							NULL, 
							NULL, 
							NULL, 
							NULL, 
							NULL, 
							NULL
						)

				SET @V_CNT = @V_CNT + 1 
			END
			IF @V_CNT <> 1
			BEGIN
				INSERT INTO HR_Z_ETNERS_SAP 
						(
							ID_INTERFACE,
							IDENT_NUMBER,
							LINE_ID,
							SEQ_NUMBER,
							REFERENCE,
							DOC_DATE,
							DOC_TYPE,
							COMP_CODE,
							PSTNG_DATE,
							CURRENCY,
							HEADER_TXT,
							USER_NAME,
							FISCAL_YEAR,
							PERIOD,
							POSTING_KEY,
							GL_ACCOUNT,
							AMT_DOCCUR,
							COST_CENTER,
							TEXT,
							PAYMENT_BLOCK,
							ASSIGNMENT
						) 
						SELECT	@P_CTIME,
								'00001',
								'02',
								RIGHT('0000'+CONVERT(NVARCHAR(5),@V_CNT),5),
								NULL ,
								NULL ,
								NULL ,
								NULL ,
								NULL ,
								NULL ,
								NULL ,
								NULL ,
								NULL ,
								NULL ,
								CASE @V_TP_DRCR WHEN '1' THEN '40' WHEN '2' THEN '50' END,
							CD_ACCT,--계정코드로 변경 2013.10.18 --NM_ACCT + '계정',
							@V_AM_DR+@V_AM_CR,
							@V_CD_CC ,
							@P_YM + ' ' + NM_ACCT + ' (' + @V_NM_CC + ')', -- ASSIGNMENT와 같은값 2013.10.18 --'',
							'',--공란으로 변경 2013.10.18  --'A',
							@P_YM + ' ' + NM_ACCT + ' (' + @V_NM_CC + ')'
						FROM	FI_ACCTCODE 
						WHERE	CD_COMPANY = @V_CD_COMPANY 
						AND		CD_ACCT = @V_CD_ACCT

				SET @V_CNT = @V_CNT + 1 
			END
			
			FETCH NEXT FROM @V_CUR 
			INTO @V_CD_BIZAREA, @V_NM_BIZAREA, @V_CD_PC, @V_NM_PC, @V_CD_DEPT, @V_NM_DEPT, @V_CD_CC, @V_NM_CC, @V_NO_EMP, @V_NM_KOR, @V_CD_PJT, @V_NM_PJT, @V_CD_PARTNER, @V_NM_PARTNER, 
				 @V_CD_BUDGET, @V_DT_START, @V_DT_END, @V_CD_ACCT, @V_NM_ACCT, @V_TP_PAYDEDUCT, @V_TP_DRCR, @V_CD_ACLIM, @V_AM_DR, @V_AM_CR, @V_DT_PAY, @V_CD_PAYDEDUCT, @V_CD_BGACCT
		END
	END

RETURN

ERROR:
	IF OBJECT_ID(N'tempdb..##GTB_HR_SLIP_PAY', N'U') IS NOT NULL 
		DELETE ##GTB_HR_SLIP_PAY WHERE ID_USER = @P_ID_USER AND CTIME = @P_CTIME
	
	IF OBJECT_ID(N'tempdb..##GTB_HR_SLIP_RPAY', N'U') IS NOT NULL 
		DELETE ##GTB_HR_SLIP_RPAY WHERE ID_USER = @P_ID_USER AND CTIME = @P_CTIME

	IF OBJECT_ID(N'tempdb..##GTB_HR_SLIP_BIZETC', N'U') IS NOT NULL 
		DELETE ##GTB_HR_SLIP_BIZETC WHERE ID_USER = @P_ID_USER AND CTIME = @P_CTIME

	IF OBJECT_ID(N'tempdb..##GTB_HR_Z_KFI_SLIP', N'U') IS NOT NULL 
		DELETE ##GTB_HR_Z_KFI_SLIP WHERE ID_USER = @P_ID_USER AND CTIME = @P_CTIME

	IF OBJECT_ID(N'tempdb..##GTB_HR_SLIP', N'U') IS NOT NULL 
		DELETE ##GTB_HR_SLIP WHERE ID_USER = @P_ID_USER AND CTIME = @P_CTIME
		
	IF OBJECT_ID(N'tempdb..##GTB_HR_SLIP_DETAIL', N'U') IS NOT NULL 
		DELETE ##GTB_HR_SLIP_DETAIL WHERE ID_USER = @P_ID_USER AND CTIME = @P_CTIME
GO

