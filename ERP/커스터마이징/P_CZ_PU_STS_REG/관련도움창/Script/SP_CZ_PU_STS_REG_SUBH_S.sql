USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PU_STS_REG_SUBH_S]    Script Date: 2018-03-22 오후 5:35:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_PU_STS_REG_SUBH_S]
(
	@P_CD_COMPANY       NVARCHAR(7),
	@P_FG_IO			NVARCHAR(3),
	@P_DT_START			NVARCHAR(8),
	@P_DT_END			NVARCHAR(8),
	@P_CD_PARTNER		NVARCHAR(20),
	@P_NO_PROJECT		NVARCHAR(20),
	@P_NO_IO			NVARCHAR(20),
	@P_NO_PSO_MGMT		NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
	   OH.DT_IO,
	   OH.NO_IO,
	   MP.LN_PARTNER,
	   ME.NM_KOR 
FROM MM_QTIOH OH
JOIN (SELECT OL.CD_COMPANY, OL.NO_IO 
	  FROM MM_QTIO OL
	  LEFT JOIN (SELECT CD_COMPANY, NO_IO_MGMT, NO_IOLINE_MGMT,
	  			        SUM(QT_IO) AS QT_IO 
	  			 FROM MM_QTIO
	  			 GROUP BY CD_COMPANY, NO_IO_MGMT, NO_IOLINE_MGMT) OL1
	  ON OL1.CD_COMPANY = OL.CD_COMPANY AND OL1.NO_IO_MGMT = OL.NO_IO AND OL1.NO_IOLINE_MGMT = OL.NO_IOLINE
	  WHERE OL.FG_IO = @P_FG_IO
	  AND ISNULL(OL.QT_IO, 0) > ISNULL(OL1.QT_IO, 0)
	  AND (ISNULL(@P_NO_PROJECT, '') = '' OR OL.CD_PJT = @P_NO_PROJECT)
	  AND (ISNULL(@P_NO_PSO_MGMT, '') = '' OR OL.NO_PSO_MGMT LIKE @P_NO_PSO_MGMT + '%')
	  GROUP BY OL.CD_COMPANY, OL.NO_IO) OL
ON OL.CD_COMPANY = OH.CD_COMPANY AND OL.NO_IO = OH.NO_IO
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = OH.CD_COMPANY AND MP.CD_PARTNER = OH.CD_PARTNER
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = OH.CD_COMPANY AND ME.NO_EMP = OH.NO_EMP
WHERE OH.CD_COMPANY = @P_CD_COMPANY
AND OH.DT_IO BETWEEN @P_DT_START AND @P_DT_END
AND (ISNULL(@P_NO_IO, '') = '' OR OH.NO_IO = @P_NO_IO)
AND (ISNULL(@P_CD_PARTNER, '') = '' OR OH.CD_PARTNER = @P_CD_PARTNER)

GO

