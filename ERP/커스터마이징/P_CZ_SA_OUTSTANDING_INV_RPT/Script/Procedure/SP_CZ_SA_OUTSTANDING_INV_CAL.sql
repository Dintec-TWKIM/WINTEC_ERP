USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_OUTSTANDING_INVOICE_CAL]    Script Date: 2017-12-06 오후 2:56:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_OUTSTANDING_INV_CAL]
(
    @P_CD_COMPANY   NVARCHAR(7)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_DT_LAST_MONTH	NVARCHAR(6)
SET @V_DT_LAST_MONTH = LEFT(CONVERT(NVARCHAR(8), DATEADD(MM, -1, GETDATE()), 112), 6)

DELETE CZ_SA_OUTSTANDING_INV
WHERE CD_COMPANY = @P_CD_COMPANY
AND DT_MONTH = @V_DT_LAST_MONTH

INSERT INTO CZ_SA_OUTSTANDING_INV
(
	CD_COMPANY,
	CD_PARTNER,
	DT_MONTH,
	AM_IV,
	AM_RCP,
	AM_REMAIN,
	QT_REMAIN,
	AM_IV_MONTH,
	QT_IV_MONTH,
	AM_RCP_MONTH,
	QT_RCP_MONTH,
	DT_RETURN,
	DT_REMAIN,
	DTS_INSERT
)
SELECT MP.CD_COMPANY,
	   MP.CD_PARTNER,
	   @V_DT_LAST_MONTH AS DT_MONTH,
	   ISNULL(IH1.AM_IV, 0) AS AM_IV,
	   ISNULL(IH1.AM_RCP, 0) AS AM_RCP,
	   ISNULL(IH1.AM_REMAIN, 0) AS AM_REMAIN,
	   ISNULL(IH1.QT_REMAIN, 0) AS QT_REMAIN,
	   ISNULL(IH.AM_IV_MONTH, 0) AS AM_IV_MONTH,
	   ISNULL(IH.QT_IV_MONTH, 0) AS QT_IV_MONTH,
	   ISNULL(RH.AM_RCP_MONTH, 0) AS AM_RCP_MONTH,
	   ISNULL(RH.QT_RCP_MONTH, 0) AS QT_RCP_MONTH,
	   ISNULL(IH1.DT_RETURN, 0) AS DT_RETURN,
	   ISNULL(IH1.DT_REMAIN, 0) AS DT_REMAIN,
	   NEOE.SF_SYSDATE(GETDATE()) AS DTS_INSERT
FROM MA_PARTNER MP
LEFT JOIN (SELECT IH.CD_COMPANY, IH.CD_PARTNER,
		   		  SUM(ISNULL(IH.AM_K, 0) + ISNULL(IH.VAT_TAX, 0)) AS AM_IV_MONTH,
		   		  SUM(1) AS QT_IV_MONTH
		   FROM SA_IVH IH
		   WHERE LEFT(IH.DT_PROCESS, 6) = @V_DT_LAST_MONTH
		   GROUP BY IH.CD_COMPANY, IH.CD_PARTNER) IH
ON IH.CD_COMPANY = MP.CD_COMPANY AND IH.CD_PARTNER = MP.CD_PARTNER
LEFT JOIN (SELECT RH.CD_COMPANY, RH.CD_PARTNER,
		   		  SUM(ISNULL(RD.AM_RCP, 0)) AS AM_RCP_MONTH,
		   		  SUM(1) AS QT_RCP_MONTH
		   FROM SA_RCPH RH
		   JOIN (SELECT RD.CD_COMPANY, RD.NO_RCP,
		   		        (ISNULL(RD.AM_RCP_TX, 0) + ISNULL(RD.AM_PL, 0)) AS AM_RCP
		   		 FROM SA_RCPD RD 
		   		 UNION ALL
		   		 SELECT BD.CD_COMPANY, BD.NO_RCP,
		   		 	    (ISNULL(BD.AM_RCPS, 0) + ISNULL(BD.AM_PL, 0)) AS AM_RCP
		   		 FROM SA_BILLSD BD) RD
		   ON RD.CD_COMPANY = RH.CD_COMPANY AND RD.NO_RCP = RH.NO_RCP
		   WHERE LEFT(RH.DT_RCP, 6) = @V_DT_LAST_MONTH
		   GROUP BY RH.CD_COMPANY, RH.CD_PARTNER) RH
ON RH.CD_COMPANY = MP.CD_COMPANY AND RH.CD_PARTNER = MP.CD_PARTNER
LEFT JOIN (SELECT IH.CD_COMPANY, IH.CD_PARTNER,
		   		  SUM(IH.AM_IV) AS AM_IV,
		   		  SUM(IH.AM_RCP) AS AM_RCP,
		   		  SUM(IH.AM_REMAIN) AS AM_REMAIN,
		   		  SUM(IH.QT_REMAIN) AS QT_REMAIN,
		   		  (CASE WHEN SUM(IH.QT_RETURN) = 0 THEN 0 ELSE ROUND(CONVERT(FLOAT, SUM(IH.DT_RETURN)) / CONVERT(FLOAT, SUM(IH.QT_RETURN)), 2) END) AS DT_RETURN,
		   		  (CASE WHEN SUM(IH.QT_REMAIN) = 0 THEN 0 ELSE ROUND(CONVERT(FLOAT, SUM(IH.DT_REMAIN)) / CONVERT(FLOAT, SUM(IH.QT_REMAIN)), 2) END) AS DT_REMAIN
		   FROM (SELECT IH.CD_COMPANY,
		   	  			IH.NO_IV,
		   	  			IH.CD_PARTNER,
		   				(CASE WHEN ((ISNULL(IH.AM_K, 0) + ISNULL(IH.VAT_TAX, 0)) - ISNULL(RH.AM_RCP, 0)) = 0 THEN DATEDIFF(DAY, IH.DT_PROCESS, RH.DT_RCP) ELSE 0 END) AS DT_RETURN,
		   				(CASE WHEN ((ISNULL(IH.AM_K, 0) + ISNULL(IH.VAT_TAX, 0)) - ISNULL(RH.AM_RCP, 0)) > 0 THEN DATEDIFF(DAY, IH.DT_PROCESS, GETDATE()) ELSE 0 END) AS DT_REMAIN, 
		   	  			(ISNULL(IH.AM_K, 0) + ISNULL(IH.VAT_TAX, 0)) AS AM_IV,
		   	  			ISNULL(RH.AM_RCP, 0) AS AM_RCP,
		   	  			((ISNULL(IH.AM_K, 0) + ISNULL(IH.VAT_TAX, 0)) - ISNULL(RH.AM_RCP, 0)) AS AM_REMAIN,
		   				(CASE WHEN ((ISNULL(IH.AM_K, 0) + ISNULL(IH.VAT_TAX, 0)) - ISNULL(RH.AM_RCP, 0)) = 0 THEN 1 ELSE 0 END) AS QT_RETURN,
		   				(CASE WHEN ((ISNULL(IH.AM_K, 0) + ISNULL(IH.VAT_TAX, 0)) - ISNULL(RH.AM_RCP, 0)) > 0 THEN 1 ELSE 0 END) AS QT_REMAIN
		   		 FROM SA_IVH IH
		   		 LEFT JOIN (SELECT RH.CD_COMPANY,
		   		 			 	   RD.NO_IV,
		   		 			 	   MAX(RH.DT_RCP) AS DT_RCP,
		   		 			 	   SUM(RD.AM_RCP) AS AM_RCP
		   		 			FROM SA_RCPH RH
		   		 			LEFT JOIN (SELECT RD.CD_COMPANY, RD.NO_RCP, RD.NO_TX AS NO_IV,
		   		   		 					  (ISNULL(RD.AM_RCP_TX, 0) + ISNULL(RD.AM_PL, 0)) AS AM_RCP
		   		 					   FROM SA_RCPD RD 
		   		 					   UNION ALL
		   		 					   SELECT BD.CD_COMPANY, BD.NO_RCP, BD.NO_IV,
		   		   		 					  (ISNULL(BD.AM_RCPS, 0) + ISNULL(BD.AM_PL, 0)) AS AM_RCP
		   		 					   FROM SA_BILLSD BD) RD
		   		 			ON RD.CD_COMPANY = RH.CD_COMPANY AND RD.NO_RCP = RH.NO_RCP
		   		 			WHERE RD.NO_IV IS NOT NULL
		   		 			AND LEFT(RH.DT_RCP, 6) <= @V_DT_LAST_MONTH
		   		 			GROUP BY RH.CD_COMPANY, RD.NO_IV) RH
		   		 ON RH.CD_COMPANY = IH.CD_COMPANY AND RH.NO_IV = IH.NO_IV
		   		 WHERE LEFT(IH.DT_PROCESS, 6) <= @V_DT_LAST_MONTH) IH
		   GROUP BY IH.CD_COMPANY, IH.CD_PARTNER) IH1
ON IH1.CD_COMPANY = MP.CD_COMPANY AND IH1.CD_PARTNER = MP.CD_PARTNER
WHERE MP.CD_COMPANY = @P_CD_COMPANY
AND IH1.AM_IV > 0

GO

