USE [NEOE]
GO

/****** Object:  Trigger [NEOE].[TD_MA_PARTNER]    Script Date: 2017-01-04 오전 10:59:23 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER TRIGGER [NEOE].[TD_MA_PARTNER] ON [NEOE].[MA_PARTNER]
FOR DELETE
-- ==========================================
-- System			: 기준
-- Sub System		: 거래처정보
-- Page				: 거래처정보등록
-- Desc				: 거래처정보 삭제시 SA_TPPTR(파트너거래처등록)과 FI_PARTNO(세금계산서거래처)를 삭제한다.
--
-- Return Values
--
-- 작    성    자	: 
-- 작    성    일	: 2008.04.16
-- 수    정    자	: 허성철
-- ==========================================
-- Change History
-- ==========================================
-- ==========================================
AS
SET NOCOUNT ON

DECLARE	@V_CD_COMPANY	NVARCHAR(7),
		@V_CD_PARTNER	NVARCHAR(20),	
		@V_NO_COMPANY	NVARCHAR(20),
		@V_NO_DEPOSIT	NVARCHAR(40)

DECLARE CUR_TD_MA_PARTNER CURSOR FOR
		
SELECT	CD_COMPANY, CD_PARTNER, NO_COMPANY, NO_DEPOSIT
FROM	DELETED

OPEN  CUR_TD_MA_PARTNER

FETCH NEXT FROM CUR_TD_MA_PARTNER INTO @V_CD_COMPANY, @V_CD_PARTNER, @V_NO_COMPANY, @V_NO_DEPOSIT
WHILE @@FETCH_STATUS = 0
BEGIN
	IF NOT EXISTS (SELECT 1 FROM FI_TAX WHERE CD_COMPANY = @V_CD_COMPANY AND CD_PARTNER = @V_CD_PARTNER)
		DELETE	FROM  FI_PARTNO 
		WHERE CD_COMPANY = @V_CD_COMPANY AND CD_PARTNER = @V_CD_PARTNER

	DELETE FROM SA_TPPTR
	WHERE CD_COMPANY = @V_CD_COMPANY AND CD_PARTNER = @V_CD_PARTNER AND CD_TPPTR = @V_CD_PARTNER
	
	DELETE FROM MA_PARTNER_DEPOSIT
	WHERE CD_COMPANY = @V_CD_COMPANY AND CD_PARTNER = @V_CD_PARTNER AND NO_DEPOSIT = @V_NO_DEPOSIT

	--박진호 
	--2015.12.18 그룹웨어 DATA연동을 위한 DELETE날짜 등록
	--PIMS: D20161111044 한용일주임(2016.11.11)통화-> 실제사용업체 발생시 연락 주기로함(주석처리)
	--DELETE FROM MA_PARTNER_GW_DELETE
	--WHERE CD_COMPANY = @V_CD_COMPANY AND CD_PARTNER = @V_CD_PARTNER
	--INSERT INTO MA_PARTNER_GW_DELETE (CD_COMPANY,CD_PARTNER,GW_DELETE_TIME) VALUES (@V_CD_COMPANY,@V_CD_PARTNER,GETDATE())
             

	FETCH NEXT FROM CUR_TD_MA_PARTNER INTO @V_CD_COMPANY, @V_CD_PARTNER, @V_NO_COMPANY, @V_NO_DEPOSIT
END

CLOSE CUR_TD_MA_PARTNER
DEALLOCATE CUR_TD_MA_PARTNER

SET NOCOUNT OFF
GO

