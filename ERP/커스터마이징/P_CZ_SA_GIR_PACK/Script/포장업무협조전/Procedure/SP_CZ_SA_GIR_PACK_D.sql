USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIR_PACK_D]    Script Date: 2015-06-04 오전 8:47:35 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIR_PACK_D]  
(  
    @P_CD_COMPANY   NVARCHAR(7),        --회사
    @P_NO_GIR       NVARCHAR(20)        --의뢰번호
)
AS

DECLARE @V_ERRMSG		NVARCHAR(255)
DECLARE @V_NO_GIR_ORG	NVARCHAR(20) = NULL 
DECLARE @V_NO_PACK_ORG  NUMERIC(5, 0)

BEGIN TRAN SP_CZ_SA_GIR_PACK_D
BEGIN TRY

SELECT @V_NO_GIR_ORG = PH.NO_GIR_ORG,
       @V_NO_PACK_ORG = PH.NO_PACK_ORG
FROM CZ_SA_PACKH PH
JOIN CZ_SA_PACKH PH1 ON PH1.CD_COMPANY = PH.CD_COMPANY AND PH1.NO_GIR = PH.NO_GIR_ORG AND PH1.NO_PACK = PH.NO_PACK_ORG
WHERE PH.CD_COMPANY = @P_CD_COMPANY
AND PH.NO_GIR = @P_NO_GIR
AND PH1.CD_TYPE = '003'
AND PH1.YN_OUTSOURCING = 'Y'

IF @V_NO_GIR_ORG IS NOT NULL
BEGIN
	SELECT @V_ERRMSG = '외주목공포장 정보가 있는 협조전은 삭제 할 수 없습니다. (협조전 번호 : ' + @P_NO_GIR + ', 포장정보 : ' + ISNULL(@V_NO_GIR_ORG, '') + '-' + CONVERT(NVARCHAR, ISNULL(@V_NO_PACK_ORG, 0)) + ')'             
    GOTO ERROR
END
ELSE
BEGIN
	DELETE FROM CZ_SA_GIRL_PACK
	WHERE CD_COMPANY = @P_CD_COMPANY
	AND NO_GIR = @P_NO_GIR
	  
	DELETE FROM CZ_SA_GIRH_PACK  
	WHERE CD_COMPANY = @P_CD_COMPANY
	AND NO_GIR = @P_NO_GIR
	
	DELETE FROM CZ_SA_GIRH_PACK_DETAIL  
	WHERE CD_COMPANY = @P_CD_COMPANY
	AND NO_GIR = @P_NO_GIR
END

COMMIT TRAN SP_CZ_SA_GIR_PACK_D

END TRY
BEGIN CATCH
	ROLLBACK TRAN SP_CZ_SA_GIR_PACK_D
	SELECT @V_ERRMSG = ERROR_MESSAGE()
	GOTO ERROR
END CATCH

RETURN
ERROR: 
RAISERROR(@V_ERRMSG, 16, 1)
ROLLBACK TRAN SP_CZ_SA_GIR_PACK_D

GO

