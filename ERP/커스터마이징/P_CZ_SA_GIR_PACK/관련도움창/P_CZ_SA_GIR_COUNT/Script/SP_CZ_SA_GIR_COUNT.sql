USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIR_COUNT]    Script Date: 2015-06-02 오후 7:34:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
            
ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIR_COUNT]
(
    @P_CD_COMPANY    NVARCHAR(7)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT TOP 3 ROW_NUMBER() OVER (ORDER BY GD.DT_COMPLETE ASC) AS IDX,
			 GD.DT_COMPLETE,
			 COUNT(1) AS QT_TOTAL
FROM SA_GIRH GH
JOIN CZ_SA_GIRH_WORK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
WHERE GH.CD_COMPANY = @P_CD_COMPANY
AND GH.STA_GIR IN ('0', 'R', 'C')
AND ISNULL(GD.DT_COMPLETE, '') <> ''
AND GD.DT_COMPLETE >= CONVERT(VARCHAR(8), GETDATE(), 112)
AND NOT EXISTS (SELECT 1 
				FROM MA_CALENDAR MC
				WHERE MC.CD_COMPANY = GH.CD_COMPANY
				AND MC.DT_CAL = GD.DT_COMPLETE
				AND MC.FG1_HOLIDAY = 'H')
GROUP BY GD.DT_COMPLETE
ORDER BY GD.DT_COMPLETE ASC

GO