SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIR_AUTO_MAIL_PTR]        
(  
    @P_CD_COMPANY   NVARCHAR(7),
    @P_NO_GIR       NVARCHAR(20)
)   
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

;WITH A AS
(
    SELECT GH.CD_COMPANY,
           GH.NO_GIR,
           GH.CD_PARTNER,
           WD.NO_IMO
    FROM SA_GIRH GH
    LEFT JOIN CZ_SA_GIRH_WORK_DETAIL WD ON WD.CD_COMPANY = GH.CD_COMPANY AND WD.NO_GIR = GH.NO_GIR
    WHERE GH.CD_COMPANY = @P_CD_COMPANY
    AND GH.NO_GIR = @P_NO_GIR
    UNION ALL
    SELECT GH.CD_COMPANY,
           GH.NO_GIR,
           GH.CD_PARTNER,
           PD.NO_IMO 
    FROM CZ_SA_GIRH_PACK GH
    LEFT JOIN CZ_SA_GIRH_PACK_DETAIL PD ON PD.CD_COMPANY = GH.CD_COMPANY AND PD.NO_GIR = GH.NO_GIR 
    WHERE GH.CD_COMPANY = @P_CD_COMPANY
    AND GH.NO_GIR = @P_NO_GIR
)
SELECT (CASE WHEN AM.NO_GIR IS NOT NULL THEN 'Y' ELSE 'N' END) AS S, 
	   GH.CD_PARTNER,
       MP.LN_PARTNER,
       FP.SEQ,
       FP.NM_PTR,
       FP.NM_EMAIL,
       ISNULL(MV.YN_PACK, 'N') AS YN_PACK,
	   (CASE WHEN NEOE.CHECK_EMAIL(FP.NM_EMAIL) = 0 THEN 'N' ELSE 'Y' END) AS YN_CHECK
FROM A GH
JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
LEFT JOIN FI_PARTNERPTR FP ON FP.CD_COMPANY = GH.CD_COMPANY AND FP.CD_PARTNER = GH.CD_PARTNER
LEFT JOIN CZ_SA_GIR_AUTO_MAIL_PTR AM ON AM.CD_COMPANY = GH.CD_COMPANY AND AM.NO_GIR = GH.NO_GIR AND AM.CD_PARTNER = GH.CD_PARTNER AND AM.SEQ = FP.SEQ
LEFT JOIN CZ_SA_AUTO_MAIL_VESSEL MV ON MV.CD_COMPANY = GH.CD_COMPANY AND MV.CD_PARTNER = GH.CD_PARTNER AND MV.NO_IMO = GH.NO_IMO AND MV.SEQ = FP.SEQ
UNION ALL
SELECT (CASE WHEN AM.NO_GIR IS NOT NULL THEN 'Y' ELSE 'N' END) AS S,
       GH.CD_PARTNER,
       MP.LN_PARTNER,
       AM.SEQ AS SEQ,
       'ETC' AS NM_PTR,
       ISNULL(AM.DC_ETC, '') AS NM_EMAIL,
       'N' AS YN_PACK,
	   (CASE WHEN NEOE.CHECK_EMAIL(ISNULL(AM.DC_ETC, '')) = 0 THEN 'N' ELSE 'Y' END) AS YN_CHECK
FROM A GH
JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
JOIN CZ_SA_GIR_AUTO_MAIL_PTR AM ON AM.CD_COMPANY = GH.CD_COMPANY AND AM.NO_GIR = GH.NO_GIR AND AM.CD_PARTNER = GH.CD_PARTNER AND AM.SEQ < 0

GO