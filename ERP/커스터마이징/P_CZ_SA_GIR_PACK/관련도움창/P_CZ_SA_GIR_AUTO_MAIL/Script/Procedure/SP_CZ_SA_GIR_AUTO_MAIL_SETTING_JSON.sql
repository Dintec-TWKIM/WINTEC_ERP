USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIR_AUTO_MAIL_SETTING_JSON]    Script Date: 2017-01-05 오후 5:48:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIR_AUTO_MAIL_SETTING_JSON]          
(
	@P_JSON			NVARCHAR(MAX),
	@P_ID_USER		NVARCHAR(10)	
)  
AS
   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT * INTO #JSON
FROM OPENJSON(@P_JSON) WITH
(
	CD_COMPANY			NVARCHAR(7),
	NO_GIR				NVARCHAR(20),
	TP_SEND				NVARCHAR(3),
	TP_TRANS			NVARCHAR(4),
	YN_DHL				NVARCHAR(1),
	YN_FEDEX			NVARCHAR(1),
	YN_TPO				NVARCHAR(1),
	YN_SK				NVARCHAR(1),
	YN_SR				NVARCHAR(1),
	YN_ETC				NVARCHAR(1),
	CD_COUNTRY_DHL		NVARCHAR(4),
	CD_COUNTRY_FEDEX	NVARCHAR(4),
	DC_COUNTRY_ETC		NVARCHAR(100),
	CD_PARTNER_ETC		NVARCHAR(20),
	DC_CONSIGNEE		NVARCHAR(1000),
	DC_EMAIL_ETC		NVARCHAR(100)
) JS

IF EXISTS (SELECT 1 
		   FROM CZ_SA_GIR_AUTO_MAIL_SETTING AM
		   JOIN #JSON JS ON JS.CD_COMPANY = AM.CD_COMPANY AND JS.NO_GIR = AM.NO_GIR)
BEGIN
	UPDATE AM
	SET AM.TP_SEND = JS.TP_SEND,
		AM.TP_TRANS = JS.TP_TRANS,
		AM.YN_DHL = JS.YN_DHL,
		AM.YN_FEDEX = JS.YN_FEDEX,
		AM.YN_TPO = JS.YN_TPO,
		AM.YN_SK = JS.YN_SK,
		AM.YN_SR = JS.YN_SR,
		AM.YN_ETC = JS.YN_ETC,
		AM.CD_COUNTRY_DHL = JS.CD_COUNTRY_DHL,
		AM.CD_COUNTRY_FEDEX = JS.CD_COUNTRY_FEDEX,
		AM.DC_COUNTRY_ETC = JS.DC_COUNTRY_ETC,
		AM.CD_PARTNER_ETC = JS.CD_PARTNER_ETC,
		AM.DC_CONSIGNEE = JS.DC_CONSIGNEE,
		AM.DC_EMAIL_ETC = JS.DC_EMAIL_ETC,
		AM.ID_UPDATE = @P_ID_USER,
		AM.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	FROM CZ_SA_GIR_AUTO_MAIL_SETTING AM
	JOIN #JSON JS ON JS.CD_COMPANY = AM.CD_COMPANY AND JS.NO_GIR = AM.NO_GIR
END
ELSE
BEGIN
	INSERT INTO CZ_SA_GIR_AUTO_MAIL_SETTING
	(
		CD_COMPANY,
		NO_GIR,
		TP_SEND,
		TP_TRANS,
		YN_DHL,
		YN_FEDEX,
		YN_TPO,
		YN_SK,
		YN_SR,
		YN_ETC,
		CD_COUNTRY_DHL,
		CD_COUNTRY_FEDEX,
		DC_COUNTRY_ETC,
		CD_PARTNER_ETC,
		DC_CONSIGNEE,
		DC_EMAIL_ETC,
		ID_INSERT,
		DTS_INSERT
	)
	SELECT CD_COMPANY,
		   NO_GIR,
		   TP_SEND,
		   TP_TRANS,
		   YN_DHL,
		   YN_FEDEX,
		   YN_TPO,
		   YN_SK,
		   YN_SR,
		   YN_ETC,
		   CD_COUNTRY_DHL,
		   CD_COUNTRY_FEDEX,
		   DC_COUNTRY_ETC,
		   CD_PARTNER_ETC,
		   DC_CONSIGNEE,
		   DC_EMAIL_ETC,
		   @P_ID_USER,
		   NEOE.SF_SYSDATE(GETDATE())
	FROM #JSON
END

DROP TABLE #JSON

GO