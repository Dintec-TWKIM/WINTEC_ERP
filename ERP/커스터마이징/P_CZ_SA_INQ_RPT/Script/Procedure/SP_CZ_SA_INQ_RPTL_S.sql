USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_INQ_RPTL_S]    Script Date: 2015-07-08 오후 2:03:07 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_INQ_RPTL_S]  
(
    @P_CD_COMPANY			NVARCHAR(7),
	@P_LANGUAGE				NVARCHAR(5) = 'KR',
	@P_NO_KEY			    NVARCHAR(20),
	@P_CD_SUPPLIER			NVARCHAR(20),
	@P_TP_STEP				NVARCHAR(4)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT WL.CD_COMPANY,
	   WL.NO_KEY,
	   WL.TP_STEP,
	   (CASE WHEN @P_LANGUAGE = 'US' THEN MC.NM_SYSDEF_E
									 ELSE MC.NM_SYSDEF END) AS NM_STEP,
	   WL.NO_LINE,
	   WL.CD_SUPPLIER,
	   MP.LN_PARTNER AS NM_SUPPLIER,
	   WL.NM_FILE,
	   WL.NM_FILE_REAL,
	   'N' AS YN_DB_FILE,
	   WL.ID_INSERT,
	   MU.NM_USER AS NM_INSERT,
	   WL.DTS_INSERT,
	   WH.DC_RMK
FROM CZ_MA_WORKFLOWL WL
LEFT JOIN CZ_MA_WORKFLOWH WH ON WH.CD_COMPANY = WL.CD_COMPANY AND WH.TP_STEP = WL.TP_STEP AND WH.NO_KEY = WL.NO_KEY
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = WL.CD_COMPANY AND MP.CD_PARTNER = WL.CD_SUPPLIER
LEFT JOIN MA_USER MU ON MU.CD_COMPANY = WL.CD_COMPANY AND MU.ID_USER = WL.ID_INSERT
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = WL.CD_COMPANY AND MC.CD_FIELD = 'CZ_MA00005' AND MC.CD_SYSDEF = WL.TP_STEP
WHERE WL.CD_COMPANY = @P_CD_COMPANY 
AND WL.NO_KEY = @P_NO_KEY
AND (WL.YN_INCLUDED IS NULL OR WL.YN_INCLUDED = 'N')
AND ISNULL(WL.NM_FILE, '') <> ''
AND (ISNULL(@P_TP_STEP, '') = '' OR WL.TP_STEP = @P_TP_STEP)
UNION ALL
SELECT SA.CD_COMPANY,
	   SA.NO_FILE AS NO_KEY,
	   '04' AS TP_STEP,
	   MC.NM_SYSDEF AS NM_STEP,
	   SA.SEQ AS NO_LINE,
	   SA.CD_PARTNER AS CD_SUPPLIER,
	   MP.LN_PARTNER AS NM_SUPPLIER,
	   SA.FILE_NAME AS NM_FILE,
	   NULL AS NM_FILE_REAL,
	   'Y' AS YN_DB_FILE,
	   NULL AS ID_INSERT,
	   NULL AS NM_INSERT,
	   NULL AS DTS_INSERT,
	   WH.DC_RMK
FROM CZ_SRM_QTNH_ATTACHMENT SA
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = SA.CD_COMPANY AND MC.CD_FIELD = 'CZ_MA00005' AND MC.CD_SYSDEF = '04'
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = SA.CD_COMPANY AND MP.CD_PARTNER = SA.CD_PARTNER
LEFT JOIN CZ_MA_WORKFLOWH WH ON WH.CD_COMPANY = SA.CD_COMPANY AND WH.TP_STEP = '04' AND WH.NO_KEY = SA.NO_FILE
LEFT JOIN CZ_SRM_QTNH SQ ON SQ.CD_COMPANY = SA.CD_COMPANY AND SQ.CD_PARTNER = SA.CD_PARTNER AND SQ.NO_FILE = SA.NO_FILE
WHERE SA.CD_COMPANY = @P_CD_COMPANY 
AND SA.NO_FILE = @P_NO_KEY
AND SQ.CD_STATUS IN ('S', 'C')
AND ISNULL(SA.FILE_NAME, '') <> ''
AND (ISNULL(@P_TP_STEP, '') = '' OR '04' = @P_TP_STEP)
ORDER BY NO_KEY, TP_STEP, NO_LINE

GO