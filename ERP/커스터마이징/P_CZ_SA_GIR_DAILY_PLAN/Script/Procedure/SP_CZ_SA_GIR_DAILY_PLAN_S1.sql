USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIR_DAILY_PLAN_S1]    Script Date: 12/2/2015 10:10:47 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIR_DAILY_PLAN_S1]  
(
    @P_NO_GIR       NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT GH.STA_GIR,
       MH.NM_VESSEL,
       GH.CD_COMPANY,
       MC.NM_COMPANY,
       GH.NO_GIR,
       CD1.NM_SYSDEF AS NM_SUB_CATEGORY,
       MH.CALL_SIGN,
       STUFF((SELECT '+' + MC.CD_FLAG2 + CONVERT(VARCHAR, CONVERT(INT, PH.QT_WIDTH))
			  FROM CZ_SA_PACKH PH
			  JOIN MA_CODEDTL MC ON MC.CD_COMPANY = PH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00026' AND MC.CD_SYSDEF = PH.CD_TYPE
			  WHERE PH.CD_COMPANY = GH.CD_COMPANY
			  AND PH.NO_GIR = GH.NO_GIR
			  FOR XML PATH('')), 1,1, '')AS DC_RESULT_PACK,
	   STUFF((SELECT DISTINCT ',' + LEFT(GL.NO_SO, 2)
			  FROM SA_GIRL GL
			  WHERE GL.CD_COMPANY = GH.CD_COMPANY
			  AND GL.NO_GIR = GH.NO_GIR
			  FOR XML PATH('')), 1,1, '')AS NO_SO_PRE,
       WD.DC_RMK AS DC_RMK_GIR,
       WD.DC_RMK1,
       WD.DC_RMK3,
       '001' AS TP_PLAN,
       ISNULL(GP.SEQ_PLAN, 0) AS SEQ_PLAN,
       GP.DT_PLAN,
       GP.NO_EMP,
       ME.NM_KOR AS NM_EMP,
       GP.DC_RMK
FROM SA_GIRH GH
JOIN CZ_SA_GIRH_WORK_DETAIL WD ON WD.CD_COMPANY = GH.CD_COMPANY AND WD.NO_GIR = GH.NO_GIR
LEFT JOIN CZ_SA_GIR_PLAN GP ON GP.CD_COMPANY = GH.CD_COMPANY AND GP.NO_GIR = GH.NO_GIR AND GP.TP_PLAN = '001'
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = GP.CD_COMPANY AND ME.NO_EMP = GP.NO_EMP
LEFT JOIN MA_COMPANY MC ON MC.CD_COMPANY = GH.CD_COMPANY
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = WD.NO_IMO
LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = WD.CD_COMPANY AND CD.CD_FIELD = 'CZ_SA00006' AND CD.CD_SYSDEF = WD.CD_MAIN_CATEGORY
LEFT JOIN MA_CODEDTL CD1 ON CD1.CD_COMPANY = WD.CD_COMPANY AND CD1.CD_FIELD = CD.CD_FLAG1 AND CD1.CD_SYSDEF = WD.CD_SUB_CATEGORY
WHERE GH.CD_COMPANY IN ('K100', 'K200') 
AND (GH.STA_GIR IN ('O', 'R') OR ISNULL(GP.DT_PLAN, '') <> '')
AND GH.YN_RETURN = 'N'
AND WD.CD_MAIN_CATEGORY = '001'
AND (ISNULL(@P_NO_GIR, '') = '' OR GP.NO_GIR = @P_NO_GIR)
ORDER BY CD1.NM_SYSDEF, WD.NO_IMO

GO

