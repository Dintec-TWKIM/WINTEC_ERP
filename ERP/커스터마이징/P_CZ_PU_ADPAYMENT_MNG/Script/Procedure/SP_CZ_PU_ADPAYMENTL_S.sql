USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PU_ADPAYMENTL_S]    Script Date: 2015-05-28 오후 7:36:59 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_PU_ADPAYMENTL_S] 
(
	@P_CD_COMPANY   NVARCHAR(7),
	@P_FG_GUBON     NVARCHAR(1),
	@P_NO_KEY		NVARCHAR(20)
) 
AS 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF(@P_FG_GUBON = 'N') 
SELECT 'N' AS S,
	   '' AS NO_ADPAY,
	   0 AS NO_ADPAYLINE,
	   PL.NO_PO,
	   PL.NO_LINE AS NO_POLINE,
	   PL.CD_ITEM,
	   MI.NM_ITEM,
	   MI.STND_ITEM,
	   MI.UNIT_IM,
	   ISNULL(PL.QT_PO_MM, 0) AS QT_PO,
	   ISNULL(PL.QT_ADPAY_MM, 0) AS QT_ADPAY,
	   (ISNULL(PL.QT_PO_MM, 0) - ISNULL(PL.QT_ADPAY_MM, 0)) AS QT_REMAIN,
	   0.00 AS QT_PRE,
	   (PL.AM_EX + ROUND(PL.AM_EX * MC.RT_VAT, (CASE WHEN PL.CD_COMPANY = 'S100' OR PH.CD_EXCH <> '000' THEN 2 ELSE 0 END))) AS AM_EX,
	   PL.AM_EX_ADPAY,
	   ((PL.AM_EX + ROUND(PL.AM_EX * MC.RT_VAT, (CASE WHEN PL.CD_COMPANY = 'S100' OR PH.CD_EXCH <> '000' THEN 2 ELSE 0 END))) - ISNULL(PL.AM_EX_ADPAY, 0)) AS AM_EX_REMAIN,
	   0.00 AS AM_EX_PRE,
	   (PL.AM + PL.VAT) AS AM,
	   PL.AM_ADPAY,
	   ((PL.AM + PL.VAT) - ISNULL(PL.AM_ADPAY, 0)) AS AM_REMAIN,
	   0.00 AS AM_PRE,
	   '' AS DT_ADPAY,
	   PH.CD_EXCH,
	   ROUND(PH.RT_EXCH, 2) AS RT_EXCH,
	   '' AS YN_JEONJA,
	   '' AS TP_AIS,
	   '' AS DT_PAY_SCHEDULE,
	   '' AS PO_CONDITION,
	   '' AS DT_ACCT,
	   '250' AS NO_MODULE,
	   PL.CD_PLANT,
	   MP.CD_BIZAREA AS NO_BIZAREA,
	   AH.CD_DOCU,
	   ME.CD_DEPT
FROM PU_POL PL
LEFT JOIN PU_POH PH ON PH.CD_COMPANY = PL.CD_COMPANY AND PH.NO_PO = PL.NO_PO
LEFT JOIN PU_TPPO PT ON PT.CD_COMPANY = PH.CD_COMPANY AND PT.CD_TPPO = PH.CD_TPPO
LEFT JOIN MA_AISPOSTH AH ON AH.CD_COMPANY = PL.CD_COMPANY AND AH.CD_TP = PL.FG_PURCHASE AND AH.FG_TP = (CASE WHEN PT.YN_IMPORT = 'N' THEN '200' ELSE '600' END)
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = PH.CD_COMPANY AND ME.NO_EMP = PH.NO_EMP
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = PL.CD_COMPANY AND MI.CD_ITEM = PL.CD_ITEM
LEFT JOIN MA_PLANT MP ON MP.CD_COMPANY = PL.CD_COMPANY AND MP.CD_PLANT = PL.CD_PLANT
LEFT JOIN (SELECT CD_SYSDEF, 
				  ROUND(CONVERT(NUMERIC(17, 4), CASE WHEN ISNULL(CD_FLAG1, '') = '' THEN '0' ELSE CD_FLAG1 END) / 100, 2) AS RT_VAT 
		   FROM MA_CODEDTL
		   WHERE CD_COMPANY = @P_CD_COMPANY
		   AND CD_FIELD = 'MA_B000046') MC 
ON MC.CD_SYSDEF = PH.FG_TAX
WHERE PL.CD_COMPANY = @P_CD_COMPANY
AND PL.NO_PO = @P_NO_KEY
AND PL.FG_POST = 'R' -- 입고여부
AND ISNULL(PL.QT_PO_MM, 0) <> ISNULL(PL.QT_ADPAY_MM, 0)
ELSE 
SELECT 'N' AS S,
	   PA.NO_ADPAY,
	   PA.NO_ADPAYLINE,
	   PA.NO_PO,
	   PA.NO_POLINE,
	   PL.CD_ITEM,
	   MI.NM_ITEM,
	   MI.STND_ITEM,
	   MI.UNIT_IM,
	   ISNULL(PL.QT_PO_MM, 0) AS QT_PO,
	   ISNULL(PL.QT_ADPAY_MM, 0) AS QT_ADPAY,
	   (ISNULL(PL.QT_PO_MM, 0) - ISNULL(PL.QT_ADPAY_MM, 0)) AS QT_REMAIN,
	   ISNULL(PA.QT_ADPAY_MM, 0) AS QT_PRE,
	   (PL.AM_EX + ROUND(PL.AM_EX * MC.RT_VAT, (CASE WHEN PL.CD_COMPANY = 'S100' OR PH.CD_EXCH <> '000' THEN 2 ELSE 0 END))) AS AM_EX,
	   PL.AM_EX_ADPAY,
	   ((PL.AM_EX + ROUND(PL.AM_EX * MC.RT_VAT, (CASE WHEN PL.CD_COMPANY = 'S100' OR PH.CD_EXCH <> '000' THEN 2 ELSE 0 END))) - ISNULL(PL.AM_EX_ADPAY, 0)) AS AM_EX_REMAIN,
	   ISNULL(PA.AM_EX, 0) AS AM_EX_PRE,
	   (PL.AM + PL.VAT) AS AM,
	   PL.AM_ADPAY,
	   ((PL.AM + PL.VAT) - ISNULL(PL.AM_ADPAY, 0)) AS AM_REMAIN,
	   ISNULL(PA.AM, 0) AS AM_PRE,
	   PA.DT_ADPAY,
	   PA.CD_EXCH,
	   ROUND(PA.RT_EXCH, 2) AS RT_EXCH,
	   PA.YN_JEONJA,
	   PA.TP_AIS,
	   PA.DT_PAY_SCHEDULE,
	   PA.PO_CONDITION,
	   PA.DT_ACCT,
	   '250' AS NO_MODULE,
	   PA.CD_PLANT,
	   PA.NO_BIZAREA,
	   PA.CD_DOCU,
	   PA.CD_DEPT
FROM PU_ADPAYMENT PA
LEFT JOIN PU_POL PL ON PL.CD_COMPANY = PA.CD_COMPANY AND PL.NO_PO = PA.NO_PO AND PL.NO_LINE = PA.NO_POLINE 
LEFT JOIN PU_POH PH ON PH.CD_COMPANY = PL.CD_COMPANY AND PH.NO_PO = PL.NO_PO
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = PL.CD_COMPANY AND MI.CD_ITEM = PL.CD_ITEM
LEFT JOIN (SELECT CD_SYSDEF, 
				  ROUND(CONVERT(NUMERIC(17, 4), CASE WHEN ISNULL(CD_FLAG1, '') = '' THEN '0' ELSE CD_FLAG1 END) / 100, 2) AS RT_VAT 
		   FROM MA_CODEDTL
		   WHERE CD_COMPANY = @P_CD_COMPANY
		   AND CD_FIELD = 'MA_B000046') MC 
ON MC.CD_SYSDEF = PH.FG_TAX
WHERE PA.CD_COMPANY = @P_CD_COMPANY
AND PA.NO_ADPAY = @P_NO_KEY
--AND PL.FG_POST = 'R'
AND ISNULL(PA.TP_AIS, 'Y') = 'Y'

GO