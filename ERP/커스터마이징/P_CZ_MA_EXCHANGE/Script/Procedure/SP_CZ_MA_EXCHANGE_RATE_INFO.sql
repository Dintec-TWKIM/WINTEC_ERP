USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_EXCHANGE_RATE_INFO]    Script Date: 2015-06-23 오후 4:02:30 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_MA_EXCHANGE_RATE_INFO]
(
	@P_YYMMDD			NVARCHAR(8),
	@P_NO_SEQ			NUMERIC(2, 0),
	@P_QUOTATION_TIME	NVARCHAR(6),
	@P_SOURCE			NVARCHAR(3),
	@P_DESTINATION		NVARCHAR(3),
	@P_CD_COMPANY		NVARCHAR(7),
	@P_RATE_BASE		NUMERIC(11, 4),
	@P_RATE_SALE		NUMERIC(11, 4),
	@P_RATE_BUY			NUMERIC(11, 4),
	@P_ID_INSERT		NVARCHAR(15)
) AS
-- ================================================
-- AUTHOR      : 이대성
-- CREATE DATE : 2010.11.06
--               
-- MODULE      : 시스템관리
-- SYSTEM      : 시스템기준정보
-- SUBSYSTEM   : 
-- PAGE        : 환율정보등록
-- PROJECT     : P_MA_EXCHANGE
-- DESCRIPTION : 
-- ================================================ 
-- CHANGE HISTORY
-- v1.0 : 2010.11.06 이대성 - 네이버 환율정보 가져오기 추가
-- v1.1 : 2010.12.25 이대성 - 환율정보 가져오기 외환은행으로 수정
-- ================================================
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE	@V_SOURCE		NVARCHAR(3),
		@V_DESTINATION	NVARCHAR(3),
		@V_RATE_BASE	NUMERIC(11, 4),
		@V_RATE_SALE	NUMERIC(11, 4),
		@V_RATE_BUY		NUMERIC(11, 4)

SELECT  @V_SOURCE = CD_SYSDEF
FROM	MA_CODEDTL 
WHERE	CD_COMPANY = @P_CD_COMPANY AND CD_FIELD = 'MA_B000005' AND NM_SYSDEF = @P_SOURCE AND USE_YN = 'Y'

SELECT  @V_DESTINATION = CD_SYSDEF
FROM	MA_CODEDTL 
WHERE	CD_COMPANY = @P_CD_COMPANY AND CD_FIELD = 'MA_B000005' AND NM_SYSDEF = @P_DESTINATION AND USE_YN = 'Y'

IF NOT EXISTS(SELECT 1 FROM	MA_CODEDTL WHERE CD_COMPANY = @P_CD_COMPANY AND CD_FIELD = 'MA_B000005' AND	CD_SYSDEF = @V_SOURCE)
BEGIN
	RETURN
END

SELECT	@V_RATE_BASE = (@P_RATE_BASE / CASE WHEN CD_FLAG3 IS NULL OR CD_FLAG3 = '' THEN 1 ELSE CD_FLAG3 END),
		@V_RATE_SALE = (@P_RATE_SALE / CASE WHEN CD_FLAG3 IS NULL OR CD_FLAG3 = '' THEN 1 ELSE CD_FLAG3 END),
		@V_RATE_BUY = (@P_RATE_BUY / CASE WHEN CD_FLAG3 IS NULL OR CD_FLAG3 = '' THEN 1 ELSE CD_FLAG3 END)
FROM	MA_CODEDTL
WHERE	CD_COMPANY = @P_CD_COMPANY
AND		CD_FIELD = 'MA_B000005'
AND		CD_SYSDEF = @V_SOURCE


IF EXISTS(SELECT 1 FROM	MA_EXCHANGE WHERE YYMMDD = @P_YYMMDD AND NO_SEQ = @P_NO_SEQ AND CURR_SOUR = @V_SOURCE AND CURR_DEST = @V_DESTINATION AND CD_COMPANY = @P_CD_COMPANY)
BEGIN
	UPDATE MA_EXCHANGE 
	SET	YYMMDD = @P_YYMMDD,
		NO_SEQ = @P_NO_SEQ,
		QUOTATION_TIME = @P_QUOTATION_TIME,
		CURR_SOUR = @V_SOURCE, 
		CURR_DEST = @V_DESTINATION, 
		RATE_BASE = @P_RATE_BASE, 
		RATE_SALE = @P_RATE_SALE, 
		RATE_BUY = @P_RATE_BUY, 
		ID_UPDATE = @P_ID_INSERT, 
		DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	WHERE CD_COMPANY = @P_CD_COMPANY	
	AND	YYMMDD = @P_YYMMDD	
	AND	NO_SEQ = @P_NO_SEQ
	AND	CURR_SOUR = @V_SOURCE	
	AND	CURR_DEST = @V_DESTINATION
END
ELSE
BEGIN
INSERT INTO MA_EXCHANGE
(
	YYMMDD,
	NO_SEQ,
	QUOTATION_TIME,
	CURR_SOUR, 
	CURR_DEST, 
	CD_COMPANY, 
	RATE_BASE, 
	RATE_SALE, 
	RATE_BUY, 
	ID_INSERT, 
	DTS_INSERT
)
VALUES
(
	@P_YYMMDD,
	@P_NO_SEQ,
	@P_QUOTATION_TIME,
	@V_SOURCE, 
	@V_DESTINATION,
	@P_CD_COMPANY, 
	@V_RATE_BASE, 
	@V_RATE_SALE, 
	@V_RATE_BUY, 
	@P_ID_INSERT, 
	NEOE.SF_SYSDATE(GETDATE())
)
END

IF EXISTS(SELECT 1 FROM	CZ_MA_EXCHANGE WHERE YYMMDD = @P_YYMMDD AND NO_SEQ = @P_NO_SEQ AND CURR_SOUR = @V_SOURCE AND CURR_DEST = @V_DESTINATION AND CD_COMPANY = @P_CD_COMPANY)
BEGIN
	UPDATE CZ_MA_EXCHANGE 
	SET	YYMMDD = @P_YYMMDD,
		NO_SEQ = @P_NO_SEQ,
		CURR_SOUR = @V_SOURCE, 
		CURR_DEST = @V_DESTINATION, 
		ID_UPDATE = @P_ID_INSERT, 
		DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	WHERE CD_COMPANY = @P_CD_COMPANY	
	AND	YYMMDD = @P_YYMMDD	
	AND	NO_SEQ = @P_NO_SEQ
	AND	CURR_SOUR = @V_SOURCE	
	AND	CURR_DEST = @V_DESTINATION
END
ELSE
BEGIN
INSERT INTO CZ_MA_EXCHANGE
(
	YYMMDD,
	NO_SEQ,
	CURR_SOUR, 
	CURR_DEST, 
	CD_COMPANY, 
	ID_INSERT, 
	DTS_INSERT
)
VALUES
(
	@P_YYMMDD,
	@P_NO_SEQ,
	@V_SOURCE, 
	@V_DESTINATION,
	@P_CD_COMPANY, 
	@P_ID_INSERT, 
	NEOE.SF_SYSDATE(GETDATE())
)
END

GO

