USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_CRM_PARTNER_SUPPLIERH_S]    Script Date: 2018-06-01 오후 2:31:12 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [NEOE].[SP_CZ_SA_CRM_PARTNER_SUPPLIERH_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_CD_PARTNER		NVARCHAR(20),
	@P_DT_START			NVARCHAR(8),
	@P_DT_END			NVARCHAR(8)
) 
AS
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT QL.CD_SUPPLIER, MP.LN_PARTNER,
	   COUNT(DISTINCT QH.NO_FILE) AS QT_FILE,
	   SUM(QL.QT_ITEM) AS QT_ITEM,
	   SUM(QL.QT_ITEM_CHOICE) AS QT_ITEM_CHOICE,
	   ROUND((SUM(QL.QT_ITEM_CHOICE) / SUM(QL.QT_ITEM)) * 100, 2) AS RT_ITEM_CHOICE,
	   ROUND((SUM(QL.QT_ITEM) / MAX(QL1.QT_ITEM)) * 100, 2) AS RT_QTN,
	   ROUND((SUM(QL.QT_ITEM_CHOICE) / MAX(QL1.QT_ITEM)) * 100, 2) AS RT_CHOICE,
	   SUM(QL.AM_QTN) AS AM_QTN,
	   SUM(QL.AM_QTN1) AS AM_QTN1,
	   SUM(ISNULL(QL.AM_QTN, 0) - ISNULL(QL.AM_QTN1, 0)) AS AM_MINUS
FROM (SELECT QH.CD_COMPANY, QH.NO_FILE, QH.CD_PARTNER
	  FROM CZ_PU_QTNH QH
	  WHERE QH.CD_COMPANY = @P_CD_COMPANY
	  AND QH.CD_PARTNER = @P_CD_PARTNER
	  AND QH.DT_QTN BETWEEN @P_DT_START AND @P_DT_END
	  GROUP BY QH.CD_COMPANY, QH.NO_FILE, QH.CD_PARTNER) QH
JOIN (SELECT QL.CD_COMPANY, QL.NO_FILE, QL.CD_PARTNER,
			 QL1.CD_PARTNER AS CD_SUPPLIER,
			 SUM(1.0) AS QT_ITEM,
			 SUM(CASE WHEN QL1.YN_CHOICE = 'Y' THEN 1.0 ELSE 0 END) AS QT_ITEM_CHOICE,
			 SUM(QL.AM_KR) AS AM_QTN,
			 SUM(QL1.AM_KR) AS AM_QTN1
      FROM CZ_PU_QTNL QL
	  JOIN CZ_PU_QTNL QL1 ON QL1.CD_COMPANY = QL.CD_COMPANY AND QL1.NO_FILE = QL.NO_FILE AND QL1.NO_LINE = QL.NO_LINE
	  WHERE ISNULL(QL.CD_ITEM, '') NOT LIKE 'SD%'
	  AND ISNULL(QL.AM_KR, 0) <> 0
	  AND ISNULL(QL1.AM_KR, 0) <> 0
      GROUP BY QL.CD_COMPANY, QL.NO_FILE, QL.CD_PARTNER, QL1.CD_PARTNER) QL
ON QL.CD_COMPANY = QH.CD_COMPANY AND QL.NO_FILE = QH.NO_FILE AND QL.CD_PARTNER = QH.CD_PARTNER
JOIN (SELECT QH.CD_COMPANY, QH.CD_PARTNER,
	  	     SUM(1.0) AS QT_ITEM
	  FROM CZ_PU_QTNH QH
	  JOIN CZ_PU_QTNL QL ON QL.CD_COMPANY = QH.CD_COMPANY AND QL.CD_PARTNER = QH.CD_PARTNER AND QL.NO_FILE = QH.NO_FILE
	  WHERE QH.DT_QTN BETWEEN @P_DT_START AND @P_DT_END
	  AND ISNULL(QL.CD_ITEM, '') NOT LIKE 'SD%'
	  AND ISNULL(QL.AM_KR, 0) <> 0
	  GROUP BY QH.CD_COMPANY, QH.CD_PARTNER) QL1
ON QL1.CD_COMPANY = QH.CD_COMPANY AND QL1.CD_PARTNER = QH.CD_PARTNER
JOIN MA_PARTNER MP ON MP.CD_COMPANY = QL.CD_COMPANY AND MP.CD_PARTNER = QL.CD_SUPPLIER
GROUP BY QL.CD_SUPPLIER, MP.LN_PARTNER
ORDER BY SUM(QL.QT_ITEM_CHOICE) DESC

GO

