USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_CRM_PARTNER_STOCKH_S]    Script Date: 2018-05-14 오후 2:05:15 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_CRM_PARTNER_STOCKH_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_CD_PARTNER		NVARCHAR(20),
	@P_DT_START			NVARCHAR(8),
	@P_DT_END			NVARCHAR(8)
) 
AS
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT QH.CD_ITEM, QH.NM_ITEM,
	   QH.DT_QTN,
	   QH.DT_SO,
	   QH.QT_QTN,
	   QH.QT_STOCK,
	   ROUND(CASE WHEN ISNULL(QH.QT_QTN, 0) = 0 THEN 0 
											    ELSE (ISNULL(QH.QT_STOCK, 0) / ISNULL(QH.QT_QTN, 0)) * 100 END, 2) AS RT_SO,
	   (ISNULL(NI.QT_INV, 0) - ISNULL(SB.QT_REMAIN, 0)) AS QT_INV
FROM (SELECT QH.CD_COMPANY, QL.CD_ITEM, QL.NM_ITEM,
	  	     MAX(QH.DT_QTN) AS DT_QTN,
	  	     MAX(SH.DT_SO) AS DT_SO,
	  	     SUM(QL.QT_QTN) AS QT_QTN,
	  	     SUM(QL.QT_STOCK) AS QT_STOCK
	  FROM CZ_SA_QTNH QH
	  LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = QH.CD_COMPANY AND SH.NO_SO = QH.NO_FILE
	  JOIN (SELECT QL.CD_COMPANY, QL.NO_FILE, QL.CD_ITEM, MI.NM_ITEM,
	  			   SUM(QL.QT_QTN) AS QT_QTN,
	  			   SUM(SB.QT_STOCK) AS QT_STOCK
	  		FROM CZ_SA_QTNL QL
	  		LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = QL.CD_COMPANY AND SB.NO_FILE = QL.NO_FILE AND SB.NO_LINE = QL.NO_LINE
	  		LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = QL.CD_COMPANY AND MI.CD_ITEM = QL.CD_ITEM
	  		WHERE MI.CLS_ITEM = '009'
	  		GROUP BY QL.CD_COMPANY, QL.NO_FILE, QL.CD_ITEM, MI.NM_ITEM) QL
	  ON QL.CD_COMPANY = QH.CD_COMPANY AND QL.NO_FILE = QH.NO_FILE
	  WHERE QH.CD_COMPANY = @P_CD_COMPANY
      AND QH.CD_PARTNER = @P_CD_PARTNER
	  AND QH.DT_QTN BETWEEN @P_DT_START AND @P_DT_END
	  GROUP BY QH.CD_COMPANY, QL.CD_ITEM, QL.NM_ITEM) QH
LEFT JOIN (SELECT CD_COMPANY, 
				  CD_ITEM, 
				  (QT_GOOD_OPEN + QT_GOOD_GR - QT_GOOD_GI) AS QT_INV
		   FROM MM_PINVN
		   WHERE P_YR = CONVERT(NVARCHAR(4), GETDATE(), 112)
		   AND CD_SL = 'SL02') NI
ON NI.CD_COMPANY = QH.CD_COMPANY AND NI.CD_ITEM = QH.CD_ITEM
LEFT JOIN (SELECT SB.CD_COMPANY, SB.CD_ITEM,
				  SUM(ISNULL(SB.QT_BOOK, 0) - (ISNULL(GL.QT_GI, 0) + ISNULL(EL.QT_GI, 0))) AS QT_REMAIN 
		   FROM CZ_SA_STOCK_BOOK SB
		   LEFT JOIN (SELECT GL.CD_COMPANY, GL.NO_SO, GL.SEQ_SO,
							 SUM(GL.QT_GIR_STOCK) AS QT_GI 
					  FROM SA_GIRL GL
					  WHERE GL.QT_GIR_STOCK > 0
					  AND GL.QT_GI > 0
					  AND GL.YN_GI_STOCK = 'Y'
					  GROUP BY GL.CD_COMPANY, GL.NO_SO, GL.SEQ_SO) GL 
		   ON GL.CD_COMPANY = SB.CD_COMPANY AND GL.NO_SO = SB.NO_FILE AND GL.SEQ_SO = SB.NO_LINE
		   LEFT JOIN (SELECT CD_COMPANY, NO_SO, SEQ_SO,
							 SUM(QT_GI) AS QT_GI 
					  FROM MM_GIREQL
					  WHERE CD_SL = 'SL02'
					  AND CD_GRSL = 'SL03'
		              GROUP BY CD_COMPANY, NO_SO, SEQ_SO) EL
		   ON EL.CD_COMPANY = SB.CD_COMPANY AND EL.NO_SO = SB.NO_FILE AND EL.SEQ_SO = SB.NO_LINE
		   GROUP BY SB.CD_COMPANY, SB.CD_ITEM) SB
ON SB.CD_COMPANY = QH.CD_COMPANY AND SB.CD_ITEM = QH.CD_ITEM
ORDER BY QH.QT_QTN DESC

GO

