USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_CUST_REL_MNGH_S]    Script Date: 2017-05-23 오전 9:44:28 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_CRM_PARTNER_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_CD_PARTNER		NVARCHAR(20),
	@P_DT_START			NVARCHAR(8),
	@P_DT_END			NVARCHAR(8)
) 
AS
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT MP.LN_PARTNER,
	   MP.FG_PARTNER,
	   MP.CLS_PARTNER,
	   MP.NO_COMPANY,
	   MP.NM_CEO,
	   MP.NO_RES,
	   MP.CD_AREA,
	   MP.CD_NATION,
	   MP.NO_POST1,
	   MP.DC_ADS1_H,
	   MP.DC_ADS1_D,
	   MP.CD_PARTNER_GRP,
	   MP.CD_PARTNER_GRP_2,
	   MP.NO_TEL1,
	   MP.NO_FAX1,
	   MP.TP_JOB,
	   MP.CLS_JOB,
	   MP.URL_PARTNER,
	   ISNULL(QH.AM_SO, 0) AS AM_SO,
	   (ISNULL(QH.AM_SO, 0) - (ISNULL(QH.AM_STOCK, 0) + ISNULL(QH.AM_PO, 0))) AS AM_PROFIT,
	   (CASE WHEN ISNULL(QH.AM_SO, 0) = 0 THEN 0
										  ELSE ROUND(((ISNULL(QH.AM_SO, 0) - (ISNULL(QH.AM_STOCK, 0) + ISNULL(QH.AM_PO, 0))) / ISNULL(QH.AM_SO, 0)) * 100, 2) END) AS RT_PROFIT,
	   (CASE WHEN ISNULL(QH.QT_QTN, 0) = 0 THEN 0
										   ELSE ROUND((ISNULL(QH.QT_SO, 0) / ISNULL(QH.QT_QTN, 0)) * 100, 2) END) AS RT_SO,
	   IH.DT_RETURN,
	   MP1.RT_SALES_PROFIT,
	   MP1.RT_SALES_DC,
	   MP1.RT_COMMISSION,
	   MP1.DC_COMMISSION,
	   MP1.DC_PHOTO
FROM MA_PARTNER MP
LEFT JOIN CZ_MA_PARTNER MP1 ON MP1.CD_COMPANY = MP.CD_COMPANY AND MP1.CD_PARTNER = MP.CD_PARTNER
LEFT JOIN (SELECT QH.CD_COMPANY, 
		   		  QH.CD_PARTNER,
		   		  SUM(1.0) AS QT_QTN,
		   		  SUM(CASE WHEN SH.CD_COMPANY IS NULL THEN 0 ELSE 1.0 END) AS QT_SO,
		   		  SUM(QL.AM_SO) AS AM_SO,
		   		  SUM(QL.AM_STOCK) AS AM_STOCK,
		   		  SUM(QL.AM_PO) AS AM_PO
		   FROM CZ_SA_QTNH QH
		   LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = QH.CD_COMPANY AND SH.NO_SO = QH.NO_FILE
		   JOIN (SELECT QL.CD_COMPANY, QL.NO_FILE,
		   		 	    SUM(SL.AM_KR_S) AS AM_SO,
		   		 	    SUM(ISNULL(SB.QT_STOCK, 0) * ISNULL(SB.UM_KR, 0)) AS AM_STOCK,
		   		 	    SUM(PL.AM_PO) AS AM_PO 
		   		 FROM CZ_SA_QTNL QL
		   		 LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = QL.CD_COMPANY AND SL.NO_SO = QL.NO_FILE AND SL.SEQ_SO = QL.NO_LINE
		   		 LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = QL.CD_COMPANY AND SB.NO_FILE = QL.NO_FILE AND SB.NO_LINE = QL.NO_LINE
		   		 LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE,
		   		 		 		   SUM(PL.AM) AS AM_PO 
		   		 			FROM PU_POL PL
		   		 		    GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE) PL
		   		 ON PL.CD_COMPANY = SL.CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.NO_SOLINE = SL.SEQ_SO
		   		 WHERE ISNULL(QL.CD_ITEM, '') NOT LIKE 'SD%'
		   		 GROUP BY QL.CD_COMPANY, QL.NO_FILE) QL
		   ON QL.CD_COMPANY = QH.CD_COMPANY AND QL.NO_FILE = QH.NO_FILE
		   WHERE QH.CD_COMPANY = @P_CD_COMPANY
		   AND QH.DT_QTN BETWEEN @P_DT_START AND @P_DT_END
		   GROUP BY QH.CD_COMPANY, QH.CD_PARTNER) QH
ON QH.CD_COMPANY = MP.CD_COMPANY AND QH.CD_PARTNER = MP.CD_PARTNER
LEFT JOIN (SELECT IH.CD_COMPANY, 
				  IH.CD_PARTNER,
		   		  AVG(DATEDIFF(DAY, ISNULL(IH.DT_PROCESS, ''), ISNULL(RH.DT_RCP, ''))) DT_RETURN
		   FROM SA_IVH IH
		   JOIN (SELECT RH.CD_COMPANY, 
			     	    RH.DT_RCP,
			     	    RD.NO_IV
			     FROM SA_RCPH RH
			     JOIN (SELECT RD.CD_COMPANY, 
			     	   		  RD.NO_RCP,
			     	   		  RD.NO_TX AS NO_IV
			     	   FROM SA_RCPD RD 
			     	   UNION
			     	   SELECT BD.CD_COMPANY,
			     	   		  BD.NO_RCP,
			     	   		  BD.NO_IV
			     	   FROM SA_BILLSD BD) RD
			     ON RD.CD_COMPANY = RH.CD_COMPANY AND RD.NO_RCP = RH.NO_RCP) RH
		   ON RH.CD_COMPANY = IH.CD_COMPANY AND RH.NO_IV = IH.NO_IV
		   WHERE IH.CD_COMPANY = @P_CD_COMPANY
		   AND IH.DT_PROCESS BETWEEN @P_DT_START AND @P_DT_END
		   GROUP BY IH.CD_COMPANY, IH.CD_PARTNER) IH
ON IH.CD_COMPANY = MP.CD_COMPANY AND IH.CD_PARTNER = MP.CD_PARTNER
WHERE MP.CD_COMPANY = @P_CD_COMPANY
AND MP.CD_PARTNER = @P_CD_PARTNER

GO

