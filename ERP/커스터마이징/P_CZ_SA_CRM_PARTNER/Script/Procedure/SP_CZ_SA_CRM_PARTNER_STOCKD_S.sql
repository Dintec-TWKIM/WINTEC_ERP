USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_CRM_PARTNER_STOCKD_S]    Script Date: 2018-05-14 오후 2:05:37 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_CRM_PARTNER_STOCKD_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_CD_PARTNER		NVARCHAR(20),
	@P_CD_ITEM			NVARCHAR(20),
	@P_NO_IMO			NVARCHAR(10),
	@P_DT_START			NVARCHAR(8),
	@P_DT_END			NVARCHAR(8)
) 
AS
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT QH.NO_IMO,
	   QL.CD_ITEM,
	   QH.NO_FILE,
	   ME.NM_KOR AS NM_EMP,
	   QH.DT_QTN,
	   SH.DT_SO,
	   QL.QT_QTN,
	   QL.QT_STOCK,
	   QL.UM_SO_QTN,
	   QL.UM_PO_QTN,
	   QL.UM_SO,
	   QL.UM_STOCK,
	   QL.AM_SO_QTN,
	   QL.AM_PO_QTN,
	   QL.AM_SO,
	   QL.AM_STOCK,
	   ROUND(CASE WHEN ISNULL(QL.QT_QTN, 0) = 0 THEN 0 
									            ELSE (ISNULL(QL.QT_STOCK, 0) / ISNULL(QL.QT_QTN, 0)) * 100 END, 2) AS RT_SO,
	   ROUND(CASE WHEN ISNULL(QL.AM_SO_QTN, 0) = 0 THEN 0 
									               ELSE ((ISNULL(QL.AM_SO_QTN, 0) - ISNULL(QL.AM_PO_QTN, 0)) / ISNULL(QL.AM_SO_QTN, 0)) * 100 END, 2) AS RT_QTN_PROFIT,
	   ROUND(CASE WHEN ISNULL(QL.AM_SO, 0) = 0 THEN 0 
									           ELSE ((ISNULL(QL.AM_SO, 0) - ISNULL(QL.AM_STOCK, 0)) / ISNULL(QL.AM_SO, 0)) * 100 END, 2) AS RT_SO_PROFIT
FROM CZ_SA_QTNH QH
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = QH.CD_COMPANY AND SH.NO_SO = QH.NO_FILE
JOIN (SELECT QL.CD_COMPANY, QL.NO_FILE, QL.CD_ITEM,
			 SUM(QL.QT_QTN) AS QT_QTN,
			 SUM(SB.QT_STOCK) AS QT_STOCK,
			 MAX(QL.UM_KR_S) AS UM_SO_QTN,
			 MAX(QL.UM_KR_P) AS UM_PO_QTN,
			 MAX(SL.UM_KR_S) AS UM_SO,
			 MAX(SB.UM_KR) AS UM_STOCK,
		     SUM(QL.AM_KR_S) AS AM_SO_QTN,
		     SUM(QL.AM_KR_P) AS AM_PO_QTN,
		     SUM(ISNULL(SL.UM_KR_S, 0) * ISNULL(SB.QT_STOCK, 0)) AS AM_SO,
		     SUM(ISNULL(SB.UM_KR, 0) * ISNULL(SB.QT_STOCK, 0)) AS AM_STOCK
	  FROM CZ_SA_QTNL QL
	  LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = QL.CD_COMPANY AND SL.NO_SO = QL.NO_FILE AND SL.SEQ_SO = QL.NO_LINE
	  LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = QL.CD_COMPANY AND SB.NO_FILE = QL.NO_FILE AND SB.NO_LINE = QL.NO_LINE
	  LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = QL.CD_COMPANY AND MI.CD_ITEM = QL.CD_ITEM
	  WHERE MI.CLS_ITEM = '009'
	  AND QL.CD_ITEM = @P_CD_ITEM
	  GROUP BY QL.CD_COMPANY, QL.NO_FILE, QL.CD_ITEM) QL
ON QL.CD_COMPANY = QH.CD_COMPANY AND QL.NO_FILE = QH.NO_FILE
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = QH.CD_COMPANY AND ME.NO_EMP = QH.NO_EMP
WHERE QH.CD_COMPANY = @P_CD_COMPANY
AND QH.CD_PARTNER = @P_CD_PARTNER
AND QH.NO_IMO = @P_NO_IMO
AND QH.DT_QTN BETWEEN @P_DT_START AND @P_DT_END
ORDER BY QH.DT_QTN DESC

GO

