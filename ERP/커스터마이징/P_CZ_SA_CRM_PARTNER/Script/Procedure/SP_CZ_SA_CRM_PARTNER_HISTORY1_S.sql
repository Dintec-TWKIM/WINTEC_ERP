USE [NEOE]
GO
/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_CRM_PARTNER_HISTORY1_S]    Script Date: 2017-05-25 오후 1:06:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_CRM_PARTNER_HISTORY1_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_CD_PARTNER		NVARCHAR(20),
	@P_DT_START			NVARCHAR(8),
	@P_DT_END			NVARCHAR(8)
) 
AS
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT QH.NO_FILE,
	   MH.NM_VESSEL,
	   ME.NM_KOR AS NM_EMP,
	   IG.NM_ITEMGRP,
	   QH.DT_INQ,
	   QH.DT_QTN,
	   SH.DT_SO,
	   1.0 AS QT_QTN,
	   (CASE WHEN SH.CD_COMPANY IS NULL THEN 0 ELSE 1.0 END) AS QT_SO,
	   QL.AM_SO_QTN,
	   QL.AM_PO_QTN,
	   QL.AM_SO,
	   QL.AM_PO,
	   QL.AM_STOCK,
	   (ISNULL(QL.AM_SO_QTN, 0) - ISNULL(QL.AM_PO_QTN, 0)) AS AM_PROFIT_QTN,
	   (ISNULL(QL.AM_SO, 0) - (ISNULL(QL.AM_PO, 0) + ISNULL(QL.AM_STOCK, 0))) AS AM_PROFIT,
	   ROUND(CASE WHEN ISNULL(QL.AM_SO_QTN, 0) = 0 THEN 0 
	   									           ELSE ((ISNULL(QL.AM_SO_QTN, 0) - ISNULL(QL.AM_PO_QTN, 0)) / ISNULL(QL.AM_SO_QTN, 0)) * 100 END, 2) AS RT_PROFIT_QTN,
	   ROUND(CASE WHEN ISNULL(QL.AM_SO, 0) = 0 THEN 0 
	   									       ELSE ((ISNULL(QL.AM_SO, 0) - (ISNULL(QL.AM_PO, 0) + ISNULL(QL.AM_STOCK, 0))) / ISNULL(QL.AM_SO, 0)) * 100 END, 2) AS RT_PROFIT
FROM CZ_SA_QTNH QH
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = QH.CD_COMPANY AND SH.NO_SO = QH.NO_FILE
JOIN (SELECT QL.CD_COMPANY, QL.NO_FILE,
			 MAX(QL.GRP_ITEM) AS GRP_ITEM,
			 SUM(QL.AM_KR_S) AS AM_SO_QTN,
			 SUM(QL.AM_KR_P) AS AM_PO_QTN,
			 SUM(SL.AM_KR_S) AS AM_SO,
			 SUM(ISNULL(SB.UM_KR, 0) * ISNULL(SB.QT_STOCK, 0)) AS AM_STOCK,
			 SUM(PL.AM_PO) AS AM_PO
	  FROM CZ_SA_QTNL QL
	  LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = QL.CD_COMPANY AND SL.NO_SO = QL.NO_FILE AND SL.SEQ_SO = QL.NO_LINE
	  LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO
	  LEFT JOIN (SELECT CD_COMPANY, NO_SO, NO_SOLINE,
					    SUM(AM) AS AM_PO 
				 FROM PU_POL
				 GROUP BY CD_COMPANY, NO_SO, NO_SOLINE) PL
	  ON PL.CD_COMPANY = SL.CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.NO_SOLINE = SL.SEQ_SO
	  WHERE ISNULL(QL.CD_ITEM, '') NOT LIKE 'SD%'
	  GROUP BY QL.CD_COMPANY, QL.NO_FILE) QL
ON QL.CD_COMPANY = QH.CD_COMPANY AND QL.NO_FILE = QH.NO_FILE
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = QH.NO_IMO
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = QH.CD_COMPANY AND ME.NO_EMP = QH.NO_EMP
LEFT JOIN MA_ITEMGRP IG ON IG.CD_COMPANY = QL.CD_COMPANY AND IG.USE_YN = 'Y' AND IG.CD_ITEMGRP = QL.GRP_ITEM
WHERE QH.CD_COMPANY = @P_CD_COMPANY
AND QH.CD_PARTNER = @P_CD_PARTNER
AND QH.DT_QTN BETWEEN @P_DT_START AND @P_DT_END

GO