USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_CRM_PARTNER_PIC_PEOPLE_S]    Script Date: 2018-04-10 오후 3:59:54 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO







ALTER PROCEDURE [NEOE].[SP_CZ_SA_CRM_PARTNER_PIC_PEOPLE_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_CD_PARTNER		NVARCHAR(20),
	@P_SEQ				NUMERIC(5, 0)
) 
AS
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

WITH TREE_QUERY AS (
	SELECT PP.CD_COMPANY,
		   PP.CD_PARTNER,
		   PP.SEQ,
		   PP.CD_PARTNER_SUB,
		   PP.SEQ_SUB,
		   PP.DC_RMK,
		   CONVERT(NVARCHAR(MAX), PP.CD_PARTNER_SUB + '-' + CONVERT(NVARCHAR, PP.SEQ_SUB)) AS SORT,
		   CONVERT(NVARCHAR(MAX), MP.LN_PARTNER + '-' + FP.NM_PTR) AS NM_DEPTH,
		   '1' AS LEVEL
	FROM CZ_CRM_PARTNER_PIC_PEOPLE PP
	JOIN MA_PARTNER MP ON MP.CD_COMPANY = PP.CD_COMPANY AND MP.CD_PARTNER = PP.CD_PARTNER_SUB
	JOIN FI_PARTNERPTR FP ON FP.CD_COMPANY = PP.CD_COMPANY AND FP.CD_PARTNER = PP.CD_PARTNER_SUB AND FP.SEQ = PP.SEQ_SUB
    WHERE PP.CD_COMPANY = @P_CD_COMPANY
	AND PP.CD_PARTNER = @P_CD_PARTNER
	AND PP.SEQ = @P_SEQ
	UNION ALL
	SELECT TQ.CD_COMPANY,
		   TQ.CD_PARTNER,
		   TQ.SEQ,
		   PP.CD_PARTNER_SUB,
		   PP.SEQ_SUB,
		   PP.DC_RMK,
		   CONVERT(NVARCHAR(MAX), TQ.SORT + ' -> ' + PP.CD_PARTNER_SUB + '-' + CONVERT(NVARCHAR, PP.SEQ_SUB)) AS SORT,
		   CONVERT(NVARCHAR(MAX), TQ.NM_DEPTH + ' -> ' + MP.LN_PARTNER + '-' + FP.NM_PTR) AS NM_DEPTH,
		   '2' AS LEVEL
	FROM TREE_QUERY TQ
	JOIN CZ_CRM_PARTNER_PIC_PEOPLE PP ON PP.CD_COMPANY = TQ.CD_COMPANY AND PP.CD_PARTNER = TQ.CD_PARTNER_SUB AND PP.SEQ = TQ.SEQ_SUB
	JOIN MA_PARTNER MP ON MP.CD_COMPANY = PP.CD_COMPANY AND MP.CD_PARTNER = PP.CD_PARTNER_SUB
	JOIN FI_PARTNERPTR FP ON FP.CD_COMPANY = PP.CD_COMPANY AND FP.CD_PARTNER = PP.CD_PARTNER_SUB AND FP.SEQ = PP.SEQ_SUB
),
TREE_QUERY1 AS (
	SELECT PP.CD_COMPANY,
		   PP.CD_PARTNER_SUB AS CD_PARTNER,
		   PP.SEQ_SUB AS SEQ,
		   PP.CD_PARTNER AS CD_PARTNER_SUB,
		   PP.SEQ AS SEQ_SUB,
		   PP.DC_RMK,
		   CONVERT(NVARCHAR(MAX), PP.CD_PARTNER + '-' + CONVERT(NVARCHAR, PP.SEQ)) AS SORT,
		   CONVERT(NVARCHAR(MAX), MP.LN_PARTNER + '-' + FP.NM_PTR) AS NM_DEPTH
	FROM CZ_CRM_PARTNER_PIC_PEOPLE PP
	JOIN MA_PARTNER MP ON MP.CD_COMPANY = PP.CD_COMPANY AND MP.CD_PARTNER = PP.CD_PARTNER
	JOIN FI_PARTNERPTR FP ON FP.CD_COMPANY = PP.CD_COMPANY AND FP.CD_PARTNER = PP.CD_PARTNER AND FP.SEQ = PP.SEQ
    WHERE PP.CD_COMPANY = @P_CD_COMPANY
	AND PP.CD_PARTNER_SUB = @P_CD_PARTNER
	AND PP.SEQ_SUB = @P_SEQ
	UNION ALL
	SELECT TQ.CD_COMPANY,
		   TQ.CD_PARTNER,
		   TQ.SEQ,
		   PP.CD_PARTNER AS CD_PARTNER_SUB,
		   PP.SEQ AS SEQ_SUB,
		   PP.DC_RMK,
		   CONVERT(NVARCHAR(MAX), PP.CD_PARTNER + '-' + CONVERT(NVARCHAR, PP.SEQ) + ' -> ' + TQ.SORT) AS SORT,
		   CONVERT(NVARCHAR(MAX), MP.LN_PARTNER + '-' + FP.NM_PTR + ' -> ' + TQ.NM_DEPTH) AS NM_DEPTH
	FROM TREE_QUERY1 TQ
	JOIN CZ_CRM_PARTNER_PIC_PEOPLE PP ON PP.CD_COMPANY = TQ.CD_COMPANY AND PP.CD_PARTNER_SUB = TQ.CD_PARTNER_SUB AND PP.SEQ_SUB = TQ.SEQ_SUB
	JOIN MA_PARTNER MP ON MP.CD_COMPANY = PP.CD_COMPANY AND MP.CD_PARTNER = PP.CD_PARTNER
	JOIN FI_PARTNERPTR FP ON FP.CD_COMPANY = PP.CD_COMPANY AND FP.CD_PARTNER = PP.CD_PARTNER AND FP.SEQ = PP.SEQ
)
SELECT 'Y' AS YN_AUTO,
       TQ.CD_COMPANY,
	   TQ.CD_PARTNER,
	   TQ.SEQ,
	   FP1.CD_RANK,
	   TQ.CD_PARTNER_SUB,
	   TQ.SEQ_SUB,
       MP.LN_PARTNER,
	   (CASE WHEN ISNULL(FP.EN_PTR, '') = '' THEN FP.NM_PTR ELSE FP.NM_PTR + ' (' + ISNULL(FP.EN_PTR, '') + ')' END) AS NM_PTR,
	   (CASE WHEN ISNULL(FP.NM_DUTY_RESP, '') = '' AND ISNULL(FP.EN_DUTY_RESP, '') = '' THEN FP.NM_DEPT
			 WHEN ISNULL(FP.EN_DUTY_RESP, '') = '' THEN FP.NM_DEPT + '/' + ISNULL(FP.NM_DUTY_RESP, '')
			 WHEN ISNULL(FP.NM_DUTY_RESP, '') = '' THEN FP.NM_DEPT + '/' + ISNULL(FP.EN_DUTY_RESP, '')
			 ELSE FP.NM_DEPT + '/' + ISNULL(FP.NM_DUTY_RESP, '') + ' (' + ISNULL(FP.EN_DUTY_RESP, '') + ')' END) AS NM_DEPT_DUTY,
	   (CASE WHEN ISNULL(FP.NO_FAX, '') = '' AND ISNULL(FP.NO_TEL, '') = '' THEN NULL
		     WHEN ISNULL(FP.NO_FAX, '') = '' THEN 'TEL : ' + FP.NO_TEL 
		     WHEN ISNULL(FP.NO_TEL, '') = '' THEN 'FAX : ' + ISNULL(FP.NO_FAX, '')
			 ELSE 'TEL : ' + FP.NO_TEL + ' / FAX : ' + ISNULL(FP.NO_FAX, '') END) AS NO_TEL,
	   (CASE WHEN ISNULL(FP.NO_HP, '') = '' THEN NULL ELSE 'HP : ' + FP.NO_HP END) AS NO_HP,
	   (CASE WHEN ISNULL(FP.NM_EMAIL, '') = '' THEN NULL ELSE 'E-MAIL : ' + FP.NM_EMAIL END) AS NM_EMAIL,
	   FP.DC_PHOTO,
	   TQ.SORT,
	   TQ.NM_DEPTH,
	   TQ.DC_RMK
FROM TREE_QUERY TQ
LEFT JOIN FI_PARTNERPTR FP ON FP.CD_COMPANY = TQ.CD_COMPANY AND FP.CD_PARTNER = TQ.CD_PARTNER_SUB AND FP.SEQ = TQ.SEQ_SUB
LEFT JOIN CZ_FI_PARTNERPTR FP1 ON FP1.CD_COMPANY = TQ.CD_COMPANY AND FP1.CD_PARTNER = FP.CD_PARTNER AND FP1.SEQ = FP.SEQ
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = FP.CD_COMPANY AND MP.CD_PARTNER = FP.CD_PARTNER
WHERE TQ.LEVEL <> '1'
UNION ALL
SELECT 'Y' AS YN_AUTO,
       TQ.CD_COMPANY,
	   TQ.CD_PARTNER,
	   TQ.SEQ,
	   FP1.CD_RANK,
	   TQ.CD_PARTNER_SUB,
	   TQ.SEQ_SUB,
       MP.LN_PARTNER,
	   (CASE WHEN ISNULL(FP.EN_PTR, '') = '' THEN FP.NM_PTR ELSE FP.NM_PTR + ' (' + ISNULL(FP.EN_PTR, '') + ')' END) AS NM_PTR,
	   (CASE WHEN ISNULL(FP.NM_DUTY_RESP, '') = '' AND ISNULL(FP.EN_DUTY_RESP, '') = '' THEN FP.NM_DEPT
			 WHEN ISNULL(FP.EN_DUTY_RESP, '') = '' THEN FP.NM_DEPT + '/' + ISNULL(FP.NM_DUTY_RESP, '')
			 WHEN ISNULL(FP.NM_DUTY_RESP, '') = '' THEN FP.NM_DEPT + '/' + ISNULL(FP.EN_DUTY_RESP, '')
			 ELSE FP.NM_DEPT + '/' + ISNULL(FP.NM_DUTY_RESP, '') + ' (' + ISNULL(FP.EN_DUTY_RESP, '') + ')' END) AS NM_DEPT_DUTY,
	   (CASE WHEN ISNULL(FP.NO_FAX, '') = '' AND ISNULL(FP.NO_TEL, '') = '' THEN NULL
		     WHEN ISNULL(FP.NO_FAX, '') = '' THEN 'TEL : ' + FP.NO_TEL 
		     WHEN ISNULL(FP.NO_TEL, '') = '' THEN 'FAX : ' + ISNULL(FP.NO_FAX, '')
			 ELSE 'TEL : ' + FP.NO_TEL + ' / FAX : ' + ISNULL(FP.NO_FAX, '') END) AS NO_TEL,
	   (CASE WHEN ISNULL(FP.NO_HP, '') = '' THEN NULL ELSE 'HP : ' + FP.NO_HP END) AS NO_HP,
	   (CASE WHEN ISNULL(FP.NM_EMAIL, '') = '' THEN NULL ELSE 'E-MAIL : ' + FP.NM_EMAIL END) AS NM_EMAIL,
	   FP.DC_PHOTO,
	   TQ.SORT,
	   TQ.NM_DEPTH, 
	   TQ.DC_RMK
FROM TREE_QUERY1 TQ
LEFT JOIN FI_PARTNERPTR FP ON FP.CD_COMPANY = TQ.CD_COMPANY AND FP.CD_PARTNER = TQ.CD_PARTNER_SUB AND FP.SEQ = TQ.SEQ_SUB
LEFT JOIN CZ_FI_PARTNERPTR FP1 ON FP1.CD_COMPANY = TQ.CD_COMPANY AND FP1.CD_PARTNER = FP.CD_PARTNER AND FP1.SEQ = FP.SEQ
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = FP.CD_COMPANY AND MP.CD_PARTNER = FP.CD_PARTNER
UNION ALL
SELECT 'N' AS YN_AUTO,
	   PP.CD_COMPANY,
	   PP.CD_PARTNER,
	   PP.SEQ,
	   FP1.CD_RANK,
	   PP.CD_PARTNER_SUB,
	   PP.SEQ_SUB,
	   MP.LN_PARTNER,
	   (CASE WHEN ISNULL(FP.EN_PTR, '') = '' THEN FP.NM_PTR ELSE FP.NM_PTR + ' (' + ISNULL(FP.EN_PTR, '') + ')' END) AS NM_PTR,
	   (CASE WHEN ISNULL(FP.NM_DUTY_RESP, '') = '' AND ISNULL(FP.EN_DUTY_RESP, '') = '' THEN FP.NM_DEPT
			 WHEN ISNULL(FP.EN_DUTY_RESP, '') = '' THEN FP.NM_DEPT + '/' + ISNULL(FP.NM_DUTY_RESP, '')
			 WHEN ISNULL(FP.NM_DUTY_RESP, '') = '' THEN FP.NM_DEPT + '/' + ISNULL(FP.EN_DUTY_RESP, '')
			 ELSE FP.NM_DEPT + '/' + ISNULL(FP.NM_DUTY_RESP, '') + ' (' + ISNULL(FP.EN_DUTY_RESP, '') + ')' END) AS NM_DEPT_DUTY,
	   (CASE WHEN ISNULL(FP.NO_FAX, '') = '' AND ISNULL(FP.NO_TEL, '') = '' THEN NULL
		     WHEN ISNULL(FP.NO_FAX, '') = '' THEN 'TEL : ' + FP.NO_TEL 
		     WHEN ISNULL(FP.NO_TEL, '') = '' THEN 'FAX : ' + ISNULL(FP.NO_FAX, '')
			 ELSE 'TEL : ' + FP.NO_TEL + ' / FAX : ' + ISNULL(FP.NO_FAX, '') END) AS NO_TEL,
	   (CASE WHEN ISNULL(FP.NO_HP, '') = '' THEN NULL ELSE 'HP : ' + FP.NO_HP END) AS NO_HP,
	   (CASE WHEN ISNULL(FP.NM_EMAIL, '') = '' THEN NULL ELSE 'E-MAIL : ' + FP.NM_EMAIL END) AS NM_EMAIL,
	   FP.DC_PHOTO,
	   NULL AS SORT,
	   NULL AS NM_DEPTH,
	   PP.DC_RMK
FROM CZ_CRM_PARTNER_PIC_PEOPLE PP
LEFT JOIN FI_PARTNERPTR FP ON FP.CD_COMPANY = PP.CD_COMPANY AND FP.CD_PARTNER = PP.CD_PARTNER_SUB AND FP.SEQ = PP.SEQ_SUB
LEFT JOIN CZ_FI_PARTNERPTR FP1 ON FP1.CD_COMPANY = FP.CD_COMPANY AND FP1.CD_PARTNER = FP.CD_PARTNER AND FP1.SEQ = FP.SEQ
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = FP.CD_COMPANY AND MP.CD_PARTNER = FP.CD_PARTNER
WHERE PP.CD_COMPANY = @P_CD_COMPANY
AND PP.CD_PARTNER = @P_CD_PARTNER
AND PP.SEQ = @P_SEQ
ORDER BY SORT

GO

