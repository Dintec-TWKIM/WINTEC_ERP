USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_HULL_ENGINE_S]    Script Date: 2016-05-31 오전 9:15:58 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_MA_HULL_ENGINE_S]
(
	@P_CD_COMPANY      NVARCHAR(7),
	@P_NO_IMO          NVARCHAR(10),
	@P_ENGINE_MAKER    NVARCHAR(2),
	@P_NM_MODEL		   NVARCHAR(100),
	@P_SERIAL		   NVARCHAR(20),
	@P_YN_UPLOAD	   NVARCHAR(1)
) 
AS
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT ME.NO_IMO,
	   ME.NO_ENGINE,
	   ME.CD_ENGINE,
	   MC4.NM_SYSDEF AS NM_ENGINE,
	   ME.NM_MODEL,
	   ME.CD_MAKER,
	   MC3.NM_SYSDEF AS NM_MAKER,
	   ME.CAPACITY,
	   ME.SERIAL,
	   ME.CLS_L,
	   MC.NM_SYSDEF AS NM_CLS_L,
	   ME.CLS_M,
	   MC1.NM_SYSDEF AS NM_CLS_M,
	   ME.CLS_S,
	   MC2.NM_SYSDEF AS NM_CLS_S,
	   ME.DC_VERSION,
	   ME.DC_RMK,
	   ME.ID_INSERT,
	   ME.DTS_INSERT,
	   ME.ID_UPDATE,
	   ME.DTS_UPDATE,
	   HC.CD_CUSTOMER,
	   ME.YN_SYNC,
	   ISNULL(EI.QT_ALL, 0) AS QT_ALL,
	   ISNULL(HG.COUNT, 0) AS QT_HGS_COUNT,
	   ISNULL(ME.QT_HGS, 0) AS QT_UPLOAD
FROM CZ_MA_HULL MH
JOIN CZ_MA_HULL_ENGINE ME ON ME.NO_IMO = MH.NO_IMO
LEFT JOIN (SELECT EI.NO_IMO, EI.NO_ENGINE,
				  COUNT(1) AS QT_ALL
		   FROM CZ_MA_HULL_ENGINE_ITEM EI
		   GROUP BY EI.NO_IMO, EI.NO_ENGINE) EI
ON EI.NO_IMO = ME.NO_IMO AND EI.NO_ENGINE = ME.NO_ENGINE
LEFT JOIN (SELECT NO_IMO, SERVICEEQ,
		   	      MAX(CD_CUSTOMER) AS CD_CUSTOMER
		   FROM CZ_MA_HULL_HGS_CUSTOMER
		   GROUP BY NO_IMO, SERVICEEQ) HC
ON HC.NO_IMO = ME.NO_IMO AND HC.SERVICEEQ = ME.SERIAL
LEFT JOIN CZ_MA_HULL_HGS_EQ_COUNT HG ON (HG.NO_IMO = ME.NO_IMO OR HG.HULLNO = MH.NO_HULL) AND HG.SERVICEEQ = ME.SERIAL
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = @P_CD_COMPANY AND MC.CD_FIELD = 'MA_B000030' AND MC.CD_SYSDEF = ME.CLS_L
LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = @P_CD_COMPANY AND MC1.CD_FIELD = 'MA_B000031' AND MC1.CD_SYSDEF = ME.CLS_M
LEFT JOIN MA_CODEDTL MC2 ON MC2.CD_COMPANY = @P_CD_COMPANY AND MC2.CD_FIELD = 'MA_B000032' AND MC2.CD_SYSDEF = ME.CLS_S
LEFT JOIN MA_CODEDTL MC3 ON MC3.CD_COMPANY = @P_CD_COMPANY AND MC3.CD_FIELD = 'CZ_MA00003' AND MC3.CD_SYSDEF = ME.CD_MAKER
LEFT JOIN MA_CODEDTL MC4 ON MC4.CD_COMPANY = @P_CD_COMPANY AND MC4.CD_FIELD = 'CZ_MA00009' AND MC4.CD_SYSDEF = ME.CD_ENGINE
WHERE ME.NO_IMO = @P_NO_IMO
AND (ISNULL(@P_ENGINE_MAKER, '') = '' OR ME.CD_MAKER = @P_ENGINE_MAKER)
AND (ISNULL(@P_NM_MODEL, '') = '' OR ME.NM_MODEL LIKE '%' + @P_NM_MODEL + '%')
AND (ISNULL(@P_SERIAL, '') = '' OR ME.SERIAL LIKE '%' + @P_SERIAL + '%')
AND (@P_YN_UPLOAD = 'N' OR EXISTS (SELECT 1 
								   FROM CZ_MA_HULL_ENGINE_ITEM HI
								   WHERE HI.NO_IMO = ME.NO_IMO
								   AND HI.NO_ENGINE = ME.NO_ENGINE
								   AND HI.YN_UPLOAD = 'Y'))
ORDER BY MC4.CD_FLAG1, ME.NO_ENGINE


GO

