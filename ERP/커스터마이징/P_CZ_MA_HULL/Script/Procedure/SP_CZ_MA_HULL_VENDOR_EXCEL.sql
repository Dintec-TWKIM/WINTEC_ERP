USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_HULL_VENDOR_EXCEL]    Script Date: 2019-01-16 오전 10:57:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






ALTER PROCEDURE [NEOE].[SP_CZ_MA_HULL_VENDOR_EXCEL] 
(
	@P_XML			XML, 
	@P_ID_USER		NVARCHAR(10)
) 
AS 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_DOC INT

EXEC SP_XML_PREPAREDOCUMENT @V_DOC OUTPUT, @P_XML 

SELECT * INTO #XML
FROM OPENXML (@V_DOC, '/XML/ROW', 2) WITH 
(
    NO_IMO			NVARCHAR(10),
	CD_VENDOR		NVARCHAR(20),
	YN_DELETE		NVARCHAR(1)
)

EXEC SP_XML_REMOVEDOCUMENT @V_DOC

-- DELETE
DELETE A
FROM CZ_MA_HULL_VENDOR A
JOIN #XML B ON B.NO_IMO = A.NO_IMO AND B.CD_VENDOR = A.CD_VENDOR
WHERE B.YN_DELETE = 'Y'

DELETE A
FROM CZ_MA_HULL_VENDOR_TYPE A
JOIN #XML B ON B.NO_IMO = A.NO_IMO AND B.CD_VENDOR = A.CD_VENDOR
WHERE B.YN_DELETE = 'Y';

DELETE A
FROM CZ_MA_HULL_VENDOR_ITEM A
JOIN #XML B ON B.NO_IMO = A.NO_IMO AND B.CD_VENDOR = A.CD_VENDOR
WHERE B.YN_DELETE = 'Y';

-- INSERT
MERGE INTO CZ_MA_HULL_VENDOR AS T
	  USING (SELECT NO_IMO,
			        CD_VENDOR
	         FROM #XML
			 WHERE ISNULL(YN_DELETE, 'N') = 'N') AS S
	  ON T.NO_IMO = S.NO_IMO
	  AND T.CD_VENDOR = S.CD_VENDOR
	  WHEN NOT MATCHED THEN
		INSERT (NO_IMO,
				CD_VENDOR,
				ID_INSERT,
				DTS_INSERT) 
		VALUES (S.NO_IMO, 
				S.CD_VENDOR,
				@P_ID_USER,
				NEOE.SF_SYSDATE(GETDATE()));

DROP TABLE #XML

GO