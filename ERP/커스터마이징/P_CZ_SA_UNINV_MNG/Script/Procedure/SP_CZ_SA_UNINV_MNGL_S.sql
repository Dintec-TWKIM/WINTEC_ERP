USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_TRCREDITSCH_S]    Script Date: 2016-01-29 오전 11:42:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_SA_UNINV_MNGL_S]
( 
	@P_CD_COMPANY			NVARCHAR(7),
	@P_NO_SO				NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT SL.NO_SO,
	   OL.YN_AM, 
	   OL.NO_IO,
	   OL.DT_IO,
	   DATEDIFF(DAY, OL.DT_IO, GETDATE()) AS DT_DELAY,
	   OL.NO_IOLINE,
	   SL.SEQ_SO,
	   QL.NO_DSP,
	   SL.CD_ITEM,
	   MI.NM_ITEM,
	   QL.CD_ITEM_PARTNER,
	   QL.NM_ITEM_PARTNER,
	   SL.TP_GI,
	   OL.NM_QTIOTP,
	   ISNULL((CASE WHEN ISNULL(OL.YN_RETURN, 'N') = 'N' THEN SL.QT_SO ELSE 0 END), 0) AS QT_SO,
	   ISNULL(OL.QT_OUT, 0) AS QT_OUT,
	   ISNULL(OL.QT_RETURN, 0) AS QT_RETURN,
	   ISNULL(OL.QT_IV, 0) AS QT_IV,
	   ISNULL(OL.QT_IV_RETURN, 0) AS QT_IV_RETURN,
	   ISNULL((CASE WHEN ISNULL(OL.YN_RETURN, 'N') = 'N' THEN SL.AM_EX_SO ELSE 0 END), 0) AS AM_EX_SO,
	   ISNULL((CASE WHEN ISNULL(OL.YN_RETURN, 'N') = 'N' THEN SL.AM_SO ELSE 0 END), 0) AS AM_SO,
	   ISNULL(OL.AM_EX_OUT, 0) AS AM_EX_OUT,
	   ISNULL(OL.AM_OUT, 0) AS AM_OUT,
	   ISNULL(OL.AM_EX_FREE, 0) AS AM_EX_FREE,
	   ISNULL(OL.AM_FREE, 0) AS AM_FREE,
	   ISNULL(OL.AM_EX_RETURN, 0) AS AM_EX_RETURN,
	   ISNULL(OL.AM_RETURN, 0) AS AM_RETURN,
	   ISNULL(OL.AM_EX_RETURN_FREE, 0) AS AM_EX_RETURN_FREE,
	   ISNULL(OL.AM_RETURN_FREE, 0) AS AM_RETURN_FREE,
	   ISNULL(OL.AM_EX_IV, 0) AS AM_EX_IV,
	   ISNULL(OL.AM_IV, 0) AS AM_IV,
	   ISNULL(OL.AM_EX_IV_RETURN, 0) AS AM_EX_IV_RETURN,
	   ISNULL(OL.AM_IV_RETURN, 0) AS AM_IV_RETURN,
	   (ISNULL(OL.AM_EX_OUT, 0) - (ISNULL(OL.AM_EX_IV, 0) + ISNULL(OL.AM_EX_FREE, 0))) AS AM_EX_REMAIN,
	   (ISNULL(OL.AM_OUT, 0) - (ISNULL(OL.AM_IV, 0) + ISNULL(OL.AM_FREE, 0))) AS AM_REMAIN,
	   SL.DC2,
	   OL.DC_RMK1
FROM (SELECT SL.CD_COMPANY, SL.NO_SO, SL.SEQ_SO,
			 SL.CD_PLANT,
			 SL.CD_ITEM,
			 SL.TP_GI,
			 SL.QT_SO,
			 ISNULL(SL.AM_EX_S, SL.AM_SO) AS AM_EX_SO,
			 ISNULL(SL.AM_KR_S, SL.AM_WONAMT) AS AM_SO,
			 SL.DC2 
	  FROM SA_SOL SL) SL
LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = SL.CD_COMPANY AND MI.CD_PLANT = SL.CD_PLANT AND MI.CD_ITEM = SL.CD_ITEM
LEFT JOIN (SELECT OL.CD_COMPANY,
				  OL.NO_IO,
				  OL.NO_IOLINE,
				  OH.DT_IO,
				  OL.NO_PSO_MGMT,
				  OL.NO_PSOLINE_MGMT,
				  TP.NM_QTIOTP,
				  OL.YN_AM,
				  OH.YN_RETURN,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'N' THEN OL.QT_IO ELSE 0 END) AS QT_OUT,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'N' THEN OL.AM_EX ELSE 0 END) AS AM_EX_OUT,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'N' THEN OL.AM ELSE 0 END) AS AM_OUT,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'N' AND ISNULL(OL.YN_AM, 'N') = 'N' THEN OL.AM_EX ELSE 0 END) AS AM_EX_FREE,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'N' AND ISNULL(OL.YN_AM, 'N') = 'N' THEN OL.AM ELSE 0 END) AS AM_FREE,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'Y' THEN OL.QT_IO ELSE 0 END) AS QT_RETURN,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'Y' THEN OL.AM_EX ELSE 0 END) AS AM_EX_RETURN,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'Y' THEN OL.AM ELSE 0 END) AS AM_RETURN,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'Y' AND ISNULL(OL.YN_AM, 'N') = 'N' THEN OL.AM_EX ELSE 0 END) AS AM_EX_RETURN_FREE,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'Y' AND ISNULL(OL.YN_AM, 'N') = 'N' THEN OL.AM ELSE 0 END) AS AM_RETURN_FREE,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'N' THEN IL.QT_CLS ELSE 0 END) AS QT_IV,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'N' THEN IL.AM_EX_CLS ELSE 0 END) AS AM_EX_IV,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'N' THEN IL.AM_CLS ELSE 0 END) AS AM_IV,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'Y' THEN IL.QT_CLS ELSE 0 END) AS QT_IV_RETURN,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'Y' THEN IL.AM_EX_CLS ELSE 0 END) AS AM_EX_IV_RETURN,
				  (CASE WHEN ISNULL(OH.YN_RETURN, 'N') = 'Y' THEN IL.AM_CLS ELSE 0 END) AS AM_IV_RETURN,
				  OL.DC_RMK1 
		   FROM MM_QTIO OL
		   LEFT JOIN MM_QTIOH OH ON OH.CD_COMPANY = OL.CD_COMPANY AND OH.NO_IO = OL.NO_IO
		   LEFT JOIN MM_EJTP TP ON TP.CD_COMPANY = OL.CD_COMPANY AND TP.CD_QTIOTP = OL.CD_QTIOTP
		   LEFT JOIN (SELECT CD_COMPANY, NO_IO, NO_IOLINE, CD_ITEM,
						     SUM(QT_CLS) AS QT_CLS,
							 SUM(AM_EX_CLS) AS AM_EX_CLS,
							 SUM(AM_CLS) AS AM_CLS 
					  FROM SA_IVL
					  GROUP BY CD_COMPANY, NO_IO, NO_IOLINE, CD_ITEM) IL 
		   ON IL.CD_COMPANY = OL.CD_COMPANY AND IL.NO_IO = OL.NO_IO AND IL.NO_IOLINE = OL.NO_IOLINE AND IL.CD_ITEM = OL.CD_ITEM
		   WHERE OL.CD_COMPANY = @P_CD_COMPANY
		   AND OL.FG_PS = '2'
		   AND OL.CD_QTIOTP <> '500') OL 
ON OL.CD_COMPANY = SL.CD_COMPANY AND OL.NO_PSO_MGMT = SL.NO_SO AND OL.NO_PSOLINE_MGMT = SL.SEQ_SO
WHERE SL.CD_COMPANY = @P_CD_COMPANY
AND SL.NO_SO = @P_NO_SO
ORDER BY SL.SEQ_SO, OL.NO_IO, OL.NO_IOLINE

GO