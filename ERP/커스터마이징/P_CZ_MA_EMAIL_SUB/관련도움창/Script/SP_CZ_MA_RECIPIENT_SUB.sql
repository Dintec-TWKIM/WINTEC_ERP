USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_RECIPIENT_SUB]    Script Date: 2015-11-23 오후 3:51:40 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_MA_RECIPIENT_SUB]
(
	@P_CD_COMPANY      NVARCHAR(7),
	@P_ID_USER		   NVARCHAR(10),
	@P_SELECT_TAB	   NVARCHAR(1),
	@P_CD_PARTNER	   NVARCHAR(20),
	@P_SEARCH		   NVARCHAR(MAX)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @P_SELECT_TAB = '0'
BEGIN
	SELECT 'N' AS S,
		   ME.NO_EMP,
		   ME.NM_KOR,
		   ME.NO_EMAIL
	FROM MA_USER MU
	LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = MU.CD_COMPANY AND ME.NO_EMP = MU.NO_EMP
	WHERE MU.CD_COMPANY = @P_CD_COMPANY
	AND MU.ID_USER = @P_ID_USER
	UNION
	SELECT 'N' AS S,
		   ME.NO_EMP,
		   ME.NM_KOR,
		   ME.NO_EMAIL  
	FROM CZ_SA_USER CU
	LEFT JOIN MA_USER MU ON MU.CD_COMPANY = CU.CD_COMPANY AND MU.ID_USER = CU.ID_USER
	LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = MU.CD_COMPANY AND ME.NO_EMP = MU.NO_EMP
	WHERE CU.CD_COMPANY = @P_CD_COMPANY
	AND EXISTS (SELECT 1
			    FROM CZ_SA_USER
			    WHERE CD_COMPANY = CU.CD_COMPANY
				AND ID_USER = @P_ID_USER
				AND ID_SALES LIKE '%' + CU.ID_USER + '%')
	AND (ISNULL(@P_SEARCH, '') = '' OR ME.NM_KOR LIKE '%' + @P_SEARCH + '%')
END
ELSE
BEGIN
	SELECT 'N' AS S,
		   NM_PTR AS NM_KOR,
		   NM_EMAIL AS NO_EMAIL  
    FROM FI_PARTNERPTR
	WHERE CD_COMPANY = @P_CD_COMPANY
	AND CD_PARTNER = @P_CD_PARTNER
	AND (ISNULL(@P_SEARCH, '') = '' OR NM_PTR LIKE '%' + @P_SEARCH + '%')
END

GO