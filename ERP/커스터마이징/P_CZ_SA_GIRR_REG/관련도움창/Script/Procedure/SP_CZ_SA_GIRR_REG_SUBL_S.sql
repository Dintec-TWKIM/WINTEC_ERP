USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIRR_REG_SUBL_S]    Script Date: 2015-09-03 오후 6:58:00 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
  
ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIRR_REG_SUBL_S]
(      
    @P_CD_COMPANY		NVARCHAR(7),   
    @P_NO_IO			NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @P_AM_FSIZE		NUMERIC(3, 0)   -- 소수점

IF @P_CD_COMPANY = 'S100'
	SET @P_AM_FSIZE = 2
ELSE
	SET @P_AM_FSIZE = 0

SELECT 'N' AS S,
	   OL.NO_IO,
	   OL.NO_IOLINE,
	   OL.CD_PLANT,
	   OL.CD_SL,
	   MS.NM_SL,
	   SG.NM_SALEGRP,
	   OL.NO_PSO_MGMT,
	   OL.CD_ITEM,
	   MI.NM_ITEM,
	   MI.STND_ITEM,
	   MI.UNIT_SO,
	   (ISNULL(OL.QT_IO, 0) - ISNULL(OL.QT_RETURN, 0)) AS QT_IO,
	   ISNULL(OL.UM_EX, 0) AS UM_EX,
	   ROUND((ISNULL(OL.QT_UNIT_MM, 0) - ISNULL(OL.QT_RETURN_MM, 0)) * ISNULL(OL.UM_EX, 0), 2) AS AM_EX,
	   ROUND(ROUND((ISNULL(OL.QT_UNIT_MM, 0) - ISNULL(OL.QT_RETURN_MM, 0)) * ISNULL(OL.UM_EX, 0), 2) * ISNULL(OL.RT_EXCH, 1), @P_AM_FSIZE) AS AM,
	   0 AS SEQ_GIR,
	   GL.TP_ITEM,
	   GL.DT_DUEDATE,
	   GL.DT_DUEDATE AS DT_REQGI,
	   GL.YN_INSPECT,
	   (ISNULL(OL.QT_UNIT_MM, 0) - ISNULL(OL.QT_RETURN_MM, 0)) AS QT_GIR,
	   ISNULL(GL.UM, 0) AS UM,
	   ((ISNULL(OL.QT_UNIT_MM, 0) - ISNULL(OL.QT_RETURN_MM, 0)) * ISNULL(GL.UM, 0)) AS AM_GIR,
	   0.0000 AM_GIRAMT,
	   0.0000 AM_VAT,
	   GL.UNIT,
	   (ISNULL(OL.QT_IO, 0) - ISNULL(OL.QT_RETURN, 0)) AS QT_GIR_IM,
	   GL.GI_PARTNER,
	   MP.LN_PARTNER,
	   PH.NM_PROJECT,
	   GL.NO_EMP,
	   MI.UNIT_SO_FACT,
	   OL.NO_IO AS NO_IO_MGMT,
	   OL.NO_IOLINE AS NO_IOLINE_MGMT,
	   OL.NO_PSO_MGMT AS NO_SO_MGMT,
	   OL.NO_PSOLINE_MGMT AS NO_SOLINE_MGMT,
	   0.0000 QT_GI,
	   OL.NO_LC,
	   OL.NO_LCLINE AS SEQ_LC,
	   OL.FG_TPIO AS TP_IV,
	   SD.NM_CUST_DLV, 
	   SD.CD_ZIP,
	   SD.ADDR1,
	   SD.ADDR2,
	   SD.NO_TEL_D1,
	   SD.NO_TEL_D2,
	   SD.TP_DLV,
	   SD.DC_REQ,
	   SD.FG_TRACK,
	   SL.TP_VAT,
	   SL.RT_VAT,
	   MI.UNIT_SO_FACT,
	   MI.FG_SERNO,
	   MI.GRP_ITEM AS CD_ITEMGRP,
	   SL.CD_ITEM_REF,
	   MI1.NM_ITEM AS NM_ITEM_REF,
	   MI1.STND_ITEM AS STND_ITEM_REF,
	   GL.YN_PICKING,
	   SD.CD_USERDEF1 AS DLV_CD_USERDEF1,
	   SD.TXT_USERDEF1 AS DLV_TXT_USERDEF1,
	   SD.TP_DLV_DUE,
	   SD.NO_ORDER,
	   SD.NM_CUST,
	   SD.NO_TEL1,
	   SD.NO_TEL2,
	   OL.CD_EXCH,
	   GL.AM_GIR AS AM_GIR_ORIGINAL,
	   GL.AM_GIRAMT AS AM_GIRAMT_ORIGINAL,
	   GL.AM_VAT AS AM_VAT_ORIGINAL,
	   OL.QT_RETURN, 
	   OL.QT_IO AS QT_IO_ORI,
	   GL.QT_GIR_IM AS QT_GIR_IM_ORI,
	   OL.TP_UM_TAX, 
	   OL.UMVAT_GI AS UMVAT_GIR,
	   OL.CD_PJT AS NO_PROJECT,
	   OL.SEQ_PROJECT,  
	   PL.CD_ITEM AS CD_UNIT,  
	   MI2.NM_ITEM AS NM_UNIT,  
	   MI2.STND_ITEM AS STND_UNIT 
FROM MM_QTIO OL
LEFT JOIN SA_GIRL GL ON GL.CD_COMPANY = OL.CD_COMPANY AND GL.NO_GIR = OL.NO_ISURCV AND GL.SEQ_GIR = OL.NO_ISURCVLINE
LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = OL.CD_COMPANY AND SL.NO_SO = OL.NO_PSO_MGMT AND SL.SEQ_SO = OL.NO_PSOLINE_MGMT
LEFT JOIN SA_SOL_DLV SD ON SD.CD_COMPANY = OL.CD_COMPANY AND SD.NO_SO = OL.NO_PSO_MGMT AND SD.SEQ_SO = OL.NO_PSOLINE_MGMT AND SD.FG_TRACK = 'SO'
LEFT JOIN MA_SL MS ON MS.CD_COMPANY = OL.CD_COMPANY AND MS.CD_PLANT = OL.CD_PLANT AND MS.CD_SL = OL.CD_SL
LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = OL.CD_COMPANY AND SG.CD_SALEGRP = OL.CD_GROUP
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GL.CD_COMPANY AND MP.CD_PARTNER = GL.GI_PARTNER
LEFT JOIN SA_PROJECTH PH ON PH.CD_COMPANY = OL.CD_COMPANY AND PH.NO_PROJECT = OL.CD_PJT
LEFT JOIN SA_PROJECTL PL ON PL.CD_COMPANY = OL.CD_COMPANY AND PL.NO_PROJECT = OL.CD_PJT AND PL.SEQ_PROJECT = OL.SEQ_PROJECT
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = OL.CD_COMPANY AND MI.CD_PLANT = OL.CD_PLANT AND MI.CD_ITEM = OL.CD_ITEM
LEFT JOIN MA_PITEM MI1 ON MI1.CD_COMPANY = SL.CD_COMPANY AND MI1.CD_PLANT = SL.CD_PLANT AND MI1.CD_ITEM = SL.CD_ITEM_REF
LEFT JOIN MA_PITEM MI2 ON MI2.CD_COMPANY = PL.CD_COMPANY AND MI2.CD_PLANT = PL.CD_PLANT AND MI2.CD_ITEM = PL.CD_ITEM
WHERE OL.CD_COMPANY = @P_CD_COMPANY    
AND	OL.NO_IO = @P_NO_IO
AND	ISNULL(OL.QT_UNIT_MM, 0) - ISNULL(OL.QT_RETURN_MM, 0) > 0

GO