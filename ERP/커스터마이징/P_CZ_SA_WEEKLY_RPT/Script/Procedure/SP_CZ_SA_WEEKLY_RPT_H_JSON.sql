USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_WEEKLY_RPT_H_JSON]    Script Date: 2017-01-05 오후 5:48:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_WEEKLY_RPT_H_JSON]          
(
	@P_JSON			NVARCHAR(MAX),
	@P_ID_USER		NVARCHAR(10)	
)  
AS
   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DELETE RH
FROM CZ_SA_WEEKLY_RPT_H RH
WHERE EXISTS (SELECT 1 
			  FROM OPENJSON(@P_JSON)
			  WITH
			  (
					CD_COMPANY      NVARCHAR(7),
					NO_EMP			NVARCHAR(10),
					DT_YEAR			NVARCHAR(4),
					QT_WEEK			INT,
					JSON_FLAG		NVARCHAR(1)
			  ) JS
			  WHERE JS.JSON_FLAG = 'D'
			  AND JS.CD_COMPANY = RH.CD_COMPANY
			  AND JS.NO_EMP = RH.NO_EMP
			  AND JS.DT_YEAR = RH.DT_YEAR
			  AND JS.QT_WEEK = RH.QT_WEEK)

DELETE RL
FROM CZ_SA_WEEKLY_RPT_L RL
WHERE EXISTS (SELECT 1 
			  FROM OPENJSON(@P_JSON)
			  WITH
			  (
					CD_COMPANY      NVARCHAR(7),
					NO_EMP			NVARCHAR(10),
					DT_YEAR			NVARCHAR(4),
					QT_WEEK		    INT,
					JSON_FLAG		NVARCHAR(1)
			  ) JS
			  WHERE JS.JSON_FLAG = 'D'
			  AND JS.CD_COMPANY = RL.CD_COMPANY
			  AND JS.NO_EMP = RL.NO_EMP
			  AND JS.DT_YEAR = RL.DT_YEAR
			  AND JS.QT_WEEK = RL.QT_WEEK)

INSERT INTO CZ_SA_WEEKLY_RPT_H
(
	CD_COMPANY,
	NO_EMP,
	DT_YEAR,
	QT_WEEK,
	YN_POST,
	YN_CONFIRM,
	ID_INSERT,
	DTS_INSERT
)
SELECT CD_COMPANY,
	   NO_EMP,
	   DT_YEAR,
	   QT_WEEK,
	   YN_POST,
	   YN_CONFIRM,
	   @P_ID_USER,
	   NEOE.SF_SYSDATE(GETDATE())
FROM OPENJSON(@P_JSON)
WITH
(
	CD_COMPANY      NVARCHAR(7),
	NO_EMP			NVARCHAR(10),
	DT_YEAR			NVARCHAR(4),
	QT_WEEK			INT,
	YN_POST			NVARCHAR(1),
	YN_CONFIRM		NVARCHAR(1),
	JSON_FLAG		NVARCHAR(1)
) JS
WHERE JS.JSON_FLAG = 'I'

UPDATE RH
SET RH.YN_POST = JS.YN_POST,
	RH.YN_CONFIRM = JS.YN_CONFIRM,
	RH.DT_FROM = JS.DT_FROM,
	RH.DT_TO = JS.DT_TO,
    RH.ID_UPDATE = @P_ID_USER,
	RH.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
FROM CZ_SA_WEEKLY_RPT_H RH
JOIN OPENJSON(@P_JSON)
WITH
(
	CD_COMPANY      NVARCHAR(7),
	NO_EMP			NVARCHAR(10),
	DT_YEAR			NVARCHAR(4),
	QT_WEEK			INT,
	YN_POST			NVARCHAR(1),
	YN_CONFIRM		NVARCHAR(1),
	DT_FROM			NVARCHAR(8),
	DT_TO			NVARCHAR(8),
	JSON_FLAG		NVARCHAR(1)
) JS
ON JS.CD_COMPANY = RH.CD_COMPANY AND JS.NO_EMP = RH.NO_EMP AND JS.DT_YEAR = RH.DT_YEAR AND JS.QT_WEEK = RH.QT_WEEK
WHERE JS.JSON_FLAG = 'U'

GO