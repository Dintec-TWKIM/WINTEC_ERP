USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_WEEKLY_RPT_L5_S]    Script Date: 2018-11-26 오후 3:09:09 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_WEEKLY_RPT_L5_S]
(
    @P_CD_COMPANY	NVARCHAR(7),
    @P_NO_EMP       NVARCHAR(10),
    @P_DT_YEAR      NVARCHAR(4),
    @P_QT_WEEK      INT
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_DT_TODAY NVARCHAR(8) = CONVERT(CHAR(8), GETDATE(), 112)

SELECT 'N' AS S,
       RL.NO_EMP,
       RL.DT_YEAR,
       RL.QT_WEEK,
       RL.TP_GUBUN,
       RL.NO_KEY,
	   IH.DT_PROCESS AS DT_IV,
	   RH.DT_RCP,
	   DATEDIFF(DAY, DATEADD(DAY, IH.DT_RCP_PREARRANGED, IH.DT_PROCESS), @V_DT_TODAY) AS DT_IV_DAY,
	   IH.LN_PARTNER AS NM_PARTNER,
	   ME.NM_KOR AS NM_EMP,
	   IH.NM_EXCH,
	   IH.RT_EXCH,
	   ISNULL(IL.AM_EX_CLS, 0) AS AM_EX_CLS,
	   ISNULL(IL.AM_CLS, 0) AS AM_CLS,
	   ISNULL(RH.AM_RCP_EX, 0) AS AM_RCP_EX,
	   ISNULL(RH.AM_RCP, 0) AS AM_RCP,
	   (ISNULL(IL.AM_EX_CLS, 0) - ISNULL(RH.AM_RCP_EX, 0)) AS AM_EX_REMAIN,
	   (ISNULL(IL.AM_CLS, 0) - ISNULL(RH.AM_RCP, 0)) AS AM_REMAIN,
       RL.DC_RMK
FROM CZ_SA_WEEKLY_RPT_L RL
LEFT JOIN (SELECT IH.CD_COMPANY, 
				  IH.NO_IV,
		   	  	  IH.DT_PROCESS,
		   	  	  IH.RT_EXCH,
		   	  	  MP.LN_PARTNER,
				  MP.DT_RCP_PREARRANGED,
		   	  	  (CASE WHEN AR.NO_EMP IS NOT NULL THEN AR.NO_EMP
		   	  		 	WHEN AR.NO_EMP IS NULL AND IL.NO_SO_EMP IS NOT NULL THEN IL.NO_SO_EMP 
		   	  		 	ELSE IL.NO_PJ_EMP END) AS NO_EMP,
		   	  	  MC.NM_SYSDEF AS NM_EXCH
		   FROM SA_IVH IH
		   JOIN (SELECT IL.CD_COMPANY, IL.NO_IV,
		   			    MAX(SH.NO_EMP) AS NO_SO_EMP,
		   			    MAX(PH.NO_EMP) AS NO_PJ_EMP
		   	     FROM SA_IVL IL
		   	     LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = IL.CD_COMPANY AND SH.NO_SO = IL.NO_SO
		   	     LEFT JOIN SA_PROJECTH PH ON PH.CD_COMPANY = IL.CD_COMPANY AND PH.NO_PROJECT = IL.CD_PJT
		   	     GROUP BY IL.CD_COMPANY, IL.NO_IV) IL
		   ON IL.CD_COMPANY = IH.CD_COMPANY AND IL.NO_IV = IH.NO_IV
		   LEFT JOIN CZ_SA_AC_RECEIVABLE AR ON AR.CD_COMPANY = IH.CD_COMPANY AND AR.NO_KEY = IH.NO_IV
		   LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = IH.CD_COMPANY AND MP.CD_PARTNER = IH.CD_PARTNER
		   LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = IH.CD_COMPANY AND MC.CD_FIELD = 'MA_B000005' AND MC.CD_SYSDEF = IH.CD_EXCH
		   WHERE IH.CD_COMPANY = @P_CD_COMPANY
		   AND IH.DT_PROCESS <= @V_DT_TODAY) IH
ON IH.CD_COMPANY = RL.CD_COMPANY AND IH.NO_IV = RL.NO_KEY
LEFT JOIN (SELECT IH.CD_COMPANY, IH.NO_IV, IH.DT_PROCESS,
		   	      SUM(CASE WHEN IL.YN_RETURN = 'Y' THEN -(IL.AM_EX_CLS + CONVERT(NUMERIC(17, 4), ROUND(IL.VAT / IH.RT_EXCH, 2))) 
		   									       ELSE (IL.AM_EX_CLS + CONVERT(NUMERIC(17, 4), ROUND(IL.VAT / IH.RT_EXCH, 2))) END) AS AM_EX_CLS,
		   	      SUM(CASE WHEN IL.YN_RETURN = 'Y' THEN -(IL.AM_CLS + IL.VAT) 
		   									       ELSE (IL.AM_CLS + IL.VAT) END) AS AM_CLS 
		   FROM SA_IVH IH
		   JOIN SA_IVL IL ON IL.CD_COMPANY = IH.CD_COMPANY AND IL.NO_IV = IH.NO_IV
		   GROUP BY IH.CD_COMPANY, IH.NO_IV, IH.DT_PROCESS) IL
ON IL.CD_COMPANY = IH.CD_COMPANY AND IL.NO_IV = IH.NO_IV AND IL.DT_PROCESS = IH.DT_PROCESS
LEFT JOIN (SELECT RH.CD_COMPANY,
				  RD.NO_IV,
				  MAX(RH.DT_RCP) AS DT_RCP,
				  SUM(RD.AM_RCP_EX) AS AM_RCP_EX,
				  SUM(RD.AM_RCP) AS AM_RCP
		   FROM SA_RCPH RH
		   LEFT JOIN (SELECT RD.CD_COMPANY, RD.NO_RCP, RD.NO_TX AS NO_IV,
  							 (ISNULL(RD.AM_RCP_TX, 0) + ISNULL(RD.AM_PL, 0)) AS AM_RCP,
  							 ISNULL(RD.AM_RCP_TX_EX, 0) AS AM_RCP_EX 
					  FROM SA_RCPD RD 
					  UNION ALL
					  SELECT BD.CD_COMPANY, BD.NO_RCP, BD.NO_IV,
  							 (ISNULL(BD.AM_RCPS, 0) + ISNULL(BD.AM_PL, 0)) AS AM_RCP,
  							 ISNULL(BD.AM_RCPS_EX, 0) AS AM_RCP_EX 
					  FROM SA_BILLSD BD) RD
		   ON RD.CD_COMPANY = RH.CD_COMPANY AND RD.NO_RCP = RH.NO_RCP
		   WHERE RD.NO_IV IS NOT NULL
		   AND RH.DT_RCP <= @V_DT_TODAY
		   GROUP BY RH.CD_COMPANY, RD.NO_IV) RH
ON RH.CD_COMPANY = IH.CD_COMPANY AND RH.NO_IV = IH.NO_IV
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = IH.CD_COMPANY AND ME.NO_EMP = IH.NO_EMP
WHERE RL.CD_COMPANY = @P_CD_COMPANY
AND RL.NO_EMP = @P_NO_EMP
AND RL.DT_YEAR = @P_DT_YEAR
AND RL.QT_WEEK = @P_QT_WEEK
AND RL.TP_GUBUN = '005'

GO