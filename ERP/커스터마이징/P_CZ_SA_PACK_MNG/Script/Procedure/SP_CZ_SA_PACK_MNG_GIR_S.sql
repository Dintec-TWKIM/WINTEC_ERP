SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_PACK_MNG_GIR_S]  
(
	@P_SERVER_KEY			NVARCHAR(50) = '',
	@P_CD_COMPANY			NVARCHAR(7),
	@P_LANGUAGE				NVARCHAR(5) = 'KR',
	@P_NO_GIR				NVARCHAR(MAX)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE	@V_SERVER_PATH NVARCHAR(MAX)

SELECT @V_SERVER_PATH = ASSEMBLY_HOST_SERVER
FROM CM_SERVER_CONFIG
WHERE SERVER_KEY = @P_SERVER_KEY

SELECT 'N' AS S,
	   GH.CD_COMPANY,
	   MC.NM_COMPANY,
	   GH.NO_GIR,
	   GH.DT_GIR,
	   GD.DT_START,
	   GD.DT_COMPLETE,
	   '' AS DT_BILL,
	   '002' AS CD_TYPE,
	   (CASE WHEN @P_LANGUAGE = 'KR' THEN MD2.NM_SYSDEF ELSE MD2.NM_SYSDEF_E END) AS NM_TYPE1,
	   (CASE WHEN @P_LANGUAGE = 'KR' THEN MD3.NM_SYSDEF ELSE MD3.NM_SYSDEF_E END) AS NM_TYPE2,
	   (CASE WHEN @P_LANGUAGE = 'KR' THEN MD4.NM_SYSDEF ELSE MD4.NM_SYSDEF_E END) AS NM_TYPE3,
	   GD.YN_PACKING,
	   GL.YN_TAX,
	   'N' AS YN_AUTO_SUBMIT,
	   GH.STA_GIR,
	   GD.DT_PACKING AS DT_DONE,
	   ME1.NM_KOR AS NM_EMP_GIR,
	   MH.NM_VESSEL,
	   MP.LN_PARTNER,
	   GD.CD_COLLECT_FROM AS CD_DELIVERY_TO,
	   MP1.LN_PARTNER AS NM_GIR_PARTNER,
	   ISNULL(MD13.NM_SYSDEF, MD5.NM_SYSDEF_E) AS ARRIVER_COUNTRY,
	   GL.QT_ITEM,
	   MP.CD_PARTNER_GRP,
	   MD1.NM_SYSDEF AS NM_PARTNER_GRP,
	   GH.CD_PARTNER,
	   PT.NM_PLANT,
	   MD.NM_SYSDEF AS NM_RETURN,
	   GD.DC_RMK1,
	   GD.DC_RMK2,
	   MD6.NM_SYSDEF AS NM_RMK,
	   GD.DC_RMK,
	   GD.DC_RESULT,
	   ME.NM_KOR AS NM_EMP_SALE,
	   GD.DTS_INSERT,
	   GD.DTS_UPDATE,
	   GD.DTS_SUBMIT,
	   GD.DTS_CONFIRM,
	   GH.YN_RETURN,
	   GH.MEMO_CD,
	   GH.CHECK_PEN,
	   MD8.NM_SYSDEF AS NM_STA_GIR,
	   GD.NO_IMO,
	   MH.NO_HULL,
	   GH.CD_PLANT,
	   MD7.NM_SYSDEF AS NM_BUSI,
	   IH.NM_CONSIGNEE,
	   IH.ADDR1_CONSIGNEE,
	   IH.ADDR2_CONSIGNEE,
	   IH.NM_NOTIFY,
	   IH.ADDR1_NOTIFY,
	   IH.ADDR2_NOTIFY,
	   IH.REMARK1 AS TEL,
	   IH.REMARK2 AS EMAIL,
	   IH.REMARK3 AS PIC,
	   IH.ADDR1_PARTNER,
	   IH.ADDR2_PARTNER,
	   IH.PORT_LOADING,
	   (CASE WHEN ISNULL(MD5.NM_SYSDEF_E, '') = '' THEN ISNULL(IH.PORT_ARRIVER, '')
	   	     WHEN ISNULL(IH.PORT_ARRIVER, '') = '' THEN MD5.NM_SYSDEF_E 
	   											   ELSE (ISNULL(IH.PORT_ARRIVER, '') + ' ' + ISNULL(MD13.NM_SYSDEF, MD5.NM_SYSDEF_E)) END) AS PORT_ARRIVER,
	   IH.DT_SAILING_ON,
	   MD9.NM_SYSDEF AS NM_HS,
	   MD10.NM_SYSDEF_E AS NM_ORIGIN,
	   (MD11.NM_SYSDEF + ' ' + ISNULL(MD14.NM_SYSDEF, IH.PORT_LOADING)) AS NM_TRANS,
	   MD12.NM_SYSDEF AS NM_COND_PAY,
	   GL.NO_IO,
	   GL.DT_IO,
	   GL.NO_SALES,
	   GL.NM_ENG,
	   (CASE WHEN ISNULL(GL.DC_SIGN, '') = '' THEN '' ELSE ISNULL(@V_SERVER_PATH, '') + '/shared/image/human/sign/' + GL.CD_COMPANY + '/' + GL.DC_SIGN END) AS PATH_SIGN,
	   PH.QT_BOX,
	   GL.YN_AM,
	   GD.DC_RMK_CI,
	   NULL AS DC_RMK_PL,
	   STUFF((SELECT ',' + A.NO_PO_PARTNER
	   	   FROM (SELECT GL.CD_COMPANY, GL.NO_GIR, SH.NO_PO_PARTNER 
	   			 FROM CZ_SA_GIRL_PACK GL
	   			 JOIN SA_SOH SH ON SH.CD_COMPANY = GL.CD_COMPANY AND SH.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT)
	   			 WHERE ISNULL(SH.NO_PO_PARTNER, '') <> ''
	   			 GROUP BY GL.CD_COMPANY, GL.NO_GIR, SH.NO_PO_PARTNER) A
	   	   WHERE A.CD_COMPANY = GH.CD_COMPANY
	   	   AND A.NO_GIR = GH.NO_GIR
	   	   FOR XML PATH(''), TYPE).value('.', 'nvarchar(max)'), 1, 1, '') AS NO_PO_PARTNER_ALL
FROM CZ_SA_GIRH_PACK GH
LEFT JOIN MA_COMPANY MC ON MC.CD_COMPANY = GH.CD_COMPANY
LEFT JOIN CZ_SA_GIRH_PACK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
LEFT JOIN (SELECT CD_COMPANY, NO_GIR, 
				  COUNT(NO_PACK) AS QT_BOX 
		   FROM CZ_SA_PACKH
		   GROUP BY CD_COMPANY, NO_GIR) PH
ON PH.CD_COMPANY = GH.CD_COMPANY AND PH.NO_GIR = GH.NO_GIR
JOIN (SELECT GL.CD_COMPANY, GL.NO_GIR,
			 MAX(GL.NO_INV) AS NO_INV,
			 (CASE WHEN ISNULL(SUM(FT.QT_TAX), 0) > 0 THEN 'Y' ELSE 'N' END) AS YN_TAX,
			 COUNT(1) AS QT_ITEM,
			 MAX(QO.NO_IO) AS NO_IO,
			 MAX(QOH.DT_IO) AS DT_IO,
			 MAX(SO.NO_SALES) AS NO_SALES,
			 MAX(PT.DC_SIGN) AS DC_SIGN,
			 MAX(ME.NM_ENG) AS NM_ENG,
			 MAX(JT.YN_AM) AS YN_AM
	  FROM CZ_SA_GIRL_PACK GL
	  LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = GL.CD_COMPANY AND SH.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT)
	  LEFT JOIN (SELECT IL.CD_COMPANY, IL.NO_SO, IL.NO_SOLINE,
					    ISNULL(SUM(IL.QT_TAX), 0) AS QT_TAX 
		 		 FROM CZ_FI_IMP_PMTL IL
		 		 GROUP BY IL.CD_COMPANY, IL.NO_SO, IL.NO_SOLINE) FT
	  ON FT.CD_COMPANY = GL.CD_COMPANY AND FT.NO_SO = SH.NO_SO AND FT.NO_SOLINE = (CASE WHEN GL.SEQ_SO = 0 THEN GL.NO_SOLINE_MGMT ELSE GL.SEQ_SO END)
	  LEFT JOIN MM_QTIO QO ON QO.CD_COMPANY = GL.CD_COMPANY AND QO.NO_ISURCV = GL.NO_GIR AND QO.NO_ISURCVLINE = GL.SEQ_GIR
	  LEFT JOIN MM_QTIOH QOH ON QOH.CD_COMPANY = QO.CD_COMPANY AND QOH.NO_IO = QO.NO_IO
	  LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = GL.CD_COMPANY AND SG.CD_SALEGRP = GL.CD_SALEGRP
	  LEFT JOIN MA_SALEORG SO ON SO.CD_COMPANY = SG.CD_COMPANY AND SO.CD_SALEORG = SG.CD_SALEORG
	  LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SO.CD_COMPANY AND ME.NO_EMP = SO.NO_SALES
	  LEFT JOIN HR_PHOTO PT ON PT.CD_COMPANY = ME.CD_COMPANY AND PT.NO_EMP = ME.NO_EMP
	  LEFT JOIN MM_EJTP JT ON JT.CD_COMPANY = GL.CD_COMPANY AND JT.CD_QTIOTP = GL.TP_GI
	  GROUP BY GL.CD_COMPANY, GL.NO_GIR) GL
ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
LEFT JOIN CZ_TR_INVH IH ON IH.CD_COMPANY = GL.CD_COMPANY AND IH.NO_INV = GL.NO_INV
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
LEFT JOIN CZ_MA_DELIVERY MP1 ON MP1.CD_COMPANY = GD.CD_COMPANY AND MP1.CD_PARTNER = GD.CD_COLLECT_FROM
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = GD.NO_IMO
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = MP.CD_COMPANY AND ME.NO_EMP = MP.CD_EMP_SALE
LEFT JOIN MA_EMP ME1 ON ME1.CD_COMPANY = GH.CD_COMPANY AND ME1.NO_EMP = GH.NO_EMP
LEFT JOIN MA_PLANT PT ON PT.CD_COMPANY = GH.CD_COMPANY AND PT.CD_PLANT = GH.CD_PLANT
LEFT JOIN MA_CODEDTL MD ON MD.CD_COMPANY = GH.CD_COMPANY AND MD.CD_FIELD = 'PU_C000027' AND MD.CD_SYSDEF = GH.YN_RETURN
LEFT JOIN MA_CODEDTL MD1 ON MD1.CD_COMPANY = MP.CD_COMPANY AND MD1.CD_FIELD = 'MA_B000065' AND MD1.CD_SYSDEF = MP.CD_PARTNER_GRP
LEFT JOIN MA_CODEDTL MD2 ON MD2.CD_COMPANY = GD.CD_COMPANY AND MD2.CD_FIELD = 'CZ_SA00021' AND MD2.CD_SYSDEF = '002'
LEFT JOIN MA_CODEDTL MD3 ON MD3.CD_COMPANY = GD.CD_COMPANY AND MD3.CD_FIELD = 'CZ_SA00020' AND MD3.CD_SYSDEF = GD.CD_PACK_CATEGORY
LEFT JOIN MA_CODEDTL MD4 ON MD4.CD_COMPANY = GD.CD_COMPANY AND MD4.CD_FIELD = MD3.CD_FLAG1 AND MD4.CD_SYSDEF = GD.CD_SUB_CATEGORY
LEFT JOIN MA_CODEDTL MD5 ON MD5.CD_COMPANY = IH.CD_COMPANY AND MD5.CD_FIELD = 'MA_B000020' AND MD5.CD_SYSDEF = IH.ARRIVER_COUNTRY
LEFT JOIN MA_CODEDTL MD6 ON MD6.CD_COMPANY = GD.CD_COMPANY AND MD6.CD_FIELD = 'CZ_SA00032' AND MD6.CD_SYSDEF = GD.CD_RMK
LEFT JOIN MA_CODEDTL MD7 ON MD7.CD_COMPANY = GH.CD_COMPANY AND MD7.CD_FIELD = 'PU_C000016' AND MD7.CD_SYSDEF = GH.TP_BUSI
LEFT JOIN MA_CODEDTL MD8 ON MD8.CD_COMPANY = GH.CD_COMPANY AND MD8.CD_FIELD = 'CZ_SA00030' AND MD8.CD_SYSDEF = GH.STA_GIR
LEFT JOIN MA_CODEDTL MD9 ON MD9.CD_COMPANY = IH.CD_COMPANY AND MD9.CD_FIELD = 'CZ_SA00018' AND MD9.CD_SYSDEF = IH.CD_PRODUCT
LEFT JOIN MA_CODEDTL MD10 ON MD10.CD_COMPANY = IH.CD_COMPANY AND MD10.CD_FIELD = 'MA_B000020' AND MD10.CD_SYSDEF = IH.CD_ORIGIN
LEFT JOIN MA_CODEDTL MD11 ON MD11.CD_COMPANY = IH.CD_COMPANY AND MD11.CD_FIELD = 'TR_IM00003' AND MD11.CD_SYSDEF = IH.TP_TRANS
LEFT JOIN MA_CODEDTL MD12 ON MD12.CD_COMPANY = IH.CD_COMPANY AND MD12.CD_FIELD = 'CZ_SA00013' AND MD12.CD_SYSDEF = IH.COND_PAY
LEFT JOIN CZ_MA_CODEDTL MD13 ON MD13.CD_COMPANY = IH.CD_COMPANY AND MD13.CD_FIELD = 'CZ_MA00004' AND MD13.CD_SYSDEF = IH.NO_TO
LEFT JOIN MA_CODEDTL MD14 ON MD14.CD_COMPANY = GH.CD_COMPANY AND MD14.CD_FIELD = 'CZ_SA00005' AND MD14.CD_SYSDEF = IH.TP_TRANSPORT
WHERE GH.CD_COMPANY = @P_CD_COMPANY
AND GH.NO_GIR IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_NO_GIR))
UNION ALL
SELECT 'N' AS S,
	   GH.CD_COMPANY,
	   MC.NM_COMPANY,
	   GH.NO_GIR,
	   GH.DT_GIR,
	   GD.DT_START,
	   GD.DT_COMPLETE,
	   '' AS DT_BILL,
	   '001' AS CD_TYPE,
	   (CASE WHEN @P_LANGUAGE = 'KR' THEN MD2.NM_SYSDEF ELSE MD2.NM_SYSDEF_E END) AS NM_TYPE1,
	   (CASE WHEN @P_LANGUAGE = 'KR' THEN MD3.NM_SYSDEF ELSE MD3.NM_SYSDEF_E END) AS NM_TYPE2,
	   (CASE WHEN @P_LANGUAGE = 'KR' THEN MD4.NM_SYSDEF ELSE MD4.NM_SYSDEF_E END) AS NM_TYPE3,
	   GD.YN_PACKING,
	   GL.YN_TAX,
	   'N' AS YN_AUTO_SUBMIT,
	   GH.STA_GIR,
	   GD.DT_PACKING AS DT_DONE,
	   ME1.NM_KOR AS NM_EMP_GIR,
	   MH.NM_VESSEL,
	   MP.LN_PARTNER,
	   GD.CD_DELIVERY_TO,
	   MP1.LN_PARTNER AS NM_GIR_PARTNER,
	   ISNULL(MD13.NM_SYSDEF, MD5.NM_SYSDEF_E) AS ARRIVER_COUNTRY,
	   GL.QT_ITEM,
	   MP.CD_PARTNER_GRP,
	   MD1.NM_SYSDEF AS NM_PARTNER_GRP,
	   GH.CD_PARTNER,
	   PT.NM_PLANT,
	   MD.NM_SYSDEF AS NM_RETURN,
	   GD.DC_RMK1,
	   GD.DC_RMK2,
	   MD6.NM_SYSDEF AS NM_RMK,
	   GD.DC_RMK,
	   GD.DC_RESULT,
	   ME.NM_KOR AS NM_EMP_SALE,
	   GD.DTS_INSERT,
	   GD.DTS_UPDATE,
	   GD.DTS_SUBMIT,
	   GD.DTS_CONFIRM,
	   GH.YN_RETURN,
	   GH.MEMO_CD,
	   GH.CHECK_PEN,
	   MD8.NM_SYSDEF AS NM_STA_GIR,
	   GD.NO_IMO,
	   MH.NO_HULL,
	   GH.CD_PLANT,
	   MD7.NM_SYSDEF AS NM_BUSI,
	   IH.NM_CONSIGNEE,
	   IH.ADDR1_CONSIGNEE,
	   IH.ADDR2_CONSIGNEE,
	   IH.NM_NOTIFY,
	   IH.ADDR1_NOTIFY,
	   IH.ADDR2_NOTIFY,
	   IH.REMARK1 AS TEL,
	   IH.REMARK2 AS EMAIL,
	   IH.REMARK3 AS PIC,
	   IH.ADDR1_PARTNER,
	   IH.ADDR2_PARTNER,
	   IH.PORT_LOADING,
	   (CASE WHEN ISNULL(MD5.NM_SYSDEF_E, '') = '' THEN ISNULL(IH.PORT_ARRIVER, '')
	   	     WHEN ISNULL(IH.PORT_ARRIVER, '') = '' THEN MD5.NM_SYSDEF_E 
	   											   ELSE (ISNULL(IH.PORT_ARRIVER, '') + ' ' + ISNULL(MD13.NM_SYSDEF, MD5.NM_SYSDEF_E)) END) AS PORT_ARRIVER,
	   IH.DT_SAILING_ON,
	   MD9.NM_SYSDEF AS NM_HS,
	   MD10.NM_SYSDEF_E AS NM_ORIGIN,
	   (MD11.NM_SYSDEF + ' ' + ISNULL(MD14.NM_SYSDEF, IH.PORT_LOADING)) AS NM_TRANS,
	   MD12.NM_SYSDEF AS NM_COND_PAY,
	   GL.NO_IO,
	   GL.DT_IO,
	   GL.NO_SALES,
	   GL.NM_ENG,
	   (CASE WHEN ISNULL(GL.DC_SIGN, '') = '' THEN '' ELSE ISNULL(@V_SERVER_PATH, '') + '/shared/image/human/sign/' + GL.CD_COMPANY + '/' + GL.DC_SIGN END) AS PATH_SIGN,
	   PH.QT_BOX,
	   GL.YN_AM,
	   GD.DC_RMK_CI,
	   GD.DC_RMK_PL,
	   STUFF((SELECT ',' + A.NO_PO_PARTNER
	   	   FROM (SELECT GL.CD_COMPANY, GL.NO_GIR, SH.NO_PO_PARTNER 
	   			 FROM SA_GIRL GL
	   			 JOIN SA_SOH SH ON SH.CD_COMPANY = GL.CD_COMPANY AND SH.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT)
	   			 WHERE ISNULL(SH.NO_PO_PARTNER, '') <> ''
	   			 GROUP BY GL.CD_COMPANY, GL.NO_GIR, SH.NO_PO_PARTNER) A
	   	   WHERE A.CD_COMPANY = GH.CD_COMPANY
	   	   AND A.NO_GIR = GH.NO_GIR
	   	   FOR XML PATH(''), TYPE).value('.', 'nvarchar(max)'), 1, 1, '') AS NO_PO_PARTNER_ALL
FROM SA_GIRH GH
LEFT JOIN MA_COMPANY MC ON MC.CD_COMPANY = GH.CD_COMPANY
LEFT JOIN CZ_SA_GIRH_WORK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
LEFT JOIN (SELECT CD_COMPANY, NO_GIR, 
				  COUNT(NO_PACK) AS QT_BOX 
		   FROM CZ_SA_PACKH
		   GROUP BY CD_COMPANY, NO_GIR) PH
ON PH.CD_COMPANY = GH.CD_COMPANY AND PH.NO_GIR = GH.NO_GIR
JOIN (SELECT GL.CD_COMPANY, GL.NO_GIR,
			 MAX(GL.NO_INV) AS NO_INV,
			 (CASE WHEN ISNULL(SUM(FT.QT_TAX), 0) > 0 THEN 'Y' ELSE 'N' END) AS YN_TAX,
			 COUNT(1) AS QT_ITEM,
			 MAX(QO.NO_IO) AS NO_IO,
			 MAX(QOH.DT_IO) AS DT_IO,
			 MAX(SO.NO_SALES) AS NO_SALES,
			 MAX(PT.DC_SIGN) AS DC_SIGN,
			 MAX(ME.NM_ENG) AS NM_ENG,
			 MAX(JT.YN_AM) AS YN_AM
	  FROM SA_GIRL GL
	  LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = GL.CD_COMPANY AND SH.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT)
	  LEFT JOIN (SELECT IL.CD_COMPANY, IL.NO_SO, IL.NO_SOLINE,
						ISNULL(SUM(IL.QT_TAX), 0) AS QT_TAX 
		 		 FROM CZ_FI_IMP_PMTL IL
		 		 GROUP BY IL.CD_COMPANY, IL.NO_SO, IL.NO_SOLINE) FT
	  ON FT.CD_COMPANY = GL.CD_COMPANY AND FT.NO_SO = SH.NO_SO AND FT.NO_SOLINE = (CASE WHEN GL.SEQ_SO = 0 THEN GL.NO_SOLINE_MGMT ELSE GL.SEQ_SO END)
	  LEFT JOIN MM_QTIO QO ON QO.CD_COMPANY = GL.CD_COMPANY AND QO.NO_ISURCV = GL.NO_GIR AND QO.NO_ISURCVLINE = GL.SEQ_GIR
	  LEFT JOIN MM_QTIOH QOH ON QOH.CD_COMPANY = QO.CD_COMPANY AND QOH.NO_IO = QO.NO_IO
	  LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = GL.CD_COMPANY AND SG.CD_SALEGRP = GL.CD_SALEGRP
	  LEFT JOIN MA_SALEORG SO ON SO.CD_COMPANY = SG.CD_COMPANY AND SO.CD_SALEORG = SG.CD_SALEORG
	  LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SO.CD_COMPANY AND ME.NO_EMP = SO.NO_SALES
	  LEFT JOIN HR_PHOTO PT ON PT.CD_COMPANY = ME.CD_COMPANY AND PT.NO_EMP = ME.NO_EMP
	  LEFT JOIN MM_EJTP JT ON JT.CD_COMPANY = GL.CD_COMPANY AND JT.CD_QTIOTP = GL.TP_GI
	  GROUP BY GL.CD_COMPANY, GL.NO_GIR) GL
ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
LEFT JOIN CZ_TR_INVH IH ON IH.CD_COMPANY = GL.CD_COMPANY AND IH.NO_INV = GL.NO_INV
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
LEFT JOIN CZ_MA_DELIVERY MP1 ON MP1.CD_COMPANY = GD.CD_COMPANY AND MP1.CD_PARTNER = GD.CD_DELIVERY_TO
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = GD.NO_IMO
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = MP.CD_COMPANY AND ME.NO_EMP = MP.CD_EMP_SALE
LEFT JOIN MA_EMP ME1 ON ME1.CD_COMPANY = GH.CD_COMPANY AND ME1.NO_EMP = GH.NO_EMP
LEFT JOIN MA_PLANT PT ON PT.CD_COMPANY = GH.CD_COMPANY AND PT.CD_PLANT = GH.CD_PLANT
LEFT JOIN MA_CODEDTL MD ON MD.CD_COMPANY = GH.CD_COMPANY AND MD.CD_FIELD = 'PU_C000027' AND MD.CD_SYSDEF = GH.YN_RETURN
LEFT JOIN MA_CODEDTL MD1 ON MD1.CD_COMPANY = MP.CD_COMPANY AND MD1.CD_FIELD = 'MA_B000065' AND MD1.CD_SYSDEF = MP.CD_PARTNER_GRP
LEFT JOIN MA_CODEDTL MD2 ON MD2.CD_COMPANY = GD.CD_COMPANY AND MD2.CD_FIELD = 'CZ_SA00021' AND MD2.CD_SYSDEF = '001'
LEFT JOIN MA_CODEDTL MD3 ON MD3.CD_COMPANY = GD.CD_COMPANY AND MD3.CD_FIELD = 'CZ_SA00006' AND MD3.CD_SYSDEF = GD.CD_MAIN_CATEGORY
LEFT JOIN MA_CODEDTL MD4 ON MD4.CD_COMPANY = GD.CD_COMPANY AND MD4.CD_FIELD = MD3.CD_FLAG1 AND MD4.CD_SYSDEF = GD.CD_SUB_CATEGORY
LEFT JOIN MA_CODEDTL MD5 ON MD5.CD_COMPANY = IH.CD_COMPANY AND MD5.CD_FIELD = 'MA_B000020' AND MD5.CD_SYSDEF = IH.ARRIVER_COUNTRY
LEFT JOIN MA_CODEDTL MD6 ON MD6.CD_COMPANY = GD.CD_COMPANY AND MD6.CD_FIELD = 'CZ_SA00032' AND MD6.CD_SYSDEF = GD.CD_RMK
LEFT JOIN MA_CODEDTL MD7 ON MD7.CD_COMPANY = GH.CD_COMPANY AND MD7.CD_FIELD = 'PU_C000016' AND MD7.CD_SYSDEF = GH.TP_BUSI
LEFT JOIN MA_CODEDTL MD8 ON MD8.CD_COMPANY = GH.CD_COMPANY AND MD8.CD_FIELD = 'CZ_SA00030' AND MD8.CD_SYSDEF = GH.STA_GIR
LEFT JOIN MA_CODEDTL MD9 ON MD9.CD_COMPANY = IH.CD_COMPANY AND MD9.CD_FIELD = 'CZ_SA00018' AND MD9.CD_SYSDEF = IH.CD_PRODUCT
LEFT JOIN MA_CODEDTL MD10 ON MD10.CD_COMPANY = IH.CD_COMPANY AND MD10.CD_FIELD = 'MA_B000020' AND MD10.CD_SYSDEF = IH.CD_ORIGIN
LEFT JOIN MA_CODEDTL MD11 ON MD11.CD_COMPANY = IH.CD_COMPANY AND MD11.CD_FIELD = 'TR_IM00003' AND MD11.CD_SYSDEF = IH.TP_TRANS
LEFT JOIN MA_CODEDTL MD12 ON MD12.CD_COMPANY = IH.CD_COMPANY AND MD12.CD_FIELD = 'CZ_SA00013' AND MD12.CD_SYSDEF = IH.COND_PAY
LEFT JOIN CZ_MA_CODEDTL MD13 ON MD13.CD_COMPANY = IH.CD_COMPANY AND MD13.CD_FIELD = 'CZ_MA00004' AND MD13.CD_SYSDEF = IH.NO_TO
LEFT JOIN MA_CODEDTL MD14 ON MD14.CD_COMPANY = GH.CD_COMPANY AND MD14.CD_FIELD = 'CZ_SA00005' AND MD14.CD_SYSDEF = IH.TP_TRANSPORT
WHERE GH.CD_COMPANY = @P_CD_COMPANY
AND GH.NO_GIR IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_NO_GIR))
ORDER BY GH.NO_GIR

SELECT GH.NO_GIR,
	   GL.CD_ITEM,
	   QL.NO_DSP,
	   QL.NM_SUBJECT,
	   (CASE WHEN GH.CD_PARTNER = '11972' AND ISNULL(QL.CD_UNIQUE_PARTNER, '') <> '' THEN ISNULL(QL.CD_ITEM_PARTNER, '') + '(' + QL.CD_UNIQUE_PARTNER + ')'
																					 ELSE QL.CD_ITEM_PARTNER END) AS CD_ITEM_PARTNER,
	   ISNULL(QL.NM_ITEM_PARTNER, MI.NM_ITEM) AS NM_ITEM_PARTNER,
	   QL.TP_BOM,
	   QL.YN_DSP_RMK,
	   QL.DC_RMK,
	   GL.UNIT,
	   MC.NM_SYSDEF AS NM_EXCH,
	   SL.NO_SO,
	   MP.LN_PARTNER AS GI_LN_PARTNER,
	   MH.NO_HULL,
	   MH.NM_VESSEL,
	   SH.NO_PO_PARTNER,
	   WD.DT_COMPLETE,
	   (CASE WHEN GH.YN_RETURN = 'Y' THEN -(ISNULL(GL.QT_GIR, 0) * ISNULL(QL.QT_BOM, 1)) 
									 ELSE (ISNULL(GL.QT_GIR, 0) * ISNULL(QL.QT_BOM, 1)) END) AS QT_GIR,
	   ISNULL(SL.UM_EX_Q, 0) AS UM_EX_Q,
	   (ISNULL(SL.UM_EX_Q, 0) * ISNULL(GL.QT_GIR, 0)) AS AM_EX_Q,
	   ISNULL(SL.RT_DC, 0) AS RT_DC,
	   -ROUND((ISNULL(SL.UM_EX_Q, 0) - ISNULL(SL.UM_EX_S, 0)) * ISNULL(GL.QT_GIR, 0), 2) AS AM_DC,
	   (CASE WHEN GH.YN_RETURN = 'Y' THEN -GL.AM_GIR ELSE GL.AM_GIR END) AS AM_GIR,
	   '' AS NO_KEY1,
	   ISNULL(GL.TXT_USERDEF1, '') AS CD_QR,
	   ISNULL(GL.TXT_USERDEF1, 'RCT') AS CD_QR_RCT,
	   ISNULL(GL.TXT_USERDEF2, 'CI') AS CD_QR_CI,
	   ISNULL(GL.TXT_USERDEF3, 'PL') AS CD_QR_PL,
	   FT.MODEL,
	   FT.UNIT_IMP,
	   FT.HSCODE,
	   FT.ORIGIN,
	   FT.NO_IMPORT,
	   FT.CUSTOMS,
	   (CASE WHEN EXISTS (SELECT 1 
		                  FROM PU_POL PL
			              WHERE PL.CD_COMPANY = SL.CD_COMPANY
			              AND PL.NO_SO = SL.NO_SO
			              AND PL.NO_SOLINE = SL.SEQ_SO
			              AND PL.YN_BL = 'Y') THEN 'Y' ELSE 'N' END) AS YN_BL,
       (CASE WHEN QL.TP_BOM = 'C' THEN 0
							      ELSE (CASE WHEN GH.YN_RETURN = 'Y' THEN -ISNULL(GL.UM, 0) 
																	 ELSE ISNULL(GL.UM, 0) END) END) AS UM_EX
FROM SA_GIRH GH
LEFT JOIN CZ_SA_GIRH_WORK_DETAIL WD ON WD.CD_COMPANY = GH.CD_COMPANY AND WD.NO_GIR = GH.NO_GIR
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = WD.NO_IMO
JOIN SA_GIRL GL ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = GL.CD_COMPANY AND MI.CD_PLANT = GH.CD_PLANT AND MI.CD_ITEM = GL.CD_ITEM
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = GL.CD_COMPANY AND MC.CD_FIELD = 'MA_B000005' AND MC.CD_SYSDEF = GL.CD_EXCH
LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = GL.CD_COMPANY AND SL.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT) AND SL.SEQ_SO = (CASE WHEN GL.SEQ_SO = 0 THEN GL.NO_SOLINE_MGMT ELSE GL.SEQ_SO END)
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = SL.CD_COMPANY AND SH.NO_SO = SL.NO_SO
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GL.CD_COMPANY AND MP.CD_PARTNER = GL.GI_PARTNER
LEFT JOIN (SELECT IL.CD_COMPANY, IL.NO_SO, IL.NO_SOLINE, 
		   	      MAX(DL.MODEL) AS MODEL,
		   	      MAX(DL.UNIT) AS UNIT_IMP,
		   	      MAX(DL.HSCODE) AS HSCODE,
		   	      LEFT(MAX(DL.ORIGIN), 2) AS ORIGIN,
				  MAX(IL.NO_IMPORT) AS NO_IMPORT,
				  SUM(DL.CUSTOMS) AS CUSTOMS
		   FROM CZ_FI_IMP_PMTL IL
		   LEFT JOIN CZ_PU_IMPORT_DECLARATIONL DL ON DL.CD_COMPANY = IL.CD_COMPANY AND REPLACE(DL.NO_IMPORT, '-', '') = IL.NO_IMPORT AND DL.SEQ = IL.SEQ_IMPORT
		   LEFT JOIN CZ_PU_IMPORT_DECLARATIONH DH ON DH.CD_COMPANY = DL.CD_COMPANY AND DH.NO_IMPORT = DL.NO_IMPORT
		   GROUP BY IL.CD_COMPANY, IL.NO_SO, IL.NO_SOLINE) FT
ON FT.CD_COMPANY = SL.CD_COMPANY AND FT.NO_SO = SL.NO_SO AND FT.NO_SOLINE = SL.SEQ_SO
LEFT JOIN (SELECT QC.CD_COMPANY, 
				  QC.NO_FILE, 
				  QC.NO_LINE, 
				  QC.NO_LINE_PARENT, 
				  QC.NO_DSP, 
				  QC.NM_SUBJECT, 
				  QC.CD_ITEM_PARTNER,
				  QC.CD_UNIQUE_PARTNER,
				  QC.NM_ITEM_PARTNER,
				  QC.TP_BOM,
				  QC.YN_DSP_RMK, 
				  QC.DC_RMK,
				  (QC.QT / (CASE WHEN QP.QT = 0 THEN 1 ELSE QP.QT END)) AS QT_BOM
		   FROM CZ_SA_QTNL QC
		   LEFT JOIN CZ_SA_QTNL QP ON QP.CD_COMPANY = QC.CD_COMPANY AND QP.NO_FILE = QC.NO_FILE AND QP.NO_LINE = QC.NO_LINE_PARENT) QL 
ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND (QL.NO_LINE = SL.SEQ_SO OR QL.NO_LINE_PARENT = SL.SEQ_SO)
WHERE GH.CD_COMPANY = @P_CD_COMPANY
AND GH.NO_GIR IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_NO_GIR))
UNION ALL
SELECT GH.NO_GIR,
	   GL.CD_ITEM,
	   QL.NO_DSP,
	   QL.NM_SUBJECT,
	   (CASE WHEN GH.CD_PARTNER = '11972' AND ISNULL(QL.CD_UNIQUE_PARTNER, '') <> '' THEN ISNULL(QL.CD_ITEM_PARTNER, '') + '(' + QL.CD_UNIQUE_PARTNER + ')'
																					 ELSE QL.CD_ITEM_PARTNER END) AS CD_ITEM_PARTNER,
	   ISNULL(QL.NM_ITEM_PARTNER, MI.NM_ITEM) AS NM_ITEM_PARTNER,
	   QL.TP_BOM,
	   QL.YN_DSP_RMK,
	   QL.DC_RMK,
	   GL.UNIT,
	   MC.NM_SYSDEF AS NM_EXCH,
	   SL.NO_SO,
	   MP.LN_PARTNER AS GI_LN_PARTNER,
	   MH.NO_HULL,
	   MH.NM_VESSEL,
	   SH.NO_PO_PARTNER,
	   WD.DT_COMPLETE,
	   (CASE WHEN GH.YN_RETURN = 'Y' THEN -(ISNULL(GL.QT_GIR, 0) * ISNULL(QL.QT_BOM, 1)) 
									 ELSE (ISNULL(GL.QT_GIR, 0) * ISNULL(QL.QT_BOM, 1)) END) AS QT_GIR,
	   ISNULL(SL.UM_EX_Q, 0) AS UM_EX_Q,
	   (ISNULL(SL.UM_EX_Q, 0) * ISNULL(GL.QT_GIR, 0)) AS AM_EX_Q,
	   ISNULL(SL.RT_DC, 0) AS RT_DC,
	   -ROUND((ISNULL(SL.UM_EX_Q, 0) - ISNULL(SL.UM_EX_S, 0)) * ISNULL(GL.QT_GIR, 0), 2) AS AM_DC,
	   (CASE WHEN GH.YN_RETURN = 'Y' THEN -GL.AM_GIR ELSE GL.AM_GIR END) AS AM_GIR,
	   '' AS NO_KEY1,
	   '' AS CD_QR,
	   'PACK' AS CD_QR_RCT,
	   'PACK' AS CD_QR_CI,
	   'PACK' AS CD_QR_PL,
	   FT.MODEL,
	   FT.UNIT_IMP,
	   FT.HSCODE,
	   FT.ORIGIN,
	   FT.NO_IMPORT,
	   FT.CUSTOMS,
	   (CASE WHEN EXISTS (SELECT 1 
		                  FROM PU_POL PL
			              WHERE PL.CD_COMPANY = SL.CD_COMPANY
			              AND PL.NO_SO = SL.NO_SO
			              AND PL.NO_SOLINE = SL.SEQ_SO
			              AND PL.YN_BL = 'Y') THEN 'Y' ELSE 'N' END) AS YN_BL,
       (CASE WHEN QL.TP_BOM = 'C' THEN 0
							      ELSE (CASE WHEN GH.YN_RETURN = 'Y' THEN -ISNULL(GL.UM, 0) 
																	 ELSE ISNULL(GL.UM, 0) END) END) AS UM_EX
FROM CZ_SA_GIRH_PACK GH
LEFT JOIN CZ_SA_GIRH_PACK_DETAIL WD ON WD.CD_COMPANY = GH.CD_COMPANY AND WD.NO_GIR = GH.NO_GIR
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = WD.NO_IMO
JOIN CZ_SA_GIRL_PACK GL ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.NO_GIR = GH.NO_GIR
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = GL.CD_COMPANY AND MI.CD_PLANT = GH.CD_PLANT AND MI.CD_ITEM = GL.CD_ITEM
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = GL.CD_COMPANY AND MC.CD_FIELD = 'MA_B000005' AND MC.CD_SYSDEF = GL.CD_EXCH
LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = GL.CD_COMPANY AND SL.NO_SO = ISNULL(GL.NO_SO, GL.NO_SO_MGMT) AND SL.SEQ_SO = (CASE WHEN GL.SEQ_SO = 0 THEN GL.NO_SOLINE_MGMT ELSE GL.SEQ_SO END)
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = SL.CD_COMPANY AND SH.NO_SO = SL.NO_SO
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GL.CD_COMPANY AND MP.CD_PARTNER = GL.GI_PARTNER
LEFT JOIN (SELECT IL.CD_COMPANY, IL.NO_SO, IL.NO_SOLINE, 
		   	      MAX(DL.MODEL) AS MODEL,
		   	      MAX(DL.UNIT) AS UNIT_IMP,
		   	      MAX(DL.HSCODE) AS HSCODE,
		   	      LEFT(MAX(DL.ORIGIN), 2) AS ORIGIN,
				  MAX(IL.NO_IMPORT) AS NO_IMPORT,
				  SUM(DL.CUSTOMS) AS CUSTOMS
		   FROM CZ_FI_IMP_PMTL IL
		   LEFT JOIN CZ_PU_IMPORT_DECLARATIONL DL ON DL.CD_COMPANY = IL.CD_COMPANY AND REPLACE(DL.NO_IMPORT, '-', '') = IL.NO_IMPORT AND DL.SEQ = IL.SEQ_IMPORT
		   LEFT JOIN CZ_PU_IMPORT_DECLARATIONH DH ON DH.CD_COMPANY = DL.CD_COMPANY AND DH.NO_IMPORT = DL.NO_IMPORT
		   GROUP BY IL.CD_COMPANY, IL.NO_SO, IL.NO_SOLINE) FT
ON FT.CD_COMPANY = SL.CD_COMPANY AND FT.NO_SO = SL.NO_SO AND FT.NO_SOLINE = SL.SEQ_SO
LEFT JOIN (SELECT QC.CD_COMPANY, 
				  QC.NO_FILE, 
				  QC.NO_LINE, 
				  QC.NO_LINE_PARENT, 
				  QC.NO_DSP, 
				  QC.NM_SUBJECT, 
				  QC.CD_ITEM_PARTNER,
				  QC.CD_UNIQUE_PARTNER,
				  QC.NM_ITEM_PARTNER,
				  QC.TP_BOM, 
				  QC.YN_DSP_RMK, 
				  QC.DC_RMK,
				  (QC.QT / (CASE WHEN QP.QT = 0 THEN 1 ELSE QP.QT END)) AS QT_BOM
		   FROM CZ_SA_QTNL QC
		   LEFT JOIN CZ_SA_QTNL QP ON QP.CD_COMPANY = QC.CD_COMPANY AND QP.NO_FILE = QC.NO_FILE AND QP.NO_LINE = QC.NO_LINE_PARENT) QL 
ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND (QL.NO_LINE = SL.SEQ_SO OR QL.NO_LINE_PARENT = SL.SEQ_SO)
WHERE GH.CD_COMPANY = @P_CD_COMPANY
AND GH.NO_GIR IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_NO_GIR))
ORDER BY GH.NO_GIR, SL.NO_SO, QL.NO_DSP

GO
