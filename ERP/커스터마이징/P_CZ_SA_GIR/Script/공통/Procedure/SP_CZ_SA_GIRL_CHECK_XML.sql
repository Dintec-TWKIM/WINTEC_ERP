USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIRL_CHECK_XML]    Script Date: 2019-02-18 오전 10:46:41 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIRL_CHECK_XML] 
(
	@P_CD_COMPANY	NVARCHAR(7),
	@P_NO_GIR		NVARCHAR(20),
	@P_XML			XML, 
	@P_ID_USER		NVARCHAR(10)
) 
AS 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_DOC INT
 
EXEC SP_XML_PREPAREDOCUMENT @V_DOC OUTPUT, @P_XML 

SELECT @P_CD_COMPANY AS CD_COMPANY,
	   SL.NO_SO,
	   SL.SEQ_SO,
	   PL.QT_GIR AS QT_GIR_PACK,
	   GL.QT_GIR
FROM OPENXML (@V_DOC, '/XML/ROW', 2) WITH 
(
    NO_SO			NVARCHAR(20),
	SEQ_SO			NUMERIC(5, 0)
) SL
LEFT JOIN SA_SOL SL1 ON SL1.CD_COMPANY = @P_CD_COMPANY AND SL1.NO_SO = SL.NO_SO AND SL1.SEQ_SO = SL.SEQ_SO
LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.SEQ_SO,
				  SUM(PL.QT_GIR) AS QT_GIR 
		   FROM CZ_SA_GIRL_PACK PL
		   WHERE EXISTS (SELECT 1 
						 FROM CZ_SA_GIRH_PACK PH
						 JOIN CZ_SA_GIRH_PACK_DETAIL PD ON PD.CD_COMPANY = PH.CD_COMPANY AND PD.NO_GIR = PH.NO_GIR
						 WHERE PH.CD_COMPANY = PL.CD_COMPANY
						 AND PH.NO_GIR = PL.NO_GIR
						 AND PD.CD_PACK_CATEGORY = '001'
						 AND PH.NO_GIR <> @P_NO_GIR
						 AND (PH.STA_GIR IS NULL OR PH.STA_GIR IN ('', 'R', 'O', 'D')))
		   GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.SEQ_SO) PL
ON PL.CD_COMPANY = @P_CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.SEQ_SO = SL.SEQ_SO
LEFT JOIN (SELECT GL.CD_COMPANY, GL.NO_SO, GL.SEQ_SO,
				  SUM(GL.QT_GIR) AS QT_GIR 
		   FROM SA_GIRL GL
		   WHERE EXISTS (SELECT 1 
						 FROM SA_GIRH
						 WHERE CD_COMPANY = GL.CD_COMPANY
						 AND NO_GIR = GL.NO_GIR
						 AND NO_GIR <> @P_NO_GIR
						 AND (STA_GIR IS NULL OR STA_GIR IN ('', 'R', 'O', 'D'))
						 AND (YN_RETURN IS NULL OR YN_RETURN = 'N'))
		   GROUP BY GL.CD_COMPANY, GL.NO_SO, GL.SEQ_SO) GL
ON GL.CD_COMPANY = @P_CD_COMPANY AND GL.NO_SO = SL.NO_SO AND GL.SEQ_SO = SL.SEQ_SO
WHERE ((PL.QT_GIR IS NOT NULL AND PL.QT_GIR > 0) OR 
	   (GL.QT_GIR IS NOT NULL AND GL.QT_GIR > 0))
AND (SL1.YN_PARTIAL_DELV IS NULL OR SL1.YN_PARTIAL_DELV = 'N')

EXEC SP_XML_REMOVEDOCUMENT @V_DOC

GO

