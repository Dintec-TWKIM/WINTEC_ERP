USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIRH_U]    Script Date: 2015-04-28 오전 11:10:47 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*******************************************
**  System : 영업
**  Sub System : 출고의뢰관리        
**  Page  : 고객납품의뢰등록
**  Desc  : 고객납품의뢰 헤더 수정
**
**  Return Values
**
**  작    성    자  : 
**  작    성    일 : 
**  수    정    자     : 허성철
*********************************************
** Change History
*********************************************
*********************************************/
ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIRH_U]
(  
	@P_CD_COMPANY			NVARCHAR(7),                
	@P_NO_GIR				NVARCHAR(20),		--의뢰번호
	@P_DT_GIR				NVARCHAR(8),		--의뢰일자
	@P_NO_EMP				NVARCHAR(10),		--사번
	@P_MAIN_CATEGORY		NVARCHAR(3),
	@P_SUB_CATEGORY			NVARCHAR(3),
	@P_YN_PACKING			NVARCHAR(1),
	@P_YN_TAX_RETURN		NVARCHAR(1),
	@P_CD_DELIVERY_TO		NVARCHAR(20),
	@P_SEQ_DELIVERY_PIC		NVARCHAR(5),
	@P_CD_FREIGHT			NVARCHAR(3),
	@P_CD_FORWARDER			NVARCHAR(20),
	@P_WEIGHT				NUMERIC(17,4),
	@P_DT_START				NVARCHAR(8),
	@P_DT_COMPLETE			NVARCHAR(8),
	@P_YN_AUTO_SUBMIT		NVARCHAR(1),
	@P_DT_AUTO_COMPLETE		INT,
	@P_DT_BILL				NVARCHAR(8),
	@P_FG_REASON			NVARCHAR(1),
	@P_CD_RMK				NVARCHAR(3),		--협조내용
	@P_DC_RMK				NVARCHAR(MAX),		--상세요청
	@P_DC_RMK1				NVARCHAR(MAX),		--취소사유
	@P_DC_RMK2				NVARCHAR(MAX),		--매출비고
	@P_DC_RMK3				NVARCHAR(MAX),		--기포장정보
	@P_DC_RMK4				NVARCHAR(MAX),		--PICKING비고
	@P_DC_RMK5				NVARCHAR(MAX),		--포장비고
	@P_NM_FORWARDER_A		NVARCHAR(50),
	@P_AM_FORWARDER_A		NUMERIC(14,2),
	@P_NM_FORWARDER_B		NVARCHAR(50),
	@P_AM_FORWARDER_B		NUMERIC(14,2),
	@P_NM_FORWARDER_C		NVARCHAR(50),
	@P_AM_FORWARDER_C		NUMERIC(14,2),
	@P_NO_IMO				NVARCHAR(10),
	@P_NO_IMO_BILL			NVARCHAR(10),
	@P_TP_CHARGE			NVARCHAR(4),
	@P_NM_DELIVERY		   NVARCHAR(100),
	@P_DC_DELIVERY_ADDR	   NVARCHAR(200),
	@P_DC_DELIVERY_TEL	   NVARCHAR(100),
	@P_DC_DESTINATION	   NVARCHAR(50),
	@P_YN_REVIEW		   NVARCHAR(1),
	@P_YN_SHIPPING		   NVARCHAR(1),
	@P_YN_CI			   NVARCHAR(1),
	@P_YN_RECEIPT		   NVARCHAR(1),
	@P_YN_REFUND		   NVARCHAR(1),
	@P_NO_GIR_SG		   NVARCHAR(20),
	@P_YN_LOADING		   NVARCHAR(1),
	@P_DC_RMK_ADD		   NVARCHAR(500),
	@P_YN_DOMESTIC		   NVARCHAR(1),
	@P_CD_SHIP_LOCATION    NVARCHAR(4),
	@P_YN_PRE_PHOTO		   NVARCHAR(1),
	@P_YN_POST_PHOTO	   NVARCHAR(1),
	@P_DC_PHOTO			   NVARCHAR(100),
	@P_YN_SPEC_CHECK	   NVARCHAR(1),
	@P_DC_SPEC			   NVARCHAR(100),
	@P_YN_SEPARATE_PACK	   NVARCHAR(1),
	@P_DC_SEPARATE	       NVARCHAR(100),
	@P_YN_CERT			   NVARCHAR(1),
	@P_YN_UNIDENTIFIABLE   NVARCHAR(1),
	@P_NO_FILE			   NVARCHAR(20),
	@P_TM_DELIVERY		   NVARCHAR(3),
	@P_DC_RMK_PACK		   NVARCHAR(500),
	@P_CD_PORT			   NVARCHAR(4),
	@P_DTS_ETB			   NVARCHAR(11),
	@P_DTS_ETD			   NVARCHAR(11),
	@P_DC_AGENCY		   NVARCHAR(50),
	@P_DC_RMK_SHIP		   NVARCHAR(200),
	@P_YN_UNPACK		   NVARCHAR(1),
	@P_DC_UNPACK		   NVARCHAR(100),
	@P_DTS_DEADLINE		   NVARCHAR(11),
    @P_YN_ETC			   NVARCHAR(1),
    @P_YN_EDIT			   NVARCHAR(1),
	@P_DC_VESSEL		   NVARCHAR(100),
	@P_DC_SHIP_CRANE	   NVARCHAR(100),
	@P_ID_UPDATE		   NVARCHAR(15)		--아이디
)   
AS  

UPDATE	SA_GIRH
SET     DT_GIR		    = @P_DT_GIR,   
		NO_EMP		    = @P_NO_EMP,
		ID_UPDATE       = @P_ID_UPDATE,
		DTS_UPDATE      = NEOE.SF_SYSDATE(GETDATE())
WHERE   CD_COMPANY      = @P_CD_COMPANY
AND     NO_GIR          = @P_NO_GIR

IF EXISTS (SELECT 1 
		   FROM CZ_SA_GIRH_REMARK GR
		   WHERE GR.CD_COMPANY = @P_CD_COMPANY
		   AND GR.NO_GIR = @P_NO_GIR)
BEGIN
	UPDATE CZ_SA_GIRH_REMARK
	SET NM_DELIVERY = @P_NM_DELIVERY,
		DC_DELIVERY_ADDR = @P_DC_DELIVERY_ADDR,
		DC_DELIVERY_TEL = @P_DC_DELIVERY_TEL,
		DC_DESTINATION = @P_DC_DESTINATION,
		YN_REVIEW = @P_YN_REVIEW,
		YN_SHIPPING = @P_YN_SHIPPING,
		YN_CI = @P_YN_CI,
		YN_RECEIPT = @P_YN_RECEIPT,
		YN_REFUND = @P_YN_REFUND,
		NO_GIR_SG = @P_NO_GIR_SG,
		YN_LOADING = @P_YN_LOADING,
		DC_RMK_ADD = @P_DC_RMK_ADD,
		YN_DOMESTIC = @P_YN_DOMESTIC,
		CD_SHIP_LOCATION = @P_CD_SHIP_LOCATION,
		YN_PRE_PHOTO = @P_YN_PRE_PHOTO,
		YN_POST_PHOTO = @P_YN_POST_PHOTO,
		DC_PHOTO = @P_DC_PHOTO,
		YN_SPEC_CHECK = @P_YN_SPEC_CHECK,
		DC_SPEC = @P_DC_SPEC,
		YN_SEPARATE_PACK = @P_YN_SEPARATE_PACK,
		DC_SEPARATE = @P_DC_SEPARATE,
		YN_CERT = @P_YN_CERT,
		YN_UNIDENTIFIABLE = @P_YN_UNIDENTIFIABLE,
		NO_FILE = @P_NO_FILE,
		TM_DELIVERY = @P_TM_DELIVERY,
		DC_RMK_PACK = @P_DC_RMK_PACK,
		CD_PORT = @P_CD_PORT,
		DTS_ETB = @P_DTS_ETB,
		DTS_ETD = @P_DTS_ETD,
		DC_AGENCY = @P_DC_AGENCY,
		DC_RMK_SHIP = @P_DC_RMK_SHIP,
		YN_UNPACK = @P_YN_UNPACK,
		DC_UNPACK = @P_DC_UNPACK,
		DTS_DEADLINE = @P_DTS_DEADLINE,
	    YN_ETC = @P_YN_ETC,
	    YN_EDIT = @P_YN_EDIT,
		DC_VESSEL = @P_DC_VESSEL,
		DC_SHIP_CRANE = @P_DC_SHIP_CRANE,
		ID_UPDATE = @P_ID_UPDATE,
		DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	WHERE CD_COMPANY = @P_CD_COMPANY
	AND NO_GIR = @P_NO_GIR
END
ELSE
BEGIN
	INSERT INTO CZ_SA_GIRH_REMARK
	(
		CD_COMPANY,
		NO_GIR,
		NM_DELIVERY,
		DC_DELIVERY_ADDR,
		DC_DELIVERY_TEL,
		DC_DESTINATION,
		YN_REVIEW,
		YN_SHIPPING,
		YN_CI,
		YN_RECEIPT,
		YN_REFUND,
		NO_GIR_SG,
		YN_LOADING,
		DC_RMK_ADD,
		YN_DOMESTIC,
		CD_SHIP_LOCATION,
		YN_PRE_PHOTO,
		YN_POST_PHOTO,
		DC_PHOTO,
		YN_SPEC_CHECK,
		DC_SPEC,
		YN_SEPARATE_PACK,
		DC_SEPARATE,
		YN_CERT,
		YN_UNIDENTIFIABLE,
		NO_FILE,
		TM_DELIVERY,
		DC_RMK_PACK,
		CD_PORT,
		DTS_ETB,
		DTS_ETD,
		DC_AGENCY,
		DC_RMK_SHIP,
		YN_UNPACK,
		DC_UNPACK,
		DTS_DEADLINE,
	    YN_ETC,
	    YN_EDIT,
		DC_VESSEL,
		DC_SHIP_CRANE,
		ID_INSERT,
		DTS_INSERT
	)
	VALUES
	(
		@P_CD_COMPANY,
		@P_NO_GIR,
		@P_NM_DELIVERY,
		@P_DC_DELIVERY_ADDR,
		@P_DC_DELIVERY_TEL,
		@P_DC_DESTINATION,
		@P_YN_REVIEW,
		@P_YN_SHIPPING,
		@P_YN_CI,
		@P_YN_RECEIPT,
		@P_YN_REFUND,
		@P_NO_GIR_SG,
		@P_YN_LOADING,
		@P_DC_RMK_ADD,
		@P_YN_DOMESTIC,
		@P_CD_SHIP_LOCATION,
		@P_YN_PRE_PHOTO,
		@P_YN_POST_PHOTO,
		@P_DC_PHOTO,
		@P_YN_SPEC_CHECK,
		@P_DC_SPEC,
		@P_YN_SEPARATE_PACK,
		@P_DC_SEPARATE,
		@P_YN_CERT,
		@P_YN_UNIDENTIFIABLE,
		@P_NO_FILE,
		@P_TM_DELIVERY,
		@P_DC_RMK_PACK,
		@P_CD_PORT,
		@P_DTS_ETB,
		@P_DTS_ETD,
		@P_DC_AGENCY,
		@P_DC_RMK_SHIP,
		@P_YN_UNPACK,
		@P_DC_UNPACK,
		@P_DTS_DEADLINE,
	    @P_YN_ETC,
	    @P_YN_EDIT,
		@P_DC_VESSEL,
		@P_DC_SHIP_CRANE,
		@P_ID_UPDATE,
	    NEOE.SF_SYSDATE(GETDATE()) 
	)
END

UPDATE WD
SET WD.CD_TAEGBAE = (CASE WHEN MD.CD_PARTNER IN ('DLV230200077', 
												 'DLV230200076', 
												 'DLV230200075', 
												 'DLV230200054') AND WD.CD_MAIN_CATEGORY = '003' AND WD.CD_SUB_CATEGORY = '005' THEN NULL
						  WHEN WD.CD_MAIN_CATEGORY = '003' AND WD.CD_SUB_CATEGORY IN ('004', '005') THEN MD.CD_TAEGBAE 
																									ELSE NULL END),
	WD.DC_RMK_PL = (CASE WHEN (WD.CD_MAIN_CATEGORY = '003' AND WD.CD_SUB_CATEGORY = '004') THEN ISNULL(GR.NM_DELIVERY, '') + ' ' + 
																							    ISNULL(GR.DC_DELIVERY_ADDR, '') + ' ' + 
																							    ISNULL(GR.DC_DELIVERY_TEL, '') + ' ' +
																								ISNULL(MC.NM_SYSDEF, '') ELSE ISNULL(GR.NM_DELIVERY, '') END),
    WD.CD_MAIN_CATEGORY = @P_MAIN_CATEGORY,
	WD.CD_SUB_CATEGORY = @P_SUB_CATEGORY,
	WD.YN_PACKING = @P_YN_PACKING,
	WD.YN_TAX_RETURN = @P_YN_TAX_RETURN,
	WD.CD_DELIVERY_TO = @P_CD_DELIVERY_TO,
	WD.SEQ_DELIVERY_PIC = @P_SEQ_DELIVERY_PIC,
	WD.CD_FREIGHT = @P_CD_FREIGHT,
	WD.CD_FORWARDER = @P_CD_FORWARDER,
	WD.WEIGHT = @P_WEIGHT,
	WD.DT_START = @P_DT_START,
	WD.DT_COMPLETE = @P_DT_COMPLETE,
	WD.YN_AUTO_SUBMIT = @P_YN_AUTO_SUBMIT,
	WD.DT_AUTO_COMPLETE = @P_DT_AUTO_COMPLETE,
	WD.DT_BILL = @P_DT_BILL,
	WD.FG_REASON = @P_FG_REASON,
	WD.NO_IMO = @P_NO_IMO,
	WD.NO_IMO_BILL = @P_NO_IMO_BILL,
	WD.CD_RMK = @P_CD_RMK,
	WD.TP_CHARGE = @P_TP_CHARGE,
	WD.DC_RMK = @P_DC_RMK,
	WD.DC_RMK1 = @P_DC_RMK1,
	WD.DC_RMK2 = @P_DC_RMK2,
	WD.DC_RMK3 = @P_DC_RMK3,
	WD.DC_RMK4 = @P_DC_RMK4,
	WD.ID_UPDATE = @P_ID_UPDATE,
	WD.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
FROM CZ_SA_GIRH_WORK_DETAIL WD
LEFT JOIN CZ_MA_DELIVERY_MAP DM ON DM.CD_COMPANY = WD.CD_COMPANY AND DM.CD_PARTNER_OLD = WD.CD_DELIVERY_TO
LEFT JOIN CZ_MA_DELIVERY MD ON MD.CD_COMPANY = WD.CD_COMPANY AND MD.CD_PARTNER = ISNULL(DM.CD_PARTNER_NEW, WD.CD_DELIVERY_TO)
LEFT JOIN CZ_SA_GIRH_REMARK GR ON GR.CD_COMPANY = WD.CD_COMPANY AND GR.NO_GIR = WD.NO_GIR
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = WD.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00032' AND MC.CD_SYSDEF = WD.CD_RMK
WHERE WD.CD_COMPANY = @P_CD_COMPANY
AND WD.NO_GIR = @P_NO_GIR

IF (@P_MAIN_CATEGORY = '003' AND (@P_SUB_CATEGORY = '001' OR @P_SUB_CATEGORY = '002'))
BEGIN
	IF EXISTS (SELECT 1 FROM CZ_SA_GIRH_FORWARDER WHERE CD_COMPANY = @P_CD_COMPANY AND NO_GIR = @P_NO_GIR AND CD_FORWARDER = '001')
		UPDATE CZ_SA_GIRH_FORWARDER
		SET	   NM_FORWARDER = @P_NM_FORWARDER_A,
			   AM_PRICE		= @P_AM_FORWARDER_A,
			   ID_UPDATE	= @P_ID_UPDATE,
			   DTS_UPDATE	= NEOE.SF_SYSDATE(GETDATE())
		WHERE CD_COMPANY	= @P_CD_COMPANY
		AND	  NO_GIR        = @P_NO_GIR
		AND	  CD_FORWARDER	= '001'
	ELSE
		INSERT INTO CZ_SA_GIRH_FORWARDER 
		(
			CD_COMPANY,
			NO_GIR,
			CD_FORWARDER,
			NM_FORWARDER,
			AM_PRICE,
			ID_INSERT,
			DTS_INSERT
		)
		VALUES 
		(
			@P_CD_COMPANY,
			@P_NO_GIR,
			'001',
			@P_NM_FORWARDER_A,
			@P_AM_FORWARDER_A,
			@P_ID_UPDATE,
			NEOE.SF_SYSDATE(GETDATE())
		)
		
	IF EXISTS (SELECT 1 FROM CZ_SA_GIRH_FORWARDER WHERE CD_COMPANY = @P_CD_COMPANY AND NO_GIR = @P_NO_GIR AND CD_FORWARDER = '002')
		UPDATE CZ_SA_GIRH_FORWARDER
		SET	   NM_FORWARDER = @P_NM_FORWARDER_B,
			   AM_PRICE		= @P_AM_FORWARDER_B,
			   ID_UPDATE	= @P_ID_UPDATE,
			   DTS_UPDATE	= NEOE.SF_SYSDATE(GETDATE())
		WHERE CD_COMPANY	= @P_CD_COMPANY
		AND	  NO_GIR        = @P_NO_GIR
		AND	  CD_FORWARDER	= '002'
	ELSE
		INSERT INTO CZ_SA_GIRH_FORWARDER 
		(
			CD_COMPANY,
			NO_GIR,
			CD_FORWARDER,
			NM_FORWARDER,
			AM_PRICE,
			ID_INSERT,
			DTS_INSERT
		)
		VALUES 
		(
			@P_CD_COMPANY,
			@P_NO_GIR,
			'002',
			@P_NM_FORWARDER_B,
			@P_AM_FORWARDER_B,
			@P_ID_UPDATE,
			NEOE.SF_SYSDATE(GETDATE())
	    )

	IF EXISTS (SELECT 1 FROM CZ_SA_GIRH_FORWARDER WHERE CD_COMPANY = @P_CD_COMPANY AND NO_GIR = @P_NO_GIR AND CD_FORWARDER = '004')
		UPDATE CZ_SA_GIRH_FORWARDER
		SET	   NM_FORWARDER = @P_NM_FORWARDER_C,
			   AM_PRICE		= @P_AM_FORWARDER_C,
			   ID_UPDATE	= @P_ID_UPDATE,
			   DTS_UPDATE	= NEOE.SF_SYSDATE(GETDATE())
		WHERE CD_COMPANY	= @P_CD_COMPANY
		AND	  NO_GIR        = @P_NO_GIR
		AND	  CD_FORWARDER	= '004'
	ELSE
		INSERT INTO CZ_SA_GIRH_FORWARDER 
		(
			CD_COMPANY,
			NO_GIR,
			CD_FORWARDER,
			NM_FORWARDER,
			AM_PRICE,
			ID_INSERT,
			DTS_INSERT
		)
		VALUES 
		(
			@P_CD_COMPANY,
			@P_NO_GIR,
			'004',
			@P_NM_FORWARDER_C,
			@P_AM_FORWARDER_C,
			@P_ID_UPDATE,
			NEOE.SF_SYSDATE(GETDATE())
		)
END
ELSE
BEGIN
	UPDATE CZ_SA_GIRH_WORK_DETAIL
	SET CD_FORWARDER = NULL,
		FG_REASON = NULL,
		WEIGHT = NULL
	WHERE CD_COMPANY = @P_CD_COMPANY
	AND	NO_GIR = @P_NO_GIR

	DELETE FROM CZ_SA_GIRH_FORWARDER
	WHERE CD_COMPANY	= @P_CD_COMPANY
	AND	  NO_GIR        = @P_NO_GIR
END
	
GO