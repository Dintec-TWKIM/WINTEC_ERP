USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIR_NOT_IN_CHK]    Script Date: 2016-11-04 오후 3:34:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIR_NOT_IN_CHK]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_NO_GIR			NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

;WITH A AS
(
    SELECT SL.CD_COMPANY,
           SL.NO_SO,
           SL.SEQ_SO,
           SL.QT_GIR,
           (CASE WHEN QL.TP_BOM = 'P' THEN ISNULL(QO.QT_BOM, 0) 
    	   							  ELSE (ISNULL(QI.QT_IO, 0) + ISNULL(SB.QT_BOOK, 0)) END) AS QT_IN
    FROM SA_SOH SH
    JOIN SA_SOL SL ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
    LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
    LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO
    LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE,
                      SUM(IL.QT_IO) AS QT_IO
               FROM PU_POL PL
               LEFT JOIN MM_QTIO IL ON IL.CD_COMPANY = PL.CD_COMPANY AND IL.NO_PSO_MGMT = PL.NO_PO AND IL.NO_PSOLINE_MGMT = PL.NO_LINE
               LEFT JOIN MM_QTIOH IH ON IH.CD_COMPANY = IL.CD_COMPANY AND IH.NO_IO = IL.NO_IO
               WHERE ISNULL(IH.YN_RETURN, 'N') <> 'Y'
               GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE) QI 
    ON QI.CD_COMPANY = SL.CD_COMPANY AND QI.NO_SO = SL.NO_SO AND QI.NO_SOLINE = SL.SEQ_SO
    LEFT JOIN (SELECT IL.CD_COMPANY, IL.NO_PSO_MGMT, IL.NO_PSOLINE_MGMT,
    				  SUM(IL.QT_IO) AS QT_BOM
    		   FROM MM_QTIOH IH
               LEFT JOIN MM_QTIO IL ON IL.CD_COMPANY = IH.CD_COMPANY AND IL.NO_IO = IH.NO_IO
               WHERE ISNULL(IH.YN_RETURN, 'N') <> 'Y'
               AND IL.FG_PS = '1' 
               AND IL.FG_IO = '002'
    		   GROUP BY IL.CD_COMPANY, IL.NO_PSO_MGMT, IL.NO_PSOLINE_MGMT) QO 
    ON QO.CD_COMPANY = SL.CD_COMPANY AND QO.NO_PSO_MGMT = SL.NO_SO AND QO.NO_PSOLINE_MGMT = SL.SEQ_SO
    WHERE SL.CD_ITEM NOT LIKE 'SD%'
    AND SH.NO_SO NOT LIKE 'HB%'
    AND QL.GRP_ITEM NOT IN ('PV', 'BD')
)
SELECT GL.SEQ_GIR,
       A.NO_SO,
       A.QT_GIR,
       A.QT_IN
FROM SA_GIRL GL
JOIN A ON A.CD_COMPANY = GL.CD_COMPANY AND A.NO_SO = GL.NO_SO AND A.SEQ_SO = GL.SEQ_SO
WHERE GL.CD_COMPANY = @P_CD_COMPANY
AND GL.NO_GIR = @P_NO_GIR
AND A.QT_GIR > A.QT_IN

GO