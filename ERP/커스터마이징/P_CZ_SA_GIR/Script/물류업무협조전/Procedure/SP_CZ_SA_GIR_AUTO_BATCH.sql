USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIR_AUTO_BATCH]    Script Date: 2016-11-04 오후 3:34:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIR_AUTO_BATCH]
(
	@P_CD_COMPANY		NVARCHAR(7)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_NO_SO    NVARCHAR(20)

DECLARE SRC_CURSOR CURSOR FOR
SELECT SH.NO_SO
FROM SA_SOH SH
JOIN CZ_SA_SOH_DLV SD ON SD.CD_COMPANY = SH.CD_COMPANY AND SD.NO_SO = SH.NO_SO AND SD.YN_USE = 'Y'
WHERE SH.CD_COMPANY = @P_CD_COMPANY
AND ISNULL(SH.DT_CONTRACT, '') <> ''
AND ISNULL(SD.CD_DLV_MAIN, '') <> ''
AND (LEFT(SD.DTS_INSERT, 8) = CONVERT(CHAR(8), DATEADD(DAY, -1, GETDATE()), 112) OR 
	 SD.DT_GIR_AUTO = CONVERT(CHAR(8), GETDATE(), 112) OR 
	 (EXISTS (SELECT 1 
			  FROM CZ_SA_STOCK_BOOK SB 
			  WHERE SB.CD_COMPANY = SH.CD_COMPANY 
			  AND SB.NO_FILE = SH.NO_SO
			  AND SB.QT_BOOK > SB.QT_HOLD 
			  AND SB.QT_HOLD = 0 
			  AND SB.QT_GI = 0) AND EXISTS (SELECT 1 
                                            FROM CZ_SA_STOCK_BOOK SB
                                            WHERE SB.CD_COMPANY = SH.CD_COMPANY
                                            AND SB.NO_FILE = SH.NO_SO
                                            AND LEFT(ISNULL(SB.DTS_UPDATE, SB.DTS_INSERT), 8) = CONVERT(CHAR(8), DATEADD(DAY, -1, GETDATE()), 112))))

OPEN SRC_CURSOR
FETCH NEXT FROM SRC_CURSOR INTO @V_NO_SO

WHILE @@FETCH_STATUS = 0
BEGIN
    EXEC PI_CZ_DX_AUTO_GIR @P_CD_COMPANY, @V_NO_SO
	FETCH NEXT FROM SRC_CURSOR INTO @V_NO_SO
END

CLOSE SRC_CURSOR
DEALLOCATE SRC_CURSOR

GO