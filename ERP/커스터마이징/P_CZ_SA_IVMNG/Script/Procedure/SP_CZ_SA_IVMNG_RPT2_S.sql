USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_IVMNG_RPT2_S]    Script Date: 2015-06-08 오후 3:30:57 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_SA_IVMNG_RPT2_S]
(
	@P_CD_COMPANY	NVARCHAR(7),
	@P_CD_PC		NVARCHAR(7),
	@P_NO_DOCU		NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S_SEL,
	   FD.CD_PC,
	   FD.NO_DOCU,
	   FD.NO_ACCT,
	   FD.DT_ACCT,
	   FD.DT_WRITE,
	   (CASE WHEN FD.NM_PUMM = '' THEN FD.NM_NOTE ELSE ISNULL(FD.NM_PUMM, FD.NM_NOTE) END) AS NM_NOTE1,
	   FD.NO_ACCT AS NO,
	   FD.CD_WDEPT,
	   FD.ID_WRITE,
	   FD.NM_PUMM,
	   FD.RT_EXCH,
	   FD.CD_DOCU,
	   FD.NO_MODULE,
	   ISNULL(FD.NO_MODULE,'') NO_MODULE2,
	   FD1.AM_AMT,
	   FD.CD_PARTNER,
	   MP.LN_PARTNER,
	   DF.CNT_FILE,
	   MU.NM_USER AS NM_WRITE,
	   MD.NM_DEPT,
	   MC.NM_SYSDEF AS ST_STATE,
	   MC1.NM_SYSDEF AS CD_TYPE,
	   MC2.NM_SYSDEF AS FI_TYPE,
	   MU.NM_USER AS ID_ACCEPT,
	   MB.NM_BIZAREA,
	   '' AS CD_PARTNER2,
	   FD.DEC_LEASE,
	   MU.NM_USER AS NM_UPDATE,
	   FD1.DTS_UPDATE,
	   FD.ST_GWARE,
	   FD.NM_NOTE,
	   FD.MEMO_CD,
	   FD.CHECK_PEN, 
	   FD.ST_DOCU,
	   FD1.YN_BAN,
	   ISNULL(DH.CNT,0) NO_PRT_NUM,
	   FD.TP_INPUT,
	   FD.NO_MDOCU,
	   GW.APP_NO_EMP_END, --최종결재자
	   ME.NM_KOR APP_NM_EMP_END, --최종결재자명
	   GW.APP_DT_END, --최종결재일자
	   GW.APP_DOC_ID, --최종결재문서번호
	   FD.TP_EPNOTE,
	   FD1.CD_EXCH,
	   MC3.NM_SYSDEF AS NM_EXCH,
	   FD1.AM_EXDO_DR, 
	   FD1.AM_EXDO_CR
FROM FI_DOCU FD
JOIN (SELECT FD.CD_COMPANY, FD.CD_PC, FD.NO_DOCU,
			 MIN(FD.NO_DOLINE) NO_DOLINE,
		     SUM(CASE WHEN FD.TP_DOCU = '3' THEN FD.AM_DR ELSE FD.AM_DR + FD.AM_CR END) AM_AMT, 
		     MAX(CASE WHEN ISNULL(BH.CD_COMPANY, '') = '' THEN 'N' ELSE 'Y' END) YN_BAN,
		     MAX(FD.CD_EXCH) CD_EXCH,
		     SUM(CASE FD.TP_DRCR WHEN '1' THEN FD.AM_EXDO ELSE 0 END) AM_EXDO_DR,
		     SUM(CASE FD.TP_DRCR WHEN '2' THEN FD.AM_EXDO ELSE 0 END) AM_EXDO_CR,
		     MAX(FD.DTS_UPDATE) DTS_UPDATE
		   FROM FI_DOCU FD
		   LEFT JOIN FI_BANH BH ON BH.CD_COMPANY = FD.CD_COMPANY AND BH.NO_DOCU = FD.NO_DOCU AND BH.NO_DOLINE = FD.NO_DOLINE
		   GROUP BY FD.CD_COMPANY, FD.CD_PC, FD.NO_DOCU) FD1
ON FD1.CD_COMPANY = FD.CD_COMPANY AND FD1.CD_PC = FD.CD_PC AND FD1.NO_DOCU = FD.NO_DOCU AND FD1.NO_DOLINE = FD.NO_DOLINE
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = FD.CD_COMPANY AND MP.CD_PARTNER = FD.CD_PARTNER
LEFT JOIN (SELECT CD_COMPANY, CD_PC, NO_DOCU,
				  COUNT(1) AS CNT_FILE
		   FROM FI_DOCU_FILE
		   GROUP BY CD_COMPANY, CD_PC, NO_DOCU) DF
ON DF.CD_COMPANY = FD.CD_COMPANY AND DF.CD_PC = FD.CD_PC AND DF.NO_DOCU = FD.NO_DOCU
LEFT JOIN (SELECT CD_COMPANY, CD_PC, NO_DOCU,
				  COUNT(1) AS CNT
		   FROM FI_DOCU_PRTHISTORY
		   GROUP BY CD_COMPANY, CD_PC, NO_DOCU) DH
ON DH.CD_COMPANY = FD.CD_COMPANY AND DH.CD_PC = FD.CD_PC AND DH.NO_DOCU = FD.NO_DOCU
LEFT JOIN FI_GWDOCU GW ON GW.CD_COMPANY = FD.CD_COMPANY AND GW.CD_PC = FD.CD_PC AND GW.NO_DOCU = FD.NO_DOCU
LEFT JOIN MA_USER MU ON MU.CD_COMPANY = FD.CD_COMPANY AND MU.ID_USER = FD.ID_WRITE
LEFT JOIN MA_USER MU1 ON MU1.CD_COMPANY = FD.CD_COMPANY AND MU1.ID_USER = FD.ID_ACCEPT
LEFT JOIN MA_USER MU2 ON MU2.CD_COMPANY = FD.CD_COMPANY AND MU2.ID_USER = FD.ID_UPDATE
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = GW.CD_COMPANY AND ME.NO_EMP = GW.APP_NO_EMP_END
LEFT JOIN MA_DEPT MD ON MD.CD_COMPANY = FD.CD_COMPANY AND MD.CD_DEPT = FD.CD_WDEPT
LEFT JOIN MA_BIZAREA MB ON MB.CD_COMPANY = MD.CD_COMPANY AND MB.CD_BIZAREA = MD.CD_BIZAREA
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = FD.CD_COMPANY AND MC.CD_FIELD = 'FI_J000003' AND MC.CD_SYSDEF = FD.ST_DOCU
LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = FD.CD_COMPANY AND MC1.CD_FIELD = 'FI_J000002' AND MC1.CD_SYSDEF = FD.CD_DOCU
LEFT JOIN MA_CODEDTL MC2 ON MC2.CD_COMPANY = FD.CD_COMPANY AND MC2.CD_FIELD = 'FI_J000001' AND MC2.CD_SYSDEF = FD.TP_DOCU
LEFT JOIN MA_CODEDTL MC3 ON MC3.CD_COMPANY = FD1.CD_COMPANY AND MC3.CD_FIELD = 'MA_B000005' AND MC3.CD_SYSDEF = FD1.CD_EXCH
WHERE FD.CD_COMPANY = @P_CD_COMPANY
AND FD.CD_PC = @P_CD_PC
AND FD.NO_DOCU = @P_NO_DOCU

SELECT FD.CD_ACCT,
	   FD.NM_NOTE,
	   FD.CD_BIZAREA,
	   FD.AM_ACTSUM, 
	   FD.AM_JSUM, 
	   FD.CD_CC, 
	   FD.CD_PARTNER, 
	   FD.CD_PJT,
	   FD.NO_DOCU, 
	   FD.NO_DOLINE, 
	   FD.CD_PC, 
	   FD.CD_MNG, 
	   FD.CD_RELATION, 
	   FD.TP_ACAREA, 
	   FD.DT_START, 
	   FD.DT_END,
	   FD.TP_DOCU, 
	   FD.DT_ACCT, 
	   FD.NO_ACCT, 
	   FD.TP_DRCR, 
	   FD.AM_DR, 
	   FD.AM_CR, 
	   FD.ID_ACCEPT, 
	   FD.ST_DOCU, 
	   FD.DTS_INSERT,
	   FD.CD_MNG1,
	   FD.CD_MNG2,
	   FD.CD_MNG3,
	   FD.CD_MNG4,
	   FD.CD_MNG5,
	   FD.CD_MNG6,
	   FD.CD_MNG7,
	   FD.CD_MNG8,
	   FM.NM_MNG AS NM_CD_MNG1,
	   FM2.NM_MNG AS NM_CD_MNG2,
	   FM3.NM_MNG AS NM_CD_MNG3,
	   FM4.NM_MNG AS NM_CD_MNG4,
	   FM5.NM_MNG AS NM_CD_MNG5,
	   FM6.NM_MNG AS NM_CD_MNG6,
	   FM7.NM_MNG AS NM_CD_MNG7,
	   FM8.NM_MNG AS NM_CD_MNG8,
	   FD.CD_MNGD1,
	   FD.CD_MNGD2,
	   FD.CD_MNGD3,
	   FD.CD_MNGD4,
	   FD.CD_MNGD5,
	   FD.CD_MNGD6,
	   FD.CD_MNGD7,
	   FD.CD_MNGD8,
	   FD.NM_MNGD1,
	   FD.NM_MNGD2,
	   FD.NM_MNGD3,
	   FD.NM_MNGD4,
	   FD.NM_MNGD5,
	   FD.NM_MNGD6,
	   FD.NM_MNGD7,
	   FD.NM_MNGD8, 
	   FD.AM_EXDO,
	   FD.DTS_UPDATE, 
	   FD.CD_FUND, 
	   FD.CD_BUDGET, 
	   FD.CD_BIZPLAN,
	   (FD.AM_DR + FD.AM_CR) AS AM_AMT,	-- 금액
	   (CASE WHEN FD.CD_MNG1 = 'A06' THEN (CASE WHEN FD.CD_MNGD1 = '00' THEN (ISNULL(FD.NM_MNGD1, '') + '*' + ISNULL(FD.NM_MNGD2, '') + '*' + ISNULL(FD.NM_MNGD3, '') + '*' + ISNULL(FD.NM_MNGD4, '') + '*' + ISNULL(FD.NM_MNGD5, '') +'*'+ISNULL(FD.NM_MNGD6,'')+'*'+ISNULL(FD.NM_MNGD7,'')+'*'+ISNULL(FD.NM_MNGD8,''))
	   								 ELSE (ISNULL(FD.NM_MNGD1,'*')+'('+ISNULL(FD.CD_MNGD1,'')+')*'+ISNULL(FD.NM_MNGD2,'*')+'*'+ISNULL(FD.NM_MNGD3,'*')+'*'+ISNULL(FD.NM_MNGD4,'*')+'*'+ISNULL(FD.NM_MNGD5,'*') +'*'+ISNULL(FD.NM_MNGD6,'*')+'*'+ISNULL(FD.NM_MNGD7,'*')+'*'+ISNULL(FD.NM_MNGD8,'*')) END)
	   		 WHEN FD.CD_MNG2 = 'A06' THEN (CASE WHEN FD.CD_MNGD2 = '00' THEN (ISNULL(FD.NM_MNGD1, '') + '*' + ISNULL(FD.NM_MNGD2, '') + '*' + ISNULL(FD.NM_MNGD3, '') + '*' + ISNULL(FD.NM_MNGD4, '') + '*' + ISNULL(FD.NM_MNGD5, '') +'*'+ISNULL(FD.NM_MNGD6,'')+'*'+ISNULL(FD.NM_MNGD7,'')+'*'+ISNULL(FD.NM_MNGD8,''))
	   								 ELSE (ISNULL(FD.NM_MNGD1,'*')+'*'+ISNULL(FD.NM_MNGD2,'*')+'('+ISNULL(FD.CD_MNGD2,'')+')*'+ISNULL(FD.NM_MNGD3,'*')+'*'+ISNULL(FD.NM_MNGD4,'*')+'*'+ISNULL(FD.NM_MNGD5,'*') +'*'+ISNULL(FD.NM_MNGD6,'*')+'*'+ISNULL(FD.NM_MNGD7,'*')+'*'+ISNULL(FD.NM_MNGD8,'*')) END)
	   		 WHEN FD.CD_MNG3 = 'A06' THEN (CASE WHEN FD.CD_MNGD3 = '00' THEN (ISNULL(FD.NM_MNGD1, '') + '*' + ISNULL(FD.NM_MNGD2, '') + '*' + ISNULL(FD.NM_MNGD3, '') + '*' + ISNULL(FD.NM_MNGD4, '') + '*' + ISNULL(FD.NM_MNGD5, '') +'*'+ISNULL(FD.NM_MNGD6,'')+'*'+ISNULL(FD.NM_MNGD7,'')+'*'+ISNULL(FD.NM_MNGD8,''))
	   								 ELSE (ISNULL(FD.NM_MNGD1,'*')+'*'+ISNULL(FD.NM_MNGD2,'*')+'*'+ISNULL(FD.NM_MNGD3,'*')+'('+ISNULL(FD.CD_MNGD3,'')+')*'+ISNULL(FD.NM_MNGD4,'*')+'*'+ISNULL(FD.NM_MNGD5,'*') +'*'+ISNULL(FD.NM_MNGD6,'*')+'*'+ISNULL(FD.NM_MNGD7,'*')+'*'+ISNULL(FD.NM_MNGD8,'*')) END)
	   		 WHEN FD.CD_MNG4 = 'A06' THEN (CASE WHEN FD.CD_MNGD4 = '00' THEN (ISNULL(FD.NM_MNGD1, '') + '*' + ISNULL(FD.NM_MNGD2, '') + '*' + ISNULL(FD.NM_MNGD3, '') + '*' + ISNULL(FD.NM_MNGD4, '') + '*' + ISNULL(FD.NM_MNGD5, '') +'*'+ISNULL(FD.NM_MNGD6,'')+'*'+ISNULL(FD.NM_MNGD7,'')+'*'+ISNULL(FD.NM_MNGD8,''))
	   								 ELSE (ISNULL(FD.NM_MNGD1,'*')+'*'+ISNULL(FD.NM_MNGD2,'*')+'*'+ISNULL(FD.NM_MNGD3,'*')+'*'+ISNULL(FD.NM_MNGD4,'*')+'('+ISNULL(FD.CD_MNGD4,'')+')*'+ISNULL(FD.NM_MNGD5,'*') +'*'+ISNULL(FD.NM_MNGD6,'*')+'*'+ISNULL(FD.NM_MNGD7,'*')+'*'+ISNULL(FD.NM_MNGD8,'*')) END)
	   		 WHEN FD.CD_MNG5 = 'A06' THEN (CASE WHEN FD.CD_MNGD5 = '00' THEN (ISNULL(FD.NM_MNGD1, '') + '*' + ISNULL(FD.NM_MNGD2, '') + '*' + ISNULL(FD.NM_MNGD3, '') + '*' + ISNULL(FD.NM_MNGD4, '') + '*' + ISNULL(FD.NM_MNGD5, '') +'*'+ISNULL(FD.NM_MNGD6,'')+'*'+ISNULL(FD.NM_MNGD7,'')+'*'+ISNULL(FD.NM_MNGD8,''))
	   								 ELSE (ISNULL(FD.NM_MNGD1,'*')+'*'+ISNULL(FD.NM_MNGD2,'*')+'*'+ISNULL(FD.NM_MNGD3,'*')+'*'+ISNULL(FD.NM_MNGD4,'*')+'*'+ISNULL(FD.NM_MNGD5,'*')+'('+ISNULL(FD.CD_MNGD5,'') +'*'+ISNULL(FD.NM_MNGD6,'*')+'*'+ISNULL(FD.NM_MNGD7,'*')+'*'+ISNULL(FD.NM_MNGD8,'*')) END)
	   		 ELSE ISNULL(FD.NM_MNGD1, '') + '*' + ISNULL(FD.NM_MNGD2, '') + '*' + ISNULL(FD.NM_MNGD3, '') + '*' + ISNULL(FD.NM_MNGD4, '') + '*' + ISNULL(FD.NM_MNGD5, '') + '*' + ISNULL(FD.NM_MNGD6, '') + '*' + ISNULL(FD.NM_MNGD7, '') + '*' + ISNULL(FD.NM_MNGD8, '') END) AS NMD_MNGD,
	   AC.NM_ACCT,
	   AC.CD_ACITEM, 
	   AC.NM_ACITEM, 
	   AC.TP_ACLEVEL,
	   AC.CD_RELATION AS CD_RELATION1,
	   AC.NM_ACCT3,
	   AC.CD_ACGRP,
	   AC.NM_ACGRP,
	   AC.CD_ACHTEM,
	   AC.NM_ACHTEM,
	   '' AS NM_PARTNER, 
	   '' AS NM_CC, 
	   '' AS NM_PJT, 
	   '' AS NM_DEPOSIT, 
	   '' AS A04, 
	   '' AS A21, 
	   '' AS B21, 
	   '' AS B23, 
	   '' AS C14, 
	   '' AS C04, 
	   '' AS C05, 
	   '' AS C17, 
	   '' AS B24, 
	   '' AS B25, 
	   FD.CD_BGACCT, 
	   FD.CD_CARD,  
	   0.0 AS AM_JPRO, 
	   '' AS A25,
	   BA.TP_BUNIT, 
	   BA.TP_BGACCT,
	   BC.NM_BUDGET AS NM_BUDGET,			-- 예산코드명
	   UD.NM_FUND AS NM_FUND,					-- 자금코드
	   MC.NM_SYSDEF AS NM_RELATION, -- 연동항목
	   FA.YN_BAN,					-- 반제여부
	   MC1.NM_SYSDEF AS DO_DRCR, -- 차대구분
	   MP1.NO_COMPANY, 
	   MP1.CD_BANK AS CD_PARTBANK, 
	   MC2.NM_SYSDEF AS NM_BANK, 
	   MP1.NM_PTR, 
	   MP1.NO_DEPOSIT, 
	   MC3.NM_SYSDEF AS CD_CON,
	   BA.NM_BGACCT,
	   MD.NM_DEPT AS NM_MDEPT,
	   BP.NM_BIZPLAN, 
	   BP.NM_DEPO,
	   BC.TP_CONTROL,
	   DP.NM_DEPOSIT AS NM_DEPONAME, 
	   DP.NO_DEPOSIT AS NO_DEPOSIT2,
	   CD.NM_CARD AS NM_CARDSA,
	   BA.NM_BGACCT AS NM_EPNOTE, 
	   '' AS CD_PARTNER2,
	   MP.LN_PARTNER AS NM_BANK2, 
	   FD.NO_TCOST,
	   FD.NO_MODULE, 
	   FD.NO_MDOCU,
	   ISNULL(FD.NO_MODULE,'') AS NO_MODULE2,
	   FD.TP_EVIDENCE,
	   FD.NO_BDOCU, 
	   FD.NO_BDOLINE,
	   FD.ID_WRITE,
	   ME.NM_KOR AS NM_WRITE
FROM FI_DOCU FD
LEFT JOIN V_FI_ACCTCODE AC ON FD.CD_ACCT = AC.CD_ACCT AND FD.CD_COMPANY = AC.CD_COMPANY
LEFT JOIN FI_DEPOSIT DP ON DP.CD_COMPANY = FD.CD_COMPANY AND DP.CD_DEPOSIT = FD.CD_DEPOSIT
LEFT JOIN FI_BIZPLAN BP ON BP.CD_COMPANY = FD.CD_COMPANY AND BP.CD_BIZPLAN = FD.CD_BIZPLAN
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = FD.CD_COMPANY AND ME.NO_EMP = FD.ID_WRITE
LEFT JOIN MA_DEPT MD ON MD.CD_COMPANY = FD.CD_COMPANY AND MD.CD_DEPT = FD.CD_DEPT
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = FD.CD_COMPANY AND MP.CD_PARTNER = FD.CD_BANK
LEFT JOIN MA_PARTNER MP1 ON MP1.CD_COMPANY = FD.CD_COMPANY AND MP1.CD_PARTNER = FD.CD_PARTNER
LEFT JOIN FI_BGCODE BC ON BC.CD_COMPANY = FD.CD_COMPANY AND BC.CD_BUDGET = FD.CD_BUDGET
LEFT JOIN FI_CARD CD ON CD.CD_COMPANY = FD.CD_COMPANY AND CD.NO_CARD = FD.CD_CARD
LEFT JOIN FI_FUND UD ON UD.CD_COMPANY = FD.CD_COMPANY AND UD.CD_FUND = FD.CD_FUND
LEFT JOIN FI_ACCTCODE FA ON FA.CD_COMPANY = FD.CD_COMPANY AND FA.CD_ACCT = FD.CD_ACCT
LEFT JOIN FI_BGACCT BA ON BA.CD_COMPANY = FD.CD_COMPANY AND BA.CD_BGACCT = FD.CD_BGACCT
LEFT JOIN FI_BGACCT BA1 ON BA1.CD_COMPANY = FD.CD_COMPANY AND BA1.CD_BGACCT = FD.CD_EPNOTE
LEFT JOIN FI_MNG FM ON FM.CD_COMPANY = FD.CD_COMPANY AND FM.CD_MNG = FD.CD_MNG1
LEFT JOIN FI_MNG FM2 ON FM2.CD_COMPANY = FD.CD_COMPANY AND FM2.CD_MNG = FD.CD_MNG2
LEFT JOIN FI_MNG FM3 ON FM3.CD_COMPANY = FD.CD_COMPANY AND FM3.CD_MNG = FD.CD_MNG3
LEFT JOIN FI_MNG FM4 ON FM4.CD_COMPANY = FD.CD_COMPANY AND FM4.CD_MNG = FD.CD_MNG4
LEFT JOIN FI_MNG FM5 ON FM5.CD_COMPANY = FD.CD_COMPANY AND FM5.CD_MNG = FD.CD_MNG5
LEFT JOIN FI_MNG FM6 ON FM6.CD_COMPANY = FD.CD_COMPANY AND FM6.CD_MNG = FD.CD_MNG6
LEFT JOIN FI_MNG FM7 ON FM7.CD_COMPANY = FD.CD_COMPANY AND FM7.CD_MNG = FD.CD_MNG7
LEFT JOIN FI_MNG FM8 ON FM8.CD_COMPANY = FD.CD_COMPANY AND FM8.CD_MNG = FD.CD_MNG8
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = FD.CD_COMPANY AND MC.CD_FIELD = 'FI_B000006' AND MC.CD_SYSDEF = FD.CD_RELATION
LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = FD.CD_COMPANY AND MC1.CD_FIELD = 'FI_B000002' AND MC1.CD_SYSDEF = FD.TP_DRCR
LEFT JOIN MA_CODEDTL MC2 ON MC2.CD_COMPANY = MP1.CD_COMPANY AND MC2.CD_FIELD = 'MA_B000043' AND MC2.CD_SYSDEF = MP1.CD_BANK
LEFT JOIN MA_CODEDTL MC3 ON MC3.CD_COMPANY = MP1.CD_COMPANY AND MC3.CD_FIELD = 'MA_B000073' AND MC3.CD_SYSDEF = MP1.CD_CON
WHERE FD.CD_COMPANY = @P_CD_COMPANY
AND FD.CD_PC = @P_CD_PC
AND FD.NO_DOCU = @P_NO_DOCU
ORDER BY FD.NO_DOCU, FD.NO_DOLINE

GO