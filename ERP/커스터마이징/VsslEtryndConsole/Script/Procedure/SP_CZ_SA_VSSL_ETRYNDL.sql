USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_VSSL_ETRYNDL]    Script Date: 2018-11-21 오후 4:25:39 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_SA_VSSL_ETRYNDL]
(
    @P_CD_PRTAG				NVARCHAR(3),
    @P_NM_PRTAG				NVARCHAR(10),
    @P_DT_ETRYPT_YEAR		NVARCHAR(4),
    @P_CNT_ETRYPT			NVARCHAR(3),
    @P_CLSGN				NVARCHAR(10),
    @P_NM_VSSL				NVARCHAR(20),
    @P_NM_ETRYND			NVARCHAR(2),
    @P_DT_ETRYPT			NVARCHAR(25),
    @P_DT_TKOFF				NVARCHAR(25),
    @P_NM_IBOBPRT			NVARCHAR(2),
    @P_CD_LAIDUPFCLTY		NVARCHAR(3),
    @P_CD_LAIDUPFCLTY_SUB	NVARCHAR(2),
    @P_NM_LAIDUPFCLTY		NVARCHAR(20),
    @P_YN_PILTG				NVARCHAR(1),
    @P_CD_LDADNG_FRGHT_CL	NVARCHAR(2),
    @P_TON_LDADNG			NVARCHAR(5),
    @P_TON_TRNPDT			NVARCHAR(5),
    @P_TON_LANDNG_FRGHT		NVARCHAR(5),
    @P_TON_LD_FRGHT			NVARCHAR(5),
    @P_GRTG					NVARCHAR(5),
    @P_INTRL_GRTG			NVARCHAR(5),
    @P_NM_SATMN_ENTRPS		NVARCHAR(30),
    @P_CNT_CREW				NVARCHAR(3),
    @P_CNT_KORAN_CREW		NVARCHAR(3),
    @P_CNT_FRGNR_CREW		NVARCHAR(3)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_DTS_ETRYPT NVARCHAR(14) = REPLACE(REPLACE(REPLACE(LEFT(@P_DT_ETRYPT, 19), 'T', ''), '-', ''), ':', '')
DECLARE @V_DTS_TKOFF NVARCHAR(14) = REPLACE(REPLACE(REPLACE(LEFT(@P_DT_TKOFF, 19), 'T', ''), '-', ''), ':', '')

DECLARE @V_TON_LDADNG			NVARCHAR(6) = (CASE WHEN @P_TON_LDADNG = '' THEN NULL
													WHEN @P_TON_LDADNG LIKE '%.' THEN @P_TON_LDADNG + '0' 
													ELSE @P_TON_LDADNG END),
        @V_TON_TRNPDT			NVARCHAR(6) = (CASE WHEN @P_TON_TRNPDT = '' THEN NULL
													WHEN @P_TON_TRNPDT LIKE '%.' THEN @P_TON_TRNPDT + '0' 
												    ELSE @P_TON_TRNPDT END),
        @V_TON_LANDNG_FRGHT		NVARCHAR(6) = (CASE WHEN @P_TON_LANDNG_FRGHT = '' THEN NULL
													WHEN @P_TON_LANDNG_FRGHT LIKE '%.' THEN @P_TON_LANDNG_FRGHT + '0' 
													ELSE @P_TON_LANDNG_FRGHT END),
        @V_TON_LD_FRGHT			NVARCHAR(6) = (CASE WHEN @P_TON_LD_FRGHT = '' THEN NULL
													WHEN @P_TON_LD_FRGHT LIKE '%.' THEN @P_TON_LD_FRGHT + '0' 
													ELSE @P_TON_LD_FRGHT END),
        @V_GRTG					NVARCHAR(6) = (CASE WHEN @P_GRTG = '' THEN NULL
													WHEN @P_GRTG LIKE '%.' THEN @P_GRTG + '0' 
													ELSE @P_GRTG END),
        @V_INTRL_GRTG			NVARCHAR(6) = (CASE WHEN @P_INTRL_GRTG = '' THEN NULL
												    WHEN @P_INTRL_GRTG LIKE '%.' THEN @P_INTRL_GRTG + '0' 
													ELSE @P_INTRL_GRTG END)

IF EXISTS (SELECT 1
		   FROM CZ_SA_VSSL_ETRYNDL
		   WHERE CD_PRTAG = @P_CD_PRTAG
		   AND DT_ETRYPT_YEAR = @P_DT_ETRYPT_YEAR
		   AND CNT_ETRYPT = @P_CNT_ETRYPT
		   AND CLSGN = @P_CLSGN
		   AND NM_VSSL = @P_NM_VSSL
		   AND NM_ETRYND = @P_NM_ETRYND)
BEGIN
	IF EXISTS (SELECT 1
			   FROM CZ_SA_VSSL_ETRYNDL
			   WHERE CD_PRTAG = @P_CD_PRTAG
			   AND DT_ETRYPT_YEAR = @P_DT_ETRYPT_YEAR
			   AND CNT_ETRYPT = @P_CNT_ETRYPT
			   AND CLSGN = @P_CLSGN
			   AND NM_VSSL = @P_NM_VSSL
			   AND NM_ETRYND = @P_NM_ETRYND
			   AND (DTS_ETRYPT <> @V_DTS_ETRYPT
				 OR DTS_TKOFF <> @V_DTS_TKOFF
				 OR NM_IBOBPRT <> @P_NM_IBOBPRT
				 OR CD_LAIDUPFCLTY <> @P_CD_LAIDUPFCLTY
				 OR CD_LAIDUPFCLTY_SUB <> @P_CD_LAIDUPFCLTY_SUB
				 OR NM_LAIDUPFCLTY <> @P_NM_LAIDUPFCLTY
				 OR YN_PILTG <> @P_YN_PILTG
				 OR CD_LDADNG_FRGHT_CL <> @P_CD_LDADNG_FRGHT_CL
				 OR TON_LDADNG <> @V_TON_LDADNG
				 OR TON_TRNPDT <> @V_TON_TRNPDT
				 OR TON_LANDNG_FRGHT <> @V_TON_LANDNG_FRGHT
				 OR TON_LD_FRGHT <> @V_TON_LD_FRGHT
				 OR GRTG <> @V_GRTG
				 OR INTRL_GRTG <> @V_INTRL_GRTG
				 OR NM_SATMN_ENTRPS <> @P_NM_SATMN_ENTRPS
				 OR CNT_CREW <> @P_CNT_CREW
				 OR CNT_KORAN_CREW <> @P_CNT_KORAN_CREW
				 OR CNT_FRGNR_CREW <> @P_CNT_FRGNR_CREW))
	BEGIN
		UPDATE CZ_SA_VSSL_ETRYNDL
		SET DTS_ETRYPT = @V_DTS_ETRYPT,
			DTS_TKOFF = @V_DTS_TKOFF,
			NM_IBOBPRT = @P_NM_IBOBPRT,
			CD_LAIDUPFCLTY = @P_CD_LAIDUPFCLTY,
			CD_LAIDUPFCLTY_SUB = @P_CD_LAIDUPFCLTY_SUB,
			NM_LAIDUPFCLTY = @P_NM_LAIDUPFCLTY,
			YN_PILTG = @P_YN_PILTG,
			CD_LDADNG_FRGHT_CL = @P_CD_LDADNG_FRGHT_CL,
			TON_LDADNG = @V_TON_LDADNG,
			TON_TRNPDT = @V_TON_TRNPDT,
			TON_LANDNG_FRGHT = @V_TON_LANDNG_FRGHT,
			TON_LD_FRGHT = @V_TON_LD_FRGHT,
			GRTG = @V_GRTG,
			INTRL_GRTG = @V_INTRL_GRTG,
			NM_SATMN_ENTRPS = @P_NM_SATMN_ENTRPS,
			CNT_CREW = @P_CNT_CREW,
			CNT_KORAN_CREW = @P_CNT_KORAN_CREW,
			CNT_FRGNR_CREW = @P_CNT_FRGNR_CREW,
		    DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
		WHERE CD_PRTAG = @P_CD_PRTAG
		AND DT_ETRYPT_YEAR = @P_DT_ETRYPT_YEAR
		AND CNT_ETRYPT = @P_CNT_ETRYPT
		AND CLSGN = @P_CLSGN
		AND NM_VSSL = @P_NM_VSSL
		AND NM_ETRYND = @P_NM_ETRYND
	END
END
ELSE
BEGIN
	INSERT INTO CZ_SA_VSSL_ETRYNDL
	(
		CD_PRTAG,
		NM_PRTAG,
		DT_ETRYPT_YEAR,
		CNT_ETRYPT,
		CLSGN,
		NM_VSSL,
		NM_ETRYND,
		DTS_ETRYPT,
		DTS_TKOFF,
		NM_IBOBPRT,
		CD_LAIDUPFCLTY,
		CD_LAIDUPFCLTY_SUB,
		NM_LAIDUPFCLTY,
		YN_PILTG,
		CD_LDADNG_FRGHT_CL,
		TON_LDADNG,
		TON_TRNPDT,
		TON_LANDNG_FRGHT,
		TON_LD_FRGHT,
		GRTG,
		INTRL_GRTG,
		NM_SATMN_ENTRPS,
		CNT_CREW,
		CNT_KORAN_CREW,
		CNT_FRGNR_CREW,
		DTS_INSERT,
		CALL_SIGN
	)
	VALUES
	(
		@P_CD_PRTAG,
		@P_NM_PRTAG,
		@P_DT_ETRYPT_YEAR,
		@P_CNT_ETRYPT,
		@P_CLSGN,
		@P_NM_VSSL,
		@P_NM_ETRYND,
		@V_DTS_ETRYPT,
		@V_DTS_TKOFF,
		@P_NM_IBOBPRT,
		@P_CD_LAIDUPFCLTY,
		@P_CD_LAIDUPFCLTY_SUB,
		@P_NM_LAIDUPFCLTY,
		@P_YN_PILTG,
		@P_CD_LDADNG_FRGHT_CL,
		@V_TON_LDADNG,
		@V_TON_TRNPDT,
		@V_TON_LANDNG_FRGHT,
		@V_TON_LD_FRGHT,
		@V_GRTG,
		@V_INTRL_GRTG,
		@P_NM_SATMN_ENTRPS,
		@P_CNT_CREW,
		@P_CNT_KORAN_CREW,
		@P_CNT_FRGNR_CREW,
		NEOE.SF_SYSDATE(GETDATE()),
		REPLACE(@P_CLSGN, '/', '')
	)
END

IF EXISTS (SELECT 1 FROM CZ_SA_VSSL_ETRYNDH 
		   WHERE CD_PRTAG = @P_CD_PRTAG
		   AND DT_ETRYPT_YEAR = @P_DT_ETRYPT_YEAR
		   AND CNT_ETRYPT = @P_CNT_ETRYPT
		   AND CLSGN = @P_CLSGN
		   AND NM_VSSL = @P_NM_VSSL
		   AND ((ISNULL(@V_DTS_ETRYPT, '') <> '' AND ISNULL(DTS_ETRYPT, '') <> @V_DTS_ETRYPT) OR
		        (ISNULL(@V_DTS_TKOFF, '') <> '' AND ISNULL(DTS_TKOFF, '') <> @V_DTS_TKOFF)))
BEGIN
	UPDATE CZ_SA_VSSL_ETRYNDH
	SET DTS_ETRYPT = (CASE WHEN ISNULL(@V_DTS_ETRYPT, '') <> ''THEN @V_DTS_ETRYPT ELSE DTS_ETRYPT END),
		DTS_TKOFF = (CASE WHEN ISNULL(@V_DTS_TKOFF, '') <> '' THEN @V_DTS_TKOFF ELSE DTS_TKOFF END),
		DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	WHERE CD_PRTAG = @P_CD_PRTAG
    AND DT_ETRYPT_YEAR = @P_DT_ETRYPT_YEAR
    AND CNT_ETRYPT = @P_CNT_ETRYPT
    AND CLSGN = @P_CLSGN
    AND NM_VSSL = @P_NM_VSSL
END

GO

