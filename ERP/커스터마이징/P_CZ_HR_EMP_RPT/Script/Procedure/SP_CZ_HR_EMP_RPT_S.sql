USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_HR_EMP_RPT_S]    Script Date: 2016-09-13 오후 2:00:45 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [NEOE].[SP_CZ_HR_EMP_RPT_S] 
(
	@P_DT_SEARCH		NVARCHAR(8),
	@P_CD_COMPANY		NVARCHAR(1000),
	@P_CD_DEPT			NVARCHAR(1000),
	@P_CD_DUTY_TYPE		NVARCHAR(1000),
	@P_CD_INCOM			NVARCHAR(3),
	@P_CD_NATION	    NVARCHAR(3),
	@P_SEARCH			NVARCHAR(100),
	@P_YN_ALL			NVARCHAR(1)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT ME.CD_COMPANY,
	   CP.NM_COMPANY,
	   ME.CD_DUTY_TYPE,
	   MC3.NM_SYSDEF AS NM_DUTY_TYPE,
	   ME.CD_DUTY_RANK,
	   MC.NM_SYSDEF AS NM_DUTY_RANK,
	   ME.CD_DUTY_STEP,
	   MC1.NM_SYSDEF AS NM_DUTY_STEP,
	   ME.CD_PAY_STEP,
	   ME.CD_DEPT,
	   MD.NM_DEPT,
	   HD2.NM_DUTY_RANK AS NM_DUTY_RANK1,
	   HD2.NM_DUTY_STEP AS NM_DUTY_STEP1,
	   HD2.CD_PAY_STEP AS CD_PAY_STEP1,
	   HD2.NM_DEPT AS NM_DEPT1,
	   ME.CD_CC,
	   CC.NM_CC,
	   ME.NO_EMP,
	   ME.NM_KOR,
	   ME.CD_INCOM,
	   MC4.NM_SYSDEF AS NM_INCOM,
	   ME.CD_NATION,
	   MC2.NM_SYSDEF AS NM_NATION,
	   ME.DT_BIRTH,
	   ME.DT_GENTER,
	   ME.DT_ENTER,
	   ME.DT_BRETIRE,
	   ME.DT_RETIRE,
	   (SC.NM_SCH + ' / ' + SC.NM_MAJOR) AS NM_SCH,
	   HD1.DT_DUTY_RANK,
	   HD.NM_ANCODE_LAST,
	   HD3.NM_ANCODE_PD,
	   CE.DC_RMK,
	   ME.NO_TEL_EMER,
	   ME.NO_EMAIL
FROM MA_EMP ME
LEFT JOIN CZ_MA_EMP CE ON CE.CD_COMPANY = ME.CD_COMPANY AND CE.NO_EMP = ME.NO_EMP
LEFT JOIN MA_COMPANY CP ON CP.CD_COMPANY = ME.CD_COMPANY
LEFT JOIN MA_DEPT MD ON MD.CD_COMPANY = ME.CD_COMPANY AND MD.CD_DEPT = ME.CD_DEPT
LEFT JOIN MA_CC CC ON CC.CD_COMPANY = ME.CD_COMPANY AND CC.CD_CC = ME.CD_CC
LEFT JOIN (SELECT CD_COMPANY, NO_EMP, 
		   		  MAX(NM_SCH) AS NM_SCH,
		   		  MAX(NM_MAJOR) AS NM_MAJOR 
		   FROM HR_SCHOCARE
		   WHERE TP_LASTSCH = '001'
		   GROUP BY CD_COMPANY, NO_EMP) SC
ON SC.CD_COMPANY = ME.CD_COMPANY AND SC.NO_EMP = ME.NO_EMP
LEFT JOIN (SELECT DISTINCT HD.CD_COMPANY, HD.NO_EMP,
		   		  FIRST_VALUE(HD.NM_ANCODE) OVER (PARTITION BY HD.CD_COMPANY, HD.NO_EMP ORDER BY HD.DT_WRITE DESC) AS NM_ANCODE_LAST
		   FROM (SELECT HD.CD_COMPANY, DT.NO_EMP, HD.DT_WRITE, DT.CD_ANCODE, HC.NM_ANCODE
				 FROM HR_HUANHEAD HD -- 인사발령
				 JOIN (SELECT CD_COMPANY, NO_AN, NO_EMP, CD_ANCODE 
				 	   FROM HR_HUANDETAIL
					   WHERE CD_ANCODE IN ('300', '410', '500', '510', '700')
				 	   GROUP BY CD_COMPANY, NO_AN, NO_EMP, CD_ANCODE) DT 
				 ON DT.CD_COMPANY = HD.CD_COMPANY AND DT.NO_AN = HD.NO_AN
				 LEFT JOIN (SELECT CD_COMPANY, CD_ANCODE, NM_ANCODE 
				 		    FROM HR_HUANCODE
				 		    GROUP BY CD_COMPANY, CD_ANCODE, NM_ANCODE) HC 
				 ON HC.CD_COMPANY = DT.CD_COMPANY AND HC.CD_ANCODE = DT.CD_ANCODE
				 UNION ALL
				 SELECT HS.CD_COMPANY, HS.NO_EMP, HS.DT_AN, HS.CD_ANCODE, HC.NM_ANCODE
				 FROM HR_HUANH_HS HS -- 과거발령
				 LEFT JOIN (SELECT CD_COMPANY, CD_ANCODE, NM_ANCODE 
				 		    FROM HR_HUANCODE
							WHERE CD_ANCODE IN ('300', '410', '500', '510', '700')
				 		    GROUP BY CD_COMPANY, CD_ANCODE, NM_ANCODE) HC 
				 ON HC.CD_COMPANY = HS.CD_COMPANY AND HC.CD_ANCODE = HS.CD_ANCODE) HD
		   WHERE HD.DT_WRITE <= @P_DT_SEARCH) AS HD
ON HD.CD_COMPANY = ME.CD_COMPANY AND HD.NO_EMP = ME.NO_EMP
LEFT JOIN (SELECT DISTINCT HD.CD_COMPANY, HD.NO_EMP,
				  FIRST_VALUE(HD.DT_DUTY_RANK) OVER (PARTITION BY HD.CD_COMPANY, HD.NO_EMP ORDER BY HD.DT_DUTY_RANK DESC) AS DT_DUTY_RANK
		   FROM (SELECT HD.CD_COMPANY, DT.NO_EMP, 
						DT.DC_AFTAN AS DT_DUTY_RANK
				 FROM HR_HUANHEAD HD
				 JOIN (SELECT CD_COMPANY, NO_AN, NO_EMP, DC_AFTAN 
				 	   FROM HR_HUANDETAIL
				 	   WHERE CD_ANCODE = '300' 
				 	   AND CD_ANEXPEN = 'H22'
				 	   AND ISNULL(DC_AFTAN, '') <> '') DT 
				 ON DT.CD_COMPANY = HD.CD_COMPANY AND DT.NO_AN = HD.NO_AN
				 UNION ALL
				 SELECT HD.CD_COMPANY, DT.NO_EMP,
				 	    DT.DC_AFTAN AS DT_DUTY_RANK 
				 FROM HR_HUANH_HS HD
				 JOIN (SELECT CD_COMPANY, NO_AN, NO_EMP, DC_AFTAN 
				 	   FROM HR_HUAND_HS
				 	   WHERE CD_ANCODE = '300' 
				 	   AND CD_ANEXPEN = 'H22'
				 	   AND ISNULL(DC_AFTAN, '') <> '') DT 
				 ON DT.CD_COMPANY = HD.CD_COMPANY AND DT.NO_AN = HD.NO_AN) HD
		   WHERE HD.DT_DUTY_RANK <= @P_DT_SEARCH) HD1
ON HD1.CD_COMPANY = ME.CD_COMPANY AND HD1.NO_EMP = ME.NO_EMP
LEFT JOIN (SELECT HD.CD_COMPANY,
		   		  HD.NO_EMP,
		   		  HD.H02 AS NM_DEPT,
		   		  HD.H03 AS NM_DUTY_RANK,
		   		  HD.H05 AS NM_DUTY_STEP,
		   		  HD.H06 AS CD_PAY_STEP 
		   FROM (SELECT DISTINCT HD.CD_COMPANY, HD.NO_EMP, HD.CD_ANEXPEN,
		   						 FIRST_VALUE(HD.DC_AFTAN) OVER (PARTITION BY HD.CD_COMPANY, HD.NO_EMP, HD.CD_ANEXPEN ORDER BY HD.DT_WRITE DESC) AS DC_AFTAN
		   	     FROM (SELECT HD.CD_COMPANY, DT.NO_EMP, HD.DT_WRITE,
		   					  DT.CD_ANEXPEN, (CASE DT.CD_ANEXPEN WHEN 'H02' THEN MD.NM_DEPT
		   														 WHEN 'H03' THEN MC.NM_SYSDEF
		   														 WHEN 'H05' THEN MC1.NM_SYSDEF
		   														 WHEN 'H06' THEN DT.DC_AFTAN END) AS DC_AFTAN 
		   			FROM HR_HUANHEAD HD
		   			LEFT JOIN HR_HUANDETAIL DT ON DT.CD_COMPANY = HD.CD_COMPANY AND DT.NO_AN = HD.NO_AN
		   			LEFT JOIN MA_DEPT MD ON MD.CD_COMPANY = DT.CD_COMPANY AND MD.CD_DEPT = DT.DC_AFTAN
		   			LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = DT.CD_COMPANY AND MC.CD_FIELD = 'HR_H000002' AND MC.CD_SYSDEF = DT.DC_AFTAN
		   			LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = DT.CD_COMPANY AND MC1.CD_FIELD = 'HR_H000003' AND MC1.CD_SYSDEF = DT.DC_AFTAN
		   			WHERE DT.CD_ANEXPEN IN ('H02', 'H03', 'H05', 'H06')
		   			UNION ALL
		   			SELECT HD.CD_COMPANY, DT.NO_EMP, HD.DT_AN,
		   				   DT.CD_ANEXPEN, DT.DC_AFTAN 
		   			FROM HR_HUANH_HS HD
		   			LEFT JOIN HR_HUAND_HS DT ON DT.CD_COMPANY = HD.CD_COMPANY AND DT.NO_AN = HD.NO_AN
		   			WHERE DT.CD_ANEXPEN IN ('H02', 'H03', 'H05', 'H06')) HD
		   	  WHERE ISNULL(HD.DC_AFTAN, '') <> ''
		   	  AND HD.DT_WRITE <= @P_DT_SEARCH) AS HD
		   PIVOT (MAX(DC_AFTAN) FOR HD.CD_ANEXPEN IN ([H02], [H03], [H05], [H06])) AS HD) HD2
ON HD2.CD_COMPANY = ME.CD_COMPANY AND HD2.NO_EMP = ME.NO_EMP
LEFT JOIN (SELECT DISTINCT HD.CD_COMPANY, HD.NO_EMP,
		   		  FIRST_VALUE(HD.NM_ANCODE) OVER (PARTITION BY HD.CD_COMPANY, HD.NO_EMP ORDER BY HD.DT_WRITE DESC) AS NM_ANCODE_PD
		   FROM (SELECT PZ.CD_COMPANY, PZ.NO_EMP, PZ.DT_PRIZE AS DT_WRITE, PZ.CD_PRIZE, HC.NM_PRIZE AS NM_ANCODE
				 FROM HR_HUPRIZE PZ -- 포상
				 LEFT JOIN (SELECT CD_COMPANY, CD_PRIZE, NM_PRIZE 
				 			FROM HR_HUPCODE
				 		    GROUP BY CD_COMPANY, CD_PRIZE, NM_PRIZE) HC 
				 ON HC.CD_COMPANY = PZ.CD_COMPANY AND HC.CD_PRIZE = PZ.CD_PRIZE 
				 UNION ALL
				 SELECT DS.CD_COMPANY, DS.NO_EMP, DS.DT_DISCIP AS DT_WRITE, DS.CD_DISCIP, HC.NM_DISCIP AS NM_ANCODE
				 FROM HR_HUDISCIP DS -- 징계
				 LEFT JOIN HR_HUDCODE HC ON HC.CD_COMPANY = DS.CD_COMPANY AND HC.CD_DISCIP = DS.CD_DISCIP) HD
		   WHERE HD.DT_WRITE <= @P_DT_SEARCH) HD3
ON HD3.CD_COMPANY = ME.CD_COMPANY AND HD3.NO_EMP = ME.NO_EMP
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = ME.CD_COMPANY AND MC.CD_FIELD = 'HR_H000002' AND MC.CD_SYSDEF = ME.CD_DUTY_RANK
LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = ME.CD_COMPANY AND MC1.CD_FIELD = 'HR_H000003' AND MC1.CD_SYSDEF = ME.CD_DUTY_STEP
LEFT JOIN MA_CODEDTL MC2 ON MC2.CD_COMPANY = ME.CD_COMPANY AND MC2.CD_FIELD = 'HR_T000003' AND MC2.CD_SYSDEF = ME.CD_NATION
LEFT JOIN MA_CODEDTL MC3 ON MC3.CD_COMPANY = ME.CD_COMPANY AND MC3.CD_FIELD = 'HR_H000004' AND MC3.CD_SYSDEF = ME.CD_DUTY_TYPE
LEFT JOIN MA_CODEDTL MC4 ON MC4.CD_COMPANY = ME.CD_COMPANY AND MC4.CD_FIELD = 'HR_H000014' AND MC4.CD_SYSDEF = ME.CD_INCOM
WHERE (ISNULL(@P_CD_COMPANY, '') = '' OR ME.CD_COMPANY IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_COMPANY)))
AND (@P_YN_ALL = 'Y' OR (ME.DT_ENTER <= @P_DT_SEARCH
						AND (ME.DT_RETIRE >= @P_DT_SEARCH OR ISNULL(ME.DT_RETIRE, '00000000') = '00000000'))) -- 입사자, 퇴사자 체크
AND (ISNULL(@P_CD_DEPT, '') = '' OR ME.CD_DEPT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_DEPT)))
AND (ISNULL(@P_CD_DUTY_TYPE, '') = '' OR ME.CD_DUTY_TYPE IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_DUTY_TYPE)))
AND (ISNULL(@P_CD_INCOM, '') = '' OR ME.CD_INCOM = @P_CD_INCOM)
AND (ISNULL(@P_CD_NATION, '') = '' OR ME.CD_NATION = @P_CD_NATION)
AND (ISNULL(@P_SEARCH, '') = '' OR ME.NO_EMP LIKE + @P_SEARCH + '%' OR ME.NM_KOR LIKE + @P_SEARCH + '%')
AND ME.CD_EMP = '001'
ORDER BY ME.CD_COMPANY, ME.CD_DUTY_RANK, ME.CD_PAY_STEP DESC 

GO

