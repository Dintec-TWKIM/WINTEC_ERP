USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIRR_REG_SUBL_S]    Script Date: 2015-09-03 오후 6:58:00 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
  
ALTER PROCEDURE [NEOE].[SP_CZ_PU_REQR_REG_SUBL_S]
(      
    @P_CD_COMPANY		NVARCHAR(7),   
    @P_NO_IO			NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @P_AM_FSIZE		NUMERIC(3, 0)   -- 소수점

IF @P_CD_COMPANY = 'S100'
	SET @P_AM_FSIZE = 2
ELSE
	SET @P_AM_FSIZE = 0

SELECT 'N' AS S,
	   IL.NO_IO,
	   IL.CD_ITEM,
	   MI.NM_ITEM,
	   MI.STND_ITEM,
	   MI.UNIT_IM,
	   IL.DT_IO,
	   (CASE WHEN MI.FG_LOTNO ='002' THEN 'YES' ELSE 'NO' END) AS NO_LOT,
	   ROUND(ROUND(ROUND((ISNULL(IL.QT_UNIT_MM, 0) - ISNULL(IL.QT_RETURN_MM, 0)) * ISNULL(IL.UM_EX_PSO, 0), 2) * ISNULL(IL.RT_EXCH, 0), @P_AM_FSIZE) * ISNULL(VT.RT_VAT, 0), @P_AM_FSIZE) AS VAT,    
       ROUND((ISNULL(IL.QT_IO, 0) - ISNULL(IL.QT_RETURN, 0)) * ISNULL(IL.UM_EX, 0), 2) AS AM_EX,
       ((ISNULL(IL.QT_IO, 0) - ISNULL(IL.QT_RETURN, 0)) * ISNULL(IL.UM, 0)) AS AM,
	   (ISNULL(IL.QT_IO, 0) - ISNULL(IL.QT_RETURN, 0)) AS QT_IO,
	   (ISNULL(IL.QT_UNIT_MM, 0) - ISNULL(IL.QT_RETURN_MM, 0)) AS QT_IO_MM,
	   IL.UM_EX,
	   IL.UM,
	   IL.VAT,
	   IL.CD_PJT,
	   IL.NO_ISURCV,
	   PJ.NM_PROJECT,
	   IL.NO_PSO_MGMT,
	   IL.NO_PSOLINE_MGMT,
	   IL.CD_GROUP,
	   IL.NO_IOLINE,
	   IL.NO_IO,
	   IL.NO_LC,
	   IL.NO_LCLINE,
	   IL.CD_SL,
	   MS.NM_SL,
	   ISNULL(MI.UNIT_PO_FACT, 1) AS RATE_EXCHG,
	   IL.CD_UNIT_MM,
	   PJ.NO_PROJECT,
	   PJ.NM_PROJECT,
	   IL.FG_TAX,
	   ISNULL(VT.CD_FLAG1, 0) AS RATE_VAT,
	   ME.NM_KOR,
	   IL.NO_PSO_MGMT,
	   JL.SEQ_PROJECT,
	   JL.CD_ITEM AS CD_PJT_ITEM,
	   MI1.NM_ITEM AS PJT_MM_ITEM,
	   MI1.STND_ITEM AS PJT_STND_ITEM,
	   IL.NO_WBS,
	   IL.NO_CBS,
	   (CASE WHEN (ISNULL(IL.TP_UM_TAX, '002') = '002' OR LEN(IL.TP_UM_TAX) < 1) THEN '002' ELSE '001' END) AS TP_UM_TAX,
	   CD.NM_SYSDEF AS NM_TP_UM_TAX,
	   (((ISNULL(IL.QT_IO, 0) - ISNULL(IL.QT_RETURN, 0)) * ISNULL(IL.UM, 0)) + (((ISNULL(IL.QT_IO, 0) - ISNULL(IL.QT_RETURN, 0)) * ISNULL(IL.UM, 0)) * ISNULL(VT.RT_VAT,0))) AS AM_TOTAL,
	   IL.RT_EXCH,
	   PC.CD_CSTR,
	   PC.DL_CSTR,
	   PC.NM_CSTR,
	   PC.SIZE_CSTR,
	   PC.UNIT_CSTR,
	   PC.QTY_ACT,
	   PC.UNT_ACT,
	   PC.AMT_ACT,
	   IL.DC_RMK,
	   IL.CD_USERDEF1,
	   IL.CD_USERDEF2,
	   IL.NM_USERDEF1,
	   IL.NM_USERDEF2,
	   IL.NM_USERDEF3,
	   IL.NM_USERDEF4,
	   PL.DC1  
FROM MM_QTIO IL
LEFT JOIN PU_POL PL ON PL.CD_COMPANY = IL.CD_COMPANY AND PL.NO_PO = IL.NO_PSO_MGMT AND PL.NO_LINE = IL.NO_PSOLINE_MGMT
LEFT JOIN PU_POH PH ON PH.CD_COMPANY = PL.CD_COMPANY AND PH.NO_PO = PL.NO_PO
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = PH.CD_COMPANY AND ME.NO_EMP = PH.NO_EMP
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
LEFT JOIN SA_PROJECTH PJ ON PJ.CD_COMPANY = IL.CD_COMPANY AND PJ.NO_PROJECT = IL.CD_PJT
LEFT JOIN SA_PROJECTL JL ON JL.CD_COMPANY = IL.CD_COMPANY AND JL.NO_PROJECT = IL.CD_PJT AND JL.SEQ_PROJECT = IL.SEQ_PROJECT
LEFT JOIN MA_PITEM MI1 ON MI1.CD_COMPANY = JL.CD_COMPANY AND MI1.CD_PLANT = JL.CD_PLANT AND MI1.CD_ITEM = JL.CD_ITEM
LEFT JOIN MA_SL MS ON MS.CD_COMPANY = IL.CD_COMPANY AND MS.CD_SL = IL.CD_SL
LEFT JOIN PJ_CBS PC ON PC.CD_COMPANY = IL.CD_COMPANY AND PC.NO_PROJECT = IL.CD_PJT AND PC.NO_CBS = IL.NO_CBS
LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = IL.CD_COMPANY AND CD.CD_FIELD = 'PU_C000005' AND CD.CD_SYSDEF = ISNULL(IL.TP_UM_TAX, '002')
LEFT JOIN (SELECT CD_COMPANY, CD_SYSDEF,
				  CD_FLAG1,
				  (CONVERT(NUMERIC(20,8), CASE WHEN ISNULL(CD_FLAG1,'') = '' THEN '0' ELSE CD_FLAG1 END) / 100) AS RT_VAT  
		   FROM MA_CODEDTL
		   WHERE CD_FIELD = 'MA_B000046') VT 
ON VT.CD_COMPANY = IL.CD_COMPANY AND VT.CD_SYSDEF = IL.FG_TAX
WHERE IL.CD_COMPANY = @P_CD_COMPANY
AND IL.NO_IO = @P_NO_IO

GO