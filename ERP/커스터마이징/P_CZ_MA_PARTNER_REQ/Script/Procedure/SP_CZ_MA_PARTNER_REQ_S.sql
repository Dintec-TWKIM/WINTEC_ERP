USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_PARTNER_REQ_S]    Script Date: 2016-08-19 오후 4:37:12 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_MA_PARTNER_REQ_S]
(
	@P_CD_COMPANY 	NVARCHAR(4000),
	@P_YN_CONFIRM	NVARCHAR(3),
	@P_TP_GW_STATUS NVARCHAR(1),
	@P_LN_PARTNER	NVARCHAR(50)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
	   RQ.CD_COMPANY,
	   MC.NM_COMPANY,
       RQ.NO_REQ,
	   RQ.CD_PARTNER,
       RQ.LN_PARTNER,
       RQ.NO_COMPANY,
	   RQ.NO_RES,
       RQ.FG_PARTNER,
	   RQ.CLS_PARTNER,
       RQ.NM_CEO,
	   RQ.CD_AREA,
       RQ.CD_NATION,
       RQ.NO_POST1,
       RQ.DC_ADS1_H,
       RQ.DC_ADS1_D,
       RQ.CD_PARTNER_GRP,
       RQ.CD_PARTNER_GRP_2,
       RQ.NO_TEL1,
       RQ.NO_FAX1,
       RQ.TP_JOB,
       RQ.CLS_JOB,
	   RQ.TP_PTR,
       RQ.CD_EMP_PARTNER,
       RQ.NO_TEL,
       RQ.NO_HPEMP_PARTNER,
       RQ.E_MAIL,
       RQ.NO_FAX,
	   RQ.CD_DEPOSIT,
	   RQ.NO_DEPOSIT,
       RQ.CD_BANK,
	   RQ.NM_BANK,
	   RQ.CD_BANK_NATION,
	   RQ.NO_SORT,
	   RQ.CD_DEPOSIT_NATION,
	   RQ.NO_SWIFT,
       RQ.NM_DEPOSIT,
	   RQ.DC_DEPOSIT_TEL,
	   RQ.DC_DEPOSIT_ADDRESS,
       RQ.NO_BANK_BIC,
	   RQ.DC_RMK,
       RQ.CD_TPPO,
	   TP.NM_TPPO,
       RQ.CD_EXCH2,
       RQ.FG_PAYMENT,
       RQ.TP_COND_PRICE,
       RQ.FG_TAX,
       RQ.RT_PURCHASE_DC,
       RQ.TP_SO,
	   TS.NM_SO,
       RQ.CD_EXCH1,
	   RQ.TP_INQ_SEND,
	   RQ.TP_PO_SEND,
       RQ.TP_INQ_RCV,
       RQ.TP_QTN_SEND,
       RQ.TP_TERMS_PAYMENT,
       RQ.TP_DELIVERY_CONDITION,
       RQ.RT_SALES_PROFIT,
       RQ.RT_SALES_DC,
       RQ.RT_COMMISSION,
       RQ.DC_COMMISSION,
       RQ.TP_VAT,
       RQ.NM_TEXT,
	   GW.ST_STAT AS CD_GW_STATUS,
	   GW.APP_DOC_ID,
	   CD.NM_SYSDEF AS NM_GW_STATUS,
	   (CASE WHEN RQ.CD_PARTNER IS NULL THEN 'N' ELSE 'Y' END) AS YN_CONFIRM,
	   MP.CNT AS QT_PARTNER,
       RQ.TP_INV,
       RQ.YN_JEONJA,
       RQ.NM_ORIGIN,
       RQ.NM_ORIGIN_RPT,
       RQ.ID_INSERT,
	   MU.NM_USER AS NM_INSERT,
       RQ.DTS_INSERT,
       RQ.ID_UPDATE,
       MU1.NM_USER AS NM_UPDATE,
	   RQ.DTS_UPDATE 
FROM CZ_MA_PARTNER_REQ RQ
LEFT JOIN MA_COMPANY MC ON MC.CD_COMPANY = RQ.CD_COMPANY
LEFT JOIN FI_GWDOCU GW ON GW.CD_COMPANY = 'K100' AND GW.CD_PC = '010000' AND GW.NO_DOCU = RQ.CD_COMPANY + '-' + RQ.NO_REQ
LEFT JOIN SA_TPSO TS ON TS.CD_COMPANY = RQ.CD_COMPANY AND TS.TP_SO = RQ.TP_SO
LEFT JOIN PU_TPPO TP ON TP.CD_COMPANY = RQ.CD_COMPANY AND TP.CD_TPPO = RQ.CD_TPPO
LEFT JOIN MA_USER MU ON MU.CD_COMPANY = RQ.CD_COMPANY AND MU.ID_USER = RQ.ID_INSERT
LEFT JOIN MA_USER MU1 ON MU1.CD_COMPANY = RQ.CD_COMPANY AND MU1.ID_USER = RQ.ID_UPDATE
LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = RQ.CD_COMPANY AND CD.CD_FIELD = 'PU_C000065' AND CD.CD_SYSDEF = GW.ST_STAT
LEFT JOIN (SELECT CD_PARTNER, COUNT(1) AS CNT
		   FROM MA_PARTNER
		   GROUP BY CD_PARTNER) MP
ON MP.CD_PARTNER = RQ.CD_PARTNER
WHERE (ISNULL(@P_CD_COMPANY, '') = '' OR RQ.CD_COMPANY IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_COMPANY)))
AND (ISNULL(@P_YN_CONFIRM, '') = '' OR 
	 (@P_YN_CONFIRM = '001' AND RQ.CD_PARTNER IS NOT NULL) OR 
	 (@P_YN_CONFIRM = '002' AND RQ.CD_PARTNER IS NULL))
AND (ISNULL(@P_TP_GW_STATUS, '') = '' OR GW.ST_STAT = @P_TP_GW_STATUS)
AND (ISNULL(@P_LN_PARTNER, '') = '' OR RQ.LN_PARTNER LIKE '%' + @P_LN_PARTNER + '%')
ORDER BY DTS_INSERT

GO

