USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_HR_WBARCODE_S]    Script Date: 2020-03-12 오전 11:07:56 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*******************************************
*********************************************/
ALTER PROCEDURE [NEOE].[SP_CZ_HR_WBARCODE_S]
(
	@P_CD_COMPANY  		NVARCHAR(7),	
	@P_MULTI_BIZAREA	NVARCHAR(1000),
	@P_MULTI_DEPT		NVARCHAR(1000),
	@P_MULTI_EMP		NVARCHAR(1000),
	@P_DT_FROM			NVARCHAR(8),
	@P_DT_TO			NVARCHAR(8)
)
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	SELECT PV.NO_EMP,
		   PV.NM_KOR,
		   PV.NO_CARD,
		   PV.DT_WORK,
		   PV.[001] AS TM_001,
		   PV.[002] AS TM_002,
		   PV.[003] AS TM_003,
		   PV.[004] AS TM_004,
		   PV.[001] AS TM_001_OLD,
		   PV.[002] AS TM_002_OLD,
		   PV.[003] AS TM_003_OLD,
		   PV.[004] AS TM_004_OLD
	FROM (SELECT ME.NO_EMP,
		  	     ME.NM_KOR,
				 (SELECT CM.NO_CARD 
				  FROM HR_WECMATCH CM 
				  WHERE CM.CD_COMPANY = ME.CD_COMPANY
				  AND CM.NO_EMP = ME.NO_EMP) AS NO_CARD,
		  	     CL.DT_CAL AS DT_WORK,
		  	     BC.CD_WCODE,
		  	     BC.TM_CARD
		  FROM MA_EMP ME 
		  LEFT JOIN MA_CALENDAR CL ON CL.CD_COMPANY = ME.CD_COMPANY
		  LEFT JOIN (SELECT BC.CD_COMPANY,
				            BC.DT_WORK,
				            CM.NO_EMP,
				            BC.CD_WCODE,
				            BC.TM_CARD
					 FROM HR_WBARCODE BC
					 JOIN HR_WECMATCH CM ON CM.CD_COMPANY = BC.CD_COMPANY AND CM.NO_CARD = BC.NO_CARD
					 --WHERE (BC.CD_WCODE <> '002' OR BC.TM_CARD > '0900')
					 --UNION ALL
					 --SELECT BC.CD_COMPANY,
					 --	    CONVERT(CHAR(8), DATEADD(DAY, -1, BC.DT_WORK), 112) AS DT_WORK,
					 --	    CM.NO_EMP,
					 --	    BC.CD_WCODE,
					 --	    BC.TM_CARD
					 --FROM HR_WBARCODE BC
					 --JOIN HR_WECMATCH CM ON CM.CD_COMPANY = BC.CD_COMPANY AND CM.NO_CARD = BC.NO_CARD
					 --WHERE BC.CD_WCODE = '002' 
					 --AND BC.TM_CARD <= '0900'
					 --AND NOT EXISTS (SELECT 1 
					 --			     FROM HR_WBARCODE BC1
					 --			     WHERE BC1.CD_COMPANY = BC.CD_COMPANY
					 --			     AND BC1.NO_CARD = BC.NO_CARD
					 --			     AND BC1.DT_WORK = CONVERT(CHAR(8), DATEADD(DAY, -1, BC.DT_WORK), 112)
					 --			     AND BC1.CD_WCODE = '002')
					 --AND NOT EXISTS (SELECT 1 
					 --				 FROM HR_WBARCODE BC1
						--			 WHERE BC1.CD_COMPANY = BC.CD_COMPANY
						--			 AND BC1.NO_CARD = BC.NO_CARD
						--			 AND BC1.DT_WORK = BC.DT_WORK
						--			 AND BC1.CD_WCODE = '001'
						--			 AND BC1.TM_CARD < BC.TM_CARD)
		  ) BC
		  ON BC.CD_COMPANY = ME.CD_COMPANY AND BC.DT_WORK = CL.DT_CAL AND BC.NO_EMP = ME.NO_EMP
		  WHERE ME.CD_COMPANY = @P_CD_COMPANY
		  AND (ME.TP_EMP IN ('100', '200') OR ME.NO_EMP LIKE 'A-%')
		  AND ME.CD_DUTY_RANK > '009'
		  AND CL.DT_CAL BETWEEN @P_DT_FROM AND @P_DT_TO
		  AND ISNULL(ME.DT_RETIRE, '00000000') = '00000000'
		  AND (ISNULL(@P_MULTI_BIZAREA, '') = '' OR ME.CD_BIZAREA IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_BIZAREA)))
		  AND (ISNULL(@P_MULTI_DEPT, '') = '' OR ME.CD_DEPT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_DEPT)))
		  AND (ISNULL(@P_MULTI_EMP, '') = '' OR ME.NO_EMP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_EMP)))) A
	PIVOT (MAX(A.TM_CARD) FOR A.CD_WCODE IN ([001],[002],[003],[004])) PV
	ORDER BY PV.DT_WORK, PV.NO_EMP
END
GO

