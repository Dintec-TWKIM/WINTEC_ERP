USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PU_PO_REG2_SUBH]    Script Date: 2019-07-08 오후 4:46:30 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PU_PO_REG2_SUBH]    
(    
    @P_CD_COMPANY	NVARCHAR(7),  
    @P_DT_PO_FROM	NVARCHAR(8),
    @P_DT_PO_TO		NVARCHAR(8),
    @P_CD_PLANT		NVARCHAR(7),
    @P_CD_PARTNER	NVARCHAR(20),
    @P_CD_PJT		NVARCHAR(20),
    @P_CD_PURGRP	NVARCHAR(4000),
    @P_CD_TPPO		NVARCHAR(4000),
    @P_NO_EMP		NVARCHAR(10),
    @P_NO_PO		NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT DISTINCT PH.NO_PO, 
			    MP.LN_PARTNER, 
				MG.NM_PURGRP,
				PH.DT_PO, 
				PT.NM_TPPO, 
				MS.CD_PURORG, 
				PH.DC50_PO, 
				PH.NO_HST, 
				ME.NM_KOR
FROM PU_POH PH 
LEFT JOIN MA_PARTNER MP ON PH.CD_COMPANY = MP.CD_COMPANY AND PH.CD_PARTNER = MP.CD_PARTNER
LEFT JOIN MA_PURGRP MG ON PH.CD_COMPANY = MG.CD_COMPANY AND PH.CD_PURGRP = MG.CD_PURGRP
LEFT JOIN PU_TPPO PT ON PH.CD_COMPANY = PT.CD_COMPANY AND PH.CD_TPPO = PT.CD_TPPO
LEFT JOIN MA_PURORG MS ON MG.CD_COMPANY = MS.CD_COMPANY AND MG.CD_PURORG = MS.CD_PURORG
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = PH.CD_COMPANY AND ME.NO_EMP = PH.NO_EMP
WHERE PH.CD_COMPANY = @P_CD_COMPANY
AND PH.DT_PO BETWEEN @P_DT_PO_FROM AND @P_DT_PO_TO
AND PH.CD_PLANT = @P_CD_PLANT
AND PH.NO_PO LIKE 'PY%'
AND (ISNULL(@P_CD_PURGRP, '') = '' OR PH.CD_PURGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_PURGRP)))
AND (ISNULL(@P_CD_PARTNER, '') = '' OR PH.CD_PARTNER = @P_CD_PARTNER)
AND (ISNULL(@P_CD_TPPO, '') = '' OR PH.CD_TPPO IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_TPPO)))
AND (ISNULL(@P_NO_EMP, '') = '' OR PH.NO_EMP = @P_NO_EMP)
AND (ISNULL(@P_NO_PO, '') = '' OR PH.NO_PO LIKE @P_NO_PO + '%')
AND EXISTS (SELECT 1 
		    FROM PU_POL PL
			WHERE PL.CD_COMPANY = PH.CD_COMPANY
			AND PL.NO_PO = PH.NO_PO
			AND PL.YN_SUBCON = 'N'
			AND (ISNULL(@P_CD_PJT, '') = '' OR PL.CD_PJT = @P_CD_PJT))
ORDER BY PH.NO_PO

GO