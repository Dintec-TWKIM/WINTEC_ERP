USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_WORKFLOW_COUNT_12]    Script Date: 2018-08-21 오후 3:42:47 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




-- 수발주통보서결재
ALTER PROCEDURE [NEOE].[SP_CZ_MA_WORKFLOW_COUNT_12]  
(
	@P_CD_COMPANY			NVARCHAR(7),
	@P_ID_USER				NVARCHAR(15),
	@P_NO_KEY				NVARCHAR(20),
	@P_CD_SALEORG			NVARCHAR(7),		
	@P_CD_SALEGRP			NVARCHAR(500)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT COUNT(1) AS CNT
FROM CZ_MA_WORKFLOWH WH
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = WH.CD_COMPANY AND SH.NO_SO = WH.NO_KEY
WHERE WH.TP_STEP = '12'
AND (WH.YN_DONE IS NULL OR WH.YN_DONE = 'N' OR WH.YN_DONE = 'F')
AND (SH.YN_CLOSE IS NULL OR SH.YN_CLOSE = 'N')
AND (ISNULL(@P_CD_COMPANY, '') = '' OR WH.CD_COMPANY = @P_CD_COMPANY)
AND (ISNULL(@P_NO_KEY, '') = '' OR WH.NO_KEY = @P_NO_KEY)
AND (ISNULL(@P_ID_USER, '') = '' OR ((WH.ID_PUR = @P_ID_USER) OR 
									 (ISNULL(WH.YN_DONE, 'N') = 'N' AND EXISTS (SELECT 1 
																			    FROM CZ_SA_USER
																				WHERE CD_COMPANY = WH.CD_COMPANY
																				AND ID_USER =  WH.ID_PUR
																				AND ID_FIRST_APPROVAL = @P_ID_USER)) OR 
									 (ISNULL(WH.YN_DONE, 'N') = 'F' AND EXISTS (SELECT 1 
																			    FROM CZ_SA_USER
																				WHERE CD_COMPANY = WH.CD_COMPANY
																				AND ID_USER =  WH.ID_PUR
																				AND ID_SECOND_APPROVAL = @P_ID_USER))))
AND (ISNULL(@P_CD_SALEGRP, '') = '' OR EXISTS (SELECT 1 
											   FROM MA_USER MU
											   WHERE MU.CD_COMPANY = WH.CD_COMPANY
											   AND MU.ID_USER = WH.ID_PUR
											   AND MU.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP))))
AND (ISNULL(@P_CD_SALEORG, '') = '' OR EXISTS (SELECT 1 
											   FROM MA_USER MU
											   JOIN MA_SALEGRP SG ON SG.CD_COMPANY = MU.CD_COMPANY AND SG.CD_SALEGRP = MU.CD_SALEGRP
											   WHERE MU.CD_COMPANY = WH.CD_COMPANY
											   AND MU.ID_USER = WH.ID_PUR
											   AND SG.CD_SALEORG = @P_CD_SALEORG))

GO

