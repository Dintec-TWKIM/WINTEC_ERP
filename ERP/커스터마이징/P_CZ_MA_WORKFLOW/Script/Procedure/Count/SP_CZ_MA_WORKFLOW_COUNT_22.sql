USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_WORKFLOW_COUNT_22]    Script Date: 2019-09-06 오전 10:48:13 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





-- 인수증확인
ALTER PROCEDURE [NEOE].[SP_CZ_MA_WORKFLOW_COUNT_22]  
(
	@P_CD_COMPANY			NVARCHAR(7),
	@P_ID_USER				NVARCHAR(15),
	@P_NO_KEY				NVARCHAR(20),
	@P_CD_SALEORG			NVARCHAR(7),		
	@P_CD_SALEGRP			NVARCHAR(500)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

WITH OH AS
(
	SELECT OL.CD_COMPANY, 
	       OL.NO_IO, 
		   OL.DT_IO,
	       OL.NO_ISURCV,
		   OL.NO_PSO_MGMT
	FROM MM_QTIOH OH
    JOIN MM_QTIO OL ON OL.CD_COMPANY = OH.CD_COMPANY AND OL.NO_IO = OH.NO_IO
	WHERE (ISNULL(@P_CD_COMPANY, '') = '' OR OH.CD_COMPANY = @P_CD_COMPANY)
	AND OH.DT_IO > '20151231'
	AND (OH.YN_RETURN IS NULL OR OH.YN_RETURN = 'N')
	AND OL.FG_PS = '2'
	AND OL.YN_AM = 'Y'
	AND OL.QT_IO > OL.QT_CLS
	GROUP BY OL.CD_COMPANY, OL.NO_IO, OL.DT_IO, OL.NO_ISURCV, OL.NO_PSO_MGMT
),
OH1 AS
(
	SELECT 1 AS CNT
	FROM OH
	JOIN SA_GIRH GH ON GH.CD_COMPANY = OH.CD_COMPANY AND GH.NO_GIR = OH.NO_ISURCV
	JOIN CZ_SA_GIRH_WORK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
	JOIN (SELECT CD_COMPANY, CD_FILE
		  FROM MA_FILEINFO 
		  WHERE CD_MODULE = 'SA'
		  AND ID_MENU = 'P_CZ_SA_GIM_REG'
		  GROUP BY CD_COMPANY, CD_FILE) MF
	ON MF.CD_COMPANY = GH.CD_COMPANY AND MF.CD_FILE = GH.NO_GIR + '_' + GH.CD_COMPANY
	LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = OH.CD_COMPANY AND SH.NO_SO = OH.NO_PSO_MGMT
	LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
	WHERE GD.NO_IMO IS NOT NULL
	AND GD.DT_LOADING IS NOT NULL 
	AND GD.DT_LOADING <> ''
	AND (GD.YN_BILL IS NULL OR GD.YN_BILL = 'N')
	AND (MP.CD_AREA = '100' OR MP.CD_AREA IS NULL OR MP.CD_AREA = '')
	AND (ISNULL(@P_ID_USER, '') = '' OR GH.NO_EMP = @P_ID_USER OR SH.NO_EMP = @P_ID_USER)
	AND (ISNULL(@P_NO_KEY, '') = '' OR GH.NO_GIR = @P_NO_KEY)
	AND (ISNULL(@P_CD_SALEGRP, '') = '' OR EXISTS (SELECT 1 
												   FROM SA_GIRL GL
												   WHERE GL.CD_COMPANY = GH.CD_COMPANY
												   AND GL.NO_GIR = GH.NO_GIR
												   AND GL.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP))))
	AND (ISNULL(@P_CD_SALEORG, '') = '' OR EXISTS (SELECT 1 
												   FROM SA_GIRL GL
												   JOIN MA_SALEGRP SG ON SG.CD_COMPANY = GL.CD_COMPANY AND SG.CD_SALEGRP = GL.CD_SALEGRP
												   WHERE GL.CD_COMPANY = GH.CD_COMPANY
												   AND GL.NO_GIR = GH.NO_GIR
												   AND SG.CD_SALEORG = @P_CD_SALEORG))
	GROUP BY OH.CD_COMPANY, OH.NO_IO, OH.NO_ISURCV
)
SELECT COUNT(CNT) AS CNT
FROM OH1


GO

