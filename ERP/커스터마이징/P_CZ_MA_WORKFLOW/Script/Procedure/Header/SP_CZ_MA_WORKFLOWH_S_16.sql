USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_WORKFLOWH_S_16]    Script Date: 2018-08-13 오전 9:48:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



-- 납품완결
ALTER PROCEDURE [NEOE].[SP_CZ_MA_WORKFLOWH_S_16]  
(
	@P_CD_COMPANY			NVARCHAR(7),
	@P_ID_USER				NVARCHAR(15),
	@P_NO_KEY				NVARCHAR(20),
	@P_CD_SALEORG			NVARCHAR(7),		
	@P_CD_SALEGRP			NVARCHAR(500)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
       PH.CD_COMPANY,
       PH.NO_GIR AS NO_KEY,
       PH.NO_PACK,
       PH.NM_PACK,
       PH.DT_PACK,
       MC.NM_SYSDEF AS NM_TYPE,
       MC1.NM_SYSDEF AS NM_SIZE,
       PH.QT_NET_WEIGHT,
       PH.QT_GROSS_WEIGHT,
       PH.QT_WIDTH,
       PH.QT_LENGTH,
       PH.QT_HEIGHT,
       PH.CD_LOCATION,
       PH.DC_RMK,
       GH.DT_GIR,
       GH.NO_EMP,
       ME.NM_KOR,
       MP.LN_PARTNER AS NM_PARTNER,
       MH.NM_VESSEL
FROM CZ_SA_PACKH PH
JOIN (SELECT GH.CD_COMPANY,
			 GH.NO_GIR,
			 GH.DT_GIR,
		     GH.NO_EMP,
			 GH.CD_PARTNER,
			 GD.NO_IMO 
      FROM SA_GIRH GH
	  LEFT JOIN CZ_SA_GIRH_WORK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
	  WHERE GH.STA_GIR = 'C'
	  AND (ISNULL(@P_CD_COMPANY, '') = '' OR GH.CD_COMPANY = @P_CD_COMPANY)
      AND (ISNULL(@P_NO_KEY, '') = '' OR GH.NO_GIR = @P_NO_KEY)
	  AND (ISNULL(@P_ID_USER, '') = '' OR GH.NO_EMP = @P_ID_USER)
	  AND (ISNULL(@P_CD_SALEGRP, '') = '' OR EXISTS (SELECT 1 
	  											     FROM SA_GIRL GL
	  											     WHERE GL.CD_COMPANY = GH.CD_COMPANY
	  											     AND GL.NO_GIR = GH.NO_GIR
	  											     AND GL.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP))))
	  AND (ISNULL(@P_CD_SALEORG, '') = '' OR EXISTS (SELECT 1 
	  											     FROM SA_GIRL GL
	  											     JOIN MA_SALEGRP SG ON SG.CD_COMPANY = GL.CD_COMPANY AND SG.CD_SALEGRP = GL.CD_SALEGRP
	  											     WHERE GL.CD_COMPANY = GH.CD_COMPANY
	  											     AND GL.NO_GIR = GH.NO_GIR
	  											     AND SG.CD_SALEORG = @P_CD_SALEORG))) GH
ON GH.CD_COMPANY = PH.CD_COMPANY AND GH.NO_GIR = PH.NO_GIR
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = GH.NO_IMO
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = GH.CD_COMPANY AND ME.NO_EMP = GH.NO_EMP
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = PH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00026' AND MC.CD_SYSDEF = PH.CD_TYPE
LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = PH.CD_COMPANY AND MC1.CD_FIELD = MC.CD_FLAG1 AND MC.CD_SYSDEF = PH.CD_SIZE
WHERE PH.CD_LOCATION IS NOT NULL

GO

