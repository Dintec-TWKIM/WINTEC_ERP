USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_WORKFLOWH_S_17]    Script Date: 2018-08-13 오전 9:48:23 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



-- 인수증등록
ALTER PROCEDURE [NEOE].[SP_CZ_MA_WORKFLOWH_S_17]  
(
	@P_CD_COMPANY			NVARCHAR(7),
	@P_ID_USER				NVARCHAR(15),
	@P_NO_KEY				NVARCHAR(20),
	@P_CD_SALEORG			NVARCHAR(7),		
	@P_CD_SALEGRP			NVARCHAR(500)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT OL.CD_COMPANY,
	   OL.NO_ISURCV AS NO_KEY,
	   OL.NO_IO,
	   STUFF((SELECT CHAR(10) + SH.NO_SO + '(' + (CASE WHEN SUM(SL.QT_SO) = SUM(SL.QT_GI) AND (SELECT COUNT(DISTINCT OL.NO_IO) 
																							   FROM MM_QTIO OL
																							   WHERE OL.CD_COMPANY = OL.CD_COMPANY
																							   AND OL.NO_PSO_MGMT = SH.NO_SO
																							   AND OL.FG_PS = '2'
																							   AND YN_PURSALE = 'Y'
																							   AND CD_QTIOTP IN ('200', '240', '250', '210', '241', '251')) = 1 THEN 'C' ELSE 'P' END) + ':' + CONVERT(NVARCHAR, CONVERT(INT, SUM(SL.QT_GI))) + '/' + CONVERT(NVARCHAR, CONVERT(INT, SUM(SL.QT_SO))) + ')' 
		      FROM SA_SOH SH
			  JOIN SA_SOL SL ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
			  WHERE SH.CD_COMPANY = OL.CD_COMPANY
			  AND EXISTS (SELECT 1 
					      FROM MM_QTIO OL1
					      WHERE OL1.CD_COMPANY = OL.CD_COMPANY
					      AND OL1.NO_IO = OL.NO_IO
					      AND OL1.NO_PSO_MGMT = SH.NO_SO)
			   GROUP BY SH.NO_SO
			   ORDER BY SH.NO_SO
			   FOR XML PATH('')),1,1,'') AS NO_SO_STATUS,
	   GH.DT_GIR,
	   GD.DT_COMPLETE,
	   OL.DT_IO,
	   GD.DT_LOADING,
	   (CASE WHEN MF.CD_FILE IS NULL THEN 'N' ELSE 'Y' END) AS YN_FILE,
	   MD1.NM_SYSDEF AS NM_TYPE1,
	   MD.NM_SYSDEF AS NM_TYPE2,
	   MD2.NM_SYSDEF AS NM_TYPE3,
	   GD.YN_PACKING,
	   MD3.NM_SYSDEF AS NM_STA_GIR,
	   ME.NM_KOR AS NM_EMP_GIR,
	   MP.LN_PARTNER AS NM_PARTNER,
	   MH.NM_VESSEL,
	   MP1.LN_PARTNER AS NM_GIR_PARTNER,
	   MD4.NM_SYSDEF AS NM_RETURN, 
	   MC.NM_COMPANY,
	   GD.DC_RMK,
	   GD.DC_RMK2,
	   STUFF((SELECT CHAR(10) + SH.NO_PO_PARTNER
		      FROM SA_SOH SH
			  WHERE SH.CD_COMPANY = OL.CD_COMPANY
			  AND EXISTS (SELECT 1 
					      FROM MM_QTIO OL1
					      WHERE OL1.CD_COMPANY = OL.CD_COMPANY
					      AND OL1.NO_IO = OL.NO_IO
					      AND OL1.NO_PSO_MGMT = SH.NO_SO)
			  FOR XML PATH('')),1,1,'') AS NO_PO_PARTNER
FROM (SELECT OH.CD_COMPANY, 
			 OH.NO_IO, 
			 OH.DT_IO, 
			 OL.NO_ISURCV 
	  FROM MM_QTIOH OH
	  JOIN MM_QTIO OL ON OL.CD_COMPANY = OH.CD_COMPANY AND OL.NO_IO = OH.NO_IO
	  WHERE OH.DT_IO > '20151231'
	  AND (OH.YN_RETURN IS NULL OR OH.YN_RETURN = 'N')
	  AND (ISNULL(@P_CD_COMPANY, '') = '' OR OH.CD_COMPANY = @P_CD_COMPANY)
	  GROUP BY OH.CD_COMPANY, OH.NO_IO, OH.DT_IO, OL.NO_ISURCV) OL
JOIN SA_GIRH GH ON GH.CD_COMPANY = OL.CD_COMPANY AND GH.NO_GIR = OL.NO_ISURCV
LEFT JOIN CZ_SA_GIRH_WORK_DETAIL GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.NO_GIR = GH.NO_GIR
LEFT JOIN MA_COMPANY MC ON MC.CD_COMPANY = GH.CD_COMPANY
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = GD.NO_IMO
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = GH.CD_COMPANY AND ME.NO_EMP = GH.NO_EMP
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
LEFT JOIN CZ_MA_DELIVERY MP1 ON MP1.CD_COMPANY = GD.CD_COMPANY AND MP1.CD_PARTNER = GD.CD_DELIVERY_TO
LEFT JOIN MA_CODEDTL MD ON MD.CD_COMPANY = GD.CD_COMPANY AND MD.CD_FIELD = 'CZ_SA00006' AND MD.CD_SYSDEF = GD.CD_MAIN_CATEGORY
LEFT JOIN MA_CODEDTL MD1 ON MD1.CD_COMPANY = GD.CD_COMPANY AND MD1.CD_FIELD = 'CZ_SA00021' AND MD1.CD_SYSDEF = '001'
LEFT JOIN MA_CODEDTL MD2 ON MD2.CD_COMPANY = GD.CD_COMPANY AND MD2.CD_FIELD = MD.CD_FLAG1 AND MD2.CD_SYSDEF = GD.CD_SUB_CATEGORY
LEFT JOIN MA_CODEDTL MD3 ON MD3.CD_COMPANY = GH.CD_COMPANY AND MD3.CD_FIELD = 'CZ_SA00030' AND MD3.CD_SYSDEF = GH.STA_GIR
LEFT JOIN MA_CODEDTL MD4 ON MD4.CD_COMPANY = GH.CD_COMPANY AND MD4.CD_FIELD = 'PU_C000027' AND MD4.CD_SYSDEF = GH.YN_RETURN
LEFT JOIN (SELECT CD_COMPANY, CD_FILE
		   FROM MA_FILEINFO 
		   WHERE CD_MODULE = 'SA'
		   AND ID_MENU = 'P_CZ_SA_GIM_REG'
		   GROUP BY CD_COMPANY, CD_FILE) MF
ON MF.CD_COMPANY = OL.CD_COMPANY AND MF.CD_FILE = OL.NO_ISURCV + '_' + OL.CD_COMPANY
WHERE GD.NO_IMO IS NOT NULL
AND ((GD.DT_LOADING IS NULL OR GD.DT_LOADING = '') OR MF.CD_FILE IS NULL)
AND (ISNULL(@P_NO_KEY, '') = '' OR GH.NO_GIR = @P_NO_KEY)
AND (ISNULL(@P_ID_USER, '') = '' OR GH.NO_EMP = @P_ID_USER)
AND (ISNULL(@P_CD_SALEGRP, '') = '' OR EXISTS (SELECT 1 
											   FROM SA_GIRL GL
											   WHERE GL.CD_COMPANY = GH.CD_COMPANY
											   AND GL.NO_GIR = GH.NO_GIR
											   AND GL.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP))))
AND (ISNULL(@P_CD_SALEORG, '') = '' OR EXISTS (SELECT 1 
											   FROM SA_GIRL GL
											   JOIN MA_SALEGRP SG ON SG.CD_COMPANY = GL.CD_COMPANY AND SG.CD_SALEGRP = GL.CD_SALEGRP
											   WHERE GL.CD_COMPANY = GH.CD_COMPANY
											   AND GL.NO_GIR = GH.NO_GIR
											   AND SG.CD_SALEORG = @P_CD_SALEORG))

GO

