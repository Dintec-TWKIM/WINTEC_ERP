USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_WORKFLOWH_S_3]    Script Date: 2018-08-13 오전 9:45:34 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



-- 문의서검토
ALTER PROCEDURE [NEOE].[SP_CZ_MA_WORKFLOWH_S_3]  
(
	@P_CD_COMPANY			NVARCHAR(7),
	@P_ID_USER				NVARCHAR(15),
	@P_NO_KEY				NVARCHAR(20),
	@P_CD_SALEORG			NVARCHAR(7),		
	@P_CD_SALEGRP			NVARCHAR(500)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
	   (CASE WHEN QH1.NO_FILE IS NULL THEN 'Y' ELSE 'N' END) AS YN_SEND,
	   WH.CD_COMPANY,
	   WH.NO_KEY,
	   WH.DTS_INSERT,
	   WH.ID_SALES,
	   MU.NM_USER AS NM_SALES,
	   MU1.NM_USER AS NM_TYPIST,
	   MP.LN_PARTNER AS NM_PARTNER,
	   MH.NM_VESSEL,
	   (SELECT MAX(IG.NM_ITEMGRP) 
	    FROM CZ_SA_QTNL QL
		JOIN MA_ITEMGRP IG ON IG.CD_COMPANY = QL.CD_COMPANY AND IG.USE_YN = 'Y' AND CD_ITEMGRP = QL.GRP_ITEM
		WHERE QL.CD_COMPANY = WH.CD_COMPANY
		AND QL.NO_FILE = WH.NO_KEY) AS NM_ITEMGRP,
	   (SELECT (CASE WHEN YN_DONE = 'Y' THEN '완료' ELSE '요청' END)  
	    FROM CZ_MA_WORKFLOWH
		WHERE CD_COMPANY = WH.CD_COMPANY
		AND NO_KEY = WH.NO_KEY
		AND TP_STEP = '21') AS TP_CHECK
FROM CZ_MA_WORKFLOWH WH
LEFT JOIN CZ_SA_QTNH QH ON QH.CD_COMPANY = WH.CD_COMPANY AND QH.NO_FILE = WH.NO_KEY
LEFT JOIN (SELECT CD_COMPANY, NO_FILE
		   FROM CZ_PU_QTNH
		   WHERE (YN_SEND IS NULL OR YN_SEND = 'N') 
		   GROUP BY CD_COMPANY, NO_FILE) QH1
ON QH1.CD_COMPANY = QH.CD_COMPANY AND QH1.NO_FILE = QH.NO_FILE
LEFT JOIN MA_USER MU ON MU.CD_COMPANY = WH.CD_COMPANY AND MU.ID_USER = WH.ID_SALES
LEFT JOIN MA_USER MU1 ON MU1.CD_COMPANY = WH.CD_COMPANY AND MU1.ID_USER = WH.ID_TYPIST
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = QH.CD_COMPANY AND MP.CD_PARTNER = QH.CD_PARTNER
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = QH.NO_IMO
WHERE WH.TP_STEP = '03'
AND (WH.YN_DONE IS NULL OR WH.YN_DONE = 'N')
AND (QH.YN_CLOSE IS NULL OR QH.YN_CLOSE = 'N')
AND (ISNULL(@P_CD_COMPANY, '') = '' OR WH.CD_COMPANY = @P_CD_COMPANY)
AND (ISNULL(@P_ID_USER, '') = '' OR WH.ID_SALES = @P_ID_USER)
AND (ISNULL(@P_NO_KEY, '') = '' OR WH.NO_KEY = @P_NO_KEY)
AND (ISNULL(@P_CD_SALEGRP, '') = '' OR MU.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP)))
AND (ISNULL(@P_CD_SALEORG, '') = '' OR EXISTS (SELECT 1 
											   FROM MA_SALEGRP
											   WHERE CD_COMPANY = MU.CD_COMPANY
											   AND CD_SALEGRP = MU.CD_SALEGRP
											   AND CD_SALEORG = @P_CD_SALEORG))
ORDER BY WH.NO_KEY

GO

