USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_WORKFLOWH_S_12]    Script Date: 2018-08-13 오전 9:47:37 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



-- 수발주통보서결재
ALTER PROCEDURE [NEOE].[SP_CZ_MA_WORKFLOWH_S_12]  
(
	@P_CD_COMPANY			NVARCHAR(7),
	@P_ID_USER				NVARCHAR(15),
	@P_NO_KEY				NVARCHAR(20),
	@P_CD_SALEORG			NVARCHAR(7),		
	@P_CD_SALEGRP			NVARCHAR(500)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
	   (CASE WHEN WH.YN_DONE IS NULL OR WH.YN_DONE = 'N' THEN '미결재'
			 WHEN WH.YN_DONE = 'F' THEN '1차결재' END) AS YN_DONE,
	   SC.YN_RE_APPROVAL,
	   WH.CD_COMPANY,
	   WH.NO_KEY,
	   (SELECT TOP 1 NM_FILE 
	    FROM CZ_MA_WORKFLOWL 
		WHERE CD_COMPANY = WH.CD_COMPANY 
		AND TP_STEP = '11' 
		AND NO_KEY = WH.NO_KEY 
		ORDER BY DTS_INSERT DESC) AS NM_FILE,
	   (SELECT TOP 1 NM_FILE_REAL 
	    FROM CZ_MA_WORKFLOWL 
		WHERE CD_COMPANY = WH.CD_COMPANY 
		AND TP_STEP = '11' 
		AND NO_KEY = WH.NO_KEY 
		ORDER BY DTS_INSERT DESC) AS NM_FILE_REAL,
	   MP.LN_PARTNER AS NM_PARTNER,
	   MH.NM_VESSEL,
	   SH.DT_CONTRACT,
	   WH.ID_SALES,
	   MU.NM_USER AS NM_SALES,
	   MU1.NM_USER AS NM_PUR,
	   SU.ID_FIRST_APPROVAL,
	   MU2.NM_USER AS NM_FIRST_APPROVAL,
	   SU.ID_SECOND_APPROVAL,
	   MU3.NM_USER AS NM_SECOND_APPROVAL,
	   SH.AM_SO,
	   SH.AM_SO_CHARGE,
	   SH.AM_PO,
	   SH.AM_PO_CHARGE,
	   SH.PROFIT,
	   SH.PROFIT_ALL,
	   (CASE WHEN SH.AM_SO IS NULL OR SH.AM_SO = 0 THEN 0 
												   ELSE ROUND((ISNULL(SH.PROFIT, 0) / ISNULL(SH.AM_SO, 0)) * 100, 2) END) AS RT_PROFIT, 
	   (CASE WHEN SH.AM_SO_ALL IS NULL OR SH.AM_SO_ALL = 0 THEN 0 
														   ELSE ROUND((ISNULL(SH.PROFIT_ALL, 0) / ISNULL(SH.AM_SO_ALL, 0)) * 100, 2) END) AS RT_PROFIT_ALL,
	   SH.DC_RMK1,
	   SH.DC_RMK_CONTRACT,
	   SC.DC_COMMENT_FIRST,
	   SC.DC_COMMENT_SECOND,
	   SH.QT_MINUS,
	   TS.NM_SO,
	   EJ.YN_AM,
	   (SELECT STRING_AGG(CONVERT(NVARCHAR(MAX), QL.NO_DSP) + '. ' + RL.DC_RMK, CHAR(13) + CHAR(10)) AS DC_RMK
		FROM CZ_SA_CONTRACT_RPTL RL
		LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = RL.CD_COMPANY AND QL.NO_FILE = RL.NO_SO AND QL.NO_LINE = RL.SEQ_SO
		WHERE RL.CD_COMPANY = WH.CD_COMPANY
		AND RL.NO_SO = WH.NO_KEY
		AND ISNULL(RL.DC_RMK, '') <> '') AS DC_RMK_LINE
FROM CZ_MA_WORKFLOWH WH
LEFT JOIN (SELECT SH.CD_COMPANY, 
				  SH.NO_SO,
				  SH.TP_SO,
				  SH.CD_PARTNER,
				  SH.NO_IMO,
				  SH.DT_CONTRACT,
				  SL.AM_SO,
				  SL.AM_SO_CHARGE,
				  SL.AM_SO_ALL,
				  (ISNULL(PL.AM_PO, 0) + ISNULL(SL.AM_STOCK, 0)) AS AM_PO,
				  PL.AM_PO_CHARGE,
				  (ISNULL(SL.AM_SO, 0) - (ISNULL(PL.AM_PO, 0) + ISNULL(SL.AM_STOCK, 0))) AS PROFIT,
				  (ISNULL(SL.AM_SO_ALL, 0) - (ISNULL(PL.AM_PO_ALL, 0) + ISNULL(SL.AM_STOCK, 0))) AS PROFIT_ALL,
				  SH.YN_CLOSE,
				  SH.DC_RMK1,
				  SH.DC_RMK_CONTRACT,
				  (SELECT 1
				   FROM SA_SOL SL
				   LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO
				   LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE,
				   				  SUM(PL.AM) AS AM_PO 
				   		   FROM PU_POL PL
				   		   GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE) PL
				   ON PL.CD_COMPANY = SL.CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.NO_SOLINE = SL.SEQ_SO
				   WHERE SL.CD_COMPANY = SH.CD_COMPANY
				   AND SL.NO_SO = SH.NO_SO 
				   AND SL.CD_ITEM NOT LIKE 'SD%'
				   AND ISNULL(SL.AM_KR_S, 0) < ((ISNULL(SB.QT_STOCK, 0) * ISNULL(SB.UM_KR, 0)) + ISNULL(PL.AM_PO, 0))
				   GROUP BY SL.CD_COMPANY, SL.NO_SO) AS QT_MINUS
		   FROM SA_SOH SH
		   LEFT JOIN (SELECT SL.CD_COMPANY, SL.NO_SO, 
		   	  	             SUM(CASE WHEN SL.CD_ITEM NOT LIKE 'SD%' THEN SL.AM_KR_S ELSE 0 END) AS AM_SO,
		   	  	             SUM(CASE WHEN SL.CD_ITEM LIKE 'SD%' THEN SL.AM_KR_S ELSE 0 END) AS AM_SO_CHARGE,
		   	  	             SUM(SL.AM_KR_S) AS AM_SO_ALL,
		   				     SUM(ISNULL(SB.UM_KR, 0) * ISNULL(SB.QT_STOCK, 0)) AS AM_STOCK
		   	          FROM SA_SOL SL
		   	          LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
		   		      LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO
		   	          GROUP BY SL.CD_COMPANY, SL.NO_SO) SL
		   ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
		   LEFT JOIN (SELECT PL.CD_COMPANY, PL.CD_PJT,
		   		   	         SUM(CASE WHEN PL.CD_ITEM NOT LIKE 'SD%' THEN PL.AM ELSE 0 END) AS AM_PO,
		   		   	         SUM(CASE WHEN PL.CD_ITEM LIKE 'SD%' THEN PL.AM ELSE 0 END) AS AM_PO_CHARGE,
		   				     SUM(PL.AM) AS AM_PO_ALL
		   		      FROM PU_POL PL
		   		      LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = PL.CD_COMPANY AND QL.NO_FILE = PL.NO_SO AND QL.NO_LINE = PL.NO_SOLINE
		   		      GROUP BY PL.CD_COMPANY, PL.CD_PJT) PL
		   ON PL.CD_COMPANY = SH.CD_COMPANY AND PL.CD_PJT = SH.NO_SO) SH 
ON SH.CD_COMPANY = WH.CD_COMPANY AND SH.NO_SO = WH.NO_KEY
LEFT JOIN CZ_SA_CONTRACT_RPTH SC ON SC.CD_COMPANY = WH.CD_COMPANY AND SC.NO_SO = WH.NO_KEY
LEFT JOIN MA_USER MU ON MU.CD_COMPANY = WH.CD_COMPANY AND MU.ID_USER = WH.ID_SALES
LEFT JOIN MA_USER MU1 ON MU1.CD_COMPANY = WH.CD_COMPANY AND MU1.ID_USER = WH.ID_PUR
LEFT JOIN CZ_SA_USER SU ON SU.CD_COMPANY = WH.CD_COMPANY AND SU.ID_USER = WH.ID_PUR
LEFT JOIN MA_USER MU2 ON MU2.CD_COMPANY = SU.CD_COMPANY AND MU2.ID_USER = SU.ID_FIRST_APPROVAL
LEFT JOIN MA_USER MU3 ON MU3.CD_COMPANY = SU.CD_COMPANY AND MU3.ID_USER = SU.ID_SECOND_APPROVAL
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = SH.CD_COMPANY AND MP.CD_PARTNER = SH.CD_PARTNER
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = SH.NO_IMO
LEFT JOIN SA_TPSO TS ON TS.CD_COMPANY = SH.CD_COMPANY AND TS.TP_SO = SH.TP_SO
LEFT JOIN MM_EJTP EJ ON EJ.CD_COMPANY = TS.CD_COMPANY AND EJ.CD_QTIOTP = TS.TP_GI
WHERE WH.TP_STEP = '12'
AND (WH.YN_DONE IS NULL OR WH.YN_DONE = 'N' OR WH.YN_DONE = 'F')
AND (SH.YN_CLOSE IS NULL OR SH.YN_CLOSE = 'N')
AND (ISNULL(@P_CD_COMPANY, '') = '' OR WH.CD_COMPANY = @P_CD_COMPANY)
AND (ISNULL(@P_NO_KEY, '') = '' OR WH.NO_KEY = @P_NO_KEY)
AND (ISNULL(@P_CD_SALEGRP, '') = '' OR MU.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP)))
AND (ISNULL(@P_ID_USER, '') = '' OR ((WH.ID_PUR = @P_ID_USER) OR 
									 (ISNULL(WH.YN_DONE, 'N') = 'N' AND SU.ID_FIRST_APPROVAL = @P_ID_USER) OR 
									 (ISNULL(WH.YN_DONE, 'N') = 'F' AND SU.ID_SECOND_APPROVAL = @P_ID_USER)))
AND (ISNULL(@P_CD_SALEORG, '') = '' OR EXISTS (SELECT 1 
											   FROM MA_SALEGRP
											   WHERE CD_COMPANY = MU.CD_COMPANY
											   AND CD_SALEGRP = MU.CD_SALEGRP
											   AND CD_SALEORG = @P_CD_SALEORG))

GO

