USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_HR_PEVALU_S2]    Script Date: 2015-11-04 오후 3:34:19 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


/*******************************************
**  System		: 인사관리
**  Sub System	: 인사평가
**  Page		: 평가등록
**  Desc		: DETAIL 조회(NO목표등록)
**  
**  Return Values
**
**  작    성    자 	: 강연철
**  작    성    일	: 2015.05.28
**  수    정    자  : 
**  수  정  내  용  : 
*********************************************
** Change History
*********************************************
*********************************************/

ALTER PROCEDURE [NEOE].[SP_CZ_HR_PEVALU_S2]
(
	@P_CD_COMPANY   NVARCHAR(7),
	@P_CD_EVALU		NVARCHAR(8),
	@P_CD_EVTYPE	NVARCHAR(3),
	@P_CD_EVNUMBER	NVARCHAR(3),
	@P_CD_GROUP		NVARCHAR(3),
	@P_NO_EMPM		NVARCHAR(10),
	@P_NO_EMPAN		NVARCHAR(10),
	@P_YN_OBJECT	NVARCHAR(1)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @P_YN_OBJECT = 'N'
BEGIN
	SELECT HN.CD_EVALU,
		   HN.CD_EVTYPE,
		   HN.CD_GROUP,
		   HN.CD_EVNUMBER,
		   HN.NO_EMPM,
		   HN.NO_EMPAN,
		   LV1.CD_EVITEM AS CD_EVITEM_LV1,
		   LV1.NM_EVITEM AS NM_EVITEM_LV1,
		   LV2.CD_EVITEM AS CD_EVITEM_LV2,
		   LV2.NM_EVITEM AS NM_EVITEM_LV2,
		   LV3.CD_EVITEM AS CD_EVITEM_LV3,
		   LV3.NM_EVITEM AS NM_EVITEM_LV3,
		   (CASE WHEN LV3.CD_EVITEM IS NOT NULL THEN LV3.DC_INDEX
				 WHEN LV2.CD_EVITEM IS NOT NULL THEN LV2.DC_INDEX
											    ELSE LV1.DC_INDEX END) AS DC_INDEX,
		   (CASE WHEN LV3.CD_EVITEM IS NOT NULL THEN LV3.CD_SCALE
				 WHEN LV2.CD_EVITEM IS NOT NULL THEN LV2.CD_SCALE
											    ELSE LV1.CD_SCALE END) AS CD_SCALE,
		   (CASE WHEN LV3.CD_EVITEM IS NOT NULL THEN LV3.CD_EVITEM
				 WHEN LV2.CD_EVITEM IS NOT NULL THEN LV2.CD_EVITEM
											    ELSE LV1.CD_EVITEM END) AS CD_EVITEM,
		   (CASE WHEN LV3.CD_EVITEM IS NOT NULL THEN LV3.LB_EVITEM
				 WHEN LV2.CD_EVITEM IS NOT NULL THEN LV2.LB_EVITEM
											    ELSE LV1.LB_EVITEM END) AS LB_EVITEM,
		   (ISNULL(LV1.NUM_EWEIGHT, 1) * ISNULL(LV2.NUM_EWEIGHT, 1) * ISNULL(LV3.NUM_EWEIGHT, 1)) AS NUM_EWEIGHT,
		   PS.CD_GRADE,
		   PS.PT_SCORE,
		   PS.PT_HSCORE,
		   PS2.CD_GRADE_000,
		   PS2.PT_SCORE_000,
		   PS2.PT_HSCORE_000,
		   PS2.CD_GRADE_001,
		   PS2.PT_SCORE_001,
		   PS2.PT_HSCORE_001,
		   PS2.CD_GRADE_002,
		   PS2.PT_SCORE_002,
		   PS2.PT_HSCORE_002,
		   PS2.CD_GRADE_003,
		   PS2.PT_SCORE_003,
		   PS2.PT_HSCORE_003,
		   PS.DC_COMMENT1,
		   PS1.DC_COMMENT1 AS DC_COMMENT2
	FROM HR_PEVALU_HUMEMPAN HN
	LEFT JOIN HR_PEVALU_ITEM LV1 ON LV1.CD_COMPANY = HN.CD_COMPANY AND LV1.CD_EVALU = HN.CD_EVALU AND LV1.CD_EVTYPE = HN.CD_EVTYPE AND LV1.CD_GROUP = HN.CD_GROUP AND LV1.LB_EVITEM = '1'
	LEFT JOIN HR_PEVALU_ITEM LV2 ON LV2.CD_COMPANY = HN.CD_COMPANY AND LV2.CD_EVALU = HN.CD_EVALU AND LV2.CD_EVTYPE = HN.CD_EVTYPE AND LV2.CD_GROUP = HN.CD_GROUP AND LV2.LB_EVITEM = '2' AND LV2.H_EVITEM = LV1.CD_EVITEM
	LEFT JOIN HR_PEVALU_ITEM LV3 ON LV3.CD_COMPANY = HN.CD_COMPANY AND LV3.CD_EVALU = HN.CD_EVALU AND LV3.CD_EVTYPE = HN.CD_EVTYPE AND LV3.CD_GROUP = HN.CD_GROUP AND LV3.LB_EVITEM = '3' AND LV3.H_EVITEM = LV2.CD_EVITEM
	LEFT JOIN HR_PEVALU_SCORE PS ON PS.CD_COMPANY = HN.CD_COMPANY AND PS.CD_EVALU = HN.CD_EVALU AND PS.CD_EVTYPE = HN.CD_EVTYPE AND PS.CD_GROUP = HN.CD_GROUP AND PS.CD_EVNUMBER = HN.CD_EVNUMBER AND PS.NO_EMPM = HN.NO_EMPM AND PS.NO_EMPAN = HN.NO_EMPAN AND PS.CD_EVOTYPE = (CASE WHEN LV3.CD_EVITEM IS NOT NULL THEN LV3.CD_EVITEM
																																																																					  WHEN LV2.CD_EVITEM IS NOT NULL THEN LV2.CD_EVITEM
																																																																													 ELSE LV1.CD_EVITEM END)
	LEFT JOIN HR_PEVALU_CODE PC ON PC.CD_COMPANY = HN.CD_COMPANY AND PC.CD_EVALU = HN.CD_EVALU AND PC.CD_FIELD = '300' AND PC.YN_USE = 'Y' AND PC.CD_HCODE = HN.CD_EVNUMBER
	LEFT JOIN (SELECT CD_COMPANY, CD_EVALU, CD_EVTYPE, CD_GROUP, CD_EVNUMBER, NO_EMPAN, CD_EVOTYPE,
					  MAX(DC_COMMENT1) AS DC_COMMENT1
			   FROM HR_PEVALU_SCORE
			   GROUP BY CD_COMPANY, CD_EVALU, CD_EVTYPE, CD_GROUP, CD_EVNUMBER, NO_EMPAN, CD_EVOTYPE) PS1 
	ON PS1.CD_COMPANY = HN.CD_COMPANY AND PS1.CD_EVALU = HN.CD_EVALU AND PS1.CD_EVTYPE = HN.CD_EVTYPE AND PS1.CD_GROUP = HN.CD_GROUP AND PS1.CD_EVNUMBER = PC.CD_HCODE_BF AND PS1.NO_EMPAN = HN.NO_EMPAN AND PS1.CD_EVOTYPE = (CASE WHEN LV3.CD_EVITEM IS NOT NULL THEN LV3.CD_EVITEM
																																																								    WHEN LV2.CD_EVITEM IS NOT NULL THEN LV2.CD_EVITEM
																																																																   ELSE LV1.CD_EVITEM END)
	LEFT JOIN (SELECT CD_COMPANY, CD_EVALU, CD_EVTYPE, CD_GROUP, NO_EMPAN, CD_EVOTYPE,
					  MAX(CASE WHEN CD_EVNUMBER = '000' THEN CD_GRADE ELSE NULL END) AS CD_GRADE_000,
					  MAX(CASE WHEN CD_EVNUMBER = '000' THEN PT_SCORE ELSE NULL END) AS PT_SCORE_000,
					  MAX(CASE WHEN CD_EVNUMBER = '000' THEN PT_HSCORE ELSE NULL END) AS PT_HSCORE_000,
					  MAX(CASE WHEN CD_EVNUMBER = '001' THEN CD_GRADE ELSE NULL END) AS CD_GRADE_001,
					  MAX(CASE WHEN CD_EVNUMBER = '001' THEN PT_SCORE ELSE NULL END) AS PT_SCORE_001,
					  MAX(CASE WHEN CD_EVNUMBER = '001' THEN PT_HSCORE ELSE NULL END) AS PT_HSCORE_001,
					  MAX(CASE WHEN CD_EVNUMBER = '002' THEN CD_GRADE ELSE NULL END) AS CD_GRADE_002,
					  MAX(CASE WHEN CD_EVNUMBER = '002' THEN PT_SCORE ELSE NULL END) AS PT_SCORE_002,
					  MAX(CASE WHEN CD_EVNUMBER = '002' THEN PT_HSCORE ELSE NULL END) AS PT_HSCORE_002,
					  MAX(CASE WHEN CD_EVNUMBER = '003' THEN CD_GRADE ELSE NULL END) AS CD_GRADE_003,
					  MAX(CASE WHEN CD_EVNUMBER = '003' THEN PT_SCORE ELSE NULL END) AS PT_SCORE_003,
					  MAX(CASE WHEN CD_EVNUMBER = '003' THEN PT_HSCORE ELSE NULL END) AS PT_HSCORE_003
			   FROM HR_PEVALU_SCORE
			   WHERE CD_EVNUMBER < @P_CD_EVNUMBER
			   GROUP BY CD_COMPANY, CD_EVALU, CD_EVTYPE, CD_GROUP, NO_EMPAN, CD_EVOTYPE) PS2
	ON PS2.CD_COMPANY = HN.CD_COMPANY AND PS2.CD_EVALU = HN.CD_EVALU AND PS2.CD_EVTYPE = HN.CD_EVTYPE AND PS2.CD_GROUP = HN.CD_GROUP AND PS2.NO_EMPAN = HN.NO_EMPAN AND PS2.CD_EVOTYPE = (CASE WHEN LV3.CD_EVITEM IS NOT NULL THEN LV3.CD_EVITEM
																																															   WHEN LV2.CD_EVITEM IS NOT NULL THEN LV2.CD_EVITEM
																																																							  ELSE LV1.CD_EVITEM END)
	WHERE HN.CD_COMPANY <> 'TEST' 
	AND HN.CD_EVALU = @P_CD_EVALU
	AND HN.CD_EVTYPE = @P_CD_EVTYPE
	AND HN.CD_GROUP = @P_CD_GROUP
	AND HN.CD_EVNUMBER = @P_CD_EVNUMBER
	AND HN.NO_EMPM = @P_NO_EMPM
	AND HN.NO_EMPAN = @P_NO_EMPAN	
END
ELSE
BEGIN
	SELECT HN.CD_EVALU,
		   HN.CD_EVTYPE,
		   HN.CD_GROUP,
		   HN.CD_EVNUMBER,
		   HN.NO_EMPM,
		   HN.NO_EMPAN,
		   PO.CD_OTASK,
		   PO.NM_OTASK,
		   PO.DC_DOBJECT,
		   PO.CD_SCALE,
		   PO.CD_EVOTYPE AS CD_EVITEM,
		   '0' AS LB_EVITEM,
		   PO.RT_WEIGHT AS NUM_EWEIGHT,
		   PS.CD_GRADE,
		   PS.PT_SCORE,
		   PS.PT_HSCORE,
		   PS2.CD_GRADE_000,
		   PS2.PT_SCORE_000,
		   PS2.PT_HSCORE_000,
		   PS2.CD_GRADE_001,
		   PS2.PT_SCORE_001,
		   PS2.PT_HSCORE_001,
		   PS2.CD_GRADE_002,
		   PS2.PT_SCORE_002,
		   PS2.PT_HSCORE_002,
		   PS2.CD_GRADE_003,
		   PS2.PT_SCORE_003,
		   PS2.PT_HSCORE_003,
		   PS.DC_COMMENT1,
		   PS1.DC_COMMENT1 AS DC_COMMENT2
	FROM HR_PEVALU_HUMEMPAN HN
	LEFT JOIN HR_PEVALU_OBJECT PO ON PO.CD_COMPANY = HN.CD_COMPANY AND PO.CD_EVALU = HN.CD_EVALU AND PO.CD_EVTYPE = HN.CD_EVTYPE AND PO.NO_EMP = HN.NO_EMPAN
	LEFT JOIN HR_PEVALU_SCORE PS ON PS.CD_COMPANY = HN.CD_COMPANY AND PS.CD_EVALU = HN.CD_EVALU AND PS.CD_EVTYPE = HN.CD_EVTYPE AND PS.CD_GROUP = HN.CD_GROUP AND PS.CD_EVNUMBER = HN.CD_EVNUMBER AND PS.NO_EMPM = HN.NO_EMPM AND PS.NO_EMPAN = HN.NO_EMPAN AND PS.CD_EVOTYPE = PO.CD_EVOTYPE
	LEFT JOIN HR_PEVALU_CODE PC ON PC.CD_COMPANY = HN.CD_COMPANY AND PC.CD_EVALU = HN.CD_EVALU AND PC.CD_FIELD = '300' AND PC.YN_USE = 'Y' AND PC.CD_HCODE = HN.CD_EVNUMBER
	LEFT JOIN (SELECT CD_COMPANY, CD_EVALU, CD_EVTYPE, CD_GROUP, CD_EVNUMBER, NO_EMPAN, CD_EVOTYPE,
					  MAX(DC_COMMENT1) AS DC_COMMENT1
			   FROM HR_PEVALU_SCORE
			   GROUP BY CD_COMPANY, CD_EVALU, CD_EVTYPE, CD_GROUP, CD_EVNUMBER, NO_EMPAN, CD_EVOTYPE) PS1 
	ON PS1.CD_COMPANY = HN.CD_COMPANY AND PS1.CD_EVALU = HN.CD_EVALU AND PS1.CD_EVTYPE = HN.CD_EVTYPE AND PS1.CD_GROUP = HN.CD_GROUP AND PS1.CD_EVNUMBER = PC.CD_HCODE_BF AND PS1.NO_EMPAN = HN.NO_EMPAN AND PS1.CD_EVOTYPE = PO.CD_EVOTYPE
	LEFT JOIN (SELECT CD_COMPANY, CD_EVALU, CD_EVTYPE, CD_GROUP, NO_EMPAN, CD_EVOTYPE,
					  MAX(CASE WHEN CD_EVNUMBER = '000' THEN CD_GRADE ELSE NULL END) AS CD_GRADE_000,
					  MAX(CASE WHEN CD_EVNUMBER = '000' THEN PT_SCORE ELSE NULL END) AS PT_SCORE_000,
					  MAX(CASE WHEN CD_EVNUMBER = '000' THEN PT_HSCORE ELSE NULL END) AS PT_HSCORE_000,
					  MAX(CASE WHEN CD_EVNUMBER = '001' THEN CD_GRADE ELSE NULL END) AS CD_GRADE_001,
					  MAX(CASE WHEN CD_EVNUMBER = '001' THEN PT_SCORE ELSE NULL END) AS PT_SCORE_001,
					  MAX(CASE WHEN CD_EVNUMBER = '001' THEN PT_HSCORE ELSE NULL END) AS PT_HSCORE_001,
					  MAX(CASE WHEN CD_EVNUMBER = '002' THEN CD_GRADE ELSE NULL END) AS CD_GRADE_002,
					  MAX(CASE WHEN CD_EVNUMBER = '002' THEN PT_SCORE ELSE NULL END) AS PT_SCORE_002,
					  MAX(CASE WHEN CD_EVNUMBER = '002' THEN PT_HSCORE ELSE NULL END) AS PT_HSCORE_002,
					  MAX(CASE WHEN CD_EVNUMBER = '003' THEN CD_GRADE ELSE NULL END) AS CD_GRADE_003,
					  MAX(CASE WHEN CD_EVNUMBER = '003' THEN PT_SCORE ELSE NULL END) AS PT_SCORE_003,
					  MAX(CASE WHEN CD_EVNUMBER = '003' THEN PT_HSCORE ELSE NULL END) AS PT_HSCORE_003
			   FROM HR_PEVALU_SCORE
			   WHERE CD_EVNUMBER < @P_CD_EVNUMBER
			   GROUP BY CD_COMPANY, CD_EVALU, CD_EVTYPE, CD_GROUP, NO_EMPAN, CD_EVOTYPE) PS2
	ON PS2.CD_COMPANY = HN.CD_COMPANY AND PS2.CD_EVALU = HN.CD_EVALU AND PS2.CD_EVTYPE = HN.CD_EVTYPE AND PS2.CD_GROUP = HN.CD_GROUP AND PS2.NO_EMPAN = HN.NO_EMPAN AND PS2.CD_EVOTYPE = PO.CD_EVOTYPE
	WHERE HN.CD_COMPANY <> 'TEST' 
	AND HN.CD_EVALU = @P_CD_EVALU
	AND HN.CD_EVTYPE = @P_CD_EVTYPE
	AND HN.CD_GROUP = @P_CD_GROUP
	AND HN.CD_EVNUMBER = @P_CD_EVNUMBER
	AND HN.NO_EMPM = @P_NO_EMPM
	AND HN.NO_EMPAN = @P_NO_EMPAN	
	ORDER BY CONVERT(NUMERIC, PO.CD_EVOTYPE)
END

GO