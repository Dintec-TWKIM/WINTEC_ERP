USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_PARTNER_PRICEL_S]    Script Date: 2016-08-09 오후 1:31:21 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_MA_PARTNER_PRICEL_S]
(
	@P_CD_COMPANY			NVARCHAR(7),
	@P_TP_PS				NVARCHAR(3),
	@P_CD_PARTNER			NVARCHAR(20),
	@P_CD_PLANT				NVARCHAR(20),
	@P_TP_SEARCH1		    NVARCHAR(3),
	@P_TP_SEARCH2		    NVARCHAR(3),
	@P_DC_SEARCH1		    NVARCHAR(100),
	@P_DC_SEARCH2		    NVARCHAR(100),
	@P_CD_CLS_S				NVARCHAR(4),
	@P_CD_ITEMGRP			NVARCHAR(20),
	@P_YN_VALID				NVARCHAR(1),
	@P_TP_PROC				NVARCHAR(3)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 'N' AS S,
	   UP.CD_COMPANY,
	   UP.CD_PLANT,
	   UP.CD_PARTNER,
	   UP.TP_UMMODULE,
	   UP.NO_LINE,
	   UP.CD_ITEM,
	   MI.NM_ITEM,
	   MI.CLS_ITEM,
	   MC1.NM_SYSDEF AS NM_CLS_ITEM,
	   MI.CLS_L,
	   MI.CLS_M,
	   MI.CLS_S,
	   MI.STND_DETAIL_ITEM,
	   MI.STND_ITEM,
	   MI.MAT_ITEM,
	   MI.DC_RMK1,
	   MI.DC_RMK2,
	   UP.CD_EXCH,
	   MC.NM_SYSDEF AS NM_EXCH,
	   UP.FG_UM,
	   UP.UM_ITEM,
	   (CASE WHEN CD_EXCH = '000' THEN ROUND(MI.STAND_PRC, 0) ELSE MI.STAND_PRC END) AS STAND_PRC, 
	   (CASE WHEN ISNULL(UP.UM_ITEM, 0) = 0 THEN 0
										    ELSE ROUND(((ROUND(ISNULL(UP.UM_ITEM, 0) * ISNULL(EX.RT_EXCH, 1), 2) - ISNULL(MI.STAND_PRC, 0)) / ROUND(ISNULL(UP.UM_ITEM, 0) * ISNULL(EX.RT_EXCH, 1), 2)) * 100, 2) END) AS RT_UM,
	   UP.DC_PRICE_TERMS,
	   UP.LT,
	   UP.SDT_UM,
	   UP.EDT_UM,
	   UP.CD_EXCH_S,
	   UP.UM_ITEM_S,
	   UP.RT_PROFIT_A,
	   UP.RT_PROFIT_B,
	   UP.RT_PROFIT_C,
	   UP.DC_RMK,
	   UP.TXT_USERDEF1,
	   ISNULL(SQ.QT_AVST, 0) AS QT_AVST,
	   ISNULL(SQ.QT_AVPO, 0) AS QT_AVPO,
	   UP.CD_PARTNER_STD,
	   MP.LN_PARTNER AS LN_PARTNER_STD,
	   UP.ID_INSERT,
	   MU.NM_USER AS NM_INSERT,
	   UP.DTS_INSERT,
	   UP.ID_UPDATE,
	   MU1.NM_USER AS NM_UPDATE,
	   UP.DTS_UPDATE
FROM MA_ITEM_UMPARTNER UP
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = UP.CD_COMPANY AND MI.CD_PLANT = UP.CD_PLANT AND MI.CD_ITEM = UP.CD_ITEM
LEFT JOIN CZ_DX_STOCK_QT SQ ON SQ.CD_COMPANY = UP.CD_COMPANY AND SQ.CD_ITEM = UP.CD_ITEM
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = UP.CD_COMPANY AND MC.CD_FIELD = 'MA_B000005' AND MC.CD_SYSDEF = UP.CD_EXCH
LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = MI.CD_COMPANY AND MC1.CD_FIELD = 'MA_B000010' AND MC1.CD_SYSDEF = MI.CLS_ITEM
LEFT JOIN MA_USER MU ON MU.CD_COMPANY = UP.CD_COMPANY AND MU.ID_USER = UP.ID_INSERT
LEFT JOIN MA_USER MU1 ON MU1.CD_COMPANY = UP.CD_COMPANY AND MU1.ID_USER = UP.ID_UPDATE
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = UP.CD_COMPANY AND MP.CD_PARTNER = UP.CD_PARTNER_STD
LEFT JOIN (SELECT EX.CD_COMPANY, EX.CURR_SOUR,
		      	  (CASE WHEN CURR_SOUR = '002' THEN RATE_BASE 
		   								       ELSE ROUND(RATE_BASE, 2) END) AS RT_EXCH
		   FROM MA_EXCHANGE EX
		   WHERE EX.NO_SEQ = '1'
		   AND EX.CURR_DEST = '000'
		   AND EX.YYMMDD = CONVERT(CHAR(8), GETDATE(), 112)) EX
ON EX.CD_COMPANY = UP.CD_COMPANY AND EX.CURR_SOUR = UP.CD_EXCH
WHERE UP.CD_COMPANY = @P_CD_COMPANY
AND UP.TP_UMMODULE = @P_TP_PS
AND UP.CD_PARTNER = @P_CD_PARTNER
AND UP.CD_PLANT = @P_CD_PLANT
AND (ISNULL(@P_YN_VALID, 'N') <> 'Y' OR CONVERT(NVARCHAR(8), GETDATE(), 112) BETWEEN UP.SDT_UM AND UP.EDT_UM)
AND (ISNULL(@P_CD_CLS_S, '') = '' OR MI.CLS_S = @P_CD_CLS_S)
AND (ISNULL(@P_CD_ITEMGRP, '') = '' OR MI.GRP_ITEM = @P_CD_ITEMGRP)
AND (ISNULL(@P_TP_PROC, '') = '' OR MI.TP_PROC = @P_TP_PROC)
AND (ISNULL(@P_DC_SEARCH1, '') = '' OR 
	 (@P_TP_SEARCH1 = '000' AND MI.CD_ITEM LIKE @P_DC_SEARCH1 + '%') OR
	 (@P_TP_SEARCH1 = '001' AND MI.NM_ITEM LIKE '%' + @P_DC_SEARCH1 + '%') OR
	 (@P_TP_SEARCH1 = '002' AND MI.STND_DETAIL_ITEM LIKE @P_DC_SEARCH1 + '%') OR
	 (@P_TP_SEARCH1 = '003' AND MI.STND_ITEM LIKE @P_DC_SEARCH1 + '%') OR
	 (@P_TP_SEARCH1 = '004' AND MI.MAT_ITEM LIKE '%' + @P_DC_SEARCH1 + '%') OR
	 (@P_TP_SEARCH1 = '005' AND MI.DC_RMK1 LIKE '%' + @P_DC_SEARCH1 + '%') OR
	 (@P_TP_SEARCH1 = '006' AND MI.DC_RMK2 LIKE '%' + @P_DC_SEARCH1 + '%'))
AND (ISNULL(@P_DC_SEARCH2, '') = '' OR 
	 (@P_TP_SEARCH2 = '000' AND MI.CD_ITEM LIKE @P_DC_SEARCH2 + '%') OR
     (@P_TP_SEARCH2 = '001' AND MI.NM_ITEM LIKE '%' + @P_DC_SEARCH2 + '%') OR
	 (@P_TP_SEARCH2 = '002' AND MI.STND_DETAIL_ITEM LIKE @P_DC_SEARCH2 + '%') OR
	 (@P_TP_SEARCH2 = '003' AND MI.STND_ITEM LIKE @P_DC_SEARCH2 + '%') OR
	 (@P_TP_SEARCH2 = '004' AND MI.MAT_ITEM LIKE '%' + @P_DC_SEARCH2 + '%') OR
	 (@P_TP_SEARCH2 = '005' AND MI.DC_RMK1 LIKE '%' + @P_DC_SEARCH2 + '%') OR
	 (@P_TP_SEARCH2 = '006' AND MI.DC_RMK2 LIKE '%' + @P_DC_SEARCH2 + '%'))
ORDER BY CD_COMPANY, CD_PLANT, CD_PARTNER, NO_LINE

GO

