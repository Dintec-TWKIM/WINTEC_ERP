USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_EXPENSE_MNG_S]    Script Date: 2016-04-06 오후 6:45:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_EXPENSE_MNG_S] 
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_DT_FROM			NVARCHAR(8),
	@P_DT_TO			NVARCHAR(8),
	@P_TP_IO			NVARCHAR(3),
	@P_CD_ITEM			NVARCHAR(20),
	@P_CD_PARTNER		NVARCHAR(20),
	@P_CD_PJT			NVARCHAR(20),
	@P_NO_EMP			NVARCHAR(10),
	@P_YN_10000			NVARCHAR(1)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @P_TP_IO = '001'
BEGIN
	SELECT IL.NO_IV,
		   IL.NO_LINE,
		   IH.DT_PROCESS,
		   IL.CD_PJT,
		   IH.CD_PARTNER,
		   MP.LN_PARTNER,
		   SH.NO_EMP,
		   ME.NM_KOR,
		   IL.CD_ITEM,
		   MI.NM_ITEM,
		   (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) AS AM_CLS,
		   (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_EX_CLS ELSE IL.AM_EX_CLS END) AS AM_EX_CLS,
		   IL.TXT_USERDEF1,
		   IH.ID_INSERT,
		   MU.NM_USER AS NM_INSERT,
		   IH.DTS_INSERT 
	FROM PU_IVL IL
	LEFT JOIN PU_IVH IH ON IH.CD_COMPANY = IL.CD_COMPANY AND IH.NO_IV = IL.NO_IV
	LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
	LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = IH.CD_COMPANY AND MP.CD_PARTNER = IH.CD_PARTNER
    LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = IL.CD_COMPANY AND SH.NO_SO = IL.CD_PJT
	LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SH.CD_COMPANY AND ME.NO_EMP = SH.NO_EMP
	LEFT JOIN MA_USER MU ON MU.CD_COMPANY = IH.CD_COMPANY AND MU.ID_USER = IH.ID_INSERT
	WHERE IL.CD_COMPANY = @P_CD_COMPANY
	AND IH.DT_PROCESS BETWEEN @P_DT_FROM AND @P_DT_TO
	AND ((ISNULL(@P_CD_ITEM, '') = '' AND IL.CD_ITEM LIKE 'SD%') OR IL.CD_ITEM = @P_CD_ITEM)
	AND (ISNULL(@P_CD_PARTNER, '') = '' OR IH.CD_PARTNER = @P_CD_PARTNER)
	AND (ISNULL(@P_CD_PJT, '') = '' OR IL.CD_PJT = @P_CD_PJT)
	AND (ISNULL(@P_NO_EMP, '') = '' OR SH.NO_EMP = @P_NO_EMP)
	AND (@P_YN_10000 = 'N' OR (@P_YN_10000 = 'Y' AND ABS(IL.AM_CLS) > 10000))
END
ELSE
BEGIN
	SELECT IL.NO_IV,
		   IL.NO_LINE,
		   IH.DT_PROCESS,
		   IL.CD_PJT,
		   IH.CD_PARTNER,
		   MP.LN_PARTNER,
		   SH.NO_EMP,
		   ME.NM_KOR,
		   IL.CD_ITEM,
		   MI.NM_ITEM,
		   IL.AM_CLS,
		   IL.AM_EX_CLS,
		   IL.TXT_USERDEF1,
		   IH.ID_INSERT,
		   MU.NM_USER AS NM_INSERT,
		   IH.DTS_INSERT  
	FROM SA_IVL IL
	LEFT JOIN SA_IVH IH ON IH.CD_COMPANY = IL.CD_COMPANY AND IH.NO_IV = IL.NO_IV
	LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
	LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = IH.CD_COMPANY AND MP.CD_PARTNER = IH.CD_PARTNER
	LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = IL.CD_COMPANY AND SH.NO_SO = IL.CD_PJT
	LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SH.CD_COMPANY AND ME.NO_EMP = SH.NO_EMP
	LEFT JOIN MA_USER MU ON MU.CD_COMPANY = IH.CD_COMPANY AND MU.ID_USER = IH.ID_INSERT
	WHERE IL.CD_COMPANY = @P_CD_COMPANY
	AND IH.DT_PROCESS BETWEEN @P_DT_FROM AND @P_DT_TO
	AND ((ISNULL(@P_CD_ITEM, '') = '' AND IL.CD_ITEM LIKE 'SD%') OR IL.CD_ITEM = @P_CD_ITEM)
	AND (ISNULL(@P_CD_PARTNER, '') = '' OR IH.CD_PARTNER = @P_CD_PARTNER)
	AND (ISNULL(@P_CD_PJT, '') = '' OR IL.CD_PJT = @P_CD_PJT)
	AND (ISNULL(@P_NO_EMP, '') = '' OR SH.NO_EMP = @P_NO_EMP)
	AND (@P_YN_10000 = 'N' OR (@P_YN_10000 = 'Y' AND ABS(IL.AM_CLS) > 10000))
END

GO