USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_HR_PEVALU_RESULT_RPT_S]    Script Date: 2015-11-18 오전 10:27:47 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [NEOE].[SP_CZ_HR_PEVALU_RESULT_RPT_S]
(
	@P_CD_EVALU		NVARCHAR(8),
	@P_CD_BIZAREA   NVARCHAR(4000),
	@P_CD_DEPT      NVARCHAR(4000),
	@P_NO_EMPAN     NVARCHAR(4000)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT PN.NO_EMPAN,
	   ME.NM_KOR,
	   MD.NM_DEPT,
	   MAX(CASE WHEN PN.CD_EVTYPE = '100' THEN PN.CD_EVNUMBER ELSE NULL END) AS CD_EVTYPE_100,
	   MAX(CASE WHEN PN.CD_EVTYPE = '300' THEN PN.CD_EVNUMBER ELSE NULL END) AS CD_EVTYPE_300,
	   MAX(CASE WHEN PS.CD_EVTYPE = '100' AND PS.CD_EVNUMBER = '000' THEN PS.PT_HSCORE ELSE 0 END) AS SCORE_100_000,
	   MAX(CASE WHEN PS.CD_EVTYPE = '100' AND PS.CD_EVNUMBER = '001' THEN PS.PT_HSCORE ELSE 0 END) AS SCORE_100_001,
	   MAX(CASE WHEN PS.CD_EVTYPE = '100' AND PS.CD_EVNUMBER = '002' THEN PS.PT_HSCORE ELSE 0 END) AS SCORE_100_002,
	   MAX(CASE WHEN PS.CD_EVTYPE = '100' AND PS.CD_EVNUMBER = '003' THEN PS.PT_HSCORE ELSE 0 END) AS SCORE_100_003,
	   0.00 AS SCORE_100_TOTAL,
	   MAX(CASE WHEN PS.CD_EVTYPE = '300' AND PS.CD_EVNUMBER = '000' THEN PS.PT_SCORE ELSE 0 END) AS SCORE_300_000,
	   MAX(CASE WHEN PS.CD_EVTYPE = '300' AND PS.CD_EVNUMBER = '001' THEN PS.PT_SCORE ELSE 0 END) AS SCORE_300_001,
	   MAX(CASE WHEN PS.CD_EVTYPE = '300' AND PS.CD_EVNUMBER = '002' THEN PS.PT_SCORE ELSE 0 END) AS SCORE_300_002,
	   MAX(CASE WHEN PS.CD_EVTYPE = '300' AND PS.CD_EVNUMBER = '003' THEN PS.PT_SCORE ELSE 0 END) AS SCORE_300_003,
	   0.00 AS SCORE_300_TOTAL,
	   MAX(CASE WHEN PC.CD_EVTYPE = '100' AND PC.CD_EVNUMBER = '000' THEN PC.DC_COMMENTS ELSE NULL END) AS DC_COMMENT_000,
	   MAX(CASE WHEN PC.CD_EVTYPE = '100' AND PC.CD_EVNUMBER = '001' THEN PC.DC_COMMENTS ELSE NULL END) AS DC_COMMENT_001,
	   MAX(CASE WHEN PC.CD_EVTYPE = '100' AND PC.CD_EVNUMBER = '002' THEN PC.DC_COMMENTS ELSE NULL END) AS DC_COMMENT_002,
	   MAX(CASE WHEN PC.CD_EVTYPE = '100' AND PC.CD_EVNUMBER = '003' THEN PC.DC_COMMENTS ELSE NULL END) AS DC_COMMENT_003
FROM HR_PEVALU_HUMEMPAN PN
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = PN.CD_BIZAREA AND ME.NO_EMP = PN.NO_EMPAN
LEFT JOIN MA_DEPT MD ON MD.CD_COMPANY = ME.CD_COMPANY AND MD.CD_DEPT = ME.CD_DEPT
LEFT JOIN (SELECT CD_EVALU, CD_EVTYPE, CD_GROUP, CD_EVNUMBER, NO_EMPM, NO_EMPAN,
				  SUM(ISNULL(PT_HSCORE, 0) * ISNULL(RT_WEIGHT, 0)) AS PT_HSCORE,
				  SUM(ISNULL(PT_SCORE, 0) * ISNULL(RT_WEIGHT, 0)) AS PT_SCORE
		   FROM HR_PEVALU_SCORE
		   WHERE CD_COMPANY <> 'TEST'
		   GROUP BY CD_EVALU, CD_EVTYPE, CD_GROUP, CD_EVNUMBER, NO_EMPM, NO_EMPAN) PS 
ON PS.CD_EVALU = PN.CD_EVALU AND PS.CD_EVTYPE = PN.CD_EVTYPE AND PS.CD_GROUP = PN.CD_GROUP AND PS.CD_EVNUMBER = PN.CD_EVNUMBER AND PS.NO_EMPM = PN.NO_EMPM AND PS.NO_EMPAN = PN.NO_EMPAN
LEFT JOIN HR_PEVALU_CMTS PC ON PC.CD_EVALU = PN.CD_EVALU AND PC.CD_EVTYPE = PN.CD_EVTYPE AND PC.CD_EVNUMBER = PN.CD_EVNUMBER AND PC.NO_EMPM = PN.NO_EMPM AND PC.NO_EMPAN = PN.NO_EMPAN
WHERE PN.CD_COMPANY <> 'TEST' 
AND PN.CD_GROUP = '600'
AND PN.CD_EVALU = @P_CD_EVALU
AND (ISNULL(@P_CD_BIZAREA, '') = '' OR ME.CD_BIZAREA IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_BIZAREA)))
AND (ISNULL(@P_CD_DEPT, '') = '' OR ME.CD_DEPT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_DEPT)))
AND (ISNULL(@P_NO_EMPAN, '') = '' OR ME.NO_EMP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_NO_EMPAN)))
GROUP BY PN.NO_EMPAN, ME.NM_KOR, MD.NM_DEPT

GO