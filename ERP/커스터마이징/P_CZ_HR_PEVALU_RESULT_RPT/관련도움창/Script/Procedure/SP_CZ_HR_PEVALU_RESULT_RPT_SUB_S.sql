USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_HR_PEVALU_RESULT_RPT_SUB_S]    Script Date: 2015-11-19 오전 10:57:03 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_HR_PEVALU_RESULT_RPT_SUB_S]
(
	@P_CD_COMPANY	NVARCHAR(7),
	@P_CD_EVALU		NVARCHAR(8),
	@P_CD_EVTYPE	NVARCHAR(3),
	@P_CD_EVNUMBER	NVARCHAR(3),
	@P_CD_GROUP		NVARCHAR(3),
	@P_NO_EMPAN		NVARCHAR(10)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT ME.NM_KOR AS NM_EMPM,
	   ME1.NM_KOR AS NM_EMPAN,
	   PO.NM_OTASK,
	   PO.DC_DOBJECT,
	   HI.NM_EVITEM1,
	   HI.NM_EVITEM2,
	   HI.NM_EVITEM3,
	   HI.DC_INDEX,
	   PS.RT_WEIGHT,
	   PS.PT_SCORE,
	   PS.PT_HSCORE,
	   PS.CD_GRADE,
	   HM.CD_BIZAREA,
	   HM.NO_EMPM,
	   HN.CD_BIZAREA,
	   HN.NO_EMPAN
FROM HR_PEVALU_SCORE PS
LEFT JOIN HR_PEVALU_HUMEMPM HM ON HM.CD_COMPANY = PS.CD_COMPANY AND HM.CD_EVALU = PS.CD_EVALU AND HM.CD_EVTYPE = PS.CD_EVTYPE AND HM.CD_EVNUMBER = PS.CD_EVNUMBER AND HM.CD_GROUP = PS.CD_GROUP AND HM.NO_EMPM = PS.NO_EMPM
LEFT JOIN HR_PEVALU_HUMEMPAN HN ON HN.CD_COMPANY = PS.CD_COMPANY AND HN.CD_EVALU = PS.CD_EVALU AND HN.CD_EVTYPE = PS.CD_EVTYPE AND HN.CD_EVNUMBER = PS.CD_EVNUMBER AND HN.CD_GROUP = PS.CD_GROUP AND HN.NO_EMPM = PS.NO_EMPM AND HN.NO_EMPAN = PS.NO_EMPAN
LEFT JOIN HR_PEVALU_OBJECT PO ON PO.CD_EVALU = PS.CD_EVALU AND PO.CD_EVTYPE = PS.CD_EVTYPE AND PO.CD_EVOTYPE = PS.CD_EVOTYPE AND PO.NO_EMP = PS.NO_EMPAN
LEFT JOIN (SELECT P1.CD_COMPANY,
		   	      P1.CD_EVALU,
		   	      P1.CD_EVTYPE,
		   	      P1.CD_GROUP,
		   	      (CASE WHEN P3.CD_EVITEM IS NOT NULL THEN 3 ELSE CASE WHEN P2.CD_EVITEM IS NOT NULL THEN 2 ELSE 1 END END) AS LB_EVITEM,
				  (CASE WHEN P3.CD_EVITEM IS NOT NULL THEN P3.CD_EVITEM ELSE CASE WHEN P2.CD_EVITEM IS NOT NULL THEN P2.CD_EVITEM ELSE P1.CD_EVITEM END END) AS CD_EVITEM,
		   	      (ISNULL(P3.NUM_EWEIGHT, 1) * ISNULL(P2.NUM_EWEIGHT, 1) * ISNULL(P1.NUM_EWEIGHT, 1)) AS RT_WEIGHT,
		   	      P1.NM_EVITEM AS NM_EVITEM1,
		   	      P2.NM_EVITEM AS NM_EVITEM2,
		   	      P3.NM_EVITEM AS NM_EVITEM3,
				  (CASE WHEN P3.CD_EVITEM IS NOT NULL THEN P3.DC_INDEX ELSE CASE WHEN P2.CD_EVITEM IS NOT NULL THEN P2.DC_INDEX ELSE P1.DC_INDEX END END) AS DC_INDEX
		   FROM HR_PEVALU_ITEM P1
		   LEFT JOIN HR_PEVALU_ITEM P2 ON P2.CD_COMPANY = P1.CD_COMPANY AND P2.CD_EVALU = P1.CD_EVALU AND P2.CD_EVTYPE = P1.CD_EVTYPE AND P2.CD_GROUP = P1.CD_GROUP AND P2.LB_EVITEM = 2 AND P2.H_EVITEM = P1.CD_EVITEM
		   LEFT JOIN HR_PEVALU_ITEM P3 ON P3.CD_COMPANY = P2.CD_COMPANY AND P3.CD_EVALU = P2.CD_EVALU AND P3.CD_EVTYPE = P2.CD_EVTYPE AND P3.CD_GROUP = P2.CD_GROUP AND P3.LB_EVITEM = 3 AND P3.H_EVITEM = P2.CD_EVITEM
		   WHERE P1.LB_EVITEM = 1
		   GROUP BY P1.CD_COMPANY, P1.CD_EVALU, P1.CD_EVTYPE, P1.CD_GROUP, P1.CD_EVITEM, P1.NM_EVITEM, P1.NUM_EWEIGHT, P1.DC_INDEX, P2.CD_EVITEM, P2.NM_EVITEM, P2.NUM_EWEIGHT, P2.DC_INDEX, P3.CD_EVITEM, P3.NM_EVITEM, P3.NUM_EWEIGHT, P3.DC_INDEX) HI
ON HI.CD_COMPANY = PS.CD_COMPANY AND HI.CD_EVALU = PS.CD_EVALU AND HI.CD_EVTYPE = PS.CD_EVTYPE AND HI.CD_GROUP = PS.CD_GROUP AND HI.LB_EVITEM = PS.LB_EVITEM AND HI.CD_EVITEM = PS.CD_EVOTYPE
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = HM.CD_BIZAREA AND ME.NO_EMP = HM.NO_EMPM
LEFT JOIN MA_EMP ME1 ON ME1.CD_COMPANY = HN.CD_BIZAREA AND ME1.NO_EMP = HN.NO_EMPAN
WHERE PS.CD_COMPANY <> 'TEST'
AND PS.CD_EVALU = @P_CD_EVALU
AND PS.CD_EVTYPE = @P_CD_EVTYPE
AND PS.CD_EVNUMBER = @P_CD_EVNUMBER
AND PS.CD_GROUP = @P_CD_GROUP
AND PS.NO_EMPAN = @P_NO_EMPAN

GO