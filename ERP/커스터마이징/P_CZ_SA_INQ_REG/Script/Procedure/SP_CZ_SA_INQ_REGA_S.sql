USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_INQ_REGA_S]    Script Date: 2015-07-03 오전 11:04:05 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_INQ_REGA_S]
(
	@P_CD_COMPANY       NVARCHAR(7),
	@P_ID_USER			NVARCHAR(15)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @ID_TYPIST TABLE (ID_USER NVARCHAR(20) PRIMARY KEY)
DECLARE @ID_TYPIST_AUTO TABLE (ID_USER NVARCHAR(20) PRIMARY KEY)
DECLARE @ID_TYPIST_MAPS TABLE (ID_USER NVARCHAR(20) PRIMARY KEY)

DECLARE @V_ID_TYPIST	   NVARCHAR(100)
DECLARE @V_ID_TYPIST_AUTO  NVARCHAR(100)
DECLARE @V_ID_TYPIST_MAPS  NVARCHAR(100)

SELECT @V_ID_TYPIST = SU.ID_TYPIST,
	   @V_ID_TYPIST_AUTO = SU.ID_TYPIST_AUTO,
	   @V_ID_TYPIST_MAPS = SU.ID_TYPIST_MAPS
FROM CZ_SA_USER SU 
WHERE SU.CD_COMPANY = @P_CD_COMPANY 
AND SU.ID_USER = @P_ID_USER

INSERT INTO @ID_TYPIST SELECT CD_STR FROM GETTABLEFROMSPLIT(@V_ID_TYPIST)
INSERT INTO @ID_TYPIST_AUTO SELECT CD_STR FROM GETTABLEFROMSPLIT(@V_ID_TYPIST_AUTO)
INSERT INTO @ID_TYPIST_MAPS SELECT CD_STR FROM GETTABLEFROMSPLIT(@V_ID_TYPIST_MAPS)

SELECT (CASE WHEN EXISTS (SELECT 1 
		                  FROM @ID_TYPIST_AUTO TA
			              WHERE TA.ID_USER = MU.ID_USER) THEN 'Y' ELSE 'N' END) AS YN_AUTO,
	   (CASE WHEN EXISTS (SELECT 1 
		                  FROM @ID_TYPIST_MAPS TM
			              WHERE TM.ID_USER = MU.ID_USER) THEN 'Y' ELSE 'N' END) AS YN_MAPS,
	   MU.ID_USER,
	   (SELECT COUNT(1) AS QT_PROGRESS 
		FROM CZ_MA_WORKFLOWH WH
		WHERE WH.CD_COMPANY = MU.CD_COMPANY
		AND WH.TP_STEP = '01'
		AND WH.ID_TYPIST = MU.ID_USER
		AND (WH.YN_DONE IS NULL OR WH.YN_DONE = 'N')
		AND NOT EXISTS (SELECT 1 
						FROM CZ_SA_QTNH QH
						WHERE QH.CD_COMPANY = WH.CD_COMPANY
						AND QH.NO_FILE = WH.NO_KEY
						AND QH.YN_CLOSE = 'Y')) AS QT_PROGRESS
FROM MA_USER MU
WHERE MU.CD_COMPANY = @P_CD_COMPANY
AND EXISTS (SELECT 1 
		    FROM @ID_TYPIST IT
			WHERE IT.ID_USER = MU.ID_USER)
AND EXISTS (SELECT 1 
			FROM MA_EMP ME
			WHERE ME.CD_COMPANY = MU.CD_COMPANY
			AND ME.NO_EMP = MU.NO_EMP
			AND ISNULL(ME.DT_RETIRE, '00000000') = '00000000')
AND NOT EXISTS (SELECT 1 
			    FROM CZ_SA_USER SU
			    WHERE SU.CD_COMPANY = MU.CD_COMPANY
			    AND SU.ID_USER = MU.ID_USER
			    AND SU.YN_EXPECT = 'Y')
AND (MU.CD_COMPANY = 'S100' OR NOT EXISTS (SELECT 1 
				                           FROM HR_WTMCALC HW
				                           WHERE HW.CD_COMPANY = MU.CD_COMPANY
				                           AND HW.NO_EMP = MU.NO_EMP
				                           AND HW.DT_WORK = (CASE WHEN DATEPART(HOUR, GETDATE()) <= 18 THEN CONVERT(CHAR(8), GETDATE(), 112) ELSE CONVERT(CHAR(8), DATEADD(DAY, 1, GETDATE()), 112) END)
				                           AND HW.CD_WCODE IN ('G05', 'G21', 'G24', 'G28', 'G29', 'G31')))
OPTION (USE HINT('QUERY_OPTIMIZER_COMPATIBILITY_LEVEL_100'))

GO