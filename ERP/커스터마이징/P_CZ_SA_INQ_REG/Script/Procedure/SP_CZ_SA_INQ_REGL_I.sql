USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_INQ_REGL_I]    Script Date: 2015-07-03 오후 8:01:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_INQ_REGL_I]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_TP_STEP			NVARCHAR(3),
	@P_NO_KEY			NVARCHAR(20),
	@P_NM_FILE			NVARCHAR(MAX),
	@P_NM_FILE_REAL		NVARCHAR(MAX),
	@P_CD_SUPPLIER		NVARCHAR(20),
	@P_YN_PARSING		NVARCHAR(1),
	@P_YN_INCLUDED		NVARCHAR(1),
	@P_ID_INSERT		NVARCHAR(15)
) AS	

IF ISNULL(@P_NO_KEY, '') = '' OR (@P_NO_KEY NOT LIKE 'ZB%' AND LEN(@P_NO_KEY) < 8)
BEGIN
	DECLARE @V_DC_MSG NVARCHAR(500)
	SET @V_DC_MSG = '[SP_CZ_SA_INQ_REGL_I] 파일번호가 잘못 되었습니다.' + ' [파일번호 : ' + ISNULL(@P_NO_KEY, '') + ', 파일이름 : ' + ISNULL(@P_NM_FILE_REAL, '') + ']'

	RAISERROR(@V_DC_MSG, 16, 1)
	RETURN
END

DECLARE @V_NO_LINE INT

SELECT @V_NO_LINE = ISNULL(MAX(NO_LINE), 0) + 1 
FROM CZ_MA_WORKFLOWL 
WHERE CD_COMPANY = @P_CD_COMPANY 
AND TP_STEP = @P_TP_STEP 
AND NO_KEY = @P_NO_KEY

INSERT INTO CZ_MA_WORKFLOWL 
(
	CD_COMPANY,
	TP_STEP,		
	NO_KEY,		
	NO_LINE,
	CD_SUPPLIER,
	NM_FILE,
	NM_FILE_REAL,
	YN_DONE,
	YN_PARSING,
	YN_INCLUDED,
	ID_INSERT,
	DTS_INSERT
)
VALUES 
(
	@P_CD_COMPANY,
	@P_TP_STEP,		
	@P_NO_KEY,		
	@V_NO_LINE,
	@P_CD_SUPPLIER,
	@P_NM_FILE,
	@P_NM_FILE_REAL,
	'N',
	@P_YN_PARSING,
	@P_YN_INCLUDED,
	@P_ID_INSERT,
	NEOE.SF_SYSDATE(GETDATE())
)

IF @P_TP_STEP = '01'
BEGIN
	EXEC SP_CZ_MA_WORKFLOW_NEXT_STEP @P_CD_COMPANY, @P_TP_STEP, @P_NO_KEY, @P_ID_INSERT, ''
	EXEC SP_CZ_MA_WORKFLOW_NEXT_STEP @P_CD_COMPANY, '02', @P_NO_KEY, @P_ID_INSERT, ''
END
ELSE IF @P_TP_STEP = '04'
BEGIN
	EXEC SP_CZ_MA_WORKFLOW_NEXT_STEP @P_CD_COMPANY, @P_TP_STEP, @P_NO_KEY, @P_ID_INSERT, ''
	EXEC SP_CZ_MA_WORKFLOW_NEXT_STEP @P_CD_COMPANY, '05', @P_NO_KEY, @P_ID_INSERT, ''

	UPDATE CZ_MA_WORKFLOWL
	SET NO_HST = (SELECT NO_HST FROM CZ_SA_QTNH WHERE CD_COMPANY = @P_CD_COMPANY AND NO_FILE = @P_NO_KEY)
	WHERE CD_COMPANY = @P_CD_COMPANY
	AND TP_STEP = @P_TP_STEP
	AND NO_KEY = @P_NO_KEY
	AND NO_HST IS NULL

	IF EXISTS(SELECT 1 FROM CZ_SA_QTNH WHERE CD_COMPANY = @P_CD_COMPANY AND NO_FILE = @P_NO_KEY AND ISNULL(YN_CLOSE, 'N') = 'Y')
	BEGIN
		UPDATE CZ_SA_QTNH
		SET YN_CLOSE = 'N'
		WHERE CD_COMPANY = @P_CD_COMPANY
		AND NO_FILE = @P_NO_KEY
		
		EXEC SP_CZ_MA_WORKFLOW_DONE @P_CD_COMPANY, '07', @P_NO_KEY, @P_ID_INSERT
	END
END
ELSE IF @P_TP_STEP = '08'
BEGIN
	EXEC SP_CZ_MA_WORKFLOW_NEXT_STEP @P_CD_COMPANY, @P_TP_STEP, @P_NO_KEY, @P_ID_INSERT, ''
END

GO

