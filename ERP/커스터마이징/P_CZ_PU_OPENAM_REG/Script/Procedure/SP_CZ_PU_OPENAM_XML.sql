USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PU_OPENAML_XML]    Script Date: 2016-10-26 오후 2:41:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





ALTER PROCEDURE [NEOE].[SP_CZ_PU_OPENAM_XML] 
(
	@P_CD_COMPANY	NVARCHAR(7),
	@P_XML_H		XML, 
	@P_XML_L		XML, 
	@P_ID_USER		NVARCHAR(10)
) 
AS 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_ERRMSG   VARCHAR(255),   -- ERROR 메시지
		@V_DOC_H INT,
		@V_DOC_L INT

EXEC SP_XML_PREPAREDOCUMENT @V_DOC_H OUTPUT, @P_XML_H 
EXEC SP_XML_PREPAREDOCUMENT @V_DOC_L OUTPUT, @P_XML_L

SELECT * INTO #XML_H
FROM OPENXML (@V_DOC_H, '/XML/ROW', 2) WITH 
(
    YM_STANDARD		NCHAR(6),
    CD_PLANT		NVARCHAR(7),
    YY_AIS			NCHAR(4),
	YM_FSTANDARD	NCHAR(6),
	CD_DEPT			NVARCHAR(12),
	NO_EMP			NVARCHAR(10),
	DT_INPUT		NCHAR(8),
	DC50_PO			NVARCHAR(50),
	XML_FLAG		NVARCHAR(1)
)

SELECT * INTO #XML_L
FROM OPENXML (@V_DOC_L, '/XML/ROW', 2) WITH 
(
	CD_ITEM			NVARCHAR(20),
    YM_STANDARD		NCHAR(6),
    CD_PLANT		NVARCHAR(7),
    QT_BAS			NUMERIC(17,4),
    UM_BAS			NUMERIC(17,4),
    AM_BAS			NUMERIC(17,4),
	XML_FLAG		NVARCHAR(1)
)

EXEC SP_XML_REMOVEDOCUMENT @V_DOC_H
EXEC SP_XML_REMOVEDOCUMENT @V_DOC_L 

BEGIN TRAN SP_CZ_PU_OPENAM_XML
BEGIN TRY

-- ================================================== DELETE
DELETE A 
FROM MM_AMINV_FIFO A 
JOIN #XML_L B ON B.XML_FLAG = 'D' AND A.CD_COMPANY = @P_CD_COMPANY AND A.CD_PLANT = B.CD_PLANT AND A.YM_STANDARD = B.YM_STANDARD AND A.CD_ITEM = B.CD_ITEM

DELETE A 
FROM MM_AMINVL A 
JOIN #XML_L B ON B.XML_FLAG = 'D' AND A.CD_COMPANY = @P_CD_COMPANY AND A.CD_PLANT = B.CD_PLANT AND A.YM_STANDARD = B.YM_STANDARD AND A.CD_ITEM = B.CD_ITEM

-- ================================================== INSERT
INSERT INTO MM_AMINVH
(
	YM_STANDARD, 
	CD_PLANT, 
	CD_COMPANY, 
	YY_AIS, 
	YM_FSTANDARD, 
	CD_DEPT, 
	NO_EMP, 
	DT_INPUT, 
	DC50_PO,
	ID_INSERT,
	DTS_INSERT
)
SELECT YM_STANDARD, 
	   CD_PLANT, 
	   @P_CD_COMPANY, 
	   YY_AIS, 
	   YM_FSTANDARD, 
	   CD_DEPT, 
	   NO_EMP, 
	   DT_INPUT, 
	   DC50_PO,
	   @P_ID_USER,
	   NEOE.SF_SYSDATE(GETDATE())
FROM #XML_H
WHERE XML_FLAG = 'I'

INSERT INTO MM_AMINVL
(
	CD_ITEM, 
	YM_STANDARD, 
	CD_PLANT, 
	CD_COMPANY, 
	QT_BAS, 
	UM_BAS, 
	AM_BAS, 
	QT_RCV, 
	AM_RCV, 
	QT_ISU, 
	AM_ISU, 
	QT_ISU_SUB, 
	AM_ISU_SUB, 
	QT_INV, 
	UM_INV, 
	AM_INV, 
	UM_ISU
)
SELECT CD_ITEM,
	   YM_STANDARD,
	   CD_PLANT,
	   @P_CD_COMPANY,
	   QT_BAS,
	   UM_BAS,
	   AM_BAS,
	   0, 
	   0, 
	   0, 
	   0, 
	   0, 
	   0,
	   QT_BAS,
	   UM_BAS,
	   AM_BAS,
	   0 
FROM #XML_L
WHERE XML_FLAG = 'I'

INSERT INTO MM_AMINV_FIFO 
(
	CD_COMPANY,
	CD_PLANT,
	YM_STANDARD,
	CD_ITEM,
	NO_CLS, 
	NO_CLSLINE,
	DT_CLS,
	QT_BAS,
	AM_BAS,
	QT_RCV, 
	AM_RCV,
	QT_ISU,
	AM_ISU,
	QT_ISU_SUB,
	AM_ISU_SUB, 
	QT_INV,
	AM_INV
)
SELECT @P_CD_COMPANY,
	   CD_PLANT,
	   YM_STANDARD,
	   CD_ITEM,
	   '0',
	   0,
	   (YM_STANDARD + '00'),
	   QT_BAS, 
	   AM_BAS, 
	   0, 
	   0, 
	   0, 
	   0,
	   0,
	   0,
	   QT_BAS,
	   AM_BAS 
FROM #XML_L
WHERE XML_FLAG = 'I'

-- ================================================== UPDATE    
UPDATE A
SET A.CD_DEPT = B.CD_DEPT,
	A.NO_EMP = B.NO_EMP, 
	A.DT_INPUT = B.DT_INPUT, 
	A.DC50_PO = B.DC50_PO, 
	A.ID_UPDATE = @P_ID_USER, 
	A.DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
FROM MM_AMINVH A
JOIN #XML_H B ON B.XML_FLAG = 'U' AND A.YM_STANDARD = B.YM_STANDARD AND A.CD_PLANT = B.CD_PLANT AND A.CD_COMPANY = @P_CD_COMPANY

UPDATE A 
SET A.QT_BAS = B.QT_BAS,
	A.UM_BAS = B.UM_BAS,
	A.AM_BAS = B.AM_BAS,
	A.QT_INV = B.QT_BAS,
	A.UM_INV = B.UM_BAS,
	A.AM_INV = B.AM_BAS
FROM MM_AMINVL A 
JOIN #XML_L B ON B.XML_FLAG = 'U' AND A.CD_ITEM = B.CD_ITEM AND A.YM_STANDARD = B.YM_STANDARD AND A.CD_PLANT = B.CD_PLANT AND A.CD_COMPANY = @P_CD_COMPANY

DELETE A
FROM MM_AMINV_FIFO A 
JOIN #XML_L B ON B.XML_FLAG = 'U' AND A.CD_ITEM = B.CD_ITEM AND A.YM_STANDARD = B.YM_STANDARD AND A.CD_PLANT = B.CD_PLANT AND A.CD_COMPANY = @P_CD_COMPANY

INSERT INTO MM_AMINV_FIFO 
(
	CD_COMPANY,
	CD_PLANT,
	YM_STANDARD,
	CD_ITEM,
	NO_CLS, 
	NO_CLSLINE,
	DT_CLS,
	QT_BAS,
	AM_BAS,
	QT_RCV, 
	AM_RCV,
	QT_ISU,
	AM_ISU,
	QT_ISU_SUB,
	AM_ISU_SUB, 
	QT_INV,
	AM_INV
)
SELECT @P_CD_COMPANY,
	   CD_PLANT,
	   YM_STANDARD,
	   CD_ITEM,
	   '0',
	   0,
	   (YM_STANDARD + '00'),
	   QT_BAS, 
	   AM_BAS, 
	   0, 
	   0, 
	   0, 
	   0,
	   0,
	   0,
	   QT_BAS,
	   AM_BAS 
FROM #XML_L
WHERE XML_FLAG = 'U'

DROP TABLE #XML_H
DROP TABLE #XML_L

COMMIT TRAN SP_CZ_PU_OPENAM_XML

END TRY
BEGIN CATCH
	ROLLBACK TRAN SP_CZ_PU_OPENAM_XML
	SELECT @V_ERRMSG = ERROR_MESSAGE()
	GOTO ERROR
END CATCH

RETURN
ERROR: 
RAISERROR(@V_ERRMSG, 16, 1)
ROLLBACK TRAN SP_CZ_PU_OPENAM_XML

GO

