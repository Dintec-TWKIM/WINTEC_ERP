USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_MA_HULL_RPT_S]    Script Date: 2017-08-08 오전 9:06:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_MA_HULL_RPTL_S]
(
	@P_CD_COMPANY      NVARCHAR(7),
	@P_NO_IMO		   NVARCHAR(10),
	@P_TP_DATE		   NVARCHAR(4),
	@P_DT_FROM		   NVARCHAR(8),
	@P_DT_TO		   NVARCHAR(8),
	@P_NO_FILE_PREFIX  NVARCHAR(500),
	@P_CD_SUPPLIER	   NVARCHAR(20),
	@P_CD_PARTNER	   NVARCHAR(20)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @P_AM_FSIZE NUMERIC(3, 0)   -- 소수점

IF @P_CD_COMPANY = 'S100'
	SET @P_AM_FSIZE = 2
ELSE
	SET @P_AM_FSIZE = 0

SELECT SH.NO_IMO,
	   SH.NO_SO,
	   SH.DT_SO,
	   IG.NM_ITEMGRP,
	   SL.SEQ_SO,
	   QL.NO_DSP,
	   SL.CD_ITEM,
	   MI.NM_ITEM,
	   QL.CD_ITEM_PARTNER,
	   QL.NM_ITEM_PARTNER,
	   MI.UNIT_SO,
	   SL.QT_SO,
	   MC.NM_SYSDEF AS NM_EXCH,
	   SH.RT_EXCH,
	   SL.UM_EX_P,
	   SL.UM_KR_P,
	   SL.AM_EX_P,
	   SL.AM_KR_P,
	   ISNULL(SL.UM_EX_S, SL.UM_SO) AS UM_EX_S,
	   ISNULL(SL.UM_KR_S, ROUND(SL.UM_SO * SH.RT_EXCH, @P_AM_FSIZE)) AS UM_KR_S,
	   ISNULL(SL.AM_EX_S, SL.AM_SO) AS AM_EX_S,
	   ISNULL(SL.AM_KR_S, SL.AM_WONAMT) AS AM_KR_S
FROM CZ_SA_QTNH QH
JOIN SA_SOH SH ON SH.CD_COMPANY = QH.CD_COMPANY AND SH.NO_SO = QH.NO_FILE
LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = SL.CD_COMPANY AND QL.NO_FILE = SL.NO_SO AND QL.NO_LINE = SL.SEQ_SO
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = SL.CD_COMPANY AND MI.CD_PLANT = SL.CD_PLANT AND MI.CD_ITEM = SL.CD_ITEM
LEFT JOIN MA_ITEMGRP IG ON IG.CD_COMPANY = MI.CD_COMPANY AND IG.CD_ITEMGRP = MI.GRP_ITEM
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = SH.NO_IMO
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = SH.CD_COMPANY AND MC.CD_FIELD = 'MA_B000005' AND MC.CD_SYSDEF = SH.CD_EXCH
WHERE QH.CD_COMPANY = @P_CD_COMPANY
AND QH.NO_IMO = @P_NO_IMO
AND (ISNULL(@P_CD_PARTNER, '') = '' OR QH.CD_PARTNER = @P_CD_PARTNER)
AND (ISNULL(@P_NO_FILE_PREFIX, '') = '' OR LEFT(SH.NO_SO, 2) IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_NO_FILE_PREFIX)))
AND (@P_TP_DATE <> '000' OR (@P_TP_DATE = '000' AND QH.DT_QTN BETWEEN @P_DT_FROM AND @P_DT_TO))
AND (@P_TP_DATE <> '001' OR (@P_TP_DATE = '001' AND ISNULL(SH.DT_SO, '') BETWEEN @P_DT_FROM AND @P_DT_TO))
AND (@P_TP_DATE <> '002' OR (@P_TP_DATE = '002' AND ISNULL(MH.DT_SHIP_DLV, '') BETWEEN @P_DT_FROM AND @P_DT_TO))
AND (@P_TP_DATE <> '003' OR (@P_TP_DATE = '003' AND ISNULL(SH.DT_CONTRACT, '') BETWEEN @P_DT_FROM AND @P_DT_TO))
AND (ISNULL(@P_CD_SUPPLIER, '') = '' OR EXISTS (SELECT 1 
												FROM PU_POH PH
												JOIN PU_POL PL ON PL.CD_COMPANY = PH.CD_COMPANY AND PL.NO_PO = PH.NO_PO
												WHERE PH.CD_COMPANY = SH.CD_COMPANY
												AND PH.CD_PARTNER = @P_CD_SUPPLIER
												AND PL.NO_SO = SL.NO_SO
												AND PL.NO_SOLINE = SL.SEQ_SO))
ORDER BY SH.DT_SO DESC, SH.NO_SO, QL.NO_DSP

GO