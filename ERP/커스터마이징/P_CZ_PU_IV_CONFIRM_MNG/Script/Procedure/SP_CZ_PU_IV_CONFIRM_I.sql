USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PU_IV_CONFIRM_I]    Script Date: 2016-11-17 오후 5:00:32 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
    
ALTER PROCEDURE [NEOE].[SP_CZ_PU_IV_CONFIRM_I]        
(             
	@P_CD_COMPANY           NVARCHAR(7),
	@P_TP_CONFIRM			NVARCHAR(4),
	@P_NO_ETAX				NVARCHAR(30),
	@P_NO_IO				NVARCHAR(20),
	@P_NO_PO				NVARCHAR(20),
	@P_DT_END				NVARCHAR(8),
	@P_AM_EX				NUMERIC(17, 4),
	@P_AM_EX_IO				NUMERIC(17, 4),
	@P_NO_EMP				NVARCHAR(100),
	@P_DC_RMK				NVARCHAR(1000),
	@P_ID_USER				NVARCHAR(15)
)        
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @P_TP_CONFIRM = '001' AND EXISTS (SELECT 1 
								     FROM CZ_PU_IV_CONFIRM IC
								     WHERE IC.CD_COMPANY = @P_CD_COMPANY
								     AND IC.TP_CONFIRM = @P_TP_CONFIRM
								     AND IC.NO_IO = @P_NO_IO
								     AND ISNULL(IC.NO_IO, '') <> '')
BEGIN
	UPDATE IC
	SET DT_END = @P_DT_END,
		AM_EX = @P_AM_EX,
		AM_EX_IO = @P_AM_EX_IO,
	    DC_RMK = REPLACE(@P_DC_RMK, CHAR(10), CHAR(13) + CHAR(10)),
	    ID_UPDATE = @P_ID_USER,
		DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	FROM CZ_PU_IV_CONFIRM IC
	WHERE IC.CD_COMPANY = @P_CD_COMPANY
	AND IC.TP_CONFIRM = @P_TP_CONFIRM
	AND IC.NO_IO = @P_NO_IO
END
ELSE IF @P_TP_CONFIRM = '002' AND EXISTS (SELECT 1 
										  FROM CZ_PU_IV_CONFIRM IC
										  WHERE IC.CD_COMPANY = @P_CD_COMPANY
										  AND IC.TP_CONFIRM = @P_TP_CONFIRM
										  AND IC.NO_ETAX = @P_NO_ETAX
										  AND ISNULL(IC.NO_ETAX, '') <> ''
										  AND ISNULL(@P_NO_IO, '') = '')
BEGIN
	UPDATE IC
	SET DT_END = @P_DT_END,
	    NO_EMP = REPLACE(@P_NO_EMP, 'S-346', 'S-495'),
	    DC_RMK = REPLACE(@P_DC_RMK, CHAR(10), CHAR(13) + CHAR(10)),
	    ID_UPDATE = @P_ID_USER,
		DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	FROM CZ_PU_IV_CONFIRM IC
	WHERE IC.CD_COMPANY = @P_CD_COMPANY
	AND IC.TP_CONFIRM = @P_TP_CONFIRM
	AND IC.NO_ETAX = @P_NO_ETAX
END
ELSE IF @P_TP_CONFIRM = '004' AND EXISTS (SELECT 1 
										  FROM CZ_PU_IV_CONFIRM IC
										  WHERE IC.CD_COMPANY = @P_CD_COMPANY
										  AND IC.TP_CONFIRM = @P_TP_CONFIRM
										  AND IC.NO_PO = @P_NO_PO
										  AND IC.AM_EX = @P_AM_EX
										  AND ISNULL(IC.NO_PO, '') <> ''
										  AND IC.AM_EX > 0)
BEGIN
	UPDATE IC
	SET DC_RMK = REPLACE(@P_DC_RMK, CHAR(10), CHAR(13) + CHAR(10)),
	    ID_UPDATE = @P_ID_USER,
		DTS_UPDATE = NEOE.SF_SYSDATE(GETDATE())
	FROM CZ_PU_IV_CONFIRM IC
	WHERE IC.CD_COMPANY = @P_CD_COMPANY
	AND IC.TP_CONFIRM = @P_TP_CONFIRM
	AND IC.NO_PO = @P_NO_PO
	AND IC.AM_EX = @P_AM_EX
END
ELSE
BEGIN
	INSERT INTO CZ_PU_IV_CONFIRM
	(
		CD_COMPANY,
		SEQ,
		TP_CONFIRM,
		NO_IO,
		NO_ETAX,
		NO_PO,
		DT_END,
		AM_EX,
		AM_EX_IO,
		NO_EMP,
		DC_RMK,
		ID_INSERT,
		DTS_INSERT
	)
	VALUES
	(
		@P_CD_COMPANY,
		(SELECT ISNULL(MAX(SEQ), 0) + 1 
		 FROM CZ_PU_IV_CONFIRM IC
		 WHERE IC.CD_COMPANY = @P_CD_COMPANY),
		@P_TP_CONFIRM,
		@P_NO_IO,
		@P_NO_ETAX,
		@P_NO_PO,
		@P_DT_END,
		@P_AM_EX,
		@P_AM_EX_IO,
		REPLACE(@P_NO_EMP, 'S-346', 'S-495'),
		REPLACE(@P_DC_RMK, CHAR(10), CHAR(13) + CHAR(10)),
		@P_ID_USER,
		NEOE.SF_SYSDATE(GETDATE())
	)
END

GO