USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_COMMISSION_MNG_GW]    Script Date: 2018-11-01 오후 4:03:14 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_COMMISSION_MNG_GW]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_CD_PARTNER	    NVARCHAR(20),
	@P_NO_COMMISSION	NVARCHAR(20)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT CH.NO_COMMISSION,
	   CH.RT_COMMISSION,
	   CH.YN_CHARGE,
	   CONVERT(CHAR(10), CONVERT(DATE, CH.DT_START), 111) + ' ~ ' + CHAR(13) + CHAR(10) + CONVERT(CHAR(10), CONVERT(DATE, CH.DT_END), 111) AS DT_PERIOD,
	   CD.NM_EXCH,
	   CD.AM_TARGET,
	   CD.AM_COMMISSION_BEFORE,
	   CD.AM_COMMISSION,
	   CD.AM_OUTSTANDING,
	   CD.RT_PROFIT,
	   CD.RT_PROFIT1
FROM CZ_SA_COMMISSIONH CH
LEFT JOIN FI_GWDOCU GW ON GW.CD_COMPANY = 'K100' AND GW.CD_PC = '010000' AND GW.NO_DOCU = CH.CD_COMPANY + '-' + CH.NO_GW_DOCU
LEFT JOIN (SELECT CD.CD_COMPANY, 
		   	      CD.NO_COMMISSION, 
		   	      MC.NM_SYSDEF AS NM_EXCH,
		   	      SUM(CD.AM_TARGET) AS AM_TARGET,
				  SUM(CD.AM_COMMISSION_BEFORE) AS AM_COMMISSION_BEFORE,
		   	      SUM(CD.AM_COMMISSION) AS AM_COMMISSION,
				  SUM(CD.AM_OUTSTANDING) AS AM_OUTSTANDING,
		   	      ROUND((SUM(SH.AM_PROFIT) / SUM(SH.AM_SO)) * 100, 2) AS RT_PROFIT,
		   	      ROUND((SUM(SH.AM_PROFIT - ((CD.AM_COMMISSION * SH.RT_EXCH) + (CD.AM_COMMISSION_BEFORE * SH.RT_EXCH))) / SUM(SH.AM_SO)) * 100, 2) AS RT_PROFIT1
		   FROM (SELECT CD.CD_COMPANY, 
		   		        CD.NO_COMMISSION, 
		   			    CD.NO_SO,
						SUM(CASE WHEN CD.YN_CHARGE = 'Y' THEN CD.AM_IV ELSE CD.AM_NET END) AS AM_TARGET,
						SUM(CD.AM_COMMISSION_BEFORE) AS AM_COMMISSION_BEFORE,
		   	  	        SUM(CD.AM_COMMISSION) AS AM_COMMISSION,
						SUM(CD.AM_OUTSTANDING) AS AM_OUTSTANDING
		         FROM CZ_SA_COMMISSIOND CD
		   	     GROUP BY CD.CD_COMPANY, CD.NO_COMMISSION, CD.NO_SO, CD.YN_ADDED) CD
		   LEFT JOIN (SELECT SH.CD_COMPANY, 
		   		   	         SH.NO_SO,
		   		   	         SH.RT_EXCH,
		   				     SH.CD_EXCH,
		   		   	         SUM(SL.AM_WONAMT) AS AM_SO,
		   		   	         SUM((ISNULL(SL.AM_WONAMT, 0) - (ISNULL(PL.AM_PO, 0) + (ISNULL(SB.UM_KR, 0) * ISNULL(SB.QT_STOCK, 0))))) AS AM_PROFIT
		   			  FROM SA_SOH SH
		   			  JOIN SA_SOL SL ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
		   			  LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE,
		   			  			        SUM(PL.AM) AS AM_PO
		   			  		     FROM PU_POL PL
		   			  		     GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE) PL
		   			  ON PL.CD_COMPANY = SL.CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.NO_SOLINE = SL.SEQ_SO
		   			  LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO
		   			  GROUP BY SH.CD_COMPANY, 
		   			  	       SH.NO_SO,
		   			  		   SH.RT_EXCH,
		   			  		   SH.CD_EXCH) SH
		   ON SH.CD_COMPANY = CD.CD_COMPANY AND SH.NO_SO = CD.NO_SO
		   LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = SH.CD_COMPANY AND MC.CD_FIELD = 'MA_B000005' AND MC.CD_SYSDEF = SH.CD_EXCH
		   GROUP BY CD.CD_COMPANY, CD.NO_COMMISSION, MC.NM_SYSDEF) CD 
ON CD.CD_COMPANY = CH.CD_COMPANY AND CD.NO_COMMISSION = CH.NO_COMMISSION
WHERE CH.CD_COMPANY = @P_CD_COMPANY
AND CH.CD_PARTNER = @P_CD_PARTNER
AND (GW.ST_STAT = '1' OR CH.NO_COMMISSION = @P_NO_COMMISSION)
ORDER BY CH.NO_COMMISSION DESC

GO

