USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_BI_QTN_SEND_DAY_CHART_S4]    Script Date: 2018-09-19 오전 9:21:52 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [NEOE].[SP_CZ_BI_QTN_SEND_DAY_CHART_S4]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_DT_START			NVARCHAR(8),
	@P_DT_END			NVARCHAR(8),
	@P_TP_QTN			NVARCHAR(3)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

WITH WH AS
(
	SELECT WH.CD_COMPANY, WH.NO_KEY,
		   LEFT(WH.DTS_INSERT, 6) AS DT_MONTH
	FROM CZ_MA_WORKFLOWH WH
	WHERE WH.CD_COMPANY = @P_CD_COMPANY
	AND WH.TP_STEP = '01'
	AND WH.DTS_INSERT BETWEEN @P_DT_START + '000000' AND @P_DT_END + '999999'
	AND (WH.NO_KEY LIKE 'FB________' OR 
		 WH.NO_KEY LIKE 'DB________' OR
		 WH.NO_KEY LIKE 'SB________' OR
		 WH.NO_KEY LIKE 'NB________' OR
		 WH.NO_KEY LIKE 'NS________' OR
		 WH.NO_KEY LIKE 'DS________' OR
		 WH.NO_KEY LIKE 'A-________' OR
		 WH.NO_KEY LIKE 'D-________' OR
		 WH.NO_KEY LIKE 'N-________')	
),
WH1 AS
(
	SELECT WH.CD_COMPANY,
		   WH.NO_KEY,
		   WH.DT_MONTH,
		   QH.CD_SALEGRP
	FROM WH WH
	LEFT JOIN CZ_SA_QTNH QH ON QH.CD_COMPANY = WH.CD_COMPANY AND QH.NO_FILE = WH.NO_KEY
	WHERE (@P_TP_QTN = '000' OR EXISTS (SELECT 1 
										FROM MA_EMP ME
										WHERE ME.CD_COMPANY = QH.CD_COMPANY
										AND ME.NO_EMP = (CASE WHEN @P_TP_QTN = '001' THEN QH.NO_EMP_STK ELSE QH.NO_EMP_QTN END)
										AND ME.CD_DEPT = '010900'))
),
WH2 AS
(
	SELECT WH.CD_COMPANY,
		   WH.NO_KEY,
		   WH.DT_MONTH,
		   SG.CD_SALEORG,
		   QL.QT_ITEM
	FROM WH1 WH
	LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = WH.CD_COMPANY AND SG.CD_SALEGRP = WH.CD_SALEGRP
	LEFT JOIN (SELECT QL.CD_COMPANY, QL.NO_FILE,
			   	      SUM(1.0) AS QT_ITEM
			   FROM CZ_SA_QTNL QL
			   GROUP BY QL.CD_COMPANY, QL.NO_FILE) QL
	ON QL.CD_COMPANY = WH.CD_COMPANY AND QL.NO_FILE = WH.NO_KEY
	WHERE SG.CD_SALEORG IN ('010301', '020200')
)
SELECT WH.DT_MONTH,
       SUM(1.0) AS QT_INQ_ALL,
	   SUM(WH.QT_ITEM) AS QT_ITEM_ALL
FROM WH2 WH
LEFT JOIN MA_SALEORG SO ON SO.CD_COMPANY = WH.CD_COMPANY AND SO.CD_SALEORG = WH.CD_SALEORG
GROUP BY WH.DT_MONTH
ORDER BY WH.DT_MONTH

GO

