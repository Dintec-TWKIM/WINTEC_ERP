USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_CRM_CHART_S03_S]    Script Date: 2017-07-13 오후 3:13:12 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_CRM_CHART_S03_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_DT_FROM			NVARCHAR(8),
	@P_DT_TO			NVARCHAR(8),
	@P_CD_PARTNER		NVARCHAR(1000),
	@P_NO_IMO			NVARCHAR(10),
	@P_NO_EMP			NVARCHAR(10),
	@P_CD_ITEMGRP		NVARCHAR(20),
	@P_CD_SALEORG		NVARCHAR(7),
	@P_CD_SALEGRP		NVARCHAR(1000),
	@P_LENGTH			NUMERIC(1)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT LEFT(QL.DT_INQ, @P_LENGTH) AS DT_INQ,
       SUM(QL.QT_INQ) AS QT_INQ,
	   SUM(QL.QT_CHOICE) AS QT_CHOICE,
	   (CASE WHEN SUM(QL.QT_INQ) = 0 THEN 0 
									 ELSE ROUND(SUM(QL.QT_CHOICE) / SUM(QL.QT_INQ) * 100, 2) END) AS RT_CHOICE,
	   SUM(CASE WHEN SL.CD_COMPANY IS NOT NULL THEN 1.0 ELSE 0 END) AS QT_SO,
	   (CASE WHEN SUM(QL.QT_CHOICE) = 0 THEN 0 
									    ELSE ROUND(ISNULL(SUM(CASE WHEN SL.CD_COMPANY IS NOT NULL THEN 1.0 ELSE 0 END), 0) / SUM(QL.QT_CHOICE) * 100, 2) END) AS RT_SO,
	   SUM(SL.AM_SO) AS AM_SO,
	   SUM(PL.AM_PO) AS AM_PO,
	   SUM(SB.AM_STOCK) AS AM_STOCK,
	   SUM(ISNULL(SL.AM_SO, 0) - (ISNULL(PL.AM_PO, 0) + ISNULL(SB.AM_STOCK, 0))) AS AM_PROFIT,
	   (CASE WHEN SUM(SL.AM_SO) = 0 THEN 0
								    ELSE ROUND(SUM(ISNULL(SL.AM_SO, 0) - (ISNULL(PL.AM_PO, 0) + ISNULL(SB.AM_STOCK, 0))) / SUM(SL.AM_SO) * 100, 2) END) AS RT_PROFIT
FROM (SELECT QH.CD_COMPANY, QL.NO_FILE, QL.NO_LINE,
	  		 MAX(QH1.DT_INQ) AS DT_INQ,
	  		 SUM(1.0) AS QT_INQ,
	  		 SUM(CASE WHEN ISNULL(QL1.YN_CHOICE, 'N') = 'Y' THEN 1.0 ELSE 0 END) AS QT_CHOICE
	  FROM CZ_SA_QTNH QH
	  JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = QH.CD_COMPANY AND QL.NO_FILE = QH.NO_FILE
	  JOIN CZ_PU_QTNL QL1 ON QL1.CD_COMPANY = QL.CD_COMPANY AND QL1.NO_FILE = QL.NO_FILE AND QL1.NO_LINE = QL.NO_LINE
	  JOIN CZ_PU_QTNH QH1 ON QH1.CD_COMPANY = QL1.CD_COMPANY AND QH1.NO_FILE = QL1.NO_FILE AND QH1.CD_PARTNER = QL1.CD_PARTNER
	  LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = QH.CD_COMPANY AND SG.CD_SALEGRP = QH.CD_SALEGRP
	  WHERE QH.CD_COMPANY = @P_CD_COMPANY
	  AND QH1.DT_INQ BETWEEN @P_DT_FROM AND @P_DT_TO
	  AND QL.CD_ITEM NOT LIKE 'SD%'
	  AND (ISNULL(@P_CD_PARTNER, '') = '' OR QL1.CD_PARTNER IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_PARTNER)))
	  AND (ISNULL(@P_CD_ITEMGRP, '') = '' OR QL.GRP_ITEM = @P_CD_ITEMGRP)
	  AND (ISNULL(@P_CD_SALEORG, '') = '' OR SG.CD_SALEORG = @P_CD_SALEORG)
	  AND (ISNULL(@P_CD_SALEGRP, '') = '' OR QH.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP)))
	  GROUP BY QH.CD_COMPANY, QL.NO_FILE, QL.NO_LINE) QL 
LEFT JOIN (SELECT SL.CD_COMPANY, SL.NO_SO, SL.SEQ_SO,
				  ISNULL(SL.AM_KR_S, SL.AM_WONAMT) AS AM_SO
		   FROM SA_SOL SL) SL 
ON SL.CD_COMPANY = QL.CD_COMPANY AND SL.NO_SO = QL.NO_FILE AND SL.SEQ_SO = QL.NO_LINE AND QL.QT_CHOICE > 0
LEFT JOIN (SELECT CD_COMPANY, NO_FILE, NO_LINE,
				  (ISNULL(QT_STOCK, 0) * ISNULL(UM_KR, 0)) AS AM_STOCK 
		   FROM CZ_SA_STOCK_BOOK) SB 
ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO
LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE,
				  SUM(PL.AM) AS AM_PO
		   FROM PU_POL PL
		   GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE) PL
ON PL.CD_COMPANY = SL.CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.NO_SOLINE = SL.SEQ_SO
GROUP BY LEFT(QL.DT_INQ, @P_LENGTH)
ORDER BY LEFT(QL.DT_INQ, @P_LENGTH)

GO