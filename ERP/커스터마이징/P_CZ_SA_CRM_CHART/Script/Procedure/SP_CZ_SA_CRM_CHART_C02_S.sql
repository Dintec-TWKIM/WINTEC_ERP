USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_CRM_CHART_C02_S]    Script Date: 2017-07-13 오후 3:13:12 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [NEOE].[SP_CZ_SA_CRM_CHART_C02_S]
(
	@P_CD_COMPANY		NVARCHAR(7),
	@P_DT_FROM			NVARCHAR(8),
	@P_DT_TO			NVARCHAR(8),
	@P_CD_PARTNER		NVARCHAR(1000),
	@P_NO_IMO			NVARCHAR(10),
	@P_NO_EMP			NVARCHAR(10),
	@P_CD_ITEMGRP		NVARCHAR(20),
	@P_CD_SALEORG		NVARCHAR(7),
	@P_CD_SALEGRP		NVARCHAR(1000),
	@P_LENGTH			NUMERIC(1)
) 
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT MC3.NM_SYSDEF AS NM_STATUS,
	   MC4.NM_SYSDEF AS NM_GW_STATUS,
	   CH.NO_CLAIM,
	   CH.NO_SO,
	   SH.DT_SO,
	   CH.DT_INPUT,
	   CH.DT_CLOSING,
	   MC.NM_SYSDEF AS NM_TP_CLAIM,
	   MC1.NM_SYSDEF AS NM_TP_CAUSE,
	   MC2.NM_SYSDEF AS NM_TP_ITEM,
	   CH.CD_PARTNER,
	   MP.LN_PARTNER,
	   MH.NM_VESSEL,
	   CH.NO_EMP,
	   ME.NM_KOR AS NM_EMP,
	   (CASE WHEN CH.NO_CLAIM IS NOT NULL THEN 1 ELSE 0 END) AS QT_CLAIM,
	   CL.AM_CLAIM,
	   DATEDIFF(DAY, SH.DT_SO, CH.DT_INPUT) AS DT_SO_DIFF,
	   DATEDIFF(DAY, CH.DT_INPUT, CH.DT_CLOSING) AS DT_CLOSING_DIFF,
	   CH.DC_CLAIM_CONTENS 
FROM CZ_SA_CLAIMH CH
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = CH.CD_COMPANY AND SH.NO_SO = CH.NO_SO
LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
JOIN (SELECT CL.CD_COMPANY, CL.NO_CLAIM,
	  		 SUM(CL.AM_CLAIM) AS AM_CLAIM 
	  FROM CZ_SA_CLAIML CL
	  LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = CL.CD_COMPANY AND MI.CD_ITEM = CL.CD_ITEM
	  WHERE (ISNULL(@P_CD_ITEMGRP, '') = '' OR MI.GRP_ITEM = @P_CD_ITEMGRP)
	  GROUP BY CL.CD_COMPANY, CL.NO_CLAIM) CL
ON CL.CD_COMPANY = CH.CD_COMPANY AND CL.NO_CLAIM = CH.NO_CLAIM
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = CH.CD_COMPANY AND MP.CD_PARTNER = CH.CD_PARTNER
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = CH.NO_IMO
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = CH.CD_COMPANY AND ME.NO_EMP = CH.NO_EMP
LEFT JOIN FI_GWDOCU GW ON GW.CD_COMPANY = 'K100' AND GW.CD_PC = '010000' AND GW.NO_DOCU = CH.CD_COMPANY + '-' + CH.NO_CLAIM + '-' + CH.CD_STATUS
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = CH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00001' AND MC.CD_SYSDEF = CH.TP_CLAIM
LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = CH.CD_COMPANY AND MC1.CD_FIELD = 'CZ_SA00002' AND MC1.CD_SYSDEF = CH.TP_CAUSE
LEFT JOIN MA_CODEDTL MC2 ON MC2.CD_COMPANY = CH.CD_COMPANY AND MC2.CD_FIELD = 'CZ_SA00003' AND MC2.CD_SYSDEF = CH.TP_ITEM
LEFT JOIN MA_CODEDTL MC3 ON MC3.CD_COMPANY = CH.CD_COMPANY AND MC3.CD_FIELD = 'CZ_SA00004' AND MC3.CD_SYSDEF = CH.CD_STATUS
LEFT JOIN MA_CODEDTL MC4 ON MC4.CD_COMPANY = GW.CD_COMPANY AND MC4.CD_FIELD = 'PU_C000065' AND MC4.CD_SYSDEF = GW.ST_STAT
WHERE CH.CD_COMPANY = @P_CD_COMPANY
AND CH.DT_INPUT BETWEEN @P_DT_FROM AND @P_DT_TO
AND (ISNULL(@P_CD_PARTNER, '') = '' OR CH.CD_PARTNER IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_PARTNER)))
AND (ISNULL(@P_NO_IMO, '') = '' OR CH.NO_IMO = @P_NO_IMO)
AND (ISNULL(@P_NO_EMP, '') = '' OR CH.NO_EMP = @P_NO_EMP)
AND (ISNULL(@P_CD_SALEORG, '') = '' OR SG.CD_SALEORG = @P_CD_SALEORG)
AND (ISNULL(@P_CD_SALEGRP, '') = '' OR SH.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP)))
ORDER BY CH.DT_INPUT DESC

SELECT ISNULL(MC.NM_SYSDEF, '') AS NM_TP_CLAIM,
	   SUM(1) AS QT_CLAIM
FROM CZ_SA_CLAIMH CH
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = CH.CD_COMPANY AND SH.NO_SO = CH.NO_SO
LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
JOIN (SELECT CL.CD_COMPANY, CL.NO_CLAIM
	  FROM CZ_SA_CLAIML CL
	  LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = CL.CD_COMPANY AND MI.CD_ITEM = CL.CD_ITEM
	  WHERE (ISNULL(@P_CD_ITEMGRP, '') = '' OR MI.GRP_ITEM = @P_CD_ITEMGRP)
	  GROUP BY CL.CD_COMPANY, CL.NO_CLAIM) CL
ON CL.CD_COMPANY = CH.CD_COMPANY AND CL.NO_CLAIM = CH.NO_CLAIM
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = CH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00001' AND MC.CD_SYSDEF = CH.TP_CLAIM
WHERE CH.CD_COMPANY = @P_CD_COMPANY
AND CH.DT_INPUT BETWEEN @P_DT_FROM AND @P_DT_TO
AND (ISNULL(@P_CD_PARTNER, '') = '' OR CH.CD_PARTNER IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_PARTNER)))
AND (ISNULL(@P_NO_IMO, '') = '' OR CH.NO_IMO = @P_NO_IMO)
AND (ISNULL(@P_NO_EMP, '') = '' OR CH.NO_EMP = @P_NO_EMP)
AND (ISNULL(@P_CD_SALEORG, '') = '' OR SG.CD_SALEORG = @P_CD_SALEORG)
AND (ISNULL(@P_CD_SALEGRP, '') = '' OR SH.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP)))
GROUP BY MC.NM_SYSDEF

SELECT ISNULL(MC.NM_SYSDEF, '') AS NM_TP_CAUSE,
	   SUM(1) AS QT_CLAIM
FROM CZ_SA_CLAIMH CH
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = CH.CD_COMPANY AND SH.NO_SO = CH.NO_SO
LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
JOIN (SELECT CL.CD_COMPANY, CL.NO_CLAIM
	  FROM CZ_SA_CLAIML CL
	  LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = CL.CD_COMPANY AND MI.CD_ITEM = CL.CD_ITEM
	  WHERE (ISNULL(@P_CD_ITEMGRP, '') = '' OR MI.GRP_ITEM = @P_CD_ITEMGRP)
	  GROUP BY CL.CD_COMPANY, CL.NO_CLAIM) CL
ON CL.CD_COMPANY = CH.CD_COMPANY AND CL.NO_CLAIM = CH.NO_CLAIM
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = CH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00002' AND MC.CD_SYSDEF = CH.TP_CAUSE
WHERE CH.CD_COMPANY = @P_CD_COMPANY
AND CH.DT_INPUT BETWEEN @P_DT_FROM AND @P_DT_TO
AND (ISNULL(@P_CD_PARTNER, '') = '' OR CH.CD_PARTNER IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_PARTNER)))
AND (ISNULL(@P_NO_IMO, '') = '' OR CH.NO_IMO = @P_NO_IMO)
AND (ISNULL(@P_NO_EMP, '') = '' OR CH.NO_EMP = @P_NO_EMP)
AND (ISNULL(@P_CD_SALEORG, '') = '' OR SG.CD_SALEORG = @P_CD_SALEORG)
AND (ISNULL(@P_CD_SALEGRP, '') = '' OR SH.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP)))
GROUP BY MC.NM_SYSDEF

SELECT ISNULL(MC.NM_SYSDEF, '') AS NM_TP_ITEM,
	   SUM(1) AS QT_CLAIM
FROM CZ_SA_CLAIMH CH
LEFT JOIN SA_SOH SH ON SH.CD_COMPANY = CH.CD_COMPANY AND SH.NO_SO = CH.NO_SO
LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
JOIN (SELECT CL.CD_COMPANY, CL.NO_CLAIM
	  FROM CZ_SA_CLAIML CL
	  LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = CL.CD_COMPANY AND MI.CD_ITEM = CL.CD_ITEM
	  WHERE (ISNULL(@P_CD_ITEMGRP, '') = '' OR MI.GRP_ITEM = @P_CD_ITEMGRP)
	  GROUP BY CL.CD_COMPANY, CL.NO_CLAIM) CL
ON CL.CD_COMPANY = CH.CD_COMPANY AND CL.NO_CLAIM = CH.NO_CLAIM
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = CH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00003' AND MC.CD_SYSDEF = CH.TP_ITEM
WHERE CH.CD_COMPANY = @P_CD_COMPANY
AND CH.DT_INPUT BETWEEN @P_DT_FROM AND @P_DT_TO
AND (ISNULL(@P_CD_PARTNER, '') = '' OR CH.CD_PARTNER IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_PARTNER)))
AND (ISNULL(@P_NO_IMO, '') = '' OR CH.NO_IMO = @P_NO_IMO)
AND (ISNULL(@P_NO_EMP, '') = '' OR CH.NO_EMP = @P_NO_EMP)
AND (ISNULL(@P_CD_SALEORG, '') = '' OR SG.CD_SALEORG = @P_CD_SALEORG)
AND (ISNULL(@P_CD_SALEGRP, '') = '' OR SH.CD_SALEGRP IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CD_SALEGRP)))
GROUP BY MC.NM_SYSDEF

GO