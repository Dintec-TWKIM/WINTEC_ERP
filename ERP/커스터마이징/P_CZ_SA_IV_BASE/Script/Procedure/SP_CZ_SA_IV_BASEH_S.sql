USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_IV_BASE_S]    Script Date: 2018-06-26 오후 2:13:34 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [NEOE].[SP_CZ_SA_IV_BASEH_S]  
(
    @P_CD_COMPANY			NVARCHAR(7),
	@P_TP_DATE			    NVARCHAR(3),
	@P_DT_FROM				NVARCHAR(8),
	@P_DT_TO				NVARCHAR(8),
	@P_CD_CC				NVARCHAR(12),
	@P_CD_PARTNER			NVARCHAR(20),
	@P_NO_PROJECT			NVARCHAR(20),
	@P_NO_IV				NVARCHAR(20),
	@P_YN_CONFIRM			NVARCHAR(1) = 'N',
	@P_YN_SALE_ACCT			NVARCHAR(1) = 'N'
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @P_AM_FSIZE		NUMERIC(3, 0)   -- 소수점

IF @P_CD_COMPANY = 'S100'
	SET @P_AM_FSIZE = 2
ELSE
	SET @P_AM_FSIZE = 0;

WITH A AS -- 프로젝트가 없는 청구등록 건
(
	SELECT SL.CD_COMPANY,
		   SL.NO_SO AS NO_PROJECT, 
		   SL.CD_PARTNER, 
		   SL.CD_CC, 
		   IL.NO_IV, 
		   IL.DT_PROCESS,
		   IL.NO_DOCU, 
		   IL.DT_ACCT, 
		   IL.ST_DOCU,
		   MAX(IL.CD_CC) AS CD_CC_IV,
		   ROUND(SUM(ISNULL(SL.UM_SO, 0) * ISNULL(IL.QT_IV, 0)), @P_AM_FSIZE) AS AM_SO,
		   SUM(IL.AM_SA_IV) AS AM_SA_IV,
		   SUM(IL.AM_SA_CHARGE) AS AM_SA_CHARGE,
		   0 AS AM_PO,
		   0 AS AM_PU_IV,
		   0 AS AM_PU_CHARGE,
		   0 AS AM_STOCK 
	FROM (SELECT SH.CD_COMPANY, SH.NO_SO, SL.SEQ_SO,
				 SH.CD_PARTNER, 
			     SG.CD_CC, 
			     SL.NO_PROJECT,
				 (ISNULL(SL.UM_SO, 0) * ISNULL(SH.RT_EXCH, 0)) AS UM_SO 
		  FROM SA_SOH SH 
		  LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
		  JOIN SA_SOL SL ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
		  WHERE SH.CD_COMPANY = @P_CD_COMPANY
		  AND ISNULL(SL.NO_PROJECT, '') = ''
		  AND (ISNULL(@P_NO_PROJECT, '') = '' OR SH.NO_SO = @P_NO_PROJECT)
		  AND (ISNULL(@P_CD_PARTNER, '') = '' OR SH.CD_PARTNER = @P_CD_PARTNER)
		  AND (ISNULL(@P_CD_CC, '') = '' OR SG.CD_CC = @P_CD_CC)) SL
	JOIN (SELECT IH.CD_COMPANY, IH.NO_IV, IH.DT_PROCESS,
			     FD.NO_DOCU, FD.DT_ACCT, FD.ST_DOCU,
			     IL.NO_SO, IL.NO_SOLINE, 
				 IL.QT_IV,
				 IL.AM_SA_IV,
				 IL.AM_SA_CHARGE,
				 IL.CD_CC
		  FROM SA_IVH IH
		  LEFT JOIN (SELECT FD.CD_COMPANY, FD.NO_DOCU, 
						    FD.NO_MDOCU,
						    FD.DT_ACCT, 
						    FD.ST_DOCU 
					 FROM FI_DOCU FD
					 GROUP BY FD.CD_COMPANY, FD.NO_DOCU, 
					 	      FD.NO_MDOCU, 
					 		  FD.DT_ACCT, 
					 		  FD.ST_DOCU) FD 
		  ON FD.CD_COMPANY = IH.CD_COMPANY AND FD.NO_MDOCU = IH.NO_IV
		  JOIN (SELECT IL.CD_COMPANY, IL.NO_IV,
					   IL.NO_SO, IL.NO_SOLINE,
					   MAX(IL.CD_CC) AS CD_CC,
				       SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.QT_CLS ELSE IL.QT_CLS END) ELSE 0 END) AS QT_IV,
				       SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) ELSE 0 END) AS AM_SA_IV,
				       SUM(CASE WHEN MI.CLS_ITEM = '010' OR MI.CLS_ITEM = '016' THEN (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) ELSE 0 END) AS AM_SA_CHARGE 
			    FROM SA_IVL IL
			    LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
			    LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = MI.CD_COMPANY AND CD.CD_FIELD = 'MA_B000010' AND CD.CD_SYSDEF = MI.CLS_ITEM
			    LEFT JOIN MA_AISPOSTL AL ON AL.CD_COMPANY = IL.CD_COMPANY AND AL.FG_TP = '100' AND AL.CD_TP = IL.TP_IV AND AL.FG_AIS = CD.CD_FLAG2
			    LEFT JOIN FI_ACCTCODE FA ON FA.CD_COMPANY = AL.CD_COMPANY AND FA.CD_ACCT = AL.CD_ACCT
			    WHERE (ISNULL(@P_YN_SALE_ACCT, 'N') = 'N' OR (FA.CD_ACGRP = '510' AND FA.YN_FILL = 'Y'))
			    GROUP BY IL.CD_COMPANY, IL.NO_IV,
					     IL.NO_SO, IL.NO_SOLINE) IL 
	      ON IL.CD_COMPANY = IH.CD_COMPANY AND IL.NO_IV = IH.NO_IV
	      WHERE (ISNULL(@P_NO_IV, '') = '' OR IH.NO_IV = @P_NO_IV)
	      AND (@P_TP_DATE <> '000' OR (IH.DT_PROCESS BETWEEN @P_DT_FROM AND @P_DT_TO))
	      AND (@P_TP_DATE <> '001' OR (FD.DT_ACCT BETWEEN @P_DT_FROM AND @P_DT_TO))
          AND (@P_YN_CONFIRM = 'N' OR FD.ST_DOCU = '2')) IL 
	ON IL.CD_COMPANY = SL.CD_COMPANY AND IL.NO_SO = SL.NO_SO AND IL.NO_SOLINE = SL.SEQ_SO
	GROUP BY SL.CD_COMPANY, SL.NO_SO, SL.CD_PARTNER, SL.CD_CC, 
		     IL.NO_IV, IL.DT_PROCESS,
		     IL.NO_DOCU, IL.DT_ACCT, IL.ST_DOCU 
),
B AS -- 프로젝트가 있는 청구등록 건
(
	SELECT SL.CD_COMPANY,
		   SL.NO_PROJECT, 
		   SL.CD_PARTNER, 
		   SL.CD_CC, 
		   IL.NO_IV, 
		   IL.DT_PROCESS,
		   IL.NO_DOCU, 
		   IL.DT_ACCT, 
		   IL.ST_DOCU,
		   MAX(IL.CD_CC) AS CD_CC_IV,
		   ROUND(SUM(ISNULL(SL.UM_SO, 0) * ISNULL(IL.QT_IV, 0)), @P_AM_FSIZE) AS AM_SO,
		   SUM(IL.AM_SA_IV) AS AM_SA_IV,
		   SUM(IL.AM_SA_CHARGE) AS AM_SA_CHARGE,
		   0 AS AM_PO,
		   0 AS AM_PU_IV,
		   0 AS AM_PU_CHARGE,
		   0 AS AM_STOCK  
    FROM (SELECT SH.CD_COMPANY, SH.NO_SO, SL.SEQ_SO,
		  	     SH.CD_PARTNER, 
			     SG.CD_CC, 
			     SL.NO_PROJECT,
		  	     (ISNULL(SL.UM_SO, 0) * ISNULL(SH.RT_EXCH, 0)) AS UM_SO 
		  FROM SA_SOH SH 
		  LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
	      JOIN SA_SOL SL ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
		  WHERE SH.CD_COMPANY = @P_CD_COMPANY
		  AND NOT EXISTS (SELECT 1 
						  FROM CZ_SA_QTNH QH
						  WHERE QH.CD_COMPANY = SH.CD_COMPANY
						  AND QH.NO_FILE = SH.NO_SO)
		  AND ISNULL(SL.NO_PROJECT, '') <> ''
		  AND (ISNULL(@P_NO_PROJECT, '') = '' OR SL.NO_PROJECT = @P_NO_PROJECT)
		  AND (ISNULL(@P_CD_PARTNER, '') = '' OR SH.CD_PARTNER = @P_CD_PARTNER)
		  AND (ISNULL(@P_CD_CC, '') = '' OR SG.CD_CC = @P_CD_CC)) SL
	JOIN (SELECT IH.CD_COMPANY, IH.NO_IV, IH.DT_PROCESS,
				 FD.NO_DOCU, FD.DT_ACCT, FD.ST_DOCU,
				 IL.NO_SO, IL.NO_SOLINE, 
		  		 IL.QT_IV,
		  		 IL.AM_SA_IV,
		  		 IL.AM_SA_CHARGE,
				 IL.CD_CC
		  FROM SA_IVH IH
		  LEFT JOIN (SELECT FD.CD_COMPANY, FD.NO_DOCU, 
							FD.NO_MDOCU,
							FD.DT_ACCT, 
							FD.ST_DOCU 
					 FROM FI_DOCU FD
					 GROUP BY FD.CD_COMPANY, FD.NO_DOCU, 
							  FD.NO_MDOCU, 
							  FD.DT_ACCT, 
							  FD.ST_DOCU) FD 
		  ON FD.CD_COMPANY = IH.CD_COMPANY AND FD.NO_MDOCU = IH.NO_IV
		  JOIN (SELECT IL.CD_COMPANY, IL.NO_IV,
					   IL.NO_SO, IL.NO_SOLINE, 
					   MAX(IL.CD_CC) AS CD_CC,
		  		       SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.QT_CLS ELSE IL.QT_CLS END) ELSE 0 END) AS QT_IV,
		  		       SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) ELSE 0 END) AS AM_SA_IV,
		  		       SUM(CASE WHEN MI.CLS_ITEM = '010' OR MI.CLS_ITEM = '016' THEN (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) ELSE 0 END) AS AM_SA_CHARGE 
				FROM SA_IVL IL
				LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
				LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = MI.CD_COMPANY AND CD.CD_FIELD = 'MA_B000010' AND CD.CD_SYSDEF = MI.CLS_ITEM
				LEFT JOIN MA_AISPOSTL AL ON AL.CD_COMPANY = IL.CD_COMPANY AND AL.FG_TP = '100' AND AL.CD_TP = IL.TP_IV AND AL.FG_AIS = CD.CD_FLAG2
				LEFT JOIN FI_ACCTCODE FA ON FA.CD_COMPANY = AL.CD_COMPANY AND FA.CD_ACCT = AL.CD_ACCT
				WHERE (ISNULL(@P_YN_SALE_ACCT, 'N') = 'N' OR (FA.CD_ACGRP = '510' AND FA.YN_FILL = 'Y'))
				GROUP BY IL.CD_COMPANY, IL.NO_IV,
					     IL.NO_SO, IL.NO_SOLINE) IL 
			ON IL.CD_COMPANY = IH.CD_COMPANY AND IL.NO_IV = IH.NO_IV
			WHERE (ISNULL(@P_NO_IV, '') = '' OR IH.NO_IV = @P_NO_IV)
			AND (@P_TP_DATE <> '000' OR (IH.DT_PROCESS BETWEEN @P_DT_FROM AND @P_DT_TO))
			AND (@P_TP_DATE <> '001' OR (FD.DT_ACCT BETWEEN @P_DT_FROM AND @P_DT_TO))
			AND (@P_YN_CONFIRM = 'N' OR FD.ST_DOCU = '2')) IL 
	ON IL.CD_COMPANY = SL.CD_COMPANY AND IL.NO_SO = SL.NO_SO AND IL.NO_SOLINE = SL.SEQ_SO
    GROUP BY SL.CD_COMPANY, SL.NO_PROJECT, SL.CD_PARTNER, SL.CD_CC, 
			 IL.NO_IV, IL.DT_PROCESS,
			 IL.NO_DOCU, IL.DT_ACCT, IL.ST_DOCU
),
C AS -- 수주등록 건 (지급등록 적용)
(
	SELECT SL.CD_COMPANY, 
		   SL.NO_PROJECT, 
		   SL.CD_PARTNER, 
		   SL.CD_CC, 
		   IL.NO_IV, 
		   IL.DT_PROCESS,
		   IL.NO_DOCU, 
		   IL.DT_ACCT, 
		   IL.ST_DOCU,
		   MAX(IL.CD_CC) AS CD_CC_IV,
	  	   SUM(ISNULL(SL.UM_SO, 0) * ISNULL(IL.QT_IV, 0)) AS AM_SO,
	  	   SUM(IL.AM_SA_IV) AS AM_SA_IV,
	  	   SUM(IL.AM_SA_CHARGE) AS AM_SA_CHARGE,
	  	   ROUND(SUM((ISNULL(SL.UM_PO, 0) + ISNULL(PC.UM_PO, 0)) * ISNULL(IL.QT_GIR, 0)), @P_AM_FSIZE) AS AM_PO,
	  	   ROUND(SUM((ISNULL(SL.UM_PU_IV, 0) + ISNULL(PC.UM_IV, 0)) * ISNULL(IL.QT_GIR, 0)), @P_AM_FSIZE) AS AM_PU_IV,
	  	   ROUND(SUM(CASE WHEN ISNULL(PC.UM_CHARGE, 0) > 0 THEN ISNULL(PC.UM_CHARGE, 0) * ISNULL(IL.QT_GIR, 0)
														   ELSE (ISNULL(SL.UM_PO_CHARGE, 0) + ISNULL(PC.UM_PO_CHARGE, 0)) * ISNULL(IL.QT_GIR, 0) END), @P_AM_FSIZE) AS AM_PU_CHARGE,
	  	   SUM(ISNULL(SL.UM_STOCK, 0) * ISNULL(IL.QT_GIR_STOCK, 0)) AS AM_STOCK
	FROM (SELECT SH.CD_COMPANY, SH.NO_SO, SL.SEQ_SO,
	  			 SH.CD_PARTNER, 
				 SG.CD_CC, 
				 ISNULL(CH.NO_SO, SH.NO_PROJECT) AS NO_PROJECT,
	  			 SL.UM_KR_S AS UM_SO,
	  			 SB.UM_KR AS UM_STOCK,
	  			 (CASE WHEN ISNULL(SL.QT_PO, 0) = 0 THEN 0 ELSE (ISNULL(PL.AM_PO, 0) / ISNULL(SL.QT_PO, 0)) END) AS UM_PO,
				 (CASE WHEN ISNULL(SL.QT_PO, 0) = 0 THEN 0 ELSE (ISNULL(PL.AM_PO_CHARGE, 0) / ISNULL(SL.QT_PO, 0)) END) AS UM_PO_CHARGE,
	  			 (CASE WHEN ISNULL(SL.QT_PO, 0) = 0 THEN 0 ELSE (ISNULL(PL.AM_IV, 0) / ISNULL(SL.QT_PO, 0)) END) AS UM_PU_IV
	  	  FROM SA_SOH SH
	  	  JOIN SA_SOL SL ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
		  LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
		  LEFT JOIN CZ_SA_CLAIMH CH ON CH.CD_COMPANY = SH.CD_COMPANY AND CH.NO_CLAIM = SH.NO_PROJECT
	  	  LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO
	  	  LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE,
							SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN PL.AM ELSE 0 END) AS AM_PO,
			   		   		SUM(CASE WHEN MI.CLS_ITEM = '010' OR MI.CLS_ITEM = '016' THEN PL.AM ELSE 0 END) AS AM_PO_CHARGE,
	  						SUM(IL.AM_IV) AS AM_IV 
	  				 FROM PU_POL PL
	  				 LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = PL.CD_COMPANY AND MI.CD_ITEM = PL.CD_ITEM
	  				 LEFT JOIN (SELECT IL.CD_COMPANY, IL.NO_PO, IL.NO_POLINE,
									   SUM(CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) AS AM_IV
	  							FROM PU_IVL IL
	  							LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
	  							WHERE MI.CLS_ITEM <> '010' 
								AND MI.CLS_ITEM <> '016'
								GROUP BY IL.CD_COMPANY, IL.NO_PO, IL.NO_POLINE) IL
	  				 ON IL.CD_COMPANY = PL.CD_COMPANY AND IL.NO_PO = PL.NO_PO AND IL.NO_POLINE = PL.NO_LINE
					 WHERE MI.CLS_ITEM <> '007'
	  				 GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE) PL
	  	  ON PL.CD_COMPANY = SL.CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.NO_SOLINE = SL.SEQ_SO
	  	  WHERE SH.CD_COMPANY = @P_CD_COMPANY
		  AND EXISTS (SELECT 1 
					  FROM CZ_SA_QTNH QH
					  WHERE QH.CD_COMPANY = SH.CD_COMPANY 
					  AND QH.NO_FILE = SH.NO_SO)
	  	  AND ISNULL(SH.NO_PROJECT, '') <> ''
		  AND (ISNULL(@P_NO_PROJECT, '') = '' OR ISNULL(CH.NO_SO, SH.NO_PROJECT) = @P_NO_PROJECT)
		  AND (ISNULL(@P_CD_PARTNER, '') = '' OR SH.CD_PARTNER = @P_CD_PARTNER)
		  AND (ISNULL(@P_CD_CC, '') = '' OR SG.CD_CC = @P_CD_CC)) SL
	JOIN (SELECT IH.CD_COMPANY, IH.NO_IV, IH.DT_PROCESS,
				 FD.NO_DOCU, FD.DT_ACCT, FD.ST_DOCU,
				 IL.NO_SO, IL.NO_SOLINE,
	  			 IL.QT_IV,
	  			 IL.AM_SA_IV,
	  			 IL.AM_SA_CHARGE,
				 IL.QT_GIR, 
				 IL.QT_GIR_STOCK,
				 IL.CD_CC
	  	  FROM SA_IVH IH
		  LEFT JOIN (SELECT FD.CD_COMPANY, FD.NO_DOCU, 
						    FD.NO_MDOCU,
						    FD.DT_ACCT, 
						    FD.ST_DOCU 
				     FROM FI_DOCU FD
				     GROUP BY FD.CD_COMPANY, FD.NO_DOCU, 
				     	      FD.NO_MDOCU, 
				     		  FD.DT_ACCT, 
				     		  FD.ST_DOCU) FD 
		  ON FD.CD_COMPANY = IH.CD_COMPANY AND FD.NO_MDOCU = IH.NO_IV
		  JOIN (SELECT IL.CD_COMPANY, IL.NO_IV,
					   IL.NO_SO, IL.NO_SOLINE, 
					   MAX(IL.CD_CC) AS CD_CC,
	  		           SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.QT_CLS ELSE IL.QT_CLS END) ELSE 0 END) AS QT_IV,
	  		           SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) ELSE 0 END) AS AM_SA_IV,
	  		           SUM(CASE WHEN MI.CLS_ITEM = '010' OR MI.CLS_ITEM = '016' THEN (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) ELSE 0 END) AS AM_SA_CHARGE,
					   SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN OL.QT_GIR ELSE 0 END) AS QT_GIR,
					   SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN OL.QT_GIR_STOCK ELSE 0 END) AS QT_GIR_STOCK 
			    FROM SA_IVL IL
			    LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
			    LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = MI.CD_COMPANY AND CD.CD_FIELD = 'MA_B000010' AND CD.CD_SYSDEF = MI.CLS_ITEM
			    LEFT JOIN MA_AISPOSTL AL ON AL.CD_COMPANY = IL.CD_COMPANY AND AL.FG_TP = '100' AND AL.CD_TP = IL.TP_IV AND AL.FG_AIS = CD.CD_FLAG2
			    LEFT JOIN FI_ACCTCODE FA ON FA.CD_COMPANY = AL.CD_COMPANY AND FA.CD_ACCT = AL.CD_ACCT
			    LEFT JOIN (SELECT OL.CD_COMPANY, OL.NO_IO, OL.NO_IOLINE,
			  				      SUM(CASE WHEN OH.YN_RETURN = 'Y' THEN -(ISNULL(GL.QT_GIR, 0) - ISNULL(RT.QT_IO, 0)) ELSE GL.QT_GIR END) AS QT_GIR,
			  				      SUM(CASE WHEN OH.YN_RETURN = 'Y' THEN -RT.QT_IO ELSE GL.QT_GIR_STOCK END) AS QT_GIR_STOCK
			  		       FROM MM_QTIOH OH
			  		       JOIN MM_QTIO OL ON OL.CD_COMPANY = OH.CD_COMPANY AND OL.NO_IO = OH.NO_IO
			  		       JOIN (SELECT CD_COMPANY, NO_GIR, SEQ_GIR,
			  			     			(ISNULL(QT_GIR, 0) - ISNULL(QT_GIR_STOCK, 0)) AS QT_GIR,
			  			     			QT_GIR_STOCK 
			  			     	 FROM SA_GIRL) GL 
			  		       ON GL.CD_COMPANY = OL.CD_COMPANY AND GL.NO_GIR = OL.NO_ISURCV AND GL.SEQ_GIR = OL.NO_ISURCVLINE
			  		       LEFT JOIN (SELECT CD_COMPANY, NO_IO_MGMT, NO_IOLINE_MGMT,
			  			     				 SUM(QT_IO) AS QT_IO 
			  			     		  FROM MM_QTIO
			  			     		  WHERE CD_QTIOTP = '400'
			  			     		  AND CD_SL = 'SL01'
			  			     		  GROUP BY CD_COMPANY, NO_IO_MGMT, NO_IOLINE_MGMT) RT 
			  		       ON RT.CD_COMPANY = OL.CD_COMPANY AND RT.NO_IO_MGMT = OL.NO_IO AND RT.NO_IOLINE_MGMT = OL.NO_IOLINE 
			  		       GROUP BY OL.CD_COMPANY, OL.NO_IO, OL.NO_IOLINE) OL
				ON OL.CD_COMPANY = IL.CD_COMPANY AND OL.NO_IO = IL.NO_IO AND OL.NO_IOLINE = IL.NO_IOLINE AND IL.QT_CLS > 0
				WHERE (ISNULL(@P_YN_SALE_ACCT, 'N') = 'N' OR (FA.CD_ACGRP = '510' AND FA.YN_FILL = 'Y'))
				GROUP BY IL.CD_COMPANY, IL.NO_IV,
					   IL.NO_SO, IL.NO_SOLINE) IL 
		  ON IL.CD_COMPANY = IH.CD_COMPANY AND IL.NO_IV = IH.NO_IV				
	WHERE (ISNULL(@P_NO_IV, '') = '' OR IH.NO_IV = @P_NO_IV)
	AND (@P_TP_DATE <> '000' OR (IH.DT_PROCESS BETWEEN @P_DT_FROM AND @P_DT_TO))
	AND (@P_TP_DATE <> '001' OR (FD.DT_ACCT BETWEEN @P_DT_FROM AND @P_DT_TO))
	AND (@P_YN_CONFIRM = 'N' OR FD.ST_DOCU = '2')) IL 
	ON IL.CD_COMPANY = SL.CD_COMPANY AND IL.NO_SO = SL.NO_SO AND IL.NO_SOLINE = SL.SEQ_SO
	LEFT JOIN (SELECT SL.CD_COMPANY, SL.NO_SO,
			   	      (CASE WHEN ISNULL(SL.QT_PO, 0) = 0 THEN 0 
			   										     ELSE (ISNULL(IL.AM_CHARGE, 0) / ISNULL(SL.QT_PO, 0)) END) AS UM_CHARGE,
					  (CASE WHEN ISNULL(SL.QT_PO, 0) = 0 THEN 0 
			   										     ELSE (ISNULL(PV.AM_PO, 0) / ISNULL(SL.QT_PO, 0)) END) AS UM_PO,
					  (CASE WHEN ISNULL(SL.QT_PO, 0) = 0 THEN 0 
			   										     ELSE (ISNULL(PV.AM_PO_CHARGE, 0) / ISNULL(SL.QT_PO, 0)) END) AS UM_PO_CHARGE,
					  (CASE WHEN ISNULL(SL.QT_PO, 0) = 0 THEN 0 
			   										     ELSE (ISNULL(PV.AM_IV, 0) / ISNULL(SL.QT_PO, 0)) END) AS UM_IV
	    	   FROM (SELECT CD_COMPANY, NO_SO,
			   			    SUM(QT_PO) AS QT_PO 
			   	     FROM SA_SOL
			   	     GROUP BY CD_COMPANY, NO_SO) SL
			   LEFT JOIN (SELECT IL.CD_COMPANY, IL.CD_PJT,
	    	   			         SUM(CASE WHEN IL.YN_RETURN = 'Y' THEN -AM_CLS ELSE AM_CLS END) AS AM_CHARGE  
			   	          FROM PU_IVL IL
	    	   	          JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM  		  		   
	    	   	          WHERE MI.CLS_ITEM = '010' 
			   	          OR MI.CLS_ITEM = '016'
			   	          GROUP BY IL.CD_COMPANY, IL.CD_PJT) IL
			   ON IL.CD_COMPANY = SL.CD_COMPANY AND IL.CD_PJT = SL.NO_SO
			   LEFT JOIN (SELECT PL.CD_COMPANY, PL.CD_PJT,
			   		   		     SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN PL.AM ELSE 0 END) AS AM_PO,
			   		   		     SUM(CASE WHEN MI.CLS_ITEM = '010' OR MI.CLS_ITEM = '016' THEN PL.AM ELSE 0 END) AS AM_PO_CHARGE,
			   		   		     SUM(IL.AM_IV) AS AM_IV
			   		      FROM PU_POL PL
			   		      LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = PL.CD_COMPANY AND MI.CD_ITEM = PL.CD_ITEM
			   		      LEFT JOIN (SELECT IL.CD_COMPANY, IL.NO_PO, IL.NO_POLINE,
			   		      				    SUM(CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) AS AM_IV
			   		      		     FROM PU_IVL IL
			   		      		     LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
			   		      			 WHERE MI.CLS_ITEM <> '010' 
			   		      			 AND MI.CLS_ITEM <> '016'
			   		      		     GROUP BY IL.CD_COMPANY, IL.NO_PO, IL.NO_POLINE) IL
			   		      ON IL.CD_COMPANY = PL.CD_COMPANY AND IL.NO_PO = PL.NO_PO AND IL.NO_POLINE = PL.NO_LINE
			   		      WHERE PL.NO_SO IS NULL
						  AND MI.CLS_ITEM <> '007'
			   		      GROUP BY PL.CD_COMPANY, PL.CD_PJT) PV
			   ON PV.CD_COMPANY = SL.CD_COMPANY AND PV.CD_PJT = SL.NO_SO) PC
	  ON PC.CD_COMPANY = SL.CD_COMPANY AND PC.NO_SO = SL.NO_SO
	  GROUP BY SL.CD_COMPANY, SL.NO_PROJECT, SL.CD_PARTNER, SL.CD_CC, 
			   IL.NO_IV, IL.DT_PROCESS,
			   IL.NO_DOCU, IL.DT_ACCT, IL.ST_DOCU
),
D AS -- 프로젝트가 있는 청구등록 건 매입금액 (지급등록 적용)
(   SELECT B.CD_COMPANY, 
		   B.NO_PROJECT, 
		   NULL AS CD_PARTNER, 
		   NULL AS CD_CC, 
		   NULL AS NO_IV, 
		   NULL AS DT_PROCESS,
		   NULL AS NO_DOCU, 
		   NULL AS DT_ACCT, 
		   NULL AS ST_DOCU,
		   B.CD_CC AS CD_CC_IV,
	  	   NULL AS AM_SO,
	  	   NULL AS AM_SA_IV,
	  	   NULL AS AM_SA_CHARGE,
	  	   (ISNULL(SH.AM_PO, 0) + ISNULL(PV.AM_PO, 0)) AS AM_PO,
	  	   (ISNULL(SH.AM_IV, 0) + ISNULL(PV.AM_IV, 0)) AS AM_PU_IV,
	  	   (CASE WHEN ISNULL(PC.AM_CHARGE, 0) > 0 THEN ISNULL(PC.AM_CHARGE, 0)
												  ELSE (ISNULL(SH.AM_PO_CHARGE, 0) + ISNULL(PV.AM_PO_CHARGE, 0)) END) AS AM_PU_CHARGE,
	  	   SH.AM_STOCK AS AM_STOCK
    FROM (SELECT SL.CD_COMPANY,
				 SL.NO_PROJECT,
				 MAX(IL.CD_CC) AS CD_CC
		  FROM (SELECT SH.CD_COMPANY, SH.NO_SO, SL.SEQ_SO,
			           SL.NO_PROJECT
		        FROM SA_SOH SH
		        LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
	            JOIN SA_SOL SL ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
		        WHERE SH.CD_COMPANY = @P_CD_COMPANY
		        AND NOT EXISTS (SELECT 1 
							    FROM CZ_SA_QTNH QH
								WHERE QH.CD_COMPANY = SH.CD_COMPANY
								AND QH.NO_FILE = SH.NO_SO)
		        AND ISNULL(SL.NO_PROJECT, '') <> ''
		        AND (ISNULL(@P_NO_PROJECT, '') = '' OR SL.NO_PROJECT = @P_NO_PROJECT)
		        AND (ISNULL(@P_CD_PARTNER, '') = '' OR SH.CD_PARTNER = @P_CD_PARTNER)
		        AND (ISNULL(@P_CD_CC, '') = '' OR SG.CD_CC = @P_CD_CC)) SL
		  JOIN (SELECT IH.CD_COMPANY, IL.NO_SO, IL.NO_SOLINE,
					   IL.CD_CC
				FROM SA_IVH IH
				LEFT JOIN (SELECT FD.CD_COMPANY, FD.NO_DOCU, 
							      FD.NO_MDOCU,
								  FD.DT_ACCT,
							      FD.ST_DOCU 
					       FROM FI_DOCU FD
					       GROUP BY FD.CD_COMPANY, FD.NO_DOCU, 
					       		    FD.NO_MDOCU, 
					       		    FD.DT_ACCT,
									FD.ST_DOCU) FD 
			    ON FD.CD_COMPANY = IH.CD_COMPANY AND FD.NO_MDOCU = IH.NO_IV
				JOIN (SELECT IL.CD_COMPANY, IL.NO_IV, IL.NO_SO, IL.NO_SOLINE,
						     MAX(IL.CD_CC) AS CD_CC,
							 SUM(CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.QT_CLS ELSE IL.QT_CLS END) AS QT_IV 
					  FROM SA_IVL IL
				      LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
				      LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = MI.CD_COMPANY AND CD.CD_FIELD = 'MA_B000010' AND CD.CD_SYSDEF = MI.CLS_ITEM
				      LEFT JOIN MA_AISPOSTL AL ON AL.CD_COMPANY = IL.CD_COMPANY AND AL.FG_TP = '100' AND AL.CD_TP = IL.TP_IV AND AL.FG_AIS = CD.CD_FLAG2
				      LEFT JOIN FI_ACCTCODE FA ON FA.CD_COMPANY = AL.CD_COMPANY AND FA.CD_ACCT = AL.CD_ACCT
				      WHERE (ISNULL(@P_YN_SALE_ACCT, 'N') = 'N' OR (FA.CD_ACGRP = '510' AND FA.YN_FILL = 'Y'))
				      GROUP BY IL.CD_COMPANY, IL.NO_IV, IL.NO_SO, IL.NO_SOLINE) IL 
				ON IL.CD_COMPANY = IH.CD_COMPANY AND IL.NO_IV = IH.NO_IV
			    WHERE IL.QT_IV > 0
				AND (ISNULL(@P_NO_IV, '') = '' OR IH.NO_IV = @P_NO_IV)
			    AND (@P_TP_DATE <> '000' OR (IH.DT_PROCESS BETWEEN @P_DT_FROM AND @P_DT_TO))
			    AND (@P_TP_DATE <> '001' OR (FD.DT_ACCT BETWEEN @P_DT_FROM AND @P_DT_TO))
			    AND (@P_YN_CONFIRM = 'N' OR FD.ST_DOCU = '2')) IL 
		  ON IL.CD_COMPANY = SL.CD_COMPANY AND IL.NO_SO = SL.NO_SO AND IL.NO_SOLINE = SL.SEQ_SO
		  GROUP BY SL.CD_COMPANY, SL.NO_PROJECT) B
	LEFT JOIN (SELECT SH.CD_COMPANY, SH.NO_SO,
			   	      SUM(PL.AM_PO) AS AM_PO,
					  SUM(PL.AM_PO_CHARGE) AS AM_PO_CHARGE,
			   	      SUM(PL.AM_IV) AS AM_IV,
			   	      SUM(ISNULL(SB.QT_STOCK, 0) * ISNULL(SB.UM_KR, 0)) AS AM_STOCK 
			   FROM SA_SOH SH
			   LEFT JOIN SA_SOL SL ON SL.CD_COMPANY = SH.CD_COMPANY AND SL.NO_SO = SH.NO_SO
			   LEFT JOIN CZ_SA_STOCK_BOOK SB ON SB.CD_COMPANY = SL.CD_COMPANY AND SB.NO_FILE = SL.NO_SO AND SB.NO_LINE = SL.SEQ_SO
			   LEFT JOIN (SELECT PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE,
	  		   		 			 SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN PL.AM ELSE 0 END) AS AM_PO,
								 SUM(CASE WHEN MI.CLS_ITEM = '010' OR MI.CLS_ITEM = '016' THEN PL.AM ELSE 0 END) AS AM_PO_CHARGE,
	  		   		 			 SUM(IL.AM_IV) AS AM_IV 
	  		   			  FROM PU_POL PL
	  		   			  LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = PL.CD_COMPANY AND MI.CD_ITEM = PL.CD_ITEM
	  		   			  LEFT JOIN (SELECT IL.CD_COMPANY, IL.NO_PO, IL.NO_POLINE,
			   			  				    SUM(CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) AS AM_IV
	  		   			  		     FROM PU_IVL IL
	  		   			  		     LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
	  		   			  		     WHERE MI.CLS_ITEM <> '010' 
			   			  		     AND MI.CLS_ITEM <> '016'
			   			  		     GROUP BY IL.CD_COMPANY, IL.NO_PO, IL.NO_POLINE) IL
	  		   			  ON IL.CD_COMPANY = PL.CD_COMPANY AND IL.NO_PO = PL.NO_PO AND IL.NO_POLINE = PL.NO_LINE
						  WHERE MI.CLS_ITEM <> '007'
	  		   			  GROUP BY PL.CD_COMPANY, PL.NO_SO, PL.NO_SOLINE) PL
	  		   ON PL.CD_COMPANY = SL.CD_COMPANY AND PL.NO_SO = SL.NO_SO AND PL.NO_SOLINE = SL.SEQ_SO
			   WHERE NOT EXISTS (SELECT 1 
								 FROM SA_IVL IL
								 WHERE IL.CD_COMPANY = SL.CD_COMPANY
								 AND IL.NO_SO = SL.NO_SO
								 AND IL.NO_SOLINE = SL.SEQ_SO)
			   GROUP BY SH.CD_COMPANY, SH.NO_SO) SH
	ON SH.CD_COMPANY = B.CD_COMPANY AND SH.NO_SO = B.NO_PROJECT
	LEFT JOIN (SELECT PL.CD_COMPANY, PL.CD_PJT,
			   	      SUM(CASE WHEN MI.CLS_ITEM <> '010' AND MI.CLS_ITEM <> '016' THEN PL.AM ELSE 0 END) AS AM_PO,
			   	      SUM(CASE WHEN MI.CLS_ITEM = '010' OR MI.CLS_ITEM = '016' THEN PL.AM ELSE 0 END) AS AM_PO_CHARGE,
			   	      SUM(IL.AM_IV) AS AM_IV
			   FROM PU_POL PL
			   LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = PL.CD_COMPANY AND MI.CD_ITEM = PL.CD_ITEM
			   LEFT JOIN (SELECT IL.CD_COMPANY, IL.NO_PO, IL.NO_POLINE,
			   				     SUM(CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) AS AM_IV
			   		     FROM PU_IVL IL
			   		     LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
						 WHERE MI.CLS_ITEM <> '010' 
			   			 AND MI.CLS_ITEM <> '016'
			   		     GROUP BY IL.CD_COMPANY, IL.NO_PO, IL.NO_POLINE) IL
			   ON IL.CD_COMPANY = PL.CD_COMPANY AND IL.NO_PO = PL.NO_PO AND IL.NO_POLINE = PL.NO_LINE
			   WHERE MI.CLS_ITEM <> '007'
			   AND PL.NO_SO IS NULL
			   GROUP BY PL.CD_COMPANY, PL.CD_PJT) PV
	ON PV.CD_COMPANY = B.CD_COMPANY AND PV.CD_PJT = B.NO_PROJECT
	LEFT JOIN (SELECT IL.CD_COMPANY, IL.CD_PJT,
	                  SUM(CASE WHEN IL.YN_RETURN = 'Y' THEN -AM_CLS ELSE AM_CLS END) AS AM_CHARGE
		  	   FROM PU_IVL IL
		       JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM  		  		   
		       WHERE (MI.CLS_ITEM = '010' OR MI.CLS_ITEM = '016')
		  	   GROUP BY IL.CD_COMPANY, IL.CD_PJT) PC
    ON PC.CD_COMPANY = B.CD_COMPANY AND PC.CD_PJT = B.NO_PROJECT
),
SH AS
(
	SELECT SH.CD_COMPANY,
		   SH.NO_PROJECT,
		   MAX(SH.CD_PARTNER) AS CD_PARTNER, 
		   MAX(SH.CD_CC) AS CD_CC, 
		   MAX(SH.NO_IV) AS NO_IV, 
		   MAX(SH.DT_PROCESS) AS DT_PROCESS,
		   MAX(SH.NO_DOCU) AS NO_DOCU, 
		   MAX(SH.DT_ACCT) AS DT_ACCT, 
		   MAX(SH.ST_DOCU) AS ST_DOCU,
		   MAX(SH.CD_CC_IV) AS CD_CC_IV,
		   COUNT(DISTINCT SH.NO_IV) AS QT_IV,
		   SUM(SH.AM_SO) AS AM_SO,
		   SUM(SH.AM_SA_IV) AS AM_SA_IV,
		   SUM(SH.AM_SA_CHARGE) AS AM_SA_CHARGE,
		   SUM(SH.AM_PO) AS AM_PO,
		   SUM(SH.AM_PU_IV) AS AM_PU_IV,
		   SUM(SH.AM_PU_CHARGE) AS AM_PU_CHARGE,
		   SUM(SH.AM_STOCK) AS AM_STOCK,
		   SUM(ISNULL(SH.AM_SA_IV, 0) + ISNULL(SH.AM_SA_CHARGE, 0)) AS AM_SA_TOTAL,
		   SUM(CASE WHEN ABS(ISNULL(SH.AM_PO, 0)) > ABS(ISNULL(SH.AM_PU_IV, 0) + ISNULL(SH.AM_PU_CHARGE, 0)) THEN (ISNULL(SH.AM_PO, 0) + ISNULL(SH.AM_STOCK, 0))
																							                 ELSE (ISNULL(SH.AM_PU_IV, 0) + ISNULL(SH.AM_PU_CHARGE, 0) + ISNULL(SH.AM_STOCK, 0)) END) AS AM_PU_TOTAL
	FROM (SELECT * FROM A
		  UNION ALL
		  SELECT * FROM B 
		  UNION ALL
		  SELECT * FROM C
		  UNION ALL
		  SELECT * FROM D) SH
	GROUP BY SH.CD_COMPANY, SH.NO_PROJECT
)
SELECT SH.NO_PROJECT,
	   SH.NO_IV,
	   SH.QT_IV,
	   SH.NO_DOCU,
	   SH.CD_PARTNER,
	   MP.LN_PARTNER,
	   SH.DT_PROCESS,
	   SH.DT_ACCT,
	   SH.ST_DOCU,
	   SH.CD_CC_IV,
	   SH.CD_CC,
	   MC.NM_CC,
	   SH.AM_SO,
	   SH.AM_SA_IV,
	   SH.AM_SA_CHARGE,
	   SH.AM_PO,
	   SH.AM_PU_IV,
	   SH.AM_PU_CHARGE,
	   SH.AM_STOCK,
	   SH.AM_SA_TOTAL,
	   SH.AM_PU_TOTAL,
	   (ISNULL(SH.AM_SA_TOTAL, 0) - ISNULL(SH.AM_PU_TOTAL, 0)) AS AM_PROFIT,
	   ROUND(CASE WHEN ISNULL(SH.AM_SA_TOTAL, 0) = 0 THEN 0
													 ELSE ((ISNULL(SH.AM_SA_TOTAL, 0) - ISNULL(SH.AM_PU_TOTAL, 0)) / ISNULL(SH.AM_SA_TOTAL, 0)) * 100 END, 2) AS RT_PROFIT
FROM SH
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = SH.CD_COMPANY AND MP.CD_PARTNER = SH.CD_PARTNER
LEFT JOIN MA_CC MC ON MC.CD_COMPANY = SH.CD_COMPANY AND MC.CD_CC = SH.CD_CC

GO

