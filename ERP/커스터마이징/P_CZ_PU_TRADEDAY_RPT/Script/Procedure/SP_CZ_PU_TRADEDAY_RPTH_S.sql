USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PU_TRADEDAY_RPTH_S]    Script Date: 2015-05-20 오후 3:30:54 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_PU_TRADEDAY_RPTH_S]        
(        
	 @P_CD_PLANT	    NVARCHAR(7),        
	 @P_CD_COMPANY		NVARCHAR(7),
	 @P_LANGUAGE		NVARCHAR(5) = 'KR',        
	 @P_CD_ITEM_FROM	NVARCHAR(20),        
	 @P_CD_ITEM_TO		NVARCHAR(20),        
	 @P_MULTI_CD_SL		VARCHAR(8000), 
	 @P_DT_FROM			NVARCHAR(8),        
	 @P_DT_TO			NVARCHAR(8),        
	 @P_CLS_ITEM		NVARCHAR(4000),
	 @P_ITEM_CHECK		NVARCHAR(1) = 'Y',
	 @P_SL_CHECK	    NVARCHAR(1) = 'N', 
	 @P_YN_ZERO			NVARCHAR(1) = 'N',
	 @P_CD_PJT			NVARCHAR(20) = NULL,
	 @P_CD_ITEMGRP      NVARCHAR(20)
)
AS        
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
     
DECLARE @V_EXC_CLS_YN  NVARCHAR(3)

SELECT @V_EXC_CLS_YN = CD_EXC  
FROM MA_EXC 
WHERE CD_COMPANY = @P_CD_COMPANY 
AND EXC_TITLE = '재고현황_비수불계정포함여부';

SET @V_EXC_CLS_YN = (CASE WHEN ISNULL(@V_EXC_CLS_YN,'') = '' THEN '000' ELSE @V_EXC_CLS_YN END)

BEGIN
SELECT DISTINCT L.CD_ITEM,
			    M.NM_ITEM,
				M.STND_ITEM,
				M.UNIT_IM,
				M.CLS_ITEM,
				ME.NM_KOR AS NM_MANAGER1,
				ME1.NM_KOR AS NM_MANAGER2,
				MI.NM_ITEMGRP,  --2011.05.16 품목군 추가(최규원) 
				(CASE WHEN M.FG_SERNO = '001' THEN 'NO' 
											  ELSE (SELECT ISNULL((CASE @P_LANGUAGE WHEN 'KR' THEN NM_SYSDEF
																				    WHEN 'US' THEN NM_SYSDEF_E
																				    WHEN 'JP' THEN NM_SYSDEF_JP
																				    WHEN 'CH' THEN NM_SYSDEF_CH END), '')
													FROM MA_CODEDTL
													WHERE CD_COMPANY = M.CD_COMPANY
													AND CD_FIELD = 'MA_B000015'
													AND CD_SYSDEF = M.FG_SERNO) END) FG_SERNO, -- S/N,LOT관리 컬럼추가 2011.05.16 (최규원)   미관리를 영문화작업으로 인해 NO 바꿈
				M.NO_DESIGN,
				M.STND_DETAIL_ITEM,
				M.MAT_ITEM,
				M.STAND_PRC
FROM (SELECT CD_ITEM, 
			 CD_COMPANY,
			 CD_PLANT
      FROM MM_OPENQTL        
      WHERE (CD_ITEM >= @P_CD_ITEM_FROM OR @P_CD_ITEM_FROM = '' OR @P_CD_ITEM_FROM IS NULL)        
      AND (CD_ITEM <= @P_CD_ITEM_TO OR @P_CD_ITEM_TO = '' OR @P_CD_ITEM_TO IS NULL)        
      AND YM_STANDARD = SUBSTRING(@P_DT_FROM, 1, 4) + '00'        
      AND CD_COMPANY = @P_CD_COMPANY        
      AND CD_PLANT = @P_CD_PLANT        
      AND (ISNULL(@P_MULTI_CD_SL, '') = '' OR CD_SL IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CD_SL)))   
      AND (ISNULL(@P_CD_PJT, '') = '' OR CD_PJT = @P_CD_PJT)
	  AND (QT_GOOD_INV <> 0 OR QT_REJECT_INV <> 0 AND QT_TRANS_INV <> 0 OR QT_INSP_INV  <> 0 )    
      UNION ALL         
      SELECT CD_ITEM,
			 M.CD_COMPANY,
		     CD_PLANT   
      FROM MM_OHSLINVM M 
	  LEFT JOIN MM_EJTP E ON E.CD_QTIOTP = M.CD_QTIOTP AND E.CD_COMPANY = M.CD_COMPANY        
      WHERE CD_PLANT = @P_CD_PLANT        
      AND M.CD_COMPANY = @P_CD_COMPANY
      AND (CD_SL IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CD_SL)) OR @P_MULTI_CD_SL = '' OR @P_MULTI_CD_SL IS NULL)  
      AND (CD_ITEM >= @P_CD_ITEM_FROM OR @P_CD_ITEM_FROM = '' OR @P_CD_ITEM_FROM IS NULL)        
      AND (CD_ITEM <= @P_CD_ITEM_TO OR @P_CD_ITEM_TO = '' OR @P_CD_ITEM_TO IS NULL)         
      AND YM_IO >= SUBSTRING(@P_DT_FROM,1,4) + '01' --200301        
      AND YM_IO <  SUBSTRING(@P_DT_FROM,1,6)  --200304        
      AND (QT_GOOD_GR <> 0 OR QT_GOOD_GI <> 0 OR QT_REJECT_GR <> 0 OR QT_REJECT_GI <> 0 OR QT_TRANS_GR <> 0 OR QT_TRANS_GI  <> 0 OR QT_INSP_GR  <> 0 OR QT_INSP_GI <> 0)   
	  AND (CD_PJT = @P_CD_PJT OR @P_CD_PJT = '' OR @P_CD_PJT IS NULL)
	  AND ((@P_SL_CHECK = 'Y' AND FG_IO <> '022') OR (@P_SL_CHECK = 'N')) 
      UNION ALL        
      SELECT L.CD_ITEM,
			 H.CD_COMPANY,
			 L.CD_PLANT   
      FROM MM_QTIOH H 
	  JOIN MM_QTIO L ON H.NO_IO = L.NO_IO AND H.CD_COMPANY = L.CD_COMPANY            
      WHERE H.CD_COMPANY =@P_CD_COMPANY        
      AND L.CD_PLANT = @P_CD_PLANT       
      AND (L.FG_PS = '1' OR L.FG_PS = '2')  
      AND L.DT_IO BETWEEN SUBSTRING(@P_DT_FROM, 1, 4) + '0101' AND @P_DT_TO        
      AND (L.CD_ITEM >= @P_CD_ITEM_FROM OR @P_CD_ITEM_FROM = '' OR @P_CD_ITEM_FROM IS NULL)        
      AND (L.CD_ITEM <= @P_CD_ITEM_TO OR @P_CD_ITEM_TO = '' OR @P_CD_ITEM_TO IS NULL)
      AND (ISNULL(@P_MULTI_CD_SL, '') = '' OR L.CD_SL IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CD_SL)))   
	  AND (ISNULL(@P_CD_PJT, '') = '' OR L.CD_PJT = @P_CD_PJT)     
      AND (L.QT_GOOD_INV <> 0 OR L.QT_REJECT_INV <> 0 OR L.QT_TRANS_INV <> 0 OR L.QT_INSP_INV <> 0 )
      AND ((@P_SL_CHECK = 'Y' AND L.FG_IO <> '022') OR (@P_SL_CHECK = 'N'))) L     
LEFT JOIN MA_PITEM M ON M.CD_COMPANY = L.CD_COMPANY AND M.CD_PLANT = L.CD_PLANT AND M.CD_ITEM = L.CD_ITEM    --AND M.YN_USE =  'Y'       
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = M.CD_COMPANY AND ME.NO_EMP = M.NO_MANAGER1  
LEFT JOIN MA_EMP ME1 ON ME1.CD_COMPANY = M.CD_COMPANY AND ME1.NO_EMP = M.NO_MANAGER2    
LEFT JOIN MA_ITEMGRP MI ON  MI.CD_COMPANY = M.CD_COMPANY AND MI.USE_YN = 'Y' AND  MI.CD_ITEMGRP = M.GRP_ITEM             -- 2011.05.16 (최규원)
WHERE (M.CLS_ITEM IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CLS_ITEM)) OR @P_CLS_ITEM = '' OR @P_CLS_ITEM IS NULL)     
AND ((@V_EXC_CLS_YN = '000' AND (M.CLS_ITEM IN ('001', '002', '003', '004', '005', '009'))) OR(@V_EXC_CLS_YN = '100')) --20090506 수불계정만 해당하게   
AND ((@P_ITEM_CHECK = 'Y' AND M.YN_USE = @P_ITEM_CHECK) OR (@P_ITEM_CHECK = 'N'))
AND (M.GRP_ITEM = @P_CD_ITEMGRP OR @P_CD_ITEMGRP = '' OR @P_CD_ITEMGRP IS NULL)

END
GO

