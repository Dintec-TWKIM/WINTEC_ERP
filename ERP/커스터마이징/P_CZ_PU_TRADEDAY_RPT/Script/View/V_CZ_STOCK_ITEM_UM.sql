USE [NEOE]
GO

/****** Object:  View [NEOE].[V_CZ_STOCK_ITEM_UM]    Script Date: 2015-09-07 오후 3:26:17 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER VIEW [NEOE].[V_CZ_STOCK_ITEM_UM]
AS

SELECT MI.CD_COMPANY,
	   MI.CD_PLANT,
	   MI.CD_ITEM,
	   ISNULL((CASE WHEN MI.STAND_PRC = 0 THEN (SELECT TOP 1 A.UM_BAS
												FROM (SELECT AH.DT_INPUT + SUBSTRING(AH.DTS_INSERT, 9, 6) AS DT_INPUT, AL.CD_COMPANY, AL.CD_PLANT, AL.CD_ITEM, AL.UM_BAS 
													  FROM MM_AMINVL AL
													  LEFT JOIN MM_AMINVH AH ON AH.CD_COMPANY = AL.CD_COMPANY AND AH.CD_PLANT = AL.CD_PLANT AND AH.YM_STANDARD = AL.YM_STANDARD
													  WHERE ISNULL(AL.UM_BAS, 0) <> 0
													  UNION ALL
													  SELECT QH.DT_IO + SUBSTRING(QH.DTS_INSERT, 9, 6), QD.CD_COMPANY, QD.CD_PLANT, QD.CD_ITEM, QD.UM_STOCK 
													  FROM CZ_MM_QTIO_DETAIL QD
													  LEFT JOIN MM_QTIOH QH ON QH.CD_COMPANY = QD.CD_COMPANY AND QH.NO_IO = QD.NO_IO
													  WHERE ISNULL(QD.UM_STOCK, 0) <> 0) A
												WHERE A.CD_COMPANY = MI.CD_COMPANY
												AND A.CD_PLANT = MI.CD_PLANT
												AND A.CD_ITEM = MI.CD_ITEM
												ORDER BY A.DT_INPUT) 
										  ELSE MI.STAND_PRC END), 0) AS STAND_PRC
FROM MA_PITEM MI

GO

