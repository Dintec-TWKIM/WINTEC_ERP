USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_HR_EMP_WORK_TIME_RPT_MONTH_S]    Script Date: 2015-11-17 오전 10:07:39 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

  
ALTER PROCEDURE [NEOE].[SP_CZ_HR_EMP_WORK_TIME_RPT_MONTH_S]  
(  
	@P_CD_COMPANY	NVARCHAR(7),
	@P_DT_MONTH		NVARCHAR(6),
	@P_NO_EMP		NVARCHAR(10),
	@P_QT_INTERVAL	INT
)  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT MU.NO_EMP,
	   UL.DT_WORK,
	   UL.DT_TIME,
	   UL.PAGE_ID,
	   UL.PAGE_NAME,
	   UL.IP,
	   CD.NM_SYSDEF,
	   (CASE WHEN DATEDIFF(MINUTE, LAG(UL.DT_TIME) OVER (PARTITION BY UL.CD_COMPANY, UL.DT_WORK, UL.ID_USER ORDER BY UL.DT_TIME), UL.DT_TIME) <= @P_QT_INTERVAL THEN DATEDIFF(MINUTE, LAG(UL.DT_TIME) OVER (PARTITION BY UL.CD_COMPANY, UL.DT_WORK, UL.ID_USER ORDER BY UL.DT_TIME), UL.DT_TIME)
																																								ELSE 0 END) AS DT_WORK_MINUTE,
	   (CASE WHEN DATEDIFF(MINUTE, LAG(UL.DT_TIME) OVER (PARTITION BY UL.CD_COMPANY, UL.DT_WORK, UL.ID_USER ORDER BY UL.DT_TIME), UL.DT_TIME) <= @P_QT_INTERVAL THEN 'Y' 
																																								ELSE 'N' END) AS YN_WORK
FROM MA_USER MU
JOIN CZ_MA_USER_LOG UL ON UL.CD_COMPANY = MU.CD_COMPANY AND UL.ID_USER = MU.ID_USER AND UL.DT_WORK LIKE @P_DT_MONTH + '%'
LEFT JOIN MA_CODEDTL CD ON CD.CD_COMPANY = UL.CD_COMPANY AND CD.CD_FIELD = 'MA_B000200' AND CD.CD_SYSDEF = UL.FLAG
WHERE MU.CD_COMPANY = @P_CD_COMPANY
AND MU.NO_EMP = @P_NO_EMP
ORDER BY UL.DT_TIME

GO