USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_GIR_HISTORYH_S]    Script Date: 2017-01-12 오후 2:51:12 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





ALTER PROCEDURE [NEOE].[SP_CZ_SA_GIR_HISTORYH_S]  
(  
	@P_CD_COMPANY		NVARCHAR(7),
	@P_DT_DELETE_FROM	NVARCHAR(8),
	@P_DT_DELETE_TO		NVARCHAR(8),
	@P_NO_GIR			NVARCHAR(20),
	@P_NO_SO			NVARCHAR(20),
	@P_CD_ITEM			NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT DT_CAL INTO #MA_CALENDAR
FROM MA_CALENDAR
WHERE CD_COMPANY = @P_CD_COMPANY
AND FG1_HOLIDAY = 'W'
ORDER BY DT_CAL

SELECT GH.CD_COMPANY,
	   CP.NM_COMPANY,
	   GH.TP_GIR,
	   MC.NM_SYSDEF AS NM_TP_GIR,
	   GH.NO_GIR,
	   GH.NO_HST,
	   GD.NO_GIREQ,
	   GH.DT_GIR,
	   GD.DT_START,
	   GD.DT_COMPLETE,
	   GD.DT_BILL,
	   GD.CD_MAIN_CATEGORY,
	   MC1.NM_SYSDEF AS NM_MAIN_CATEGORY,
	   GD.CD_SUB_CATEGORY,
	   MC2.NM_SYSDEF AS NM_SUB_CATEGORY,
	   GD.YN_PACKING,
	   GD.YN_TAX_RETURN,
	   (CASE WHEN SUBSTRING(GD.DTS_SUBMIT, 1, 8) = SUBSTRING(GD.DT_COMPLETE, 1, 8) THEN 'Y'
			 WHEN (SUBSTRING(GD.DTS_SUBMIT, 9, 2) >= 16 OR 
			 	   (GD.CD_MAIN_CATEGORY = '001' OR (GD.CD_MAIN_CATEGORY = '002' AND GD.CD_SUB_CATEGORY = 'DIR'))) AND 
			 	   SUBSTRING(GD.DT_COMPLETE, 1, 8) <= (SELECT TOP 1 DT_CAL 
													   FROM #MA_CALENDAR
													   WHERE DT_CAL > SUBSTRING(GD.DTS_SUBMIT, 1, 8)) THEN 'Y'
			 ELSE 'N' END) AS YN_URGENT,
	   GD.YN_AUTO_SUBMIT,
	   GH.STA_GIR,
	   MC3.NM_SYSDEF AS NM_STA_GIR,
	   (CASE WHEN GH.TP_GIR = '001' THEN GD.DT_LOADING + '000000' ELSE GD.DT_PACKING END) AS DT_DONE,
	   GH.NO_EMP,
	   ME.NM_KOR AS NM_EMP,
	   GD.NO_IMO,
	   MH.NM_VESSEL,
	   GD.NO_IMO_BILL,
	   MH1.NM_VESSEL AS NM_VESSEL_BILL,
	   GH.CD_PARTNER,
	   MP.LN_PARTNER AS NM_PARTNER,
	   GD.CD_DELIVERY_TO,
	   MP1.LN_PARTNER AS NM_DELIVERY_TO,
	   TH.ARRIVER_COUNTRY,
	   MC4.NM_SYSDEF AS NM_ARRIVER_COUNTRY,
	   GH.YN_RETURN,
	   MC5.NM_SYSDEF AS NM_RETURN,
	   GD.DC_RMK1,
	   GD.DC_RMK2,
	   GD.DC_RMK3,
	   GD.DC_RMK4,
	   GD.DC_RMK5,
	   GD.CD_RMK,
	   MC6.NM_SYSDEF AS NM_RMK,
	   GD.TP_CHARGE,
	   GH.DC_RMK,
	   GD.DC_RESULT,
	   GD.DTS_INSERT,
	   GD.DTS_UPDATE,
	   GD.DTS_SUBMIT,
	   GD.DTS_CONFIRM,
	   GH.DTS_DELETE,
	   GH.ID_DELETE,
	   MU.NM_USER AS NM_DELETE
FROM CZ_SA_GIRH_LOG GH
JOIN (SELECT CD_COMPANY, TP_GIR, NO_GIR, NO_HST,
	  		 MAX(NO_INV) AS NO_INV
	  FROM CZ_SA_GIRL_LOG
	  WHERE (ISNULL(@P_NO_SO, '') = '' OR NO_SO = @P_NO_SO)
	  AND (ISNULL(@P_CD_ITEM, '') = '' OR CD_ITEM = @P_CD_ITEM)
	  GROUP BY CD_COMPANY, TP_GIR, NO_GIR, NO_HST) GL
ON GL.CD_COMPANY = GH.CD_COMPANY AND GL.TP_GIR = GH.TP_GIR AND GL.NO_GIR = GH.NO_GIR AND GL.NO_HST = GH.NO_HST
LEFT JOIN CZ_SA_GIRH_DETAIL_LOG GD ON GD.CD_COMPANY = GH.CD_COMPANY AND GD.TP_GIR = GH.TP_GIR AND GD.NO_GIR = GH.NO_GIR AND GD.NO_HST = GH.NO_HST
LEFT JOIN CZ_TR_INVH_LOG TH ON TH.CD_COMPANY = GL.CD_COMPANY AND TH.NO_INV = GL.NO_INV AND TH.NO_HST = GL.NO_HST
LEFT JOIN MA_COMPANY CP ON CP.CD_COMPANY = GH.CD_COMPANY
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = GH.CD_COMPANY AND ME.NO_EMP = GH.NO_EMP
LEFT JOIN MA_USER MU ON MU.CD_COMPANY = GH.CD_COMPANY AND MU.ID_USER = GH.ID_DELETE
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = GD.NO_IMO
LEFT JOIN CZ_MA_HULL MH1 ON MH1.NO_IMO = GD.NO_IMO_BILL
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = GH.CD_COMPANY AND MP.CD_PARTNER = GH.CD_PARTNER
LEFT JOIN CZ_MA_DELIVERY MP1 ON MP1.CD_COMPANY = GD.CD_COMPANY AND MP1.CD_PARTNER = GD.CD_DELIVERY_TO
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = GH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00021' AND MC.CD_SYSDEF = GH.TP_GIR
LEFT JOIN MA_CODEDTL MC1 ON MC1.CD_COMPANY = GD.CD_COMPANY AND MC1.CD_FIELD = (CASE WHEN GD.TP_GIR = '001' THEN 'CZ_SA00006' ELSE 'CZ_SA00020' END) AND MC1.CD_SYSDEF = GD.CD_MAIN_CATEGORY
LEFT JOIN MA_CODEDTL MC2 ON MC2.CD_COMPANY = GD.CD_COMPANY AND MC2.CD_FIELD = MC1.CD_FLAG1 AND MC2.CD_SYSDEF = GD.CD_SUB_CATEGORY
LEFT JOIN MA_CODEDTL MC3 ON MC3.CD_COMPANY = GH.CD_COMPANY AND MC3.CD_FIELD = 'CZ_SA00030' AND MC3.CD_SYSDEF = GH.STA_GIR
LEFT JOIN MA_CODEDTL MC4 ON MC4.CD_COMPANY = TH.CD_COMPANY AND MC4.CD_FIELD = 'MA_B000020' AND MC4.CD_SYSDEF = TH.ARRIVER_COUNTRY
LEFT JOIN MA_CODEDTL MC5 ON MC5.CD_COMPANY = TH.CD_COMPANY AND MC5.CD_FIELD = 'PU_C000027' AND MC5.CD_SYSDEF = GH.YN_RETURN
LEFT JOIN MA_CODEDTL MC6 ON MC6.CD_COMPANY = GD.CD_COMPANY AND MC6.CD_FIELD = 'CZ_SA00032' AND MC6.CD_SYSDEF = GD.CD_RMK
WHERE (ISNULL(@P_CD_COMPANY, '') = '' OR GH.CD_COMPANY = @P_CD_COMPANY)
AND LEFT(GH.DTS_DELETE, 8) BETWEEN @P_DT_DELETE_FROM AND @P_DT_DELETE_TO
AND (ISNULL(@P_NO_GIR, '') = '' OR GH.NO_GIR = @P_NO_GIR)

DROP TABLE #MA_CALENDAR

GO

