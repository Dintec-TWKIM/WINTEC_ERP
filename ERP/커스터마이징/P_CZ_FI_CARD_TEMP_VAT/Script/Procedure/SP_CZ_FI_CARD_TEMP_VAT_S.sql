USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_FI_CARD_TEMP_VAT_S]    Script Date: 2021-08-19 오후 1:47:29 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_FI_CARD_TEMP_VAT_S]
(      
	@P_CD_COMPANY	NVARCHAR(7),          
	@P_MULTI_DEPT	NTEXT,     
	@P_MULTI_CARD	NTEXT,     
	@P_DT_FROM		VARCHAR(8),      
	@P_DT_TO		VARCHAR(8),      
	@P_VAT_TYPE		VARCHAR(3),      
	@P_ADMIN_GU		CHAR(1),      
	@P_DOCU_STAT	VARCHAR(3),      
	@P_SERVERKEY	VARCHAR(50),  
	@P_NM_CARD		NVARCHAR(20), -- 카드사명  
	@P_ASK_FROM		VARCHAR(8), -- 청구일자FROM   
	@P_ASK_TO		VARCHAR(8), -- 청구일자TO  
	@P_ST_DOCU		NVARCHAR(1), -- 전표승인여부  
	@P_TP_GR_CARD	NVARCHAR(1), -- 환경설정값
	@P_GW_SEND_YN	NVARCHAR(1), -- 그룹웨어처리여부
    @P_CD_ZCOSTACCT NTEXT,		 -- 나이스(오라클)전용(비용계정)
	@P_ID_USER		NVARCHAR(14),
	@P_CD_USERDEF1	NVARCHAR(20) --한국항공서비스주식회사전용
) AS      
-- ================================================      
-- AUTHOR      : 장은경      
-- CREATE DATE : 2010.01.14      
--       
-- MODULE      : 회계관리      
-- SYSTEM      : 은행연동      
-- SUBSYSTEM   : 거래내역관리      
-- PAGE        : 법인카드승인내역      
-- PROJECT     : P_FI_CARD_TEMP_VAT      
-- DESCRIPTION : 법인카드승인내역 조회      
-- ================================================       
-- CHANGE HISTORY      
-- v1.0 : 2010.07.19 이대성 수정   
-- v1.1 : 2010.12.23 박창수 수정       (승인금액, 취소금액가져오는 쿼리추가)  
-- v1.2 : 2010.12.30 박창수 수정       (조회조건추가)  
-- v1.3 : 2014.06.18 윤나라 수정	   (리사이텍, 신세계SVN CARD_USER_H 서버키 추가)
-- v1.4 : 2014.09.03 윤나라 수정	   (회계단위 파라미터삭제)
-- v1.5 : 2014.09.17 윤나라 수정	   (소계구분값 TP_SORT 추가)
-- v1.6 : 2014.11.20 윤나라 수정	   (법인카드불출현황 관련 수정 및 프로시져 정리 (관련핌스번호 : D20141117017, D20141118037)
-- v1.7 : 2015.04.28 윤나라 수정	   (바이오랜드전용 컬럼 추가)
-- ================================================      
SET NOCOUNT ON   

DECLARE @V_SERVER_KEY	VARCHAR(50)
SELECT	@V_SERVER_KEY = MAX(SERVER_KEY) FROM CM_SERVER_CONFIG

DECLARE @GTB_CARD_USER TABLE(NO_CARD VARCHAR(200))



--================================================================================================
--[회계환경설정]-[은행연동]-[법인카드승인내역 카드도움창 설정]-[신용카드부서등록]선택시 
--================================================================================================
IF @P_TP_GR_CARD  = '0' 
BEGIN
	INSERT INTO @GTB_CARD_USER
	SELECT	MAX(NO_CARD) NO_CARD
	FROM	FI_CARD_DEPT
	WHERE	CD_COMPANY = @P_CD_COMPANY
	AND		(@P_MULTI_DEPT IS NULL OR CD_DEPT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT2(@P_MULTI_DEPT)))        
	GROUP BY NO_CARD
END
--================================================================================================
--[회계환경설정]-[은행연동]-[법인카드승인내역 카드도움창 설정]-[신용카드사용자등록]선택시
--================================================================================================
ELSE
BEGIN
	IF @V_SERVER_KEY IN('RECYTECH','CHOSUNHOTELBA') 
	-- 리싸이텍코리아	RECYTECH / 신세계SVN	CHOSUNHOTELBA
	BEGIN
		INSERT INTO @GTB_CARD_USER
		SELECT	NO_CARD 
		FROM	FI_CARD_USER_H      
		WHERE	CD_COMPANY = @P_CD_COMPANY      
		AND		ID_USER = @P_ID_USER   
	END 
	ELSE
	BEGIN
		INSERT INTO @GTB_CARD_USER
		SELECT	NO_CARD 
		FROM	FI_CARD_USER    
		WHERE	CD_COMPANY = @P_CD_COMPANY      
		AND		ID_USER = @P_ID_USER   
	END
END
--================================================================================================
BEGIN
	SELECT	'N' AS S, 
			'1' AS TP_SORT,	-- 소계 구분값
			T.NODE_CODE, 
			T.ACCT_NO, 
			L.CD_MDEPT, 
			B.NM_DEPT,       
			T.BANK_CODE, 
			T.TRADE_DATE, 
			T.TRADE_TIME, 
			T.SEQ, 
			(CASE WHEN NEOE.FN_SERVERKEY('Y','CBS|119|') = 'Y' THEN ISNULL(ME.NM_KOR, '') ELSE ISNULL(ME.NM_KOR, L.NM_OWNER) END) AS NM_OWNER,
			L.NM_OWNER AS CARD_OWNER,
			L.CD_DEPOSIT, 
			T.CLIENT_NOTE, 
			T.TRADE_PLACE, 
			T.TRADE_PLACE AS LN_PARTNER,
			T.S_IDNO, 
			T.MCC_CODE,
			T.MCC_CODE_NAME, 
			T.MERC_ADDR,      
			CONVERT(NUMERIC(19, 0), T.ADMIN_AMT) AS ADMIN_AMT, 
			CONVERT(NUMERIC(19, 0), T.SUPPLY_AMT) AS SUPPLY_AMT,       
			CONVERT(NUMERIC(19, 0), T.VAT_AMT) AS VAT_AMT, 
			T.ADMIN_NO, 
			T.ADMIN_GU, 
			T.DOCU_STAT,      
			(CASE WHEN T.DOCU_STAT = '0' THEN '' ELSE T.NO_DOCU + '-' + CONVERT(VARCHAR, T.LINE_NO) END) AS NO_DOCU_LINE_NO,      
			T.NODE_CODE, 
			T.NO_DOCU, 
			T.LINE_NO, 
			T.WRITE_DATE, 
			T.DEPT_CODE,       
			T.CD_PARTNER, 
			T.MERC_REPR, 
			L.NO_CARD NO_CARD_G,
			L.NO_CARD,
			L.NM_CARD,
			L.CD_ACCT,
			L.NM_ACCT,
			T.VAT_TYPE, 
			(CASE WHEN NEOE.FN_SERVERKEY('N','ETEC|') = 'Y' AND T.VAT_TYPE = '1' THEN 'Y' ELSE ISNULL(T.YN_VAT, 'N') END) AS YN_VAT, 
			T.ASK_MON, 
			L.CD_BGACCT,
			L.NM_BGACCT, 
			L.CD_TACCT, 
			L.NM_TACCT,  
			L.NO_CARD ADMIN_GU_Y, 
			L.NO_CARD ADMIN_GU_N, 
			E.ST_DOCU,
			T.TRADE_PLACE_ADDR,
			FR.CD_KOR1,
			T.SERVICE_CHARGE,
			T.MEMO_CD,
			T.CHECK_PEN,
			T.CURRENCY,
			MAB05.CD_SYSDEF AS CURRENCY_CODE,
			T.TRAN_AMT,
			-- 동적 CONTEXT 때문에 추가
			E.ST_DOCU,
			E.ID_WRITE,
			E.NM_KOR,
			E.DT_ACCT,
			E.CD_WDEPT,
			E.NM_WDEPT,
			E.ST_GWARE,
			FC.TP_DATE,
			T.WRITE_DATE,
			ISNULL(T.GW_SEND_YN,'N') AS GW_SEND_YN,
			L.CD_PC,
			L.NM_PC,
			T.AQUI_RATE,
			T.TRAN_AMT,
			T.CD_COSTACCT,
			(SELECT NM_ACCT FROM FI_ACCTCODE WHERE CD_ACCT = T.CD_COSTACCT AND CD_COMPANY = @P_CD_COMPANY) AS NM_COSTACCT,
			(CASE WHEN NEOE.FN_SERVERKEY('N','MNS|') = 'Y' AND ISNULL(T.CD_CC,'') = '' THEN CA.CD_MDEPT 
				  WHEN NEOE.FN_SERVERKEY('Y','HANUL|') = 'Y' THEN B.CD_CC 
				  ELSE T.CD_CC END) AS CD_CC,
			(CASE WHEN NEOE.FN_SERVERKEY('N','MNS|') = 'Y' AND ISNULL(T.CD_CC,'') = '' THEN (SELECT NM_DEPT FROM MA_DEPT WHERE CD_DEPT = CA.CD_MDEPT AND CD_COMPANY = @P_CD_COMPANY)
				  WHEN NEOE.FN_SERVERKEY('Y','HANUL|') = 'Y' THEN (SELECT NM_CC FROM MA_CC WHERE CD_CC = B.CD_CC AND CD_COMPANY = @P_CD_COMPANY)
				  ELSE (SELECT NM_CC FROM MA_CC WHERE CD_CC = T.CD_CC AND CD_COMPANY = @P_CD_COMPANY) END) AS NM_CC,
			T.NM_NOTE,
			T.CD_USERDEF1,
			T.CD_USERDEF2,
			T.TRADE_PLACE_TEL,
			T.TRADE_PLACE_POST,
			T.CD_TPACCT,
			AC.NM_TPACCT,
			T.CARD_TYPE,
			T.CD_USERDEF3,
			T.AQUI_DOLL,
			T.AQUI_WON,
			T.FORE_USE,
			T.CD_PJT,
	        (SELECT NM_PROJECT FROM SA_PROJECTH WHERE NO_PROJECT = T.CD_PJT AND CD_COMPANY = @P_CD_COMPANY) AS NM_PJT,
	        CA.ETC_CARD,
	        T.EXP_DATE,
	        T.TP_INPUT,
			PH.NO_PO,
			PH.NO_IO,
			PH.NO_IV,
			PH.NO_DOCU AS NO_DOCU_PH,
			B.NO_EMPMNG,
			MC.NM_SYSDEF AS NM_GW_STATUS,
			(SELECT MAX(BD.DT_BANACCT) 
			 FROM FI_BAND BD
			 WHERE BD.CD_COMPANY = T.C_CODE
			 AND BD.BAN_PC = T.NODE_CODE
			 AND BD.NO_DOCU = T.NO_DOCU
			 AND BD.NO_DOLINE = T.LINE_NO) AS DT_ACCT_BAN
	FROM CARD_TEMP T      
	JOIN V_FI_ACCT_LINK_CARD L ON T.C_CODE = L.CD_COMPANY AND T.ACCT_NO = L.ACCT_NO      
	JOIN @GTB_CARD_USER	C ON L.NO_CARD = C.NO_CARD
	LEFT JOIN MA_DEPT B ON L.CD_COMPANY = B.CD_COMPANY AND L.CD_MDEPT = B.CD_DEPT       					 
	LEFT JOIN (SELECT FD.NO_DOCU,
			   		  MAX(FD.ST_DOCU) AS ST_DOCU,
			   		  MAX(FD.ID_WRITE) AS ID_WRITE,
			   		  MAX(ME.NM_KOR) AS NM_KOR,
			   		  MAX(FD.DT_ACCT) AS DT_ACCT,
			   		  MAX(FD.CD_WDEPT) AS CD_WDEPT,
			   		  MAX(MD.NM_DEPT) AS NM_WDEPT,
			   		  MAX(FD.ST_GWARE) AS ST_GWARE
			   FROM	FI_DOCU FD
			   LEFT JOIN MA_EMP ME ON FD.ID_WRITE = ME.NO_EMP AND FD.CD_COMPANY = ME.CD_COMPANY
			   LEFT JOIN MA_DEPT MD ON FD.CD_WDEPT = MD.CD_DEPT AND FD.CD_COMPANY = MD.CD_COMPANY
			   WHERE FD.CD_COMPANY = @P_CD_COMPANY  
			   GROUP BY NO_DOCU)E  
	ON T.NO_DOCU = E.NO_DOCU  
	LEFT JOIN FI_RECARD FR ON T.C_CODE = FR.CD_COMPANY AND T.ACCT_NO = REPLACE(FR.NO_AIMCARD,'-','') 
							  AND (((T.TRADE_DATE + (SUBSTRING(T.TRADE_TIME, 1, 4))) BETWEEN (ISNULL(FR.DT_RE,'00000000') + ISNULL(FR.DT_RE2,'0000')) AND (ISNULL(FR.DT_CO,'00000000') + ISNULL(FR.DT_CO2,'0000'))) OR 
								   ((T.TRADE_DATE + (SUBSTRING(T.TRADE_TIME, 1, 4))) >= (ISNULL(FR.DT_RE,'00000000') + ISNULL(FR.DT_RE2,'0000')) AND ISNULL(FR.DT_CO,'00000000') = '00000000'))
	LEFT JOIN MA_EMP ME ON FR.CD_COMPANY = ME.CD_COMPANY AND FR.CD_KOR1 = ME.NO_EMP
	LEFT JOIN FI_CALENDARDAY FC ON T.C_CODE = FC.CD_COMPANY AND T.TRADE_DATE = FC.DT_DATE
	LEFT JOIN MA_CODEDTL MAB05 ON T.C_CODE = MAB05.CD_COMPANY AND MAB05.CD_FIELD = 'MA_B000005' AND T.CURRENCY = MAB05.NM_SYSDEF
	LEFT JOIN FI_CARD CA ON REPLACE(T.ACCT_NO,'-','') = REPLACE(CA.NO_CARD,'-','') AND T.C_CODE = CA.CD_COMPANY
	LEFT JOIN FI_CARD_TEMP_ACCT	AC ON T.C_CODE = AC.CD_COMPANY AND T.CD_TPACCT = AC.CD_TPACCT
	LEFT JOIN (SELECT PH.CD_COMPANY, PH.NO_ORDER,
			   	      MAX(PH.NO_PO) AS NO_PO,
			   	      MAX(IL.NO_IO) AS NO_IO,
			   	      MAX(VL.NO_IV) AS NO_IV,
			   	      MAX(FD.NO_DOCU) AS NO_DOCU
			   FROM PU_POH PH
			   JOIN PU_POL PL ON PL.CD_COMPANY = PH.CD_COMPANY AND PL.NO_PO = PH.NO_PO
			   LEFT JOIN MM_QTIO IL ON IL.CD_COMPANY = PL.CD_COMPANY AND IL.NO_PSO_MGMT = PL.NO_PO AND IL.NO_PSOLINE_MGMT = PL.NO_LINE
			   LEFT JOIN PU_IVL VL ON VL.CD_COMPANY = IL.CD_COMPANY AND VL.NO_IO = IL.NO_IO AND VL.NO_IOLINE = IL.NO_IOLINE
			   LEFT JOIN FI_DOCU FD ON FD.CD_COMPANY = VL.CD_COMPANY AND FD.NO_MDOCU = VL.NO_IV
			   WHERE PH.CD_COMPANY = 'K100'
			   AND PH.CD_PARTNER IN ('20505', '08488', '11068')
			   GROUP BY PH.CD_COMPANY, PH.NO_ORDER) PH
	ON PH.CD_COMPANY = T.C_CODE AND PH.NO_ORDER = T.ADMIN_NO
	LEFT JOIN FI_GWDOCU GW ON GW.CD_COMPANY = 'K100' AND GW.CD_PC = '010000' AND GW.NO_DOCU = T.C_CODE + '-' + E.NO_DOCU 
	LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = GW.CD_COMPANY AND MC.CD_FIELD = 'PU_C000065' AND MC.CD_SYSDEF = GW.ST_STAT
	WHERE ((T.TRADE_DATE BETWEEN @P_DT_FROM AND @P_DT_TO)
	AND ((@P_ASK_FROM IS NULL OR @P_ASK_FROM = '' OR T.ASK_MON >= @P_ASK_FROM)  
	AND (@P_ASK_TO IS NULL OR @P_ASK_TO = '' OR T.ASK_MON <= @P_ASK_TO)))
	AND	(@P_MULTI_CARD IS NULL OR REPLACE(L.ACCT_NO,'-','') IN (SELECT CD_STR FROM GETTABLEFROMSPLIT2(@P_MULTI_CARD)))      
	AND	T.C_CODE = @P_CD_COMPANY
	AND (@P_VAT_TYPE IS NULL OR @P_VAT_TYPE = '' OR T.VAT_TYPE = @P_VAT_TYPE)      
	AND (@P_ADMIN_GU IS NULL OR @P_ADMIN_GU = '' OR T.ADMIN_GU = @P_ADMIN_GU)      
	AND (@P_DOCU_STAT IS NULL OR @P_DOCU_STAT = '' OR T.DOCU_STAT = @P_DOCU_STAT)  
	AND	(@P_NM_CARD IS NULL OR @P_NM_CARD = '' OR T.BANK_CODE = @P_NM_CARD)  
	AND	(@P_ST_DOCU IS NULL OR @P_ST_DOCU = '' OR E.ST_DOCU = @P_ST_DOCU)  
	AND	(@P_GW_SEND_YN IS NULL OR @P_GW_SEND_YN = '' OR ISNULL(T.GW_SEND_YN,'N') = @P_GW_SEND_YN)
	AND	(@P_CD_USERDEF1 IS NULL OR @P_CD_USERDEF1 = '' OR T.CD_USERDEF1 = @P_CD_USERDEF1)
	ORDER BY T.ACCT_NO, T.TRADE_DATE, T.TRADE_TIME
END
	  
-- 소계 (승인합계, 취소합계)를 가져오기 위한 쿼리
SELECT	T.ACCT_NO NO_CARD,   
		SUM(CASE WHEN ADMIN_GU = 'Y' THEN ADMIN_AMT ELSE 0 END) ADMIN_AMT_Y,  
		SUM(CASE WHEN ADMIN_GU = 'N' THEN ADMIN_AMT ELSE 0 END) ADMIN_AMT_N,  
		SUM(CASE WHEN ADMIN_GU = 'Y' THEN SUPPLY_AMT ELSE 0 END) SUPPLY_AMT_Y,  
		SUM(CASE WHEN ADMIN_GU = 'N' THEN SUPPLY_AMT ELSE 0 END) SUPPLY_AMT_N,    
		SUM(CASE WHEN ADMIN_GU = 'Y' THEN VAT_AMT ELSE 0 END) VAT_AMT_Y,  
		SUM(CASE WHEN ADMIN_GU = 'N' THEN VAT_AMT ELSE 0 END) VAT_AMT_N  
FROM	CARD_TEMP T  
JOIN	V_FI_ACCT_LINK_CARD L      
ON		T.C_CODE = L.CD_COMPANY AND T.ACCT_NO = L.ACCT_NO      
JOIN	@GTB_CARD_USER  C	ON	L.NO_CARD = C.NO_CARD  
LEFT JOIN	(  
				 SELECT FD.NO_DOCU,
						MAX(FD.ST_DOCU) AS ST_DOCU,
						MAX(FD.ID_WRITE) AS ID_WRITE,
						MAX(ME.NM_KOR) AS NM_KOR,
						MAX(FD.DT_ACCT) AS DT_ACCT,
						MAX(FD.CD_WDEPT) AS CD_WDEPT,
						MAX(MD.NM_DEPT) AS NM_WDEPT
						
				 FROM	FI_DOCU FD
				 LEFT JOIN MA_EMP ME
				 ON		FD.ID_WRITE = ME.NO_EMP AND FD.CD_COMPANY = ME.CD_COMPANY
				 LEFT JOIN MA_DEPT MD
				 ON		FD.CD_WDEPT = MD.CD_DEPT AND FD.CD_COMPANY = MD.CD_COMPANY
				 WHERE	FD.CD_COMPANY = @P_CD_COMPANY  
				 GROUP BY NO_DOCU  
			)E  
ON			T.NO_DOCU = E.NO_DOCU  


WHERE	((TRADE_DATE BETWEEN @P_DT_FROM AND @P_DT_TO)
			AND    ((@P_ASK_FROM IS NULL OR @P_ASK_FROM = '' OR ASK_MON >= @P_ASK_FROM)  
			AND		(@P_ASK_TO IS NULL OR @P_ASK_TO = '' OR ASK_MON <= @P_ASK_TO)))
AND		(@P_MULTI_CARD IS NULL OR REPLACE(L.ACCT_NO,'-','') IN (SELECT CD_STR FROM GETTABLEFROMSPLIT2(@P_MULTI_CARD)))      			
AND		C_CODE = @P_CD_COMPANY 	
AND     (@P_VAT_TYPE IS NULL OR @P_VAT_TYPE = '' OR T.VAT_TYPE = @P_VAT_TYPE)      
AND     (@P_ADMIN_GU IS NULL OR @P_ADMIN_GU = '' OR T.ADMIN_GU = @P_ADMIN_GU)      
AND     (@P_DOCU_STAT IS NULL OR @P_DOCU_STAT = '' OR T.DOCU_STAT = @P_DOCU_STAT)  
AND		(@P_NM_CARD IS NULL OR @P_NM_CARD = '' OR T.BANK_CODE = @P_NM_CARD)  
AND		(@P_ST_DOCU IS NULL OR @P_ST_DOCU = '' OR E.ST_DOCU = @P_ST_DOCU)  
AND		(@P_CD_USERDEF1 IS NULL OR @P_CD_USERDEF1 = '' OR T.CD_USERDEF1 = @P_CD_USERDEF1)
GROUP BY T.ACCT_NO  
      
--회수하지 않은 카드사용자
SELECT	REPLACE(R.NO_AIMCARD,'-','')AS NO_CARD, R.CD_KOR1, ME.NM_KOR, R.DT_RE, R.DT_RE2, R.DT_CO, R.DT_CO2
FROM	FI_RECARD	R
LEFT JOIN	MA_EMP ME	ON	R.CD_COMPANY = ME.CD_COMPANY AND R.CD_KOR1 = ME.NO_EMP
WHERE	R.CD_COMPANY = @P_CD_COMPANY
AND		(@P_MULTI_CARD IS NULL OR REPLACE(R.NO_AIMCARD,'-','') IN (SELECT CD_STR FROM GETTABLEFROMSPLIT2(@P_MULTI_CARD)))
AND		R.DT_CO = '00000000'

SET NOCOUNT OFF
GO