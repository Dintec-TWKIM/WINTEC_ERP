USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_IVMNG_INVOICE_S]    Script Date: 2016-03-15 오후 2:59:58 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [NEOE].[SP_CZ_SA_IVMNG_INVOICE_S]
(
	@P_CD_COMPANY	NVARCHAR(7),
	@P_NO_INVOICE	NVARCHAR(20)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT IV.CD_COMPANY,
	   'N' AS S,
	   IV.NO_INVOICE,
	   IV.NO_IV,
	   IV.NO_IO,
	   ISNULL(IV.DC_COMPANY, '') AS DC_COMPANY,
	   ISNULL(IV.DC_ADDRESS, '') AS DC_ADDRESS,
	   ISNULL(IV.DC_TEL, '') AS DC_TEL,
	   ISNULL(IV.CD_NATION, '') AS CD_NATION,
	   MC.NM_SYSDEF_E AS NM_NATION,
	   ISNULL(IV.NM_CITY, IV1.NM_CITY) AS NM_CITY,
	   ISNULL(IV.CD_POSTAL, IV1.CD_POSTAL) AS CD_POSTAL,
	   'D' AS CD_PRODUCT,
	   IH.DT_PROCESS
FROM CZ_SA_IVMNG_INVOICE IV
LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = IV.CD_COMPANY AND MC.CD_FIELD = 'MA_B000020' AND MC.CD_FLAG1 = IV.CD_NATION
LEFT JOIN SA_IVH IH ON IH.CD_COMPANY = IV.CD_COMPANY AND IH.NO_IV = IV.NO_IV
LEFT JOIN (SELECT DC_ADDRESS,
		   	      MAX(NM_CITY) AS NM_CITY,
		   	      MAX(CD_POSTAL) AS CD_POSTAL
		   FROM CZ_SA_IVMNG_INVOICE
		   WHERE ISNULL(DC_ADDRESS, '') <> '' 
		   AND NM_CITY IS NOT NULL
		   AND CD_POSTAL IS NOT NULL
		   GROUP BY DC_ADDRESS) IV1
ON IV1.DC_ADDRESS = IV.DC_ADDRESS
WHERE IV.CD_COMPANY = @P_CD_COMPANY
AND IV.NO_INVOICE = @P_NO_INVOICE

GO