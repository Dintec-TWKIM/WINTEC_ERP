USE [NEOE]
GO

/****** Object:  StoredProcedure [NEOE].[SP_CZ_PU_IV_MNGL_S]    Script Date: 2016-11-17 오후 5:00:44 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*******************************************                          
*********************************************/     
ALTER PROCEDURE [NEOE].[SP_CZ_PU_IV_MNGL_S]    
(            
	@P_CD_COMPANY       NVARCHAR(7),            
	@P_NO_IV            NVARCHAR(20),
	@P_NO_PO		    NVARCHAR(20),
	@P_CD_PJT		    NVARCHAR(20)
)    
AS   

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
SELECT IL.NO_IV,
	   IL.NO_LINE,
	   MH.CD_PARTNER,
	   MP.LN_PARTNER,
	   IL.CD_ITEM,
	   MI.NM_ITEM,
	   QL.CD_ITEM_PARTNER,
	   QL.NM_ITEM_PARTNER,
	   PH.CD_TPPO,
	   PT.NM_TPPO,
	   MI.CLS_ITEM,
	   DT1.NM_SYSDEF AS NM_CLS_ITEM,
	   QL.UNIT,
	   IL.QT_CLS,
	   IL.CD_EXCH,
	   DT.NM_SYSDEF AS NM_EXCH,
	   IL.RT_EXCH,
	   (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.UM_EX_CLS ELSE IL.UM_EX_CLS END) AS UM_EX_CLS,
	   (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.UM_ITEM_CLS ELSE IL.UM_ITEM_CLS END) AS UM_ITEM_CLS,
	   (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_EX_CLS ELSE IL.AM_EX_CLS END) AS AM_EX_CLS,
	   (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.AM_CLS ELSE IL.AM_CLS END) AS AM_CLS,
	   (CASE WHEN IL.YN_RETURN = 'Y' THEN -IL.VAT ELSE IL.VAT END) AS VAT,
	   (CASE WHEN IL.YN_RETURN = 'Y' THEN -(IL.AM_CLS + IL.VAT) ELSE (IL.AM_CLS + IL.VAT) END) AS AM_TOTAL,
	   ISNULL(PL.AM_EX_ADPAY, 0) AS AM_EX_ADPAY,
	   ISNULL(PL.AM_ADPAY, 0) AS AM_ADPAY,
	   IL.CD_PJT,
	   PL.NO_PO,
	   PH.NO_ORDER,
	   IL.NO_IO,
	   IL.NO_IOLINE,
	   MH.DT_IO,
	   IL.CD_CC,
	   MC.NM_CC,
	   PH.CD_PURGRP,
	   PG.NM_PURGRP,
	   PH.NO_EMP,
	   ME.NM_KOR AS NM_EMP,
	   IL.MEMO_CD,
	   IL.CHECK_PEN
FROM PU_IVL IL
LEFT JOIN MA_PITEM MI ON MI.CD_COMPANY = IL.CD_COMPANY AND MI.CD_PLANT = IL.CD_PLANT AND MI.CD_ITEM = IL.CD_ITEM
LEFT JOIN MA_CC MC ON MC.CD_COMPANY = IL.CD_COMPANY AND MC.CD_CC = IL.CD_CC
LEFT JOIN MM_QTIOH MH ON MH.CD_COMPANY = IL.CD_COMPANY AND MH.NO_IO = IL.NO_IO
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = MH.CD_COMPANY AND MP.CD_PARTNER = MH.CD_PARTNER
LEFT JOIN PU_POL PL ON PL.CD_COMPANY = IL.CD_COMPANY AND PL.NO_PO = IL.NO_PO AND PL.NO_LINE = IL.NO_POLINE
LEFT JOIN PU_POH PH ON PH.CD_COMPANY = PL.CD_COMPANY AND PH.NO_PO = PL.NO_PO
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = PH.CD_COMPANY AND ME.NO_EMP = PH.NO_EMP
LEFT JOIN PU_TPPO PT ON PT.CD_COMPANY = PH.CD_COMPANY AND PT.CD_TPPO = PH.CD_TPPO
LEFT JOIN MA_PURGRP PG ON PG.CD_COMPANY = PH.CD_COMPANY AND PG.CD_PURGRP = PH.CD_PURGRP
LEFT JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = PL.CD_COMPANY AND QL.NO_FILE = PL.NO_SO AND QL.NO_LINE = PL.NO_SOLINE
LEFT JOIN MA_CODEDTL DT ON DT.CD_COMPANY = IL.CD_COMPANY AND DT.CD_FIELD = 'MA_B000005' AND DT.CD_SYSDEF = IL.CD_EXCH
LEFT JOIN MA_CODEDTL DT1 ON DT1.CD_COMPANY = MI.CD_COMPANY AND DT1.CD_FIELD = 'MA_B000010' AND DT1.CD_SYSDEF = MI.CLS_ITEM
WHERE IL.CD_COMPANY = @P_CD_COMPANY
AND IL.NO_IV = @P_NO_IV 
AND (ISNULL(@P_NO_PO, '') = '' OR IL.NO_PO LIKE @P_NO_PO + '%')
AND (ISNULL(@P_CD_PJT, '') = '' OR IL.CD_PJT = @P_CD_PJT)
ORDER BY IL.NO_LINE

GO

