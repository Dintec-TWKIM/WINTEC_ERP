USE [NEOE]
GO
/****** Object:  StoredProcedure [NEOE].[SP_CZ_SA_IV_AUTO_S]    Script Date: 2016-04-12 오전 11:07:43 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [NEOE].[SP_CZ_SA_IV_AUTO_S]    
(    
    @P_CD_COMPANY       NVARCHAR(7),
	@P_NO_IO			NVARCHAR(20)
)    
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @V_EMAIL NVARCHAR(1000)

SELECT @V_EMAIL = A.CD_FLAG2 
FROM CZ_MA_CODEDTL A
WHERE A.CD_COMPANY = @P_CD_COMPANY
AND A.CD_FIELD = 'CZ_SA00002'
AND A.CD_SYSDEF = '000'

CREATE TABLE #MM_QTIO
(
	CD_COMPANY		NVARCHAR(7),
	NO_IO			NVARCHAR(20),
	NO_PSO_MGMT		NVARCHAR(20),
	COND_PAY		NVARCHAR(4),
	E_MAIL			NVARCHAR(30),
	NO_EMAIL		NVARCHAR(100),
	NO_GIR			NVARCHAR(20),
	CD_EXCH			NVARCHAR(4),
	AM_IO			NUMERIC(17, 4)
)

CREATE NONCLUSTERED INDEX MM_QTIO ON #MM_QTIO (CD_COMPANY, NO_IO)

INSERT INTO #MM_QTIO
SELECT OL.CD_COMPANY, OL.NO_IO, OL.NO_PSO_MGMT,
	   MAX(SH.COND_PAY) AS COND_PAY,
	   MAX(SG.E_MAIL) AS E_MAIL,
	   MAX((CASE WHEN ISNULL(ME.DT_RETIRE, '00000000') = '00000000' THEN ME.NO_EMAIL ELSE '' END)) AS NO_EMAIL,
	   MAX(OL.NO_ISURCV) AS NO_GIR,
       MAX(OL.CD_EXCH) AS CD_EXCH,
	   SUM(OL.AM) AS AM_IO
FROM MM_QTIO OL
JOIN SA_GIRL GL ON GL.CD_COMPANY = OL.CD_COMPANY AND GL.NO_GIR = OL.NO_ISURCV AND GL.SEQ_GIR = OL.NO_ISURCVLINE
JOIN CZ_SA_QTNL QL ON QL.CD_COMPANY = GL.CD_COMPANY AND QL.NO_FILE = GL.NO_SO AND QL.NO_LINE = GL.SEQ_SO
JOIN SA_SOH SH ON SH.CD_COMPANY = OL.CD_COMPANY AND SH.NO_SO = OL.NO_PSO_MGMT
LEFT JOIN MA_SALEGRP SG ON SG.CD_COMPANY = SH.CD_COMPANY AND SG.CD_SALEGRP = SH.CD_SALEGRP
LEFT JOIN MA_EMP ME ON ME.CD_COMPANY = SH.CD_COMPANY AND ME.NO_EMP = SH.NO_EMP
WHERE OL.CD_COMPANY = @P_CD_COMPANY
AND (ISNULL(@P_NO_IO, '') = '' OR OL.NO_IO = @P_NO_IO)
AND OL.YN_AM = 'Y' 
AND OL.FG_PS = '2'
AND OL.FG_IO IN ('010', '041')
AND OL.YN_PURSALE = 'Y'
AND (ISNULL(@P_NO_IO, '') <> '' OR OL.QT_IO > OL.QT_CLS)
AND OL.CD_ITEM NOT LIKE 'SD%'
GROUP BY OL.CD_COMPANY, OL.NO_IO, OL.NO_PSO_MGMT

SELECT OH.CD_COMPANY,
	   OH.NO_IO,
	   OL.NO_GIR,
	   OH.DT_IO,
	   ISNULL(OH.YN_STATUS1, 'N') AS YN_STATUS1,
	   WD.DT_LOADING,
	   (CASE WHEN OH.CD_COMPANY = 'K100' AND OH.CD_PARTNER IN ('02895', '07683') THEN '005' ELSE MP1.TP_INV END) AS TP_INV,
	   ISNULL(MP1.YN_COLOR, 'N') AS YN_COLOR,
	   OL1.E_MAIL AS FROM_EMAIL,
	   OL1.NO_EMAIL AS CC,
	   ISNULL((SELECT MC.CD_FLAG2 
			   FROM SA_SOH SH
			   JOIN CZ_MA_CODEDTL MC ON MC.CD_COMPANY = SH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00002' AND MC.CD_SYSDEF = SH.CD_PARTNER_GRP
			   WHERE SH.CD_COMPANY = OL.CD_COMPANY 
			   AND SH.NO_SO = OL.NO_SO), @V_EMAIL) AS WEB_EMAIL,
	   (CASE WHEN (MP.FG_PARTNER = '400' OR MP.FG_PARTNER = '600') THEN MP.E_MAIL
			 WHEN ISNULL(MH.INVOICE_EMAIL, '') <> '' THEN MH.INVOICE_EMAIL
			 ELSE MP.E_MAIL END) AS TO_EMAIL,
	   (CASE WHEN OH.CD_COMPANY IN ('K100', 'K200') AND OH.CD_PARTNER = '01711' THEN 'Y' ELSE 'N' END) AS YN_CI,
	   (CASE WHEN OH.CD_COMPANY IN ('K100', 'K200') AND OH.CD_PARTNER = '01711' THEN 'Y' ELSE 'N' END) AS YN_PL,
	   (CASE WHEN (OH.CD_COMPANY IN ('K100', 'K200') AND OH.CD_PARTNER = '01711') OR
				  (OH.CD_COMPANY = 'K100' AND OH.CD_PARTNER = '01989') THEN 'Y' ELSE 'N' END) AS YN_ACK,
	   (CASE WHEN (OH.CD_COMPANY = 'K100' AND OH.CD_PARTNER IN ('05743', '09825', '09737', '17842', '17832', '01989')) OR 
				  (OH.CD_COMPANY = 'K200' AND OH.CD_PARTNER IN ('09737')) THEN 'Y' ELSE 'N' END) AS YN_PO,
	   (CASE WHEN OH.CD_COMPANY = 'K100' AND OH.CD_PARTNER IN ('09737', '06146', '17842', '09825', '05743', '17832', '17844', '05928', '03448', '07300', '01187') THEN 'Y' ELSE 'N' END) AS YN_PARTIAL
FROM MM_QTIOH OH
JOIN (SELECT A.CD_COMPANY, A.NO_IO,
		     MAX(A.NO_GIR) AS NO_GIR,
			 MAX(A.NO_PSO_MGMT) AS NO_SO,
			 MAX(A.CD_EXCH) AS CD_EXCH
	  FROM #MM_QTIO A
	  GROUP BY A.CD_COMPANY, A.NO_IO) OL
ON OL.CD_COMPANY = OH.CD_COMPANY AND OL.NO_IO = OH.NO_IO
LEFT JOIN (SELECT ROW_NUMBER() OVER (PARTITION BY A.CD_COMPANY, A.NO_IO ORDER BY A.AM_IO DESC) AS IDX,
				  A.CD_COMPANY, A.NO_IO, A.E_MAIL, A.NO_EMAIL 
		   FROM #MM_QTIO A) OL1
ON OL1.CD_COMPANY = OH.CD_COMPANY AND OL1.NO_IO = OH.NO_IO AND OL1.IDX = 1
LEFT JOIN CZ_SA_GIRH_WORK_DETAIL WD ON WD.CD_COMPANY = OL.CD_COMPANY AND WD.NO_GIR = OL.NO_GIR
LEFT JOIN MA_PARTNER MP ON MP.CD_COMPANY = OH.CD_COMPANY AND MP.CD_PARTNER = OH.CD_PARTNER
LEFT JOIN CZ_MA_PARTNER MP1 ON MP1.CD_COMPANY = OH.CD_COMPANY AND MP1.CD_PARTNER = OH.CD_PARTNER
LEFT JOIN CZ_MA_HULL MH ON MH.NO_IMO = WD.NO_IMO
LEFT JOIN (SELECT EX.CD_COMPANY, EX.YYMMDD, EX.CURR_SOUR,
		      	  (CASE WHEN CURR_SOUR = '002' THEN RATE_BASE 
											   ELSE ROUND(RATE_BASE, 2) END) AS RT_EXCH
		   FROM MA_EXCHANGE EX
		   WHERE EX.NO_SEQ = '1'
		   AND EX.CURR_DEST = '000') EX
ON EX.CD_COMPANY = WD.CD_COMPANY AND EX.YYMMDD = WD.DT_LOADING AND EX.CURR_SOUR = OL.CD_EXCH
LEFT JOIN (SELECT CD_COMPANY,
		          DT_CAL,
		   	      ROW_NUMBER() OVER (PARTITION BY CD_COMPANY ORDER BY DT_CAL DESC) AS IDX
		   FROM MA_CALENDAR
		   WHERE FG1_HOLIDAY = 'W'
		   AND DT_CAL < CONVERT(CHAR(8), GETDATE(), 112)) CL
ON CL.CD_COMPANY = OH.CD_COMPANY AND CL.IDX = 5
JOIN (SELECT CD_COMPANY, CD_FILE,
	  		 CONVERT(CHAR(8), MAX(DTS_INSERT), 112) AS DT_INSERT
	  FROM MA_FILEINFO
	  WHERE CD_MODULE = 'SA' 
	  AND ID_MENU = 'P_CZ_SA_GIM_REG'
	  GROUP BY CD_COMPANY, CD_FILE) MF 
ON MF.CD_COMPANY = OL.CD_COMPANY AND MF.CD_FILE = OL.NO_GIR + '_' + OL.CD_COMPANY
WHERE OH.CD_COMPANY = @P_CD_COMPANY
AND OH.FG_TRANS = '005'
AND OH.YN_RETURN <> 'Y'
AND MP.YN_JEONJA <> '4' 
AND NOT EXISTS (SELECT 1 
                FROM MM_QTIO OL
				JOIN SA_GIRL GL ON GL.CD_COMPANY = OL.CD_COMPANY AND GL.NO_GIR = OL.NO_ISURCV AND GL.SEQ_GIR = OL.NO_ISURCVLINE
                JOIN SA_SOH SH ON SH.CD_COMPANY = OL.CD_COMPANY AND SH.NO_SO = OL.NO_PSO_MGMT
				LEFT JOIN MA_CODEDTL MC ON MC.CD_COMPANY = SH.CD_COMPANY AND MC.CD_FIELD = 'CZ_SA00013' AND MC.CD_SYSDEF = SH.COND_PAY
                WHERE OL.CD_COMPANY = OH.CD_COMPANY
                AND OL.NO_IO = OH.NO_IO
                AND ((SH.NO_SO NOT LIKE 'DS%' AND ISNULL(GL.TXT_USERDEF1, '') = '') OR 
					 LEFT(SH.NO_SO, 2) IN ('TE', 'BS', 'BE') OR
					 ISNULL(MC.CD_FLAG1, '') <> '' OR
					 SH.COND_PAY = '102' OR
					 (SH.CD_COMPANY = 'K100' AND (SH.CD_PARTNER_GRP IN ('53', '54') OR SH.NO_SO LIKE 'DB%')) OR 
					 (SH.CD_COMPANY = 'K200' AND (SH.CD_PARTNER_GRP = '82' OR SH.NO_SO LIKE 'D-%')) OR
					 (SH.TP_SO IN ('2000', '2100') AND ISNULL(SH.TP_VAT, '') <> '15') OR
					 (SH.CD_PARTNER = '09737' AND LEFT(SH.NO_SO, 2) = 'SB')))
AND ISNULL(WD.DT_LOADING, '') <> ''
AND (OL.CD_EXCH = '000' OR ISNULL(EX.RT_EXCH, 0) > 0)
AND (NOT ((WD.CD_MAIN_CATEGORY = '003' AND WD.CD_SUB_CATEGORY IN ('001', '002', '003', '006')) OR 
          (WD.CD_MAIN_CATEGORY = '003' AND WD.CD_SUB_CATEGORY = '004' AND WD.CD_RMK NOT IN ('011', '013')) OR
		  (WD.CD_MAIN_CATEGORY = '003' AND WD.CD_SUB_CATEGORY = '006')) OR MF.DT_INSERT <= CL.DT_CAL)
ORDER BY OH.CD_PARTNER, WD.DT_LOADING

DROP TABLE #MM_QTIO

GO