
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'UP_SA_SOSCH2_SELECT') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE UP_SA_SOSCH2_SELECT
GO

/*******************************************              
**  System : 영업관리              
**  Sub System : 매출관리          
**  Page  : 수주진행현황  
**  Desc  :  수주진행현황 탭별 헤더 조회      
**              
**  Return Values              
**              
**  작    성    자  : 허성철              
**  작    성    일 : 07-04-04  
** Change History              
*********************************************      
* 2007.08.10 업체 요구사항에 따라 기존 진행상태(진행, 미납,완료)를 전체,미출고,출고로 변경 By Young  
*********************************************/      
CREATE PROCEDURE UP_SA_SOSCH2_SELECT  
(      
 @P_CD_COMPANY   NVARCHAR(7),  
 @P_DT_SO_FROM NCHAR(8),  
 @P_DT_SO_TO  NCHAR(8),  
 @P_CD_BIZAREA NVARCHAR(7),  
 @P_CD_SALEGRP NVARCHAR(7),  
 @P_TP_BUSI  NVARCHAR(3),  
 @P_STA_SO  NVARCHAR(3),   
 @P_STATE  NVARCHAR(3), --001 : 전체, 002 : 미출고, 003: 출고  
 @P_TP_SO  NVARCHAR(4),   
 @P_TAB_GUBUN NCHAR(1)    --@P_TAB_GUBUN : 0-> 수주번호별, 1-> 거래처별, 2-> 품목별, 3-> 납기요구일별, 4-> 수주형태별, 5-> 영업그룹별  
)  
AS  
SET NOCOUNT ON  
  
IF (@P_TAB_GUBUN = '0')   --수주번호별  
BEGIN  
 IF (@P_STATE IS NULL OR @P_STATE = '')  
 BEGIN  
  SELECT   
     A.NO_SO,  
     A.DT_SO,  
     A.CD_PARTNER,  
     (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = A.CD_COMPANY AND CD_PARTNER = A.CD_PARTNER) LN_PARTNER,  
     A.FG_TRANSPORT, A.TP_SO, C.NM_SO  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  LEFT OUTER JOIN SA_TPSO C ON C.CD_COMPANY = @P_CD_COMPANY  
        AND C.TP_SO = A.TP_SO  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
 END  
 ELSE IF (@P_STATE = '001')  -- 전체 조회  
 BEGIN  
  SELECT  A.NO_SO,  
     A.DT_SO,  
     A.CD_PARTNER,  
     (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = A.CD_COMPANY AND CD_PARTNER = A.CD_PARTNER) LN_PARTNER,  
     A.FG_TRANSPORT, A.TP_SO, C.NM_SO  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT  NO_SO,   
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   --AND  QT_GIR > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  LEFT OUTER JOIN SA_TPSO C ON C.CD_COMPANY = @P_CD_COMPANY  
        AND C.TP_SO = A.TP_SO  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
 END  
 ELSE IF (@P_STATE = '002')  -- 미출고  
 BEGIN  
  SELECT  A.NO_SO,  
     A.DT_SO,  
     A.CD_PARTNER,  
     (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = A.CD_COMPANY AND CD_PARTNER = A.CD_PARTNER) LN_PARTNER,  
     A.FG_TRANSPORT, A.TP_SO, C.NM_SO  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO,   
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  LEFT OUTER JOIN SA_TPSO C ON C.CD_COMPANY = @P_CD_COMPANY  
        AND C.TP_SO = A.TP_SO  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
 END  
 ELSE IF (@P_STATE = '003')  -- 출고  
 BEGIN  
  SELECT  A.NO_SO,  
     A.DT_SO,  
     A.CD_PARTNER,  
     (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = A.CD_COMPANY AND CD_PARTNER = A.CD_PARTNER) LN_PARTNER,  
     A.FG_TRANSPORT, A.TP_SO, C.NM_SO  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT  NO_SO,   
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND   A.QT_SO - A.QT_GI = 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  LEFT OUTER JOIN SA_TPSO C ON C.CD_COMPANY = @P_CD_COMPANY  
        AND C.TP_SO = A.TP_SO  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
 END  
  
END  
ELSE IF (@P_TAB_GUBUN = '1') --거래처별  
BEGIN  
 IF (@P_STATE IS NULL OR @P_STATE = '')  
 BEGIN  
  SELECT  A.CD_PARTNER,  
     (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = A.CD_COMPANY AND CD_PARTNER = A.CD_PARTNER) LN_PARTNER  
      
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO,  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.CD_PARTNER  
 END  
 ELSE IF (@P_STATE = '001')  
 BEGIN  
  SELECT  A.CD_PARTNER,  
     (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = A.CD_COMPANY AND CD_PARTNER = A.CD_PARTNER) LN_PARTNER  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO,  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
  -- AND  QT_GIR > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.CD_PARTNER  
 END  
 ELSE IF (@P_STATE = '002')  
 BEGIN  
  SELECT  A.CD_PARTNER,  
     (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = A.CD_COMPANY AND CD_PARTNER = A.CD_PARTNER) LN_PARTNER  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO,  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.CD_PARTNER  
 END  
  
 ELSE IF (@P_STATE = '003')  
 BEGIN  
  SELECT  A.CD_PARTNER,  
     (SELECT LN_PARTNER FROM MA_PARTNER WHERE CD_COMPANY = A.CD_COMPANY AND CD_PARTNER = A.CD_PARTNER) LN_PARTNER  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO,  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI = 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.CD_PARTNER  
 END  
  
END  
ELSE IF (@P_TAB_GUBUN = '2') --품목별  
BEGIN  
 IF (@P_STATE IS NULL OR @P_STATE = '')  
 BEGIN  
  SELECT  B.CD_ITEM, --품목코드  
     (SELECT NM_ITEM FROM MA_PITEM WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = B.CD_PLANT AND CD_ITEM = B.CD_ITEM) NM_ITEM, --품목명  
     (SELECT STND_ITEM FROM MA_PITEM WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = B.CD_PLANT AND CD_ITEM = B.CD_ITEM) STND_ITEM --규격  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     CD_PLANT, --공장  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA, --사업장  
     CD_ITEM  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT, CD_ITEM  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, B.CD_PLANT, B.CD_ITEM  
 END  
 ELSE IF (@P_STATE = '001')  
 BEGIN  
  SELECT  B.CD_ITEM, --품목코드  
     (SELECT NM_ITEM FROM MA_PITEM WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = B.CD_PLANT AND CD_ITEM = B.CD_ITEM) NM_ITEM, --품목명  
     (SELECT STND_ITEM FROM MA_PITEM WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = B.CD_PLANT AND CD_ITEM = B.CD_ITEM) STND_ITEM --규격  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     CD_PLANT, --공장  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA, --사업장  
     CD_ITEM  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
  -- AND  QT_GIR > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT, CD_ITEM  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, B.CD_PLANT, B.CD_ITEM  
 END  
 ELSE IF (@P_STATE = '002')  
 BEGIN  
  SELECT  B.CD_ITEM, --품목코드  
     (SELECT NM_ITEM FROM MA_PITEM WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = B.CD_PLANT AND CD_ITEM = B.CD_ITEM) NM_ITEM, --품목명  
     (SELECT STND_ITEM FROM MA_PITEM WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = B.CD_PLANT AND CD_ITEM = B.CD_ITEM) STND_ITEM --규격  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT  NO_SO, --수주번호  
     CD_PLANT, --공장  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA, --사업장  
     CD_ITEM  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT, CD_ITEM  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, B.CD_PLANT, B.CD_ITEM  
 END  
  
ELSE IF (@P_STATE = '003')  
 BEGIN  
  SELECT  B.CD_ITEM, --품목코드  
     (SELECT NM_ITEM FROM MA_PITEM WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = B.CD_PLANT AND CD_ITEM = B.CD_ITEM) NM_ITEM, --품목명  
     (SELECT STND_ITEM FROM MA_PITEM WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = B.CD_PLANT AND CD_ITEM = B.CD_ITEM) STND_ITEM  --규격  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT  NO_SO, --수주번호  
     CD_PLANT, --공장  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA, --사업장  
     CD_ITEM  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI = 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT, CD_ITEM  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, B.CD_PLANT, B.CD_ITEM  
 END  
  
  
END  
ELSE IF (@P_TAB_GUBUN = '3') --납기요구일별  
BEGIN  
 IF (@P_STATE IS NULL OR @P_STATE = '')  
 BEGIN  
  SELECT  B.DT_DUEDATE --납기일  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA, --사업장  
     DT_DUEDATE  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT, DT_DUEDATE  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, B.DT_DUEDATE  
 END  
 ELSE IF (@P_STATE = '001')  
 BEGIN  
  SELECT  B.DT_DUEDATE --납기일  
        
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA, --사업장  
     DT_DUEDATE  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
  -- AND  QT_GIR > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT, DT_DUEDATE  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, B.DT_DUEDATE  
 END  
 ELSE IF (@P_STATE = '002')  
 BEGIN  
  SELECT  B.DT_DUEDATE --납기일  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA, --사업장  
     DT_DUEDATE  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT, DT_DUEDATE  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, B.DT_DUEDATE  
 END  
  
 ELSE IF (@P_STATE = '003')  
 BEGIN  
  SELECT  B.DT_DUEDATE --납기일  
        
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA, --사업장  
     DT_DUEDATE  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI = 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT, DT_DUEDATE  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, B.DT_DUEDATE  
 END  
  
  
END  
ELSE IF (@P_TAB_GUBUN = '4') --수주형태별  
BEGIN  
 IF (@P_STATE IS NULL OR @P_STATE = '')  
 BEGIN  
  SELECT  A.TP_SO,  
     (SELECT NM_SO FROM SA_TPSO WHERE CD_COMPANY = A.CD_COMPANY AND TP_SO = A.TP_SO) NM_SO  --수주형태  
      
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.TP_SO  
 END  
 ELSE IF (@P_STATE = '001')  
 BEGIN  
  SELECT  A.TP_SO,  
     (SELECT NM_SO FROM SA_TPSO WHERE CD_COMPANY = A.CD_COMPANY AND TP_SO = A.TP_SO) NM_SO  --수주형태  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   --AND  QT_GIR > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.TP_SO  
 END  
 ELSE IF (@P_STATE = '002')  
 BEGIN  
  SELECT  A.TP_SO,  
     (SELECT NM_SO FROM SA_TPSO WHERE CD_COMPANY = A.CD_COMPANY AND TP_SO = A.TP_SO) NM_SO  --수주형태  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.TP_SO  
 END  
  
 ELSE IF (@P_STATE = '003')  
 BEGIN  
  SELECT  A.TP_SO,  
     (SELECT NM_SO FROM SA_TPSO WHERE CD_COMPANY = A.CD_COMPANY AND TP_SO = A.TP_SO) NM_SO  --수주형태  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI = 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.TP_SO  
 END  
  
  
END  
ELSE IF (@P_TAB_GUBUN = '5') --영업그룹별  
BEGIN  
 IF (@P_STATE IS NULL OR @P_STATE = '')  
 BEGIN  
  SELECT  A.CD_SALEGRP, --영업그룹  
     (SELECT NM_SALEGRP FROM MA_SALEGRP WHERE CD_COMPANY = A.CD_COMPANY AND CD_SALEGRP = A.CD_SALEGRP) NM_SALEGRP --영업그룹명  
      
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.CD_SALEGRP  
 END  
 ELSE IF (@P_STATE = '001')  
 BEGIN  
  SELECT  A.CD_SALEGRP, --영업그룹  
     (SELECT NM_SALEGRP FROM MA_SALEGRP WHERE CD_COMPANY = A.CD_COMPANY AND CD_SALEGRP = A.CD_SALEGRP) NM_SALEGRP --영업그룹명  
       
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   --AND  QT_GIR > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.CD_SALEGRP  
 END  
 ELSE IF (@P_STATE = '002')  
 BEGIN  
  SELECT  A.CD_SALEGRP, --영업그룹  
     (SELECT NM_SALEGRP FROM MA_SALEGRP WHERE CD_COMPANY = A.CD_COMPANY AND CD_SALEGRP = A.CD_SALEGRP) NM_SALEGRP --영업그룹명  
      
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI > 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.CD_SALEGRP  
 END  
  
 ELSE IF (@P_STATE = '003')  
 BEGIN  
  SELECT  A.CD_SALEGRP, --영업그룹  
     (SELECT NM_SALEGRP FROM MA_SALEGRP WHERE CD_COMPANY = A.CD_COMPANY AND CD_SALEGRP = A.CD_SALEGRP) NM_SALEGRP --영업그룹명  
      
  FROM  SA_SOH A  
  INNER JOIN  
  (  
   SELECT NO_SO, --수주번호  
     (SELECT CD_BIZAREA FROM MA_PLANT WHERE CD_COMPANY = A.CD_COMPANY AND CD_PLANT = A.CD_PLANT) CD_BIZAREA --사업장  
   FROM SA_SOL A  
   WHERE CD_COMPANY = @P_CD_COMPANY  
   AND  (TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)  
   AND  (STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)  
   AND  QT_SO - QT_GI = 0  
   GROUP BY CD_COMPANY, NO_SO, CD_PLANT  
  ) B  
  ON   B.NO_SO = A.NO_SO  
  AND   B.CD_BIZAREA = @P_CD_BIZAREA  
  WHERE  A.CD_COMPANY = @P_CD_COMPANY  
  AND   A.DT_SO BETWEEN  @P_DT_SO_FROM AND @P_DT_SO_TO  
  AND   (A.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
  AND   (A.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  GROUP BY A.CD_COMPANY, A.CD_SALEGRP  
 END  
END  
  
SET NOCOUNT OFF  
GO
  
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'UP_SA_SOSCH2_SELECT1') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE UP_SA_SOSCH2_SELECT1
GO

    
/*******************************************                
**  System : 영업관리                
**  Sub System : 매출관리            
**  Page  : 수주진행현황    
**  Desc  :  수주진행현황 탭별 라인 조회    
**                
**  Return Values                
**                
**  작    성    자  : 허성철                
**  작    성    일 : 07-04-04    
** Change History                
*********************************************                
*********************************************/        
CREATE PROCEDURE UP_SA_SOSCH2_SELECT1    
(        
 @P_CD_COMPANY   NVARCHAR(7),    
 @P_KEY   NVARCHAR(20),    
 @P_DT_SO_FROM NCHAR(8),    
 @P_DT_SO_TO  NCHAR(8),    
 @P_CD_BIZAREA NVARCHAR(7),    
 @P_CD_SALEGRP NVARCHAR(7),    
 @P_TP_BUSI  NVARCHAR(3),     
 @P_UNIT_CHOICE NVARCHAR(3), --@P_UNIT_CHOICE : 001 -> 수주단위, @P_UNIT_CHOICE : 002 -> 재고단위    
 @P_STA_SO  NVARCHAR(3),    
 @P_STATE  NVARCHAR(3), --001 : 진행, 002 : 미납, 003 : 완료    
 @P_TP_SO  NVARCHAR(4),   
 @P_TAB_GUBUN NCHAR(1)  --@P_TAB_GUBUN : 0-> 수주번호별, 1-> 거래처별, 2-> 품목별, 3-> 납기요구일별, 4-> 수주형태별, 5-> 영업그룹별    
)    
AS    
SET NOCOUNT ON    
    
IF (@P_TAB_GUBUN = '0')   --수주번호별    
BEGIN    
 IF (@P_STATE IS NULL OR @P_STATE = '')    
     
   BEGIN    
    SELECT   A.NO_SO,     --수주번호    
        A.CD_ITEM,    --품목코드    
        B.NM_ITEM,    --품목명    
        B.STND_ITEM,    --규격    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
        A.DT_DUEDATE,   --납기요구일    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
        A.STA_SO, D.TP_SO, E.NM_SO  
    FROM  SA_SOL A    
        LEFT OUTER JOIN MA_PITEM B    
        ON    B.CD_COMPANY = A.CD_COMPANY    
        AND    B.CD_PLANT = A.CD_PLANT    
        AND    B.CD_ITEM = A.CD_ITEM    
        INNER JOIN  MA_PLANT C    
        ON    C.CD_COMPANY = A.CD_COMPANY    
        AND    C.CD_PLANT = A.CD_PLANT    
        AND    C.CD_BIZAREA = @P_CD_BIZAREA    
 INNER JOIN SA_SOH D   
 ON D.CD_COMPANY = A.CD_COMPANY  
 AND    D.NO_SO = A.NO_SO  
 AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO  
 AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
    WHERE   A.CD_COMPANY = @P_CD_COMPANY    
        AND    A.NO_SO = @P_KEY    
        AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
        AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
   END    
    
 ELSE IF (@P_STATE = '001')    
    
    BEGIN    
     SELECT   A.NO_SO,     --수주번호    
         A.CD_ITEM,    --품목코드    
         B.NM_ITEM,    --품목명    
         B.STND_ITEM,    --규격    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
         A.DT_DUEDATE,   --납기요구일    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
         A.STA_SO, D.TP_SO, E.NM_SO  
   
     FROM   SA_SOL A    
         LEFT OUTER JOIN MA_PITEM B    
         ON    B.CD_COMPANY = A.CD_COMPANY    
         AND    B.CD_PLANT = A.CD_PLANT    
         AND    B.CD_ITEM = A.CD_ITEM    
         INNER JOIN  MA_PLANT C    
         ON    C.CD_COMPANY = A.CD_COMPANY    
         AND    C.CD_PLANT = A.CD_PLANT    
         AND    C.CD_BIZAREA = @P_CD_BIZAREA    
 INNER JOIN SA_SOH D   
 ON D.CD_COMPANY = A.CD_COMPANY  
 AND    D.NO_SO = A.NO_SO  
 AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO  
 AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
     WHERE   A.CD_COMPANY = @P_CD_COMPANY    
         AND    A.NO_SO = @P_KEY    
         AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
         AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
--         AND    A.QT_GIR > 0     
--         AND    A.QT_SO - A.QT_GI <> 0    
    END    
    
 ELSE IF (@P_STATE = '002')    
     
    BEGIN    
     SELECT   A.NO_SO,     --수주번호    
         A.CD_ITEM,    --품목코드    
         B.NM_ITEM,    --품목명    
         B.STND_ITEM,    --규격    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
         A.DT_DUEDATE,   --납기요구일    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
         A.STA_SO, D.TP_SO, E.NM_SO  
   
     FROM   SA_SOL A    
         LEFT OUTER JOIN MA_PITEM B    
         ON    B.CD_COMPANY = A.CD_COMPANY    
         AND    B.CD_PLANT = A.CD_PLANT    
         AND    B.CD_ITEM = A.CD_ITEM    
         INNER JOIN  MA_PLANT C    
         ON    C.CD_COMPANY = A.CD_COMPANY    
         AND    C.CD_PLANT = A.CD_PLANT    
         AND    C.CD_BIZAREA = @P_CD_BIZAREA    
 INNER JOIN SA_SOH D   
 ON D.CD_COMPANY = A.CD_COMPANY  
 AND    D.NO_SO = A.NO_SO  
 AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO  
 AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
     WHERE  A.CD_COMPANY = @P_CD_COMPANY    
         AND    A.NO_SO = @P_KEY    
         AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
         AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
         AND    A.QT_SO - A.QT_GI > 0    
    END    
      
    
 ELSE IF (@P_STATE = '003')     
    
   BEGIN    
  SELECT   A.NO_SO,     --수주번호    
       A.CD_ITEM,    --품목코드    
       B.NM_ITEM,    --품목명    
       B.STND_ITEM,    --규격    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
       A.DT_DUEDATE,   --납기요구일    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
       A.STA_SO, D.TP_SO, E.NM_SO  
   
   FROM   SA_SOL A    
       LEFT OUTER JOIN MA_PITEM B    
       ON    B.CD_COMPANY = A.CD_COMPANY    
       AND    B.CD_PLANT = A.CD_PLANT    
       AND    B.CD_ITEM = A.CD_ITEM    
       INNER JOIN  MA_PLANT C    
       ON    C.CD_COMPANY = A.CD_COMPANY    
       AND    C.CD_PLANT = A.CD_PLANT    
       AND    C.CD_BIZAREA = @P_CD_BIZAREA    
 INNER JOIN SA_SOH D   
 ON D.CD_COMPANY = A.CD_COMPANY  
 AND    D.NO_SO = A.NO_SO  
 AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO  
 AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)  
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
   WHERE   A.CD_COMPANY = @P_CD_COMPANY    
       AND    A.NO_SO = @P_KEY    
       AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
       AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
       AND   A.QT_SO - A.QT_GI = 0    
   END    
    
END    
    
ELSE IF (@P_TAB_GUBUN = '1') --거래처별    
    
BEGIN    
 IF (@P_STATE IS NULL OR @P_STATE = '')    
   BEGIN    
      SELECT   D.CD_PARTNER,   --거래처    
          A.NO_SO,     --수주번호    
          A.CD_ITEM,    --품목코드    
          B.NM_ITEM,    --품목명    
          B.STND_ITEM,    --규격    
          CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
          (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
          A.DT_DUEDATE,   --납기요구일    
          CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
          CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
          CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
          CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
          CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
          CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
          CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
          A.STA_SO,  
  D.FG_TRANSPORT  , D.TP_SO, E.NM_SO  
      FROM   SA_SOL A    
      LEFT OUTER JOIN MA_PITEM B    
      ON    B.CD_COMPANY = A.CD_COMPANY    
      AND    B.CD_PLANT = A.CD_PLANT    
      AND    B.CD_ITEM = A.CD_ITEM    
      INNER JOIN  MA_PLANT C    
      ON    C.CD_COMPANY = A.CD_COMPANY    
      AND    C.CD_PLANT = A.CD_PLANT    
      AND    C.CD_BIZAREA = @P_CD_BIZAREA    
      INNER JOIN  SA_SOH D    
      ON    D.CD_COMPANY = A.CD_COMPANY    
      AND    D.NO_SO = A.NO_SO    
      AND    D.CD_PARTNER = @P_KEY    
      AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
      AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
      WHERE   A.CD_COMPANY = @P_CD_COMPANY    
      AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
      AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
   END    
 ELSE IF (@P_STATE = '001')  --   (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM)    
     
  BEGIN    
   SELECT   D.CD_PARTNER,   --거래처    
       A.NO_SO,     --수주번호    
       A.CD_ITEM,    --품목코드    
       B.NM_ITEM,    --품목명    
       B.STND_ITEM,    --규격    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
       (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
       A.DT_DUEDATE,   --납기요구일    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
       A.STA_SO,  
 D.FG_TRANSPORT  , D.TP_SO, E.NM_SO  
   FROM   SA_SOL A    
   LEFT OUTER JOIN MA_PITEM B    
      ON    B.CD_COMPANY = A.CD_COMPANY    
      AND    B.CD_PLANT = A.CD_PLANT    
      AND    B.CD_ITEM = A.CD_ITEM    
      INNER JOIN  MA_PLANT C    
      ON    C.CD_COMPANY = A.CD_COMPANY    
      AND    C.CD_PLANT = A.CD_PLANT    
      AND    C.CD_BIZAREA = @P_CD_BIZAREA    
      INNER JOIN  SA_SOH D    
      ON    D.CD_COMPANY = A.CD_COMPANY    
      AND    D.NO_SO = A.NO_SO    
      AND    D.CD_PARTNER = @P_KEY    
      AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
      AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
   WHERE   A.CD_COMPANY = @P_CD_COMPANY    
      AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
      AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
--      AND    A.QT_GIR > 0    
--      AND    A.QT_SO - A.QT_GI <> 0    
  END    
    
 ELSE IF (@P_STATE = '002') --  (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM)     
   BEGIN    
    SELECT   D.CD_PARTNER,   --거래처    
        A.NO_SO,     --수주번호    
        A.CD_ITEM,    --품목코드    
        B.NM_ITEM,    --품목명    
        B.STND_ITEM,    --규격    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
        (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
        A.DT_DUEDATE,   --납기요구일    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
        A.STA_SO,  
 D.FG_TRANSPORT  , D.TP_SO, E.NM_SO  
    FROM   SA_SOL A    
        LEFT OUTER JOIN MA_PITEM B    
        ON    B.CD_COMPANY = A.CD_COMPANY    
        AND    B.CD_PLANT = A.CD_PLANT    
        AND    B.CD_ITEM = A.CD_ITEM    
        INNER JOIN  MA_PLANT C    
        ON    C.CD_COMPANY = A.CD_COMPANY    
        AND    C.CD_PLANT = A.CD_PLANT    
        AND    C.CD_BIZAREA = @P_CD_BIZAREA    
        INNER JOIN  SA_SOH D    
        ON    D.CD_COMPANY = A.CD_COMPANY    
        AND    D.NO_SO = A.NO_SO    
        AND    D.CD_PARTNER = @P_KEY    
        AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
        AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
    WHERE   A.CD_COMPANY = @P_CD_COMPANY    
        AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
        AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
        AND    A.QT_SO - A.QT_GI > 0    
   END    
    
    
ELSE IF (@P_STATE = '003')    
    
 BEGIN    
  SELECT   D.CD_PARTNER,   --거래처    
      A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      B.NM_ITEM,    --품목명    
      B.STND_ITEM,    --규격    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO,  
 D.FG_TRANSPORT  , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.CD_PARTNER = @P_KEY    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  AND   A.QT_SO - A.QT_GI = 0    
  END    
END    
    
    
ELSE IF (@P_TAB_GUBUN = '2') --품목별    
BEGIN    
 IF (@P_STATE IS NULL OR @P_STATE = '')    
 BEGIN    
  SELECT   A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO,  
 D.FG_TRANSPORT  , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    A.CD_ITEM = @P_KEY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
 END    
 ELSE IF (@P_STATE = '001')    
 BEGIN    
  SELECT   A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO, D.FG_TRANSPORT  , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    A.CD_ITEM = @P_KEY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)     
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
--  AND    A.QT_GIR > 0    
-- AND    A.QT_SO - A.QT_GI <> 0    
    
 END    
 ELSE IF (@P_STATE = '002')    
 BEGIN    
  SELECT   A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO, D.FG_TRANSPORT  , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    A.CD_ITEM = @P_KEY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)     
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  AND    A.QT_SO - A.QT_GI > 0    
 END    
    
    
ELSE IF ( @P_STATE = '003')    
  BEGIN    
  SELECT   A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    A.CD_ITEM = @P_KEY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)     
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  AND   A.QT_SO - A.QT_GI = 0    
 END    
END    
    
ELSE IF (@P_TAB_GUBUN = '3') --납기요구일별    
BEGIN    
 IF (@P_STATE IS NULL OR @P_STATE = '')    
 BEGIN    
  SELECT   A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      B.NM_ITEM,    --품목명    
      B.STND_ITEM,    --규격    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    A.DT_DUEDATE = @P_KEY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
 END    
 ELSE IF (@P_STATE = '001')    
    
 BEGIN    
  SELECT   A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      B.NM_ITEM,    --품목명    
      B.STND_ITEM,    --규격    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO , D.FG_TRANSPORT   , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    A.DT_DUEDATE = @P_KEY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
--  AND    A.QT_GIR > 0    
-- AND    A.QT_SO - A.QT_GI <> 0    
 END    
    
 ELSE IF (@P_STATE = '002')    
    
   BEGIN    
     SELECT   A.NO_SO,     --수주번호    
         A.CD_ITEM,    --품목코드    
         B.NM_ITEM,    --품목명    
         B.STND_ITEM,    --규격    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
         (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
         A.DT_DUEDATE,   --납기요구일    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
         A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
     FROM   SA_SOL A    
     LEFT OUTER JOIN MA_PITEM B    
     ON    B.CD_COMPANY = A.CD_COMPANY    
     AND    B.CD_PLANT = A.CD_PLANT    
     AND    B.CD_ITEM = A.CD_ITEM    
     INNER JOIN  MA_PLANT C    
     ON    C.CD_COMPANY = A.CD_COMPANY    
     AND    C.CD_PLANT = A.CD_PLANT    
     AND    C.CD_BIZAREA = @P_CD_BIZAREA    
     INNER JOIN  SA_SOH D    
     ON    D.CD_COMPANY = A.CD_COMPANY    
     AND    D.NO_SO = A.NO_SO    
     AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
     AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
     WHERE   A.CD_COMPANY = @P_CD_COMPANY    
     AND    A.DT_DUEDATE = @P_KEY    
     AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
     AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
     AND    A.QT_SO - A.QT_GI > 0    
   END    
    
 ELSE IF (@P_STATE = '003')    
    
   BEGIN    
     SELECT   A.NO_SO,     --수주번호    
         A.CD_ITEM,    --품목코드    
         B.NM_ITEM,    --품목명    
         B.STND_ITEM,    --규격    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
         (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
         A.DT_DUEDATE,   --납기요구일    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
         CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
         A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
     FROM   SA_SOL A    
     LEFT OUTER JOIN MA_PITEM B    
     ON    B.CD_COMPANY = A.CD_COMPANY    
     AND    B.CD_PLANT = A.CD_PLANT    
     AND    B.CD_ITEM = A.CD_ITEM    
     INNER JOIN  MA_PLANT C    
     ON    C.CD_COMPANY = A.CD_COMPANY    
     AND    C.CD_PLANT = A.CD_PLANT    
     AND    C.CD_BIZAREA = @P_CD_BIZAREA    
     INNER JOIN  SA_SOH D    
     ON    D.CD_COMPANY = A.CD_COMPANY    
     AND    D.NO_SO = A.NO_SO    
     AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
     AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
     WHERE   A.CD_COMPANY = @P_CD_COMPANY    
     AND    A.DT_DUEDATE = @P_KEY    
     AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
     AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
   AND   A.QT_SO - A.QT_GI = 0    
   END    
 END    
ELSE IF (@P_TAB_GUBUN = '4') --수주형태별    
BEGIN    
 IF (@P_STATE IS NULL OR @P_STATE = '')    
 BEGIN    
  SELECT   D.TP_SO,     --수주형태    
      A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      B.NM_ITEM,    --품목명    
      B.STND_ITEM,    --규격    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.TP_SO = @P_KEY    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
 END    
 ELSE IF (@P_STATE = '001')    
 BEGIN    
  SELECT   D.TP_SO,     --수주형태    
      A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      B.NM_ITEM,    --품목명    
      B.STND_ITEM,    --규격    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.TP_SO = @P_KEY    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)     
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
--  AND    A.QT_GIR > 0    
--  AND    A.QT_SO - A.QT_GI <> 0    
 END    
 ELSE IF (@P_STATE = '002')    
 BEGIN    
  SELECT   D.TP_SO,     --수주형태    
      A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      B.NM_ITEM,    --품목명    
      B.STND_ITEM,    --규격    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.TP_SO = @P_KEY    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)     
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  AND    A.QT_SO - A.QT_GI > 0    
 END    
    
ELSE IF (@P_STATE = '003')    
  BEGIN    
    SELECT   D.TP_SO,     --수주형태    
        A.NO_SO,     --수주번호    
        A.CD_ITEM,    --품목코드    
        B.NM_ITEM,    --품목명    
        B.STND_ITEM,    --규격    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
        (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
        A.DT_DUEDATE,   --납기요구일    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
        CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
        A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
    FROM   SA_SOL A    
    LEFT OUTER JOIN MA_PITEM B    
    ON    B.CD_COMPANY = A.CD_COMPANY    
    AND    B.CD_PLANT = A.CD_PLANT    
    AND    B.CD_ITEM = A.CD_ITEM    
    INNER JOIN  MA_PLANT C    
    ON    C.CD_COMPANY = A.CD_COMPANY    
    AND    C.CD_PLANT = A.CD_PLANT    
    AND    C.CD_BIZAREA = @P_CD_BIZAREA    
    INNER JOIN  SA_SOH D    
    ON    D.CD_COMPANY = A.CD_COMPANY    
    AND    D.NO_SO = A.NO_SO    
    AND    D.TP_SO = @P_KEY    
    AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
    AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
    WHERE   A.CD_COMPANY = @P_CD_COMPANY    
    AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
    AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)     
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
    AND   A.QT_SO - A.QT_GI = 0    
  END    
END    
ELSE IF (@P_TAB_GUBUN = '5') --영업그룹별    
BEGIN    
 IF (@P_STATE IS NULL OR @P_STATE = '')    
 BEGIN    
  SELECT   D.CD_SALEGRP,   --영업그룹    
      A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      B.NM_ITEM,    --품목명    
      B.STND_ITEM,    --규격    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.CD_SALEGRP = @P_KEY    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)    
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
 END    
 ELSE IF (@P_STATE = '001')    
 BEGIN    
  SELECT   D.CD_SALEGRP,   --영업그룹    
      A.NO_SO,     --수주번호    
      A.CD_ITEM,    --품목코드    
      B.NM_ITEM,    --품목명    
      B.STND_ITEM,    --규격    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
      (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
      A.DT_DUEDATE,   --납기요구일    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
      CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
      A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
  FROM   SA_SOL A    
  LEFT OUTER JOIN MA_PITEM B    
  ON    B.CD_COMPANY = A.CD_COMPANY    
  AND    B.CD_PLANT = A.CD_PLANT    
  AND    B.CD_ITEM = A.CD_ITEM    
  INNER JOIN  MA_PLANT C    
  ON    C.CD_COMPANY = A.CD_COMPANY    
  AND    C.CD_PLANT = A.CD_PLANT    
  AND    C.CD_BIZAREA = @P_CD_BIZAREA    
  INNER JOIN  SA_SOH D    
  ON    D.CD_COMPANY = A.CD_COMPANY    
  AND    D.NO_SO = A.NO_SO    
  AND    D.CD_SALEGRP = @P_KEY    
  AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
  AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
  WHERE   A.CD_COMPANY = @P_CD_COMPANY    
  AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
  AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)     
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
--  AND    A.QT_GIR > 0    
-- AND    A.QT_SO - A.QT_GI <> 0    
    
 END    
 ELSE IF (@P_STATE = '002')    
  BEGIN    
   SELECT   D.CD_SALEGRP,   --영업그룹    
       A.NO_SO,     --수주번호    
       A.CD_ITEM,    --품목코드    
       B.NM_ITEM,    --품목명    
       B.STND_ITEM,    --규격    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
       (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
       A.DT_DUEDATE,   --납기요구일    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
       A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
   FROM   SA_SOL A    
   LEFT OUTER JOIN MA_PITEM B    
   ON    B.CD_COMPANY = A.CD_COMPANY    
   AND    B.CD_PLANT = A.CD_PLANT    
   AND    B.CD_ITEM = A.CD_ITEM    
   INNER JOIN  MA_PLANT C    
   ON    C.CD_COMPANY = A.CD_COMPANY    
   AND    C.CD_PLANT = A.CD_PLANT    
   AND    C.CD_BIZAREA = @P_CD_BIZAREA    
   INNER JOIN  SA_SOH D    
   ON    D.CD_COMPANY = A.CD_COMPANY    
   AND    D.NO_SO = A.NO_SO    
   AND    D.CD_SALEGRP = @P_KEY    
   AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
   AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
   WHERE   A.CD_COMPANY = @P_CD_COMPANY    
   AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
   AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)     
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
   AND    A.QT_SO - A.QT_GI > 0    
  END    
    
  ELSE IF (@P_STATE = '003')    
  BEGIN    
   SELECT   D.CD_SALEGRP,   --영업그룹    
       A.NO_SO,     --수주번호    
       A.CD_ITEM,    --품목코드    
       B.NM_ITEM,    --품목명    
       B.STND_ITEM,    --규격    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN B.UNIT_SO ELSE B.UNIT_IM END UNIT_SO,  --단위    
       (SELECT DT_SO FROM SA_SOH WHERE CD_COMPANY = A.CD_COMPANY AND NO_SO = A.NO_SO) DT_SO, --수주일자    
       A.DT_DUEDATE,   --납기요구일    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_SO ELSE A.QT_IM END QT_SO, --수주수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GIR ELSE A.QT_GIR_IM END QT_GIR, --의뢰수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_GI ELSE A.QT_GI_IM END QT_GI, --출하수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_SO - A.QT_GI) ELSE (A.QT_IM - A.QT_GI_IM) END QT_GI_REMAIN,--출하수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN -(A.QT_RETURN) ELSE -(A.QT_RETURN_IM) END QT_RETURN, --반품수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN A.QT_IV ELSE A.QT_IV_IM END QT_IV, --매출수량    
       CASE WHEN @P_UNIT_CHOICE = '001' THEN (A.QT_GI - A.QT_IV) ELSE (A.QT_GI_IM - A.QT_IV_IM) END QT_IV_REMAIN, --미매출수량    
       A.STA_SO, D.FG_TRANSPORT    , D.TP_SO, E.NM_SO  
   FROM   SA_SOL A    
   LEFT OUTER JOIN MA_PITEM B    
   ON    B.CD_COMPANY = A.CD_COMPANY    
   AND    B.CD_PLANT = A.CD_PLANT    
   AND    B.CD_ITEM = A.CD_ITEM    
   INNER JOIN  MA_PLANT C    
   ON    C.CD_COMPANY = A.CD_COMPANY    
   AND    C.CD_PLANT = A.CD_PLANT    
   AND    C.CD_BIZAREA = @P_CD_BIZAREA    
   INNER JOIN  SA_SOH D    
   ON    D.CD_COMPANY = A.CD_COMPANY    
   AND    D.NO_SO = A.NO_SO    
   AND    D.CD_SALEGRP = @P_KEY    
   AND    D.DT_SO BETWEEN @P_DT_SO_FROM AND @P_DT_SO_TO    
   AND    (D.CD_SALEGRP = @P_CD_SALEGRP OR @P_CD_SALEGRP = '' OR @P_CD_SALEGRP IS NULL)    
 LEFT OUTER JOIN SA_TPSO E ON E.CD_COMPANY = @P_CD_COMPANY  
       AND E.TP_SO = D.TP_SO  
   WHERE   A.CD_COMPANY = @P_CD_COMPANY    
   AND    (A.TP_BUSI = @P_TP_BUSI OR @P_TP_BUSI = '' OR @P_TP_BUSI IS NULL)    
   AND    (A.STA_SO = @P_STA_SO OR @P_STA_SO = '' OR @P_STA_SO IS NULL)     
 AND    (D.TP_SO = @P_TP_SO OR @P_TP_SO = '' OR @P_TP_SO IS NULL)  
  AND   A.QT_SO - A.QT_GI = 0    
  END    
    
END    
    
SET NOCOUNT OFF    
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  